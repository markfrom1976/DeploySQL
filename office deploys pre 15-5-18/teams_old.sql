USE [TEAMS]
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='LegionellaApproval'))
	BEGIN
		CREATE TABLE [dbo].[LegionellaApproval] (
        [LegionellaApprovalId] [int] IDENTITY (1, 1) NOT NULL,
        [orgInstructionID] [int] NOT NULL CONSTRAINT [DF_LegionellaApproval_orgInstructionID] DEFAULT (0),
        [EmployeeId] [int] NOT NULL,
        [DateApproved] [datetime] NOT NULL CONSTRAINT [DF_LegionellaApproval_DateApproved] DEFAULT (getdate()),
        [DateDeleted] [datetime] NULL,
        CONSTRAINT [PK_LegionellaApproval]
        PRIMARY KEY CLUSTERED
        (
            [LegionellaApprovalId] ASC
        )
        WITH (FILLFACTOR = 90, PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
        ON [PRIMARY]
        ) ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_AirMonitoring')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_AirMonitoring] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Paged_AirMonitoring]    Script Date: 01/18/2017 20:36:45 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- ======================================================
-- Author:		Lonny
-- Create date:	26/08/2016
-- Description:	Paged SP to replace inline SQL in Classic
-- ======================================================

ALTER PROCEDURE [dbo].[Paged_AirMonitoring] 
	@PerPage INT = 15,
	@CurrentPage INT = 1,
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@JobID INT = 0,
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL,
	@Filter VARCHAR(MAX) = '',
	@BranchId INT = 0,
	@EmployeeId INT = 0,
	@AirTestTypeId INT = 0,
	@SurveyStatus INT = 0,
	@Accessibility INT = 0, -- (0=all, 1=accessible, 2=not accessible)
	@Approval INT = 0 -- (0=all, 1=approved, 2=unapproved)
WITH RECOMPILE
AS
BEGIN
	SET NOCOUNT ON;

	Set @FilterStartDate = ISNULL(@FilterStartDate,'1900-01-01 00:00:00') -- DATEADD(year,-1,GETDATE())
	Set @FilterEndDate = ISNULL(@FilterEndDate,'2099-12-31 23:59:59') -- DATEADD(month,3,GETDATE())
      
	DECLARE @IdList TABLE (JobID INT, AirTestID INT, AirTestStart DATETIME, SiteArrival DATETIME, Created DATETIME)
      
	Insert into @IdList (JobID, AirTestID, AirTestStart, SiteArrival, Created)
	Select  
		j.jobID,
		at.AirTestID,
		at.AirTestStart,
		at.SiteArrival,
		j.Created
	From
		Job j
		Inner Join (Select JobId From Quote q Inner Join Appointment a On a.QuoteId = q.QuoteId And a.DateDeclined Is Null Where q.Rejected Is Null Group By q.JobId) a On a.JobId = j.JobId
		Inner Join JobEmployee je ON j.JobID = je.JobID
		Inner Join Employee e ON je.EmployeeID = e.EmployeeID
		Inner Join AirTest at ON je.JobEmployeeID = at.JobEmployeeID
		Inner Join AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
		Inner Join Client c ON j.ClientID = c.ClientID
		Left Outer Join Project p ON j.ProjectID = p.ProjectID
		Inner Join Site s ON j.SiteID = s.SiteID
		Left Outer Join NoAccess na On na.JobId = j.JobId And na.Created > at.AirTestFinish AND na.Deleted IS NULL
	Where 
		(
			(Select COUNT(*) FROM AirTestResult Where AirTestID=at.AirTestID)
				+
			(Select COUNT(*) FROM AirTestPDF Where AirtestID=at.AirtestID)
				+
			(select COUNT(*) FROM AirTest Where AirTestID=at.AirTestID AND AirTestTypeID=100)
		) > 0 
			And
		att.AirTestTypeID <> 7 
			And
		att.AirTestTypeID IS NOT NULL 
			And
		j.Cancelled IS NULL
			And
		(
			LEN(@Filter) = 0
				OR
			(
				s.Address Like '%' + @Filter + '%'
					Or 
				s.Postcode Like '%' + @Filter + '%'
					Or 
				s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
					Or 
				s.UPRN = @Filter
			)
		)
			And
		(@ProjectID=0 OR j.ProjectID=@ProjectID)
			And
		(@SiteID=0 OR j.SiteID=@SiteID)
			And
		(@ClientID=0 OR j.ClientID=@ClientID)
			And
		(@BranchId=0 OR j.BranchOfficeID=@BranchId)
			And
		(@EmployeeId=0 OR je.EmployeeID=@EmployeeId)
			And
		(@AirTestTypeId=0 OR att.AirTestTypeID=@AirTestTypeId)
			And
		(
			(@Accessibility=0) -- Everything
				OR 
            (@Accessibility = 1 AND na.NoAccessId Is Null) -- Accessible
                Or
            (@Accessibility = 2 AND na.NoAccessId Is Not Null)-- Not accessible
		)
			And
		(
			(@Approval=0) -- Everything
				OR 
            (@Approval = 1 AND at.OfficeApproved = 1) -- Approved
                Or
            (@Approval = 2 AND at.OfficeApproved = 0)-- Unapproved
		)
			And
		(
			CASE WHEN @JobID > 0 THEN
				CASE WHEN j.JobID = @JobID THEN 1 ELSE 0 END
			ELSE
				CASE WHEN
					(
						ISNULL(at.SiteArrival,j.Created) BETWEEN @FilterStartDate AND @FilterEndDate
					)
				THEN 1 ELSE 0 END
			END = 1
		)
            And
        (
            (@SurveyStatus = 0) -- Everything
                Or
            (@SurveyStatus = 1 AND (at.Status IS NULL OR at.Status = '')) -- Status Empty
                Or
            (@SurveyStatus = 2 AND at.Status IS NOT NULL AND at.Status <> '') -- Status Not Empty
        )
	GROUP BY 
		j.jobID,
		at.AirTestID,
		at.AirTestStart,
		at.SiteArrival,
		j.Created
      
	DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @IdList)
		            
	;With Paging As 
	( 
		Select 
			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
			END As Pages, 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				((Row_Number() Over(Order By a.SiteArrival DESC)-1) / @PerPage)+1
			END As Page, 

			Row_Number() Over(Order By a.SiteArrival DESC) as Row_Num, 

			*
		From 
			(
				Select * FROM @IdList
			) a
	)
	
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.Row_Num,
		main.JobID,
		j.JobNo, 
		j.Created, 
		j.LastNoteCreated, 
		at.AirTestNo, 
		at.OfficeApproved, 
		at.SystemName, 
		at.AirTestID, 
		at.LocationEnclosure, 
		dbo.Ellipsis(at.LocationEnclosure,12) as LocationEnclosureShort, 
		main.SiteArrival, 
		att.AirTestTypeID, 
		att.Description, 
		c.Client, 
		s.Address, 
		s.UPRN, 
		at.Status, 
		j.SiteID, 
		(
			RIGHT('0' + CONVERT(VARCHAR, DATEPART(DAY, at.AirTestStart)), 2) 
				+ 
			RIGHT('0' + CONVERT(VARCHAR, DATEPART(MONTH, at.AirTestStart)), 2) 
				+ 
			CONVERT(VARCHAR, DATEPART(YEAR, at.AirTestStart))
		) 'AirTestDate', 
		dbo.IsPrimaryAirTest(at.AirTestID) 'PrimaryAirTest', 
		e.Fullname,
		ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
		(Select Top 1 FileName FROM PDF pf WHERE pf.DateDeleted IS NULL And Not FileName Like '%ra%' And FileName Like '%\_' + CAST(at.AirTestID AS VARCHAR) + ' (%' ESCAPE '\' And pf.JobId=main.JobId ORDER BY pf.FileName DESC) AS [FileName],
		(Select Top 1 FileName FROM PDF pf WHERE pf.DateDeleted IS NULL And FileName Like '%ra%' And FileName Like '%\_' + CAST(at.AirTestID AS VARCHAR) + ' (%' ESCAPE '\' And pf.JobId=main.JobId ORDER BY pf.FileName DESC) AS [RiskFileName],
		(
			Select Top 1 
				FileName 
			FROM 
				PDF pf 
			WHERE 
				JobId IS NULL AND 
				QuoteId IS NULL AND 
				InvoiceId IS NULL AND 
				[FileName] LIKE 'Combi%' AND 
				[FileName] LIKE 
					'%_' + 
					RIGHT('0' + CONVERT(VARCHAR, DATEPART(DAY, at.AirTestStart)), 2) + 
					RIGHT('0' + CONVERT(VARCHAR, DATEPART(MONTH, at.AirTestStart)), 2) + 
					CONVERT(VARCHAR, DATEPART(YEAR, at.AirTestStart)) + 
					'_%' AND 
				[FileName] LIKE '%site' + CAST(s.SiteID AS VARCHAR) AND 
				pf.DateDeleted IS NULL 
			ORDER BY 
				pf.PDFId DESC
		) AS [CombiFileName],
		j.ClientOrderNo
    From 
		Paging main
		INNER JOIN Job j On main.JobID = j.JobId
		Inner Join JobEmployee je ON j.JobID = je.JobID
		Inner Join Employee e ON je.EmployeeID = e.EmployeeID
		Inner Join AirTest at ON je.JobEmployeeID = at.JobEmployeeID AND main.AirTestID = at.AirTestID
		Inner Join AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
        LEFT OUTER Join Client c On j.ClientID = c.ClientID 
        LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
        LEFT OUTER Join Site s On j.SiteID = s.SiteID
	Where 
        (
			main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.Row_Num
      
    SET NOCOUNT OFF;
END

GO


USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_CompletedSampleReport')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_CompletedSampleReport] AS BEGIN SET NOCOUNT ON; END')
END


/****** Object:  StoredProcedure [dbo].[Paged_CompletedSampleReport]    Script Date: 01/18/2017 20:37:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Moving 'CompletedSampleReports' from a inline SQL to a stored procedure to increase speed.
-- In addition the the normal re-factoring, this requires a page number and number of items per page
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_CompletedSampleReports are synced at all times */
ALTER PROCEDURE [dbo].[Paged_CompletedSampleReport]
	@PerPage INT = 15,
	@CurrentPage INT = 1,
	@JobID INT = 0,
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL,
	@EmployeeID INT = 0,
	@BranchOfficeID INT = 0,
	@CompletedSampleReportsFilterType INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LaboratoryID INT = 0
AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
    Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))
      
	DECLARE @CompletedSampleReportJobs TABLE (JobID INT, JobNo INT, ClientOrderNo VARCHAR(MAX))
	INSERT INTO @CompletedSampleReportJobs (JobID, JobNo, ClientOrderNo)
	SELECT
		a.JobID, a.JobNo, a.ClientOrderNo
	FROM
	(
		SELECT
			jd.JobID, jd.JobNo, jd.ClientOrderNo,
			ROW_NUMBER() OVER (PARTITION BY jd.JobID Order By asu.DueDate ASC, r.RegisterFinish DESC) [Identifier]
		FROM
			(
				SELECT
					j.JobID, j.JobNo, a.AppointmentID, a.ClientOrderNo
				FROM
					Job j 
					INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
					INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
					LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
					LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
				WHERE
					a.DateDeclined IS NULL
						AND
					j.Approved IS NOT NULL
						AND
					j.Cancelled IS NULL
						AND
					(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
						AND
					(
						CASE WHEN j.SampleResultEmployeeID IS NOT NULL AND j.SampleContentEmployeeID IS NOT NULL THEN
							1
						ELSE
							0
						END = 1
					)
						AND
					(
						CASE @CompletedSampleReportsFilterType
							WHEN -1 THEN CASE WHEN a.AppointmentID IS NULL THEN 1 ELSE 0 END
							WHEN -2 THEN CASE WHEN a.AppointmentID IS NOT NULL THEN 1 ELSE 0 END
							WHEN 0 THEN 1
						ELSE
							1
						End = 1
					)
						AND
					(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
						AND
					(
						CASE WHEN @Filter IS NULL THEN
							1
						ELSE
							CASE WHEN
								/*j.ClientOrderNo LIKE '%' + @Filter + '%'
									OR*/ --This seems to be in other sp's, but not this one? - Left in for clarity later
								si.Address Like '%' + @Filter + '%'
									Or
								si.Postcode Like '%' + @Filter + '%'
									Or
								si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
									Or 
								si.UPRN = @Filter
							THEN 1 ELSE 0 END
						END = 1
					)
			) jd
			INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = jd.JobID
			INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			
			LEFT JOIN AppointmentSurvey asu WITH (NOLOCK) ON jd.AppointmentID = asu.AppointmentID

		WHERE
			(
				CASE WHEN @JobID = 0 THEN
					CASE WHEN r.RegisterFinish between @FilterStartDate AND @FilterEndDate THEN 1 ELSE 0 END
				ELSE
					1
				END = 1
			)
	            AND
			(
				CASE @CompletedSampleReportsFilterType
					WHEN -1 THEN 1
					WHEN -2 THEN 1
					WHEN 0 THEN 1
				ELSE
					CASE WHEN asu.SurveyTypeID = @CompletedSampleReportsFilterType THEN 1 ELSE 0 END
				End = 1
			)
	) a
	WHERE
		a.Identifier = 1

    DECLARE @FullSet TABLE (JobNo INT, JobID INT, DateAnalysedStart DATETIME, DateAnalysedFinish DATETIME, ClientOrderNo VARCHAR(MAX), SampleCount INT)

    Insert into @FullSet (JobNo, JobID, DateAnalysedStart, DateAnalysedFinish, ClientOrderNo, SampleCount)
    SELECT
        csrj.JobNo,
        csrj.JobID,
        MIN(s.DateAnalysed) [DateAnalysedStart],
        MAX(s.DateAnalysed) [DateAnalysedFinish],
        csrj.ClientOrderNo,
        COUNT(*) [SampleCount]
	FROM
        @CompletedSampleReportJobs csrj
        INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = csrj.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Room rm WITH (NOLOCK) ON r.RegisterID=rm.RegisterID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID AND s.SampleRef NOT LIKE '%*%' AND NULLIF(s.SampleRef,'') IS NOT NULL AND s.AsSample=0
	WHERE
		(
			CASE WHEN @EmployeeID = 0 THEN
				1
			ELSE 
				CASE WHEN s.EmployeeID = @EmployeeID THEN 1 ELSE 0 END
			END = 1
		)
			AND
		(
			CASE 
				WHEN @LaboratoryID = 0 THEN 1
			ELSE
				CASE
					WHEN s.LaboratoryID = @LaboratoryID THEN 1 
				ELSE 
					0
				END
			END = 1
		)
	Group By 
		csrj.JobNo,csrj.JobID,csrj.ClientOrderNo
	
	DECLARE @CompletedSampleReportsData TABLE (Pages INT, Page INT, Row_Num INT, JobID INT, DateAnalysedStart DATETIME, DateAnalysedFinish DATETIME, ClientOrderNo VARCHAR(MAX), SampleCount INT)
	DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
	DECLARE @BSRFile TABLE (JobID INT, [Filename] VARCHAR(MAX))

    ;With Paging As
    (
        Select
           CASE 
                WHEN @PerPage = 0 
                THEN 1
                ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages,
        CASE 
            WHEN @PerPage = 0 
            THEN 1
            ELSE
			((Row_Number() Over(Order By a.JobNo DESC)-1) / @PerPage)+1
            END As Page,
			Row_Number() Over(Order By a.JobNo DESC) as Row_Num,
			*
        From
        (
			Select * FROM @FullSet
        ) a
    )
    
    INSERT INTO @CompletedSampleReportsData (Pages, Page, Row_Num, JobID, DateAnalysedStart, DateAnalysedFinish, ClientOrderNo, SampleCount)
    Select
		main.Pages,
        main.Page,
        main.Row_Num,
        main.JobID,
        main.DateAnalysedStart,
        main.DateAnalysedFinish,
        main.ClientOrderNo,
        main.SampleCount
    FROM
		Paging main
	Where 
        (
            main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )
    
    INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				csrd.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY csrd.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@CompletedSampleReportsData csrd
				INNER JOIN Job j WITH (NOLOCK) On csrd.JobID = j.JobId
				INNER JOIN ClientTemplate ct WITH (NOLOCK) ON ct.ClientID = j.ClientID
				INNER JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1
		
	INSERT INTO @BSRFile (JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				csrd.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY csrd.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSampleReportsData csrd
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = csrd.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
    
    -- Start the main SELECT
    Select
        main.Pages,
        main.Page,
        main.Row_Num,
        j.JobNo, Client + IsNull(Case When Len(BranchName) > 0 Then ' (' + BranchName + ')' End, '') [Client],
        si.Address,
        j.JobID,
        j.Status,
        j.LastNoteCreated,
        j.approved [Approved],
        CASE WHEN CAST(main.DateAnalysedFinish AS DATE) = CAST(main.DateAnalysedStart AS DATE) THEN 
			dbo.FormatTeamsDate(main.DateAnalysedStart, 1)
		ELSE 
			dbo.FormatTeamsDate(main.DateAnalysedStart, 1) + ' - ' + dbo.FormatTeamsDate(main.DateAnalysedFinish, 1)
		END [DateAnalysed],
        main.DateAnalysedStart,
        main.DateAnalysedFinish,
        surveyors.List [Surveyors],
        COALESCE(main.ClientOrderNo, q.ClientOrderNo, j.ClientOrderNo, '') [ClientOrderNo],
        main.SampleCount,
		bsr_CT.TemplateID [ClientTemplateID],
		rep_BSR.[Filename] [FileName],
		ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour]		
    From
        @CompletedSampleReportsData main
        INNER JOIN Job j WITH (NOLOCK) ON j.JobID=main.JobID
        INNER JOIN Client c WITH (NOLOCK) ON c.ClientID=j.ClientID
        INNER JOIN Site si WITH (NOLOCK) ON si.SiteID=j.SiteID
        LEFT OUTER JOIN Quote q WITH (NOLOCK) On q.JobID = j.JobID
		OUTER APPLY
		(
			SELECT STUFF((
                SELECT DISTINCT ', ' + e.FullName
                FROM
                    JobEmployee je INNER JOIN Employee e ON je.EmployeeID = e.EmployeeID
                WHERE
                    je.JobID = j.JobID
                FOR XML PATH('')
			), 1, 2, '') [List]
		) surveyors
		LEFT OUTER JOIN @BSRFile rep_BSR ON rep_BSR.JobID = j.JobID
		LEFT OUTER JOIN @BulkSampleClientTemplate bsr_CT ON bsr_CT.JobID=j.JobID
    WHERE
         (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    ORDER BY
         main.Row_Num    
    
    SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_CompletedSurveys')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_CompletedSurveys] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_CompletedSurveys] 
    
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@BranchId INT = 0,
    @EmployeeId INT = 0,
    @SurveyTypeId INT = 0,
    @SurveyStatus INT = 0,
    @JobID INT = 0,
	@FilterStartDate DATETIME = NULL,
    @FilterEndDate DATETIME = NULL,
    @Filter VARCHAR(MAX) = ''

AS
BEGIN
    SET NOCOUNT ON;
    
    
    Set @FilterStartDate = ISNULL(@FilterStartDate,'1900-01-01 00:00:00') -- DATEADD(year,-1,GETDATE())
    Set @FilterEndDate = ISNULL(@FilterEndDate,'2099-12-31 23:59:59') -- DATEADD(month,3,GETDATE())
      
    DECLARE @CompletedSurveysView TABLE (JobID INT,SurveyTypeID INT,Created DATETIME,EndDate DATETIME, PropertyType VARCHAR(50))
      
    Insert into @CompletedSurveysView (JobID,SurveyTypeID,Created,EndDate, PropertyType)
    Select  
        jd.JobID,
        su.SurveyTypeID,
        jd.Created,
        MAX(reg.RegisterFinish),
		jd.PropertyType
    From
        (
			Select 
				j.JobID, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate], pt.PropertyType
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
				INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
				INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
				INNER JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
			WHERE
				a.DateDeclined IS NULL
					AND
				(CASE WHEN @FilterStartDate IS NULL OR @FilterEndDate IS NULL THEN 1 ELSE CASE WHEN j.Created BETWEEN @FilterStartDate AND @FilterEndDate THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
			GROUP BY
				j.JobID, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, pt.PropertyType
		) jd
		INNER JOIN Site si ON jd.SiteID=si.SiteID
        INNER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
		LEFT JOIN TestEmployee te WITH (NOLOCK) On reg.RegisterID = te.RegisterID
		LEFT JOIN Floorplan fp WITH (NOLOCK) On fp.RegisterID = reg.RegisterID
		INNER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId        
    Where 
		jd.Approved IS NOT NULL
			AND
		(
			(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN je.EmployeeID = @EmployeeId THEN 1 ELSE 0 END END = 1)
				OR
			(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN te.EmployeeID = @EmployeeId THEN 1 ELSE 0 END END = 1)
		)
		
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
			AND
		(CASE WHEN @SurveyTypeId = 0 THEN 1 ELSE CASE WHEN su.SurveyTypeID=@SurveyTypeId THEN 1 ELSE 0 END END = 1)
            And
        (
			CASE WHEN @SurveyStatus = 0 THEN
				1
			ELSE
				CASE WHEN NULLIF(reg.[Status],'') IS NULL THEN 
					CASE WHEN @SurveyStatus = 1 THEN 1 ELSE 0 END
				ELSE 
					CASE WHEN @SurveyStatus = 2 THEN 1 ELSE 0 END
				END
			END = 1
        )
    Group By
        jd.JobID,
        su.SurveyTypeID,
        jd.Created,
		jd.PropertyType
      
    DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @CompletedSurveysView)
    DECLARE @CompletedSurveysTopLevel TABLE (Pages INT, Page INT, Row_Num INT, JobID INT, EndDate DATETIME, SurveyTypeID INT, PropertyType VARCHAR(50))
    DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
    DECLARE @RegisterStatus TABLE (JobID INT, [Status] VARCHAR(MAX))
    DECLARE @EmployeesOnJob TABLE (JobID INT, EmployeeID INT)
    DECLARE @ReportFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
    DECLARE @RiskAssessmentFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
    DECLARE @BSRFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
                    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.Created DESC) as Row_Num, 

            *
        From 
			(
				Select * FROM @CompletedSurveysView
			) a
    )
    
    Insert into @CompletedSurveysTopLevel (Pages, Page, Row_Num, JobID, EndDate, SurveyTypeID, PropertyType)
    Select
		main.Pages,
        main.Page,
        main.Row_Num,
        main.JobID,
        main.EndDate,
        main.SurveyTypeID,
		main.PropertyType
    FROM
		Paging main
	Where 
        (
            main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )
	
	INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				cstl.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@CompletedSurveysTopLevel cstl
				INNER JOIN Job j WITH (NOLOCK) On cstl.JobID = j.JobId
				INNER JOIN ClientTemplate ct WITH (NOLOCK) ON ct.ClientID = j.ClientID
				INNER JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1
		
	Insert into @RegisterStatus (JobID, [Status])
	Select
		cstl.JobID, reg.[Status]
	FROM
		@CompletedSurveysTopLevel cstl
		INNER JOIN JobEmployee je WITH (NOLOCK) On cstl.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
	GROUP BY
		cstl.JobID, reg.[Status]
    
    Insert into @EmployeesOnJob (JobID, EmployeeID)
    SELECT
		cstl.JobID, je.EmployeeID
    FROM
		@CompletedSurveysTopLevel cstl
		INNER JOIN JobEmployee je WITH (NOLOCK) On cstl.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
	GROUP BY
		cstl.JobID, je.EmployeeID
	
	INSERT INTO @ReportFile(JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
		
	INSERT INTO @RiskAssessmentFile (JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
	
	INSERT INTO @BSRFile(JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
	
	SELECT
		rd.[Row_Total],
		rd.Pages,
		rd.Page,
		rd.Row_Num,
		rd.JobID,
		rd.EndDate,
		rd.[Surveyors],
		rd.JobNo,
		rd.ClientOrderNo,
		rd.BranchOfficeID,
		rd.Created,
		rd.LastNoteCreated,
		rd.SurveyTypeID,
		rd.[Description],
		rd.ClientID,
		rd.Client, 
		rd.MiCADId,
		rd.ProjectId,
		rd.[ProjectName], 
		rd.SiteId,
		rd.[Address],
		rd.Postcode,
		rd.UPRN,
		rd.[Status],
		rd.[isNew], 
		rd.[HasNotes],
		rd.[NotesInLastHour],
		rd.[FileName],
		rd.[RiskFileName],
		rd.[BSRFileName],
		rd.[BSRClientTemplateID],
		rd.[IsSupplementary],
		rd.PropertyType,
		rd.Approved
	FROM
	(
		SELECT  
			@TotalRowNumber [Row_Total],
			main.Pages,
			main.Page,
			main.Row_Num,
			main.JobID,
			main.EndDate,
			surveyors.List [Surveyors],
			j.JobNo,
			j.ClientOrderNo,
			j.BranchOfficeID,
			j.Created,
			j.LastNoteCreated,
			main.SurveyTypeID,
			sut.[Description],
			c.ClientID,
			c.Client + IsNull(Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' End, '') Client, 
			c.MiCADId,
			p.ProjectId,
			p.Project + ' / ' + p.GroupName [ProjectName], 
			s.SiteId,
			s.[Address],
			s.Postcode,
			s.UPRN,
			rs.[Status],
			ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
			CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
			CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			rep_File.[Filename] [FileName],
			rep_RA.[Filename] [RiskFileName],
			rep_BSR.[Filename] [BSRFileName],
			bsr_CT.TemplateID [BSRClientTemplateID],
			CASE	
				WHEN sc.SupplementaryChangeId IS NOT NULL
				THEN 1
			ELSE
				0
			END [IsSupplementary],
			main.PropertyType,
			j.Approved,
			ROW_NUMBER() OVER (Partition BY main.JobID Order by sc.DateCreated DESC) [Identifier]
		From 
			@CompletedSurveysTopLevel main
			INNER JOIN Job j WITH (NOLOCK) On main.JobID = j.JobId
			INNER JOIN SurveyType sut WITH (NOLOCK) ON sut.SurveyTypeID=main.SurveyTypeID
			INNER JOIN @RegisterStatus rs ON main.JobID=rs.JobID
			INNER JOIN
				(
					SELECT
						eoj.JobID, 
						e.[List]
					FROM
						@EmployeesOnJob eoj
						OUTER APPLY
						(
							SELECT STUFF((SELECT ', ' + e.FullName FROM Employee e WITH(NOLOCK) INNER JOIN @EmployeesOnJob sub_eoj ON e.EmployeeID=sub_eoj.EmployeeID WHERE eoj.JobID=sub_eoj.JobID GROUP BY e.FullName Order by e.FullName FOR XML PATH('')), 1, 2, '') [List]
						) e
					GROUP BY
						eoj.JobID, e.List
				) surveyors ON surveyors.JobID = j.JobID
			LEFT OUTER Join Client c On j.ClientID = c.ClientID 
			LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
			LEFT OUTER Join Site s On j.SiteID = s.SiteID
			
			LEFT OUTER JOIN @ReportFile rep_File ON rep_File.JobID = j.JobID
			LEFT OUTER JOIN @RiskAssessmentFile rep_RA ON rep_RA.JobID = j.JobID
			LEFT OUTER JOIN @BSRFile rep_BSR ON rep_BSR.JobID = j.JobID
			LEFT OUTER JOIN @BulkSampleClientTemplate bsr_CT ON bsr_CT.JobID=j.JobID
			LEFT OUTER JOIN SupplementaryChanges sc ON j.JobID = sc.JobId
		) rd
	WHERE
		rd.Identifier = 1
    Order By
        rd.Row_Num   
    
    SET NOCOUNT OFF;
END

GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoiceHistory')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_InvoiceHistory] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_InvoiceHistory]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
    @InvoiceID INT = 0,
	@InvoiceState INT = 0,
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0,
    @Filter VARCHAR(MAX) = '' -- Text entered in search box (part of address, postcode etc.)
/**********************************************************************
** Overview: Get the data for the Invoice History tab. Replaces the InvoiceHistory view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice History data - just the minimum ammount of data for speed.
    DECLARE @InvoiceHistoryData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoiceHistoryData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                (
                    i.DateCompleted IS NOT NULL
                        OR
                    i.DateDiscarded IS NOT NULL
                )
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
					AND
				(
					CASE WHEN @SiteID = 0 THEN
						1
					ELSE
						CASE WHEN @SiteID IN (Select SiteID FROM InvoiceItems Where InvoiceID=i.InvoiceID) THEN
							1
						ELSE
							0
						END
					END = 1				
				)
                    AND
                i.InvoiceDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
					(@InvoiceState = 0)
						OR
					(@InvoiceState = 1 AND i.DateDiscarded IS NULL)
						OR
					(@InvoiceState = 2 AND i.DateDiscarded IS NOT NULL)
				)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC,
	i.InvoiceNo DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoiceHistoryData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoiceHistoryData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        i.DateCompleted,
        i.DateDiscarded,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        lnc.DateCreated [LastNoteCreated],
        CAST(CASE WHEN lnc.DateCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN lnc.DateCreated IS NOT NULL
                THEN
                    CASE WHEN lnc.DateCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        i.OriginalInvoiceID,
        CAST(CASE WHEN EXISTS(SELECT 1 FROM Invoice _i WITH (NOLOCK) WHERE _i.OriginalInvoiceID = i.InvoiceID AND _i.DateDiscarded IS NULL) THEN 1 ELSE 0 END AS BIT) [HasAdditionalInvoices],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.InvoiceID = i.InvoiceID
                    AND
                _pf.DateDeleted IS NULL
            ORDER BY
                _pf.DateCreated DESC
        ) [FileName],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
        OUTER APPLY
        (
            SELECT MAX(n.DateCreated) [DateCreated]
            FROM Note n WITH (NOLOCK)
            WHERE
                n.NoteTypeID = 4 -- Invoice
                    AND
                n.ItemID = i.InvoiceID
        ) lnc -- Last Note Created
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoicesInProgress')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_InvoicesInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_InvoicesInProgress]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
	@SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
    @InvoiceID INT = 0,
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0,
    @Filter VARCHAR(MAX) = '' -- Text entered in search box (part of address, postcode etc.)
/**********************************************************************
** Overview: Get the data for the Invoices In Progress tab. Replaces the InvoicesInProgress view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceNo = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice In Progress data - just the minimum ammount of data for speed.
    DECLARE @InvoicesInProgressData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoicesInProgressData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                i.DateCompleted IS NULL
                    AND
                i.DateDiscarded IS NULL
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
                    AND
				(@SiteID = 0 OR ii.SiteID = @SiteID)
					AND
                i.DateCreated BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoicesInProgressData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoicesInProgressData
           ) a
    )   
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        i.LastNoteCreated,
        CAST(CASE WHEN i.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN i.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN i.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        CASE WHEN oi.InvoiceNo IS NOT NULL
            THEN dbo.FormatTeamsReference('I', oi.InvoiceNo)
            ELSE NULL
        END [OrigInvoiceNo],
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO

USE [TEAMS]
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetInvoiced')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetInvoiced] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_NotYetInvoiced]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @FilterEndStartDate DATETIME = NULL,
    @FilterEndFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    --@QuoteTypeID INT = 0,
    @QuoteVisitTypeID INT = 0,
    @Complete BIT = NULL,
    @JobID INT = 0,
    @Address VARCHAR(MAX) = NULL,
    @OrderByQuoteType INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByPostcode INT = 0,
    @OrderByProject INT = 0,
    @OrderByJobNo INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderByValue INT = 0,
    @OrderByDate INT = 0,
    @OrderByStartDate INT = 0,
    @OrderByFinishDate INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Invoiced tab. Replaces the NotYetInvoiced view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        --@FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        --@FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        --@FilterEndStartDate = ISNULL(@FilterEndStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        --@FilterEndFinishDate = ISNULL(@FilterEndFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Address = NULLIF(LTRIM(RTRIM(@Address)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByQuoteType = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByPostcode = 0 AND @OrderByProject = 0 AND @OrderByJobNo = 0 AND @OrderByClientOrderNo = 0 AND @OrderByValue = 0 AND @OrderByDate = 0
    BEGIN
        SET @OrderByDate = 2
    END
    
    -- Set variables for logic.
    DECLARE @b__NYI_AirTestCompletedPriorToday BIT, @i__maxNoOfNoAccessBeforeRaiseQuote INT
    SELECT
        @b__NYI_AirTestCompletedPriorToday = cfg.b__NYI_AirTestCompletedPriorToday,
        @i__maxNoOfNoAccessBeforeRaiseQuote = cfg.i__maxNoOfNoAccessBeforeRaiseQuote
    FROM
        Config cfg WITH (NOLOCK)

    DECLARE @NotYetInvoicedJobs TABLE (JobID INT, JobNo INT, InvoiceItemID INT, NoAccess BIT, Created DATETIME, HasAppointment BIT, AppointmentCost MONEY, AppointmentClientOrderNo VARCHAR(MAX), DateConfirmed DATETIME, AppointmentTypeID INT, HasNoAccess BIT)
    INSERT INTO @NotYetInvoicedJobs (JobID, JobNo, InvoiceItemID, NoAccess, Created, HasAppointment, AppointmentCost, AppointmentClientOrderNo, DateConfirmed, AppointmentTypeID, HasNoAccess)
    SELECT
            a.JobID, a.JobNo, a.InvoiceItemID, 0 [NoAccess], a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID, a.HasNoAccess
      FROM
      (
            SELECT
                  j.JobID,
                  j.JobNo,
                  q.InvoiceItemID,
                  CAST(ISNULL(a.EndTime, q.Created) AS DATE) [Created],
                  CASE WHEN a.AppointmentID IS NOT NULL THEN 1 ELSE 0 END [HasAppointment],
                  a.Cost [AppointmentCost],
                  a.ClientOrderNo [AppointmentClientOrderNo],
                  a.DateConfirmed,
                  a.AppointmentTypeID,
                  CASE WHEN na.NoAccessID IS NOT NULL THEN 1 ELSE 0 END [HasNoAccess],
                  ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY a.EndTime ASC, q.Created ASC) [Identified]
            FROM
                  Job j WITH (NOLOCK)
                  INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
                  LEFT JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
                  LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
                  INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                  INNER JOIN QuoteType qt WITH (NOLOCK) ON qt.QuoteTypeID=q.QuoteTypeID
                  LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                  LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
            WHERE
                  (CASE WHEN @QuoteVisitTypeID = 0 THEN 1 ELSE CASE WHEN qt.QuoteVisitTypeID=@QuoteVisitTypeID THEN 1 ELSE 0 END END = 1)
                        AND
                  q.Accepted IS NOT NULL
                        AND
                  j.Cancelled IS NULL
                        AND
                  j.ImportID IS NULL
                        AND
                  a.DateDeclined IS NULL
                        AND -- NOTE: These WHERE clauses are repeated in the second UNION.
                  (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @Address IS NULL THEN 1 ELSE CASE WHEN si.[Address] LIKE '%' + @Address + '%' OR a.ClientOrderNo LIKE '%' + @Address + '%' THEN 1 ELSE 0 END END = 1)
      ) a
      WHERE
            a.Identified = 1
                  AND
            (
                  CASE WHEN a.HasNoAccess = 0 THEN
                        CASE WHEN a.InvoiceItemID IS NULL THEN 1 ELSE 0 END
                  ELSE
                        1
                  END = 1
            )

	IF @i__maxNoOfNoAccessBeforeRaiseQuote < 999 BEGIN
      INSERT INTO @NotYetInvoicedJobs (JobID, InvoiceItemID, NoAccess, Created, HasAppointment, AppointmentCost, AppointmentClientOrderNo, DateConfirmed, AppointmentTypeID, HasNoAccess)
      SELECT
            a.JobID, a.InvoiceItemID, 1, a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID, 1
      FROM  
            (
                  SELECT nyij.JobID, nyij.JobNo, dbo.FormatTeamsReference('J',nyij.JobNo) [FormattedJobNo], nyij.InvoiceItemID, 1 [NoAccess], nyij.Created, nyij.HasAppointment, nyij.AppointmentCost, nyij.AppointmentClientOrderNo, nyij.DateConfirmed, nyij.AppointmentTypeID  FROM @NotYetInvoicedJobs nyij LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = nyij.JobID WHERE nyij.HasNoAccess = 1
            ) a
            LEFT OUTER JOIN InvoiceItem ii WITH (NOLOCK) ON (ii.JobNo = a.FormattedJobNo OR ii.InvoiceItemID=a.InvoiceItemID)
            LEFT OUTER JOIN Invoice i WITH (NOLOCK) ON i.InvoiceID=ii.InvoiceID
      WHERE
            (
            CASE WHEN ii.InvoiceItemID IS NULL THEN
                        1
                  ELSE
                        CASE WHEN ii.InvoiceItemID=a.InvoiceItemID AND i.DateCompleted IS NULL THEN
                              1
                        ELSE
                              0
                        END
                  END = 1
        )
      GROUP BY
            a.JobID, a.InvoiceItemID, a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID
      HAVING 
            COUNT(*) >= @i__maxNoOfNoAccessBeforeRaiseQuote
	END


    DECLARE @NotYetInvoicedData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, BranchOfficeID INT, QuoteTypeID INT, QuoteType VARCHAR(100), ClientID INT, Client VARCHAR(210), ProjectID INT, Project VARCHAR(110), SiteID INT, Address VARCHAR(200), Postcode VARCHAR(10), Created DATETIME, Value MONEY, ClientOrderNo VARCHAR(50), JobID INT, JobNo INT, Complete BIT, StartDate DATETIME, FinishDate DATETIME)

    INSERT INTO @NotYetInvoicedData (QuoteID, QuoteNo, BranchOfficeID, QuoteTypeID, QuoteType, ClientID, Client, ProjectID, Project, SiteID, Address, Postcode, Created, Value, ClientOrderNo, JobID, JobNo, Complete, StartDate, FinishDate)
    SELECT
        i.QuoteID,
        i.QuoteNo,
        i.BranchOfficeID,
        i.QuoteTypeID,
        i.QuoteType,
        i.ClientID,
        i.Client,
        i.ProjectID,
        i.Project,
        i.SiteID,
        i.Address,
        i.Postcode,
        i.Created,
        i.Value,
        i.ClientOrderNo,
        i.JobID,
        i.JobNo,
        i.Complete,
        i.StartDate,
        i.FinishDate
    FROM
        (
            -- Normal joins for displaying in Not Yet Invoiced.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                nyij.Created [Created], -- NOTE: When adjusting, also adjust the HAVING.
                ISNULL(MAX(a.Cost), MAX(q.Value)) [Value],
                ISNULL(NULLIF(a.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete,
                CAST(COALESCE(MIN(r.RegisterStart), MIN(at.AirTestStart), MIN(l.LegionellaStart), nyij.Created) AS DATE) [StartDate],
                CAST(COALESCE(MAX(r.RegisterFinish), MAX(at.AirTestFinish), MAX(l.LegionellaFinish), nyij.Created) AS DATE) [FinishDate]
            FROM
                @NotYetInvoicedJobs nyij
                INNER JOIN Quote q WITH (NOLOCK) ON nyij.JobID = q.JobID
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN AirTestType att WITH (NOLOCK) ON at.AirTestTypeID = att.AirTestTypeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                LEFT JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = qt.TemplateTypeID
                LEFT JOIN TemplateTypeGroup tg WITH (NOLOCK) ON Not tg.GroupId = 0 And tg.GroupId = tt.GroupNo 
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                a.AppointmentID IS NOT NULL
                                    AND
                                a.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        a.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        a.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                                OR
                            ( -- Quote has a Bulk Sample Report that is not Approved.
                                a.AppointmentID IS NULL
                                    AND
                                qt.QuoteTypeID = 6
                                    AND
                                j.Approved IS NULL
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                nyij.InvoiceItemID IS NULL -- Make sure the Quote isn't already on an Invoice.
                    AND
                ( -- Work out if the work has been done:
                    ( -- Quote has an Appointment that is confirmed.
                        a.AppointmentID IS NOT NULL
                            AND
                        a.DateConfirmed IS NOT NULL
                            AND
                        (
                            ( -- Is a Survey that has work done.
                                a.AppointmentTypeID = 1
                                    AND
                                (r.RegisterID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is an Air Test.
                                a.AppointmentTypeID = 3
                                    AND
                                (
                                    (at.AirTestID IS NULL AND a.ManuallyMarkWorkDone = 1)
                                        OR
                                    (at.AirTestID IS NOT NULL AND att.AirTestTypeID IS NOT NULL)
                                )
                            )
                                OR
                            ( -- Is a Training Appointment.
                                a.AppointmentTypeID = 4
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                                OR
                            ( -- Is a Legionella Survey that has work done.
                                a.AppointmentTypeID = 9
                                    AND
                                (l.LegionellaID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is a general Appointment and work has been marked as done if booked.
                                a.AppointmentTypeID NOT IN (1, 3, 9)
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                        )
                    )
                        OR
                    ( -- Quote has a Bulk Sample Report that is approved.
                        a.AppointmentID IS NULL
                            AND
                        qt.QuoteTypeID = 6
                    )
                )
                    AND
                nyij.NoAccess = 0
					AND
				a.DateDeclined IS NULL
            GROUP BY
                nyij.Created,
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client,
                c.BranchName,
                p.ProjectID,
                p.Project,
                p.GroupName,
                si.SiteID,
                si.Address,
                si.Postcode,
                a.AppointmentTypeID,
                a.ClientOrderNo,
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                com.Complete
            HAVING -- NOTE: When adjusting, also adjust the SELECT column for the Created date.
                CASE WHEN a.AppointmentTypeID = 3 -- Will not show Air Test Appointments until the current date is greater than the Appoinment date.
                    THEN CASE WHEN @b__NYI_AirTestCompletedPriorToday = 1 AND MIN(nyij.Created) > GETDATE() THEN 0 ELSE 1 END
                   ELSE 1
                END = 1

            UNION

            /*
            TEMP table and check this for each job to populate, that way the below can be from that table as base, should increase speed a large amount
                        (SELECT COUNT(*) FROM NoAccess WITH (NOLOCK) WHERE JobID = j.JobID AND Deleted IS NULL) >= @i__maxNoOfNoAccessBeforeRaiseQuote
            
            Will need to do a straight join from previous TEMP table on JobNo (this is a varchar(10) /golfclap)
                NOT EXISTS (SELECT 1 FROM InvoiceItem WITH (NOLOCK) WHERE JobNo = dbo.FormatTeamsReference('J', j.JobNo))
            Select top 10 * FROM InvoiceItem
            */

            -- No Access data.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                125 [QuoteTypeID],
                (SELECT QuoteType FROM QuoteType WITH (NOLOCK) WHERE QuoteTypeID = 125) [QuoteType],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                CAST(ISNULL(nyij.Created, q.Created) AS DATE) [Created],
                ISNULL(nyij.AppointmentCost, q.Value) [Value],
                ISNULL(NULLIF(nyij.AppointmentClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete,
                nyij.Created [StartDate],
                nyij.Created [FinishDate]
                --CAST(COALESCE(r.RegisterStart, at.AirTestStart, l.LegionellaStart, nyij.Created) AS DATE) [StartDate],
                --CAST(COALESCE(r.RegisterFinish, at.AirTestFinish, l.LegionellaFinish, nyij.Created) AS DATE) [FinishDate]
            FROM
                @NotYetInvoicedJobs nyij
                INNER JOIN Quote q WITH (NOLOCK) ON nyij.JobID = q.JobID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                INNER JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                nyij.HasAppointment IS NOT NULL
                                    AND
                                nyij.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        nyij.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        nyij.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                nyij.NoAccess = 1
        ) i
    WHERE
        (CASE WHEN @FilterStartDate IS NOT NULL AND @FilterFinishDate IS NOT NULL
            THEN
                CASE WHEN i.StartDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    THEN 1
                    ELSE 0
                END
            ELSE 1
        END = 1
            OR
        CASE WHEN @FilterEndStartDate IS NOT NULL AND @FilterEndFinishDate IS NOT NULL
            THEN
                CASE WHEN i.FinishDate BETWEEN @FilterEndStartDate AND @FilterEndFinishDate
                    THEN 1
                    ELSE 0
                END
            ELSE 1
        END = 1)
            AND
        (
            @Complete IS NULL
                OR
            (@Complete = 0 AND i.Complete = 0)
                OR
            (@Complete = 1 AND i.Complete = 1)
        )
    ORDER BY
        CASE WHEN @OrderByQuoteType = 1 THEN i.QuoteType ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteType = 2 THEN i.QuoteType ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN i.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN i.Address ELSE NULL END DESC,
        CASE WHEN @OrderByPostcode = 1 THEN i.Postcode ELSE NULL END ASC,
        CASE WHEN @OrderByPostcode = 2 THEN i.Postcode ELSE NULL END DESC,
        CASE WHEN @OrderByProject = 1 THEN i.Project ELSE NULL END ASC,
        CASE WHEN @OrderByProject = 2 THEN i.Project ELSE NULL END DESC,
        CASE WHEN @OrderByJobNo = 1 THEN i.JobNo ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN i.JobNo ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN i.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN i.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN i.Value ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN i.Value ELSE NULL END DESC,
        CASE WHEN @OrderByStartDate = 1 THEN i.StartDate ELSE NULL END ASC,
        CASE WHEN @OrderByStartDate = 2 THEN i.StartDate ELSE NULL END DESC,
        CASE WHEN @OrderByFinishDate = 1 THEN i.FinishDate ELSE NULL END ASC,
        CASE WHEN @OrderByFinishDate = 2 THEN i.FinishDate ELSE NULL END DESC

    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetInvoicedData);

    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetInvoicedData
           ) a
    )


    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        q.BranchOfficeID,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.QuoteTypeID,
        pag.QuoteType,
        apt.AppointmentTypeID,
        ISNULL(apt.AppointmentType, 'Samples') [AppointmentType],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.Project,
        pag.SiteID,
        pag.Address,
        pag.Postcode,
        si.UPRN,
        pag.Created,
        CAST(CASE WHEN pag.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Value,
        pag.ClientOrderNo,
        pag.JobID,
        pag.JobNo,
        NULLIF(j.ClientOrderNo, '') [JobClientOrderNo],
        pag.Complete,
        pag.StartDate,
        pag.FinishDate
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
        LEFT JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

    SELECT
            a.QuoteVisitTypeID, a.QuoteVisitType, a.Value, a.Ordering
    FROM
      (
            SELECT 
                  qvt.QuoteVisitTypeID, qvt.Description [QuoteVisitType]/*, qt.QuoteType*/, SUM(nyid.Value) [Value], 0 [Ordering], MAX(nyid.QuoteID) [test]
            FROM 
                  QuoteVisitType qvt WITH (NOLOCK)
                  LEFT OUTER JOIN QuoteType qt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qt.QuoteVisitTypeID
                  LEFT OUTER JOIN Quote q WITH (NOLOCK) ON qt.QuoteTypeID=q.QuoteTypeID
                  LEFT OUTER JOIN
                  (
                        Select
                              nyid.JobID, nyid.QuoteID, MAX(nyid.Value) [Value]
                        FROM
                              @NotYetInvoicedData nyid
                        GROUP BY
                              nyid.JobID, nyid.QuoteID
                  ) nyid ON nyid.QuoteID=q.QuoteID
            WHERE
                  qvt.Deleted IS NULL
            GROUP BY
                  qvt.QuoteVisitTypeID,qvt.Description
            UNION
            SELECT 
                  NULL [QuoteVisitTypeID], 'Total' [QuoteVisitType], /*'Total' [QuoteType],*/ SUM(nyid.Value) [Value], 1 [Ordering], 0 [test]
            FROM 
                  QuoteVisitType qvt WITH (NOLOCK)
                  LEFT OUTER JOIN
                  (
                        Select
                              nyid.JobID, nyid.QuoteID, qt.QuoteVisitTypeID, MAX(nyid.Value) [Value]
                        FROM
                              @NotYetInvoicedData nyid
                              INNER JOIN Quote q WITH (NOLOCK) ON nyid.QuoteID=q.QuoteID
                              INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID=qt.QuoteTypeID
                        GROUP BY
                              nyid.JobID, nyid.QuoteID, qt.QuoteVisitTypeID
                  ) nyid ON qvt.QuoteVisitTypeID=nyid.QuoteVisitTypeID
      ) a
      ORDER BY
          a.Ordering,
          a.QuoteVisitType


    SET NOCOUNT OFF;
END


GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetInvoicedWithGroupFilter')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetInvoicedWithGroupFilter] AS BEGIN SET NOCOUNT ON; END')
END


/****** Object:  StoredProcedure [dbo].[Paged_NotYetInvoicedWithGroupFilter]    Script Date: 01/18/2017 20:38:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_NotYetInvoicedWithGroupFilter]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    --@QuoteTypeID INT = 0,
	@GroupID INT = 0,
    @Complete BIT = NULL,
    @JobID INT = 0,
    @Address VARCHAR(MAX) = NULL,
    @OrderByQuoteType INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByPostcode INT = 0,
    @OrderByProject INT = 0,
    @OrderByJobNo INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderByValue INT = 0,
    @OrderByDate INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Invoiced tab. Replaces the NotYetInvoiced view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Address = NULLIF(LTRIM(RTRIM(@Address)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByQuoteType = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByPostcode = 0 AND @OrderByProject = 0 AND @OrderByJobNo = 0 AND @OrderByClientOrderNo = 0 AND @OrderByValue = 0 AND @OrderByDate = 0
    BEGIN
        SET @OrderByDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByQuoteType [OrderByQuoteType],
        @OrderByClient [OrderByClient],
        @OrderBySite [OrderBySite],
        @OrderByPostcode [OrderByPostcode],
        @OrderByProject [OrderByProject],
        @OrderByJobNo [OrderByJobNo],
        @OrderByClientOrderNo [OrderByClientOrderNo],
        @OrderByValue [OrderByValue],
        @OrderByDate [OrderByDate]
    */
    
    -- Set variables for logic.
    DECLARE @b__NYI_AirTestCompletedPriorToday BIT, @i__maxNoOfNoAccessBeforeRaiseQuote INT
    SELECT
        @b__NYI_AirTestCompletedPriorToday = cfg.b__NYI_AirTestCompletedPriorToday,
        @i__maxNoOfNoAccessBeforeRaiseQuote = cfg.i__maxNoOfNoAccessBeforeRaiseQuote
    FROM
        Config cfg WITH (NOLOCK)
    
    -- Get all the Not Yet Invoiced data - just the minimum ammount of data for speed.
    -- NOTE: Looking at comments from the old view, j.Approved logic has been removed as it's been superseded by the Completed field below.
    DECLARE @NotYetInvoicedData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, BranchOfficeID INT, QuoteTypeID INT, QuoteType VARCHAR(100), ClientID INT, Client VARCHAR(210), ProjectID INT, Project VARCHAR(110), SiteID INT, Address VARCHAR(200), Postcode VARCHAR(10), Created DATETIME, Value MONEY, ClientOrderNo VARCHAR(50), JobID INT, JobNo INT, Complete BIT)
    
    INSERT INTO @NotYetInvoicedData
    SELECT
        i.QuoteID,
        i.QuoteNo,
        i.BranchOfficeID,
        i.QuoteTypeID,
        i.QuoteType,
        i.ClientID,
        i.Client,
        i.ProjectID,
        i.Project,
        i.SiteID,
        i.Address,
        i.Postcode,
        i.Created,
        i.Value,
        i.ClientOrderNo,
        i.JobID,
        i.JobNo,
        i.Complete
    FROM
        (
            -- Normal joins for displaying in Not Yet Invoiced.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                MIN(CAST(ISNULL(a.EndTime, q.Created) AS DATE)) [Created], -- NOTE: When adjusting, also adjust the HAVING.
                ISNULL(MAX(a.Cost), MAX(q.Value)) [Value],
                ISNULL(NULLIF(a.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete
            FROM
                Quote q WITH (NOLOCK)
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN AirTestType att WITH (NOLOCK) ON at.AirTestTypeID = att.AirTestTypeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
				LEFT JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = qt.TemplateTypeID
				LEFT JOIN TemplateTypeGroup tg WITH (NOLOCK) ON Not tg.GroupId = 0 And tg.GroupId = tt.GroupNo 
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                a.AppointmentID IS NOT NULL
                                    AND
                                a.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        a.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        a.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                                OR
                            ( -- Quote has a Bulk Sample Report that is not Approved.
                                a.AppointmentID IS NULL
                                    AND
                                qt.QuoteTypeID = 6
                                    AND
                                j.Approved IS NULL
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                q.Accepted IS NOT NULL -- Make sure the Quote has been Accepted.
                    AND
                q.InvoiceItemID IS NULL -- Make sure the Quote isn't already on an Invoice.
                    AND
                a.DateDeclined IS NULL -- Make sure the Appointment is not declined.
                    AND
                j.Cancelled IS NULL -- Make sure the Job has not been cancelled.
                    AND
                ( -- Work out if the work has been done:
                    ( -- Quote has an Appointment that is confirmed.
                        a.AppointmentID IS NOT NULL
                            AND
                        a.DateConfirmed IS NOT NULL
                            AND
                        (
                            ( -- Is a Survey that has work done.
                                a.AppointmentTypeID = 1
                                    AND
                                (r.RegisterID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is an Air Test.
                                a.AppointmentTypeID = 3
                                    AND
                                (
                                    (at.AirTestID IS NULL AND a.ManuallyMarkWorkDone = 1)
                                        OR
                                    (at.AirTestID IS NOT NULL AND att.AirTestTypeID IS NOT NULL)
                                )
                            )
                                OR
                            ( -- Is a Training Appointment.
                                a.AppointmentTypeID = 4
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                                OR
                            ( -- Is a Legionella Survey that has work done.
                                a.AppointmentTypeID = 9
                                    AND
                                (l.LegionellaID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is a general Appointment and work has been marked as done if booked.
                                a.AppointmentTypeID NOT IN (1, 3, 9)
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                        )
                    )
                        OR
                    ( -- Quote has a Bulk Sample Report that is approved.
                        a.AppointmentID IS NULL
                            AND
                        qt.QuoteTypeID = 6
                    )
                )
                    AND -- NOTE: These WHERE clauses are repeated in the second UNION.
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR p.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                (@BranchOfficeID = 0 OR q.BranchOfficeID = @BranchOfficeID)
                    AND
                (@GroupID = 0 OR tg.GroupID = @GroupID)
                    AND
                (@JobID = 0 OR j.JobID = @JobID)
                    AND
                (@Address IS NULL OR si.Address LIKE '%' + @Address + '%')
            GROUP BY
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client,
                c.BranchName,
                p.ProjectID,
                p.Project,
                p.GroupName,
                si.SiteID,
                si.Address,
                si.Postcode,
                a.AppointmentTypeID,
                a.ClientOrderNo,
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                com.Complete
            HAVING -- NOTE: When adjusting, also adjust the SELECT column for the Created date.
                CASE WHEN a.AppointmentTypeID = 3 -- Will not show Air Test Appointments until the current date is greater than the Appoinment date.
                    THEN CASE WHEN @b__NYI_AirTestCompletedPriorToday = 1 AND MIN(CAST(ISNULL(a.EndTime, q.Created) AS DATE)) > GETDATE() THEN 0 ELSE 1 END
                    ELSE 1
                END = 1
            
            UNION
            
            -- No Access data.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                125 [QuoteTypeID],
                (SELECT QuoteType FROM QuoteType WITH (NOLOCK) WHERE QuoteTypeID = 125) [QuoteType],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                CAST(ISNULL(fa.EndTime, q.Created) AS DATE) [Created],
                ISNULL(fa.Cost, q.Value) [Value],
                ISNULL(NULLIF(fa.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete
            FROM
                Quote q WITH (NOLOCK)
                OUTER APPLY
                (
                    SELECT TOP 1 _a.*
                    FROM Appointment _a WITH (NOLOCK)
                    WHERE
                        _a.QuoteID = q.QuoteID
                            AND
                        _a.DateDeclined IS NULL
                ) fa -- First Appointment
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                INNER JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                fa.AppointmentID IS NOT NULL
                                    AND
                                fa.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        fa.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        fa.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                (
                    q.InvoiceItemID IS NULL
                        OR -- IS THIS LINE CORRECT (JOIN TO INVOICE)?
                    (q.InvoiceItemID IS NOT NULL AND NOT EXISTS (SELECT 1 FROM Invoice WITH (NOLOCK) WHERE InvoiceID = q.InvoiceItemID AND DateCompleted IS NOT NULL))
                )
                    AND
                (SELECT COUNT(*) FROM NoAccess WITH (NOLOCK) WHERE JobID = j.JobID AND Deleted IS NULL) >= @i__maxNoOfNoAccessBeforeRaiseQuote
                    AND
                NOT EXISTS (SELECT 1 FROM InvoiceItem WITH (NOLOCK) WHERE JobNo = dbo.FormatTeamsReference('J', j.JobNo))
                    AND -- NOTE: These WHERE clauses are repeated in the first UNION.
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR p.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                (@BranchOfficeID = 0 OR q.BranchOfficeID = @BranchOfficeID)
                    AND
                --(@QuoteTypeID = 0 OR 125 = @QuoteTypeID)
                --    AND
                (@JobID = 0 OR j.JobID = @JobID)
                    AND
                (@Address IS NULL OR si.Address LIKE '%' + @Address + '%')
        ) i
    WHERE
        i.Created BETWEEN @FilterStartDate AND @FilterFinishDate
            AND
        (
            @Complete IS NULL
                OR
            (@Complete = 0 AND i.Complete = 0)
                OR
            (@Complete = 1 AND i.Complete = 1)
        )
    ORDER BY
        CASE WHEN @OrderByQuoteType = 1 THEN i.QuoteType ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteType = 2 THEN i.QuoteType ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN i.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN i.Address ELSE NULL END DESC,
        CASE WHEN @OrderByPostcode = 1 THEN i.Postcode ELSE NULL END ASC,
        CASE WHEN @OrderByPostcode = 2 THEN i.Postcode ELSE NULL END DESC,
        CASE WHEN @OrderByProject = 1 THEN i.Project ELSE NULL END ASC,
        CASE WHEN @OrderByProject = 2 THEN i.Project ELSE NULL END DESC,
        CASE WHEN @OrderByJobNo = 1 THEN i.JobNo ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN i.JobNo ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN i.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN i.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN i.Value ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN i.Value ELSE NULL END DESC,
        CASE WHEN @OrderByDate = 1 THEN i.Created ELSE NULL END ASC,
        CASE WHEN @OrderByDate = 2 THEN i.Created ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetInvoicedData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetInvoicedData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        q.BranchOfficeID,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.QuoteTypeID,
        pag.QuoteType,
        apt.AppointmentTypeID,
        ISNULL(apt.AppointmentType, 'Samples') [AppointmentType],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.Project,
        pag.SiteID,
        pag.Address,
        pag.Postcode,
        si.UPRN,
        pag.Created,
        CAST(CASE WHEN pag.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Value,
        pag.ClientOrderNo,
        pag.JobID,
        pag.JobNo,
        NULLIF(j.ClientOrderNo, '') [JobClientOrderNo],
        pag.Complete
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
        LEFT JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END



GO



USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetScheduled')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetScheduled] AS BEGIN SET NOCOUNT ON; END')
END



/****** Object:  StoredProcedure [dbo].[Paged_NotYetScheduled]    Script Date: 01/18/2017 20:38:46 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_NotYetScheduled]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @QuoteID INT = 0,
	@QuoteTypeID INT = 0,
    @Site VARCHAR(MAX) = NULL,
    @OrderByAccepted INT = 0,
    @OrderByQuoteNo INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByNotes INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Scheduled tab. Replaces the NotYetScheduled view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Site = NULLIF(LTRIM(RTRIM(@Site)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByAccepted = 0 AND @OrderByQuoteNo = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByNotes = 0
    BEGIN
        SET @OrderByAccepted = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByAccepted [OrderByAccepted],
        @OrderByQuoteNo [OrderByQuoteNo],
        @OrderByClient [OrderByClient],
        @OrderBySite [OrderBySite],
        @OrderByNotes [OrderByNotes]
    */
    
    -- Get all the Not Yet Scheduled data - just the minimum ammount of data for speed.
    DECLARE @NotYetScheduledData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, Notes VARCHAR(MAX), Accepted DATETIME, ClientID INT, Client VARCHAR(210), ProjectID INT, SiteID INT, Site VARCHAR(220), RemovalID INT, IsBackFromMobileTeams BIT, IsRemovalQuoteVisit BIT, IsRemovalWorkVisit BIT)
    
    INSERT INTO @NotYetScheduledData
    SELECT
        q.QuoteID,
        q.QuoteNo,
        q.Notes,
        q.Accepted,
        q.ClientID,
        q.Client,
        q.ProjectID,
        q.SiteID,
        q.Site,
        q.RemovalID,
        q.IsBackFromMobileTeams,
        q.IsRemovalQuoteVisit,
        q.IsRemovalWorkVisit
    FROM
        (
            SELECT
                q.QuoteID,
                q.QuoteNo,
                ISNULL(NULLIF(q.Status, ''), q.DetailsOfWork) [Notes],
                q.Accepted,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                q.ProjectID,
                si.SiteID,
                si.Address + ISNULL(', ' + NULLIF(si.Postcode, ''), '') [Site],
                rem.RemovalID, -- Also get the Removal columns, so we don't have to hit the View twice.
                rem.IsBackFromMobileTeams,
                rem.IsRemovalQuoteVisit,
                rem.IsRemovalWorkVisit
            FROM
                Quote q WITH (NOLOCK)
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID -- Remove to include Sample quotes.
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Removals rem WITH (NOLOCK) ON q.QuoteID = rem.QuoteID
            WHERE
                q.Rejected IS NULL -- Not rejected.
                    AND
                q.Accepted IS NOT NULL -- Has been accepted.
                    AND
                (
                    ( -- Logic for most quotes.
                        (
                            qt.QuoteType != 'Removals (Notifiable)'
                                AND
                            qt.QuoteType != 'Removals (Non-Notifiable)'
                        )
                            AND
                        NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE QuoteID = q.QuoteID AND AppointmentTypeID != 8)
                            AND
                        NOT EXISTS (SELECT 1 FROM Job WITH (NOLOCK) WHERE JobID = q.JobID)
                            AND
                        NOT EXISTS (SELECT 1 FROM ProjectAppointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            AND
                        (
                            q.SiteID IS NOT NULL
                                OR
                            (
                                q.SiteID IS NULL
                                    AND
                                NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            )
                        )
                    )
                        OR
                    ( -- Logic for Removal quotes.
                        (
                            qt.QuoteType = 'Removals (Notifiable)'
                                OR
                            qt.QuoteType = 'Removals (Non-Notifiable)'
                        )
                            AND
                        ISNULL(rem.isBackFromMobileTeams, 0) = 1
                            AND
                        ISNULL(rem.isRemovalQuoteVisit, 0) = 1
                            AND
                        -- Make sure neither the Quote visit or Site visit for the Quote has no Appointment.
                        NOT EXISTS (SELECT 1 FROM Removals WITH (NOLOCK) WHERE RemovalID = rem.RemovalID AND AppointmentID IS NOT NULL AND ISNULL(isRemovalWorkVisit, 0) = 1 AND ISNULL(isBackFromMobileTeams, 0) = 1)
                    )
                )
                    AND
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR q.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                q.Accepted BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@QuoteID = 0 OR q.QuoteID = @QuoteID)
					AND
				(@QuoteTypeID = 0 OR q.QuoteTypeID = @QuoteTypeID)
        ) q
    WHERE
        (@Site IS NULL OR q.Site LIKE '%' + @Site + '%')
    ORDER BY
        CASE WHEN @OrderByAccepted = 1 THEN q.Accepted ELSE NULL END ASC,
        CASE WHEN @OrderByAccepted = 2 THEN q.Accepted ELSE NULL END DESC,
        CASE WHEN @OrderByQuoteNo = 1 THEN q.QuoteNo ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteNo = 2 THEN q.QuoteNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN q.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN q.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN q.Site ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN q.Site ELSE NULL END DESC,
        CASE WHEN @OrderByNotes = 1 THEN q.Notes ELSE NULL END ASC,
        CASE WHEN @OrderByNotes = 2 THEN q.Notes ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetScheduledData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((a.IndexID - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetScheduledData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.IndexID [Row_Num],
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        pag.Notes,
        q.Created,
        CAST(CASE WHEN q.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Accepted,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        qt.QuoteTypeID,
        qt.QuoteType,
        pag.ClientID,
        pag.Client,
        p.ProjectID,
        p.ProjectGroupID,
        NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
        pag.SiteID,
        si.Address,
        si.Postcode,
        pag.Site,
        si.UPRN,
        pag.RemovalID,
        pag.IsBackFromMobileTeams,
        pag.IsRemovalQuoteVisit,
        pag.IsRemovalWorkVisit
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN Project p WITH (NOLOCK) ON pag.ProjectID = p.ProjectID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
    WHERE
        (pag.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.IndexID
    
    
    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'DiscardReason' AND OBJECT_ID = OBJECT_ID('Enquiry'))
BEGIN
    ALTER TABLE [dbo].[Enquiry]
    ADD [DiscardReason] [varchar] (MAX) NULL;
END
GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingQuotes')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingQuotes] AS BEGIN SET NOCOUNT ON; END')
END


/****** Object:  StoredProcedure [dbo].[Paged_OutstandingQuotes]    Script Date: 01/18/2017 20:39:23 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */

ALTER PROCEDURE [dbo].[Paged_OutstandingQuotes] 
      @PerPage INT = 15,
      @CurrentPage INT = 1,
      @ClientID INT = 0,
      @SiteID INT = 0,
      @ProjectID INT = 0,
      @OutstandingQuotesFilterAssignedTo INT = 0,
      @OutstandingQuotesFilterQuoteType INT = 0,
      @OutstandingQuotesHideInstaquote INT = 0,
      @QuoteID INT = 0,
      @EnquiryID INT = 0,
      @FilterStartDate DATETIME = NULL,
      @FilterEndDate DATETIME = NULL,
      @Filter VARCHAR(MAX) = ''
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @OutstandingQuotesViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @OutstandingQuotesView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX))
      
  	  Insert into @OutstandingQuotesViewID (ItemID,ItemType,Created)
	  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
	  From
			Quote q 
			Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
			Left Outer Join Job j On q.JobId = j.JobId
			Left Outer Join Client c On c.ClientID = q.ClientID 
			Left Outer Join Project p On p.ProjectID = q.ProjectID 
			Left Outer Join Site s On s.SiteID = q.SiteID
			LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID
			OUTER APPLY
			(
				SELECT CASE when
				EXISTS 
				( 
		        
					SELECT 
						'x'
					FROM
						[dbo].[Appointment] [a]
						INNER JOIN [dbo].[AppointmentType] [at] ON [at].[AppointmentTypeId] = [a].[AppointmentTypeID]
					WHERE
						[a].[QuoteID] = [q].[QuoteID]     
							AND
						[a].[AppointmentTypeID] = 8
				)
				THEN 
					1
				ELSE 
					0
				END 
			)isQuoteVisitApointment(val)
	  Where 
			(
				  LEN(@Filter ) = 0
						OR
				  (
						s.Address Like '%' + @Filter + '%'
							  Or 
						s.Postcode Like '%' + @Filter + '%'
							  Or 
						s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
						Or s.UPRN = @Filter
				)
			)
				  AND
			(
				CASE WHEN qt.QuoteVisitTypeID IS NOT NULL AND [isQuoteVisitApointment].[val] = 1 THEN
					(Select COUNT(*) FROM QuoteVisit qv INNER JOIN QuoteEmployee qe ON qv.QuoteEmployeeID=qe.QuoteEmployeeID Where qe.QuoteID=q.QuoteID AND qe.EmployeeID>0)
				ELSE
					1
				END = 1
			)
				And
			(Accepted Is Null) 
				AND
			(Rejected IS NULL)
				AND					  
			(@ProjectID=0 OR q.ProjectID=@ProjectID)
				  AND
			(@SiteID=0 OR q.SiteID=@SiteID)
				  AND
			(@ClientID=0 OR q.ClientID=@ClientID)
				  AND
			(
				  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
						CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
				  ELSE
						CASE WHEN
							  (
									q.Created BETWEEN @FilterStartDate AND @FilterEndDate
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @OutstandingQuotesFilterAssignedTo THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @OutstandingQuotesFilterQuoteType THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesHideInstaquote = 0 THEN 0 ELSE 
										Cast(
											Case When q.ReallyQuickQuote = 1 Then 
												1
											Else 
												0 
											End as bit) 
									END = 0
							  )
						THEN 1 ELSE 0 END
				  END = 1
			)
      
	  DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @OutstandingQuotesViewID)
		            
      ;With Paging As 
		( 
			Select 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
				END As Pages, 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
				END As Page, 

				   Row_Number() Over(Order By a.Created DESC) as Row_Num, 
				   *
				   From 
				   (
						Select * FROM @OutstandingQuotesViewID
				   ) a
		)
	
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
            ISNULL('Q' + Right('00000'+ Cast(e.QuoteNo as varchar), Case When Len(e.QuoteNo)<=6 Then 6 Else Len(e.QuoteNo) End),q.Status) [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.SiteUPRN,s.UPRN) [UPRN], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN 'Rejected' ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CAST(CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END as BIT) [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
            q.ReminderDate [ReminderDate],
            CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(ISNULL(s.SiteID,bQuoteHasSite.[Count]) as BIT) [bQuoteHasSite],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo]
    From 
            Paging main

            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
            
            LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
            
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null AND [FileName] Not  Like '%ra%'  order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            OUTER APPLY
            (
				Select COUNT(*) [Count] FROM ProjectSite Where ProjectID=p.ProjectID
            ) bQuoteHasSite
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END



GO






USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingSampleReports')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingSampleReports] AS BEGIN SET NOCOUNT ON; END')
END


/****** Object:  StoredProcedure [dbo].[Paged_OutstandingSampleReports]    Script Date: 06/06/2017 10:41:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_OutstandingSampleReports]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @LaboratoryID INT = 0,
    @SurveyTypeID INT = 0,
    @EmployeeID INT = 0,
    @GlobalFilter VARCHAR(MAX) = NULL,
    @JobID INT = 0,
    @OrderByJobNo INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderBySamplesDueDate INT = 0,
    @OrderByResultsAndSamples INT = 0,
    @OrderByResultsVerified INT = 0
/**********************************************************************
** Overview: Get the data for the Outstanding Sample Reports tab. Replaces the OutstandingSampleReports view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
	DECLARE @UseDefaultOrdering INT = 0

    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @GlobalFilter = NULLIF(LTRIM(RTRIM(@GlobalFilter)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByJobNo = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByClientOrderNo = 0 AND @OrderBySamplesDueDate = 0 AND @OrderByResultsAndSamples = 0 AND @OrderByResultsVerified = 0
    BEGIN
        SET @UseDefaultOrdering = 1
    END
    
    -- Set variables for logic.
    DECLARE @b__SampleDueDatesIncludeHolidays BIT, @b__showAllSamplesRegardlessOfBranch BIT, @b__OutstandingSampleReportsSwitchLabsNotManager BIT, @RequiredBranchOfficeID INT, @LabBranchOfficeID INT, @EmployeeIsManager BIT
    SELECT
        @b__SampleDueDatesIncludeHolidays = cfg.b__SampleDueDatesIncludeHolidays,
        @b__showAllSamplesRegardlessOfBranch = cfg.b__showAllSamplesRegardlessOfBranch,
        @b__OutstandingSampleReportsSwitchLabsNotManager = cfg.b__OutstandingSampleReportsSwitchLabsNotManager,
        @RequiredBranchOfficeID = COALESCE(e.BranchOfficeID, (SELECT BranchOfficeID FROM BranchOffice WITH (NOLOCK) WHERE [Default] = 1), -1),
        @LabBranchOfficeID = (SELECT BranchOfficeID FROM Laboratory WITH (NOLOCK) WHERE LaboratoryID = @LaboratoryID),
        @EmployeeIsManager = ISNULL(e.Manager, 0)
    FROM
        Config cfg WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT Manager, BranchOfficeID FROM Employee WITH (NOLOCK) WHERE EmployeeID = @EmployeeID
        ) e
    
    -- Get a list of required LaboratoryIDs for logic.
    DECLARE @RequiredLaboratoryIDs TABLE (LaboratoryID INT)
    INSERT INTO @RequiredLaboratoryIDs
    SELECT LaboratoryID FROM Laboratory WITH (NOLOCK) WHERE BranchOfficeID = @RequiredBranchOfficeID OR ServerCode IS NOT NULL
    
    
    -- Get all the Outstanding Sample Reports data - just the minimum ammount of data for speed.
	DECLARE @OutstandingSampleReportJobs TABLE (JobID INT, Created DATETIME, QuoteTypeID INT, ClientFull VARCHAR(MAX),[SiteAddress] VARCHAR(MAX), IsSurvey BIT, SurveyTypeID INT, SamplesDueDate DATETIME, SampleReportsDueInDays INT, AppDueDate DATETIME, [ProjectDueDate] DATETIME, [CalculatedDueDate] DATETIME)
	INSERT INTO @OutstandingSampleReportJobs (JobID, Created, QuoteTypeID, ClientFull, [SiteAddress], IsSurvey, SurveyTypeID, SamplesDueDate, SampleReportsDueInDays, AppDueDate, [ProjectDueDate], [CalculatedDueDate])
	SELECT
		b.JobID, b.Created, b.QuoteTypeID, b.ClientFull, b.[SiteAddress], b.IsSurvey, b.SurveyTypeID, b.SamplesDueDate, b.SampleReportsDueInDays, b.AppDueDate, b.[ProjectDueDate], b.CalculatedDueDate
	FROM
	(
		SELECT
			a.JobID, a.Created, a.QuoteTypeID, a.ClientFull, a.[SiteAddress], a.IsSurvey, a.SurveyTypeID, a.SamplesDueDate, a.SampleReportsDueInDays, a.AppDueDate, a.[ProjectDueDate], 
			ISNULL(
				a.SamplesDueDate, -- Use if present, as it's the main driver for the date.
				CASE WHEN ISNULL(a.QuoteTypeID,6) != 6 THEN -- For non-Sample jobs.
					CASE WHEN a.AppDueDate IS NOT NULL THEN
						dbo.fn_AddWorkingDays(CAST(ISNULL(a.SampleReportsDueInDays, 0) AS INT), a.RegisterFinish)
					END
				END
			) [CalculatedDueDate]
		FROM
		(
			SELECT
				j.JobID, j.Created,
				q.QuoteTypeID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [ClientFull],
				si.[Address] [SiteAddress],
				CASE WHEN a.AppointmentID IS NULL THEN 0 ELSE 1 END [IsSurvey],
				asu.SurveyTypeID,
				asu.SamplesDueDate,
				p.SampleReportsDueInDays,
				asu.DueDate [AppDueDate],
				p.DueDate [ProjectDueDate],
				r.RegisterFinish,
				ROW_NUMBER() OVER (PARTITION BY j.JobID Order By asu.DueDate ASC, r.RegisterFinish DESC) [Identifier]
			FROM
				Job j 
				INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
				INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
				LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
				LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
				LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID != 8
				LEFT JOIN AppointmentSurvey asu WITH (NOLOCK) ON a.AppointmentID = asu.AppointmentID
			WHERE
				a.DateDeclined IS NULL
					AND
				j.Approved IS NULL
					AND
				(
                    CASE WHEN j.SampleResultEmployeeID IS NULL THEN
						1
					ELSE
						CASE WHEN j.SampleContentEmployeeID IS NULL THEN
							1
						ELSE
							0
						END
                    END = 1
				)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
				 AND
				(
					CASE WHEN @GlobalFilter IS NULL THEN
						1
					ELSE
						CASE WHEN
							j.ClientOrderNo LIKE '%' + @GlobalFilter + '%'
								OR
							si.Address Like '%' + @GlobalFilter + '%'
								Or
							si.Postcode Like '%' + @GlobalFilter + '%'
								Or
							si.Address + ', ' + si.Postcode Like '%' + @GlobalFilter + '%'
								Or 
							si.UPRN = @GlobalFilter
						THEN 1 ELSE 0 END
					END = 1
				)
		) a
		WHERE
			a.Identifier = 1
	) b
	WHERE
		(
			CASE WHEN b.[CalculatedDueDate] IS NULL THEN
				1
			ELSE
				CASE WHEN b.[CalculatedDueDate] BETWEEN @FilterStartDate AND @FilterFinishDate THEN
					1
				ELSE
					0
				END
			END = 1
		)
	    
    DECLARE @OutstandingSampleReportsData TABLE (IndexID INT IDENTITY(1,1), JobID INT, JobNo INT, ClientOrderNo VARCHAR(50), SampleResultEmployeeID INT, BranchOfficeID INT, ClientID INT, Client VARCHAR(210), ProjectID INT, SiteID INT, Address VARCHAR(200), IsSurvey BIT, SurveyTypeID INT, AppDueDate DATETIME, InSampleExchange BIT, Interval INT, LaboratoryID INT, ServerCode NVARCHAR(3), SamplesDueDate DATETIME, SamplesWithResultCount INT, CheckedInCount INT, TotalSamplesCount INT)
  
    
    INSERT INTO @OutstandingSampleReportsData
    SELECT
        s.JobID,
        s.JobNo,
        s.ClientOrderNo,
        s.SampleResultEmployeeID,
        s.BranchOfficeID,
        s.ClientID,
        s.Client,
        s.ProjectID,
        s.SiteID,
        s.Address,
        s.IsSurvey,
        s.SurveyTypeID,
        s.AppDueDate,
        s.InSampleExchange,
        s.Interval,
        s.LaboratoryID,
        s.ServerCode,
        s.SamplesDueDate,
        s.SamplesWithResultCount,
        s.CheckedInCount,
        s.TotalSamplesCount
    FROM
        (
            SELECT
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                j.SampleResultEmployeeID,
                j.BranchOfficeID,
                j.ClientID,
                osrj.ClientFull [Client],
                j.ProjectID,
                j.SiteID,
                osrj.[SiteAddress] [Address],
                osrj.IsSurvey,
                osrj.SurveyTypeID [SurveyTypeID],
                osrj.AppDueDate,
                CAST(ISNULL(MIN(s.SampleExchangeDateTransfered), 0) AS BIT) [InSampleExchange],
                st.Interval,
                l.LaboratoryID,
                l.ServerCode,
                ISNULL(
                    osrj.SamplesDueDate, -- Use if present, as it's the main driver for the date.
                    CASE WHEN osrj.QuoteTypeID != 6
                        THEN -- For non-Sample jobs.
                            CASE WHEN osrj.ProjectDueDate IS NULL -- Check if there is a Project due date.
                                THEN
                                    CASE WHEN st.Interval IS NULL -- No Project due date.
                                        THEN DATEADD(d, -2, osrj.AppDueDate) -- Take 2 days off the report due date.
                                        ELSE DATEADD(d, st.Interval, j.Created) -- Otherwise use the Job Created date as a basis.
                                    END
                                ELSE dbo.fn_AddWorkingDays(CAST(ISNULL(osrj.SampleReportsDueInDays, 0) AS INT), MAX(rd.LastRegisterFinish)) -- If a Project due date, add working days to the Register Finish.
                            END
                        ELSE -- For Sample jobs. Base off the Sample Turnaround Interval and Job Created.
                            CASE WHEN @b__SampleDueDatesIncludeHolidays = 1
                                THEN dbo.fn_AddWorkingDays(st.Interval, j.Created)
                                ELSE DATEADD(d, st.Interval, j.Created)
                            END
                    END) [SamplesDueDate],
                -- Both of the below cases divide by the number of Appointments to negate the effect of the join to the Appointment table.
                -- As joining to Appointment can sometimes cause duplicate rows, and we need an accurate count of Samples.
                COUNT(s.SampleResultID) [SamplesWithResultCount],
                COUNT(s.LaboratoryID) [CheckedInCount],
                COUNT(s.SampleID) [TotalSamplesCount]
            FROM
                @OutstandingSampleReportJobs osrj 
                INNER JOIN Job j WITH (NOLOCK) ON j.JobID=osrj.JobID
                OUTER APPLY
                (
                    SELECT MAX(_r.RegisterFinish) [LastRegisterFinish]
                    FROM
                        JobEmployee _je WITH (NOLOCK)
                        INNER JOIN Register _r WITH (NOLOCK) ON _je.JobEmployeeID = _r.JobEmployeeID
                    WHERE
                        _je.JobID = osrj.JobID
                ) rd -- Register Details
                INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = osrj.JobID
                INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
                INNER JOIN Room rm WITH (NOLOCK) ON rm.RegisterID = r.RegisterID
                INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
                LEFT JOIN SampleTurnaround st WITH (NOLOCK) ON s.SampleTurnaroundID = st.SampleTurnaroundID
                LEFT JOIN Laboratory l WITH (NOLOCK) ON s.LaboratoryID = l.LaboratoryID AND l.DateDeleted IS NULL
                
                
            WHERE -- NOTE: Parts of this WHERE clause are repeated in the main SELECT below.
                NULLIF(s.SampleRef, '') IS NOT NULL -- No Visuals.
                    AND
                s.AsSample = 0 -- No As Samples (these are not a physical Sample).
                    AND
                s.SampleRef NOT LIKE '%*%' -- No Samples that have been re-inspected (these were analysed before).
                    AND
                s.SampleRef NOT LIKE '%{%' -- Ignore Samples that were surveyed prior to TEAMS.
                    AND
                ( -- Not analysed/approved.
                    j.SampleResultEmployeeID IS NULL
	                    OR
                    j.SampleContentEmployeeID IS NULL
                )
            GROUP BY
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                j.SampleResultEmployeeID,
                j.BranchOfficeID,
                j.Created,
                j.ClientID,
                osrj.SurveyTypeID,
                osrj.IsSurvey,
                osrj.ClientFull,
                osrj.SamplesDueDate,
                osrj.AppDueDate,
                j.ProjectID,
                osrj.ProjectDueDate,
                osrj.SampleReportsDueInDays,
                j.SiteID,
                osrj.[SiteAddress],
                osrj.QuoteTypeID,
                l.LaboratoryID,
                l.ServerCode,
                st.Interval
        ) s
    WHERE
        (
            (
                s.SamplesDueDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (
                    CASE WHEN @b__showAllSamplesRegardlessOfBranch = 1 THEN 
						1
                    ELSE
						CASE WHEN
							( -- Employee is not a manager but show all for branch
								(@EmployeeIsManager = 0 AND @b__OutstandingSampleReportsSwitchLabsNotManager = 0)
									AND
								( -- Checked in to the required lab
									s.LaboratoryID IN (SELECT LaboratoryID FROM @RequiredLaboratoryIDs)
										OR
									( -- Not checked in but original job is for required labs branch
										s.LaboratoryID IS NULL
											AND
										s.BranchOfficeID = @RequiredBranchOfficeID
									)
								)
							)
								OR
							( -- Employee is a manager.
								(@EmployeeIsManager = 1 OR @b__OutstandingSampleReportsSwitchLabsNotManager = 1)
									AND
								(
									(  -- A lab filter wanted.
										@LaboratoryID > 0
											AND
										( -- Checked in to the required lab
											s.LaboratoryID = @LaboratoryID
												OR
											( -- Not checked in but original job is for required labs branch
												s.LaboratoryID IS NULL
													AND
												s.BranchOfficeID = @LabBranchOfficeID
											)
										)
									)
										OR -- Show all labs checked in or not
									@LaboratoryID = 0
								)
							)
						THEN 1 ELSE 0 END
                    END = 1
                )
            )
                OR
            @JobID > 0
        )
            AND
        (
            CASE WHEN @SurveyTypeID = 0 THEN 
				1 -- Everything
			ELSE
				CASE WHEN 
					(@SurveyTypeID = -2 AND s.IsSurvey = 1) -- Just Surveys
						OR
					(@SurveyTypeID = -1 AND s.IsSurvey = 0) -- Just Bulk Sample Reports
						OR
					(s.SurveyTypeID = @SurveyTypeID) -- A specific Survey Type
				THEN 1 ELSE 0 END
            END = 1
        )
    ORDER BY
		CASE WHEN @UseDefaultOrdering = 1 THEN CASE WHEN IsNull(SampleResultEmployeeID,0) = 0 THEN 0 ELSE 1 END ELSE NULL END,
		CASE WHEN @UseDefaultOrdering = 1 THEN SamplesDueDate ELSE NULL END,
		CASE WHEN @UseDefaultOrdering = 1 THEN jobid ELSE NULL END,
        CASE WHEN @OrderByJobNo = 1 THEN CAST(s.JobNo AS INT) ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN CAST(s.JobNo AS INT) ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN s.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN s.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN s.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN s.Address ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN s.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN s.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderBySamplesDueDate = 1 THEN s.SamplesDueDate ELSE NULL END ASC,
        CASE WHEN @OrderBySamplesDueDate = 2 THEN s.SamplesDueDate ELSE NULL END DESC,
        CASE WHEN @OrderByResultsAndSamples = 1 THEN s.TotalSamplesCount ELSE NULL END ASC,
        CASE WHEN @OrderByResultsAndSamples = 2 THEN s.TotalSamplesCount ELSE NULL END DESC,
        CASE WHEN @OrderByResultsAndSamples = 1 THEN s.SamplesWithResultCount ELSE NULL END ASC,
        CASE WHEN @OrderByResultsAndSamples = 2 THEN s.SamplesWithResultCount ELSE NULL END DESC,
        CASE WHEN @OrderByResultsVerified = 1 THEN CASE WHEN ISNULL(s.SampleResultEmployeeID, -1) > 1 THEN 1 ELSE 0 END ELSE NULL END ASC,
        CASE WHEN @OrderByResultsVerified = 2 THEN CASE WHEN ISNULL(s.SampleResultEmployeeID, -1) > 1 THEN 1 ELSE 0 END ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OutstandingSampleReportsData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((a.IndexID - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @OutstandingSampleReportsData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.IndexID [Row_Num],
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        pag.JobID,
        pag.JobNo,
        pag.ClientOrderNo,
        pag.SampleResultEmployeeID,
        j.Created,
        CAST(CASE WHEN j.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.BranchOfficeID,
        j.LastNoteCreated,
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN j.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN j.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        STUFF((
            SELECT DISTINCT ', ' + e.FullName
            FROM
                JobEmployee je WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
            WHERE
                je.JobID = pag.JobID
        FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [Surveyors],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.JobID = pag.JobID
                    AND
                _pf.DateDeleted IS NULL
                    AND
                _pf.FileName LIKE '%bsr%'
            ORDER BY
                _pf.FileName DESC
        ) [FileName],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.JobID = pag.JobID
                    AND
                _pf.DateDeleted IS NULL
                    AND
                _pf.FileName LIKE '%bsr%'
                    AND
                _pf.Uploaded = 1
            ORDER BY
                _pf.FileName DESC
        ) [UploadedFileName],
        (SELECT TOP 1 _ct.TemplateID FROM ClientTemplate _ct WITH (NOLOCK) WHERE _ct.ClientID = pag.ClientID AND _ct.TemplateTypeID = 14 ORDER BY _ct.Version DESC) [ClientTemplateID],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.SiteID,
        pag.Address,
        si.Postcode,
        si.UPRN,
        pag.IsSurvey,
        pag.SurveyTypeID,
        pag.AppDueDate [SurveyDueDate],
        pag.InSampleExchange,
        pag.Interval,
        pag.LaboratoryID,
        CAST(CASE WHEN pag.ServerCode IS NOT NULL THEN 1 ELSE 0 END AS BIT) [SampleExchangeLab],
        pag.SamplesDueDate,
        pag.SamplesWithResultCount,
        pag.CheckedInCount,
        pag.TotalSamplesCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
        LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
    WHERE -- NOTE: Parts of this WHERE clause are repeated in the table variable INSERT above.
        (
            (pag.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
                OR
            (@PerPage = 0 AND @CurrentPage = 0)
        )
    GROUP BY
        pag.IndexID,
        pag.Page,
        pag.Pages,
        pag.JobID,
        pag.JobNo,
        pag.ClientOrderNo,
        pag.SampleResultEmployeeID,
        pag.AppDueDate,
        j.Created,
        pag.BranchOfficeID,
        j.LastNoteCreated,
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.SiteID,
        pag.Address,
        si.Postcode,
        si.UPRN,
        pag.IsSurvey,
        pag.SurveyTypeID,
        pag.InSampleExchange,
        pag.Interval,
        pag.LaboratoryID,
        pag.ServerCode,
        pag.SamplesDueDate,
        pag.SamplesWithResultCount,
        pag.CheckedInCount,
        pag.TotalSamplesCount
    ORDER BY
        pag.IndexID
    
    
    SET NOCOUNT OFF;
END

GO





USE [TEAMS]
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_ProjectJobSheet')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_ProjectJobSheet] AS BEGIN SET NOCOUNT ON; END')
END


/****** Object:  StoredProcedure [dbo].[Paged_ProjectJobSheet]    Script Date: 01/18/2017 20:39:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Paged_ProjectJobSheet]
	@PerPage INT = 15
	, @CurrentPage INT = 1
	, @ClientID INT = NULL
	, @ProjectGroupID INT = NULL
	, @ProjectID INT = NULL
	, @SiteID INT = NULL
	, @Status VARCHAR(24) = ''
	, @Other VARCHAR(MAX) = ''
	, @Address VARCHAR(200) = ''
	, @PhoneCalls INT = NULL
	, @Letters INT = NULL,
	@NoAccessAttempts INT = NULL
/**********************************************************************
** Overview: Get data for the View Project JobSheet tab - procedurised
**		to improve performance over previous code + add paging capability
**
** PLEASE NOTE: The Change Log has now been removed as this has been added to SQL SVN instead.
** Please use the latest version from SVN before making changes. Commit the changes when done.
**********************************************************************/
AS
SET ANSI_WARNINGS OFF
BEGIN
    SET NOCOUNT ON;
    
    
	-- tidy input variables
	SELECT @ClientID = NULLIF(@ClientID, 0)
	SELECT @ProjectGroupID = NULLIF(@ProjectGroupID, 0)
	SELECT @ProjectID = NULLIF(@ProjectID, 0)
	SELECT @SiteID = NULLIF(@SiteID, 0)
	SELECT @Status = NULLIF(@Status, '')
	SELECT @Other = NULLIF(@Other, '')
	SELECT @Address = NULLIF(@Address, '')
	SELECT @PhoneCalls = NULLIF(@PhoneCalls, 0)
	SELECT @Letters = NULLIF(@Letters, 0)
	SELECT @NoAccessAttempts = NULLIF(@NoAccessAttempts, 0)

	-- ensure we have at least 1 filter ID (don't want to kill the server!)
	IF (@ClientID IS NULL) AND (@ProjectGroupID IS NULL) AND (@ProjectID IS NULL) AND (@SiteID IS NULL) BEGIN
		RAISERROR('No ID values passed to GetProjectJobSheet', 16, 1)
		RETURN
	END
	
	-- get ProjectIDs into a table to join to, based on @ProjectGroupID AND @ProjectID inputs
	CREATE TABLE #ProjectIDs (ProjectID INT)
	IF @ProjectID IS NOT NULL BEGIN
	
		INSERT
			#ProjectIDs
		SELECT
			@ProjectID
			
	END ELSE BEGIN
		
		INSERT
			#ProjectIDs
		SELECT
			ProjectID
		FROM
			Project
		WHERE
			ProjectGroupId = @ProjectGroupID
		
	END
	
	-- change #ProjectIDs into a comma separated string of IDs 
	DECLARE @ProjectIDsString VARCHAR(MAX)
	SELECT @ProjectIDsString = STUFF 
	((
		SELECT ',' + CONVERT(VARCHAR(20), ProjectID)
		FROM #ProjectIDs
		FOR XML PATH('')
	), 1, 1, '')
	
	-- select from existing ProjectJobSheet view into a temp table
	CREATE TABLE #JobSheetData (
		JobSheetDataID INT IDENTITY (1,1) NOT NULL
		, AppointmentID INT NULL
		, JobId INT NULL
		, SurveyTypeId INT NULL
		, ClientId INT NULL
		, ProjectId INT NULL
		, SiteId INT NULL
		, SurveyCompleted INT NULL
		, SurveyStillDue INT NULL
		, Approved INT NULL
		, SurveyOnTime INT NULL
		, SurveyOverTime INT NULL
		, Unscheduled INT NULL
		, SurveyCompletedRaw NVARCHAR(40) NULL
		, DueDateRaw NVARCHAR(40) NULL
		, ApprovedRaw NVARCHAR(40) NULL
		, SortOrder INT NOT NULL
		, Samples INT NULL
		, SampleResults INT NULL
		, [Status] VARCHAR(24)
		, Other VARCHAR(MAX)
		, [Address] VARCHAR(200)
		, PhoneCalls INT NULL
		, Letters INT NULL
		, NoAccessAttempts INT NULL
	)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)
	SELECT @DynamicSQL = 'INSERT
		#JobSheetData
	SELECT
		pjs.AppointmentID
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyCompleted
		, CASE WHEN [Status] = ''Unscheduled'' OR SortOrder = 3 THEN 0 ELSE 1 END AS SurveyStillDue
		, CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS Approved
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) <= 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOnTime
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) > 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOverTime
		, CASE WHEN [Status] = ''Unscheduled'' AND SortOrder <> 3 THEN 1 ELSE 0 END AS Unscheduled
		, SurveyCompleted
		, DueDate
		, Approved
		, SortOrder
		, Samples
		, SampleResults
		, [Status]
		, Other
		, [Address]
		, [PhoneCalls]
		, [Letters]
		, pjs.NoAccessAttempts
	FROM
		ProjectJobSheet pjs
	WHERE
		pjs.ProjectID IN (' + @ProjectIDsString + ') '

	-- add default order by
	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY SortOrder, JobNo, Address'

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- ClientID filter (not applied to view above as extra view filters slow performance)
	IF @ClientID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE ClientID <> @ClientID
	END
	
	-- SiteID filter (not applied to view above as extra view filters slow performance)
	IF @SiteID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE SiteID <> @SiteID
	END

	-- @PhoneCalls filter (not applied to view above as extra view filters slow performance)
	IF @PhoneCalls IS NOT NULL BEGIN
		
		IF @PhoneCalls > 3 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls < 4
		END

		IF @PhoneCalls < 4 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls <> @PhoneCalls
		END
	END

	-- @Letters filter (not applied to view above as extra view filters slow performance)
	IF @Letters IS NOT NULL BEGIN

		IF @Letters > 3 BEGIN
			DELETE FROM #JobSheetData WHERE Letters < 4
		END

		IF @Letters < 4 BEGIN
			DELETE FROM #JobSheetData WHERE Letters <> @Letters
		END
	END
	
	-- @NoAccessAttempts filter (not applied to view above as extra view filters slow performance)
	IF @NoAccessAttempts IS NOT NULL BEGIN

		IF @NoAccessAttempts > 3 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts < 4
		END

		IF @NoAccessAttempts < 4 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts <> @NoAccessAttempts
		END
	END

	-- calculate useful totals
    DECLARE @SurveysCompleted INT
    DECLARE @SurveysStillDue INT
    DECLARE @Approved INT
    DECLARE @SurveysOnTime INT
    DECLARE @SurveysOverTime INT
    DECLARE @UnScheduled INT
    DECLARE @KPI DECIMAL(12,2)
    DECLARE @TotalJobs_HasSampleResults INT
    DECLARE @Approved_HasSampleResults INT
    DECLARE @TotalRows INT
    
	SELECT
		@SurveysCompleted = ISNULL(SUM(SurveyCompleted), 0)
		, @SurveysStillDue = ISNULL(SUM(SurveyStillDue), 0) - ISNULL(SUM(SurveyCompleted), 0)
		, @Approved = ISNULL(SUM(Approved), 0)
		, @SurveysOnTime = ISNULL(SUM(SurveyOnTime), 0)
		, @SurveysOverTime = ISNULL(SUM(SurveyOverTime), 0)
		, @UnScheduled = ISNULL(SUM(UnScheduled), 0)
		, @KPI = ISNULL(CASE WHEN COUNT(SurveyCompletedRaw) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN DueDateRaw > SurveyCompletedRaw AND SortOrder <> 3 THEN 1 ELSE 0 END)
					/ CONVERT(FLOAT,COUNT(SurveyCompletedRaw)), 3) * 100 END, 0)
		, @TotalRows = COUNT(1)
	FROM 
		#JobSheetData
		
	SELECT
		@TotalJobs_HasSampleResults = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' OR SortOrder = 3 THEN 0 ELSE 1 END), 0) 
		, @Approved_HasSampleResults = ISNULL(SUM(CASE WHEN NOT ApprovedRaw IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
	FROM 
		#JobSheetData
	WHERE
		Samples > 0
		AND Samples = SampleResults
	
	-- return paged raw data to front end
	-- NOTE - @Status, @Other and @Address filters only filter this data, not the count data
	;WITH Paging AS 
    ( 
       SELECT 
           CAST(CEILING(COUNT(*) OVER(PARTITION BY '') * 1.00 / @PerPage) AS INT) AS Pages
           , ((ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) - 1) / @PerPage) + 1 AS Page
           , ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) AS Row_Num
           , *
       FROM 
       (
			SELECT * FROM #JobSheetData jsd
			WHERE
				( (jsd.[Status] = @Status) OR (@Status IS NULL) )
				AND ( (jsd.Other = @Other) OR (@Other IS NULL) )
				AND ( (jsd.[Address] = @Address) OR (@Address IS NULL) )
	   ) a
    )	
	SELECT  
		main.Pages
		, main.Page
		, main.Row_Num
		, pjs.SortOrder
		, pjs.AppointmentID
		, pjs.[Status]
		, pjs.StatusDate
		, pjs.JobNo
		, pjs.[Address]
		, pjs.Postcode
		, pjs.Contact
		, pjs.Telephone
		, pjs.SiteEmail
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.AppointmentDate
		, pjs.DateSiteWorkComplete
		, pjs.AnalysisComplete
		, pjs.TotalJobs
		, pjs.WorkScheduled
		, pjs.SiteWorkComplete
		, pjs.Samples
		, pjs.SampleResults
		, pjs.[FileName]
		, pjs.ClientOrderNo
		, pjs.DateReceived
		, pjs.UPRN
		, pjs.SurveyType
		, pjs.Surveyor
		, pjs.SurveyStart
		, pjs.SurveyCompleted
		, pjs.AnalysisCompleted
		, pjs.Approved
		, pjs.ApprovedBy
		, pjs.DueDate
		, pjs.NoAccessAttempts
		, pjs.PhoneCalls
		, pjs.Letters
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 1
				FOR XML PATH('')
			), 1, 1, '')) AS PhoneCallSiteContactIDs
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 2
				FOR XML PATH('')
			), 1, 1, '')) AS LetterSiteContactIDs
		, pjs.GroupName
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, pjs.Other
		, pjspa.ProjectAppointmentID
		, pjs.LastNoAccessDate
		, pjs.LastJobEmployeeDate
		, pjs.QuoteId
		, pjs.QuoteDate,
		pjs.InvoiceDate
    FROM 
		Paging main
		INNER JOIN ProjectJobSheet pjs 
			ON ISNULL(main.AppointmentID, 0) = ISNULL(pjs.AppointmentID, 0)
			AND ISNULL(main.JobID, 0) = ISNULL(pjs.JobID, 0)
			AND ISNULL(main.SurveyTypeID, 0) = ISNULL(pjs.SurveyTypeID, 0)
			AND ISNULL(main.ClientID, 0) = ISNULL(pjs.ClientID, 0)
			AND ISNULL(main.ProjectID, 0) = ISNULL(pjs.ProjectID, 0)
			AND ISNULL(main.SiteID, 0) = ISNULL(pjs.SiteID, 0)
		LEFT JOIN Appointment pjspa ON pjs.AppointmentID = pjspa.AppointmentID
    WHERE 
		main.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage
	ORDER BY
		main.Row_Num
	
	-- drop temp tables
	DROP TABLE #ProjectIDs
	DROP TABLE #JobSheetData
	
	-- return useful counts to front end
	SELECT
		@SurveysStillDue AS WorkScheduled
		, @SurveysStillDue AS SurveysStillDue
		, @Approved AS Approved
		, @SurveysOnTime AS SurveysOnTime
		, @SurveysOverTime AS SurveysOverTime
		, @UnScheduled AS UnScheduled
		, @KPI AS KPI
		, @TotalJobs_HasSampleResults - @Approved_HasSampleResults AS SampleAnalysisComplete
		--, @SurveysCompleted - @TotalJobs_HasSampleResults - @Approved AS SiteWorkComplete
		, @TotalRows - @UnScheduled - @SurveysStillDue - @TotalJobs_HasSampleResults + @Approved_HasSampleResults - @Approved AS SiteWorkComplete
    
    
    SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_VerifyResults')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_VerifyResults] AS BEGIN SET NOCOUNT ON; END')
END
GO

/****** Object:  StoredProcedure [dbo].[Paged_VerifyResults]    Script Date: 01/18/2017 20:40:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- ======================================================================
-- Author:		Lonny
-- Create date:	04/01/2017
-- Description:	SP to replace inline SQL in Classic (not actually paged!)
-- ======================================================================

ALTER PROCEDURE [dbo].[Paged_VerifyResults] 
	@JobID INT = 0

AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT Sample.SiteReference,
		Sample.SampleID,
		Sample.DateCreated,
		SampleRef,
		ElementText AS Description,
		SampleResultID,
		SampleClassificationID,
		SampleClassificationExtendedID,
		isnull(SampleClassificationExtendedPointsID, 0) 'SampleClassificationExtendedPointsID',
		client.clientid,
		Sample.Notes,
		SampleNotes,
		DateAnalysed,
		Sample.EmployeeID,
		testCol.internalnote
	FROM Sample
	INNER JOIN Room ON Sample.RoomID = Room.RoomID
	INNER JOIN Register ON Room.RegisterID = Register.RegisterID
	INNER JOIN JobEmployee ON Register.JobEmployeeID = JobEmployee.JobEmployeeID
	INNER JOIN Job ON JobEmployee.JobID = Job.JobID
	FULL JOIN Client ON Job.ClientID = Client.ClientID
	FULL JOIN Site ON Job.SiteID = Site.SiteID
	FULL JOIN Element ON Sample.SampleID = Element.SampleID
	OUTER APPLY (
		SELECT _sampleInternalNote
		FROM sampletestcollection sc
		WHERE sc._sampleid = sample.sampleid
			AND sc.deleted IS NULL
		) testCol(internalnote)
	WHERE ElementTypeID = 2
		AND JobEmployee.MainEmployee = 1
		AND NOT IsNull(SampleRef, '') = ''
		AND AsSample = 0
		AND Right(SampleRef, 1) <> '*'
		AND sample.sampleref NOT LIKE '%{%'
		AND Job.Cancelled IS NULL
		AND (@JobID=0 OR Job.JobID=@JobID)
	ORDER BY Sample.SampleRef
      
    SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO

/****** Object:  UserDefinedFunction [dbo].[CalibrationDueDate]    Script Date: 01/18/2017 21:09:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER FUNCTION [dbo].[CalibrationDueDate] (@EquipmentID int)
RETURNS datetime
WITH EXECUTE AS CALLER
AS
BEGIN

      DECLARE @DueDate        DATETIME
      DECLARE @IntervalCheck  INT
      DECLARE @StartDate            DATETIME
      
      SELECT @IntervalCheck = IntervalCheck FROM Equipment WHERE EquipmentID = @EquipmentID
      
      IF EXISTS (
            SELECT 1 FROM Calibration WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL)
      BEGIN
            SELECT @StartDate = MAX(CalibrationDate) FROM Calibration WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL
      END
      ELSE
      BEGIN
            SELECT @StartDate = DatePurchased FROM Equipment WHERE EquipmentID = @EquipmentID
      END
      
      SELECT @DueDate = CASE @IntervalCheck
            WHEN 0 THEN DATEADD(year,1,@StartDate)
            WHEN 1 THEN DATEADD(month,6,@StartDate)
            WHEN 2 THEN DATEADD(month,3,@StartDate)
            WHEN 3 THEN DATEADD(month,1,@StartDate)
            WHEN 4 THEN DATEADD(day,1,@StartDate)
            WHEN 5 THEN DATEADD(year,100,GETDATE())  -- really loads in the future!!
            WHEN 6 THEN DATEADD(year,2,@StartDate)
            WHEN 7 THEN DATEADD(year,5,@StartDate)
            WHEN 8 THEN DATEADD(MONTH,8,@StartDate)
            WHEN 9 THEN DATEADD(YEAR,10,@StartDate)
            -- shouldn't ever hit the else!  but if we do just return the start date for safety
            ELSE @StartDate END

      RETURN @DueDate
END;
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaNew')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaNew] AS SELECT 1 GO')
END


/****** Object:  View [dbo].[dgLegionellaNew]    Script Date: 01/13/2017 10:22:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[dgLegionellaNew] AS 	
SELECT
	*
FROM
	(
		Select
			j.JobID,
			lt.LegionellaTypeID [TypeID],
			lt.Description [Type],
			'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
			MIN(l.LegionellaStart) [Start],
			MAX(l.LegionellaFinish) [Finish],
			MAX(l.MonitoringSchedule) [MonitoringSchedule],
			MAX(al.DueDate) [Due],
			c.ClientID,
			c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
			s.SiteID,
			s.Address [Site],
			CAST(CASE WHEN leginfo.ReportInformationID IS NULL THEN 0 ELSE 1 END as bit) [Report],
			CAST(CASE WHEN p.PhotoID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Photos],
			CAST(CASE WHEN fp.FloorplanID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Plans],
			CAST(CASE WHEN MIN(lsd.LegionellaSupportingDocumentId) IS NOT NULL THEN 1 ELSE 0 END as BIT) [Documents],
			l.DateApproved,
			0 [HasNotes],
			0 [NotesInLastHour],
			1 [NewGrid],
			j.Status [Status],
			org.State [OrgState],
			CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT) [PDF],
			je.EmployeeID [EmployeeID],
			e.FullName [FullName],
			ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY MAX(l.LegionellaFinish) DESC) [Identifier]
		FROM
			Job j WITH (NOLOCK)
			INNER JOIN Client c WITH (NOLOCK) ON j.ClientID=c.ClientID
			INNER JOIN Site s WITH (NOLOCK) ON j.SiteID=s.SiteID
			INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
			INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID
			INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID = a.AppointmentID
			INNER JOIN LegionellaType lt WITH (NOLOCK) ON lt.LegionellaTypeID = al.LegionellaTypeID
			INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
			INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
			INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
			OUTER APPLY
			(
				SELECT TOP 1
					l.ReportInformationID
				FROM
					Job _j
					INNER JOIN JobEmployee je ON j.JobID = je.JobID
					INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
				WHERE
					_j.JobID = j.JobId
				ORDER BY
					l.ReportInformationID
			) legInfo
			LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.LegionellaID=l.LegionellaID AND fp.AutocadDataContentType IS NOT NULL
			LEFT OUTER JOIN OfflineReportGeneration org WITH (NOLOCK) ON org.JobID=j.JobID AND org.Completed IS NULL
			LEFT OUTER JOIN LegionellaSupportingDocument lsd WITH (NOLOCK) ON lsd.LegionellaID=l.LegionellaID
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON p.PhotoID=l.PhotoID
			LEFT OUTER JOIN PDF pf WITH (NOLOCK) ON pf.JobId=j.JobID AND pf.DateDeleted IS NULL
		Where
			a.DateDeclined IS NULL
		GROUP BY
			j.JobID,
			lt.LegionellaTypeID,
			lt.Description,
			j.JobNo,
			c.ClientID,
			c.Client,
			c.BranchName,
			s.SiteID,
			s.Address,
			l.DateApproved,
			j.Status,
			org.State,
			je.EmployeeID,
			e.FullName,
			CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT),
			fp.FloorplanID,
			p.PhotoID,
			leginfo.ReportInformationID
	 ) main
WHERE
	main.Identifier = 1

GO

update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Clients'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Sites'
update TeamsV2Tab set IsMvcTab = 1, UsesMvcSubTabs = 1 where tabtext = 'Other Services'
update TeamsV2Tab set  IsMvcTab = 1 Where TabText = 'Create Survey'

update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Not Yet Quoted'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Outstanding Quotes'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Quote History'

update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Outstanding Sample Reports'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Completed Sample Reports'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Not Yet Scheduled'

update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Open Surveys'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Completed Surveys'
update TeamsV2Tab set enablemvcgrid = 1 where TabText = 'Air Monitoring' and TeamsV2SectionID = 5

IF (SELECT b__SageInvoiceIntegrated FROM Config) = 0
BEGIN
    update TeamsV2Tab set enablemvcgrid = 1, IsMvcTab = 1 where TabText = 'Not Yet Invoiced'
    update TeamsV2Tab set enablemvcgrid = 1, IsMvcTab = 1 where TabText = 'Invoices In Progress'
    update TeamsV2Tab set enablemvcgrid = 1, IsMvcTab = 1 where TabText = 'Invoice History'
    update TeamsV2Tab set IsMvcTab = 1 where TabText = 'Create New Invoice'
END

IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS') = 0
BEGIN
    INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order], DateDeleted, IsMvcTab, UsesMvcSubTabs, EnableMvcGrid) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'mobileTEAMS', 10, NULL, NULL, 1, NULL)
END
update TeamsV2Tab set UsesMvcSubTabs = 1 where TabText = 'mobileTEAMS'

IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'Maintenance') = 0
BEGIN
    INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order], DateDeleted, IsMvcTab, UsesMvcSubTabs, EnableMvcGrid) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'Maintenance', 9, NULL, NULL, 1, NULL)
END
update TeamsV2Tab set UsesMvcSubTabs = 1 where TabText = 'Maintenance'

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 's__Sitedeploy' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD [s__Sitedeploy] datetime NULL
END
 
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 's__Portaldeploy' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD [s__Portaldeploy] datetime NULL
END
 
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 's__Sqldeploy' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD [s__Sqldeploy] datetime NULL
END

-- ----------------------------------------- PAT TESTING -----------------------------------------
USE [TEAMS]
GO

-- PatTest column in Equipment table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'PatTest' AND Object_ID=Object_ID(N'Equipment'))
BEGIN
    ALTER TABLE [Equipment] ADD [PatTest] DATETIME NULL
END
GO

-- PatCheck column in Equipment table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'PatCheck' AND Object_ID = Object_ID(N'Equipment'))
BEGIN
    ALTER TABLE [Equipment] ADD [PatCheck] INT NOT NULL
	CONSTRAINT [DF_Equipment_PatCheck]  DEFAULT ((0))
END
GO

-- PatCheck column in Equipment table (check type is int)
IF (SELECT system_type_id FROM sys.columns WHERE Name='PatCheck' AND Object_ID=Object_ID('Equipment')) != (select xtype FROM systypes where name='int')
BEGIN 
	DECLARE @defaultconstraint VARCHAR(MAX)

	SELECT 
		@defaultconstraint=name 
	FROM 
		sys.default_constraints 
	WHERE 
		parent_object_id=object_ID('dbo.Equipment') 
			AND 
		object_id IN (SELECT default_object_id FROM sys.columns WHERE Name = 'PatCheck' AND Object_ID = Object_ID('Equipment'))

	IF LEN(@defaultconstraint) > 0 BEGIN --only if the constraint is present
		-- Drop the constraint
		EXEC('ALTER TABLE Equipment DROP CONSTRAINT ' + @defaultconstraint)
	END

	-- Modify the column and add the constraint
	ALTER TABLE Equipment ALTER COLUMN PatCheck INT NOT NULL
	ALTER TABLE Equipment ADD CONSTRAINT DF_Equipment_PatCheck DEFAULT 0 FOR PatCheck
END
GO

-- PatTest table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='PatTest'))
	BEGIN
		CREATE TABLE [dbo].[PatTest](
			[PatTestID] [int] IDENTITY(1,1) NOT NULL,
			[EquipmentID] [int] NOT NULL,
			[PatTestDate] [datetime] NOT NULL,
			[NotInUse] [varchar](50) NULL,
			[FileNamePDF] [varchar](50) NULL,
			[DateCreated] [datetime] NOT NULL,
			[DateDeleted] [datetime] NULL,
		 CONSTRAINT [PK_PatTest_PatTestID] PRIMARY KEY CLUSTERED 
		(
			[PatTestID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- PatTestInformation table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='PatTestInformation'))
	BEGIN
		CREATE TABLE [dbo].[PatTestInformation](
			[PatTestInformationID] [int] IDENTITY(1,1) NOT NULL,
			[PatTestID] [int] NOT NULL,
			[PatTestInformationTypeID] [int] NOT NULL,
			[PatTestInt] [int] NULL,
			[PatTestText] [varchar](max) NULL,
			[PatTestDateTime] [datetime] NULL,
		 CONSTRAINT [PK_PatTestInformation_PatTestInformationID] PRIMARY KEY CLUSTERED 
		(
			[PatTestInformationID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- PatTestInformationType table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'PatTestInformationType'))
	BEGIN
		CREATE TABLE [dbo].[PatTestInformationType](
			[PatTestInformationTypeID] [int] IDENTITY(1,1) NOT NULL,
			[EquipmentCategoryID] [int] NOT NULL,
			[Description] [varchar](50) NOT NULL,
			[EntryType] [varchar](50) NOT NULL,
			[Required] [bit] NOT NULL,
		 CONSTRAINT [PK_PatTestInformationType_PatTestInformationTypeID] PRIMARY KEY CLUSTERED 
		(
			[PatTestInformationTypeID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]

		ALTER TABLE [dbo].[PatTestInformationType] ADD CONSTRAINT [DF_PatTestInformationType_Required]  DEFAULT ((0)) FOR [Required]
	END 
COMMIT TRANSACTION
GO

-- EquipmentPatCheck table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'EquipmentPatCheck'))
	BEGIN
		CREATE TABLE [dbo].[EquipmentPatCheck](
			[PatCheckID] [int] IDENTITY(0,1) NOT NULL,
			[TypeName] [varchar](10) NOT NULL,
			[Description] [varchar](30) NULL,
		 CONSTRAINT [PK_EquipmentPatCheck_PatCheckID] PRIMARY KEY CLUSTERED 
		(
			[PatCheckID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- EquipmentPatCheck table data
IF not exists(SELECT * FROM EquipmentPatCheck)
BEGIN
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('YEARLY','Yearly')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('HALFYEAR','Half Yearly')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('QUARTERLY','Quarterly')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('MONTHLY','Monthly')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('DAILY','Daily')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('UNREQUIRED','Check Not Required')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('BIENNIAL','Biennial')
	INSERT INTO EquipmentPatCheck ([TypeName],[Description]) VALUES ('5 YEARLY','5 Yearly')
END
GO

-- PatTestDueDate dummy function
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='FN' AND name='PatTestDueDate')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[PatTestDueDate] (@EquipmentID int) RETURNS datetime WITH EXECUTE AS CALLER AS BEGIN RETURN null END')
END
GO

-- PatTestDueDate full function
ALTER FUNCTION [dbo].[PatTestDueDate] (@EquipmentID int)
RETURNS datetime
WITH EXECUTE AS CALLER
AS
BEGIN

	DECLARE @DueDate	DATETIME
	DECLARE @PatCheck	INT
	DECLARE @StartDate	DATETIME
      
	SELECT @PatCheck = PatCheck FROM Equipment WHERE EquipmentID = @EquipmentID
      
	IF EXISTS (SELECT 1 FROM PatTest WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL)
	BEGIN
		SELECT @StartDate = MAX(PatTestDate) FROM PatTest WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL

		SELECT @DueDate = CASE @PatCheck
			WHEN 0 THEN DATEADD(year,1,@StartDate)
			WHEN 1 THEN DATEADD(month,6,@StartDate)
			WHEN 2 THEN DATEADD(month,3,@StartDate)
			WHEN 3 THEN DATEADD(month,1,@StartDate)
			WHEN 4 THEN DATEADD(day,1,@StartDate)
			WHEN 5 THEN DATEADD(year,100,GETDATE())  -- really loads in the future!!
			WHEN 6 THEN DATEADD(year,2,@StartDate)
			WHEN 7 THEN DATEADD(year,5,@StartDate)
			WHEN 8 THEN DATEADD(MONTH,8,@StartDate)
			WHEN 9 THEN DATEADD(YEAR,10,@StartDate)
			-- shouldn't ever hit the else!  but if we do just return the start date for safety
			ELSE @StartDate END
	END
	ELSE BEGIN
		SELECT @DueDate = null
	END

	RETURN @DueDate
END
GO

-- getPatTestInformation dummy sp
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='P' AND name='getPatTestInformation')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[getPatTestInformation] AS BEGIN SET NOCOUNT ON; END')
END
GO

-- getPatTestInformation full sp
ALTER PROCEDURE [dbo].[getPatTestInformation]
	@patTestID int,
	@equipmentCategoryID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    create table #rex
	(
		equipmentCategoryID int not null,
		PatTestInformationTypeID int not null,
		description varchar(50) not null,
		entrytype varchar(50) not null,
		required bit not null,
		pattestid int null,
		pattesttext varchar(max) null,
		pattestInt int null,
		pattestdatetime datetime null
	)

	insert into #rex
	(
		equipmentCategoryID,
		PatTestInformationTypeID,
		description,
		entryType,
		required		
	)
	select
		pit.EquipmentCategoryID,
		pit.PatTestInformationTypeID,
		pit.Description,
		pit.EntryType,
		pit.Required
	from
		patTestInformationType pit
	where 
		pit.EquipmentCategoryID = @EquipmentCategoryID
	
	update #rex 
	set 
		pattestid = pti.PatTestID,
		pattesttext = pti.PatTestText,
		pattestInt = pti.PatTestInt,
		pattestdatetime =pti.PatTestDateTime 
	from
		PatTestInformation pti
	where 
		#rex.PatTestInformationTypeID = pti.PatTestInformationTypeID and
		pti.pattestid = @patTestID
	
	select * from #rex
	drop table #rex
END
GO

-- ---------------------------------- MANUAL INSPECTION TESTING ----------------------------------
USE [TEAMS]
GO

-- ManualInspectionTest column in Equipment table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'ManualInspectionTest' AND Object_ID=Object_ID(N'Equipment'))
BEGIN
    ALTER TABLE [Equipment] ADD [ManualInspectionTest] DATETIME NULL
END
GO

-- ManualInspectionCheck column in Equipment table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'ManualInspectionCheck' AND Object_ID=Object_ID(N'Equipment'))
BEGIN
    ALTER TABLE [Equipment] ADD [ManualInspectionCheck] INT NOT NULL
	CONSTRAINT [DF_Equipment_ManualInspectionCheck]  DEFAULT ((0))
END
GO

-- ManualInspectionCheck column in Equipment table (check type is int)
IF (SELECT system_type_id FROM sys.columns WHERE Name='ManualInspectionCheck' AND Object_ID=Object_ID('Equipment')) != (select xtype FROM systypes where name='int') BEGIN 
	DECLARE @defaultconstraint VARCHAR(MAX)

	SELECT 
		@defaultconstraint=name 
	FROM 
		sys.default_constraints 
	WHERE 
		parent_object_id = object_ID('dbo.Equipment') 
			AND 
		object_id IN (SELECT default_object_id FROM sys.columns WHERE Name = 'ManualInspectionCheck' AND Object_ID = Object_ID('Equipment'))

	IF LEN(@defaultconstraint) > 0 BEGIN --only if the constraint is present
		-- Drop the constraint
		EXEC('ALTER TABLE Equipment DROP CONSTRAINT ' + @defaultconstraint)
	END

	-- Modify the column and add the constraint
	ALTER TABLE Equipment ALTER COLUMN ManualInspectionCheck INT NOT NULL
	ALTER TABLE Equipment ADD CONSTRAINT DF_Equipment_ManualInspectionCheck DEFAULT 0 FOR ManualInspectionCheck
END
GO

-- ManualCheck table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ManualCheck'))
	BEGIN
		CREATE TABLE [dbo].[ManualCheck](
			[ManualCheckID] [int] IDENTITY(1,1) NOT NULL,
			[EquipmentID] [int] NOT NULL,
			[ManualCheckDate] [datetime] NOT NULL,
			[NotInUse] [varchar](50) NULL,
			[FileNamePDF] [varchar](50) NULL,
			[PAT] [varchar](50) NULL,
			[DateCreated] [datetime] NOT NULL,
			[DateDeleted] [datetime] NULL,
		 CONSTRAINT [PK_Check_CheckID] PRIMARY KEY CLUSTERED 
		(
			[ManualCheckID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- ManualCheckInformation table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ManualCheckInformation'))
	BEGIN
		CREATE TABLE [dbo].[ManualCheckInformation](
			[ManualCheckInformationID] [int] IDENTITY(1,1) NOT NULL,
			[ManualCheckID] [int] NOT NULL,
			[ManualCheckInformationTypeID] [int] NOT NULL,
			[ManualCheckInt] [int] NULL,
			[ManualCheckText] [varchar](max) NULL,
			[ManualCheckDateTime] [datetime] NULL,
		 CONSTRAINT [PK_ManualCheckInformation_ManualCheckInformationID] PRIMARY KEY CLUSTERED 
		(
			[ManualCheckInformationID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- ManualCheckInformationType table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'ManualCheckInformationType'))
	BEGIN
		CREATE TABLE [dbo].[ManualCheckInformationType](
			[ManualCheckInformationTypeID] [int] IDENTITY(1,1) NOT NULL,
			[EquipmentCategoryID] [int] NOT NULL,
			[Description] [varchar](50) NOT NULL,
			[EntryType] [varchar](50) NOT NULL,
			[Required] [bit] NOT NULL,
		 CONSTRAINT [PK_ManualCheckInformationType_ManualCheckInformationTypeID] PRIMARY KEY CLUSTERED 
		(
			[ManualCheckInformationTypeID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- EquipmentManualCheck table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'EquipmentManualCheck'))
	BEGIN
		CREATE TABLE [dbo].[EquipmentManualCheck](
			[ManualCheckID] [int] IDENTITY(0,1) NOT NULL,
			[TypeName] [varchar](10) NOT NULL,
			[Description] [varchar](30) NULL,
			CONSTRAINT [PK_EquipmentManualCheck_ManualCheckID] PRIMARY KEY CLUSTERED 
			(
				[ManualCheckID] ASC
			)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- EquipmentManualCheck table data
IF not exists(SELECT * FROM EquipmentManualCheck)
BEGIN
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('YEARLY','Yearly')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('HALFYEAR','Half Yearly')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('QUARTERLY','Quarterly')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('MONTHLY','Monthly')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('DAILY','Daily')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('UNREQUIRED','Check Not Required')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('BIENNIAL','Biennial')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('5 YEARLY','5 Yearly')
	INSERT INTO EquipmentManualCheck ([TypeName],[Description]) VALUES ('BIMONTHLY','Bi Monthly')
END
GO

-- ManualCheckDueDate dummy function
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='FN' AND name='ManualCheckDueDate')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[ManualCheckDueDate] (@EquipmentID int) RETURNS datetime WITH EXECUTE AS CALLER AS BEGIN RETURN null END')
END
GO

-- ManualCheckDueDate full function
ALTER FUNCTION [dbo].[ManualCheckDueDate] (@EquipmentID int)
RETURNS datetime
WITH EXECUTE AS CALLER
AS
BEGIN
	DECLARE @DueDate        DATETIME
	DECLARE @ManualCheck  INT
	DECLARE @StartDate      DATETIME
      
	SELECT @ManualCheck = ManualInspectionCheck FROM Equipment WHERE EquipmentID = @EquipmentID
      
	IF EXISTS (SELECT 1 FROM ManualCheck WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL)
	BEGIN
		SELECT @StartDate = MAX(ManualCheckDate) FROM ManualCheck WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL

		SELECT @DueDate = CASE @ManualCheck
			WHEN 0 THEN DATEADD(year,1,@StartDate)
			WHEN 1 THEN DATEADD(month,6,@StartDate)
			WHEN 2 THEN DATEADD(month,3,@StartDate)
			WHEN 3 THEN DATEADD(month,1,@StartDate)
			WHEN 4 THEN DATEADD(day,1,@StartDate)
			WHEN 5 THEN DATEADD(year,100,GETDATE())  -- really loads in the future!!
			WHEN 6 THEN DATEADD(year,2,@StartDate)
			WHEN 7 THEN DATEADD(year,5,@StartDate)
			WHEN 8 THEN DATEADD(MONTH,8,@StartDate)
			WHEN 9 THEN DATEADD(YEAR,10,@StartDate)
			-- shouldn't ever hit the else!  but if we do just return the start date for safety
			ELSE @StartDate END
	END
	ELSE
	BEGIN
		SELECT @StartDate = null
	END

	RETURN @DueDate
END
GO

-- getManualCheckInformation dummy sp
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='P' AND name='getManualCheckInformation')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[getManualCheckInformation] AS BEGIN SET NOCOUNT ON; END')
END
GO

-- getManualCheckInformation full sp
ALTER PROCEDURE [dbo].[getManualCheckInformation]
	@ManualCheckID int,
	@equipmentCategoryID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    create table #rex
	(
		equipmentCategoryID int not null,
		ManualCheckInformationTypeID int not null,
		description varchar(50) not null,
		entrytype varchar(50) not null,
		required bit not null,
		Manualcheckid int null,
		Manualchecktext varchar(max) null,
		ManualcheckInt int null,
		Manualcheckdatetime datetime null
	)

	insert into #rex
	(
		equipmentCategoryID,
		ManualCheckInformationTypeID,
		description,
		entryType,
		required		
	)
	select
		cit.EquipmentCategoryID,
		cit.ManualCheckInformationTypeID,
		cit.Description,
		cit.EntryType,
		cit.Required
	from
		ManualcheckInformationType cit
	where 
		cit.EquipmentCategoryID = @EquipmentCategoryID
	
	update #rex 
	set 
		Manualcheckid = ci.ManualCheckID,
		Manualchecktext = ci.ManualCheckText,
		ManualcheckInt = ci.ManualCheckInt,
		Manualcheckdatetime =ci.ManualCheckDateTime 
	from
		ManualCheckInformation ci
	where 
		#rex.ManualCheckInformationTypeID = ci.ManualCheckInformationTypeID and
		ci.Manualcheckid = @ManualCheckID
	
	select * from #rex
	drop table #rex
END
GO


-- ---------------------------------- NEW CONFIG COLUMN FOR QC ----------------------------------------
USE [TEAMS]
GO

-- b__BlankNotesInQC column in Config table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'b__BlankNotesInQC' AND Object_ID=Object_ID(N'Config'))
BEGIN
    ALTER TABLE [Config] ADD [b__BlankNotesInQC] INT NOT NULL
	CONSTRAINT [DF_Config_BlankNotesInQC]  DEFAULT ((0))
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='EnterpriseServerCode') < 1
BEGIN
  ALTER TABLE Client
      ADD [EnterpriseServerCode] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Site') AND name='TEAMSUPRN') < 1
BEGIN
  ALTER TABLE Site
      ADD [TEAMSUPRN] [VARCHAR] (MAX) NULL
END


-- QRcode TABLES AND SPROCS!
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='QRCode'))
	BEGIN
				
		CREATE TABLE [dbo].[QRCode](
	[QRCodeID] [int] IDENTITY(1,1) NOT NULL,
	[QRCodeTypeID] [int] NOT NULL,
	[DataID] [int] NOT NULL,
	[UniqueCode] [varchar](20) NOT NULL,
	[Image] [varbinary](max) NOT NULL,
	[ImageContentType] [varchar](50) NOT NULL,
 CONSTRAINT [PK_QRCode] PRIMARY KEY CLUSTERED 
(
	[QRCodeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]	
	
	
	END 
COMMIT TRANSACTION
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='QRCodeType'))
	BEGIN

CREATE TABLE [dbo].[QRCodeType](
	[QRCodeTypeID] [int] NOT NULL,
	[Description] [varchar](50) NOT NULL,
 CONSTRAINT [PK_QRCodeType] PRIMARY KEY CLUSTERED 
(
	[QRCodeTypeID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

insert into QRCodeType (QRCodeTypeID, Description) values (1, 'Register')
insert into QRCodeType (QRCodeTypeID, Description) values (2, 'Floorplan')
insert into QRCodeType (QRCodeTypeID, Description) values (3, 'Room')
insert into QRCodeType (QRCodeTypeID, Description) values (4, 'Sample')
insert into QRCodeType (QRCodeTypeID, Description) values (5, 'Job')

	END 
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetSampleQRCodesForSurvey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetSampleQRCodesForSurvey] AS BEGIN SET NOCOUNT ON; END')
END
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetRoomQRCodesForSurvey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetRoomQRCodesForSurvey] AS BEGIN SET NOCOUNT ON; END')
END
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetFloorplanQRCodesForSurvey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetFloorplanQRCodesForSurvey] AS BEGIN SET NOCOUNT ON; END')
END
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetBuildingQRCodesForSurvey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetBuildingQRCodesForSurvey] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[GetSampleQRCodesForSurvey]
    @JobID INT,
    @SurveyTypeID INT
/**********************************************************************
** Overview: Get all the Sample QR Codes for a Survey. Generic across all servers.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Get information that is repeated per row in variables to reduce table scans
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = (SELECT ISNULL(NULLIF(s__BasementName, ''), 'Z-Sub Level') FROM Config)

    -- Get basic sample data up front to reduce table scans on the sample table.
    DECLARE @SampleData TABLE (RegisterID INT, RoomID INT, SampleRef VARCHAR(50), AsSample BIT, RegisterItemNo INT, SampleID INT, PhotoID INT)

    INSERT INTO @SampleData (RegisterID, RoomID, SampleRef, AsSample, RegisterItemNo, SampleID, PhotoID)
    SELECT
        r.RegisterID,
        rm.RoomID,
        s.SampleRef,
        s.AsSample,
        s.RegisterItemNo,
        s.SampleID,
        s.PhotoID
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
    WHERE
        je.JobID = @JobID
            AND
        su.SurveyTypeID = @SurveyTypeID

    -- Get all element data up front to reduce table scans on the element table
    DECLARE @ElementData TABLE (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX), ElementIntMeaningShortDescription VARCHAR(MAX), ElementIntMeaningLongDescription VARCHAR(MAX), ElementDescriptionOrText VARCHAR(MAX))

    INSERT INTO @ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription, ElementIntMeaningShortDescription, ElementIntMeaningLongDescription, ElementDescriptionOrText)
    SELECT
        e.ElementID,
        e.SampleID,
        e.ElementTypeID,
        e.ElementText,
        e.ElementIntID,
        e.ElementIntMeaningID,
        e.ElementIntMeaningExtendedID,
        e.ElementIntMeaningSubOptionID,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description),
        eim.ShortDescription,
        eim.Description,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description, e.ElementText)
    FROM
        @SampleData s
        INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
        INNER JOIN (
            SELECT ElementTypeID
            FROM
            (   -- Only specify the ElementTypeID's that we need, as it's a generic SPROC.
                VALUES (1), (2), (5)
            ) et (ElementTypeID)
        ) et ON e.ElementTypeID = et.ElementTypeID
        LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID


    -- Start the main SELECT.
    SELECT
        r.RegisterID,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A') [BuildingDesignation],
        CONVERT(VARCHAR(10), r.RegisterStart, 103) [RegisterStart],
        CONVERT(VARCHAR(10), r.RegisterFinish, 103) [RegisterFinish],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorName],
        rm.RoomID,
        RTRIM(rm.Description) [RoomName],
        ISNULL(NULLIF(rm.RoomCode, ''), dbo.FloorNumberShort(f.FloorNumber) + '.' + RIGHT('000' + CAST(rm.Number AS VARCHAR(10)), 3)) [RoomCode],
        sd.SampleID,
        CASE WHEN sd.AsSample = 1
            THEN 'As ' + sd.SampleRef
            ELSE ISNULL(sd.SampleRef, 'Visual')
        END [SampleRef],
        sd.RegisterItemNo,
        e2.ElementText [Description],
        ISNULL(NULLIF(e1.ElementText, ''), '&nbsp;') [Position],
        ISNULL(e5.ElementIntMeaningLongDescription, 'No suspect materials found') [LevelOfIdentification],
        CASE WHEN qrc.Image IS NOT NULL
            THEN '<img src="[HOSTNAME]/images/getQRCodeFromTable.asp?id=' + CAST(qrc.QRCodeID AS VARCHAR(20)) + '&[RND]" class="QRCodeItem" />'
            ELSE '<span class="QRCodeItem">No QR Code Available</span>'
        END [QRCode]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
        INNER JOIN @SampleData sd ON rm.RoomID = sd.RoomID
        INNER JOIN QRCode qrc WITH (NOLOCK) ON sd.SampleID = qrc.DataID AND qrc.QRCodeTypeID = 4

        -- NOTE: When adding another Element join, change the inner select on @ElementData.
        LEFT JOIN @ElementData e1 ON sd.SampleID = e1.SampleID AND e1.ElementTypeID = 1
        INNER JOIN @ElementData e2 ON sd.SampleID = e2.SampleID AND e2.ElementTypeID = 2
        LEFT JOIN @ElementData e5 ON sd.SampleID = e5.SampleID AND e5.ElementTypeID = 5
    WHERE
        je.JobID = @JobID
    ORDER BY
        r.RegisterStart,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A'),
        sd.RegisterItemNo


    SET NOCOUNT OFF;
END
GO
ALTER PROCEDURE [dbo].[GetRoomQRCodesForSurvey]
    @JobID INT,
    @SurveyTypeID INT
/**********************************************************************
** Overview: Get all the Room QR Codes for a Survey. Generic across all servers.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Get information that is repeated per row in variables to reduce table scans
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = (SELECT ISNULL(NULLIF(s__BasementName, ''), 'Z-Sub Level') FROM Config)


    -- Start the main SELECT.
    SELECT
        r.RegisterID,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A') [BuildingDesignation],
        CONVERT(VARCHAR(10), r.RegisterStart, 103) [RegisterStart],
        CONVERT(VARCHAR(10), r.RegisterFinish, 103) [RegisterFinish],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorName],
        rm.RoomID,
        RTRIM(rm.Description) [RoomName],
        ISNULL(NULLIF(rm.RoomCode, ''), dbo.FloorNumberShort(f.FloorNumber) + '.' + RIGHT('000' + CAST(rm.Number AS VARCHAR(10)), 3)) [RoomCode],
        CASE WHEN qrc.Image IS NOT NULL
            THEN '<img src="[HOSTNAME]/images/getQRCodeFromTable.asp?id=' + CAST(qrc.QRCodeID AS VARCHAR(20)) + '&[RND]" class="QRCodeItem" />'
            ELSE '<span class="QRCodeItem">No QR Code Available</span>'
        END [QRCode]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
        INNER JOIN QRCode qrc WITH (NOLOCK) ON rm.RoomID = qrc.DataID AND qrc.QRCodeTypeID = 3
    WHERE
        je.JobID = @JobID
            AND
        su.SurveyTypeID = @SurveyTypeID
    ORDER BY
        r.RegisterStart,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A'),
        ISNULL(rm.RoomCode, CAST(rm.Number AS VARCHAR(500)))


    SET NOCOUNT OFF;
END
GO
ALTER PROCEDURE [dbo].[GetFloorplanQRCodesForSurvey]
    @JobID INT,
    @SurveyTypeID INT
/**********************************************************************
** Overview: Get all the Floorplan QR Codes for a Survey. Generic across all servers.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;

	-- Get information that is repeated per row in variables to reduce table scans
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = (SELECT ISNULL(NULLIF(s__BasementName, ''), 'Z-Sub Level') FROM Config)

    -- Start the main SELECT.
    SELECT
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorName],
        CASE WHEN qrc.Image IS NOT NULL
            THEN '<img src="[HOSTNAME]/images/getQRCodeFromTable.asp?id=' + CAST(qrc.QRCodeID AS VARCHAR(20)) + '&[RND]" class="QRCodeItem" />'
            ELSE '<span class="QRCodeItem">No QR Code Available</span>'
        END [QRCode]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
		INNER JOIN dbo.Floorplan f WITH (NOLOCK) ON f.RegisterID = r.RegisterID
		INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN QRCode qrc WITH (NOLOCK) ON f.FloorplanID = qrc.DataID AND qrc.QRCodeTypeID = 2
    WHERE
        je.JobID = @JobID
            AND
        su.SurveyTypeID = @SurveyTypeID
    ORDER BY
        r.RegisterStart,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A')


    SET NOCOUNT OFF;
END
GO
ALTER PROCEDURE [dbo].[GetBuildingQRCodesForSurvey]
    @JobID INT,
    @SurveyTypeID INT
/**********************************************************************
** Overview: Get all the Building QR Codes for a Survey. Generic across all servers.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;

    -- Start the main SELECT.
    SELECT
        r.RegisterID,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A') [BuildingDesignation],
        CASE WHEN qrc.Image IS NOT NULL
            THEN '<img src="[HOSTNAME]/images/getQRCodeFromTable.asp?id=' + CAST(qrc.QRCodeID AS VARCHAR(20)) + '&[RND]" class="QRCodeItem" />'
            ELSE '<span class="QRCodeItem">No QR Code Available</span>'
        END [QRCode]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
		INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN QRCode qrc WITH (NOLOCK) ON r.RegisterID = qrc.DataID AND qrc.QRCodeTypeID = 1
    WHERE
        je.JobID = @JobID
            AND
        su.SurveyTypeID = @SurveyTypeID
    ORDER BY
        r.RegisterStart,
        ISNULL(NULLIF(r.BuildingDesignation, ''), 'N/A')


    SET NOCOUNT OFF;
END
GO

-- Template Page Layout
IF NOT EXISTS(SELECT * FROM TemplatePageLayout WHERE SearchString = 'tpl_SurveyQRCodes')
BEGIN
    EXEC('INSERT INTO TemplatePageLayout (SearchString, Header_RectString, Header_BrowserWidth, Header_HTML, Body_RectString, Body_BrowserWidth, Footer_RectString, Footer_BrowserWidth, Footer_HTML_Override, Landscape, IsChainable, MediaBox, PriorityOrder)
VALUES (''tpl_SurveyQRCodes'', ''30 780 570 780'', 800, ''<!-- Header --><!-- End Header -->'', ''30 40 570 750'', 800, ''30 5 570 40'', 800, ''<!-- Footer -->
<table style="width: 100%; border-collapse: collapse;">
    <tr>
        <td style="font-family: Arial; font-size: 10pt; width: 33%;">
            QR Codes
        </td>
        <td style="font-family: Arial; font-size: 10pt; width: 33%; text-align: center;">
            [JOBNUMBER]
        </td>
        <td style="font-family: Arial; font-size: 10pt; width: 33%; text-align: right;">
           Page [CURRENTPAGE] of [TOTALPAGES]
        </td>
    </tr>
</table>
<!-- End Footer -->'', 0, 1, ''0 0 612 792'', -1)')
END

-- Row Template
IF NOT EXISTS(SELECT * FROM RowTemplate WHERE ReplaceVariable = 'QRCODEITEMS')
BEGIN
    EXEC('INSERT INTO RowTemplate (ReplaceVariable, HeaderHTML, RowHTML, FooterHTML, HeaderFooterSQL, RowSQL, NoDataRowHTML, MaxRowsPerPage, MaxRowsPerPageAdditionalPagesOverride, RowTemplateTypeInt)
    VALUES (''QRCODEITEMS'', ''<!-- Header -->
    <div class="tpl_SurveyQRCodes Centre Width100">
    <!-- End Header -->'', ''<!-- Row -->
        <div class="Centre Width47" style="float: left; padding-right: 10px; height: 250px;">
            <p class="Centre" style="padding-top: 10px; padding-bottom: 10px;">
                <b>Item Number:</b> [RegisterItemNo]<br />
                <b>Sample Ref:</b> [SampleRef]
            </p>
            [QRCode]
        </div>
    <!-- End Row -->'', ''<!-- Footer -->
    </div>
    <!-- End Footer -->'', ''SELECT 0'', ''EXEC GetSampleQRCodesForSurvey @JobID = {iDataID}, @SurveyTypeID = {iSurveyTypeID}'', ''<!-- No Data Row -->
    <p class="Bold">No QR Codes were found.</p>
    <!-- End No Data Row -->'', 4, 6, 2)')
END
IF NOT EXISTS(SELECT * FROM RowTemplate WHERE ReplaceVariable = 'QRCODEROOMS')
BEGIN
    EXEC('INSERT INTO RowTemplate (ReplaceVariable, HeaderHTML, RowHTML, FooterHTML, HeaderFooterSQL, RowSQL, NoDataRowHTML, MaxRowsPerPage, MaxRowsPerPageAdditionalPagesOverride, RowTemplateTypeInt)
VALUES (''QRCODEROOMS'', ''<!-- Header -->
<div class="tpl_SurveyQRCodes Centre Width100">
<!-- End Header -->'', ''<!-- Row -->
    <div class="Centre Width47" style="float: left; padding-right: 10px; height: 250px;">
        <p class="Centre" style="padding-top: 10px; padding-bottom: 10px;">
            <b>Room:</b> [RoomName]<br />
            <b>Room Code:</b> [RoomCode]
        </p>
        [QRCode]
    </div>
<!-- End Row -->'', ''<!-- Footer -->
</div>
<!-- End Footer -->'', ''SELECT 0'', ''EXEC GetRoomQRCodesForSurvey @JobID = {iDataID}, @SurveyTypeID = {iSurveyTypeID}'', ''<!-- No Data Row -->
<p class="Bold">No QR Codes were found.</p>
<!-- End No Data Row -->'', 4, 6, 2)')
END
IF NOT EXISTS(SELECT * FROM RowTemplate WHERE ReplaceVariable = 'QRCODEFLOORPLANS')
BEGIN
    EXEC('INSERT INTO RowTemplate (ReplaceVariable, HeaderHTML, RowHTML, FooterHTML, HeaderFooterSQL, RowSQL, NoDataRowHTML, MaxRowsPerPage, MaxRowsPerPageAdditionalPagesOverride, RowTemplateTypeInt)
VALUES (''QRCODEFLOORPLANS'', ''<!-- Header -->
<div class="tpl_SurveyQRCodes Centre Width100">
<!-- End Header -->'', ''<!-- Row -->
    <div class="Centre Width47" style="float: left; padding-right: 10px; height: 250px;">
        <p class="Centre" style="padding-top: 10px; padding-bottom: 10px;">
            <b>Floor:</b> [FloorName]
        </p>
        [QRCode]
    </div>
<!-- End Row -->'', ''<!-- Footer -->
</div>
<!-- End Footer -->'', ''SELECT 0'', ''EXEC GetFloorplanQRCodesForSurvey @JobID = {iDataID}, @SurveyTypeID = {iSurveyTypeID}'', ''<!-- No Data Row -->
<p class="Bold">No QR Codes were found.</p>
<!-- End No Data Row -->'', 4, 6, 2)')
END
IF NOT EXISTS(SELECT * FROM RowTemplate WHERE ReplaceVariable = 'QRCODEBUILDINGS')
BEGIN
    EXEC('INSERT INTO RowTemplate (ReplaceVariable, HeaderHTML, RowHTML, FooterHTML, HeaderFooterSQL, RowSQL, NoDataRowHTML, MaxRowsPerPage, MaxRowsPerPageAdditionalPagesOverride, RowTemplateTypeInt)
VALUES (''QRCODEBUILDINGS'', ''<!-- Header -->
<div class="tpl_SurveyQRCodes Centre Width100">
<!-- End Header -->'', ''<!-- Row -->
    <div class="Centre Width47" style="float: left; padding-right: 10px; height: 250px;">
        <p class="Centre" style="padding-top: 10px; padding-bottom: 10px;">
            <b>Building:</b> [BuildingDesignation]
        </p>
        [QRCode]
    </div>
<!-- End Row -->'', ''<!-- Footer -->
</div>
<!-- End Footer -->'', ''SELECT 0'', ''EXEC GetBuildingQRCodesForSurvey @JobID = {iDataID}, @SurveyTypeID = {iSurveyTypeID}'', ''<!-- No Data Row -->
<p class="Bold">No QR Codes were found.</p>
<!-- End No Data Row -->'', 4, 6, 2)')
END
GO

-- If one of the Flushed columns does not exist, we assume they all do not exist.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'FlushedCold' AND object_id = OBJECT_ID('LegionellaOutletPortalData'))
BEGIN
    ALTER TABLE LegionellaOutletPortalData
    ADD [FlushedCold] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD [FlushedHot] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD [FlushedMixed] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD [FlushedMains] [bit] NOT NULL DEFAULT 0

    ALTER TABLE LegionellaOutletComputedData
    ADD [FlushedCold] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD [FlushedHot] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD [FlushedMixed] [bit] NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD [FlushedMains] [bit] NOT NULL DEFAULT 0
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'LowUseCold' AND object_id = object_id('LegionellaOutletPortalData'))
BEGIN
    ALTER TABLE LegionellaOutletPortalData
    ADD LowUseCold BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD LowUseHot BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD LowUseMixed BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletPortalData
    ADD LowUseMains BIT NOT NULL DEFAULT 0

    ALTER TABLE LegionellaOutletComputedData
    ADD LowUseCold BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD LowUseHot BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD LowUseMixed BIT NOT NULL DEFAULT 0
    ALTER TABLE LegionellaOutletComputedData
    ADD LowUseMains BIT NOT NULL DEFAULT 0
END
GO
ALTER Proc [dbo].[PopulateLegionellaOutletComputedData]
    @JobID INT
As
Begin
    Set NoCount On;


	DECLARE @SiteID INT = (Select SiteID FROM Job Where JobID=@JobId)
	DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobId)

	--Clear out the data for the given job
	DELETE LegionellaOutletComputedData Where SiteID = @SiteID

	--Get historic temp data per outlet associated with the job
	DECLARE @LegionellaOutlet TABLE (PerformedByEmployeeID INT,LegionellaOutletID INT, LegionellaLocationID INT, [GUID] VARCHAR(MAX), GUIDVersion INT, LegionellaFinish DATETIME, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	Insert into @LegionellaOutlet (PerformedByEmployeeID,LegionellaOutletID,LegionellaLocationID,[GUID],GUIDVersion,LegionellaFinish,Cold,Hot,[Mixed],Mains, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		ISNULL(lo.FlushedCold, 0) [FlushedCold],
		ISNULL(lo.FlushedHot, 0) [FlushedHot],
		ISNULL(lo.FlushedMixed, 0) [FlushedMixed],
		ISNULL(lo.FlushedMains, 0) [FlushedMains],
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains
	FROM
		Job j WITH (NOLOCK)
		INNER JOIN Quote q WITH (NOLOCK) ON q.JobID=j.JobID
		INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL
		INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
		INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
		INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON ll.LegionellaID=l.LegionellaID AND ll.Deleted IS NULL
		INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON lo.LegionellaLocationID=ll.LegionellaLocationID AND lo.Deleted IS NULL
	Where
		j.SiteID=@SiteID
			AND
		j.ClientID=@ClientID
			AND
		(
			j.Approved IS NOT NULL
				OR
			j.JobID = @JobID
		)
	Group By
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		lo.FlushedCold,
		lo.FlushedHot,
		lo.FlushedMixed,
		lo.FlushedMains,
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains

	DECLARE @LegionellaOutletComputedData TABLE (JobID INT, OriginalOutletID INT,LegionellaOutletID INT, LegionellaLocationID INT, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), PerformedByEmployeeID INT, PerformedByPortalUserID INT, PerformedByThirdParty VARCHAR(MAX), Comments VARCHAR(MAX), Recorded DATETIME, FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		main.JobID, main.LegionellaOutletID [OriginalOutletID],main.CurrentOutletID [LegionellaOutletID], main.CurrentLocationID [LegionellaLocationID],main.Cold,main.Hot,main.[Mixed],main.Mains,main.PerformedByEmployeeID,main.PerformedByPortalUserID,main.PerformedByThirdParty,main.Comments,main.Recorded, main.FlushedCold, main.FlushedHot, main.FlushedMixed, main.FlushedMains, main.LowUseCold, main.LowUseHot, main.LowUseMixed, main.LowUseMains
	FROM
		(
			Select
				@JobID [JobID], 
				lo.LegionellaOutletID [CurrentOutletID],
				lo.LegionellaLocationID [CurrentLocationID],
				ROW_NUMBER() OVER (Partition By loMax.GUID,loMax.LegionellaFinish Order by lo.LegionellaFinish DESC) [Identifier],
				loMax.LegionellaOutletID,
				loMax.[GUID],
				loMax.Cold,
				loMax.Hot,
				loMax.Mixed,
				loMax.Mains,
				lo.PerformedByEmployeeID,
				NULL [PerformedByPortalUserID],
				NULL [PerformedByThirdParty],
				NULL [Comments],
				loMax.LegionellaFinish [Recorded],
				loMax.FlushedCold,
				loMax.FlushedHot,
				loMax.FlushedMixed,
				loMax.FlushedMains,
				loMax.LowUseCold,
				loMax.LowUseHot,
				loMax.LowUseMixed,
				loMax.LowUseMains
			FROM 
				@LegionellaOutlet lo
				INNER JOIN @LegionellaOutlet loMax ON lo.GUID=loMax.GUID
		) main
	Where
		main.Identifier = 1

	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	SELECT
		locd.JobID,locd.OriginalOutletID,locd.LegionellaOutletID,locd.LegionellaLocationID,lopd.Cold,lopd.Hot,lopd.[Mixed],lopd.Mains,NULL [PerformedByEmployeeID],lopd.PerformedByPortalUserID,lopd.PerformedByThirdParty,lopd.Comments,lopd.Recorded, lopd.FlushedCold, lopd.FlushedHot, lopd.FlushedMixed, lopd.FlushedMains, lopd.LowUseCold, lopd.LowUseHot, lopd.LowUseMixed, lopd.LowUseMains
	FROM
		@LegionellaOutletComputedData locd
		INNER JOIN LegionellaOutletPortalData lopd ON locd.OriginalOutletID = lopd.LegionellaOutletID

	Insert into LegionellaOutletComputedData (ClientID,SiteID,JobID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		@ClientID,@SiteID,JobID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains
	FROM
		@LegionellaOutletComputedData


    Set NoCount Off;
End
GO

-- If one of the new chart columns does not exist, we assume they all do not exist.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__DisplayPortalLegLowUseOutletsChart' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__DisplayPortalLegLowUseOutletsChart BIT NOT NULL DEFAULT 0
    ALTER TABLE Config
    ADD b__DisplayPortalLegOutletsOutOfSpecChart BIT NOT NULL DEFAULT 0

    ALTER TABLE PortalUser
    ADD LegLowUseOutletsChart BIT NOT NULL DEFAULT 0
    ALTER TABLE PortalUser
    ADD LegOutletsOutOfSpecChart BIT NOT NULL DEFAULT 0
END
GO

---NEW EQUIPMENT CATEOGIES-------------------------------------------------

IF not exists(SELECT * FROM EquipmentCategory where Description like 'Extension leads')
BEGIN
	INSERT INTO EquipmentCategory (EquipmentCategoryID, Description,SurveyType, AirTestType, RemovalType, SampleType, AirSampleType, Deleted,  NoEquipmentAllowed, LabType, LegionellaType) VALUES (60, 'Extension leads', 0, 0, 0, 0, 0, GETDATE(), 0, 0, 0)
END
GO


IF not exists(SELECT * FROM EquipmentCategory where Description like 'Fire extinguisher')
BEGIN
	INSERT INTO EquipmentCategory (EquipmentCategoryID, Description,SurveyType, AirTestType, RemovalType, SampleType, AirSampleType, Deleted,  NoEquipmentAllowed, LabType, LegionellaType) VALUES (61, 'Fire extinguisher', 0, 0, 0, 0, 0, GETDATE(), 0, 0, 0)
END
GO



IF not exists(SELECT * FROM EquipmentCategory where Description like 'Phase Telescope')
BEGIN
	INSERT INTO EquipmentCategory (EquipmentCategoryID, Description,SurveyType, AirTestType, RemovalType, SampleType, AirSampleType, Deleted,  NoEquipmentAllowed, LabType, LegionellaType) VALUES (62, 'Phase Telescope', 0, 0, 0, 0, 0, GETDATE(), 0, 0, 0)
END
GO

IF not exists(SELECT * FROM EquipmentCategory where Description like 'Uniform/PPE')
BEGIN
	INSERT INTO EquipmentCategory (EquipmentCategoryID, Description,SurveyType, AirTestType, RemovalType, SampleType, AirSampleType, Deleted,  NoEquipmentAllowed, LabType, LegionellaType) VALUES (63, 'Uniform/PPE', 0, 0, 0, 0, 0, GETDATE(), 0, 0, 0)
END
GO

IF not exists(SELECT * FROM EquipmentCategory where Description like 'Furniture')
BEGIN
	INSERT INTO EquipmentCategory (EquipmentCategoryID, Description,SurveyType, AirTestType, RemovalType, SampleType, AirSampleType, Deleted,  NoEquipmentAllowed, LabType, LegionellaType) VALUES (64, 'Furniture', 0, 0, 0, 0, 0, GETDATE(), 0, 0, 0)
END
GO

-- Column for QR code generation
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Generated' AND object_id = OBJECT_ID('orgInstruction'))
BEGIN
    EXEC('
	ALTER TABLE [dbo].[orgInstruction]
	ADD [Generated] [datetime] NULL;
    ')
END
GO



-- AirtestAuthorisationType
IF NOT EXISTS(SELECT 1 FROM sys.objects WHERE object_id = object_id('AirtestAuthorisationType'))
BEGIN
    EXEC('
    CREATE TABLE [dbo].[AirtestAuthorisationType](
        [AirtestAuthorisationTypeID] [int] NOT NULL,
        [Description] [varchar](100) NOT NULL,
        [AirtestTypeID] [int] NOT NULL,
        [Deleted] [datetime] NULL,
     CONSTRAINT [PK_AirtestAuthorisationType] PRIMARY KEY CLUSTERED 
    (
        [AirtestAuthorisationTypeID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]

    CREATE NONCLUSTERED INDEX [Idx_AirtestAuthorisationType_AirtestTypeID] ON [dbo].[AirtestAuthorisationType] 
    (
        [AirtestTypeID] ASC,
        [Deleted] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

    INSERT INTO AirtestAuthorisationType (AirtestAuthorisationTypeID, Description, AirtestTypeID)
    VALUES
        (1, ''AIB/Other'', 2),
        (2, ''Sprayed coating'', 2),
        (3, ''Lagging/thermal insulation'', 2)

    ALTER TABLE EmployeeAuthorisation
    ADD [AirtestAuthorisationTypeID] [int] NULL
    ')
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'SampleClassificationIDs' AND object_id = object_id('AirtestAuthorisationType'))
BEGIN
    ALTER TABLE AirtestAuthorisationType
    ADD [SampleClassificationIDs] [varchar](max) NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'modifyEmployeeAuthorisation')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[modifyEmployeeAuthorisation] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[modifyEmployeeAuthorisation]
    @employeeId INT,
    @surveytypeid INT,
    @airtesttypeid INT,
    @enabled BIT,
    @expirydate DATETIME,
    @surveytypeGroupId INT = NULL,
    @propertytypeId INT = NULL,
    @SampleAnalysis BIT = 0,
    @AirtestAuthorisationTypeID INT = NULL,
	@SessionEmployeeID INT = 0,
	@SessionDataScript VARCHAR(MAX) = NULL,
	@SessionDataQueryString VARCHAR(MAX) = NULL,
	@SessionDataIPAddress VARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- DEBUG
        --DECLARE
        --    @employeeId INT = 92,
        --    @surveytypeid INT = NULL,
        --    @airtesttypeid INT = NULL,
        --    @enabled BIT = 0,
        --    @expirydate DATETIME = NULL,
        --    @surveytypeGroupId INT = 16,
        --    @propertytypeId INT = 1,
        --    @SampleAnalysis BIT = 0,
        --    @AirtestAuthorisationTypeID INT = NULL
    -- END DEBUG
	
	DECLARE @SurveyTypeGroupString VARCHAR(MAX) = (SELECT Description FROM SUrveyTypeGroup WHERE SurveyTypeGroupID = @surveytypeGroupId)
	DECLARE @ExpiryDateString VARCHAR(MAX) = CASE WHEN @expirydate IS NULL THEN 'No Expiry' ELSE CONVERT(varchar(max), @expirydate) END
	DECLARE @CurrentEnabled BIT

    IF @surveytypeGroupId IS NOT NULL AND @propertytypeId IS NULL
    BEGIN
		-- insert an audit
		SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM SurveyType st INNER JOIN EmployeeAuthorisation ea WITH (NOLOCK) ON st.SurveyTypeID = ea.SurveyTypeID WHERE SurveyTypeGroupID = @surveytypeGroupId AND ea.EmployeeID = @employeeId)

		IF @enabled = 1 AND @CurrentEnabled = 0
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
		ELSE IF @enabled = 0 AND @CurrentEnabled = 1
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END

        --firstly update the records that do exist
        UPDATE ea
        SET
            ea.[Enabled] = @enabled,
            ea.[ExpiryDate] = @expirydate
        FROM
            [dbo].[SurveyType] st
            INNER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId]
        WHERE 
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            [ea].[EmployeeID] = @employeeId AND
			ea.PropertyTypeID IS NULL

        --secondly, insert the new EmployeeAuthorisation that do not exist for the client
        INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate])
        SELECT
            @employeeId,
            st.surveytypeid,
            @enabled,
            @expirydate
        FROM
            [dbo].[SurveyType] st
            LEFT OUTER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId] AND [ea].[EmployeeID] = @employeeId
        WHERE
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            ea.[EmployeeAuthorisationID] IS NULL
    END
    ELSE IF @surveytypeGroupId IS NOT NULL AND @propertytypeId IS NOT NULL
    BEGIN
		-- insert an audit
		DECLARE @PropertyTypeString VARCHAR(MAX) = (SELECT PropertyType FROM PropertyType WHERE PropertyTypeID = @propertytypeId)
		SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM SurveyType st INNER JOIN EmployeeAuthorisation ea WITH (NOLOCK) ON st.SurveyTypeID = ea.SurveyTypeID WHERE SurveyTypeGroupID = @surveytypeGroupId AND ea.EmployeeID = @employeeId AND ea.PropertyTypeID = @propertytypeId)

		IF @enabled = 1 AND @CurrentEnabled = 0
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', PropertyType: ' + @PropertyTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
		ELSE IF @enabled = 0 AND @CurrentEnabled = 1
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', PropertyType: ' + @PropertyTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
        --firstly update the records that do exist
        UPDATE ea
            SET 
                ea.[Enabled] = @enabled,
                ea.[ExpiryDate] = @expirydate
        FROM 
            [dbo].[SurveyType] st
            INNER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId]
        WHERE 
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            [ea].[EmployeeID] = @employeeId AND 
            [ea].[PropertyTypeID] = @propertytypeId

        IF not EXISTS(SELECT 'x' FROM [dbo].[SurveyType] st INNER JOIN EmployeeAuthorisation ea ON [ea].[SurveyTypeId] = [st].[SurveyTypeID] 
                        WHERE [EmployeeID] = @employeeId AND st.[SurveyTypeGroupID] = @surveytypeGroupId AND [PropertyTypeID] = @propertytypeId) AND @enabled = 1 AND @propertytypeId IS not null
        BEGIN             
            INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate], [PropertyTypeID])
            SELECT
                @employeeId,
                st.surveytypeid,
                @enabled,
                @expirydate,
                @propertytypeId
             FROM 
                [dbo].[SurveyType] st
            WHERE
                [SurveyTypeGroupID] = @surveytypeGroupId 
                --AND [ea].[Enabled] = 1
                --AND
                --ea.[EmployeeAuthorisationID] IS NULL        
        END 
    END 
    ELSE IF @surveytypeid IS NOT NULL
    BEGIN
        IF EXISTS(SELECT 'x' FROM EmployeeAuthorisation WHERE [EmployeeID] = @employeeId AND surveytypeid = @surveytypeid) 
        BEGIN
            UPDATE EmployeeAuthorisation SET [Enabled] = @enabled, [ExpiryDate] = @expirydate WHERE [EmployeeID] = @employeeId AND surveytypeid = @surveytypeid            
        END
        ELSE
        BEGIN
            INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate])
            SELECT
                @employeeId,
                @surveytypeid,
                @enabled,
                @expirydate
        END
    END 
    ELSE IF @airtesttypeid IS NOT NULL
    BEGIN
        IF @AirtestAuthorisationTypeID IS NOT NULL
        BEGIN
            -- Run an UPDATE if a record exists for this employee.
            IF EXISTS (SELECT 1 FROM EmployeeAuthorisation ea WHERE ea.EmployeeID = @employeeId AND ea.AirtestTypeId = @airtesttypeid AND ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID)
            BEGIN
                UPDATE ea
                SET
                    ea.Enabled = @enabled,
                    ea.ExpiryDate = @expirydate
                FROM
                    EmployeeAuthorisation ea
                WHERE
                    ea.EmployeeID = @employeeId
                        AND
                    ea.AirtestTypeId = @airtesttypeid
                        AND
                    ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID
            END
            ELSE
            BEGIN
                INSERT INTO EmployeeAuthorisation (EmployeeID, AirtestTypeID, Enabled, ExpiryDate, AirtestAuthorisationTypeID)
                SELECT
                    @employeeId,
                    @airtesttypeid,
                    @enabled,
                    @expirydate,
                    @AirtestAuthorisationTypeID
            END
        END
        ELSE
        BEGIN
            -- Run an UPDATE if a record exists for this employee.
            IF EXISTS (SELECT 1 FROM EmployeeAuthorisation ea WHERE ea.EmployeeID = @employeeId AND ea.AirtestTypeId = @airtesttypeid)
            BEGIN
                UPDATE ea
                SET
                    ea.Enabled = @enabled,
                    ea.ExpiryDate = @expirydate
                FROM 
                    EmployeeAuthorisation ea
                WHERE
                    ea.EmployeeID = @employeeId
                        AND
                    ea.AirtestTypeId = @airtesttypeid
            END
            ELSE
            BEGIN
                INSERT INTO EmployeeAuthorisation (EmployeeID, AirtestTypeID, Enabled, ExpiryDate)
                SELECT
                    @employeeId,
                    @airtesttypeid,
                    @enabled,
                    @expirydate
            END
        END
    END
    ELSE IF @SampleAnalysis = 1
    BEGIN
        IF EXISTS(SELECT 1 FROM EmployeeAuthorisation WITH (NOLOCK) WHERE EmployeeID = @employeeId AND SampleAnalysis = 1)
        BEGIN
            UPDATE EmployeeAuthorisation
            SET
                Enabled = @enabled,
                ExpiryDate = @expirydate
            WHERE
                EmployeeID = @employeeId
                    AND
                SampleAnalysis = 1
        END
        ELSE
        BEGIN
            INSERT INTO EmployeeAuthorisation (EmployeeID, Enabled, ExpiryDate, SampleAnalysis)
            SELECT
                @employeeId,
                @enabled,
                @expirydate,
                1
        END
    END


    SET NOCOUNT OFF;
END
GO


ALTER FUNCTION [dbo].[EmployeeAuthorised] (@EmployeeID INT, @SurveyTypeID INT = NULL, @AirtestTypeID INT = NULL, @SurveyTypeGroupID INT = NULL, @PropertyTypeID INT = NULL, @AirtestAuthorisationTypeID INT = NULL, @SampleClassificationIDsAvailable VARCHAR(MAX) = NULL, @SampleClassificationID INT = NULL)
RETURNS BIT
WITH EXECUTE AS CALLER
AS
BEGIN


    DECLARE @Rez BIT
    DECLARE @bitVal BIT
    DECLARE @expired BIT

    -- If we are checking for an individual SampleClassificationID against all SampleClassificationIDs available for an AirTestType, then get the IDs here.
    DECLARE @SampleClassificationsForAirTestType TABLE (SampleClassificationID INT PRIMARY KEY)
    IF @AirtestTypeID > 0 AND @SampleClassificationIDsAvailable IS NOT NULL AND @SampleClassificationID > 0
    BEGIN
        INSERT INTO @SampleClassificationsForAirTestType (SampleClassificationID)
        SELECT RTRIM(LTRIM(s)) [SampleClassificationID] FROM dbo.SplitString(@SampleClassificationIDsAvailable, ',')
    END


    IF
        ISNULL((SELECT
            CASE WHEN @SurveyTypeID IS NOT NULL THEN 1 ELSE 0 END +
            CASE WHEN @AirtestTypeID IS NOT NULL THEN 1 ELSE 0 END +
            CASE WHEN @SurveyTypeGroupID IS NOT NULL THEN 1 ELSE 0 END
        ), 0) = 1 -- Only one must be selected.
    BEGIN
        --only one of the params is supplied
        IF EXISTS(SELECT 1 FROM [dbo].[Employee] WITH (NOLOCK) WHERE [EmployeeID] = @EmployeeID AND [Deleted] IS NULL)
        BEGIN
            --employee exists
            IF NOT @SurveyTypeGroupID IS NULL AND @PropertyTypeID IS null
            BEGIN
                --a group was passed, lets just check to see if any of the groups children are set to enabled.
                SELECT TOP 1
                    @bitVal = ISNULL(tea.enabled,1),
                    @expired = tea.expired
                FROM
                    [dbo].[Employee] emp WITH (NOLOCK)
                    OUTER apply(
                        SELECT
                            [ea].[Enabled],
                            (
                                        CASE WHEN NOT ea.expirydate IS NULL THEN
                                            CASE WHEN (GETDATE() < ea.expirydate) THEN 0 ELSE 1 END
                                        ELSE
                                            0
                                        END
                            )
                        FROM
                            [dbo].[EmployeeAuthorisation] ea WITH (NOLOCK)
                            LEFT OUTER JOIN [dbo].[SurveyType] st WITH (NOLOCK) ON ea.[SurveyTypeId] = [st].[SurveyTypeID]
                        WHERE
                            [st].[SurveyTypeGroupID] = @SurveyTypeGroupID
                            AND ea.EmployeeID = [emp].[EmployeeID]
                            --AND [ea].[PropertyTypeID] IS null  -- Removed STODD 20/10/2015 as bugging up management Edit Employee page
                    )tea(enabled,expired)
                WHERE
                    emp.employeeid =@EmployeeID
                ORDER BY [TEA].[Enabled] DESC

                --default false if no employeeauthorisation record found
                select @Rez = CASE WHEN @bitVal IS NULL THEN
                    0
                ELSE
                    --expiry overrides enabled flag
                    CASE WHEN @expired = 1 THEN
                        0
                    ELSE
                        --enabled flag
                        @bitVal
                    END
                END
            END
            ELSE IF NOT @SurveyTypeGroupID IS NULL AND not @PropertyTypeID IS null
            BEGIN
                    --a group was passed, lets just check to see if any of the groups children are set to enabled.
                    SELECT TOP 1
                        @bitVal = ISNULL(tea.enabled,0),
                        @expired = tea.expired
                    FROM
                        [dbo].[Employee] emp WITH (NOLOCK)
                        OUTER apply(
                            SELECT
                                [ea].[Enabled],
                                (
                                            CASE WHEN NOT ea.expirydate IS NULL THEN
                                                CASE WHEN (GETDATE() < ea.expirydate) THEN 0 ELSE 1 END
                                            ELSE
                                                0
                                            END
                                )
                            FROM
                                [dbo].[EmployeeAuthorisation] ea WITH (NOLOCK)
                                LEFT OUTER JOIN [dbo].[SurveyType] st WITH (NOLOCK) ON (ea.[SurveyTypeId] = [st].[SurveyTypeID])
                            WHERE
                                [st].[SurveyTypeGroupID] = @SurveyTypeGroupID
                                AND ea.EmployeeID = [emp].[EmployeeID]
                                AND [ea].[PropertyTypeID] = @PropertyTypeID
                        )tea(enabled,expired)
                    WHERE
                        emp.employeeid =@EmployeeID
                    ORDER BY [TEA].[Enabled] DESC

                    --default false if no employeeauthorisation record found
                    select @Rez = CASE WHEN @bitVal IS NULL THEN
                        0
                    ELSE
                        --expiry overrides enabled flag
                        CASE WHEN @expired = 1 THEN
                            0
                        ELSE
                            --enabled flag
                            @bitVal
                        END
                    END
            END
            ELSE IF not @SurveyTypeID IS NULL AND @PropertyTypeID IS null
            BEGIN
                --survey type overrides airtest type
                --pull out whether it is enabled and whether it has expired
                SELECT
                    @bitVal = ISNULL([ea].[Enabled],1),
                    @expired = (
                                CASE WHEN NOT ea.expirydate IS NULL THEN 
                                    CASE WHEN (GETDATE() < ea.expirydate) THEN 0 ELSE 1 END  
                                ELSE 
                                    0
                                END 
                               )
                FROM
                    [dbo].[Employee] emp WITH (NOLOCK)
                    LEFT OUTER JOIN [dbo].[EmployeeAuthorisation] ea WITH (NOLOCK) ON [emp].[EmployeeID] =ea.EmployeeID  AND [ea].[SurveyTypeId] = @SurveyTypeID
                WHERE
                    emp.employeeid = @EmployeeID
                    AND [ea].[PropertyTypeID] IS null

                --default false if no employeeauthorisation record found
                select @Rez = CASE WHEN @bitVal IS NULL THEN
                    0
                ELSE
                    --expiry overrides enabled flag
                    CASE WHEN @expired = 1 THEN
                        0
                    ELSE
                        --enabled flag
                        @bitVal
                    END
                END
            END
            ELSE IF not @SurveyTypeID IS NULL AND not @PropertyTypeID IS null
            BEGIN
                --propertytype passed in as well as surveytype
                SELECT
                    @bitVal = ISNULL([ea].[Enabled],1),
                    @expired = (
                                CASE WHEN NOT ea.expirydate IS NULL THEN
                                    CASE WHEN (GETDATE() < ea.expirydate) THEN 0 ELSE 1 END
                                ELSE
                                    0
                                END
                               )
                FROM
                    [dbo].[Employee] emp WITH (NOLOCK)
                    LEFT OUTER JOIN [dbo].[EmployeeAuthorisation] ea WITH (NOLOCK) ON [emp].[EmployeeID] =ea.EmployeeID  AND [ea].[SurveyTypeId] = @SurveyTypeID
                WHERE
                    emp.employeeid = @EmployeeID
                    AND [ea].[PropertyTypeID] = @PropertyTypeID

                --default false if no employeeauthorisation record found
                select @Rez = CASE WHEN @bitVal IS NULL THEN
                    0
                ELSE
                    --expiry overrides enabled flag
                    CASE WHEN @expired = 1 THEN
                        0
                    ELSE
                        --enabled flag
                        @bitVal
                    END
                END
            END
            ELSE IF @AirtestTypeID IS NOT NULL
            BEGIN
                -- Pull out whether the AirtestTypeID is enabled and whether it has expired.
                -- Default to true if the record doesn't exist, otherwise use the Enabled flag.
                SELECT
                    @bitVal = ISNULL(ea.Enabled, 1),
                    @expired = (
                                CASE WHEN ea.ExpiryDate IS NOT NULL THEN
                                    CASE WHEN (GETDATE() < ea.ExpiryDate) THEN 0 ELSE 1 END
                                ELSE
                                    0
                                END)
                FROM
                    Employee e WITH (NOLOCK)
                    LEFT jOIN EmployeeAuthorisation ea WITH (NOLOCK) ON e.EmployeeID = ea.EmployeeID AND ea.AirTestTypeID = @AirtestTypeID
                WHERE
                    e.EmployeeID = @EmployeeID
                        AND
                    (
                        (@AirtestAuthorisationTypeID IS NULL AND ea.AirtestAuthorisationTypeID IS NULL)
                            OR
                        (@AirtestAuthorisationTypeID IS NOT NULL AND ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID)
                    )

                SELECT @Rez =
                    CASE
                        WHEN @bitVal IS NULL THEN 0
                        WHEN @expired = 1 THEN 0
                        ELSE @bitVal
                    END

                -- If the main part is authorised, check to see if we are authorised for this particular Classification.
                IF @Rez = 1 AND @SampleClassificationIDsAvailable IS NOT NULL AND @SampleClassificationID > 0
                BEGIN
                    SELECT @Rez =
                        CASE WHEN EXISTS(SELECT 1 FROM @SampleClassificationsForAirTestType WHERE SampleClassificationID = @SampleClassificationID)
                            THEN 1
                            ELSE 0
                        END
                END
            END
            ELSE
            BEGIN
                --not type passed -- false
                SET @rez = 0
            END
        END
        ELSE
        BEGIN
            --employee does not exist
            SET @rez = 0
        END
    END
    ELSE
    BEGIN
        --surveytypeid and airtesttypeid and @SurveyTypeGroupID have a value, this is invalid return false
        set @Rez = 0
    END

    RETURN @rez

END
GO
ALTER PROCEDURE [dbo].[employeeAuthReport]
    @employees varchar(max)
AS
BEGIN

SELECT @employees = ISNULL(@employees,'')

SELECT 
    [a].[FullName],
    [a].[Description],
    [a].[Enabled],
    [a].[ExpiryDate]
FROM
(
    SELECT 
        [emp].[EmployeeID]  'EmployeeId',
        [emp].[Deleted]     'deleted',
        1                   'type',
        [emp].[FullName]    'FullName',
        [Description]       'Description',
        st.[SurveyTypeID]   'SurveyTypeId',
        NULL                'AirTestTypeId', 
        dbo.EmployeeAuthorised([emp].[EmployeeID],st.[SurveyTypeID],NULL,NULL,[ea].[PropertyTypeID], NULL, NULL, NULL) 'Enabled',
        ea.[ExpiryDate]     'ExpiryDate'
    FROM 
        [dbo].[SurveyType] st
        CROSS JOIN employee emp
        LEFT OUTER JOIN [dbo].[EmployeeAuthorisation] ea ON ea.[SurveyTypeId] = st.[SurveyTypeID] AND ea.[EmployeeID] = [emp].[EmployeeID]
    WHERE
        st.deleted is NULL
    UNION ALL
    SELECT 
        [emp].[EmployeeID]  'EmployeeId',
        [emp].[Deleted]     'deleted',
        2                   'type',
        [emp].[FullName]    'FullName',
        [Description]       'Description',
        NULL                'SurveyTypeId',
        at.[AirTestTypeID]  'AirTestTypeId',
        dbo.EmployeeAuthorised([emp].[EmployeeID],NULL,at.[AirTestTypeID],null,null, NULL, NULL, NULL) 'Enabled',
        ea.[ExpiryDate]     'ExpiryDate'
    FROM 
        AirTestType at 
        CROSS JOIN employee emp
        LEFT OUTER JOIN [dbo].[EmployeeAuthorisation] ea ON ea.[AirTestTypeID] = at.[AirTestTypeID] AND ea.[EmployeeID] = [emp].[EmployeeID]
    WHERE
        at.deleted is NULL
)AS a 
LEFT OUTER JOIN dbo.splitstring(@employees,',') e ON a.[EmployeeId] = [e].[s]
WHERE 
    --[a].[deleted] IS NULL AND
    (
        (@employees ='' AND [e].[zeroBasedOccurance] is null) OR
        (@employees !='' AND NOT [e].[zeroBasedOccurance] is null)
    )
ORDER BY 
    [a].[EmployeeID],
    [a].[type]

END
GO
ALTER PROCEDURE [dbo].[Paged_NotYetScheduled]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @QuoteID INT = 0,
	@QuoteTypeID INT = 0,
    @Site VARCHAR(MAX) = NULL,
    @OrderByAccepted INT = 0,
    @OrderByQuoteNo INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByNotes INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Scheduled tab. Replaces the NotYetScheduled view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Site = NULLIF(LTRIM(RTRIM(@Site)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByAccepted = 0 AND @OrderByQuoteNo = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByNotes = 0
    BEGIN
        SET @OrderByAccepted = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByAccepted [OrderByAccepted],
        @OrderByQuoteNo [OrderByQuoteNo],
        @OrderByClient [OrderByClient],
        @OrderBySite [OrderBySite],
        @OrderByNotes [OrderByNotes]
    */
    
    -- Get all the Not Yet Scheduled data - just the minimum ammount of data for speed.
    DECLARE @NotYetScheduledData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, Notes VARCHAR(MAX), Accepted DATETIME, ClientID INT, Client VARCHAR(210), ProjectID INT, SiteID INT, Site VARCHAR(220), RemovalID INT, IsBackFromMobileTeams BIT, IsRemovalQuoteVisit BIT, IsRemovalWorkVisit BIT)
    
    INSERT INTO @NotYetScheduledData
    SELECT
        q.QuoteID,
        q.QuoteNo,
        q.Notes,
        q.Accepted,
        q.ClientID,
        q.Client,
        q.ProjectID,
        q.SiteID,
        q.Site,
        q.RemovalID,
        q.IsBackFromMobileTeams,
        q.IsRemovalQuoteVisit,
        q.IsRemovalWorkVisit
    FROM
        (
            SELECT
                q.QuoteID,
                q.QuoteNo,
                ISNULL(NULLIF(q.Status, ''), q.DetailsOfWork) [Notes],
                q.Accepted,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                q.ProjectID,
                si.SiteID,
                si.Address + ISNULL(', ' + NULLIF(si.Postcode, ''), '') [Site],
                rem.RemovalID, -- Also get the Removal columns, so we don't have to hit the View twice.
                rem.IsBackFromMobileTeams,
                rem.IsRemovalQuoteVisit,
                rem.IsRemovalWorkVisit
            FROM
                Quote q WITH (NOLOCK)
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID -- Remove to include Sample quotes.
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Removals rem WITH (NOLOCK) ON q.QuoteID = rem.QuoteID
            WHERE
                q.Rejected IS NULL -- Not rejected.
                    AND
                q.Accepted IS NOT NULL -- Has been accepted.
                    AND
                (
                    ( -- Logic for most quotes.
                        (
                            qt.QuoteType != 'Removals (Notifiable)'
                                AND
                            qt.QuoteType != 'Removals (Non-Notifiable)'
                        )
                            AND
                        NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE QuoteID = q.QuoteID AND AppointmentTypeID != 8)
                            AND
                        NOT EXISTS (SELECT 1 FROM Job WITH (NOLOCK) WHERE JobID = q.JobID)
                            AND
                        NOT EXISTS (SELECT 1 FROM ProjectAppointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            AND
                        (
                            q.SiteID IS NOT NULL
                                OR
                            (
                                q.SiteID IS NULL
                                    AND
                                NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            )
                        )
                    )
                        OR
                    ( -- Logic for Removal quotes.
                        (
                            qt.QuoteType = 'Removals (Notifiable)'
                                OR
                            qt.QuoteType = 'Removals (Non-Notifiable)'
                        )
                            AND
                        ISNULL(rem.isBackFromMobileTeams, 0) = 1
                            AND
                        ISNULL(rem.isRemovalQuoteVisit, 0) = 1
                            AND
                        -- Make sure neither the Quote visit or Site visit for the Quote has no Appointment.
                        NOT EXISTS (SELECT 1 FROM Removals WITH (NOLOCK) WHERE RemovalID = rem.RemovalID AND AppointmentID IS NOT NULL AND ISNULL(isRemovalWorkVisit, 0) = 1 AND ISNULL(isBackFromMobileTeams, 0) = 1)
                    )
                )
                    AND
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR q.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                q.Accepted BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@QuoteID = 0 OR q.QuoteID = @QuoteID)
					AND
				(@QuoteTypeID = 0 OR q.QuoteTypeID = @QuoteTypeID)
        ) q
    WHERE
        (@Site IS NULL OR q.Site LIKE '%' + @Site + '%')
    ORDER BY
        CASE WHEN @OrderByAccepted = 1 THEN q.Accepted ELSE NULL END ASC,
        CASE WHEN @OrderByAccepted = 2 THEN q.Accepted ELSE NULL END DESC,
        CASE WHEN @OrderByQuoteNo = 1 THEN q.QuoteNo ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteNo = 2 THEN q.QuoteNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN q.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN q.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN q.Site ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN q.Site ELSE NULL END DESC,
        CASE WHEN @OrderByNotes = 1 THEN q.Notes ELSE NULL END ASC,
        CASE WHEN @OrderByNotes = 2 THEN q.Notes ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetScheduledData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((a.IndexID - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetScheduledData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.IndexID [Row_Num],
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        pag.Notes,
        q.Created,
        CAST(CASE WHEN q.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Accepted,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        qt.QuoteTypeID,
        qt.QuoteType,
        pag.ClientID,
        pag.Client,
        p.ProjectID,
        p.ProjectGroupID,
        NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
        pag.SiteID,
        si.Address,
        si.Postcode,
        pag.Site,
        si.UPRN,
        pag.RemovalID,
        pag.IsBackFromMobileTeams,
        pag.IsRemovalQuoteVisit,
        pag.IsRemovalWorkVisit,
		q.Value
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN Project p WITH (NOLOCK) ON pag.ProjectID = p.ProjectID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
    WHERE
        (pag.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.IndexID
    
    
    SET NOCOUNT OFF;
END


GO

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Site UPRN2') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.ImportData
      ADD [Site UPRN2] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Site UPRN3') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.ImportData
      ADD [Site UPRN3] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Building Description') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.ImportData
      ADD [Building Description] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Construction Type') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.ImportData
      ADD [Construction Type] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Age of Building') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.ImportData
      ADD [Age of Building] [VARCHAR] (MAX) NULL
END


IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Site') AND name='UPRN2') < 1
BEGIN
  ALTER TABLE Site
      ADD [UPRN2] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Site') AND name='UPRN3') < 1
BEGIN
  ALTER TABLE Site
      ADD [UPRN3] [VARCHAR] (MAX) NULL
END

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetText]    Script Date: 02/20/2017 21:40:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





ALTER PROC [dbo].[FloorplanRerender_GetText]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = 
      (
			SELECT 
				j.JobID 
			FROM 
				Job j WITH (NOLOCK)
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
			WHERE 
				fp.FloorplanID=@FloorplanID
      )
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            COALESCE(sr.Value,e8.ElementIntID,-1),
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            e48.ElementIntMeaningID
      FROM
            Floorplan f
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            f.FloorplanID=@FloorplanID
            
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            0
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=r.JobEmployeeID
            INNER JOIN Job j WITH (NOLOCK) ON j.JobID=je.JobID
      WHERE
			j.JobID=@JobID
      
      Update @SampleData
            Set 
                  SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)

      Select 
            fi.FloorplanItemID,fi.FloorplanID,fi.FloorplanAdditionalID,fi.SampleID,fi.AirSampleID,fi.RoomID,fi.Autosize,fi.BackColor,fi.BorderStyle,fi.Font,fi.ForeColor,fi.IconImage,fi.Location,fi.MaximumSize,fi.MinimumSize,fi.Padding,fi.Size,fi.Text,fi.TextAlign,fi.ZOrder,fi.Locked,fi.IsSampleRef,fi.IsRegisterItemNo,
            CASE WHEN sd.ReinspectionElementIntMeaningID = 121 THEN
                        'Removed'
            ELSE
                        CASE WHEN sd.Inaccessible > 0 THEN
                                          'Inaccessible'
                                Else
                                          CASE sd.SampleResultValue 
                                          WHEN -1 THEN 'Reference Only'
                                          WHEN 0 THEN 'Negative Asbestos'
                                          Else
                                                  CASE WHEN sd.SampleResultValue > 0 THEN
                                                            'Asbestos'
                                                  END
                        End
            END
            END [TextType]
      FROM
            FloorplanItem fi
            LEFT OUTER JOIN @SampleData sd ON sd.SampleID=fi.SampleID
      Where 
            fi.FloorplanID = @FloorplanID 
                  AND 
            fi.IconImage IS NULL 
                  AND 
            fi.IsRoomOverlay=0 
                  AND 
            fi.IsGraphic=0 
            	  AND
			fi.IsSampleOverlay=0
      Order by 
            fi.ZOrder desc
      
End


GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetSampleOverlay]    Script Date: 02/20/2017 21:33:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FloorplanRerender_GetSampleOverlay]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = 
      (
			SELECT 
				j.JobID 
			FROM 
				Job j WITH (NOLOCK)
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
			WHERE 
				fp.FloorplanID=@FloorplanID
      )
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            COALESCE(sr.Value,e8.ElementIntID,-1),
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            e48.ElementIntMeaningID
      FROM
            Floorplan f
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            f.FloorplanID=@FloorplanID
            
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            0
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
            INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=r.JobEmployeeID
            INNER JOIN Job j WITH (NOLOCK) ON j.JobID=je.JobID
      WHERE
			j.JobID=@JobID
      
      Update @SampleData
            Set 
                  SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)

      Select 
            fi.FloorplanItemID,fi.FloorplanID,fi.FloorplanAdditionalID,fi.SampleID,fi.AirSampleID,fi.RoomID,fi.Autosize,fi.BackColor,fi.BorderStyle,fi.Font,fi.ForeColor,fi.IconImage,fi.Location,fi.MaximumSize,fi.MinimumSize,fi.Padding,fi.Size,fi.Text,fi.TextAlign,fi.ZOrder,fi.Locked,fi.IsSampleRef,fi.IsRegisterItemNo,fi.PolygonPath,
            CASE WHEN sd.ReinspectionElementIntMeaningID = 121 THEN
                        'Removed'
            ELSE
                        CASE WHEN sd.Inaccessible > 0 THEN
                                          'Inaccessible'
                                Else
                                          CASE sd.SampleResultValue 
                                          WHEN -1 THEN 'Reference Only'
                                          WHEN 0 THEN 'Negative Asbestos'
                                          Else
                                                  CASE WHEN sd.SampleResultValue > 0 THEN
                                                            'Asbestos'
                                                  END
                        End
            END
            END [OverlayType]
      FROM
            FloorplanItem fi
            LEFT OUTER JOIN @SampleData sd ON sd.SampleID=fi.SampleID
      Where 
            fi.FloorplanID = @FloorplanID 
                  AND 
            fi.IconImage IS NULL 
                  AND 
            fi.IsRoomOverlay=0 
                  AND 
            fi.IsGraphic=0 
				AND
			fi.IsSampleOverlay=1
      Order by 
            fi.ZOrder desc
      
End
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'DueDate' AND object_id = object_id('LegionellaTask'))
BEGIN
    ALTER TABLE LegionellaTask
    ADD DueDate DATETIME
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'EnableMvcGrid' AND object_id = object_id('TeamsV2SubTab'))
BEGIN
    ALTER TABLE TeamsV2SubTab
	ADD EnableMvcGrid BIT NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'UsesMvcSubSubTabs' AND object_id = object_id('TeamsV2SubTab'))
BEGIN
    ALTER TABLE TeamsV2SubTab
	ADD UsesMvcSubSubTabs BIT NULL;
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Mobile Unit Summary') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Mobile Unit Summary', 1, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Keyboard Standard Phrases') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Keyboard Standard Phrases', 2, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Question Banks') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Question Banks', 3, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Sample Information') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Sample Information', 4, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Sample Classifications') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Sample Classifications', 5, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Data Matching') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Data Matching', 6, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Symbols') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Symbols', 7, NULL, NULL, 0, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Legionella Question Editor') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Legionella Question Editor', 8, NULL, 1, 1, NULL)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Job Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Job Tools', 1, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Report Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Report Tools', 2, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Invoice Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Invoice Tools', 3, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Quote Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Quote Tools', 4, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Audit Trail') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Audit Trail', 5, NULL, null, 0, NULL, 0)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Sample Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Sample Tools', 6, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Staff Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Staff Tools', 7, NULL, null, 0, NULL, 1)
END

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Appointment Tools') = 0
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden, EnableMvcGrid, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Appointment Tools', 8, NULL, null, 0, NULL, 1)
END

GO
/*
    ClientInvoiceDetail table and other table/SPROC modifications for this.
*/
IF NOT EXISTS(SELECT * FROM sys.objects WHERE name = 'ClientInvoiceDetail' AND RTRIM(type) = 'U')
BEGIN
    CREATE TABLE [dbo].[ClientInvoiceDetail](
	    [ClientInvoiceDetailID] [int] IDENTITY(1,1) NOT NULL,
	    [ClientID] [int] NOT NULL,
	    [InvoiceAddress] [varchar](200) NOT NULL,
	    [InvoicePostcode] [varchar](10) NOT NULL,
	    [Deleted] [datetime] NULL,
     CONSTRAINT [PK_ClientInvoiceDetail] PRIMARY KEY CLUSTERED 
    (
	    [ClientInvoiceDetailID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]

    ALTER TABLE Invoice
    ADD ClientInvoiceDetailID INT NULL
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Deleted' AND object_id = OBJECT_ID('ClientInvoiceDetail'))
BEGIN
    ALTER TABLE ClientInvoiceDetail
    ADD [Deleted] [datetime] NULL
END
GO
IF EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ClientInvoiceDetail]') AND name = N'Idx_ClientInvoiceDetail_ClientID')
BEGIN
    DROP INDEX [Idx_ClientInvoiceDetail_ClientID] ON [dbo].[ClientInvoiceDetail] WITH ( ONLINE = OFF )
END
GO
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ClientInvoiceDetail]') AND name = N'Idx_ClientInvoiceDetail_ClientIDDeleted')
BEGIN
    CREATE NONCLUSTERED INDEX [Idx_ClientInvoiceDetail_ClientIDDeleted] ON [dbo].[ClientInvoiceDetail] 
    (
	    [ClientID] ASC,
	    [Deleted] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
GO
-- =============================================
-- Author:      Stephen Pilton
-- Create date: 23/07/2014
-- Description: Get Invoice Header/Footer SQL
-- =============================================
ALTER PROCEDURE [dbo].[GetInvoiceHeaderFooterSQL]
    @InvoiceID INT,
    @ItemSQLTable VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;


    -- Get the Item data in a temporary table.
    -- All the fields are the same for the three tables, except for the 'InvoiceItemID' being different (although aliased the same) and Credit Notes have an 'InvoiceItemID' referring to the original Invoice (this has been aliased 'OriginalInvoiceItemID' in this temp table).
    DECLARE @ItemTable TABLE (InvoiceItemID INT, OriginalInvoiceItemID INT, SiteID INT, QuoteTypeID INT, JobNo VARCHAR(10), Description VARCHAR(MAX), ClientOrderNo VARCHAR(50), Cost MONEY, ItemDate DATETIME, TypeDescription VARCHAR(200), SortOrder INT, SageNominalCode VARCHAR(8), SageDepartment INT, VATRate DECIMAL(12, 3))

    IF @ItemSQLTable = 'ProFormaItem'
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.ProFormaItemID,
                NULL,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                ProFormaItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END
    ELSE IF @ItemSQLTable = 'CreditItem'
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.CreditItemID,
                ii.InvoiceItemID,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                CreditItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END
    ELSE
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.InvoiceItemID,
                NULL,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                InvoiceItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END


    -- Set variables used in SQL below. VAT Rate, Discount Total, Currency and Tax.
    DECLARE @InvoiceVATRate DECIMAL (12, 3) = (SELECT VATRate FROM Invoice WITH (NOLOCK) WHERE InvoiceID = @InvoiceID)
    DECLARE @InvoiceDiscountTotal MONEY = ISNULL(dbo.InvoiceDiscountTotal(@InvoiceID), 0)
    DECLARE @InvoiceDiscountPerItem MONEY = ISNULL(CASE WHEN (SELECT COUNT(*) FROM @ItemTable) > 0 AND @InvoiceDiscountTotal > 0 THEN @InvoiceDiscountTotal / (SELECT COUNT(*) FROM @ItemTable) END, 0)

    DECLARE @Currency VARCHAR(20) = (SELECT ISNULL(NULLIF(s__Currency, ''), '�') FROM Config)
    SET @Currency =
        CASE @Currency
            WHEN '$' THEN '&#36;'
            WHEN '�' THEN '&euro;'
            ELSE '&pound;'
        END

    DECLARE @TaxName VARCHAR(100) = (SELECT ISNULL(NULLIF(s__TaxName, ''), 'VAT') FROM Config)

    -- Now get all calculations for each item.
    DECLARE @ItemTableCalculations TABLE (InvoiceItemID INT, Cost MONEY, CostWithDiscount MONEY, VATRate DECIMAL(12, 3), VATTotal MONEY, ItemTotal MONEY)

    INSERT INTO @ItemTableCalculations (InvoiceItemID, Cost, CostWithDiscount, VATRate, VATTotal, ItemTotal)
    SELECT
        ii.InvoiceItemID,
        ii.Cost,
        cwd.CostWithDiscount,
        ii.VATRate,
        CAST(ISNULL((cwd.CostWithDiscount * ISNULL(ii.VATRate, @InvoiceVATRate)) - cwd.CostWithDiscount, 0) AS MONEY) [VATTotal],
        CAST(cwd.CostWithDiscount + ISNULL((cwd.CostWithDiscount * ISNULL(ii.VATRate, @InvoiceVATRate)) - cwd.CostWithDiscount, 0) AS MONEY) [ItemTotal]
    FROM
        @ItemTable ii
        OUTER APPLY
        (
            SELECT
                ii.Cost - @InvoiceDiscountPerItem [CostWithDiscount],
                -- Make sure the value has 2 decimal places.
                CASE WHEN CAST(ii.Cost - @InvoiceDiscountPerItem AS VARCHAR(MAX)) LIKE '%.___%'
                    THEN CAST(CAST(ROUND(ii.Cost - @InvoiceDiscountPerItem, 2) AS NUMERIC(10,2)) AS MONEY)
                    ELSE ii.Cost - @InvoiceDiscountPerItem
                END [CostWithDiscountRounded]
        ) cwd -- Cost with Discount


    -- Start the main SELECT.
    SELECT
        @Currency + CAST(SUM(ii.CostWithDiscount) AS VARCHAR(MAX)) [NetTotal],

        @Currency + CAST(i.Deposit AS VARCHAR(MAX)) [Deposit],

        CASE WHEN i.Deposit > 0
            THEN ''
            ELSE 'display: none;'
        END [HasDeposit],

        @Currency + CAST(@InvoiceDiscountTotal AS VARCHAR(MAX)) [Discount],

        CASE WHEN @InvoiceDiscountTotal > 0
            THEN ''
            ELSE 'display: none;'
        END [HasDiscount],

        @TaxName [TaxName],

        CAST((@InvoiceVATRate-1) * 100 AS FLOAT) [InvoiceVATRate],

        @Currency + CAST(CAST(SUM(ii.VATTotal) AS MONEY) AS VARCHAR(MAX)) [VATTotal],

        @Currency + CAST(CAST(SUM(ii.ItemTotal) - i.Deposit AS MONEY) AS VARCHAR(MAX)) [InvoiceTotal],

        i.Notes,

        ISNULL(i.InvoiceClientOrderNo, '&nbsp;') [InvoiceClientOrderNo]

    FROM
        @ItemTableCalculations ii
        INNER JOIN Invoice i WITH (NOLOCK) ON i.InvoiceID = @InvoiceID
    WHERE
        i.InvoiceID = @InvoiceID
    GROUP BY
        i.Deposit,
        i.VATRate,
        i.Notes,
        i.InvoiceClientOrderNo


    SET NOCOUNT OFF;
END
GO
-- =============================================
-- Author:      Stephen Pilton
-- Create date: 23/07/2014
-- Description: Get Invoice Row SQL
-- =============================================
ALTER PROCEDURE [dbo].[GetInvoiceRowSQL]
    @InvoiceID INT,
    @ItemSQLTable VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;


    -- Get the Item data in a temporary table.
    -- All the fields are the same for the three tables, except for the 'InvoiceItemID' being different (although aliased the same) and Credit Notes have an 'InvoiceItemID' referring to the original Invoice (this has been aliased 'OriginalInvoiceItemID' in this temp table).
    DECLARE @ItemTable TABLE (InvoiceItemID INT, OriginalInvoiceItemID INT, SiteID INT, QuoteTypeID INT, JobNo VARCHAR(10), Description VARCHAR(MAX), ClientOrderNo VARCHAR(50), Cost MONEY, ItemDate DATETIME, TypeDescription VARCHAR(200), SortOrder INT, SageNominalCode VARCHAR(8), SageDepartment INT, VATRate DECIMAL(12, 3))

    IF @ItemSQLTable = 'ProFormaItem'
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.ProFormaItemID,
                NULL,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                ProFormaItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END
    ELSE IF @ItemSQLTable = 'CreditItem'
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.CreditItemID,
                ii.InvoiceItemID,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                CreditItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END
    ELSE
        BEGIN
            INSERT INTO @ItemTable
            SELECT
                ii.InvoiceItemID,
                NULL,
                ii.SiteID,
                ii.QuoteTypeID,
                ii.JobNo,
                ii.Description,
                ii.ClientOrderNo,
                ii.Cost,
                ii.ItemDate,
                ii.TypeDescription,
                ii.sortOrder,
                ii.SageNominalCode,
                ii.SageDepartment,
                ii.VATRate
            FROM
                InvoiceItem ii WITH (NOLOCK)
            WHERE
                ii.DateRemoved IS NULL
                    AND
                ii.InvoiceID = @InvoiceID
        END

    -- Set Currency and Tax variable.
    DECLARE @Currency VARCHAR(20) = (SELECT ISNULL(NULLIF(s__Currency, ''), '�') FROM Config)
    SET @Currency =
        CASE @Currency
            WHEN '$' THEN '&#36;'
            WHEN '�' THEN '&euro;'
            ELSE '&pound;'
        END

    DECLARE @TaxName VARCHAR(100) = (SELECT ISNULL(NULLIF(s__TaxName, ''), 'VAT') FROM Config)


    -- Start the main SELECT.
    SELECT
        CONVERT(VARCHAR(11), ii.ItemDate, 106) [ItemDate],

        ii.ClientOrderNo [ClientOrderNumber],

        ii.JobNo [JobNumber],

        CASE WHEN LEN(ii.TypeDescription) > 0 AND qt.InvoiceQuoteType = 'General'
            THEN ii.TypeDescription
            ELSE qt.InvoiceQuoteType
        END +
        CASE WHEN LEN(si.Address) > 0
            THEN
                CASE WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis'
                    THEN ' from ' + si.Address
                    ELSE ' at ' + si.Address
                END
            ELSE ''
        END +
        CASE WHEN LEN(ii.Description) > 0
            THEN ' - ' + ii.Description
            ELSE ''
        END [ItemDetails],

        CASE WHEN LEN(ii.TypeDescription) > 0 AND qt.InvoiceQuoteType = 'General'
            THEN ii.TypeDescription
            ELSE qt.InvoiceQuoteType
        END +
        CASE WHEN LEN(si.Address) > 0
            THEN
                CASE WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis'
                    THEN ' from ' + si.Address + ', ' + si.Postcode
                    ELSE ' at ' + si.Address + ', ' + si.Postcode
                END
            ELSE ''
        END +
        CASE WHEN LEN(ii.Description) > 0
            THEN ' - ' + ii.Description
            ELSE ''
        END [ItemDetailsAltIncludePostcode],

        CASE WHEN LEN(ii.TypeDescription) > 0
            THEN ii.TypeDescription
            ELSE qt.InvoiceQuoteType
        END +
        CASE WHEN LEN(si.Address) > 0
            THEN
                CASE WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis'
                    THEN ' from ' + si.Address
                    ELSE ' at ' + si.Address
                END
            ELSE ''
        END +
        CASE WHEN LEN(ii.Description) > 0
            THEN ' - ' + ii.Description
            ELSE ''
        END [ItemDetailsAltDescOverride],

        @TaxName [TaxName],

        @Currency + CAST(ii.Cost AS VARCHAR(MAX)) [Cost],

        CAST((ISNULL(ii.VATRate, i.VATRate)-1) * 100 AS FLOAT) [VATRate],

        @Currency + CAST(ISNULL(CAST((ii.Cost * ISNULL(ii.VATRate, i.VATRate)) - ii.Cost AS MONEY), 0) AS VARCHAR(MAX)) [VATTotal],

        @Currency + CAST(CAST(ii.Cost + ISNULL((ii.Cost * ISNULL(ii.VATRate, i.VATRate)) - ii.Cost, 0) AS MONEY) AS VARCHAR(MAX)) [TotalCost]

    FROM
        @ItemTable ii
        INNER JOIN QuoteType qt WITH (NOLOCK) ON ii.QuoteTypeID = qt.QuoteTypeID
        INNER JOIN Invoice i WITH (NOLOCK) ON i.InvoiceID = @InvoiceID
        LEFT JOIN Site si WITH (NOLOCK) ON ii.SiteID = si.SiteID
    WHERE
        i.InvoiceID = @InvoiceID
    ORDER BY
        ii.sortOrder,
        ii.ItemDate


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_Training')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_Training] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GridDetail_Training]    Script Date: 07/03/2017 11:04:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_Training] 
      @JobID INT
AS
BEGIN
	SELECT 
		MIN(a.StartTime) 'WorkStarted', 
		MAX(a.EndTime) 'WorkFinished', 
		MAX(e.FullName) 'Employee', 
		(SELECT TOP 1 a.Notes FROM Appointment a WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID WHERE q.JobID = @JobID) 'Notes',
		c.SageAccountNumber
	FROM 
		Appointment a WITH (NOLOCK) 
		INNER JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID 
		INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
		INNER JOIN AppointmentEmployee ae WITH (NOLOCK) ON a.AppointmentID = ae.AppointmentID 
		INNER JOIN Employee e WITH (NOLOCK) ON ae.EmployeeID = e.EmployeeID 
	WHERE 
		q.JobID = @JobID
	GROUP BY
		c.SageAccountNumber
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_Survey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_Survey] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GridDetail_Survey]    Script Date: 07/03/2017 11:04:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_Survey] 
      @JobID INT
AS
BEGIN
SELECT 
		MIN(r.RegisterStart) 'WorkStarted', 
		MAX(r.RegisterFinish) 'WorkFinished', 
		e.FullName 'Employee', 
		(
			SELECT 
				TOP 1 a.Notes 
			FROM 
				Appointment a WITH (NOLOCK) 
				INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID 
			WHERE 
				q.JobID = @JobID
		) 'Notes',
		c.SageAccountNumber
	FROM 
		JobEmployee je WITH (NOLOCK) 
		INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
		INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
		INNER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID = je.EmployeeID 
		INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID 
	WHERE 
		je.JobID = @JobID 
	GROUP BY 
		e.FullName,
		c.SageAccountNumber
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_Samples')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_Samples] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GridDetail_Samples]    Script Date: 07/03/2017 11:04:02 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_Samples] 
      @JobID INT
AS
BEGIN
	SELECT 
		COUNT(s.[SampleRef]) as sampleCount,
		c.SageAccountNumber
	FROM 
		JobEmployee je WITH (NOLOCK) 
		INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
		INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
		INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID 
		INNER JOIN Room rm WITH (NOLOCK) ON [rm].[RegisterID] = [r].[RegisterID] 
		INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID 
	WHERE 
		[s].[AsSample] = 0 AND [s].[SampleRef] IS not NULL and [je].[Jobid] = @JobID
	GROUP BY
		c.SageAccountNumber
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_General')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_General] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GridDetail_General]    Script Date: 07/03/2017 11:03:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_General] 
      @JobID INT
AS
BEGIN
	SELECT 
		MIN(a.StartTime) 'WorkStarted', 
		MAX(a.EndTime) 'WorkFinished', 
		MAX(e.FullName) 'Employee', 
		(SELECT TOP 1 a.Notes FROM Appointment a WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID WHERE q.JobID = @JobID) 'Notes',
		c.SageAccountNumber
	FROM 
		Appointment a WITH (NOLOCK) 
		INNER JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID 
		INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
		INNER JOIN AppointmentEmployee ae WITH (NOLOCK) ON a.AppointmentID = ae.AppointmentID 
		INNER JOIN Employee e WITH (NOLOCK) ON ae.EmployeeID = e.EmployeeID 
	WHERE 
		q.JobID = @JobID
	GROUP BY
		c.SageAccountNumber
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_AirTest')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_AirTest] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GridDetail_AirTest]    Script Date: 07/03/2017 11:03:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_AirTest] 
      @JobID INT
AS
BEGIN
	SELECT 
		MIN(a.AirTestStart) 'WorkStarted', 
		MAX(a.AirTestFinish) 'WorkFinished', 
		e.FullName 'Employee', 
		(
			SELECT 
				TOP 1 a.Notes 
			FROM 
				Appointment a WITH (NOLOCK) 
				INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID 
			WHERE 
				q.JobID = @JobID
		) 'Notes', 
		SUBSTRING ((
			SELECT 
				',' + a.SystemName + RIGHT('0' + CONVERT(VARCHAR, a.AirTestNo), 2) + ' (' + att.[Description] + ')' 
			FROM 
				AirTest a WITH (NOLOCK) 
				INNER JOIN AirTestType att WITH (NOLOCK) ON a.AirTestTypeID = att.AirTestTypeID 
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID = a.JobEmployeeID 
			WHERE 
				je.JobID = @JobID 
			ORDER BY a.AirTestNo FOR XML PATH ('')
		), 2, 1000) 'AirTests',
		COUNT(airs.AirSampleId) as NumPumps,
		c.SageAccountNumber
	FROM 
		JobEmployee je WITH (NOLOCK) 
		INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
		INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
		INNER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID = je.EmployeeID 
		INNER JOIN AirTest a WITH (NOLOCK) ON a.JobEmployeeID = je.JobEmployeeID 
		LEFT JOIN AirSample airs ON airs.AirTestID = a.AirTestID AND airs.FieldBlank=0 
	WHERE 
		je.JobID = @JobID 
	GROUP BY 
		e.FullName,
		c.SageAccountNumber
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Diary_WeekViewData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Diary_WeekViewData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Diary_WeekViewData]    Script Date: 07/03/2017 12:00:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Diary_WeekViewData] 
	-- @BranchId INT = nNULL
AS
BEGIN

	;WITH cte_AppList 
	( 
		OffsetStart, Days, OffsetEnd, Duration, StartTime, EndTime, AppointmentID, AppointmentType, ClientID, Client, 
		ProjectID, Project, SiteID, Site, Address, Postcode, UPRN, JobID, JobNo, Cost, DateConfirmed, CalendarFileID, 
		EmployeeID, Employee, BranchOfficeId, AppCategoryDescription, HTML_Colour, AppointmentGroupId, ProjectAppointmentId, 
		MobileDataReturned, MobileDataReturnedOutsideOfScope, MobileData, NoAccess, noAccessOutsideOfScope, DateDeclined, 
		Employees, SurveyAppointmentColour 
	)
		AS
	(
		SELECT
			a.OffsetStart,a.Days,a.OffsetEnd,a.Duration,a.StartTime,a.EndTime,a.AppointmentID,a.AppointmentType,
			a.ClientID,a.Client,a.ProjectID,a.Project,a.SiteID,a.Site,a.Address,a.Postcode,a.UPRN,a.JobID,a.JobNo,
			a.Cost,a.DateConfirmed,a.CalendarFileID,a.EmployeeID,a.Employee,a.BranchOfficeId,a.AppCategoryDescription,
			a.HTML_Colour,a.AppointmentGroupId,a.ProjectAppointmentId,a.MobileDataReturned,
			a.MobileDataReturnedOutsideOfScope,a.MobileData,a.NoAccess,a.noAccessOutsideOfScope,a.DateDeclined,
			IsNull((Select Count(*) From AppointmentEmployee Where AppointmentId = a.AppointmentId),0) as Employees,
			a.SurveyAppointmentColour
		FROM 
			AppointmentsWithCategory a
		WHERE 
		(
			-- TODO - Need to use the date passed in
			StartTime Between '2017-02-01 00:00:00' And '2017-02-07 23:59:59' 
				OR
			EndTime Between  '2017-02-01 00:00:00' And '2017-02-07 23:59:59' 
				Or 
			'2017-02-01 00:00:00' Between StartTime And EndTime
				Or 
			'2017-02-07 23:59:59' Between StartTime And EndTime
		)
		-- TODO - Add branch filter if passed in
		-- WriteIf(Session("DiaryFilterBranch") > 0, "And BranchOfficeId = " & Session("DiaryFilterBranch"))
	)

	SELECT 
		CurrentWeek.DayEmployeeId,CurrentWeek.DayEmployee,CurrentWeek.EmployeeDeleted,CurrentWeek.Date,Main.OffsetStart,
		Main.Days,Main.OffsetEnd,Main.Duration,Main.StartTime,Main.EndTime,Main.AppointmentID,Main.AppointmentType,
		Main.ClientID,Main.Client,Main.ProjectID,Main.Project,Main.SiteID,Main.Site,Main.Address,Main.Postcode,Main.UPRN,
		Main.JobID,Main.JobNo,Main.Cost,Main.DateConfirmed,Main.CalendarFileID,Main.EmployeeID,Main.Employee,
		Main.BranchOfficeId,Main.appCategoryDescription,Main.HTML_Colour,Main.AppointmentGroupId,Main.ProjectAppointmentId,
		Main.MobileDataReturned,Main.MobileDataReturnedOutsideOfScope,Main.MobileData,Main.NoAccess,
		Main.noAccessOutsideOfScope,Main.DateDeclined,Main.Employees,Main.SurveyAppointmentColour
	FROM
	(
		SELECT
			DayEmployeeId,DayEmployee,EmployeeDeleted,CurrentWeek.Date,e.SortOrder,a.* 
		FROM
		(
			SELECT
				EmployeeId as DayEmployeeId,FullName as DayEmployee,IsNull(Cast(Deleted as bit),0) as EmployeeDeleted, 
				-- TODO - Add the prefix "Branch" if necessary
				-- WriteIf(SafeNumeric(Session("DiaryFilterBranch")) > 0, "Branch")
				SortOrder [SortOrder] 
			FROM
				Employee 
			WHERE
				Not FullName = 'External Lab' 
				-- TODO - Add filters
				-- WriteIf(SafeNumeric(Session("DiaryFilterDeletedEmployees")) = 0 And 1=2, "And Deleted Is Null " & vbcrlf) & _
				-- WriteIf(Session("DiaryFilterBranch") > 0, "And BranchOfficeId = " & Session("DiaryFilterBranch") & vbcrlf) & _
				-- WriteIf(trim(Session("DiaryFilterEmployeePosition")) <> "", " And LTRIM(rtrim(ISNULL([Position],''))) = '" & trim(Session("DiaryFilterEmployeePosition") & "'") & vbcrlf) & _
				-- WriteIf(Not roleSQL = "", "And " & roleSQL & vbcrlf) & _
				-- WriteIf(Not Session("DiaryFilterEmployees") = "" And 1=2, "		And EmployeeID In (" & SQLSafe(Session("DiaryFilterEmployees")) & ")" & vbcrlf) & _

			UNION

			SELECT 
				-1 AS DayEmployeeId,'Unassigned' as DayEmployee,0 as EmployeeDeleted,-1 as SortOrder 
		) e
		CROSS JOIN 
		(
			SELECT CAST('2017-02-01' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-02' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-03' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-04' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-05' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-06' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-07' as date) as [Date]
		) CurrentWeek 
		LEFT OUTER JOIN 
		(
			SELECT
				OffsetStart,Days,OffsetEnd,Duration,StartTime,EndTime,AppointmentID,AppointmentType,ClientID,
				Client,ProjectID,Project,SiteID,Site,Address,Postcode,UPRN,JobID,JobNo,Cost,DateConfirmed,
				CalendarFileID,EmployeeID,Employee,BranchOfficeId,AppCategoryDescription,HTML_Colour,
				AppointmentGroupId,ProjectAppointmentId,MobileDataReturned,MobileDataReturnedOutsideOfScope,
				MobileData,NoAccess,noAccessOutsideOfScope,DateDeclined,Employees,SurveyAppointmentColour
			FROM 
				cte_AppList
		) a On e.DayEmployeeId=ISNULL(a.EmployeeId,-1)
		WHERE
			CASE WHEN 
				(CurrentWeek.Date BETWEEN Cast(StartTime as date) And Cast(EndTime as date)) 
					OR 
				a.AppointmentID IS NULL THEN 1 ELSE 0 END = 1 

			-- TODO - Add filters
			-- WriteIf(Session("ClientID")  > 0, "       And a.ClientID = " &  Session("ClientID") & vbcrlf) & _
			-- WriteIf(Session("ProjectID") > 0, "       And a.ProjectID = " & Session("ProjectID") & vbcrlf) & _
			-- WriteIf(Session("SiteID")    > 0, "       And a.SiteID = " &    Session("SiteID") & vbcrlf) & _
			-- WriteIf(Not Session("Filter") = "", "       And (" & Replace(Session("FilterSQL"),"s.","a.") & ")" & vbcrlf) & _
			-- WriteIf(Session("DiaryFilterIncludeDeclined") = 0, "       And a.DateDeclined Is Null" & vbcrlf) & _
			-- WriteIf(Session("DiaryFilterProjectBookings") = 0, " AND a.ProjectAppointmentID IS NULL" & VbCrLf) & _
	) Main 

	FULL JOIN 
	(
		SELECT
			thisWeek.Date,e.DayEmployeeId,e.DayEmployee,e.EmployeeDeleted,e.SortOrder
		FROM 
		(
			SELECT
				EmployeeId as DayEmployeeId,FullName as DayEmployee,IsNull(Cast(Deleted as bit),0) as EmployeeDeleted, 
				-- TODO - Add the prefix "Branch" if necessary
				-- WriteIf(SafeNumeric(Session("DiaryFilterBranch")) > 0, "Branch")
				SortOrder [SortOrder] 
			FROM
				Employee 
			WHERE
				Not FullName = 'External Lab' 
				-- TODO - Add filters
				-- WriteIf(SafeNumeric(Session("DiaryFilterDeletedEmployees")) = 0 And 1=2, "		And Deleted Is Null " & vbcrlf) & _
				-- WriteIf(Session("DiaryFilterBranch") > 0, "       And BranchOfficeId = " & Session("DiaryFilterBranch") & vbcrlf) & _
				-- WriteIf(trim(Session("DiaryFilterEmployeePosition")) <> "", " And LTRIM(rtrim(ISNULL([Position],''))) = '" & trim(Session("DiaryFilterEmployeePosition") & "'") & vbcrlf) & _
				-- WriteIf(Not roleSQL = "", "		And " & roleSQL & vbcrlf) & _
				-- WriteIf(Not Session("DiaryFilterEmployees") = "" And 1=2, "		And EmployeeID In (" & SQLSafe(Session("DiaryFilterEmployees")) & ")" & vbcrlf) & _

			UNION
		
			SELECT 
				-1 as DayEmployeeId,'Unassigned' as DayEmployee,0 as EmployeeDeleted,-1 as SortOrder 
		) e
		CROSS JOIN 
		(
			SELECT CAST('2017-02-01' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-02' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-03' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-04' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-05' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-06' as date) as [Date] 
				UNION
			SELECT CAST('2017-02-07' as date) as [Date]

		) thisWeek 
	) CurrentWeek ON CurrentWeek.Date = Main.Date AND Main.DayEmployeeId=CurrentWeek.DayEmployeeId


	ORDER BY 
		CurrentWeek.SortOrder,CurrentWeek.Date,Cast(Main.StartTime as time),Main.Address
      
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_PopulateSiteJobsReinspectionState')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_PopulateSiteJobsReinspectionState] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_PopulateSiteJobsReinspectionState]    Script Date: 07/03/2017 12:03:24 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Portfolio_PopulateSiteJobsReinspectionState]
/**********************************************************************
** Overview: Takes a list of Site/Jobs and sets the reinspection state of each
**   NOTE: Designed to be called within another procedure to populate columns in a temporary
**   table named #SiteJobs. This table must be created with the correct columns before calling this.
**   There must also be a temporary table called #ClientIdData which contains a list of the ClientIDs.
**   As of 20/12/2016, it is being used by these procedures (which are commented appropriately):
**     a) GetSites
**     b) GetSites_MainTab
**     c) GetSitesSurveyed
**     d) GetPortalJobDataForSites
**   This method is used to save duplicating logic between procedures and allowing the complicated logic
**   to calculate the reinspection state to only be run on as few sites/jobs as possible for performance
**   reasons.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- For each Site in #SiteJobs, get all Jobs for that Site into a temp table. We have to do this, as otherwise we could only join based upon the SiteID which doesn't have a filtered list of SurveyTypes.
    CREATE TABLE #AllSiteJobsData (JobID INT PRIMARY KEY NOT NULL, SiteID INT NOT NULL)

    -- Add an index on important #AllSiteJobsData fields to increase speed in the main UPDATE.
    CREATE INDEX temp_AllSiteJobsData ON #AllSiteJobsData (JobID)

    INSERT INTO #AllSiteJobsData (JobID, SiteID)
    SELECT j.JobID, j.SiteID
    FROM
        #SiteJobs sj
        INNER JOIN Job j WITH (NOLOCK) ON sj.SiteID = j.SiteID
        INNER JOIN #ClientIdData c ON j.ClientID = c.ClientID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
    GROUP BY
        j.JobID, j.SiteID

    -- Get SampleComputedData data up front to reduce table scans on the SampleComputedData table.
    -- NOTE: Only gets certain fields from SampleComputedData to increase speed. Add more columns in the future if needed.
    -- If more Element data is required in the future, then we will want to move this data into an #ElementData temp table.
    CREATE TABLE #SiteJobsComputedData (SampleComputedDataID INT PRIMARY KEY, SiteID INT, JobID INT, SampleID INT, RiskScoreGroupID INT, DateOfNextReviewInt INT, DateOfNextReviewIsAsRequired BIT NOT NULL)

    -- Add an index on important #SiteJobsComputedData fields to increase speed in the main UPDATE.
    CREATE INDEX temp_SiteJobsComputedData ON #SiteJobsComputedData (SiteID, RiskScoreGroupID, DateOfNextReviewInt, DateOfNextReviewIsAsRequired)

    INSERT INTO #SiteJobsComputedData (SampleComputedDataID, SiteID, JobID, SampleID, RiskScoreGroupID, DateOfNextReviewInt, DateOfNextReviewIsAsRequired)
    SELECT
        scd.SampleComputedDataID,
        scd.SiteID,
        scd.JobID,
        scd.SampleID,
        scd.RiskScoreGroupID,
        CASE WHEN ISNUMERIC(eim27.ShortDescription) = 1 THEN CAST(eim27.ShortDescription AS INT) END [DateOfNextReviewInt],
		CASE WHEN eim27.ShortDescription = 'As Required' THEN 1 ELSE 0 END [DateOfNextReviewIsAsRequired]
    FROM
        (
            SELECT scd.SampleComputedDataID, scd.SiteID, scd.JobID, scd.SampleID, scd.RiskScoreGroupID, e27.ElementIntMeaningID
            FROM
                #AllSiteJobsData sj
                INNER JOIN SampleComputedData scd WITH (NOLOCK) ON sj.JobID = scd.JobID AND scd.Removed = 0
                INNER JOIN GuidSamples gs WITH (NOLOCK) ON scd.SampleID = gs.SampleID
                LEFT JOIN Element e27 WITH (NOLOCK) ON scd.SampleId = e27.SampleID AND e27.ElementTypeID = 27
            GROUP BY
                scd.SampleComputedDataID, scd.SiteID, scd.JobID, scd.SampleID, scd.RiskScoreGroupID, e27.ElementIntMeaningID
        ) scd
        LEFT JOIN ElementIntMeaning eim27 WITH (NOLOCK) ON scd.ElementIntMeaningID = eim27.ElementIntMeaningID

    -- Update temp table #SiteJobs with the data from #SiteJobsComputedData. Does one UPDATE to increase speed (rather than four seperate updates).
    DECLARE @SiteJobsCalculated TABLE (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(10), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)
    INSERT INTO @SiteJobsCalculated (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed)
    SELECT
        sj.SiteID,
        sj.SiteAddress,
        sj.SitePostcode,
        sj.SitePost2000,
        sj.UnmanagedSite,
        sj.IsSiteDocument,
        sj.JobID,
        sj.MaxRegisterFinish,
        hrsgi.HighestRiskScoreGroupID,
        fnrd.FirstNextReviewDate,
        rd.ReinspectionDate,
        CASE
            -- A post-2000 Site
            WHEN sj.SitePost2000 = 1 THEN 5
            -- A Un-managed Site
            WHEN sj.UnmanagedSite = 1 THEN 6
            -- ReinspectionNotRequired
            WHEN rd.ReinspectionDate IS NULL AND ISNULL(fnrd.DateOfNextReviewIsAsRequired, 0) = 0 THEN 1
            -- Compliant
            WHEN rd.ReinspectionDate > DATEADD(MONTH, 3, GETDATE()) OR ISNULL(fnrd.DateOfNextReviewIsAsRequired, 0) = 1 THEN 2
            -- ReinspectionOverdue
            WHEN rd.ReinspectionDate < GETDATE() THEN 3
            -- ReinspectionDueIn3Months
            ELSE 4
        END [Surveyed]
    FROM
        #SiteJobs sj
        OUTER APPLY
        (
            SELECT MAX(RiskScoreGroupID) [HighestRiskScoreGroupID]
            FROM #SiteJobsComputedData
            WHERE SiteID = sj.SiteID
        ) hrsgi -- HighestRiskScoreGroupID
        OUTER APPLY
        (
            SELECT MIN(DateOfNextReviewInt) [FirstNextReviewDate], CAST(MAX(CAST(DateOfNextReviewIsAsRequired AS INT)) AS BIT) [DateOfNextReviewIsAsRequired]
            FROM #SiteJobsComputedData
            WHERE SiteID = sj.SiteID AND RiskScoreGroupID = hrsgi.HighestRiskScoreGroupID AND (DateOfNextReviewInt IS NOT NULL OR DateOfNextReviewIsAsRequired = 1)
        ) fnrd -- FirstNextReviewDate
        OUTER APPLY
        (
            SELECT
                CASE
                    WHEN sj.IsSiteDocument = 1 THEN DATEADD(MONTH, 12, sj.MaxRegisterFinish)
                    WHEN fnrd.FirstNextReviewDate IS NOT NULL THEN DATEADD(MONTH, fnrd.FirstNextReviewDate, sj.MaxRegisterFinish)
					WHEN fnrd.DateOfNextReviewIsAsRequired = 1 THEN NULL
                    WHEN hrsgi.HighestRiskScoreGroupID = 4 THEN DATEADD(MONTH, 6, sj.MaxRegisterFinish)
                    WHEN hrsgi.HighestRiskScoreGroupID IS NOT NULL THEN DATEADD(MONTH, 12, sj.MaxRegisterFinish)
                END [ReinspectionDate]
        ) rd -- ReinspectionDate

    -- Delete from #SiteJobs.
    DELETE FROM #SiteJobs

    -- Re-insert the new data into #SiteJobs.
    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed FROM @SiteJobsCalculated

    -- Clear up temp tables.
    DROP TABLE #AllSiteJobsData
    DROP TABLE #SiteJobsComputedData


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_TotalComplianceChartData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_TotalComplianceChartData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_TotalComplianceChartData]    Script Date: 07/03/2017 12:03:58 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Portfolio_TotalComplianceChartData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @SurveyTypeIDs = NULLIF(LTRIM(RTRIM(@SurveyTypeIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    DECLARE @SurveyTypeIdData TABLE (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO @SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Total Compliance data up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #TotalComplianceData (SiteID INT PRIMARY KEY, Post2000 BIT NOT NULL, UnmanagedSite BIT NOT NULL, JobID INT, SurveyTypeID INT)

    -- Add an index on important #TotalComplianceData fields to increase speed below.
    CREATE INDEX temp_TotalComplianceData ON #TotalComplianceData (SiteID)

    -- Get Total Compliance data for Sites with a Survey.
    INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite, JobID, SurveyTypeID)
    SELECT SiteID, Post2000, UnmanagedSite, JobID, SurveyTypeID
    FROM
    (
        SELECT
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite,
            CASE WHEN si.Post2000 = 0 AND si.UnmanagedSite = 0 THEN ISNULL(jd.JobID, -1) ELSE NULL END [JobID],
            CASE WHEN si.Post2000 = 0 AND si.UnmanagedSite = 0 THEN ISNULL(jd.SurveyTypeID, -1) ELSE NULL END [SurveyTypeID],
            ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.RegisterFinish DESC, jd.JobID DESC) [RowID]
        FROM
            @ClientSiteData csd
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
            INNER JOIN (
                SELECT
                    a.*,
                    ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.RegisterFinish DESC, a.JobID DESC) [RowID]
                FROM
                (
                    SELECT 0 [IsSiteDocument], j.ClientID, j.SiteID, j.JobID, su.SurveyTypeID, r.RegisterFinish
                    FROM
                        Job j WITH (NOLOCK)
                        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN @SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                    WHERE j.Approved IS NOT NULL AND j.Cancelled IS NULL
                    UNION ALL
                    SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], NULL [SurveyTypeID], sidi.WorkDate [RegisterFinish]
                    FROM
                        SiteDocument sid WITH (NOLOCK)
                        INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                    WHERE
                        sid.SiteDocumentTypeID = 3 -- Surveys
                            AND
                        sid.Deleted IS NULL
                ) a
            ) jd ON
                CASE WHEN jd.IsSiteDocument = 1
                    THEN -1
                    ELSE csd.ClientID
                END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
        GROUP BY
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.SurveyTypeID,
            jd.RegisterFinish,
            jd.RowID
    ) a
    WHERE a.RowID = 1
    GROUP BY
        a.SiteID,
        a.Post2000,
        a.UnmanagedSite,
        a.JobID,
        a.SurveyTypeID
    ORDER BY
        a.SiteID

    -- Get Total Compliance data for Sites without a Survey.
    INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite)
    SELECT
        si.SiteID,
        si.Post2000,
        si.UnmanagedSite
    FROM
        @ClientSiteData csd
        INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
    WHERE
        si.SiteID NOT IN (SELECT SiteID FROM #TotalComplianceData)
    GROUP BY
        si.SiteID,
        si.Post2000,
        si.UnmanagedSite

    -- Get the total number of items.
    DECLARE @TotalItems INT = (SELECT COUNT(*) FROM #TotalComplianceData)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END [category],
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END [Colour],
            COUNT(*) [Share],
            @TotalItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            CAST(
                CASE WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL
                    THEN 1
                    ELSE 0
                END AS BIT) [Surveyed]
        FROM #TotalComplianceData
        GROUP BY
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END,
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END,
            CASE WHEN JobID IS NOT NULL AND SurveyTypeID IS NOT NULL
                THEN 1
                ELSE 0
            END
        ORDER BY
            Surveyed,
            category
    END
    ELSE
    BEGIN
        SELECT * FROM #TotalComplianceData
        ORDER BY SiteID
    END

    -- Clear up temp tables.
    DROP TABLE #TotalComplianceData


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_TargetTimescalesChartData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_TargetTimescalesChartData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_TargetTimescalesChartData]    Script Date: 07/03/2017 12:03:41 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Portfolio_TargetTimescalesChartData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL
/**********************************************************************
** Overview: Get Target Timescales data.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this graph. */
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this graph. */
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Target Timescales data up front to reduce table scans.
    DECLARE @TimescaleForCompletionData TABLE (SampleID INT NOT NULL, TimescaleForCompletionCategoryID INT NOT NULL)
    INSERT INTO @TimescaleForCompletionData (SampleID, TimescaleForCompletionCategoryID)
    SELECT
        scd.SampleID,
        CASE
            WHEN scd.TimescaleForCompletion < GETDATE() THEN 1                      -- Overdue
            WHEN DATEDIFF(m, GETDATE(), scd.TimescaleForCompletion) <= 3 THEN 2     -- WithinThreeMonths
            WHEN DATEDIFF(m, GETDATE(), scd.TimescaleForCompletion) > 3 THEN 3      -- OverThreeMonths
        END [TimescaleForCompletionCategoryID]
    FROM
        @ClientSiteData csd
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON csd.ClientID = scd.ClientID AND csd.SiteID = scd.SiteID
        INNER JOIN GuidSamples gs WITH (NOLOCK) ON scd.SampleID = gs.SampleID
    WHERE
        scd.TimescaleForCompletion IS NOT NULL

    -- Get the total number of items.
    DECLARE @TotalItems INT = (SELECT COUNT(*) FROM @TimescaleForCompletionData)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE TimescaleForCompletionCategoryID
                WHEN 1 THEN 'Overdue'
                WHEN 2 THEN 'Within 3 Months'
                WHEN 3 THEN 'Over 3 Months'
                ELSE NULL
            END [category],
            CASE TimescaleForCompletionCategoryID
                WHEN 1 THEN '#E8412D'
                WHEN 2 THEN '#FFB400'
                WHEN 3 THEN '#92CE7A'
                ELSE NULL
            END [Colour],
            COUNT(*) [Share],
            @TotalItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend]
        FROM @TimescaleForCompletionData
        GROUP BY
            CASE TimescaleForCompletionCategoryID
                WHEN 1 THEN 'Overdue'
                WHEN 2 THEN 'Within 3 Months'
                WHEN 3 THEN 'Over 3 Months'
                ELSE NULL
            END,
            CASE TimescaleForCompletionCategoryID
                WHEN 1 THEN '#E8412D'
                WHEN 2 THEN '#FFB400'
                WHEN 3 THEN '#92CE7A'
                ELSE NULL
            END
        ORDER BY
            category
    END
    ELSE
    BEGIN
        SELECT * FROM @TimescaleForCompletionData
        ORDER BY SampleID
    END


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_SitesSurveyedChartData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_SitesSurveyedChartData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_SitesSurveyedChartData]    Script Date: 07/03/2017 12:03:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Portfolio_SitesSurveyedChartData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL
/**********************************************************************
** Overview: Get the Sites Surveyed data.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @SurveyTypeIDs = NULLIF(LTRIM(RTRIM(@SurveyTypeIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed. Also used by PopulateSiteJobsReinspectionState.
    CREATE TABLE #ClientIdData (ClientID INT PRIMARY KEY)
    INSERT INTO #ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    CREATE TABLE #SurveyTypeIdData (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO #SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            #ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            #ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Site Jobs up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #SiteJobs (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(10), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)

    -- Add an index on important #SiteJobs fields to increase speed below.
    CREATE INDEX temp_SiteJobs ON #SiteJobs (SiteID)

    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, RegisterFinish [MaxRegisterFinish]
    FROM
    (
        SELECT
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.Post2000 [SitePost2000],
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.RegisterFinish DESC, jd.JobID DESC) [RowID]
        FROM
            @ClientSiteData csd
            INNER JOIN (
                SELECT
                    a.*,
                    ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.RegisterFinish DESC, a.JobID DESC) [RowID]
                FROM
                (
                    SELECT 0 [IsSiteDocument], j.ClientID, j.SiteID, j.JobID, r.RegisterFinish
                    FROM
                        Job j WITH (NOLOCK)
                        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                    WHERE j.Approved IS NOT NULL AND j.Cancelled IS NULL
                    UNION ALL
                    SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [RegisterFinish]
                    FROM
                        SiteDocument sid WITH (NOLOCK)
                        INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                    WHERE
                        sid.SiteDocumentTypeID = 3 -- Surveys
                            AND
                        sid.Deleted IS NULL
                ) a
            ) jd ON
                CASE WHEN jd.IsSiteDocument = 1
                    THEN -1
                    ELSE csd.ClientID
                END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        GROUP BY
            si.SiteID,
            si.Address,
            si.Postcode,
            si.Post2000,
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            jd.RowID
    ) a
    WHERE a.RowID = 1
    GROUP BY
        a.SiteID,
        a.SiteAddress,
        a.SitePostcode,
        a.SitePost2000,
        a.UnmanagedSite,
        a.IsSiteDocument,
        a.JobID,
        a.RegisterFinish,
        a.RowID
    ORDER BY
        a.SiteID

    -- Execute the SPROC Portfolio_PopulateSiteJobsReinspectionState. This populates additional columns in #SiteJobs, so it assumes #SiteJobs already exists.
    EXEC Portfolio_PopulateSiteJobsReinspectionState

    -- Get the total number of items.
    DECLARE @TotalItems INT = (SELECT COUNT(*) FROM #SiteJobs)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE
                WHEN SitePost2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN 'Reinspection Not Required'
                        WHEN 2 THEN 'Compliant'
                        WHEN 3 THEN 'Reinspection Overdue'
                        WHEN 4 THEN 'Compliant - Reinspection Due Within 3 Months'
                        ELSE NULL
                    END
            END [category],
            CASE
                WHEN SitePost2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN '#00B050'
                        WHEN 2 THEN '#AFD8F8'
                        WHEN 3 THEN '#E8412D'
                        WHEN 4 THEN '#F6BD0F'
                        ELSE NULL
                    END
            END [Colour],
            COUNT(*) [Share],
            @TotalItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            Surveyed
        FROM #SiteJobs
        GROUP BY
            CASE
                WHEN SitePost2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN 'Reinspection Not Required'
                        WHEN 2 THEN 'Compliant'
                        WHEN 3 THEN 'Reinspection Overdue'
                        WHEN 4 THEN 'Compliant - Reinspection Due Within 3 Months'
                        ELSE NULL
                    END
            END,
            CASE
                WHEN SitePost2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN '#00B050'
                        WHEN 2 THEN '#AFD8F8'
                        WHEN 3 THEN '#E8412D'
                        WHEN 4 THEN '#F6BD0F'
                        ELSE NULL
                    END
            END,
            Surveyed
        ORDER BY
            Surveyed,
            category
    END
    ELSE
    BEGIN
        SELECT
            sj.SiteID,
            sj.JobID,
            0 [SurveyTypeID], -- 07/11/2016 - Old column, remove in the future.
            sj.Surveyed,
            sj.ReinspectionDate,
            sj.SiteAddress,
            sj.SitePostcode
        FROM
            #SiteJobs sj
    END

    -- Clear up temp tables.
    DROP TABLE #ClientIdData
    DROP TABLE #SurveyTypeIdData
    DROP TABLE #SiteJobs


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_OverviewLegionellaGraphData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_OverviewLegionellaGraphData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_OverviewLegionellaGraphData]    Script Date: 07/03/2017 12:03:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Portfolio_OverviewLegionellaGraphData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL,
    @TotalCompliance BIT = 1,
    @RiskItems BIT = 1,
    @LowUseOutlets BIT = 0,
    @OutletsOutOfSpec BIT = 0,
    @RiskItemID INT = 0

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Total Compliance data up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #TotalComplianceData (SiteID INT PRIMARY KEY, Post2000 BIT NOT NULL, UnmanagedSite BIT NOT NULL, JobID INT)

    -- Add an index on important #TotalComplianceData fields to increase speed below.
    CREATE INDEX temp_TotalComplianceData ON #TotalComplianceData (SiteID, JobID)

    -- Get Total Compliance data for Sites with a Survey.
    IF @TotalCompliance = 1 OR @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite, JobID)
        SELECT SiteID, Post2000, UnmanagedSite, JobID
        FROM
        (
            SELECT
                si.SiteID,
                si.Post2000,
                si.UnmanagedSite,
                CASE WHEN si.Post2000 = 0 AND si.UnmanagedSite = 0 THEN ISNULL(jd.JobID, -1) ELSE NULL END [JobID],
                ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.LegionellaFinish DESC, jd.JobID DESC) [RowID]
            FROM
                @ClientSiteData csd
                INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
                INNER JOIN (
                    SELECT
                        a.*,
                        ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.LegionellaFinish DESC, a.JobID DESC) [RowID]
                    FROM
                    (
                        SELECT 0 [IsSiteDocument], j.ClientID, j.SiteID, j.JobID, l.LegionellaFinish
                        FROM
                            Job j WITH (NOLOCK)
                            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                            INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
                            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID AND l.DateApproved IS NOT NULL
                        WHERE j.Approved IS NOT NULL AND j.Cancelled IS NULL
                        UNION ALL
                        SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [LegionellaFinish]
                        FROM
                            SiteDocument sid WITH (NOLOCK)
                            INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                        WHERE
                            sid.SiteDocumentTypeID = 6 -- Legionella Surveys
                                AND
                            sid.Deleted IS NULL
                    ) a
                ) jd ON
                    CASE WHEN jd.IsSiteDocument = 1
                        THEN -1
                        ELSE csd.ClientID
                    END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            GROUP BY
                si.SiteID,
                si.Post2000,
                si.UnmanagedSite,
                jd.IsSiteDocument,
                jd.JobID,
                jd.LegionellaFinish,
                jd.RowID
        ) a
        WHERE a.RowID = 1
        GROUP BY
            a.SiteID,
            a.Post2000,
            a.UnmanagedSite,
            a.JobID
        ORDER BY
            a.SiteID
    END

    -- Get Legionella Items data up front to reduce table scans on the Legionella/Asset/Location/Outlet tables.
    DECLARE @LegionellaItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, DateApproved DATETIME, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT,  OutletEnabledCold BIT, OutletEnabledHot BIT, OutletEnabledMixed BIT, OutletEnabledMains BIT, OutletLowUse BIT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, DateApproved, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, OutletEnabledCold, OutletEnabledHot, OutletEnabledMixed, OutletEnabledMains, OutletLowUse)
        SELECT
            tcd.SiteID,
            j.JobID,
            lao.RowType,
            l.LegionellaID,
            l.GUID [LegGUID],
            l.GUIDVersion [LegGUIDVersion],
            l.DateApproved,
            lao.LegionellaAssetOutletID,
            lao.AssetOutletGUID,
            lao.AssetOutletGUIDVersion,
            lao.LegionellaLocationID,
            lao.LocationGUID,
            lao.LocationGUIDVersion,
            lao.OutletEnabledCold,
            lao.OutletEnabledHot,
            lao.OutletEnabledMixed,
            lao.OutletEnabledMains,
            CASE WHEN (lao.OutletEnabledCold = 1 AND lao.OutletLowUseCold = 1) OR (lao.OutletEnabledHot = 1 AND lao.OutletLowUseHot = 1) OR (lao.OutletEnabledMixed = 1 AND lao.OutletLowUseMixed = 1) OR (lao.OutletEnabledMains = 1 AND lao.OutletLowUseMains = 1)
                THEN 1
                ELSE 0
            END [OutletLowUse]
        FROM
            #TotalComplianceData tcd
            INNER JOIN Job j WITH (NOLOCK) ON tcd.SiteID = j.SiteID AND j.Approved IS NOT NULL AND j.Cancelled IS NULL
            INNER JOIN @ClientIdData c ON j.ClientID = c.ClientID
            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
            INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
            INNER JOIN (
                SELECT
                    1 [RowType],
                    l.LegionellaID,
                    NULL [LegionellaAssetOutletID],
                    NULL [AssetOutletSystemRef],
                    NULL [AssetOutletGUID],
                    NULL [AssetOutletGUIDVersion],
                    NULL [LegionellaLocationID],
                    NULL [AssetOutletLocation],
                    NULL [LocationGUID],
                    NULL [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    Legionella l WITH (NOLOCK)

                UNION ALL

                SELECT
                    2 [RowType],
                    la.LegionellaID,
                    la.LegionellaAssetID [LegionellaAssetOutletID],
                    la.SystemRef [AssetOutletSystemRef],
                    la.GUID [AssetOutletGUID],
                    la.GUIDVersion [AssetOutletGUIDVersion],
                    NULL [LegionellaLocationID],
                    la.Location [AssetOutletLocation],
                    NULL [LocationGUID],
                    NULL [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    LegionellaAsset la WITH (NOLOCK)
                WHERE
                    la.Deleted IS NULL

                UNION ALL

                SELECT
                    3 [RowType],
                    ll.LegionellaID,
                    NULL [LegionellaAssetOutletID],
                    NULL [AssetOutletSystemRef],
                    NULL [AssetOutletGUID],
                    NULL [AssetOutletGUIDVersion],
                    ll.LegionellaLocationID,
                    ll.Location [AssetOutletLocation],
                    ll.GUID [LocationGUID],
                    ll.GUIDVersion [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    LegionellaLocation ll WITH (NOLOCK)
                WHERE
                    ll.Deleted IS NULL

                UNION ALL

                SELECT
                    4 [RowType],
                    ll.LegionellaID,
                    lo.LegionellaOutletID [LegionellaAssetOutletID],
                    lo.SystemRef [AssetOutletSystemRef],
                    lo.GUID [AssetOutletGUID],
                    lo.GUIDVersion [AssetOutletGUIDVersion],
                    ll.LegionellaLocationID,
                    ll.Location [AssetOutletLocation],
                    ll.GUID [LocationGUID],
                    ll.GUIDVersion [LocationGUIDVersion],
                    lo.EnabledCold [OutletEnabledCold],
                    lo.EnabledHot [OutletEnabledHot],
                    lo.EnabledMixed [OutletEnabledMixed],
                    lo.EnabledMains [OutletEnabledMains],
                    lo.LowUseCold [OutletLowUseCold],
                    lo.LowUseHot [OutletLowUseHot],
                    lo.LowUseMixed [OutletLowUseMixed],
                    lo.LowUseMains [OutletLowUseMains]
                FROM
                    LegionellaLocation ll WITH (NOLOCK)
                    INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID AND lo.Deleted IS NULL
                WHERE
                    ll.Deleted IS NULL
            ) lao ON l.LegionellaID = lao.LegionellaID
        GROUP BY
            tcd.SiteID,
            j.JobID,
            lao.RowType,
            l.LegionellaID,
            l.GUID,
            l.GUIDVersion,
            l.DateApproved,
            lao.LegionellaAssetOutletID,
            lao.AssetOutletGUID,
            lao.AssetOutletGUIDVersion,
            lao.LegionellaLocationID,
            lao.LocationGUID,
            lao.LocationGUIDVersion,
            lao.OutletEnabledCold,
            lao.OutletEnabledHot,
            lao.OutletEnabledMixed,
            lao.OutletEnabledMains,
            lao.OutletLowUseCold,
            lao.OutletLowUseHot,
            lao.OutletLowUseMixed,
            lao.OutletLowUseMains
    END

    -- Get Legionella data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion)
        SELECT
            l.SiteID,
            l.JobID,
            l.LegionellaID,
            l.LegGUID,
            l.LegGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella record with the max GUID.
                    l.SiteID,
                    l.JobID,
                    l.LegionellaID,
                    l.LegGUID,
                    l.LegGUIDVersion,
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(l.LegGUID, NEWID()) ORDER BY l.LegGUIDVersion DESC, l.DateApproved DESC) [RowID]
                FROM @LegionellaItemsData l
                WHERE l.RowType = 1
            ) l
        WHERE l.RowID = 1
    END*/

    -- Get Legionella Asset data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaAssetGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetID INT, AssetGUID VARCHAR(MAX), AssetGUIDVersion INT)

    IF @RiskItems = 1
    BEGIN
        INSERT INTO @LegionellaAssetGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetID, AssetGUID, AssetGUIDVersion)
        SELECT
            la.SiteID,
            la.JobID,
            la.LegionellaID,
            la.LegGUID,
            la.LegGUIDVersion,
            la.LegionellaAssetID,
            la.AssetGUID,
            la.AssetGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella Asset record with the max GUID.
                    la.SiteID,
                    la.JobID,
                    la.LegionellaID,
                    la.LegGUID,
                    la.LegGUIDVersion,
                    la.LegionellaAssetOutletID [LegionellaAssetID],
                    la.AssetOutletGUID [AssetGUID],
                    la.AssetOutletGUIDVersion [AssetGUIDVersion],
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(la.AssetOutletGUID, NEWID()) ORDER BY la.AssetOutletGUIDVersion DESC) [RowID]
                FROM @LegionellaItemsData la
                WHERE la.RowType = 2
            ) la
        WHERE la.RowID = 1
    END*/

    -- Get Legionella Location data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaLocationGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaLocationID INT NOT NULL, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaLocationGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion)
        SELECT
            ll.SiteID,
            ll.JobID,
            ll.LegionellaID,
            ll.LegGUID,
            ll.LegGUIDVersion,
            ll.LegionellaLocationID,
            ll.LocationGUID,
            ll.LegGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella Location record with the max GUID.
                    ll.SiteID,
                    ll.JobID,
                    ll.LegionellaID,
                    ll.LegGUID,
                    ll.LegGUIDVersion,
                    ll.LegionellaLocationID,
                    ll.LocationGUID,
                    ll.LocationGUIDVersion,
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(ll.LocationGUID, NEWID()) ORDER BY ll.LocationGUIDVersion DESC) [RowID]
                FROM @LegionellaItemsData ll
                WHERE ll.RowType = 3
            ) ll
        WHERE ll.RowID = 1
    END*/

    -- Get Legionella Outlet data combined as GUIDs up front as used below. As well as getting the latest GUID version, get the latest LegionellaOutletComputedData version (if available).
    DECLARE @LegionellaOutletGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaLocationID INT NOT NULL, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaOutletID INT NOT NULL, OutletGUID VARCHAR(MAX), OutletGUIDVersion INT, Cold DECIMAL(10, 2), Hot DECIMAL(10, 2), Mixed DECIMAL(10, 2), Mains DECIMAL(10, 2), Flushed BIT NOT NULL, LowUse BIT NOT NULL)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaOutletGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaOutletID, OutletGUID, OutletGUIDVersion, Cold, Hot, Mixed, Mains, Flushed, LowUse)
        SELECT
            lo.SiteID,
            lo.JobID,
            lo.LegionellaID,
            lo.LegGUID,
            lo.LegGUIDVersion,
            lo.LegionellaLocationID,
            lo.LocationGUID,
            lo.LocationGUIDVersion,
            lo.LegionellaOutletID,
            lo.OutletGUID,
            lo.OutletGUIDVersion,
            lo.Cold,
            lo.Hot,
            lo.Mixed,
            lo.Mains,
            lo.Flushed,
            lo.LowUse
        FROM
            (
                SELECT -- Get each Legionella Outlet record with the max GUID.
                    lo.SiteID,
                    lo.JobID,
                    lo.LegionellaID,
                    lo.LegGUID,
                    lo.LegGUIDVersion,
                    lo.LegionellaLocationID,
                    lo.LocationGUID,
                    lo.LocationGUIDVersion,
                    lo.LegionellaOutletID,
                    lo.OutletGUID,
                    lo.OutletGUIDVersion,
                    CASE WHEN lo.EnabledCold = 1 THEN locd.Cold ELSE NULL END [Cold],
                    CASE WHEN lo.EnabledHot = 1 THEN locd.Hot ELSE NULL END [Hot],
                    CASE WHEN lo.EnabledMixed = 1 THEN locd.Mixed ELSE NULL END [Mixed],
                    CASE WHEN lo.EnabledMains = 1 THEN locd.Mains ELSE NULL END [Mains],
                    CASE WHEN (lo.EnabledCold = 1 AND locd.FlushedCold = 1) OR (lo.EnabledHot = 1 AND locd.FlushedHot = 1) OR (lo.EnabledMixed = 1 AND locd.FlushedMixed = 1) OR (lo.EnabledMains = 1 AND locd.FlushedMains = 1)
                        THEN 1
                        ELSE 0
                    END [Flushed],
                    lo.OutletLowUse [LowUse],
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(lo.OutletGUID, NEWID()) ORDER BY lo.OutletGUIDVersion DESC, locd.Created DESC) [RowID]
                FROM
                    (
                        SELECT -- Get each Legionella Outlet record with the max GUID.
                            lo.SiteID,
                            lo.JobID,
                            lo.LegionellaID,
                            lo.LegGUID,
                            lo.LegGUIDVersion,
                            lo.LegionellaLocationID,
                            lo.LocationGUID,
                            lo.LocationGUIDVersion,
                            lo.LegionellaAssetOutletID [LegionellaOutletID],
                            lo.AssetOutletGUID [OutletGUID],
                            lo.AssetOutletGUIDVersion [OutletGUIDVersion],
                            lo.OutletEnabledCold [EnabledCold],
                            lo.OutletEnabledHot [EnabledHot],
                            lo.OutletEnabledMixed [EnabledMixed],
                            lo.OutletEnabledMains [EnabledMains],
                            lo.OutletLowUse,
                            ROW_NUMBER() OVER (PARTITION BY ISNULL(lo.AssetOutletGUID, NEWID()) ORDER BY lo.AssetOutletGUIDVersion DESC) [RowID]
                        FROM @LegionellaItemsData lo
                        WHERE lo.RowType = 4
                    ) lo
                    INNER JOIN LegionellaOutletComputedData locd WITH (NOLOCK) ON lo.LegionellaOutletID = locd.LegionellaOutletID
                    WHERE lo.RowID = 1
            ) lo
        WHERE lo.RowID = 1
    END

    -- Get Legionella Task up front to reduce table scans on the LegionellaTask table.
    -- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
    DECLARE @LegionellaTasksData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, /* ADDITIONAL COLUMNS */ RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaPriorityRatingID INT)

    IF @RiskItems = 1
    BEGIN
        IF @ReturnAsChart = 1 -- Basic columns only.
        BEGIN
            INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID)
            SELECT
                lao.SiteID,
                lao.JobID,
                lao.RowType,
                lao.LegionellaID,
                lao.LegGUID,
                lao.LegGUIDVersion,
                lao.LegionellaAssetOutletID,
                lao.AssetOutletGUID,
                lao.AssetOutletGUIDVersion,
                lao.LegionellaLocationID,
                lao.LocationGUID,
                lao.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.GUID [TaskGUID],
                lt.GUIDVersion [TaskGUIDVersion],
                lt.LegionellaRiskRatingID
            FROM
                @LegionellaItemsData lao
                INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
                    CASE lao.RowType -- Join based on the main UNION
                        WHEN 1 THEN lao.LegionellaID
                        WHEN 3 THEN lao.LegionellaLocationID
                        ELSE lao.LegionellaAssetOutletID
                    END =
                    CASE lao.RowType -- Join based on this live table
                        WHEN 1 THEN lt.LegionellaID
                        WHEN 2 THEN lt.LegionellaAssetID
                        WHEN 3 THEN lt.LegionellaLocationID
                        WHEN 4 THEN lt.LegionellaOutletID
                    END
            WHERE
                lt.Deleted IS NULL
                    AND
                CASE WHEN @RiskItemID = 0 -- Risk filter.
                    THEN 1
                    ELSE
                        CASE WHEN @RiskItemID = -1
                            THEN CASE WHEN lt.LegionellaRiskRatingID IS NULL THEN 1 ELSE 0 END
                            ELSE CASE WHEN @RiskItemID = ISNULL(lt.LegionellaRiskRatingID, -1) THEN 1 ELSE 0 END
                        END
                END = 1
        END
        ELSE
        BEGIN -- Additional columns included.
            INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
            SELECT
                lao.SiteID,
                lao.JobID,
                lao.RowType,
                lao.LegionellaID,
                lao.LegGUID,
                lao.LegGUIDVersion,
                lao.LegionellaAssetOutletID,
                lao.AssetOutletGUID,
                lao.AssetOutletGUIDVersion,
                lao.LegionellaLocationID,
                lao.LocationGUID,
                lao.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.GUID [TaskGUID],
                lt.GUIDVersion [TaskGUIDVersion],
                lt.LegionellaRiskRatingID,
                lt.RiskDescription,
                lt.Action,
                lt.LegionellaFrequencyCategoryID,
                lt.LegionellaPriorityRatingID
            FROM
                @LegionellaItemsData lao
                INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
                    CASE lao.RowType -- Join based on the main UNION
                        WHEN 1 THEN lao.LegionellaID
                        WHEN 3 THEN lao.LegionellaLocationID
                        ELSE lao.LegionellaAssetOutletID
                    END =
                    CASE lao.RowType -- Join based on this live table
                        WHEN 1 THEN lt.LegionellaID
                        WHEN 2 THEN lt.LegionellaAssetID
                        WHEN 3 THEN lt.LegionellaLocationID
                        WHEN 4 THEN lt.LegionellaOutletID
                    END
            WHERE
                lt.Deleted IS NULL
                    AND
                CASE WHEN @RiskItemID = 0 -- Risk filter.
                    THEN 1
                    ELSE
                        CASE WHEN @RiskItemID = -1
                            THEN CASE WHEN lt.LegionellaRiskRatingID IS NULL THEN 1 ELSE 0 END
                            ELSE CASE WHEN @RiskItemID = ISNULL(lt.LegionellaRiskRatingID, -1) THEN 1 ELSE 0 END
                        END
                END = 1
        END
    END

    -- Get Legionella Risk Items data up front as used below. Basically GUID Tasks.
    -- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
    DECLARE @LegionellaRiskItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, /* ADDITIONAL COLUMNS */ JobNo INT, SiteAddress VARCHAR(200), SitePostcode VARCHAR(10), BuildingDesignation VARCHAR(50), AssetOutletSystemRef VARCHAR(8000), Location VARCHAR(8000), RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(8000), LegionellaPriorityRatingID INT, PriorityRating VARCHAR(20), PriorityColour VARCHAR(15))

    IF @RiskItems = 1
    BEGIN
        IF @ReturnAsChart = 1 -- Basic columns only.
        BEGIN
            INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder)
            SELECT
                lt.SiteID,
                lt.JobID,
                lt.RowType,
                lt.LegionellaID,
                lt.LegGUID,
                lt.LegGUIDVersion,
                lt.LegionellaAssetOutletID,
                lt.AssetOutletGUID,
                lt.AssetOutletGUIDVersion,
                lt.LegionellaLocationID,
                lt.LocationGUID,
                lt.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.TaskGUID,
                lt.TaskGUIDVersion,
                lrr.LegionellaRiskRatingID,
                lrr.Description [RiskRating],
                lrr.RiskColour,
                lrr.SortOrder [RiskRatingSortOrder]
            FROM
                (
                    SELECT -- Get each Legionella Task record with the max GUID.
                        lt.SiteID,
                        lt.JobID,
                        lt.RowType,
                        lt.LegionellaID,
                        lt.LegGUID,
                        lt.LegGUIDVersion,
                        lt.LegionellaAssetOutletID,
                        lt.AssetOutletGUID,
                        lt.AssetOutletGUIDVersion,
                        lt.LegionellaLocationID,
                        lt.LocationGUID,
                        lt.LocationGUIDVersion,
                        lt.LegionellaTaskID,
                        lt.TaskGUID,
                        lt.TaskGUIDVersion,
                        lt.LegionellaRiskRatingID,
                        ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
                    FROM @LegionellaTasksData lt
                ) lt
                LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
            WHERE lt.RowID = 1
        END
        ELSE
        BEGIN -- Additional columns included.
            INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, JobNo, SiteAddress, SitePostcode, BuildingDesignation, AssetOutletSystemRef, Location, RiskDescription, Action, LegionellaFrequencyCategoryID, FrequencyCategory, LegionellaPriorityRatingID, PriorityRating, PriorityColour)
            SELECT
                lt.SiteID,
                lt.JobID,
                lt.RowType,
                lt.LegionellaID,
                lt.LegGUID,
                lt.LegGUIDVersion,
                lt.LegionellaAssetOutletID,
                lt.AssetOutletGUID,
                lt.AssetOutletGUIDVersion,
                lt.LegionellaLocationID,
                lt.LocationGUID,
                lt.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.TaskGUID,
                lt.TaskGUIDVersion,
                lrr.LegionellaRiskRatingID,
                ISNULL(lrr.Description, 'None') [RiskRating],
                '#' + ISNULL(lrr.RiskColour, 'CCCCCC') [RiskColour],
                lrr.SortOrder [RiskRatingSortOrder],
                j.JobNo,
                si.Address [SiteAddress],
                si.Postcode [SitePostcode],
                ISNULL(NULLIF(l.BuildingDesignation, ''), 'No Building Designation') [BuildingDesignation],
                ISNULL(NULLIF(ISNULL(la.SystemRef, lo.SystemRef), ''), 'N/A') [AssetOutletSystemRef],
                ISNULL(ISNULL(la.Location, ll.Location), '') [Location],
                ISNULL(lt.RiskDescription, 'N/A') [RiskDescription],
                ISNULL(lt.Action, 'N/A') [Action],
                lfc.LegionellaFrequencyCategoryID,
                ISNULL(lfc.Description, '') [FrequencyCategory],
                lpr.LegionellaPriorityRatingID,
                ISNULL(lpr.ShortDescription, 'None') [PriorityRating],
                '#' + ISNULL(lpr.PriorityColour, 'CCCCCC') [PriorityColour]
            FROM
                (
                    SELECT -- Get each Legionella Task record with the max GUID.
                        lt.SiteID,
                        lt.JobID,
                        lt.RowType,
                        lt.LegionellaID,
                        lt.LegGUID,
                        lt.LegGUIDVersion,
                        lt.LegionellaAssetOutletID,
                        lt.AssetOutletGUID,
                        lt.AssetOutletGUIDVersion,
                        lt.LegionellaLocationID,
                        lt.LocationGUID,
                        lt.LocationGUIDVersion,
                        lt.LegionellaTaskID,
                        lt.TaskGUID,
                        lt.TaskGUIDVersion,
                        lt.LegionellaRiskRatingID,
                        lt.RiskDescription,
                        lt.Action,
                        lt.LegionellaFrequencyCategoryID,
                        lt.LegionellaPriorityRatingID,
                        ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
                    FROM @LegionellaTasksData lt
                ) lt
                INNER JOIN Job j WITH (NOLOCK) ON lt.JobID = j.JobID
                INNER JOIN Site si WITH (NOLOCK) ON lt.SiteID = si.SiteID
                INNER JOIN Legionella l WITH (NOLOCK) ON lt.LegionellaID = l.LegionellaID
                LEFT JOIN LegionellaAsset la WITH (NOLOCK) ON lt.LegionellaAssetOutletID = la.LegionellaAssetID AND lt.RowType = 2
                LEFT JOIN LegionellaLocation ll WITH (NOLOCK) ON lt.LegionellaLocationID = ll.LegionellaLocationID
                LEFT JOIN LegionellaOutlet lo WITH (NOLOCK) ON lt.LegionellaAssetOutletID = lo.LegionellaOutletID AND lt.RowType = 4
                LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
                LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
                LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
            WHERE lt.RowID = 1
        END
    END

    -- Get the default Outlet Temperature Limits for the Company.
    DECLARE @ColdMin FLOAT = 0, @ColdMax FLOAT = 0, @HotMin FLOAT = 0, @HotMax FLOAT = 0, @MixedMin FLOAT = 0, @MixedMax FLOAT = 0, @MainsMin FLOAT = 0, @MainsMax FLOAT = 0
    IF @OutletsOutOfSpec = 1
    BEGIN
        SELECT TOP 1
            @ColdMin = ISNULL(ColdMin, 0),
            @ColdMax = ISNULL(ColdMax, 0),
            @HotMin = ISNULL(HotMin, 0),
            @HotMax = ISNULL(HotMax, 0),
            @MixedMin = ISNULL(MixedMin, 0),
            @MixedMax = ISNULL(MixedMax, 0),
            @MainsMin = ISNULL(MainsMin, 0),
            @MainsMax = ISNULL(MainsMax, 0)
        FROM SiteLegionellaTemperatureLimits WITH (NOLOCK)
        WHERE SiteID = -1 AND Deleted IS NULL
    END

    -- Get the Legionella Outlets out of Spec for each Site.
    DECLARE @LegionellaOutletsOutOfSpec TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegionellaLocationID INT NOT NULL, LegionellaOutletID INT NOT NULL, Cold DECIMAL(10, 2), Hot DECIMAL(10, 2), Mixed DECIMAL(10, 2), Mains DECIMAL(10, 2), ColdMin FLOAT, ColdMax FLOAT, HotMin FLOAT, HotMax FLOAT, MixedMin FLOAT, MixedMax FLOAT, MainsMin FLOAT, MainsMax FLOAT, TempOutOfSpec BIT NOT NULL)

    IF @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaOutletsOutOfSpec (SiteID, JobID, LegionellaID, LegionellaLocationID, LegionellaOutletID, Cold, Hot, Mixed, Mains, ColdMin, ColdMax, HotMin, HotMax, MixedMin, MixedMax, MainsMin, MainsMax, TempOutOfSpec)
        SELECT
            lo.SiteID,
            lo.JobID,
            lo.LegionellaID,
            lo.LegionellaLocationID,
            lo.LegionellaOutletID,
            lo.Cold,
            lo.Hot,
            lo.Mixed,
            lo.Mains,
            ISNULL(siltl.ColdMin, @ColdMin) [ColdMin],
            ISNULL(siltl.ColdMax, @ColdMax) [ColdMax],
            ISNULL(siltl.HotMin, @HotMin) [HotMin],
            ISNULL(siltl.HotMax, @HotMax) [HotMax],
            ISNULL(siltl.MixedMin, @MixedMin) [MixedMin],
            ISNULL(siltl.MixedMax, @MixedMax) [MixedMax],
            ISNULL(siltl.MainsMin, @MainsMin) [MainsMin],
            ISNULL(siltl.MainsMax, @MainsMax) [MainsMax],
            CASE
                WHEN lo.Cold < ISNULL(siltl.ColdMin, @ColdMin) OR lo.Cold > ISNULL(siltl.ColdMax, @ColdMax) THEN 1
                WHEN lo.Hot < ISNULL(siltl.HotMin, @HotMin) OR lo.Hot > ISNULL(siltl.HotMax, @HotMax) THEN 1
                WHEN lo.Mixed < ISNULL(siltl.MixedMin, @MixedMin) OR lo.Mixed > ISNULL(siltl.MixedMax, @MixedMax) THEN 1
                WHEN lo.Mains < ISNULL(siltl.MainsMin, @MainsMin) OR lo.Mains > ISNULL(siltl.MainsMax, @MainsMax) THEN 1
                ELSE 0
            END [TempOutOfSpec]
        FROM
            @LegionellaOutletGUIDData lo
            LEFT JOIN SiteLegionellaTemperatureLimits siltl WITH (NOLOCK) ON lo.SiteID = siltl.SiteID AND siltl.Deleted IS NULL
    END

    -- Add more to the Total Compliance data for Sites without a Survey.
    IF @TotalCompliance = 1
    BEGIN
        INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite)
        SELECT
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite
        FROM
            @ClientSiteData csd
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        WHERE
            si.SiteID NOT IN (SELECT SiteID FROM #TotalComplianceData)
        GROUP BY
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite
    END

    -- Get the total number of items.
    DECLARE @TotalComplianceItems INT = (SELECT COUNT(*) FROM #TotalComplianceData)
    DECLARE @TotalRiskItems INT = (SELECT COUNT(*) FROM @LegionellaRiskItemsData)
    DECLARE @TotalLowUseOutlets INT = (SELECT COUNT(*) FROM @LegionellaOutletGUIDData WHERE LowUse = 1)
    DECLARE @TotalOutletsOutOfSpec INT = (SELECT COUNT(*) FROM @LegionellaOutletsOutOfSpec)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END [category],
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END [Colour],
            COUNT(*) [Share],
            @TotalComplianceItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            CAST(
                CASE WHEN JobID IS NOT NULL
                    THEN 1
                    ELSE 0
                END AS BIT) [Surveyed]
        FROM #TotalComplianceData
        WHERE @TotalCompliance = 1
        GROUP BY
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END,
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END,
            CASE WHEN JobID IS NOT NULL
                THEN 1
                ELSE 0
            END
        ORDER BY
            Surveyed,
            category

        SELECT
            ISNULL(RiskRating, 'None') [category],
            '#' + ISNULL(RiskColour, 'CCCCCC') [Colour],
            COUNT(*) [Share],
            @TotalRiskItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            ISNULL(RiskRatingSortOrder, -1) [SortOrder],
            ISNULL(LegionellaRiskRatingID, -1) [LegionellaRiskRatingID]
        FROM @LegionellaRiskItemsData
        WHERE @RiskItems = 1
        GROUP BY
            ISNULL(RiskRating, 'None'),
            '#' + ISNULL(RiskColour, 'CCCCCC'),
            ISNULL(RiskRatingSortOrder, -1),
            ISNULL(LegionellaRiskRatingID, -1)
        ORDER BY
            SortOrder,
            category

        SELECT
            CASE WHEN Flushed = 1
                THEN 'Flushed'
                ELSE 'Not Flushed'
            END [category],
            CASE WHEN Flushed = 1
                THEN '#AFD8F8'
                ELSE '#CCCCCC'
            END [Colour],
            COUNT(*) [Share],
            @TotalLowUseOutlets [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            Flushed
        FROM @LegionellaOutletGUIDData
        WHERE @LowUseOutlets = 1 AND LowUse = 1
        GROUP BY
            CASE WHEN Flushed = 1
                THEN 'Flushed'
                ELSE 'Not Flushed'
            END,
            CASE WHEN Flushed = 1
                THEN '#AFD8F8'
                ELSE '#CCCCCC'
            END,
            Flushed
        ORDER BY
            Flushed DESC,
            category

        SELECT
            CASE WHEN TempOutOfSpec = 1
                THEN 'Outside of Specification'
                ELSE 'Within Specification'
            END [category],
            CASE WHEN TempOutOfSpec = 1
                THEN '#E8412D'
                ELSE '#00B050'
            END [Colour],
            COUNT(*) [Share],
            @TotalOutletsOutOfSpec [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            TempOutOfSpec
        FROM @LegionellaOutletsOutOfSpec
        WHERE @OutletsOutOfSpec = 1
        GROUP BY
            CASE WHEN TempOutOfSpec = 1
                THEN 'Outside of Specification'
                ELSE 'Within Specification'
            END,
            CASE WHEN TempOutOfSpec = 1
                THEN '#E8412D'
                ELSE '#00B050'
            END,
            TempOutOfSpec
        ORDER BY
            TempOutOfSpec,
            category
    END
    ELSE
    BEGIN
        SELECT * FROM #TotalComplianceData
        WHERE @TotalCompliance = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaRiskItemsData
        WHERE @RiskItems = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaOutletGUIDData
        WHERE @LowUseOutlets = 1 AND LowUse = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaOutletsOutOfSpec
        WHERE @OutletsOutOfSpec = 1
        ORDER BY SiteID
    END

    -- Clear up temp tables.
    DROP TABLE #TotalComplianceData


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_OverviewGraphData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_OverviewGraphData] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_OverviewGraphData]    Script Date: 07/03/2017 12:03:08 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Portfolio_OverviewGraphData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = '',
    @JobID INT = NULL,
    @ReturnAsChart BIT = NULL

AS
BEGIN
    SET NOCOUNT ON;

    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @SurveyTypeIDs = NULLIF(LTRIM(RTRIM(@SurveyTypeIDs)), ''),
        @JobID = NULLIF(@JobID, 0),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    DECLARE @SurveyTypeIdData TABLE (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO @SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this graph. */
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this graph. */
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get Register data up front to reduce table scans.
    CREATE TABLE #RegisterData (ClientID INT, SiteID INT, JobID INT, JobNo INT, RegisterID INT, BuildingDesignation VARCHAR(1000), RegisterFinish DATETIME, SurveyTypeID INT)

    -- Add an index on important #RegisterData fields to increase speed below.
    CREATE INDEX temp_RegisterData ON #RegisterData (RegisterID)

    INSERT INTO #RegisterData (ClientID, SiteID, JobID, JobNo, RegisterID, BuildingDesignation, RegisterFinish, SurveyTypeID)
    SELECT
        csd.ClientID,
        csd.SiteID,
        j.JobID,
        j.JobNo,
        r.RegisterID,
        r.BuildingDesignation,
        r.RegisterFinish,
        su.SurveyTypeID
    FROM
        @ClientSiteData csd
        INNER JOIN Job j WITH (NOLOCK) ON csd.ClientID = j.ClientID AND csd.SiteID = j.SiteID AND j.Cancelled IS NULL AND j.Approved IS NOT NULL
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN @SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
    WHERE
        (@JobID IS NULL OR j.JobID = @JobID)
    GROUP BY
        csd.ClientID,
        csd.SiteID,
        j.JobID,
        j.JobNo,
        r.RegisterID,
        r.BuildingDesignation,
        r.RegisterFinish,
        su.SurveyTypeID

    -- Get SampleComputedData data up front to reduce table scans on the SampleComputedData table.
    DECLARE @SiteSampleComputedData TABLE (SampleComputedDataID INT, RegisterID INT, SampleID INT, SampleResult INT, RecommendedAction NVARCHAR(100), RecommendedActionColour VARCHAR(6), RecommendedActionSortOrder INT, RiskScore INT, RiskScoreGroupID INT, RiskScoreGroup VARCHAR(100), RiskScoreGroupColour VARCHAR(10), RiskScoreSortOrder INT)

    INSERT INTO @SiteSampleComputedData (SampleComputedDataID, RegisterID, SampleID, SampleResult, RecommendedAction, RecommendedActionColour, RecommendedActionSortOrder, RiskScore, RiskScoreGroupID, RiskScoreGroup, RiskScoreGroupColour, RiskScoreSortOrder)
    SELECT
        scd.SampleComputedDataID,
        r.RegisterID,
        scd.SampleID,
        scd.SampleResult,
        scd.RecommendedAction,
        scd.RecommendedActionColour,
        scd.RecommendedActionSortOrder,
        scd.RiskScore,
        scd.RiskScoreGroupID,
        scd.RiskScoreGroup,
        scd.RiskScoreGroupColour,
        scd.RiskScoreSortOrder
    FROM
        #RegisterData r
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
        INNER JOIN Sample s WITH (NOLOCK) ON rm.RoomID = s.RoomID
        INNER JOIN GuidSamples gs WITH (NOLOCK) ON s.SampleID = gs.SampleID
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON gs.SampleID = scd.SampleID AND gs.ClientID = scd.ClientID AND gs.SiteID = scd.SiteID
    WHERE
        scd.Removed = 0
            AND
        scd.RecommendedAction IS NOT NULL

    -- Clear up temp tables.
    DROP TABLE #RegisterData

    -- Get all Risk Items data up front to reduce table scans.
    DECLARE @RiskItemsData TABLE (SampleID INT NOT NULL, RiskScoreGroup VARCHAR(100) NOT NULL, RiskScoreGroupColour VARCHAR(10) NOT NULL, RiskScoreSortOrder INT NOT NULL)
    INSERT INTO @RiskItemsData (SampleID, RiskScoreGroup, RiskScoreGroupColour, RiskScoreSortOrder)
    SELECT
        SampleID,
        ISNULL(RiskScoreGroup, 'Inaccessible') [RiskScoreGroup],
        ISNULL(RiskScoreGroupColour, '#CCCCCC') [RiskScoreGroupColour],
        ISNULL(RiskScoreSortOrder, 0) [RiskScoreSortOrder]
    FROM @SiteSampleComputedData
    WHERE SampleResult <> 0
    GROUP BY
        SampleID,
        ISNULL(RiskScoreGroup, 'Inaccessible'),
        ISNULL(RiskScoreGroupColour, '#CCCCCC'),
        ISNULL(RiskScoreSortOrder, 0)

    -- Get all Recommended Action Items data up front to reduce table scans.
    DECLARE @RecommendedActionItemsData TABLE (RegisterID INT NOT NULL, SampleID INT NOT NULL, RecommendedAction NVARCHAR(100) NOT NULL, RecommendedActionColour VARCHAR(6) NOT NULL, RecommendedActionSortOrder INT NOT NULL)
    INSERT INTO @RecommendedActionItemsData (RegisterID, SampleID, RecommendedAction, RecommendedActionColour, RecommendedActionSortOrder)
    SELECT
        RegisterID,
        SampleID,
        RecommendedAction,
        RecommendedActionColour,
        ISNULL(RecommendedActionSortOrder, 0) [RecommendedActionSortOrder]
    FROM @SiteSampleComputedData
    GROUP BY
        RegisterID,
        SampleID,
        RecommendedAction,
        RecommendedActionColour,
        ISNULL(RecommendedActionSortOrder, 0)

    -- Get the total number of items.
    DECLARE @TotalRiskItems INT = (SELECT COUNT(*) FROM @RiskItemsData)
    DECLARE @TotalRecActionItems INT = (SELECT COUNT(*) FROM @RecommendedActionItemsData)

    -- Start the main SELECTs.
    IF @ReturnAsChart = 1
    BEGIN
        -- Get the Max Sort Order, so we can re-arrange the items.
        DECLARE @MaxRisksSortOrder INT = (SELECT MAX(RiskScoreSortOrder) FROM @RiskItemsData)

        -- Start the SELECT to get Risk Items data.
        SELECT
            RiskScoreGroup [category],
            RiskScoreGroupColour [Colour],
            COUNT(*) [Share],
            @TotalRiskItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            @MaxRisksSortOrder - MAX(RiskScoreSortOrder) + 1 [SortOrder]
        FROM @RiskItemsData
        GROUP BY
            RiskScoreGroup,
            RiskScoreGroupColour
        ORDER BY
            SortOrder,
            category

        -- Start the SELECT to get Recommended Action Items data.
        SELECT
            RecommendedAction [category],
            '#' + RecommendedActionColour [Colour],
            COUNT(*) [Share],
            @TotalRecActionItems [TotalItems],
            CAST(0 AS BIT) [VisibleInLegend],
            MAX(RecommendedActionSortOrder) [SortOrder]
        FROM @RecommendedActionItemsData
        GROUP BY
            RecommendedAction,
            RecommendedActionColour
        ORDER BY
            category,
            SortOrder
    END
    ELSE
    BEGIN
        -- Start the SELECT to get Risk Items data.
        SELECT
            SampleID,
            ISNULL(RiskScoreGroup, 'Inaccessible') [RiskScoreGroup],
            ISNULL(RiskScoreGroupColour, '#CCCCCC') [RiskScoreGroupColour],
            ISNULL(RiskScoreSortOrder, 0) [RiskScoreSortOrder]
        FROM @SiteSampleComputedData
        WHERE SampleResult <> 0
        GROUP BY
            SampleID,
            ISNULL(RiskScoreGroup, 'Inaccessible'),
            ISNULL(RiskScoreGroupColour, '#CCCCCC'),
            ISNULL(RiskScoreSortOrder, 0)

        -- Start the SELECT to get Recommended Action Items data.
        SELECT
            RegisterID,
            SampleID,
            RecommendedAction,
            RecommendedActionColour,
            ISNULL(RecommendedActionSortOrder, 0) [RecommendedActionSortOrder]
        FROM @SiteSampleComputedData
        GROUP BY
            RegisterID,
            SampleID,
            RecommendedAction,
            RecommendedActionColour,
            ISNULL(RecommendedActionSortOrder, 0)
    END

    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_SiteList')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_SiteList] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Paged_SiteList]    Script Date: 07/03/2017 12:02:57 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- ======================================================
-- Author:			Lonny 
-- Create date:		28/02/2017
-- ======================================================

ALTER PROCEDURE [dbo].[Paged_SiteList] 

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0 -- (0=all)

AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX))

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
        c.ClientID = @ClientID
            AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_MyRisksAsbestos')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_MyRisksAsbestos] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Paged_MyRisksAsbestos]    Script Date: 07/03/2017 12:02:46 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- ======================================================
-- Author:			Lonny 
-- Create date:		28/02/2017
-- ======================================================

ALTER PROCEDURE [dbo].[Paged_MyRisksAsbestos] 

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0 -- (0=all)

AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX))

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
        c.ClientID = @ClientID
            AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetJobStatus')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetJobStatus] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[GetJobStatus]    Script Date: 07/03/2017 12:02:21 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END


    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            Else 'Work Scheduled'
        End [Status],
        MIN(CAST(a.StartTime AS DATE)) [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(Cast(reg.RegisterFinish as Date)) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC


    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO

-- Currency table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='Currency'))
	BEGIN
		CREATE TABLE [dbo].[Currency](
			[CurrencyId] [int] IDENTITY(1,1) NOT NULL,
			[Code] [varchar](10) NOT NULL,
			[Name] [varchar](max) NOT NULL,
			[TerritoryCode] [varchar](10) NOT NULL,
			[TerritoryName] [varchar](max) NOT NULL,
		 CONSTRAINT [PK_Currency] PRIMARY KEY CLUSTERED 
		(
			[CurrencyId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

/*
    NEW VERSION OF POPULATE SAMPLECOMPUTEDDATA AND GUIDSAMPLES SPROCS
    These now join to the Floorplan table as well to prevent data issues on Ensafe, in particular to do with Import data.
    As well as this, PopulateSampleComputedData now uses less CTE's and more table variables, which has sped it up a lot. Seems to be working well on Ensafe, but we might need to keep an eye out.
*/
ALTER PROCEDURE [dbo].[PopulateSampleComputedData]
    @JobID INT
AS
BEGIN
    SET NOCOUNT ON;


    -- Delete existing data for the Job.
    DELETE FROM SampleComputedData
    WHERE JobID = @JobID

    -- Set variables for logic.
    DECLARE @CompanyName NVARCHAR(50), @BranchName NVARCHAR(50), @RecommendedActionsAllowed INT
    SELECT
        @CompanyName = cfg.s__CompanyName,
        @BranchName = cfg.s__BranchName,
        @RecommendedActionsAllowed = (SELECT mc.MobileConfigInt FROM MobileConfig mc WITH (NOLOCK) INNER JOIN MobileConfigType mct WITH (NOLOCK) ON mc.MobileConfigTypeID = mct.MobileConfigTypeID WHERE mct.ConfigType = 'RecommendedActionAllowed')
    FROM
        Config cfg WITH (NOLOCK)

    -- Get all sample result data up front to reduce table scans on the sample table
    DECLARE @SampleData TABLE (RegisterID INT, RegisterFinish DATETIME, PriorityAssessment BIT, RoomID INT, SampleRef VARCHAR(50), AsSample BIT, RegisterItemNo INT, SampleID INT, PhotoID INT, SampleResultID INT, SampleResult VARCHAR(500), FullSampleResult VARCHAR(500), SampleResultValue INT, SampleClassificationID INT, SampleClassification VARCHAR(500), SampleClassificationValue INT, SampleClassificationScore INT, Notes VARCHAR(MAX))

    INSERT INTO @SampleData (RegisterID, RegisterFinish, PriorityAssessment, RoomID, SampleRef, AsSample, RegisterItemNo, SampleID, PhotoID, SampleResultID, SampleResult, FullSampleResult, SampleResultValue, SampleClassificationID, SampleClassification, SampleClassificationValue, SampleClassificationScore, Notes)
    SELECT
        r.RegisterID,
        r.RegisterFinish,
        r.PriorityAssessment,
        rm.RoomID,
        s.SampleRef,
        s.AsSample,
        s.RegisterItemNo,
        s.SampleID,
        s.PhotoID,
        sr.SampleResultID,
        COALESCE(sr.SampleResult, eim8.ShortDescription, eim8.Description),
        COALESCE(sr.FullSampleResult, sr.SampleResult, eim8.ShortDescription, eim8.Description),
        COALESCE(sr.Value, e8.ElementIntID, -1),
        sc.SampleClassificationID,
        COALESCE(sce.SampleClassification, sc.SampleClassification, eime6.Description, eimso6.Description, eim6.ShortDescription, eim6.Description),
        COALESCE(sc.Value, e6sc.Value, -1),
        COALESCE(sc.Score, e6sc.Score, 0),
        s.Notes
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
        LEFT JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID = sr.SampleResultID
        LEFT JOIN Element e8 WITH (NOLOCK) ON s.SampleID = e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID = eim8.ElementIntMeaningID
        LEFT JOIN SampleClassification sc WITH (NOLOCK) ON s.SampleClassificationID = sc.SampleClassificationID
        LEFT JOIN SampleClassificationExtended sce WITH (NOLOCK) ON s.SampleClassificationExtendedID = sce.SampleClassificationExtendedID
        LEFT JOIN Element e6 WITH (NOLOCK) ON s.SampleID = e6.SampleID AND e6.ElementTypeID = 6
        LEFT JOIN ElementIntMeaning eim6 WITH (NOLOCK) ON e6.ElementIntMeaningID = eim6.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime6 WITH (NOLOCK) ON e6.ElementIntMeaningExtendedID = eime6.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso6 WITH (NOLOCK) ON e6.ElementIntMeaningSubOptionID = eimso6.ElementIntMeaningSubOptionID
        LEFT JOIN SampleClassification e6sc WITH (NOLOCK) ON e6.ElementIntID = e6sc.SampleClassificationID
    WHERE
        je.JobID = @JobID
            AND
        s.Archived = 0

    -- Get all element data up front to reduce table scans on the element table
    DECLARE @ElementData TABLE (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX), ElementIntMeaningShortDescription VARCHAR(MAX), ElementIntMeaningLongDescription VARCHAR(MAX), ElementDescriptionOrText VARCHAR(MAX))

    INSERT INTO @ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription, ElementIntMeaningShortDescription, ElementIntMeaningLongDescription, ElementDescriptionOrText)
    SELECT
        e.ElementID,
        e.SampleID,
        e.ElementTypeID,
        e.ElementText,
        e.ElementIntID,
        e.ElementIntMeaningID,
        e.ElementIntMeaningExtendedID,
        e.ElementIntMeaningSubOptionID,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description),
        eim.ShortDescription,
        eim.Description,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description, e.ElementText)
    FROM
        @SampleData s
        INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
        LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID

    -- Update table variable so that As Samples get the same Sample Data of the physical Samples
    UPDATE @SampleData
    SET
        SampleResultID = (SELECT subSD.SampleResultID FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        SampleResult = ISNULL((SELECT subSD.SampleResult FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        FullSampleResult = ISNULL((SELECT subSD.FullSampleResult FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        SampleResultValue = ISNULL((SELECT subSD.SampleResultValue FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e8.ElementIntID),
        SampleClassificationID = (SELECT subSD.SampleClassificationID FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        SampleClassification = ISNULL((SELECT subSD.SampleClassification FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e6.ElementIntMeaningDescription),
        SampleClassificationValue = ISNULL((SELECT subSD.SampleClassificationValue FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Value FROM SampleClassification WHERE e6.ElementIntID=SampleClassificationID), 0)),
        SampleClassificationScore = ISNULL((SELECT subSD.SampleClassificationScore FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Score FROM SampleClassification WHERE e6.ElementIntID=SampleClassificationID), 0)),
        Notes = (SELECT subSD.Notes FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
    FROM
        @SampleData updateSD
        LEFT JOIN @ElementData e8 ON updateSD.SampleID=e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN @ElementData e6 ON updateSD.SampleID=e6.SampleID AND e6.ElementTypeID = 6
    WHERE
        updateSD.AsSample = 1

    -- Setup the CTEs.
      ;With SamplesComputed As
      (
            Select
                  s.SampleId,
                  s.SampleRef,
                  e2.ElementText [SourceDescription], 
                  e20.ElementIntMeaningShortDescription [RecommendedAction],
                  rac.RecommendedActionColour,
                  CASE WHEN e20.ElementIntMeaningShortDescription = 'No further action required'
                    THEN 0
                    Else @RecommendedActionsAllowed + 1 - e20.ElementIntID
                  END [RecommendedActionSortOrder],
                  s.SampleResultValue [SampleResult],

                  Case
                        When Not s.SampleResultValue = -1 Then
                              '(' + Cast(s.SampleResultValue as varchar(10)) + ') ' +
                              ISNULL(s.FullSampleResult, '')
                  End [AsbestosType],

                  Coalesce(sc.Value, sc2.Value, 0) [ClassificationValue],
                  Coalesce(sc.SampleClassification, e6.ElementIntMeaningShortDescription, e6.ElementIntMeaningLongDescription, '') [Classification],
                  Case
                        When sr.Value < 1 Then
                              0
                        When Not sc.SampleClassificationID Is Null Then
                              sc.Score
                        When Not e6.ElementIntID Is Null Then
                              e6.ElementIntID
                        Else
                              0
                  End [ClassificationScore],

                  e9.ElementIntID + e10.ElementIntID [MaterialAssessmentScore],

                  IsNull(e11.ElementIntID,0) [OccupantActivity],
                  IsNull(e12.ElementIntID,0) [LocationScore],
                  IsNull(e13.ElementIntID,0) [VulnerabilityScore],
                  IsNull(e14.ElementIntID,0) [QuantityScore],
                  IsNull(e15.ElementIntID,0) [NoOfOccupants],
                  IsNull(e16.ElementIntID,0) [FrequencyOfUse],
                  IsNull(e17.ElementIntID,0) [AverageTimeAreaIsInUse],
                  IsNull(e18.ElementIntID,0) [TypeOfMaintenance],
                  IsNull(e19.ElementIntID,0) [FrequencyOfMaintenance],
                  
                  s.SampleResultID,
                  s.SampleClassificationID,

                  Case
                        When (s.SampleResultValue > 0 Or e5.ElementIntId = 0)  AND (IsNull(e48.ElementIntMeaningID,0)<>121 AND IsNull(e48.ElementIntMeaningID,0)<>126) Then
                              Case
                                    When e27.ElementText IS NULL Then
                                          Case Coalesce(sc.Value,sc2.Value,0)
                                                      When 0 Then
                                                            Case e5.ElementIntID
                                                                  When 0 Then 
                                                                        -- INACCESSIBLE
                                                                        Case e22.ElementIntMeaningID
                                                                              When 113 Then ReviewDates.TwelveMonths
                                                                        End
                                                            End
                                                      When 10 Then ReviewDates.SixMonths
                                                      When  8 Then ReviewDates.SixMonths
                                                      When  7 Then ReviewDates.SixMonths
                                                      When  6 Then ReviewDates.SixMonths
                                                      Else 
                                                            ReviewDates.TwelveMonths
                                          End
                                    When IsDate(e27.ElementText) = 1 Then
                                          e27.ElementText
                              End
                  End [ReviewDate],
                  
                  Case
                        When (s.SampleResultValue > 0 Or e5.ElementIntId = 0) And (IsNull(e48.ElementIntMeaningID,0)<>121 AND IsNull(e48.ElementIntMeaningID,0)<>126) Then
                              Case IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)
                                      When '2 Months' Then ReviewDates.TwoMonths
                                      When '3 Months' Then ReviewDates.ThreeMonths
                                      When '6 Months' Then ReviewDates.SixMonths
                                      Else
                                          Case
                                                When IsDate(IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)) = 1 Then
                                                      IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)
                                          End
                                    End
                  End [TimescaleForCompletion],

                  CASE WHEN s.PriorityAssessment = 1 THEN 0 ELSE 1 END [IsMAOnly],

                  LTrim(
                        Cast(IsNull(e26.ElementText, '') as varchar(Max)) + ' ' +
                        Cast(IsNull(e3.ElementText, '') as varchar(Max)) + ' ' +
                        Cast(IsNull(e4.ElementText, '') as varchar(Max))
                  ) [Quantity],
                  e31.ElementText [Comments],
                  Cast(Case When IsNull(e48.ElementIntMeaningId,0) = 121 Then 1 Else 0 End as bit) [Removed]
            From
                  @SampleData s
                  Outer Apply
                  (
                        Select
                              DateAdd(m,  2, Cast(Max(RegisterFinish) as date)) as TwoMonths,
                              DateAdd(m,  3, Cast(Max(RegisterFinish) as date)) as ThreeMonths,
                              DateAdd(m,  6, Cast(Max(RegisterFinish) as date)) as SixMonths,
                              DateAdd(m, 12, Cast(Max(RegisterFinish) as date)) as TwelveMonths
                        From @SampleData
                  ) as ReviewDates
                  LEFT JOIN SampleResult sr WITH (NOLOCK) On s.SampleResultId = sr.SampleResultId 
                  LEFT JOIN SampleClassification sc WITH (NOLOCK) On s.SampleClassificationId = sc.SampleClassificationID

                  -- Source Description
                  LEFT JOIN @ElementData e2 On s.SampleID = e2.SampleID AND e2.ElementTypeID = 2

                  -- Level of Identification
                  LEFT JOIN @ElementData e5 On s.SampleID = e5.SampleID AND e5.ElementTypeID = 5

                  -- Reinspection State
                  LEFT JOIN @ElementData e48 On s.SampleID = e48.SampleID AND e48.ElementTypeID = 48

                  -- Date of Next Review Override
                  LEFT JOIN @ElementData e27 On s.SampleID = e27.SampleID AND e27.ElementTypeID = 27

                  -- Management Option
                  LEFT JOIN @ElementData e22 On s.SampleID = e22.SampleID AND e22.ElementTypeID = 22

                  -- Timescale for Completion
                  LEFT JOIN @ElementData e24 On s.SampleID = e24.SampleID AND e24.ElementTypeID = 24

                  -- Asbestos Type
                  LEFT JOIN @ElementData e8 On s.SampleID = e8.SampleID AND e8.ElementTypeID = 8

                  -- Recommended Action
                  LEFT JOIN @ElementData e20 On s.SampleID = e20.SampleID AND e20.ElementTypeID = 20
                  LEFT JOIN RecommendedActionColour rac WITH (NOLOCK) On e20.ElementIntID = rac.ElementIntValue

                  -- Classification Score
                  LEFT JOIN @ElementData e6 On s.SampleID = e6.SampleID AND e6.ElementTypeID = 6
                  LEFT JOIN SampleClassification sc2 WITH (NOLOCK) On sc2.Score = e6.ElementIntID And sc2.SampleClassificationId Between 1 And 7

                  -- Quantity
                  LEFT JOIN @ElementData e26 On s.SampleId = e26.SampleId AND e26.ElementTypeId = 26
                  LEFT JOIN @ElementData e3 On s.SampleId = e3.SampleId AND  e3.ElementTypeId = 3
                  LEFT JOIN @ElementData e4 On s.SampleId = e4.SampleId AND  e4.ElementTypeId = 4

                  -- Comments
                  LEFT JOIN @ElementData e31 On s.SampleId = e31.SampleId AND e31.ElementTypeId = 31

                  LEFT JOIN @ElementData e7 On e7.SampleID = s.SampleID And e7.ElementTypeID = 7

                  -- Material Assessment Score
                        -- Damage/Detoriation
                        LEFT JOIN @ElementData e9 On s.SampleID = e9.SampleID AND e9.ElementTypeID = 9
                        -- Surface Treatment
                        LEFT JOIN @ElementData e10 On s.SampleID = e10.SampleID AND e10.ElementTypeID = 10

                  -- Priority Assessment Score
                        -- Occupant Activity
                        LEFT JOIN @ElementData e11 On s.SampleID = e11.SampleID AND e11.ElementTypeID = 11

                  -- Disturbance Score
                        -- Location Score
                        LEFT JOIN @ElementData e12 On s.SampleID = e12.SampleID AND e12.ElementTypeID = 12
                        -- Vulnerability Score
                        LEFT JOIN @ElementData e13 On s.SampleID = e13.SampleID AND e13.ElementTypeID = 13
                        -- Quantity Score
                        LEFT JOIN @ElementData e14 On s.SampleID = e14.SampleID AND e14.ElementTypeID = 14

                  -- ExposureScore
                        -- No. of Occupants
                        LEFT JOIN @ElementData e15 On s.SampleID = e15.SampleID AND e15.ElementTypeID = 15
                        -- Frequency of Use
                        LEFT JOIN @ElementData e16 On s.SampleID = e16.SampleID AND e16.ElementTypeID = 16
                        -- Average Time Area is in Use
                        LEFT JOIN @ElementData e17 On s.SampleID = e17.SampleID AND e17.ElementTypeID = 17

                  -- MaintenanceScore
                        -- Type of Maintenance
                        LEFT JOIN @ElementData e18 On s.SampleID = e18.SampleID AND e18.ElementTypeID = 18
                        -- Frequency of Maintenance
                        LEFT JOIN @ElementData e19 On s.SampleID = e19.SampleID AND e19.ElementTypeID = 19
      ),
      SamplesComputed2 as
      (
            Select
                  j.JobId,
                  j.SiteId,
                  j.ClientId,
                  SampleId,
                  SampleRef,
                  SourceDescription,
                  Case
                        When SampleResult = 0 Or Removed = 1 Then
                              'No further action required'
                        Else
                              RecommendedAction
                  End as RecommendedAction,
                  Case
                        When AsbestosType = '(0) no asbestos detected' Or Removed = 1 Then
                              '92A0F4'
                        Else
                              RecommendedActionColour
                  End as RecommendedActionColour,
                  Case
                        When SampleResult = 0 Or Removed = 1 Then
                              0-- Doesn't matter as we're not using the Rec. Action Sort Order is not used on the portal.
                        Else
                              RecommendedActionSortOrder
                  End as RecommendedActionSortOrder,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then
                                          -- MA Score
                                          MaterialAssessmentScore + 
                                          SampleResult + 
                                          ClassificationValue
                                    Else
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue
                              End
                  End as MaterialAssessmentScore,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 AND IsMAOnly = 0 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then                                                  
                                          -- PA Score
                                          LocationScore + 
                                          VulnerabilityScore + 
                                          QuantityScore +
                                          NoOfOccupants

                                    When @CompanyName = 'G & L Consultancy Ltd' And @BranchName = 'Northern Ireland' Then
                                          -- PA Score
                                          OccupantActivity +
                                                -- Disturbance Score
                                                Round(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3, 0) +
                                                -- ExposureScore
                                                Round(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3, 0) +
                                                -- MaintenanceScore
                                                Round(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2, 0)
                                    Else
                                          -- PA Score
                                          OccupantActivity +
                                                -- Disturbance Score
                                                Ceiling(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3) +
                                                -- ExposureScore
                                                Ceiling(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3) +
                                                -- MaintenanceScore
                                                Ceiling(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2)
                              End
                  End as PriorityAssessmentScore,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then
                                          -- MA Score
                                          MaterialAssessmentScore + 
                                          SampleResult + 
                                          ClassificationValue +

                                          -- PA Score
                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  LocationScore + 
                                                  VulnerabilityScore + 
                                                  QuantityScore +
                                                  NoOfOccupants
                                              ELSE 0
                                          END

                                    When @CompanyName = 'G & L Consultancy Ltd' And @BranchName = 'Northern Ireland' Then
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue +

                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  -- PA Score
                                                  OccupantActivity +
                                                  -- Disturbance Score
                                                  Round(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3, 0) +
                                                  -- ExposureScore
                                                  Round(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3, 0) +
                                                  -- MaintenanceScore
                                                  Round(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2, 0)
                                              ELSE 0
                                          END
                                    Else        
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue +

                                          -- PA Score
                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  OccupantActivity +
                                                  -- Disturbance Score
                                                  Ceiling(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3) +
                                                  -- ExposureScore
                                                  Ceiling(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3) +
                                                  -- MaintenanceScore
                                                  Ceiling(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2)
                                              ELSE 0
                                          END
                              End
                  End as RiskScore,
                  SampleResult,
                  AsbestosType,
                  Classification,
                  ClassificationScore,
                  ClassificationValue,
                  ReviewDate,
                  TimescaleForCompletion,
                  IsMAOnly,
                  Quantity,
                  Comments,
                  Removed
            From
                  SamplesComputed s WITH (NOLOCK)
                  Inner Join Job j WITH (NOLOCK) On @JobID = j.JobId
                  Inner Join Client c WITH (NOLOCK) On j.ClientId = c.ClientId
      )

      -- Run the main SQL to INSERT the data.
      INSERT INTO SampleComputedData (ClientId, SiteId, JobId, SampleId, SourceDescription, PriorityAssessmentScore, MaterialAssessmentScore, SampleResult, AsbestosType, Classification, ClassificationScore, ClassificationScoreValue, ReviewDate, TimescaleForCompletion, RecommendedAction, RecommendedActionColour, RecommendedActionSortOrder, RiskScore, RiskScoreGroupId, RiskScoreGroup, RiskScoreGroupColour, RiskScoreSortOrder, IsMAOnly, Quantity, Comments, Removed, DateCreated)
      Select
            s.ClientId,
            s.SiteId,
            s.JobID,
            s.SampleID,
            s.SourceDescription,

            s.PriorityAssessmentScore,
            s.MaterialAssessmentScore,

            s.SampleResult,
            s.AsbestosType,

            s.Classification,
            s.ClassificationScore,
            s.ClassificationValue,
            s.ReviewDate,
            s.TimescaleForCompletion,
            RecommendedAction,
            RecommendedActionColour,
            RecommendedActionSortOrder,
            s.RiskScore,

            Coalesce(rsbc.RiskScoreGroupId, rsb.RiskScoreGroupId, rsbcMA.RiskScoreGroupId, rsbMA.RiskScoreGroupId) [RiskScoreGroupId],
            Coalesce(rsbc.ScoreGroup, rsb.ScoreGroup, rsbcMA.ScoreGroup, rsbMA.ScoreGroup) [RiskScoreGroup],
            Coalesce(rsbc.Colour, rsb.Colour, rsbcMA.Colour, rsbMA.Colour) [RiskScoreGroupColour],
            Coalesce(rsbc.SortOrder, rsb.SortOrder, rsbcMA.SortOrder, rsbMa.SortOrder) [SortOrder],

            s.IsMAOnly,
            s.Quantity,
            s.Comments,
            s.Removed,
            GETDATE() [DateCreated]
      From
            SamplesComputed2 s

            -- MA & PA with client specific risk.
            LEFT JOIN RiskScore rsc WITH (NOLOCK) On Cast(s.RiskScore as int) = rsc.RiskScore And rsc.ClientId = s.ClientId And s.IsMAOnly = 0
            LEFT JOIN RiskScoreGroup rsbc WITH (NOLOCK) On rsc.RiskScoreGroupId = rsbc.RiskScoreGroupId

            -- MA & PA with default specific risk.
            LEFT JOIN RiskScore rs WITH (NOLOCK) On Cast(s.RiskScore as int) = rs.RiskScore And rs.ClientId Is Null And s.IsMAOnly = 0
            LEFT JOIN RiskScoreGroup rsb WITH (NOLOCK) On rs.RiskScoreGroupId = rsb.RiskScoreGroupId

            -- MA Only with client specific risk.
            LEFT JOIN RiskScoreMAOnly rscMA WITH (NOLOCK) On s.MaterialAssessmentScore = rscMA.MaterialAssessmentScore And rscMA.ClientId = s.ClientId And s.IsMAOnly = 1
            LEFT JOIN RiskScoreGroup rsbcMA WITH (NOLOCK) On rscMA.RiskScoreGroupId = rsbcMA.RiskScoreGroupId

            -- MA Only with default specific risk.
            LEFT JOIN RiskScoreMAOnly rsMA WITH (NOLOCK) On s.MaterialAssessmentScore = rsMA.MaterialAssessmentScore And rsMA.ClientId Is Null And s.IsMAOnly = 1
            LEFT JOIN RiskScoreGroup rsbMA WITH (NOLOCK) On rsMA.RiskScoreGroupId = rsbMA.RiskScoreGroupId
    ORDER BY
        s.SampleID


    SET NOCOUNT OFF;
END
GO
ALTER PROCEDURE [dbo].[PopulateGuidSamples]
    @ClientId INT,
    @SiteId INT
AS
BEGIN
    SET NOCOUNT ON;
    SET ANSI_WARNINGS OFF;


      Delete GuidSamples
      Where
            ClientId = @ClientId
                  And
            SiteId = @SiteId;

      With Registers As
      (
            Select
                  reg.RegisterId,
                  reg.Guid,
                  reg.GuidVersion
            From
                  Job j WITH (NOLOCK)
                  Inner Join JobEmployee je WITH (NOLOCK) On je.JobId = j.JobId
                  Inner Join Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
            Where
                  j.ClientId = @ClientId
                        And
                  j.SiteId = @SiteId
                        And
                  j.JobId In (Select JobId From SampleComputedData WITH (NOLOCK))
      ),
      GuidRegisters As
      (
            Select 
                  reg.RegisterId
            From
                  Registers reg -- CTE
                  Inner Join
                  (
                        Select
                              Guid,
                              Max(GuidVersion) as GuidVersion
                        From
                              Registers -- CTE
                        Group By
                              Guid
                  ) g On
                              (
                                    reg.Guid = g.Guid
                                          And
                                    reg.GuidVersion = g.GuidVersion
                              )
                                    Or
                              (
                                    reg.Guid Is Null
                                          And
                                    g.Guid Is Null
                              )
      ),
    Floorplans AS
    (
        SELECT
            f.FloorplanID,
            f.GUID,
            f.GUIDVersion
        FROM
            Registers r -- CTE
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
    ),
    GuidFloorplans AS
    (
        SELECT
            f.FloorplanID
        FROM
            Floorplans f -- CTE
            INNER JOIN (
                SELECT
                    GUID,
                    MAX(GUIDVersion) [GUIDVersion]
                FROM
                    Floorplans -- CTE
                GROUP BY
                    GUID
            ) fg ON
                (
                    f.GUID = fg.GUID
                        AND
                    f.GUIDVersion = fg.GUIDVersion
                )
                    OR
                (
                    f.GUID IS NULL
                        AND
                    fg.GUID IS NULL
                )
    ),
    Rooms AS
    (
        SELECT
            rm.RoomID,
            rm.GUID,
            rm.GUIDVersion
        FROM
            Floorplans f -- CTE
            INNER JOIN Room rm WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
    ),
    GuidRooms AS
    (
        SELECT
            rm.RoomID
        FROM
            Rooms rm -- CTE
            INNER JOIN (
                SELECT
                    GUID,
                    MAX(GUIDVersion) [GuidVersion]
                FROM
                    Rooms -- CTE
                GROUP BY
                    GUID
            ) rmg ON
                (
                    rm.GUID = rmg.GUID
                        AND
                    rm.GUIDVersion = rmg.GUIDVersion
                )
                    OR
                (
                    rm.GUID IS NULL
                        AND
                    rmg.GUID IS NULL
                )
    ),
    Samples AS
    (
        SELECT
            s.SampleID,
            s.GUID,
            s.GUIDVersion
        FROM
            Rooms rm -- CTE
            INNER JOIN Sample s WITH (NOLOCK) ON rm.RoomID = s.RoomID
        WHERE
            s.Archived = 0
    )

      --Select * From Samples
      Insert Into GuidSamples (ClientId, SiteId, SampleId)
      Select
            @ClientId,
            @SiteId,
            s.SampleId
      From
            Samples s -- CTE
            Inner Join
            (
                  Select
                        Guid,
                        Max(GuidVersion) as GuidVersion
                  From
                        Samples -- CTE
                  Group By
                        Guid
            ) g On
                        (
                              s.Guid = g.Guid
                                    And
                              s.GuidVersion = g.GuidVersion
                        )
                              Or
                        (
                              s.Guid Is Null
                                    And
                              g.Guid Is Null
                        )


    SET NOCOUNT OFF;
    SET ANSI_WARNINGS ON;
END
GO

-- Currency table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='Currency'))
	BEGIN
		CREATE TABLE [dbo].[Currency](
			[CurrencyId] [int] IDENTITY(1,1) NOT NULL,
			[Code] [varchar](10) NOT NULL,
			[Name] [varchar](max) NOT NULL,
			[TerritoryCode] [varchar](10) NOT NULL,
			[TerritoryName] [varchar](max) NOT NULL,
		 CONSTRAINT [PK_Currency] PRIMARY KEY CLUSTERED 
		(
			[CurrencyId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'CurrencyId' AND OBJECT_ID = OBJECT_ID('Invoice'))
BEGIN
    ALTER TABLE Invoice
    ADD CurrencyId INT NULL
END
 
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ExchangeRate' AND OBJECT_ID = OBJECT_ID('Invoice'))
BEGIN
    ALTER TABLE Invoice
    ADD ExchangeRate decimal(18,12) NULL
END

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_GetJobDataForSites')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Portfolio_GetJobDataForSites] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Portfolio_GetJobDataForSites]    Script Date: 14/03/2017 15:19:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Portfolio_GetJobDataForSites]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = ''
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @Surveys BIT, @BulkSamples BIT, @AirTests BIT, @Legionella BIT, @b__onlyshowApprovedAirTestsOnPortal BIT, @b__PortalShowPDFsOnSitesTab BIT, @MoreThanOneSite BIT
    SELECT
		@Surveys = 1,
		@BulkSamples = 1,
		@AirTests = 1,
		@Legionella = 1,
        @b__onlyshowApprovedAirTestsOnPortal = cfg.b__onlyshowApprovedAirTestsOnPortal,
        @b__PortalShowPDFsOnSitesTab = cfg.b__PortalShowPDFsOnSitesTab,
        @MoreThanOneSite = CASE WHEN @SiteIDs IS NULL THEN 1 ELSE CASE WHEN CHARINDEX(',', @SiteIDs) > 0 THEN 1 ELSE 0 END END
    FROM
        Config cfg WITH (NOLOCK)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed. Also used by PopulateSiteJobsReinspectionState.
    CREATE TABLE #ClientIdData (ClientID INT PRIMARY KEY)
    INSERT INTO #ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    CREATE TABLE #SurveyTypeIdData (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO #SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT, UseRiskColours BIT)
    INSERT INTO @ClientSiteData (ClientID, SiteID, UseRiskColours)
    SELECT
        c.ClientID,
        si.SiteID,
        c.UseRiskColours
    FROM
        #ClientIdData cid
        INNER JOIN Client c WITH (NOLOCK) ON cid.ClientID = c.ClientID
        INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
        INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
        INNER JOIN (
            SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
        ) sis ON si.SiteID = sis.SiteID
    WHERE
        si.Deleted IS NULL
    GROUP BY
        c.ClientID,
        si.SiteID,
        c.UseRiskColours

    -- Get Job/Appointment data up front to reduce table scans.
    DECLARE @JobAppointmentData TABLE (ClientID INT, SiteID INT, UseRiskColours BIT, JobID INT)
    INSERT INTO @JobAppointmentData (ClientID, SiteID, UseRiskColours, JobID)
    SELECT
        csd.ClientID,
        csd.SiteID,
        csd.UseRiskColours,
        j.JobID
    FROM
        @ClientSiteData csd
        INNER JOIN Job j WITH (NOLOCK) ON csd.ClientID = j.ClientID AND csd.SiteID = j.SiteID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
        LEFT JOIN AppointmentAirMonitoring aam WITH (NOLOCK) ON a.AppointmentID = aam.AppointmentID
    WHERE
        a.DateDeclined IS NULL
            AND
        j.Cancelled IS NULL
            AND
        (j.Approved IS NOT NULL OR (j.Approved IS NULL AND aam.AppointmentAirMonitoringID IS NOT NULL))
    GROUP BY
        csd.ClientID,
        csd.SiteID,
        csd.UseRiskColours,
        j.JobID

    -- Get all Site Jobs up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #SiteJobs (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(10), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)

    -- Add an index on important #SiteJobs fields to increase speed below.
    CREATE INDEX temp_SiteJobs ON #SiteJobs (SiteID)

    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, RegisterFinish [MaxRegisterFinish]
    FROM
    (
        SELECT
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.Post2000 [SitePost2000],
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.RegisterFinish DESC, jd.JobID DESC) [RowID]
        FROM
            @ClientSiteData csd
            INNER JOIN (
                SELECT
                    a.*,
                    ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.RegisterFinish DESC, a.JobID DESC) [RowID]
                FROM
                (
                    SELECT 0 [IsSiteDocument], jad.ClientID, jad.SiteID, jad.JobID, r.RegisterFinish
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                    UNION ALL
                    SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [RegisterFinish]
                    FROM
                        SiteDocument sid WITH (NOLOCK)
                        INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                    WHERE
                        sid.SiteDocumentTypeID = 3 -- Surveys
                            AND
                        sid.Deleted IS NULL
                ) a
            ) jd ON
                CASE WHEN jd.IsSiteDocument = 1
                    THEN -1
                    ELSE csd.ClientID
                END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        GROUP BY
            si.SiteID,
            si.Address,
            si.Postcode,
            si.Post2000,
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            jd.RowID
    ) a
    WHERE a.RowID = 1
    GROUP BY
        a.SiteID,
        a.SiteAddress,
        a.SitePostcode,
        a.SitePost2000,
        a.UnmanagedSite,
        a.IsSiteDocument,
        a.JobID,
        a.RegisterFinish,
        a.RowID
    ORDER BY
        a.SiteID

    -- Execute the SPROC PopulateSiteJobsReinspectionState. This populates additional columns in #SiteJobs, so it assumes #SiteJobs already exists.
    EXEC Portfolio_PopulateSiteJobsReinspectionState


    -- Start the main SELECT.
    SELECT
        csd.SiteID,
        ISNULL(SUM(o.SurveyJobCount), 0) [SurveyJobCount], -- How many Survey's against the current Site? That is Approved, appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.SurveyDocCount), 0) [SurveyDocCount], -- How many Survey Site Docs are there for the current Site?
        ISNULL(SUM(o.ManagementPlanCount), 0) [ManagementPlanCount], -- How many Management Plans are there for the current Site?
        ISNULL(SUM(o.BulkSampleCertificateCount), 0) [BulkSampleCertificateCount], -- How many Bulk Sample Report's against the current Site (either as part of a Survey or a standalone)? That is Approved, quote not rejected, etc.
        ISNULL(SUM(o.BulkSampleDocCount), 0) [BulkSampleDocCount], -- How many Bulk Sample Site Docs are there for the current Site?
        ISNULL(SUM(o.AirTestCount), 0) [AirTestCount], -- How many Air test's against the current Site? That is Approved (if config @b__onlyshowApprovedAirTestsOnPortal is true), appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.AirTestDocCount), 0) [AirTestDocCount], -- How many Air Test Site Docs are there for the current Site?
        ISNULL(SUM(o.LegionellaJobCount), 0) [LegionellaJobCount], -- How many Legionella's against the current Site? That is Approved, appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.LegionellaDocCount), 0) [LegionellaDocCount], -- How many Legionella Site Docs are there for the current Site?
        MAX(o.SurveyJobFileName) [SurveyJobFileName], -- If the job has 1 Survey, get the PDF File Name for it.
        MAX(o.SurveySiteDocumentID) [SurveySiteDocumentID], -- Get the latest Survey Site Document.
        MAX(o.SurveyDocFileName) [SurveyDocFileName], -- If the job has 1 Survey Site Document, get it.
        MAX(o.ManagementPlanSiteDocumentID) [ManagementPlanSiteDocumentID], -- Get the latest Site Document Management Plan.
        MAX(o.ManagementPlanFileName) [ManagementPlanFileName], -- If the job has 1 Management Plan, get it.
        MAX(o.BulkSampleJobFileName) [BulkSampleJobFileName], -- If the job has 1 BSR, get the PDF File Name for it.
        MAX(o.BulkSampleSiteDocumentID) [BulkSampleSiteDocumentID], -- Get the latest Bulk Sample Site Document.
        MAX(o.BulkSampleDocFileName) [BulkSampleDocFileName], -- If the job has 1 Bulk Sample Site Document, get it.
        MAX(o.AirTestJobFileName) [AirTestJobFileName], -- If the job has 1 Air Test, get the PDF File Name for it.
        MAX(o.AirTestSiteDocumentID) [AirTestSiteDocumentID], -- Get the latest Air Test Site Document.
        MAX(o.AirTestDocFileName) [AirTestDocFileName], -- If the job has 1 Air Test Site Document, get it.
        MAX(o.LegionellaJobFileName) [LegionellaJobFileName], -- If the job has 1 Legionella job, get the PDF File Name for it.
        MAX(o.LegionellaSiteDocumentID) [LegionellaSiteDocumentID], -- Get the latest Legionella Site Document.
        MAX(o.LegionellaDocFileName) [LegionellaDocFileName], -- If the job has 1 Legionella Site Document, get it.
        MAX(o.ExternalPhotoID) [ExternalPhotoID], -- Get the ExternalPhotoID of a photo that has data. Attempt to get a normal Register/Legionella record PhotoID.
        MAX(o.SurveyJobID) [SurveyJobID], -- The JobID of the latest Survey on the Site (previously ordered by RegisterFinish DESC).
        MIN(o.SurveyReinspectionDate) [SurveyReinspectionDate], -- The first Reinspection Date of the latest Survey at the Site.
        MAX(o.SurveySampleResultsOverview) [SurveySampleResultsOverview] -- The Sample Results Overview of the Site.
    FROM
        @ClientSiteData csd
        INNER JOIN
        (
            SELECT -- Surveys
                su.SiteID,
                su.SurveyJobCount,
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                su.ExternalPhotoID,
                su.JobID [SurveyJobID],
                CASE WHEN @Surveys = 1 AND (su.SurveyJobCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN (
                        SELECT TOP 1 _pf.FileName
                        FROM PDF _pf WITH (NOLOCK)
                        WHERE
                            _pf.JobID = su.JobID
                                AND
                            _pf.DateDeleted IS NULL
                                AND
                            _pf.FileName NOT LIKE '%bsr%'
                                AND
                            _pf.FileName NOT LIKE '%ra%'
                                AND
                            _pf.FileName NOT LIKE '%asb5%'
                        ORDER BY
                            _pf.DateCreated DESC
                    )
                    ELSE NULL
                END [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [SurveyJobCount],
                    MAX(mep.ExternalPhotoID) [ExternalPhotoID],
                    MAX(main.JobID) [JobID]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        su.SurveyTypeID
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                ) main
                OUTER APPLY
                (
                    SELECT TOP 1 p.PhotoID [ExternalPhotoID]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                        INNER JOIN Photo p WITH (NOLOCK) ON r.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
                    WHERE
                        jad.SiteID = main.SiteID
                    ORDER BY
                        r.MainExternalPhoto DESC,
                        p.PhotoNo DESC,
                        p.PhotoID DESC
                ) mep
                GROUP BY
                    main.SiteID
            ) su
            UNION ALL
            SELECT  -- Bulk Samples
                bsr.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                bsr.BSRCount [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                CASE WHEN @BulkSamples = 1 AND (bsr.BSRCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN bsr.FileName
                    ELSE NULL
                END [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [BSRCount],
                    MAX(main.FileName) [FileName]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        bsr.PDFId,
                        bsr.FileName
                    FROM
                        @JobAppointmentData jad
                        OUTER APPLY
                        (
                            SELECT TOP 1 _pf.PdfID, _pf.FileName
                            FROM PDF _pf WITH (NOLOCK)
                            WHERE
                                _pf.JobID = jad.JobID
                                    AND
                                _pf.DateDeleted IS NULL
                                    AND
                                _pf.FileName LIKE '%bsr%'
                            ORDER BY
                                _pf.DateCreated DESC
                        ) bsr
                    WHERE
                        bsr.PDFId IS NOT NULL
                ) main
                GROUP BY
                    main.SiteID
            ) bsr
            UNION ALL
            SELECT -- Air Tests
                at.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                at.AirTestCount,
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                CASE WHEN @AirTests = 1 AND (at.AirTestCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN at.FileName
                    ELSE NULL
                END [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.AirTestID) [AirTestCount],
                    MAX(main.FileName) [FileName]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        at.AirTestID,
                        pf.FileName
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Airtest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                        OUTER APPLY
                        (
                            SELECT TOP 1 _pf.FileName
                            FROM PDF _pf WITH (NOLOCK)
                            WHERE
                                _pf.JobID = jad.JobID
                                    AND
                                _pf.DateDeleted IS NULL
                                    AND
                                _pf.FileName NOT LIKE '%bsr%'
                                    AND
                                _pf.FileName NOT LIKE '%ra%'
                                    AND
                                _pf.FileName NOT LIKE '%asb5%'
                                    AND
                                _pf.FileName LIKE '%\_' + CAST(at.AirTestID AS VARCHAR(20)) + ' (%' ESCAPE '\'
                            ORDER BY
                                _pf.DateCreated DESC
                        ) pf
                    WHERE
                        CASE WHEN @b__onlyshowApprovedAirTestsOnPortal = 1
                            THEN at.OfficeApproved
                            ELSE 1
                        END = 1
                ) main
                GROUP BY
                    main.SiteID
            ) at
            UNION ALL
            SELECT -- Legionella
                l.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                l.LegionellaJobCount,
                NULL [LegionellaDocCount],
                l.ExternalPhotoID,
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                CASE WHEN @Legionella = 1 AND (l.LegionellaJobCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN (
                        SELECT TOP 1 _pf.FileName
                        FROM PDF _pf WITH (NOLOCK)
                        WHERE
                            _pf.JobID = l.JobID
                                AND
                            _pf.DateDeleted IS NULL
                                AND
                            _pf.FileName NOT LIKE '%bsr%'
                                AND
                            _pf.FileName NOT LIKE '%ra%'
                                AND
                            _pf.FileName NOT LIKE '%asb5%'
                        ORDER BY
                            _pf.DateCreated DESC
                        )
                    ELSE NULL
                END [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [LegionellaJobCount],
                    MAX(main.JobID) [JobID],
                    MAX(main.ExternalPhotoID) [ExternalPhotoID]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        p.PhotoID [ExternalPhotoID]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID AND l.DateApproved IS NOT NULL
                        LEFT JOIN Photo p WITH (NOLOCK) ON l.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
                ) main
                GROUP BY
                    main.SiteID
            ) l
            UNION ALL
            SELECT -- Site Documents with a Type
                sid.SiteID,
                NULL [SurveyJobCount],
                sid.SurveyDocCount,
                sid.ManagementPlanCount,
                NULL [BulkSampleCertificateCount],
                sid.BulkSampleDocCount,
                NULL [AirTestCount],
                sid.AirTestDocCount,
                NULL [LegionellaJobCount],
                sid.LegionellaDocCount,
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                CASE WHEN @Surveys = 1 AND (sid.SurveyDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.SurveySiteDocumentID
                    ELSE NULL
                END [SurveySiteDocumentID],
                CASE WHEN @Surveys = 1 AND (sid.SurveyDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.SurveyDocFileName
                    ELSE NULL
                END [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                CASE WHEN @Surveys = 1 AND (sid.ManagementPlanCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.ManagementPlanSiteDocumentID
                    ELSE NULL
                END [ManagementPlanSiteDocumentID],
                CASE WHEN @Surveys = 1 AND (sid.ManagementPlanCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.ManagementPlanFileName
                    ELSE NULL
                END [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                CASE WHEN @BulkSamples = 1 AND (sid.BulkSampleDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.BulkSampleSiteDocumentID
                    ELSE NULL
                END [BulkSampleSiteDocumentID],
                CASE WHEN @BulkSamples = 1 AND (sid.BulkSampleDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.BulkSampleDocFileName
                    ELSE NULL
                END [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                CASE WHEN @AirTests = 1 AND (sid.AirTestDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.AirTestSiteDocumentID
                    ELSE NULL
                END [AirTestSiteDocumentID],
                CASE WHEN @AirTests = 1 AND (sid.AirTestDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.AirTestDocFileName
                    ELSE NULL
                END [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                CASE WHEN @Legionella = 1 AND (sid.LegionellaDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.LegionellaSiteDocumentID
                    ELSE NULL
                END [LegionellaSiteDocumentID],
                CASE WHEN @Legionella = 1 AND (sid.LegionellaDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.LegionellaDocFileName
                    ELSE NULL
                END [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.SurveySiteDocumentID) [SurveyDocCount],
                    MAX(main.SurveySiteDocumentID) [SurveySiteDocumentID],
                    MAX(main.SurveyFileName) [SurveyDocFileName],
                    COUNT(DISTINCT main.ManagementPlanSiteDocumentID) [ManagementPlanCount],
                    MAX(main.ManagementPlanSiteDocumentID) [ManagementPlanSiteDocumentID],
                    MAX(main.ManagementPlanFileName) [ManagementPlanFileName],
                    COUNT(DISTINCT main.BulkSampleSiteDocumentID) [BulkSampleDocCount],
                    MAX(main.BulkSampleSiteDocumentID) [BulkSampleSiteDocumentID],
                    MAX(main.BulkSampleFileName) [BulkSampleDocFileName],
                    COUNT(DISTINCT main.AirTestSiteDocumentID) [AirTestDocCount],
                    MAX(main.AirTestSiteDocumentID) [AirTestSiteDocumentID],
                    MAX(main.AirTestFileName) [AirTestDocFileName],
                    COUNT(DISTINCT main.LegionellaSiteDocumentID) [LegionellaDocCount],
                    MAX(main.LegionellaSiteDocumentID) [LegionellaSiteDocumentID],
                    MAX(main.LegionellaFileName) [LegionellaDocFileName]
                FROM
                (
                    SELECT
                        csd.SiteID,
                        suSid.SiteDocumentID [SurveySiteDocumentID],
                        suSid.FileName [SurveyFileName],
                        mPlanSid.SiteDocumentID [ManagementPlanSiteDocumentID],
                        mPlanSid.FileName [ManagementPlanFileName],
                        bsrSid.SiteDocumentID [BulkSampleSiteDocumentID],
                        bsrSid.FileName [BulkSampleFileName],
                        atSid.SiteDocumentID [AirTestSiteDocumentID],
                        atSid.FileName [AirTestFileName],
                        lSid.SiteDocumentID [LegionellaSiteDocumentID],
                        lSid.FileName [LegionellaFileName]
                    FROM
                        @ClientSiteData csd
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 3
                        ) suSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 2
                        ) mPlanSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 4
                        ) bsrSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 5
                        ) atSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 6
                        ) lSid
                ) main
                WHERE
                    main.SurveySiteDocumentID IS NOT NULL OR main.ManagementPlanSiteDocumentID IS NOT NULL OR main.BulkSampleSiteDocumentID IS NOT NULL OR main.AirTestSiteDocumentID IS NOT NULL OR main.LegionellaSiteDocumentID IS NOT NULL
                GROUP BY
                    main.SiteID
            ) sid
            UNION ALL
            SELECT -- Survey Sample Results Overview HTML and Reinspection Dates
                ssro.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                ssro.ReinspectionDate [SurveyReinspectionDate],
                ssro.SampleResultsOverview [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    MIN(main.ReinspectionDate) [ReinspectionDate],
                    MAX(main.SampleResultsOverview) [SampleResultsOverview]
                FROM
                (
                    SELECT
                        sj.SiteID,
                        sj.ReinspectionDate,
                        CASE WHEN jad.UseRiskColours = 1
                            THEN ssros.RiskSampleResultsOverview
                            ELSE ssros.RecommendedActionSampleResultsOverview
                        END [SampleResultsOverview]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN #SiteJobs sj ON jad.SiteID = sj.SiteID
                        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON jad.ClientID = ssros.ClientID AND jad.SiteID = ssros.SiteID
                ) main
                GROUP BY
                    main.SiteID
            ) ssro
        ) o ON csd.SiteID = o.SiteID
    GROUP BY
        csd.SiteID
    ORDER BY
        csd.SiteID


    -- Clear up temp tables.
    DROP TABLE #ClientIdData
    DROP TABLE #SurveyTypeIdData
    DROP TABLE #SiteJobs


    SET NOCOUNT OFF;
END
GO

-- AppointmentAirMonitoring - Now allow them to select a Sample Result and multiple classifications.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE Name = N'SampleResultID' AND Object_ID = Object_ID(N'AppointmentAirMonitoring'))
BEGIN
    ALTER TABLE AppointmentAirMonitoring
    ADD SampleResultID INT NULL
END
IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'AppointmentAirMonitoringSampleClassification')
BEGIN
    CREATE TABLE [dbo].[AppointmentAirMonitoringSampleClassification](
        [AppointmentAirMonitoringSampleClassificationID] [int] IDENTITY(1,1) NOT NULL,
        [AppointmentAirMonitoringID] [int] NOT NULL,
        [SampleClassificationID] [int] NOT NULL,
    CONSTRAINT [PK_AppointmentAirMonitoringSampleClassification] PRIMARY KEY CLUSTERED 
    (
        [AppointmentAirMonitoringSampleClassificationID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]
END
GO

-- Portal Super User
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'SuperUser' AND object_id = OBJECT_ID('PortalUser'))
BEGIN
    ALTER TABLE PortalUser
    ADD SuperUser BIT NOT NULL DEFAULT 0
END
GO

-- Insert a portal super user
IF NOT EXISTS(SELECT * FROM PortalUser WHERE [Company]='Super User' AND [FullName]='Super User' AND [SuperUser]=1)
BEGIN
	INSERT INTO [dbo].[PortalUser] ([Company],[FullName],[Email],[Password],[Enabled],[Diary],[Quotes],[Surveys]
		,[Projects],[AirTests],[Removals],[BulkSamples],[Invoices],[Sites],[Activity],[Created],[FailedLoginAttempts]
		,[UseSiteGroups],[ProjectGroupId],[ProjectId],[AccessGUID],[PremiumUser],[CookieAccess],[PortalAdministrator]
		,[Legionella],[Training],[Maps],[Home],[Glance],[TotalComplianceChart],[LegTotalComplianceChart],[SitesSurveyedChart]
		,[RiskItemsChart],[LegRiskItemsChart],[RecommendedActionItemsChart],[TargetTimescalesChart],[TrainingComplianceChart]
		,[LegLowUseOutletsChart],[LegOutletsOutOfSpecChart],[SuperUser])
	VALUES
		('Super User','Super User','superuser@m1c.co.uk',(SELECT Password FROM Employee WHERE Username='swetherell'),1,1,1,1,1
		,1,1,1,1,1,1,GETDATE(),0,1,0,0,NEWID(),1,NEWID(),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_MyRisksAsbestos')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_MyRisksAsbestos] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[Paged_MyRisksAsbestos]    Script Date: 21/03/2017 16:40:12 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Paged_MyRisksAsbestos]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	-- From original portal SP
    @Risk VARCHAR(100) = '',
    @RecAction VARCHAR(100) = ''

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;

    -- Set variables for logic.
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = ISNULL(NULLIF(cfg.s__BasementName, ''), 'Z-Sub Level')
    FROM
        Config cfg WITH (NOLOCK)

	DECLARE @ListView TABLE (JobNo INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(50),Building VARCHAR(1000),FloorNumber INT,
								FloorDescription VARCHAR(MAX),RoomCode VARCHAR(MAX),RoomNumber INT,RoomDescription VARCHAR(50),
								RegisterItemNo INT,AsSample BIT,SampleRef VARCHAR(50),SourceDescription NVARCHAR(MAX),AsbestosType NVARCHAR(MAX),
								MaterialAssessmentScore INT,PriorityAssessmentScore INT,RiskScore INT,RiskScoreGroupColour VARCHAR(10),
								RecommendedAction NVARCHAR(100),RecommendedActionColour VARCHAR(6),TimescaleForCompletion VARCHAR(MAX),
								SurveyTypeID INT,JobID INT,SampleID INT,IsMAOnly BIT,SurveyStartDate DATE,SurveyFinishDate DATE)

	INSERT INTO @ListView (JobNo,Address,Postcode,UPRN,Building,FloorNumber,
							FloorDescription,RoomCode,RoomNumber,RoomDescription,
							RegisterItemNo,AsSample,SampleRef,SourceDescription,AsbestosType,
							MaterialAssessmentScore,PriorityAssessmentScore,RiskScore,RiskScoreGroupColour,
							RecommendedAction,RecommendedActionColour,TimescaleForCompletion,
							SurveyTypeID,JobID,SampleID,IsMAOnly,SurveyStartDate,SurveyFinishDate)
	SELECT DISTINCT
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        ISNULL(r.BuildingDesignation, 'No Building Designation') [Building],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorDescription],
        rm.RoomCode,
        rm.Number [RoomNumber],
        rm.Description [RoomDescription],
        s.RegisterItemNo,
        s.AsSample,
        s.SampleRef,
        scd.SourceDescription,
        scd.AsbestosType,
        scd.MaterialAssessmentScore,
        scd.PriorityAssessmentScore,
        scd.RiskScore,
        scd.RiskScoreGroupColour,
        scd.RecommendedAction,
        scd.RecommendedActionColour,
        DATENAME(MONTH, scd.TimescaleForCompletion) + ' ' + CAST(DATEPART(YEAR, scd.TimescaleForCompletion) AS VARCHAR(4)) [TimescaleForCompletion],
        su.SurveyTypeID,
        j.JobID,
        s.SampleID,
        scd.IsMAOnly,
        CAST(r.RegisterStart AS DATE) [SurveyStartDate],
        CAST(r.RegisterFinish AS DATE) [SurveyFinishDate]
    FROM
        GuidSamples gs WITH (NOLOCK) 
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON gs.SampleID = scd.SampleID AND gs.ClientID = scd.ClientID AND gs.SiteID = scd.SiteID
        INNER JOIN Sample s WITH (NOLOCK) ON scd.SampleID = s.SampleID
        INNER JOIN Room rm WITH (NOLOCK) ON s.RoomID = rm.RoomID
        INNER JOIN Floorplan f WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Register r WITH (NOLOCK) ON f.RegisterID = r.RegisterID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN Site si WITH (NOLOCK) ON scd.SiteID = si.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON scd.ClientID = c.ClientID
        LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
    WHERE
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
            AND
        si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this table. */
            AND
        c.ClientID = @ClientID
            AND
        scd.Removed = 0
            AND
        scd.RecommendedAction IS NOT NULL
    ORDER BY
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        Building,
        f.FloorNumber,
        rm.RoomCode,
        rm.Number,
        s.RegisterItemNo

    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@ListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @ListView
            ) a
    )

    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.JobNo,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Building,
        main.FloorNumber,
        main.FloorDescription,
        main.RoomCode,
        main.RoomNumber,
        main.RoomDescription,
        main.RegisterItemNo,
        main.AsSample,
        main.SampleRef,
        main.SourceDescription,
        main.AsbestosType,
        main.MaterialAssessmentScore,
        main.PriorityAssessmentScore,
        main.RiskScore,
        main.RiskScoreGroupColour,
        main.RecommendedAction,
        main.RecommendedActionColour,
        main.TimescaleForCompletion,
        main.SurveyTypeID,
        main.JobID,
        main.SampleID,
        main.IsMAOnly,
        main.SurveyStartDate,
        main.SurveyFinishDate
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

ALTER PROCEDURE [dbo].[Paged_MyRisksAsbestos]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	-- From original portal SP
    @Risk VARCHAR(100) = '',
    @RecAction VARCHAR(100) = ''

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;

    -- Set variables for logic.
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = ISNULL(NULLIF(cfg.s__BasementName, ''), 'Z-Sub Level')
    FROM
        Config cfg WITH (NOLOCK)

	DECLARE @ListView TABLE (JobNo INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(50),Building VARCHAR(1000),FloorNumber INT,
								FloorDescription VARCHAR(MAX),RoomCode VARCHAR(MAX),RoomNumber INT,RoomDescription VARCHAR(50),
								RegisterItemNo INT,AsSample BIT,SampleRef VARCHAR(50),SourceDescription NVARCHAR(MAX),AsbestosType NVARCHAR(MAX),
								MaterialAssessmentScore INT,PriorityAssessmentScore INT,RiskScore INT,RiskScoreGroupColour VARCHAR(10),
								RecommendedAction NVARCHAR(100),RecommendedActionColour VARCHAR(6),TimescaleForCompletion VARCHAR(MAX),
								SurveyTypeID INT,JobID INT,SampleID INT,IsMAOnly BIT,SurveyStartDate DATE,SurveyFinishDate DATE)

	INSERT INTO @ListView (JobNo,Address,Postcode,UPRN,Building,FloorNumber,
							FloorDescription,RoomCode,RoomNumber,RoomDescription,
							RegisterItemNo,AsSample,SampleRef,SourceDescription,AsbestosType,
							MaterialAssessmentScore,PriorityAssessmentScore,RiskScore,RiskScoreGroupColour,
							RecommendedAction,RecommendedActionColour,TimescaleForCompletion,
							SurveyTypeID,JobID,SampleID,IsMAOnly,SurveyStartDate,SurveyFinishDate)
	SELECT DISTINCT
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        ISNULL(r.BuildingDesignation, 'No Building Designation') [Building],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorDescription],
        rm.RoomCode,
        rm.Number [RoomNumber],
        rm.Description [RoomDescription],
        s.RegisterItemNo,
        s.AsSample,
        s.SampleRef,
        scd.SourceDescription,
        scd.AsbestosType,
        scd.MaterialAssessmentScore,
        scd.PriorityAssessmentScore,
        scd.RiskScore,
        scd.RiskScoreGroupColour,
        scd.RecommendedAction,
        scd.RecommendedActionColour,
        DATENAME(MONTH, scd.TimescaleForCompletion) + ' ' + CAST(DATEPART(YEAR, scd.TimescaleForCompletion) AS VARCHAR(4)) [TimescaleForCompletion],
        su.SurveyTypeID,
        j.JobID,
        s.SampleID,
        scd.IsMAOnly,
        CAST(r.RegisterStart AS DATE) [SurveyStartDate],
        CAST(r.RegisterFinish AS DATE) [SurveyFinishDate]
    FROM
        GuidSamples gs WITH (NOLOCK) 
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON gs.SampleID = scd.SampleID AND gs.ClientID = scd.ClientID AND gs.SiteID = scd.SiteID
        INNER JOIN Sample s WITH (NOLOCK) ON scd.SampleID = s.SampleID
        INNER JOIN Room rm WITH (NOLOCK) ON s.RoomID = rm.RoomID
        INNER JOIN Floorplan f WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Register r WITH (NOLOCK) ON f.RegisterID = r.RegisterID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN Site si WITH (NOLOCK) ON scd.SiteID = si.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON scd.ClientID = c.ClientID
        LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
    WHERE
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
            AND
        si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this table. */
            AND
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
        scd.Removed = 0
            AND
        scd.RecommendedAction IS NOT NULL
    ORDER BY
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        Building,
        f.FloorNumber,
        rm.RoomCode,
        rm.Number,
        s.RegisterItemNo

    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@ListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @ListView
            ) a
    )

    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.JobNo,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Building,
        main.FloorNumber,
        main.FloorDescription,
        main.RoomCode,
        main.RoomNumber,
        main.RoomDescription,
        main.RegisterItemNo,
        main.AsSample,
        main.SampleRef,
        main.SourceDescription,
        main.AsbestosType,
        main.MaterialAssessmentScore,
        main.PriorityAssessmentScore,
        main.RiskScore,
        main.RiskScoreGroupColour,
        main.RecommendedAction,
        main.RecommendedActionColour,
        main.TimescaleForCompletion,
        main.SurveyTypeID,
        main.JobID,
        main.SampleID,
        main.IsMAOnly,
        main.SurveyStartDate,
        main.SurveyFinishDate
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

ALTER PROCEDURE [dbo].[Paged_SiteList] 

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0 -- (0=all)

AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX))

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

-- ======================================================
-- Author:			Lonny 
-- Create date:		28/02/2017
-- ======================================================

ALTER PROCEDURE [dbo].[Paged_SiteList] 

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0 -- (0=all)

AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX))

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END


    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            When [Log].SiteLogID Is Not null Then 'Work Started'
            Else 'Work Scheduled'
        End [Status],
        MIN(CAST(a.StartTime AS DATE)) [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        LEFT JOIN SiteLog [log] on j.JobID = log.JobID and log.Description like '%started building%'
        Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(reg.RegisterFinish) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
				-- Left Outer Join [Signature] sig WITH (NOLOCK) On reg.SignatureID = sig.SignatureID
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted,
        log.sitelogID
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC


    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'reorderRegisterItemsByJob')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[reorderRegisterItemsByJob] AS BEGIN SET NOCOUNT ON; END')
END

/****** Object:  StoredProcedure [dbo].[reorderRegisterItemsByJob]    Script Date: 04/04/2017 11:28:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- ===================================================
-- Author:		Lonny
-- Create date: 03/04/17
-- Description:	reorders register items from job level
--              taken straight from classic code
-- ===================================================

ALTER PROCEDURE [dbo].[reorderRegisterItemsByJob] @jobid int as
BEGIN

	SELECT
		[s].sampleid,
		RegisterItemNo,
		ROW_NUMBER() over(PARTITION BY [je].[JobID] ORDER BY [je].[JobID] DESC, s.DateCreated ASC) c
	INTO
		#rez
	FROM 
		Job j
		INNER JOIN JobEmployee je ON je.JobID = j.JobID
		INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
		INNER JOIN Room rm ON rm.RegisterID = r.RegisterID
		INNER JOIN [sample] s ON s.RoomID = rm.RoomID
	WHERE
		je.jobid = @jobid

	UPDATE s
		SET registeritemno = r.c
	FROM
		[Sample] s
		INNER JOIN #rez r ON r.sampleid = [s].sampleid
END 
GO

/****** Object:  StoredProcedure [dbo].[GetJobStatus]    Script Date: 04/04/2017 11:04:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END

    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            Else 'Work Scheduled'
        End [Status],
        MIN(a.StartTime) [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(reg.RegisterFinish) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC

    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO

-- b__EditRegisterUseBuildingComponents column in Config table
IF not exists(SELECT * FROM sys.columns WHERE Name=N'b__EditRegisterUseBuildingComponents' AND Object_ID=Object_ID(N'Config'))
BEGIN
    ALTER TABLE [Config] ADD [b__EditRegisterUseBuildingComponents] BIT NOT NULL
	CONSTRAINT [DF_Config_b__EditRegisterUseBuildingComponents]  DEFAULT ((1))
END
GO
ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END


    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
            WHEN na.NoAccess = 1 THEN 'No Access'
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            When [Log].SiteLogID Is Not null Then 'Work Started'
            Else 'Work Scheduled'
        End [Status],
        MIN(log.Created) [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        LEFT JOIN SiteLog [log] on j.JobID = log.JobID and log.Description like '%started building%'
            Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(reg.RegisterFinish) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete,
                MIN(reg.RegisterStart) as RegisterStart
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
        OUTER APPLY 
        (
              SELECT 
                    CASE
                          WHEN MAX(na.Created) > MAX(a.StartTime) OR (MAX(na.Created) > MAX(a.StartTime) AND MAX(na.Created) > MAX(je.Created))  --see gary for more info
                          THEN 1
                    ELSE
                          0
                    END [NoAccess]
              FROM
                    NoAccess na
                    LEFT JOIN JobEmployee je ON na.JobID = je.JobID
                    INNER JOIN Quote q ON na.JobID = q.JobID
                    INNER JOIN Appointment a ON q.QuoteID = a.QuoteID
              WHERE
                    na.JobID = j.JobID
                          and 
                    na.Deleted IS NULL 
        ) na
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted,
        log.sitelogID,
        na.NoAccess
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC


    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__EnableEnterpriseTools' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__EnableEnterpriseTools BIT NOT NULL DEFAULT 0
END
GO

/****** Object:  StoredProcedure [dbo].[GetJobStatus]    Script Date: 04/10/2017 13:37:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END

    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
                  WHEN na.NoAccess = 1 THEN 'No Access'
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
                  When reg.Samples < 1 Then 'Sample Analysis Complete'    -- new
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            When [Log].SiteLogID Is Not null Then 'Work Started'
                  Else 'Work Scheduled'
        End [Status],
        Case
                  WHEN na.NoAccess = 1 THEN na.NoAccessCreated
                  ELSE MIN(log.Created)
            End [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        LEFT JOIN SiteLog [log] on j.JobID = log.JobID and log.Description like '%started building%'
            Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(reg.RegisterFinish) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete,
                MIN(reg.RegisterStart) as RegisterStart
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
            OUTER APPLY 
            (
                  SELECT  
                        na.JobID,
                        1 [NoAccess],
                        MAX(na.Created) [NoAccessCreated]
                  FROM
                        NoAccess na
                        LEFT JOIN JobEmployee je ON na.JobID = je.JobID
                        INNER JOIN Quote q ON na.JobID = q.JobID
                        INNER JOIN Appointment a ON q.QuoteID = a.QuoteID
                  WHERE
                        na.JobID = j.JobID
                              and 
                        na.Deleted IS NULL 
                  GROUP BY
                        na.JobID
                  HAVING
                        (
                              CASE WHEN MAX(na.Created) > MAX(a.StartTime) OR (MAX(na.Created) > MAX(a.StartTime) AND MAX(na.Created) > MAX(je.Created))  THEN --see gary for more info
                                    1
                              ELSE
                                    0
                              END = 1
                        )
            ) na
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted,
        log.sitelogID,
            na.NoAccess,
            na.NoAccessCreated
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC

    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_SiteList')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_SiteList] AS BEGIN SET NOCOUNT ON; END')
END
GO

/****** Object:  StoredProcedure [dbo].[GridDetail_SiteList]    Script Date: 18/04/2017 13:45:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GridDetail_SiteList] 
      @SiteID INT
AS
BEGIN

	DECLARE @GridDetailSiteList TABLE (GridDetailSiteListID INT IDENTITY(1,1),ListType INT, JobID INT, JobNo INT, DateChanged DATE, MaxTimeChanged TIME, OriginalJobNumber VARCHAR(MAX), QuoteType VARCHAR(MAX), PDFID INT)

	INSERT INTO @GridDetailSiteList (ListType,JobID,JobNo,DateChanged,MaxTimeChanged,OriginalJobNumber,QuoteType,PDFID)
	SELECT
		1,
		j.JobID,
		j.JobNo,
		CAST(pdf.DateCreated as DATE),
		CAST(pdf.DateCreated as TIME),
		j.OriginalJobNumber,
		qt.QuoteType,
		pdf.PDFID
	FROM
		Job j
		JOIN Quote q ON q.JobID = j.JobID
		JOIN QuoteType qt ON qt.QuoteTypeID = q.QuoteTypeID
		INNER JOIN pdf ON j.JobID=pdf.JobId AND pdf.[FileName] NOT LIKE '%bsr%' 
		LEFT OUTER JOIN SupplementaryChanges sc ON sc.JobId=j.JobID
	WHERE
		j.SiteID = @SiteID
			AND
		j.Approved IS NOT NULL

	INSERT INTO @GridDetailSiteList (ListType,JobID,JobNo,DateChanged,MaxTimeChanged,OriginalJobNumber,QuoteType)
	SELECT
		2,
		j.JobID,
		j.JobNo,
		CAST(rat.DateCreated as DATE),
		CAST(MAX(rat.DateCreated) as TIME),
		'/' [OriginalJobNumber],
		'Portal Register Update' [QuoteType]
	FROM
		Job j
		INNER JOIN RegisterAuditTrail rat ON rat.JobID = j.JobID AND rat.PortalUserId IS NOT NULL
	WHERE
		j.SiteID = @SiteID
			AND
		j.Approved IS NOT NULL
	GROUP BY
		j.JobID,j.JobNo,j.Approved,CAST(rat.DateCreated as DATE)
		      
	--INSERT INTO @GridDetailSiteList (ListType,JobID,JobNo,DateChanged,MaxTimeChanged,OriginalJobNumber,QuoteType)
	--SELECT
	--	3,
	--	j.JobID,
	--	j.JobNo,
	--	CAST(rat.DateCreated as DATE),
	--	CAST(MAX(rat.DateCreated) as TIME),
	--	'/' [OriginalJobNumber],
	--	'Office Register Update' [QuoteType]
	--FROM
	--	Job j
	--	INNER JOIN RegisterAuditTrail rat ON rat.JobID = j.JobID
	--WHERE
	--	j.SiteID = @SiteID
	--		AND
	--	j.Approved IS NOT NULL
	--GROUP BY
	--	j.JobID,j.JobNo,j.Approved,CAST(rat.DateCreated as DATE)
	
	SELECT
		main.JobNo,
		main.DateChanged,
		main.MaxTimeChanged,
		main.OriginalJobNumber,
		main.QuoteType,
		main.PDFId,
		main.[FileName]
	FROM
		(
			SELECT
				ISNULL(ROW_NUMBER() OVER (Partition By gdsl.GridDetailSiteListID Order By pdf.DateCreated ASC),1) [Identifier],
				gdsl.JobNo,
				gdsl.DateChanged,
				gdsl.MaxTimeChanged,
				gdsl.OriginalJobNumber,
				gdsl.QuoteType,
				pdf.PDFId,
				pdf.FileName
			FROM
				@GridDetailSiteList gdsl 
				LEFT OUTER JOIN PDF 
					ON	
					(
						pdf.DateDeleted IS NULL
							AND
						gdsl.JobID=pdf.JobId 
							AND 
						pdf.[FileName] NOT LIKE '%bsr%' 
							AND 
						gdsl.ListType!=2
							AND
						(
							CASE WHEN gdsl.ListType = 3 THEN
								CASE WHEN pdf.DateCreated > gdsl.DateChanged THEN 1 ELSE 0 END
							ELSE
								CASE WHEN gdsl.PDFID = pdf.PDFID THEN 1 ELSE 0 END
							END
						) = 1
					)
		) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.JobNo,
		main.DateChanged DESC,
		main.MaxTimeChanged DESC

    SET NOCOUNT OFF;
END
GO

-- InvoiceVatRate table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='InvoiceVatRate'))
	BEGIN
		CREATE TABLE [dbo].[InvoiceVatRate](
			[InvoiceVatRateId] [int] IDENTITY(1,1) NOT NULL,
			[Description] [varchar](50) NOT NULL,
			[VATRate] [decimal](12, 3) NOT NULL,
			[ThirdPartyCode] [varchar](50) NULL,
			[DateDeleted] [datetime] NULL,
		 CONSTRAINT [PK_InvoiceVatRate_InvoiceVatRateId] PRIMARY KEY CLUSTERED 
		(
			[InvoiceVatRateId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

-- Web Service stuff.
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TeamsWebServiceDATA')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TeamsWebServiceDATA] AS BEGIN SET NOCOUNT ON; END')
END
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TeamsWebService_GUID_DATA')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TeamsWebService_GUID_DATA] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[TeamsWebServiceDATA](@jobid int,@SurveyTypeID int)
AS
BEGIN

DECLARE @internal_jobid [int]
DECLARE @internal_SurveyTypeID [int] 

SET @internal_jobid = @JobID
SET @internal_SurveyTypeID =  @SurveyTypeID

--debug
        --SET @internal_jobid = 18657	
        --SET @internal_SurveyTypeID = 8
        --SET @internal_jobid = 119082	
        --SET @internal_SurveyTypeID = 7
--end debug

    Set NoCount ON;
    
    -- Get all sample result data up front to reduce table scans on the sample table
	DECLARE @SampleData TABLE (SampleRef VARCHAR(MAX), AsSample BIT, SampleID INT, SampleResultID INT,FullSampleResult varchar(100), SampleResult VARCHAR(MAX),SampleResultValue INT, SampleClassification VARCHAR(MAX), SampleClassificationValue INT,SampleClassificationScore INT, SampleNADClassification varchar(MAX))
	
	INSERT INTO @SampleData (SampleRef,AsSample,SampleID,SampleResultID,FullSampleResult,SampleResult,SampleResultValue,SampleClassification,SampleClassificationValue,SampleClassificationScore,SampleNADClassification)
	SELECT
		s.SampleRef,
		s.AsSample,
		s.SampleID,
		sr.SampleResultID,
        CASE WHEN eim8.ShortDescription = 'Crocidolite (or unknown)' THEN
            ISNULL([sr].[FullSampleResult],'Crocidolite')
        ELSE
            COALESCE([sr].[FullSampleResult],eim8.ShortDescription,'')
        END,
		COALESCE(sr.SampleResult,eim8.ShortDescription,eim8.Description,''),
		COALESCE(sr.Value,e8.ElementIntID,-1),
		COALESCE(sce.SampleClassification,eim6.ShortDescription,eim6.Description,''),
		COALESCE(sc.Value,e6sc.Value,-1),
		COALESCE(sc.Score,e6sc.Score,0),
		sce.NADClassification
	FROM
		job j WITH (NOLOCK)
		inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
		INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
		INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
		INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
		INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
		INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
		LEFT OUTER JOIN Element e6 WITH (NOLOCK) ON e6.SampleID=s.SampleID AND e6.ElementTypeID=6
		LEFT OUTER JOIN ElementIntMeaning eim6 WITH (NOLOCK) ON e6.ElementIntMeaningID=eim6.ElementIntMeaningID
		LEFT OUTER JOIN SampleClassification e6sc WITH (NOLOCK) ON e6sc.SampleClassificationID=e6.ElementIntID
		LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
		LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
		LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
		LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON s.SampleClassificationID=sc.SampleClassificationID
		LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON s.SampleClassificationExtendedID=sce.SampleClassificationExtendedID
	WHERE
		je.JobID = @internal_jobid
			--AND
		--su.SurveyTypeID = @internal_SurveyTypeID
		
	-- Get all element data up front to reduce table scans on the element table
	DECLARE @ElementData TABLE (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX))

	INSERT INTO @ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription)
	SELECT
		e.ElementID,
		e.SampleID,
		e.ElementTypeID,
		e.ElementText,
		e.ElementIntID,
		e.ElementIntMeaningID,
		e.ElementIntMeaningExtendedID,
		e.ElementIntMeaningSubOptionID,
		COALESCE(eimso.[Description], eime.[Description], eim.ShortDescription, eim.[Description])
	FROM
		@SampleData s
		INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
		LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
		LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
		LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID
	
	Update @SampleData
		Set SampleResultValue=ISNULL((Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),e8.ElementIntID),
            FullSampleResult=(SELECT subSD.[FullSampleResult] FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
			SampleResult=ISNULL((Select subSD.SampleResult FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),(Select ShortDescription FROM ElementIntMeaning Where ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
			SampleResultID=(Select subSD.SampleResultID FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
			SampleClassification=ISNULL((Select subSD.SampleClassification FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),e6.ElementIntMeaningDescription),
			SampleClassificationValue=ISNULL((Select subSD.SampleClassificationValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),IsNull((Select Value FROM SampleClassification Where e6.ElementIntID=SampleClassificationID),0)),
			SampleClassificationScore=ISNULL((Select subSD.SampleClassificationScore FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),IsNull((Select Score FROM SampleClassification Where e6.ElementIntID=SampleClassificationID),0)),
			SampleNADClassification=(Select subSD.SampleNADClassification FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
	FROM @SampleData updateSD 
	LEFT OUTER JOIN @ElementData e8 ON updateSD.SampleID=e8.SampleID AND e8.ElementTypeID=8
	LEFT OUTER JOIN @ElementData e6 ON updateSD.SampleID=e6.SampleID AND e6.ElementTypeID=6
	Where (updateSD.AsSample=1)
    
    SELECT
        BuildingDesignation,
        Floornumber,
        f.floorplanid fpfloorplanId,
        f.AutocadData fpAutocadData,
        f.AutocadDataContentType fpAutocadDataContentType, 
        Number,
        rm.Description,
        rm.notes 'roomnotes', 
        ph.photodata,
        ph.photoid,
        ph.photono,
        s.sampleref,
        --[sd].[SampleClassification],
        e2.[ElementText] 'SampleDescription',
        COALESCE(eime9.[Description], eimso9.[Description], eim9.ShortDescription) 'ExtentOfDamage',
        COALESCE(eime10.[Description], eimso10.[Description], eim10.ShortDescription) 'SurfaceTreatment',
        [e3].[ElementText] 'ExtentOfMaterial',
        eim20.[Description] 'Recommendations',
        eim48.[Description] 'ReinspectionState',
        eim5.[Description] 'LevelOfIdentification',
        sd.[SampleClassification]'ProductType',
        [sd].FullSampleResult 'AsbestosType',
        CASE WHEN e5.[ElementIntID]>0 THEN 
            CASE WHEN e5.[ElementIntID]>0 AND (NOT [sut].[Description] LIKE '%MA only%') THEN 
                CASE 
                    WHEN maScore.[v] + [pascore].[v] BETWEEN 1 AND 8 THEN 'Risk Band D (' + CAST(maScore.[v] + [pascore].[v] AS varchar) + ')'
                    WHEN maScore.[v] + [pascore].[v] BETWEEN 9 AND 13 THEN 'Risk Band C ('+ CAST(maScore.[v] + [pascore].[v] AS varchar) + ')'
                    WHEN maScore.[v] + [pascore].[v] BETWEEN 14 AND 17 THEN 'Risk Band B ('+ CAST(maScore.[v] + [pascore].[v] AS varchar) + ')'
                    WHEN maScore.[v] + [pascore].[v] >= 18 THEN 'Risk Band A ('+ CAST(maScore.[v] + [pascore].[v] AS varchar) + ')'
                END 
            END 
        END RiskColumn,
        CASE WHEN ISNULL(e5.ElementIntID, -1) > 0 AND sut.Description NOT LIKE '%MA only%' AND sd.SampleResultValue > 0
            THEN pascore.v
            ELSE NULL
        END [PAScore],
        CASE WHEN ISNULL(e5.ElementIntID, -1) > 0 AND sd.SampleResultValue > 0
            THEN maScore.v
            ELSE NULL
        END [MAScore],
        pdf.filename 'pdfName',
        sd.SampleResultValue
	FROM
	
		Job j
		INNER JOIN [Site] si ON si.SiteID = j.SiteID
		INNER JOIN JobEmployee je ON j.JobID = je.JobID
		INNER JOIN Employee e ON je.EmployeeID = e.EmployeeID
		INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
		INNER JOIN Survey su ON r.SurveyID = su.SurveyID
		INNER JOIN SurveyType sut ON su.SurveyTypeID = sut.SurveyTypeID
        INNER JOIN Room rm ON r.[RegisterID] = rm.[RegisterID]
		INNER JOIN Floorplan f ON rm.[FloorplanID] = [f].[FloorplanID]
		INNER JOIN [Sample] s ON rm.RoomID = s.RoomID
        LEFT OUTER JOIN [dbo].[Photo] ph ON s.[PhotoID] = [ph].[PhotoID]
		INNER JOIN @SampleData sd ON sd.SampleID = s.SampleID
       -- LEFT JOIN [dbo].[SampleClassification] sc ON [sc].[SampleClassificationID] = s.[SampleClassificationID]
        --LEFT OUTER JOIN [dbo].[SampleClassificationExtended] sce ON s.[SampleClassificationExtendedID] = [sce].[SampleClassificationExtendedID]
		INNER JOIN @ElementData e2 ON e2.SampleID = s.SampleID AND e2.ElementTypeID = 2
		LEFT JOIN @ElementData e3 ON e3.SampleID = s.SampleID AND e3.ElementTypeID = 3
		LEFT JOIN @ElementData e4 ON e4.SampleID = s.SampleID AND e4.ElementTypeID = 4
		LEFT JOIN @ElementData e5 ON e5.SampleID = s.SampleID AND e5.ElementTypeID = 5
        LEFT OUTER JOIN elementintmeaning eim5 ON e5.[elementintmeaningid] = eim5.[ElementIntMeaningID]

        LEFT JOIN @ElementData e6 ON e6.SampleID = s.SampleID AND e6.ElementTypeID = 6
        LEFT OUTER JOIN SampleClassification e6sc ON e6sc.ElementIntValue=e6.ElementIntID


		LEFT JOIN @ElementData e7 ON e7.SampleID = s.SampleID AND e7.ElementTypeID = 7
		LEFT JOIN @ElementData e8 ON e8.SampleID = s.SampleID AND e8.ElementTypeID = 8
        LEFT OUTER JOIN elementintmeaning eim8 ON e8.[elementintmeaningid] = eim8.[ElementIntMeaningID]

		LEFT JOIN @ElementData e9 ON e9.SampleID = s.SampleID AND e9.ElementTypeID = 9
        LEFT JOIN ElementIntMeaning eim9 On e9.ElementIntMeaningID = eim9.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningSubOption eimso9 ON eimso9.ElementIntMeaningSubOptionID = e9.ElementIntMeaningSubOptionID
        LEFT JOIN ElementIntMeaningExtended eime9 ON eime9.ElementIntMeaningExtendedID = e9.ElementIntMeaningExtendedID

        
        
		LEFT JOIN @ElementData e10 ON e10.SampleID = s.SampleID AND e10.ElementTypeID = 10
        LEFT JOIN ElementIntMeaning eim10 On e10.ElementIntMeaningID = eim10.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningSubOption eimso10 ON eimso10.ElementIntMeaningSubOptionID = e10.ElementIntMeaningSubOptionID
        LEFT JOIN ElementIntMeaningExtended eime10 ON eime10.ElementIntMeaningExtendedID = e10.ElementIntMeaningExtendedID
        
        
        
		LEFT JOIN @ElementData e11 ON e11.SampleID = s.SampleID AND e11.ElementTypeID = 11
        LEFT OUTER JOIN elementintmeaning eim11 ON e11.[elementintmeaningid] = eim11.[ElementIntMeaningID]

		LEFT JOIN @ElementData e12 ON e12.SampleID = s.SampleID AND e12.ElementTypeID = 12

		LEFT JOIN @ElementData e13 ON e13.SampleID = s.SampleID AND e13.ElementTypeID = 13
        LEFT OUTER JOIN elementintmeaning eim13 ON e13.[elementintmeaningid] = eim13.[ElementIntMeaningID]

		LEFT JOIN @ElementData e14 ON e14.SampleID = s.SampleID AND e14.ElementTypeID = 14
        LEFT OUTER JOIN elementintmeaning eim14 ON e14.[elementintmeaningid] = eim14.[ElementIntMeaningID]

		LEFT JOIN @ElementData e15 ON e15.SampleID = s.SampleID AND e15.ElementTypeID = 15
        LEFT OUTER JOIN elementintmeaning eim15 ON e15.[elementintmeaningid] = eim15.[ElementIntMeaningID]

		LEFT JOIN @ElementData e16 ON e16.SampleID = s.SampleID AND e16.ElementTypeID = 16
        LEFT OUTER JOIN elementintmeaning eim16 ON e16.[elementintmeaningid] = eim16.[ElementIntMeaningID]

		LEFT JOIN @ElementData e17 ON e17.SampleID = s.SampleID AND e17.ElementTypeID = 17
        LEFT OUTER JOIN elementintmeaning eim17 ON e17.[elementintmeaningid] = eim17.[ElementIntMeaningID]

		LEFT JOIN @ElementData e18 ON e18.SampleID = s.SampleID AND e18.ElementTypeID = 18
        LEFT OUTER JOIN elementintmeaning eim18 ON e18.[elementintmeaningid] = eim18.[ElementIntMeaningID]


		LEFT JOIN @ElementData e19 ON e19.SampleID = s.SampleID AND e19.ElementTypeID = 19
        LEFT OUTER JOIN elementintmeaning eim19 ON e19.[elementintmeaningid] = eim19.[ElementIntMeaningID]

		LEFT JOIN @ElementData e20 ON e20.SampleID = s.SampleID AND e20.ElementTypeID = 20
        LEFT OUTER JOIN elementintmeaning eim20 ON e20.[elementintmeaningid] = eim20.[ElementIntMeaningID]
        
        LEFT JOIN @ElementData e26 ON e26.SampleID = s.SampleID AND e26.ElementTypeID = 26

        LEFT JOIN @ElementData e31 ON e31.SampleID = s.SampleID AND e31.ElementTypeID = 31
        
        LEFT JOIN @ElementData e48 ON e48.SampleID = s.SampleID AND e48.ElementTypeID = 48
        LEFT OUTER JOIN elementintmeaning eim48 ON e48.[elementintmeaningid] = eim48.[ElementIntMeaningID]

		LEFT JOIN Element e997 ON e997.[RegisterID] = [r].[RegisterID] AND e997.ElementTypeID = 997
		LEFT JOIN Element e1000 ON e1000.[RegisterID] = [r].[RegisterID] AND e1000.ElementTypeID = 1000

        OUTER APPLY
        (
            SELECT
                CASE WHEN s.[AsSample] = 0 THEN
            		'Sample ' + CAST(s.[RegisterItemNo] AS varchar(10))
                ELSE
                    'Ref Sample ' + CAST(parentSample.[RegisterItemNo] AS varchar(10))
                END SAMPLENote
            FROM    
                SAMPLE lkupSamp
                LEFT OUTER JOIN [dbo].[Sample] parentSample ON  lkupSamp.sampleref = [parentSample].[SampleRef]
                                                                AND [parentSample].[AsSample] = 0 
                                                                AND [parentSample].[SampleID]<>[lkupSamp].[SampleID]
                
            WHERE
                [lkupSamp].sampleid = s.[SampleID]
            
        ) sampleNotes(SAMPLENote)
        OUTER APPLY
        (
            SELECT 
                CASE WHEN RIGHT(ISNULL([subel].[ElementText],''),1)!='.' THEN 
                    ISNULL([subel].[ElementText]+ '. ','') 
                ELSE
                    ISNULL([subel].[ElementText] + ' ','')
                END 
            FROM
                @ElementData subel
                INNER JOIN InternalExternalNote ien ON [ien].[ElementTypeID] = [subel].[ElementTypeID]
            WHERE 
                ien.deleted IS NOT NULL
                AND [subel].[SampleID] = s.[SampleID]
            FOR XML PATH ('')
        ) otherInternalExternalNotes(notes)

        OUTER APPLY 
        (
            SELECT 
            ISNULL(
                (
                    SELECT
                        ceiling(cast(Sum(ISNULL(ElementIntId, 0)) AS float))
        	        FROM 
                        @ElementData
        	        WHERE 
                        SampleID = s.sampleid And ElementTypeID IN (9,10)       
                )
                ,0) + 
            sd.[SampleClassificationValue] + 
            sd.[SampleResultValue]
        )maScore(v)
        
        OUTER APPLY --used to calculate the PA SCORE in an outer apply - on a row basis
            (
                SELECT 
                ISNULL(e11.[ElementIntID],0),
                ISNULL((
                    SELECT
                        ceiling(cast(Sum(ISNULL(ElementIntId, 0)) AS float)/3)
	                FROM 
                        @ElementData
	                WHERE 
                        SampleID = s.sampleid And ElementTypeID IN (12, 13, 14)       
                ),0),
                ISNULL((
                    SELECT 
                        ceiling(cast(Sum(ISNULL(ElementIntId, 0)) AS float) /3)
                	From @ElementData
                	WHERE 
                        SampleID =s.[SampleID]
                        And ElementTypeID IN (15, 16, 17)
                ),0),
                ISNULL((
                    SELECT 
                        ceiling(cast(Sum(ISNULL(ElementIntId, 0)) AS float)/ 2)
	                FROM 
                        @ElementData
	                WHERE 
                        SampleID = s.sampleid And ElementTypeID IN (18, 19)
                ),0)
        ) PAScoreBreakDown (Avg_Occupant_ActivityScore,Avg_Disturbance_Score,Avg_Human_Exposure_Score,Avg_Maintenance_Activity_Score)
        OUTER APPLY --used to calculate the PA SCORE in an outer apply - on a row basis
        (
                SELECT
                    PAScoreBreakDown.[Avg_Occupant_ActivityScore] + 
                    [PAScoreBreakDown].[Avg_Disturbance_Score] + 
                    [PAScoreBreakDown].[Avg_Human_Exposure_Score] + 
                    [PAScoreBreakDown].[Avg_Maintenance_Activity_Score]
        ) pascore (v)            
        OUTER apply(
           SELECT TOP 1 
               pdf.filename
           FROM 
           [dbo].[PDF] pdf 
           WHERE 
               [pdf].[DateDeleted] IS NULL 
               AND [pdf].[FileName] LIKE '%bsr%.pdf' 
               AND [pdf].[JobId]=j.jobid
           ORDER BY [DateCreated] DESC
           )pdf(filename)
	WHERE
		j.JobID = @internal_jobid
			--AND
		--su.SurveyTypeID = @internal_SurveyTypeID
	ORDER BY
		r.BuildingDesignation,
		f.FloorNumber,
		rm.Number,
		s.RegisterItemNo


    Set NoCount OFF;
END
GO
ALTER PROCEDURE [dbo].[TeamsWebService_GUID_DATA]
    @JobID INT,
    @SurveyTypeID INT
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE
        --    @JobID INT = 8770,
        --    @SurveyTypeID INT = 7
    -- END DEBUG
    
    -- Get all sample result data up front to reduce table scans on the sample table
    CREATE TABLE #SampleData (JobID INT, RegisterID INT, RoomID INT, SampleRef VARCHAR(50), AsSample BIT, RegisterItemNo INT, SampleID INT, PhotoID INT, SampleResultID INT, FullSampleResult VARCHAR(500), SampleResult VARCHAR(500), SampleResultValue INT, SampleClassificationExtendedID INT, SampleClassification VARCHAR(500), SampleClassificationValue INT, SampleClassificationScore INT, SampleNADClassification VARCHAR(MAX), Notes VARCHAR(MAX), DateCheckedIn DATETIME, CheckedInEmployeeID INT, DateAnalysed DATETIME, AnalysedEmployeeID INT, GUID VARCHAR(50), GUIDVersion INT)
    
    -- Add an index on important #SampleData fields to increase speed in the main SELECT.
    CREATE INDEX temp_SampleData ON #SampleData (SampleID, PhotoID, SampleResultValue)
    
    INSERT INTO #SampleData (JobID, RegisterID, RoomID, SampleRef, AsSample, RegisterItemNo, SampleID, PhotoID, SampleResultID, FullSampleResult, SampleResult, SampleResultValue, SampleClassificationExtendedID, SampleClassification, SampleClassificationValue, SampleClassificationScore, SampleNADClassification, Notes, DateCheckedIn, CheckedInEmployeeID, DateAnalysed, AnalysedEmployeeID, GUID, GUIDVersion)
    SELECT
        je.JobID,
        r.RegisterID,
        rm.RoomID,
        s.SampleRef,
        s.AsSample,
        s.RegisterItemNo,
        s.SampleID,
        s.PhotoID,
        sr.SampleResultID,
        REPLACE(COALESCE(sr.FullSampleResult, sr.SampleResult, eim8.ShortDescription, eim8.Description, ''), 'Crocidolite (or unknown)', 'Crocidolite') [FullSampleResult],
        COALESCE(sr.SampleResult, eim8.ShortDescription, eim8.Description, '') [SampleResult],
        COALESCE(sr.Value, e8.ElementIntID, -1) [SampleResultValue],
        sce.SampleClassificationExtendedID,
        COALESCE(sce.SampleClassification, sc.SampleClassification, eime6.Description, eimso6.Description, eim6.ShortDescription, eim6.Description, '') [SampleClassification],
        COALESCE(sc.Value, e6sc.Value, -1) [SampleClassificationValue],
        COALESCE(sc.Score, e6sc.Score, 0) [SampleClassificationScore],
        sce.NADClassification [SampleNADClassification],
        s.Notes,
        s.DateCheckedIn,
        s.EmployeeIdCheckedIn [CheckedInEmployeeID],
        s.DateAnalysed,
        s.EmployeeID [AnalysedEmployeeID],
        s.GUID,
        s.GUIDVersion
        
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN CompletedSurveys cs WITH (NOLOCK) ON je.JobID = cs.JobID  -- Make sure job is Completed.
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
        LEFT JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID = sr.SampleResultID
        LEFT JOIN Element e8 WITH (NOLOCK) ON s.SampleID = e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID = eim8.ElementIntMeaningID
        LEFT JOIN SampleClassification sc WITH (NOLOCK) ON s.SampleClassificationID = sc.SampleClassificationID
        LEFT JOIN SampleClassificationExtended sce WITH (NOLOCK) ON s.SampleClassificationExtendedID = sce.SampleClassificationExtendedID
        LEFT JOIN Element e6 WITH (NOLOCK) ON s.SampleID = e6.SampleID AND e6.ElementTypeID = 6
        LEFT JOIN ElementIntMeaning eim6 WITH (NOLOCK) ON e6.ElementIntMeaningID = eim6.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime6 WITH (NOLOCK) ON e6.ElementIntMeaningExtendedID = eime6.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso6 WITH (NOLOCK) ON e6.ElementIntMeaningSubOptionID = eimso6.ElementIntMeaningSubOptionID
        LEFT JOIN SampleClassification e6sc WITH (NOLOCK) ON e6.ElementIntID = e6sc.SampleClassificationID
    WHERE
        je.JobID = @JobID
    
    -- Get all element data up front to reduce table scans on the element table
    CREATE TABLE #ElementData (ElementID INT, RegisterID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX), ElementIntMeaningShortDescription VARCHAR(MAX), ElementIntMeaningLongDescription VARCHAR(MAX), ElementDescriptionOrText VARCHAR(MAX))
    
    -- Add an index on important #ElementData fields to increase speed in the main SELECT.
    CREATE INDEX temp_ElementData ON #ElementData (RegisterID, SampleID, ElementTypeID, ElementIntID)
    
    INSERT INTO #ElementData (ElementID, RegisterID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription, ElementIntMeaningShortDescription, ElementIntMeaningLongDescription, ElementDescriptionOrText)
    SELECT
        e.ElementID,
        NULL,
        e.SampleID,
        e.ElementTypeID,
        e.ElementText,
        e.ElementIntID,
        e.ElementIntMeaningID,
        e.ElementIntMeaningExtendedID,
        e.ElementIntMeaningSubOptionID,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description),
        eim.ShortDescription,
        eim.Description,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description, e.ElementText)
    FROM
        #SampleData s
        INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
        LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID
    
    -- Update table variable so that As Samples get the same Sample Data as their physical Samples.
    UPDATE #SampleData
    SET
        SampleResultID = (SELECT subSD.SampleResultID FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        FullSampleResult = ISNULL((SELECT subSD.FullSampleResult FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WITH (NOLOCK) WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        SampleResult = ISNULL((SELECT subSD.SampleResult FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WITH (NOLOCK) WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        SampleResultValue = ISNULL((SELECT subSD.SampleResultValue FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e8.ElementIntID),
        SampleClassificationExtendedID = (SELECT subSD.SampleClassificationExtendedID FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        SampleClassification = ISNULL((SELECT subSD.SampleClassification FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e6.ElementIntMeaningDescription),
        SampleClassificationValue = ISNULL((SELECT subSD.SampleClassificationValue FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Value FROM SampleClassification WITH (NOLOCK) WHERE e6.ElementIntID=SampleClassificationID), 0)),
        SampleClassificationScore = ISNULL((SELECT subSD.SampleClassificationScore FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Score FROM SampleClassification WITH (NOLOCK) WHERE e6.ElementIntID=SampleClassificationID), 0)),
        SampleNADClassification = ISNULL((SELECT subSD.SampleNADClassification FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT SampleNADClassification FROM SampleClassification WITH (NOLOCK) WHERE e6.ElementIntID=SampleClassificationID)),
        Notes = (SELECT subSD.Notes FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        DateCheckedIn = (SELECT subSD.DateCheckedIn FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        CheckedInEmployeeID = (SELECT subSD.CheckedInEmployeeID FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        DateAnalysed = (SELECT subSD.DateAnalysed FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        AnalysedEmployeeID = (SELECT subSD.AnalysedEmployeeID FROM #SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
    FROM
        #SampleData updateSD
        LEFT JOIN #ElementData e8 ON updateSD.SampleID = e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN #ElementData e6 ON updateSD.SampleID = e6.SampleID AND e6.ElementTypeID = 6
    WHERE
        updateSD.AsSample = 1
    
    -- Get sample test data up front to reduce table scans on the SampleTest table
    DECLARE @SampleTestData TABLE (SampleTestCollectionID INT, EmployeeID INT, SampleID VARCHAR(50), SampleRef VARCHAR(50), SampleTestID INT, Name VARCHAR(50))
    
    INSERT INTO @SampleTestData (SampleTestCollectionID, EmployeeID, SampleID, SampleRef, SampleTestID, Name)
    SELECT
        stc.sampleTestCollectionID [SampleTestCollectionID],
        stc._employeeID [EmployeeID],
        stc._sampleID [SampleID],
        stc._sampleRef [SampleRef],
        st.sampleTestID [SampleTestID],
        st._name [Name]
    FROM
        #SampleData sd
        INNER JOIN SampleTestCollection stc WITH (NOLOCK) ON sd.SampleID = stc._sampleID
        LEFT JOIN SampleTest st WITH (NOLOCK) ON stc.sampleTestCollectionID = st.sampleTestCollectionID AND st._testCancelledOn IS NULL
    WHERE 
        stc.Deleted IS NULL
    
    
    -- Start the main SELECT
    SELECT
        dbo.FormatTeamsReference('J', j.JobNo) [JobNo],
        r.GUID [register_GUID],
        r.GUIDVersion [register_GUIDVersion],
        f.GUID [Floor_GUID],
        f.GUIDVersion [Floor_GUIDVersion],
        rm.GUID [room_GUID],
        rm.GUIDVersion [room_GUIDVersion],
        sd.GUID [sample_GUID],
        sd.GUIDVersion [sample_GUIDVersion],
        e.EmployeeID [SurveyorID],
        e.FullName [Surveyor],
        r.BuildingDesignation [BuildingDesignation],
        f.FloorNumber [Floornumber],
        f.FloorplanID [fpfloorplanId],
        f.AutocadData [fpAutocadData],
        f.AutocadDataContentType [fpAutocadDataContentType], 
        rm.Number [Number],
        rm.Description [Description],
        rm.Notes [roomnotes], 
        p.PhotoData [photodata],
        p.PhotoID [photoid],
        p.PhotoNo [photono],
        sd.SampleID [SampleID],
        CASE WHEN sd.AsSample = 0 THEN '' ELSE 'AS ' END + sd.SampleRef [SampleRef],
        CASE WHEN ISNULL(e5.ElementIntID, -1) = 3 OR sd.AsSample = 1
            THEN -- If a physical sample or As Sample then..
                CASE WHEN sd.AsSample = 1
                    THEN 'See Parent Sample' -- As sample
                    ELSE
                        CASE WHEN stc.SampleTestCollectionID IS NOT NULL -- For a physical sample, get additional details about the analysis.
                            THEN
                                CASE WHEN stc.QCCount > 0
                                    THEN 'Analysed and QC Tested'
                                    ELSE
                                        CASE WHEN stc.TestCount > 0
                                            THEN 'Analysed in Lab'
                                            ELSE 'No Lab Analysis'
                                        END
                                END
                            ELSE 'Analysed'
                        END
                END
            ELSE 'No Sample to check' -- Other items such as No Suspect Materials, Inaccessible, Presumed and Strongly Presumed.
        END [LabAnalysis],
        e2.ElementText [SampleDescription],
        e9.ElementIntMeaningDescription [ExtentOfDamage],
        e10.ElementIntMeaningDescription [SurfaceTreatment],
        e3.ElementText [ExtentOfMaterial],
        e20.ElementIntMeaningDescription [Recommendations],
        e48.ElementIntMeaningDescription [ReinspectionState],
        CASE WHEN rm.Inaccessible = 1
            THEN 'Room Inaccessible'
            ELSE
                CASE ISNULL(e5.ElementIntID, -1)
                    WHEN -1 THEN ''
                    WHEN 0 THEN 'Innacessible'
                    ELSE 'Accessible'
                END 
        END [Accessible],
        ISNULL(e5.ElementIntID, -1) [LevelOfID_IntID],
        e5.ElementIntMeaningDescription [LevelOfIdentification],
        CASE WHEN rm.Inaccessible = 1
            THEN ''
            ELSE
                CASE ISNULL(e5.ElementIntID, -1)
                    WHEN -1 THEN 'NO SUSPECT MATERIALS FOUND'
                    WHEN 0 THEN ''
                    WHEN 1 THEN 'INSPECTION'
                    WHEN 2 THEN 'INSPECTION'
                    WHEN 3 THEN 'SAMPLE'
                    ELSE ''
                END 
        END [SampleInspection],
        sd.SampleClassification [ProductType],
        sd.FullSampleResult [AsbestosType],
        CASE WHEN ISNULL(e5.ElementIntID, -1) > 0
            THEN
                CASE WHEN ISNULL(e5.ElementIntID, -1) > 0 AND sut.Description NOT LIKE '%MA only%'
                    THEN
                        CASE
                            WHEN ms.MaScore + ps.PaScore BETWEEN 1 AND 8 THEN 'Risk Band D (' + CAST(ms.MaScore + ps.PaScore AS VARCHAR(100)) + ')'
                            WHEN ms.MaScore + ps.PaScore BETWEEN 9 AND 13 THEN 'Risk Band C ('+ CAST(ms.MaScore + ps.PaScore AS VARCHAR(100)) + ')'
                            WHEN ms.MaScore + ps.PaScore BETWEEN 14 AND 17 THEN 'Risk Band B ('+ CAST(ms.MaScore + ps.PaScore AS VARCHAR(100)) + ')'
                            WHEN ms.MaScore + ps.PaScore >= 18 THEN 'Risk Band A ('+ CAST(ms.MaScore + ps.PaScore AS VARCHAR(100)) + ')'
                            ELSE NULL
                        END
                    ELSE NULL
                END
            ELSE NULL
        END [RiskColumn],
        CASE WHEN ISNULL(e5.ElementIntID, -1) > 0 AND sut.Description NOT LIKE '%MA only%' AND sd.SampleResultValue > 0
            THEN ps.PaScore
            ELSE NULL
        END [PAScore],
        CASE WHEN ISNULL(e5.ElementIntID, -1) > 0 AND sd.SampleResultValue > 0
            THEN ms.MaScore
            ELSE NULL
        END [MAScore],
        bsrp.FileName [pdfName], -- Bulk Sample Report
        sd.SampleResultValue [SampleResultValue]
        
    FROM
        Job j WITH (NOLOCK)
        INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
        INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN SurveyType sut WITH (NOLOCK) ON su.SurveyTypeID = sut.SurveyTypeID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
        INNER JOIN #SampleData sd ON rm.RoomID = sd.RoomID
        LEFT JOIN Photo p WITH (NOLOCK) ON sd.PhotoID = p.PhotoID
        
        LEFT JOIN #ElementData e1 ON sd.SampleID = e1.SampleID AND e1.ElementTypeID = 1
        INNER JOIN #ElementData e2 ON sd.SampleID = e2.SampleID AND e2.ElementTypeID = 2
        LEFT JOIN #ElementData e3 ON sd.SampleID = e3.SampleID AND e3.ElementTypeID = 3
        LEFT JOIN #ElementData e4 ON sd.SampleID = e4.SampleID AND e4.ElementTypeID = 4
        LEFT JOIN #ElementData e5 ON sd.SampleID = e5.SampleID AND e5.ElementTypeID = 5
        LEFT JOIN #ElementData e9 ON sd.SampleID = e9.SampleID AND e9.ElementTypeID = 9
        LEFT JOIN #ElementData e10 ON sd.SampleID = e10.SampleID AND e10.ElementTypeID = 10
        LEFT JOIN #ElementData e11 ON sd.SampleID = e11.SampleID AND e11.ElementTypeID = 11
        LEFT JOIN #ElementData e12 ON sd.SampleID = e12.SampleID AND e12.ElementTypeID = 12
        LEFT JOIN #ElementData e13 ON sd.SampleID = e13.SampleID AND e13.ElementTypeID = 13
        LEFT JOIN #ElementData e14 ON sd.SampleID = e14.SampleID AND e14.ElementTypeID = 14
        LEFT JOIN #ElementData e15 ON sd.SampleID = e15.SampleID AND e15.ElementTypeID = 15
        LEFT JOIN #ElementData e16 ON sd.SampleID = e16.SampleID AND e16.ElementTypeID = 16
        LEFT JOIN #ElementData e17 ON sd.SampleID = e17.SampleID AND e17.ElementTypeID = 17
        LEFT JOIN #ElementData e18 ON sd.SampleID = e18.SampleID AND e18.ElementTypeID = 18
        LEFT JOIN #ElementData e19 ON sd.SampleID = e19.SampleID AND e19.ElementTypeID = 19
        LEFT JOIN #ElementData e20 ON sd.SampleID = e20.SampleID AND e20.ElementTypeID = 20
        LEFT JOIN #ElementData e26 ON sd.SampleID = e26.SampleID AND e26.ElementTypeID = 26
        LEFT JOIN #ElementData e31 ON sd.SampleID = e31.SampleID AND e31.ElementTypeID = 31
        LEFT JOIN #ElementData e48 ON sd.SampleID = e48.SampleID AND e48.ElementTypeID = 48
        
        OUTER APPLY -- Calculate Total Ma Score
        (
            SELECT ISNULL(e9.ElementIntID, 0) + ISNULL(e10.ElementIntID, 0) + ISNULL(sd.SampleResultValue, 0) + ISNULL(sd.SampleClassificationValue, 0)
        ) ms (MaScore)
        
        OUTER APPLY -- Calculate Total Pa Score and each Average Score
        (
            SELECT
                a.*,
                a.OccupantActivityScore + a.DisturbanceScore + a.HumanExposureScore + a.MaintenanceActivityScore
            FROM
            (
                SELECT
                    ISNULL(e11.ElementIntID, 0) [OccupantActivityScore],
                    ISNULL(CEILING(CAST((ISNULL(e12.ElementIntID, 0) + ISNULL(e13.ElementIntID, 0) + ISNULL(e14.ElementIntID, 0)) AS FLOAT) / 3), 0) [DisturbanceScore],
                    ISNULL(CEILING(CAST((ISNULL(e15.ElementIntID, 0) + ISNULL(e16.ElementIntID, 0) + ISNULL(e17.ElementIntID, 0)) AS FLOAT) / 3), 0) [HumanExposureScore],
                    ISNULL(CEILING(CAST((ISNULL(e18.ElementIntID, 0) + ISNULL(e19.ElementIntID, 0)) AS FLOAT) / 2), 0) [MaintenanceActivityScore]
            ) a
        ) ps (OccupantActivityScore, DisturbanceScore, HumanExposureScore, MaintenanceActivityScore, PaScore)
        
        OUTER APPLY
        (
            SELECT
                SampleTestCollectionID,
                SUM(CASE WHEN Name = 'AnalysisTest' THEN 1 ELSE 0 END) [TestCount],
                SUM(CASE WHEN Name = 'AnalysisQC' THEN 1 ELSE 0 END) [QCCount]
            FROM
                @SampleTestData
            WHERE
                SampleID = sd.SampleID
            GROUP BY
                SampleTestCollectionID
        ) stc -- Sample Test Collection data for the current sample
        
        OUTER APPLY
        (
            SELECT TOP 1 FileName
            FROM PDF WITH (NOLOCK)
            WHERE
                JobID = j.JobID
                    AND
                DateDeleted IS NULL
                    AND
                FileName LIKE '%bsr%.pdf'
           ORDER BY DateCreated DESC
        ) bsrp -- Bulk Sample Report PDF
        
    WHERE
        je.JobID = @JobID
        
    ORDER BY
        j.JobID,
        r.BuildingDesignation,
        f.FloorNumber,
        rm.Number,
        sd.RegisterItemNo
    
    -- Clear up temp tables.
    DROP TABLE #SampleData
    DROP TABLE #ElementData
    
    
    SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO

/****** Object:  View [dbo].[MobileUnitSummary]    Script Date: 25/04/2017 10:42:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[MobileUnitSummary]
As

SELECT
	[SystemName] =			SystemName, 
	[LastUsed] =			m1.DateCreated, 
	[SoftwareVersion] =		DataQueryString, 
	[SerialNumber] =		eq.SerialNumber,
	[Employee] =			ISNULL(e.FullName,'Unknown') ,
	[UserBranch] =			b.BranchOffice,
	[LicenceKey] =			mlk.LicenceKey,
	[EquipmentID] =			eq.EquipmentID,
	[LastUpdate] =			lastUpd.DateCreated,
	[DataScript] =			recentScript.DataScript
From
	MobileAuditTrail m1 WITH (NOLOCK)
	INNER JOIN Equipment eq WITH (NOLOCK) ON eq.RefNo = m1.SystemName And eq.EquipmentCategoryID = 19
	LEFT JOIN Employee e WITH (NOLOCK) ON m1.EmployeeID = e.EmployeeID
	LEFT JOIN BranchOffice b WITH (NOLOCK) ON e.BranchOfficeID = b.BranchOfficeID
	LEFT JOIN MobileUnitLicenceKey mlk WITH (NOLOCK) ON eq.[MobileUnitLicenceKeyID] = [mlk].[MobileUnitLicenceKeyID]
	--Last time an update was done
	OUTER APPLY
	(
		SELECT TOP 1
			DateCreated
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
				AND
			_mat.DataQueryString != m1.DataQueryString
		ORDER BY
			DateCreated DESC
	) lastUpd
	OUTER APPLY
	(
		SELECT TOP 1
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
		ORDER BY
			DateCreated DESC
	) recentScript
Where
	Category IN (1, 2)
		AND 
	MobileAuditTrailID = (Select Top 1 MobileAuditTrailID from MobileAuditTrail m2 WITH (NOLOCK) Where m1.SystemName = m2.SystemName Order By MobileAuditTrailID DESC)
		AND
	m1.[DateCreated] BETWEEN CONVERT(varchar(20),DATEADD(day,-30,GETDATE()),106) AND CONVERT(VARCHAR(20),DATEADD(day,1,GETDATE()),106)

UNION

SELECT
	[SystemName] =			SystemName, 
	[LastUsed] =			m1.DateCreated, 
	[SoftwareVersion] =		DataQueryString, 
	[SerialNumber] =		eq.SerialNumber,
	[Employee] =			ISNULL(e.FullName,'Unknown') ,
	[UserBranch] =			b.BranchOffice,
	[LicenceKey] =			mlk.LicenceKey,
	[EquipmentID] =			eq.EquipmentID,
	[LastUpdate] =			lastUpd.DateCreated,
	[DataScript] =			recentScript.DataScript
From
	MobileAuditTrail m1 WITH (NOLOCK)
	LEFT JOIN Equipment eq WITH (NOLOCK) ON eq.RefNo = m1.SystemName And eq.EquipmentCategoryID = 19
	LEFT JOIN Employee e WITH (NOLOCK) ON m1.EmployeeID = e.EmployeeID
	LEFT JOIN BranchOffice b WITH (NOLOCK) ON e.BranchOfficeID = b.BranchOfficeID
	LEFT JOIN MobileUnitLicenceKey mlk WITH (NOLOCK) ON eq.[MobileUnitLicenceKeyID] = [mlk].[MobileUnitLicenceKeyID]
	--Last time an update was done
	OUTER APPLY
	(
		SELECT TOP 1
			DateCreated,
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
				AND
			_mat.DataQueryString != m1.DataQueryString
		ORDER BY
			DateCreated DESC
	) lastUpd
    OUTER APPLY
	(
		SELECT TOP 1
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
		ORDER BY
			DateCreated DESC
	) recentScript
Where
	Category IN (1, 2)
		AND 
	MobileAuditTrailID = (Select Top 1 MobileAuditTrailID from MobileAuditTrail m2 WITH (NOLOCK) Where m1.SystemName = m2.SystemName Order By MobileAuditTrailID DESC)
		AND
	m1.[DateCreated] BETWEEN CONVERT(varchar(20),DATEADD(day,-30,GETDATE()),106) AND CONVERT(VARCHAR(20),DATEADD(day,1,GETDATE()),106)
		AND
	eq.EquipmentID IS NULL

GO

-- TransportEnterpriseSite bit field.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'TransportEnterpriseSite' AND OBJECT_ID = OBJECT_ID('Client'))
BEGIN
    ALTER TABLE Client
    ADD TransportEnterpriseSite BIT NOT NULL DEFAULT 0
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'TransportEnterpriseSite' AND OBJECT_ID = OBJECT_ID('Site'))
BEGIN
    ALTER TABLE Site
    ADD TransportEnterpriseSite BIT NOT NULL DEFAULT 0
END
GO

-- PropertyType And ConstructionType for a Site.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'PropertyTypeID' AND OBJECT_ID = OBJECT_ID('Site'))
BEGIN
    ALTER TABLE Site
    ADD PropertyTypeID INT NULL
END
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ConstructionTypeID' AND OBJECT_ID = OBJECT_ID('Site'))
BEGIN
    ALTER TABLE Site
    ADD ConstructionTypeID INT NULL
END
GO
IF NOT EXISTS(SELECT * FROM sys.tables WHERE OBJECT_ID = OBJECT_ID('ConstructionType'))
BEGIN
    CREATE TABLE [dbo].[ConstructionType](
        [ConstructionTypeID] [int] NOT NULL,
        [Description] [varchar](200) NOT NULL,
        [Deleted] [datetime] NULL,
    CONSTRAINT [PK_ConstructionType] PRIMARY KEY CLUSTERED 
    (
        [ConstructionTypeID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]
END
GO
IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('ConstructionType') AND name = 'Idx_ConstructionType_Deleted')
BEGIN
    CREATE NONCLUSTERED INDEX [Idx_ConstructionType_Deleted] ON [dbo].[ConstructionType] 
    (
        [Deleted] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
GO

ALTER VIEW [dbo].[NotYetQuoted]
As
Select
	
	Case
		When a.AppointmentTypeId = 8 Then
			'visitQuote'
		Else
			'standardQuote'
	End as typestr,
	a.ClientId,
	a.ProjectId,
	a.SiteId,
	a.clientOrderNo,
	'A' + Cast(Min(AppointmentId) as varchar) as Id,
	Case
		When a.AppointmentTypeId = 8 Then
			'Quote Visit Appointment'
		Else
			'Quote Appointment'
	End +
	Case
		When a.DateConfirmed Is Null Then
			' (Unconfirmed)'
		Else
			''
	End as Type,
	Cast(Min(StartTime) as date) as Date,
	dbo.Ellipsis(a.Notes, 250) as Notes,
	c.Client + Case When Len(IsNull(c.BranchName, '')) > 0 Then ' (' + c.BranchName + ')' Else '' End as Client,
	-- This case is same as _subs/teams.asp function GetEmployeeList - but needs to exist here also to make union work
	IsNull( dbo.FormatTeamsReference('E', e.EnquiryNo), 'N/A') as Source,
	Min(a.DateCreated) as DateCreated,
	Replace(Replace(Replace(
		(
			Select
				e.FullName
			From
				AppointmentEmployee ae
				Inner Join Employee e On e.EmployeeId = ae.EmployeeId
			Where
				AppointmentId = Min(a.AppointmentId)
			Order By
				e.FullName
			For XML Path('')
		),
		'</FullName><FullName>', ', '), -- Seperate the names with a comma.
		'<FullName>', ''), -- Remove opening tag.
		'</FullName>', '') -- Remove closing tag.
	as AssignedTo,
	Null as AssignedToEmployeeId,
	Null as LastNoteCreated,
	s.Address,
	s.Postcode,
	s.Address as EnquirySiteAddress,
	s.PostCode as EnquirySitePostcode,
	s.UPRN,
	Null as followup,
	CASE WHEN a.DateCreated > DATEADD(hh,-1,GetDate()) THEN
		1
	ELSE
		0
	END 'isNew',
	0 as 'HasNotes',
	0 AS 'NotesInLastHour',
    qt.quotetype,
	emp.Fullname [Source Origin]
From
	Appointment a
	Left Outer Join Enquiry e On e.QuoteId = a.QuoteId
	Left Outer Join Employee emp On e.EnquiryEmployeeID = emp.EmployeeID
    LEFT OUTER JOIN [dbo].[Quote] q ON a.[QuoteID] = [q].[QuoteID]
    LEFT OUTER JOIN [dbo].[QuoteType] qt ON qt.[QuoteTypeID] = COALESCE([q].[QuoteTypeID],[e].[QuoteTypeID])
	Left Outer Join Client c On c.ClientId = a.ClientId
	Left Outer Join Project p On p.ProjectId = a.ProjectId
	Left Outer Join Site s On s.SiteId = a.SiteId
Where
	(
		(a.QuoteId Is Null And a.AppointmentTypeId = 2 And a.DateConfirmed Is Not Null)
			Or
		(a.QuoteId Is Not Null And a.AppointmentTypeId = 8 And (Select MAX(EmployeeId) From QuoteEmployee Where QuoteId = a.QuoteId) = 0)
	)
	And a.DateDeclined Is Null
Group By
	a.ClientId,
	a.ProjectId,
	a.SiteId,
	a.ClientOrderNo,
	a.AppointmentTypeId,
	a.AppointmentGroupId,
	a.datecreated,
	Case
		When a.DateConfirmed Is Null Then
			' (Unconfirmed)'
		Else
			''
	End,
	c.Client + Case When Len(IsNull(c.BranchName, '')) > 0 Then ' (' + c.BranchName + ')' Else '' End,
	dbo.Ellipsis(a.Notes, 250),
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	e.EnquiryNo,
    qt.quotetype,
	emp.Fullname

Union All

Select
	'enquiryQuote' as typestr,
	e.ClientId,
	Null as ProjectId,
	e.SiteId,
	Null as ClientOrderNo,
	'E' + Cast(e.EnquiryId as varchar) as Id,
	'Enquiry E' + Right('00000' + Convert(varchar, e.EnquiryNo),6) as Type,
	Cast(e.DateCreated as date) as Date,
	dbo.Ellipsis(e.DetailsOfWork, 250) as Notes,
	Case
		When e.ClientId Is Null Then
			e.Client + Case When Len(IsNull(e.ClientBranchName, '')) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End
		Else
			c.Client + Case When Len(IsNull(c.BranchName, '')) > 0 Then ' (' + c.BranchName + ')' Else '' End
	End as Client,
	Case
		When e.EnquirySourceId Is Null Then
			emp.FullName
		Else
			es.Description
	End as Source,
	e.DateCreated,
	IsNull(emp2.FullName, 'Unassigned') as AssignedTo,
	emp2.EmployeeId as AssignedToEmployeeId,
	e.LastNoteCreated,
	c.Address,
	c.Postcode,
	Coalesce(s.Address, e.SiteAddress) as EnquirySiteAddress,
	Coalesce(s.PostCode, e.SitePostCode) as EnquirySitePostcode,
	Null as UPRN,
	e.ReminderDate as followup,
	CASE WHEN e.DateCreated > DATEADD(hh,-1,GetDate()) THEN
		1
	ELSE
		0
	END 'isNew',
	CASE WHEN e.LastNoteCreated Is Null THEN
		0
	ELSE
		1
	END 'HasNotes',
	CASE WHEN IsNull(e.LastNoteCreated, DateAdd(hh, -2, GETDATE())) > DATEADD(hh, -1, GetDate()) THEN
		1
	ELSE
		0
	END 'NotesInLastHour',
    qt.quotetype,
	emp.Fullname [Source Origin]
FROM
	Enquiry e
    LEFT OUTER JOIN [dbo].[QuoteType] qt ON e.[QuoteTypeID] = [qt].[QuoteTypeID]
	Left Outer Join Client c On e.ClientId = c.ClientId
	Left Outer Join Employee emp On emp.EmployeeId = e.EnquiryEmployeeId
	Left Outer Join Employee emp2 On emp2.EmployeeId = e.AssignedEmployeeId
	Left Outer Join EnquirySource es On es.EnquirySourceId = e.EnquirySourceId
	Left Outer Join Appointment a On a.EnquiryId = e.EnquiryId
	Left Outer Join Site s On s.SiteId = e.SiteId
Where
	e.DateDiscarded Is Null
		And
	e.QuoteId Is Null
		And
	a.EnquiryId Is Null
/*
Union All

Select
	'removalQuoteVisit' as typestr,
	a.ClientId,
	a.ProjectId,
	a.SiteId,
	a.clientOrderNo,
	'R' + Cast(Min(AppointmentId) as varchar) as Id,
	'Removal Quote Appointment' as Type,
	Cast(Min(StartTime) as date) as Date,
	dbo.Ellipsis(a.Notes, 250) as Notes,
	c.Client + Case When Len(IsNull(c.BranchName, '')) > 0 Then ' (' + c.BranchName + ')' Else '' End as Client,
	-- This case is same as _subs/teams.asp function GetEmployeeList - but needs to exist here also to make union work
	Case (Select Count(*) From AppointmentEmployee ae2 Inner Join Appointment a2 On a2.AppointmentId = ae2.AppointmentId Inner Join Employee e2 On ae2.EmployeeId = e2.EmployeeId Where a2.AppointmentId = Min(a.AppointmentId))
		When 0 Then
			'Nobody'
		When 1 Then
			'Site visit by ' + (Select e3.FullName From AppointmentEmployee ae3 Inner Join Employee e3 On ae3.EmployeeId = e3.EmployeeId Where ae3.AppointmentId = Min(a.AppointmentId))
		Else
			'Site visit by ' + Convert(varchar,(Select Count(*) From AppointmentEmployee ae2 Inner Join Appointment a2 On a2.AppointmentId = ae2.AppointmentId Inner Join Employee e2 On ae2.EmployeeId = e2.EmployeeId Where a2.AppointmentId = Min(a.AppointmentId))) + ' people'
	End as Source,
	Min(a.DateCreated) as DateCreated,
	'N/A' as AssignedTo,
	Null as AssignedToEmployeeId
From
	Appointment a
	Inner Join Quote q On a.QuoteId = q.QuoteId
	Left Outer Join Client c On c.ClientId = a.ClientId
	Left Outer Join Project p On p.ProjectId = a.ProjectId
	Left Outer Join Site s On s.SiteId = a.SiteId
Where
	a.AppointmentTypeId = 6
	And Q.notyetquoted = 1
	And a.DateDeclined Is Null
	And a.DateConfirmed Is Not Null
Group By
	a.ClientId,
	a.ProjectId,
	a.SiteId,
	a.ClientOrderNo,
	a.AppointmentGroupId,
	c.Client + Case When Len(IsNull(c.BranchName, '')) > 0 Then ' (' + c.BranchName + ')' Else '' End,
	dbo.Ellipsis(a.Notes, 250)
*/
GO

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='AEInstruction') AND name='FileNameList') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.[AEInstruction]
      ADD FileNameList VARCHAR(MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='BranchOffice') AND name='Email') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.[BranchOffice]
      ADD [Email] [VARCHAR] (MAX) NULL
END

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='BranchOffice') AND name='Telephone') < 1
BEGIN
  ALTER TABLE TEAMS.dbo.[BranchOffice]
      ADD [Telephone] [VARCHAR] (MAX) NULL
END
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'DefaultRate' AND Object_ID = Object_ID(N'InvoiceVatRate'))
BEGIN
    ALTER TABLE [InvoiceVatRate] ADD [DefaultRate] bit NULL
	CONSTRAINT [DF_InvoiceVatRate_DefaultRate]  DEFAULT ((0))
END
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'SortOrder' AND Object_ID = Object_ID(N'InvoiceVatRate'))
BEGIN
    ALTER TABLE [InvoiceVatRate] ADD [SortOrder] int NOT NULL
	CONSTRAINT [DF_InvoiceVatRate_SortOrder]  DEFAULT ((0))
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__SurveyorCantAnalyseOwnSamples' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__SurveyorCantAnalyseOwnSamples BIT NOT NULL DEFAULT 0
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__clientAccountRefRequired' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__clientAccountRefRequired BIT NOT NULL DEFAULT 0
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaHeaderFooterData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetLegionellaHeaderFooterData] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[GetLegionellaHeaderFooterData]
    @JobID INT
/**********************************************************************
** Overview: Get Legionella Header and Footer data. Used via Generate Report for replace variables. The main SELECT gets COUNTs/STUFFed data, and the second gets category data.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM DEV FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- DEBUG
        --DECLARE @JobID INT = 11402
    -- END DEBUG


    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)

    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID


    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)

    INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        la.LegionellaAssetID,
        la.PhotoID [AssetPhotoID],
        la.SystemRef [AssetSystemRef],
        la.Location [AssetLocation],
        la.SortOrder [AssetSortOrder],
        lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
        lrr.Description [AssetRiskRating],
        lrr.RiskColour [AssetRiskColour],
        lrr.SortOrder [AssetRiskRatingSortOrder],
        lac.LegionellaAssetCategoryID,
        lac.Description [AssetCategory],
        lac.SortOrder [AssetCategorySortOrder]
    FROM
        @LegionellaData l
        INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
        INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
    WHERE
        la.Deleted IS NULL


    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        ll.LegionellaLocationID,
        ll.Location,
        ll.SortOrder [LocationSortOrder]
    FROM
        @LegionellaData l
        INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
    WHERE
        ll.Deleted IS NULL


    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)

    INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        lo.LegionellaOutletID,
        lo.PhotoID [OutletPhotoID],
        lo.SystemRef [OutletSystemRef],
        ll.LegionellaLocationID,
        ll.Location,
        ll.LocationSortOrder,
        lo.Cold [OutletCold],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletColdTriggered],
        lo.Hot [OutletHot],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletHotTriggered],
        lo.Mixed [OutletMixed],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletMixedTriggered],
        lo.Mains [OutletMains],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletMainsTriggered],
        lo.SentinelCold [OutletSentinelCold],
        lo.SentinelHot [OutletSentinelHot],
        lo.SentinelMixed [OutletSentinelMixed],
        lo.SentinelMains [OutletSentinelMains],
        lo.SortOrder [OutletSortOrder],
        lo.FlushedCold [OutletFlushedCold],
        lo.FlushedHot [OutletFlushedHot],
        lo.FlushedMixed [OutletFlushedMixed],
        lo.FlushedMains [OutletFlushedMains],
        lo.LowUseCold [OutletLowUseCold],
        lo.LowUseHot [OutletLowUseHot],
        lo.LowUseMixed [OutletLowUseMixed],
        lo.LowUseMains [OutletLowUseMains],
        sca.OutletSourceColdAssetID,
        sca.OutletSourceColdAssetSystemRef,
        sca.OutletSourceColdAssetLocation,
        sca.OutletSourceColdAssetCategory,
        sha.OutletSourceHotAssetID,
        sha.OutletSourceHotAssetSystemRef,
        sha.OutletSourceHotAssetLocation,
        sha.OutletSourceHotAssetCategory,
        sma.OutletSourceMixedAssetID,
        sma.OutletSourceMixedAssetSystemRef,
        sma.OutletSourceMixedAssetLocation,
        sma.OutletSourceMixedAssetCategory,
        smna.OutletSourceMainsAssetID,
        smna.OutletSourceMainsAssetSystemRef,
        smna.OutletSourceMainsAssetLocation,
        smna.OutletSourceMainsAssetCategory,
        loc.LegionellaOutletCategoryID,
        loc.Description [OutletCategory],
        loc.SortOrder [OutletCategorySortOrder]
    FROM
        @LegionellaData l
        INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
        INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
        LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceColdAssetID],
                _la.SystemRef [OutletSourceColdAssetSystemRef],
                _la.Location [OutletSourceColdAssetLocation],
                _lac.Description [OutletSourceColdAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceCold
        ) sca -- Source Cold Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceHotAssetID],
                _la.SystemRef [OutletSourceHotAssetSystemRef],
                _la.Location [OutletSourceHotAssetLocation],
                _lac.Description [OutletSourceHotAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceHot
        ) sha -- Source Hot Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceMixedAssetID],
                _la.SystemRef [OutletSourceMixedAssetSystemRef],
                _la.Location [OutletSourceMixedAssetLocation],
                _lac.Description [OutletSourceMixedAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceMixed
        ) sma -- Source Mixed Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceMainsAssetID],
                _la.SystemRef [OutletSourceMainsAssetSystemRef],
                _la.Location [OutletSourceMainsAssetLocation],
                _lac.Description [OutletSourceMainsAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceMains
        ) smna -- Source Mains Asset
    WHERE
        lo.Deleted IS NULL

    -- Get Legionella Sample data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaSampleData TABLE (JobEmployeeID INT, LegionellaID INT, LegionellaOutletID INT, LegionellaSampleID INT, SampleRefCold VARCHAR(MAX), SampleRefHot VARCHAR(MAX), SampleRefMixed VARCHAR(MAX), SampleRefMains VARCHAR(MAX), LegionellaSampleTypeIDCold INT, SampleTypeCold VARCHAR(MAX), LegionellaSampleTypeIDHot INT, SampleTypeHot VARCHAR(MAX), LegionellaSampleTypeIDMixed INT, SampleTypeMixed VARCHAR(MAX), LegionellaSampleTypeIDMains INT, SampleTypeMains VARCHAR(MAX))

    INSERT INTO @LegionellaSampleData (JobEmployeeID, LegionellaID, LegionellaOutletID, LegionellaSampleID, SampleRefCold, SampleRefHot, SampleRefMixed, SampleRefMains, LegionellaSampleTypeIDCold, SampleTypeCold, LegionellaSampleTypeIDHot, SampleTypeHot, LegionellaSampleTypeIDMixed, SampleTypeMixed, LegionellaSampleTypeIDMains, SampleTypeMains)
    SELECT
        lo.JobEmployeeID,
        lo.LegionellaID,
        lo.LegionellaOutletID,
        ls.LegionellaSampleID,
        ls.SampleRefCold,
        ls.SampleRefHot,
        ls.SampleRefMixed,
        ls.SampleRefMains,
        lstc.LegionellaSampleTypeID [LegionellaSampleTypeIDCold],
        lstc.Description [SampleTypeCold],
        lsth.LegionellaSampleTypeID [LegionellaSampleTypeIDHot],
        lsth.Description [SampleTypeHot],
        lstm.LegionellaSampleTypeID [LegionellaSampleTypeIDMixed],
        lstm.Description [SampleTypeMixed],
        lstma.LegionellaSampleTypeID [LegionellaSampleTypeIDMains],
        lstma.Description [SampleTypeMains]
    FROM
        @LegionellaOutletData lo
        INNER JOIN LegionellaSample ls WITH (NOLOCK) ON lo.LegionellaOutletID = ls.LegionellaOutletID
        LEFT JOIN LegionellaSampleType lstc WITH (NOLOCK) ON ls.LegionellaSampleTypeIDCold = lstc.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lsth WITH (NOLOCK) ON ls.LegionellaSampleTypeIDHot = lsth.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lstm WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMixed = lstm.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lstma WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMains = lstma.LegionellaSampleTypeID

    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaTaskID INT, LegionellaTaskNo INT, TaskRiskDescription VARCHAR(MAX), TaskAction VARCHAR(MAX), TaskSortOrder INT, LegionellaRiskCategoryID INT, RiskCategory VARCHAR(MAX), RiskCategorySortOrder INT, LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(MAX), FrequencyCategoryDateAddModifier VARCHAR(20), FrequencyCategoryDateAddValue INT, FrequencyCategoryDateCalc DATETIME, FrequencyCategorySortOrder INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, LegionellaPriorityRatingID INT, PriorityRating VARCHAR(MAX), ShortPriorityRating VARCHAR(20), PriorityColour VARCHAR(15), PriorityRatingSortOrder INT, LegionellaTaskAutoInsertTypeID INT, TaskAutoInsertType VARCHAR(MAX), LegionellaTaskEventID INT, EventPerformedByEmployeeID INT, EventPerformedByPortalUserID INT, EventPerformedByThirdParty VARCHAR(MAX), EventPerformedBy VARCHAR(MAX), EventComments VARCHAR(MAX), EventRecorded DATETIME, EventCreated DATETIME)

    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        lt.LegionellaTaskID,
        lt.LegionellaTaskNo,
        lt.RiskDescription [TaskRiskDescription],
        lt.Action [TaskAction],
        lt.SortOrder [TaskSortOrder],
        lrc.LegionellaRiskCategoryID,
        lrc.Description [RiskCategory],
        lrc.SortOrder [RiskCategorySortOrder],
        lfc.LegionellaFrequencyCategoryID,
        lfc.Description [FrequencyCategory],
        lfc.DateAddModifier [FrequencyCategoryDateAddModifier],
        lfc.DateAddValue [FrequencyCategoryDateAddValue],
        dbo.fn_DateAddFromStringPart(lfc.DateAddModifier, lfc.DateAddValue, lao.MonitoringSchedule) [FrequencyCategoryDateCalc],
        lfc.SortOrder [FrequencyCategorySortOrder],
        lrr.LegionellaRiskRatingID,
        lrr.Description [RiskRating],
        lrr.RiskColour,
        lrr.SortOrder [RiskRatingSortOrder],
        lpr.LegionellaPriorityRatingID,
        lpr.Description [PriorityRating],
        lpr.ShortDescription [ShortPriorityRating],
        lpr.PriorityColour,
        lpr.SortOrder [PriorityRatingSortOrder],
        ltait.LegionellaTaskAutoInsertTypeID,
        ltait.Description [TaskAutoInsertType],
        lte.LegionellaTaskEventID,
        lte.PerformedByEmployeeID [EventPerformedByEmployeeID],
        lte.PerformedByPortalUserID [EventPerformedByPortalUserID],
        lte.PerformedByThirdParty [EventPerformedByThirdParty],
        COALESCE(e.FullName, pu.FullName, lte.PerformedByThirdParty) [EventPerformedBy],
        lte.Comments [EventComments],
        lte.Recorded [EventRecorded],
        lte.Created [EventCreated]

    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
        ) lao
        LEFT JOIN LegionellaTask lt WITH (NOLOCK) ON
            CASE lao.RowType -- Join based on the main UNION
                WHEN 1 THEN lao.LegionellaID
                WHEN 3 THEN lao.LegionellaLocationID
                ELSE lao.LegionellaAssetOutletID
            END =
            CASE lao.RowType -- Join based on this live table
                WHEN 1 THEN lt.LegionellaID
                WHEN 2 THEN lt.LegionellaAssetID
                WHEN 3 THEN lt.LegionellaLocationID
                WHEN 4 THEN lt.LegionellaOutletID
            END
        LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lt.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
        LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
        LEFT JOIN LegionellaTaskAutoInsertType ltait WITH (NOLOCK) ON lt.LegionellaTaskAutoInsertTypeID = ltait.LegionellaTaskAutoInsertTypeID
        OUTER APPLY
        (
            SELECT TOP 1
                lte.LegionellaTaskEventID,
                lte.PerformedByEmployeeID,
                lte.PerformedByPortalUserID,
                lte.PerformedByThirdParty,
                lte.Comments,
                lte.Recorded,
                lte.Created
            FROM
                LegionellaTaskEvent lte WITH (NOLOCK)
            WHERE
                lte.LegionellaTaskID = lt.LegionellaTaskID
                    AND
                lte.Deleted IS NULL
            ORDER BY
                lte.Created
        ) lte -- Legionella Task Event
        LEFT JOIN Employee e WITH (NOLOCK) ON lte.PerformedByEmployeeID = e.EmployeeID
        LEFT JOIN PortalUser pu WITH (NOLOCK) ON lte.PerformedByPortalUserID = pu.PortalUserID
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
    WHERE
        lt.Deleted IS NULL
    ORDER BY
        lao.LegionellaStart,
        lao.RowType,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lt.SortOrder


    -- Get Legionella Risk data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaRiskData TABLE (LegionellaID INT, LegionellaLegRiskCategoryID INT, LegRiskCategory VARCHAR(MAX), LegRiskCategorySortOrder INT, LegionellaLegRiskRatingID INT, LegRiskRating VARCHAR(MAX), LegRiskColour VARCHAR(15), LegRiskRatingSortOrder INT)

    INSERT INTO @LegionellaRiskData (LegionellaID, LegionellaLegRiskCategoryID, LegRiskCategory, LegRiskCategorySortOrder, LegionellaLegRiskRatingID, LegRiskRating, LegRiskColour, LegRiskRatingSortOrder)
    SELECT
        lrcor.LegionellaID,
        lrc.LegionellaRiskCategoryID [LegionellaLegRiskCategoryID],
        lrc.Description [LegRiskCategory],
        lrc.SortOrder [LegRiskCategorySortOrder],
        lrr.LegionellaRiskRatingID [LegionellaLegRiskRatingID],
        lrr.Description [LegRiskRating],
        lrr.RiskColour [LegRiskColour],
        lrr.SortOrder [LegRiskRatingSortOrder]
    FROM
        LegionellaRiskCategoryOverallRisk lrcor WITH (NOLOCK)
        LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lrcor.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lrcor.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
    WHERE
        lrcor.LegionellaID IN (SELECT DISTINCT LegionellaID FROM @LegionellaData)


    -- Start the main SELECT. Get all the main counts / bits of data.
    SELECT
        (SELECT COUNT(*) FROM @LegionellaData) [NumberOfLegionellas],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 0) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringSchedule],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 1) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringSchedule_dd/MM/yyyy],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 2) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleFull],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 3) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleFullExt],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT CAST(DAY(MonitoringSchedule) AS VARCHAR(2)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleDay],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT RIGHT('0' + CAST(MONTH(MonitoringSchedule) AS VARCHAR(2)), 2) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonth],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT DATENAME(MM, MonitoringSchedule) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonthName],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT UPPER(DATENAME(MM, MonitoringSchedule)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonthNameCaps],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT CAST(YEAR(MonitoringSchedule) AS VARCHAR(4)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleYear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT BuildingDesignation FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllBuildingDesignation],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT GeneralDescriptionOfSite FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllGeneralDescriptionOfSite],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT ScopeOfWork FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllScopeOfWorks],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AreasNotAccessed FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllAreasNotAccessed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegionellaNotes FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegionellaNotes],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegRiskCategory FROM @LegionellaRiskData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegRiskCategory],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegRiskRating FROM @LegionellaRiskData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegRiskRating],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskCategoryWhereRiskCategory1],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskRatingWhereRiskCategory1],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskColourWhereRiskCategory1],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskCategoryWhereRiskCategory2],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskRatingWhereRiskCategory2],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskColourWhereRiskCategory2],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskCategoryWhereRiskCategory3],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskRatingWhereRiskCategory3],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskColourWhereRiskCategory3],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskCategoryWhereRiskCategory4],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskRatingWhereRiskCategory4],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskColourWhereRiskCategory4],
        (SELECT COUNT(*) FROM @LegionellaAssetData) [NumberOfAssets],
        STUFF((SELECT DISTINCT ', ' + AssetSystemRef FROM @LegionellaAssetData ORDER BY ', ' + AssetSystemRef FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AssetSystemRefs],
        STUFF((SELECT DISTINCT ', ' + AssetLocation FROM @LegionellaAssetData ORDER BY ', ' + AssetLocation FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AssetLocations],
        (SELECT COUNT(*) FROM @LegionellaLocationData) [NumberOfLocations],
        STUFF((SELECT DISTINCT ', ' + Location FROM @LegionellaLocationData ORDER BY ', ' + Location FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [LegionellaLocations],
        (SELECT COUNT(*) FROM @LegionellaOutletData) [NumberOfOutlets],
        STUFF((SELECT DISTINCT ', ' + OutletSystemRef FROM @LegionellaOutletData ORDER BY ', ' + OutletSystemRef FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefs],
        STUFF((SELECT DISTINCT ', ' + Location FROM @LegionellaOutletData ORDER BY ', ' + Location FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocations],
        (SELECT COUNT(*) FROM @LegionellaAssetData WHERE LegionellaAssetRiskRatingID IS NOT NULL) [NumberOfAssetsWithRiskRating],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletCold IS NOT NULL) [NumberOfOutletsWithCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) [NumberOfOutletsWithColdTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithColdTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithColdTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) [NumberOfOutletsWithColdNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithColdNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithColdNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHot IS NOT NULL) [NumberOfOutletsWithHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) [NumberOfOutletsWithHotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithHotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithHotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) [NumberOfOutletsWithHotNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithHotNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithHotNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixed IS NOT NULL) [NumberOfOutletsWithMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) [NumberOfOutletsWithMixedTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMixedTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMixedTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) [NumberOfOutletsWithMixedNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMixedNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMixedNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMains IS NOT NULL) [NumberOfOutletsWithMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) [NumberOfOutletsWithMainsTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMainsTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMainsTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) [NumberOfOutletsWithMainsNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMainsNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMainsNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) [NumberOfOutletsWithSentinelCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) [NumberOfOutletsWithSentinelHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) [NumberOfOutletsWithSentinelMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) [NumberOfOutletsWithSentinelMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) [NumberOfOutletsWithSentinelColdNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelColdNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelColdNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) [NumberOfOutletsWithSentinelHotNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHotNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHotNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) [NumberOfOutletsWithSentinelMixedNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixedNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixedNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) [NumberOfOutletsWithSentinelMainsNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMainsNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMainsNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) [NumberOfOutletsWithSentinelColdFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelColdFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelColdFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) [NumberOfOutletsWithSentinelHotFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHotFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHotFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) [NumberOfOutletsWithSentinelMixedFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixedFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixedFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) [NumberOfOutletsWithSentinelMainsFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMainsFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMainsFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) [NumberOfOutletsWithFlushedCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) [NumberOfOutletsWithFlushedHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) [NumberOfOutletsWithFlushedMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) [NumberOfOutletsWithFlushedMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) [NumberOfOutletsWithLowUseCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) [NumberOfOutletsWithLowUseHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) [NumberOfOutletsWithLowUseMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) [NumberOfOutletsWithLowUseMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseMains],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL) [NumberOfTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL) [NumberOfNonTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 1) [NumberOfLegionellaTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 1) [NumberOfNonLegionellaTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 2) [NumberOfAssetTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 2) [NumberOfNonAssetTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 3) [NumberOfLocationTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 3) [NumberOfNonLocationTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 4) [NumberOfOutletTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 4) [NumberOfNonOutletTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID IS NULL) [NumberOfTasksWithoutRiskCategory],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 1) [NumberOfTasksWithRiskCategory1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 2) [NumberOfTasksWithRiskCategory2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 3) [NumberOfTasksWithRiskCategory3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 4) [NumberOfTasksWithRiskCategory4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 5) [NumberOfTasksWithRiskCategory5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID IS NULL) [NumberOfTasksWithoutFrequencyCategory],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 1) [NumberOfTasksWithFrequencyCategory1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 2) [NumberOfTasksWithFrequencyCategory2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 3) [NumberOfTasksWithFrequencyCategory3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 4) [NumberOfTasksWithFrequencyCategory4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 5) [NumberOfTasksWithFrequencyCategory5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID IS NULL) [NumberOfTasksWithoutRiskRating],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 1) [NumberOfTasksWithRiskRating1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 2) [NumberOfTasksWithRiskRating2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 3) [NumberOfTasksWithRiskRating3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 4) [NumberOfTasksWithRiskRating4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 5) [NumberOfTasksWithRiskRating5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID IS NULL) [NumberOfTasksWithoutPriorityRating],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 1) [NumberOfTasksWithPriorityRating1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 2) [NumberOfTasksWithPriorityRating2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 3) [NumberOfTasksWithPriorityRating3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 4) [NumberOfTasksWithPriorityRating4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 5) [NumberOfTasksWithPriorityRating5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskEventID IS NOT NULL) [NumberOfTasksWithEvents],
        (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedCold = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedHot = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedMixed = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedMains = 1) [TotalNumberFlushed],
        (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDCold IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDHot IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDMixed IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDMains IS NOT NULL) [TotalSamplesTaken]


    -- Start the next SELECT. Get counts for each category.
    SELECT
        lac.LegionellaAssetCategoryID,
        lac.Description,
        'ASSETCATEGORY' + UPPER(REPLACE(lac.Description, ' ', '')) [CategoryReplaceVar],
        lac.SortOrder,
        CASE WHEN de.DoesExist = 1
            THEN (SELECT COUNT(*) FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID)
            ELSE 0
        END [CategoryCount],
        CASE WHEN de.DoesExist = 1
            THEN STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AssetSystemRef FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')
            ELSE NULL
        END [CategorySystemRefs],
        CASE WHEN de.DoesExist = 1
            THEN STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AssetLocation FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')
            ELSE NULL
        END [CategoryLocations]
    FROM
        LegionellaAssetCategory lac WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT CASE WHEN EXISTS(SELECT 1 FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) THEN 1 ELSE 0 END [DoesExist]
        ) de -- Data Exists
    WHERE
        lac.Deleted IS NULL
    ORDER BY
        lac.SortOrder


    SET NOCOUNT OFF;
END
GO

-- Drop InvoiceVatRate table
IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='InvoiceVatRate'))
BEGIN
	DROP TABLE [dbo].[InvoiceVatRate]
END 
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Project_Create_JobReinspectionStructure')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Project_Create_JobReinspectionStructure] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[Project_Create_JobReinspectionStructure]
	@ProjectID INT,
	@EmployeeID INT
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE @JRS_InsertList TABLE (JobID INT, ClientID INT, SiteID INT, EmployeeID INT)
	INSERT INTO @JRS_InsertList (JobID, ClientID, SiteID, EmployeeID)
	SELECT
		jrs.JobID, jrs.ClientID, jrs.SiteID, @EmployeeID
	FROM
	(
		Select 
			j.JobID,j.ClientID,j.SiteID,ROW_NUMBER() OVER (PARTITION BY j.ClientID,j.SiteID Order by j.Created DESC) [Identifier]
		FROM
			Project p WITH (NOLOCK)
			INNER JOIN ProjectSite ps WITH (NOLOCK) ON p.ProjectID=ps.ProjectID
			INNER JOIN Job j WITH (NOLOCK) ON j.SiteID=ps.SiteID AND p.ProjectID=j.ProjectID
			CROSS APPLY
			(
				SELECT TOP 1
					apts.AppointmentSurveyID
				FROM
					Quote q
					INNER JOIN Appointment a ON q.QuoteID = a.QuoteID
					INNER JOIN AppointmentSurvey apts ON a.AppointmentID = apts.AppointmentSurveyID
				WHERE
					q.JobID = j.JobID
			) apts
		WHERE
			p.ProjectID = @ProjectID				
	) jrs
	WHERE
		jrs.Identifier = 1

	DECLARE @JRSD_InsertList TABLE (JobID INT, RegisterID INT, FloorplanID INT, RoomID INT, SampleID INT)
	Insert into @JRSD_InsertList (JobID, RegisterID, FloorplanID, RoomID, SampleID)
	SELECT
		jrs.OriginalJobID, r.RegisterID, fp.FloorplanID, rm.RoomID, s.SampleID
	FROM
		(
			SELECT
				prej.OriginalJobID, prej.JobID
			FROM
			(
				SELECT
					jrs.JobID [OriginalJobID],j.JobID, ROW_NUMBER() OVER (Partition By jrs.JobID,j.SiteID,j.ClientID Order by j.Created DESC) [Identifier]
				FROM
					@JRS_InsertList jrs
					INNER JOIN Job j WITH (NOLOCK) ON jrs.ClientID=j.ClientID AND jrs.SiteID=j.SiteID AND jrs.JobID!=j.JobID AND j.Approved IS NOT NULL
			) prej
			WHERE
				prej.Identifier = 1
		) jrs
		INNER JOIN Job j WITH (NOLOCK) ON jrs.JobID=j.JobID
		INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID=j.JobID
		INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID=je.JobEmployeeID
		LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
		LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
		LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID

	--Delete records upfront as newly inserted rows will be what they are looking for
	DELETE FROM JobReinspectionStructure WHERE JobID IN (Select jrs.JobID FROM @JRS_InsertList jrs)

	Insert into JobReinspectionStructure ([JobID],[SessionID],[ClientID],[SiteID],[EmployeeID],[NoDataRequired])
	Select jrs.JobID,'Project Booking',jrs.ClientID,jrs.SiteID,jrs.EmployeeID,0 FROM @JRS_InsertList jrs

	Insert into JobReinspectionStructureData (JobReinspectionStructureID, RegisterID)
	Select 
		jrs.JobReinspectionStructureID, jrsd.RegisterID
	FROM 
		@JRSD_InsertList jrsd 
		INNER JOIN JobReinspectionStructure jrs WITH (NOLOCK) ON jrs.JobID=jrsd.JobID
	GROUP BY
		jrs.JobReinspectionStructureID, jrs.JobID, jrsd.RegisterID

	Insert into JobReinspectionStructureData (JobReinspectionStructureID, RegisterID, FloorplanID)
	Select 
		jrs.JobReinspectionStructureID, jrsd.RegisterID, jrsd.FloorplanID
	FROM 
		@JRSD_InsertList jrsd 
		INNER JOIN JobReinspectionStructure jrs WITH (NOLOCK) ON jrs.JobID=jrsd.JobID
	WHERE
		jrsd.FloorplanID IS NOT NULL
	GROUP BY
		jrs.JobReinspectionStructureID, jrs.JobID, jrsd.RegisterID, jrsd.FloorplanID
		
	Insert into JobReinspectionStructureData (JobReinspectionStructureID, RegisterID, FloorplanID, RoomID)
	Select 
		jrs.JobReinspectionStructureID, jrsd.RegisterID, jrsd.FloorplanID, jrsd.RoomID
	FROM 
		@JRSD_InsertList jrsd 
		INNER JOIN JobReinspectionStructure jrs WITH (NOLOCK) ON jrs.JobID=jrsd.JobID
	WHERE
		jrsd.RoomID IS NOT NULL
	GROUP BY
		jrs.JobReinspectionStructureID, jrs.JobID, jrsd.RegisterID, jrsd.FloorplanID, jrsd.RoomID
		
	Insert into JobReinspectionStructureData (JobReinspectionStructureID, RegisterID, FloorplanID, RoomID, SampleID)
	Select 
		jrs.JobReinspectionStructureID, jrsd.RegisterID, jrsd.FloorplanID, jrsd.RoomID, jrsd.SampleID
	FROM 
		@JRSD_InsertList jrsd 
		INNER JOIN JobReinspectionStructure jrs WITH (NOLOCK) ON jrs.JobID=jrsd.JobID
	WHERE
		jrsd.SampleID IS NOT NULL
	GROUP BY
		jrs.JobReinspectionStructureID, jrs.JobID, jrsd.RegisterID, jrsd.FloorplanID, jrsd.RoomID, jrsd.SampleID
	
	SET NOCOUNT OFF;

END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'PortalUserNotes')
BEGIN
    EXEC('CREATE VIEW[dbo].[PortalUserNotes] AS SELECT 1 GO')
END
GO
/* 06/06/2017 - Commented out by Stephen as there is a newer version we use on the Portal (listed below and also in the Portal SQL file). If there is a reason for using this version instead, let me know!
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER View [dbo].[PortalUserNotes]
As
Select
	NoteId,
	IsNull(Note,'') as Note,
	n.DateCreated,
	NoteType,
	ItemId,
	Case NoteType
		When 'Quote' Then
			(
				Select 
					'Q' + Right('00000'+ Cast(QuoteNo as varchar), Case When Len(QuoteNo)<=6 Then 6 Else Len(QuoteNo) End)
				From
					Quote
				Where
					QuoteID = n.ItemId
			)
		When 'Job' Then
			(
				Select 
					'J' + Right('00000'+ Cast(JobNo as varchar), Case When Len(JobNo)<=6 Then 6 Else Len(JobNo) End)
				From
					Job
				Where
					JobID = n.ItemId
			)
		When 'AirTest' Then
			(
				Select
					'J' + Right('00000'+ Cast(JobNo as varchar), Case When Len(JobNo)<=6 Then 6 Else Len(JobNo) End) +
					Case When AirTestNo > 0 Then
						' / ' + IsNull(SystemName,'') + Right('0' + Cast(AirTestNo as varchar), 2)
					Else
						''
					End
				From
					AirTest a
					Inner Join JobEmployee je On a.JobEmployeeID = je.JobEmployeeID
					Inner Join Job j On je.JobID = j.jobid
				Where
					AirTestId = n.ItemId
			)
		When 'Invoice' Then
			(
				Select 
					'I' + Right('00000'+ Cast(InvoiceNo as varchar), Case When Len(InvoiceNo)<=6 Then 6 Else Len(InvoiceNo) End)
				From
					Invoice
				Where
					InvoiceID = n.ItemId
			)
	End ItemNo, 
	pu.FullName as PortalUser,
	pu.Company,
	ISNULL(c.ClientId,cc.ClientID) [ClientId],
	ISNULL(c.Client,cc.Client) [Client]
From
	Note n 
	Inner Join NoteType t On n.NoteTypeId = t.NoteTypeId
	Inner Join PortalUser pu On n.PortalUserId = pu.PortalUserId
	LEFT Join Client c On pu.ClientId = c.ClientId
	LEFT Join ClientPortalUser cpu On pu.PortalUserId = cpu.PortalUserId
	LEFT JOIN Client cc ON cpu.ClientId = cc.ClientID

Union

Select
	Null as NoteId,
	Case When p.PhotoData Is Null Then '' Else '<img src="/images/getphoto.asp?id=' + Cast(p.PhotoId as varchar(10)) + '">' + Char(13) + Char(10) End + Comment as Note,
	na.Created as DateCreated,
	'Site' as NoteType,
	j.SiteId as ItemId,
	dbo.FormatTeamsReference('J', JobNo) as ItemNo,
	e.FullName as PortalUser,
	c.s__CompanyName as Company,
	Null as ClientId,
	Null as Client
From
	NoAccess na
	Left Outer Join Photo p On p.PhotoId = na.PhotoId And Not p.PhotoData Is Null
	Inner Join Job j On j.JobId = na.JobId
	Inner Join Employee e On e.EmployeeId = na.EmployeeId
	Cross Join Config c

Union

Select
	Null as NoteId,
	Case When p.PhotoData Is Null Then '' Else '<img src="/images/getphoto.asp?id=' + Cast(p.PhotoId as varchar(10)) + '">' + Char(13) + Char(10) End + Comment as Note,
	na.Created as DateCreated,
	'Site' as NoteType,
	na.SiteId as ItemId,
	'' as ItemNo,
	e.FullName as PortalUser,
	c.s__CompanyName as Company,
	Null as ClientId,
	Null as Client
From
	NoAccess na
	Left Outer Join Photo p On p.PhotoId = na.PhotoId And Not p.PhotoData Is Null
	Inner Join Site s On s.SiteId = na.SiteId
	Inner Join Employee e On e.EmployeeId = na.EmployeeId
	Cross Join Config c

GO*/
ALTER VIEW [dbo].[PortalUserNotes]
AS

-- Notes for a Portal User.
SELECT
    n.NoteId,
    ISNULL(n.Note, '') [Note],
    n.DateCreated,
    nt.NoteType,
    n.ItemId,
    CASE nt.NoteType
        WHEN 'Quote' THEN
            (
                SELECT dbo.FormatTeamsReference('Q', QuoteNo)
                FROM Quote WITH (NOLOCK)
                WHERE QuoteID = n.ItemID
            )
        WHEN 'Job' THEN
            (
                SELECT dbo.FormatTeamsReference('J', JobNo)
                FROM Job WITH (NOLOCK)
                WHERE JobID = n.ItemID
            )
        WHEN 'AirTest' THEN
            (
                SELECT
                    dbo.FormatTeamsReference('J', _j.JobNo) +
                    CASE WHEN _at.AirTestNo > 0
                        THEN ' / ' + ISNULL(_at.SystemName,'') + RIGHT('0' + CAST(_at.AirTestNo AS VARCHAR(100)), 2)
                        ELSE ''
                    END
                FROM
                    AirTest _at WITH (NOLOCK)
                    INNER JOIN JobEmployee _je WITH (NOLOCK) ON _at.JobEmployeeID = _je.JobEmployeeID
                    INNER JOIN Job _j WITH (NOLOCK) ON _je.JobID = _j.jobid
                WHERE
                    _at.AirTestID = n.ItemID
            )
        WHEN 'Invoice' THEN
            (
                SELECT dbo.FormatTeamsReference('I', InvoiceNo)
                FROM Invoice WITH (NOLOCK)
                WHERE InvoiceID = n.ItemID
            )
    END [ItemNo],
    pu.FullName [PortalUser],
    pu.Company,
    c.ClientId,
    c.Client
FROM
    Note n WITH (NOLOCK)
    INNER JOIN NoteType nt WITH (NOLOCK) ON n.NoteTypeID = nt.NoteTypeID
    INNER JOIN PortalUser pu WITH (NOLOCK) ON n.PortalUserID = pu.PortalUserID
    LEFT JOIN Client c WITH (NOLOCK) ON pu.ClientID = c.ClientID -- Invalid now, but kept in for the old Portal

UNION

-- No Access for a Job.
SELECT
    NULL [NoteId],
    CASE WHEN p.PhotoData IS NULL
        THEN ''
        ELSE '<img src="/File/GetPhoto?id=' + CAST(p.PhotoID AS VARCHAR(100)) + '&width=150" />' + CHAR(13)+CHAR(10)
    END + na.Comment [Note],
    na.Created [DateCreated],
    'Site' [NoteType],
    j.SiteID [ItemId],
    dbo.FormatTeamsReference('J', j.JobNo) [ItemNo],
    e.FullName [PortalUser],
    cfg.s__CompanyName [Company],
    NULL [ClientId],
    NULL [Client]
FROM
    NoAccess na WITH (NOLOCK)
    LEFT JOIN Photo p WITH (NOLOCK) ON na.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
    INNER JOIN Job j WITH (NOLOCK) ON na.JobID = j.JobID
    INNER JOIN Employee e WITH (NOLOCK) ON na.EmployeeID = e.EmployeeID
    CROSS JOIN Config cfg WITH (NOLOCK)

UNION

-- No Access for a Site.
SELECT
    NULL [NoteId],
    CASE WHEN p.PhotoData IS NULL
        THEN ''
        ELSE '<img src="/File/GetPhoto?id=' + CAST(p.PhotoID AS VARCHAR(100)) + '&width=150" />' + CHAR(13)+CHAR(10)
    END + na.Comment [Note],
    na.Created [DateCreated],
    'Site' [NoteType],
    si.SiteID [ItemId],
    '' [ItemNo],
    e.FullName [PortalUser],
    cfg.s__CompanyName [Company],
    NULL [ClientId],
    NULL [Client]
FROM
    NoAccess na WITH (NOLOCK)
    LEFT JOIN Photo p WITH (NOLOCK) ON na.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
    INNER JOIN Site si WITH (NOLOCK) ON na.SiteID = si.SiteID
    INNER JOIN Employee e WITH (NOLOCK) ON na.EmployeeID = e.EmployeeID
    CROSS JOIN Config cfg WITH (NOLOCK)

UNION

-- Air Test Photos from the Site Log.
SELECT
    NULL [NoteId],
    CASE WHEN p.PhotoData IS NULL
        THEN ''
        ELSE '<img src="/File/GetPhoto?id=' + CAST(p.PhotoID AS VARCHAR(100)) + '&width=150" />' + CHAR(13)+CHAR(10)
    END + sl.Description [Note],
    sl.Recorded [DateCreated],
    'Airtest' [NoteType],
    at.AirTestID [ItemId],
    dbo.FormatTeamsReference('J', j.JobNo) +
        CASE WHEN at.AirTestNo > 0
            THEN
                CASE WHEN at.AirTestNo <= 99
                    THEN ' / ' + ISNULL(at.SystemName,'') + RIGHT('0' + CAST(at.AirTestNo AS VARCHAR(100)), 2)
                    ELSE ' / ' + ISNULL(at.SystemName,'') + CAST(at.AirTestNo AS VARCHAR(100))
                END
            ELSE ''
        END
    [ItemNo],
    e.FullName [PortalUser],
    cfg.s__CompanyName [Company],
    c.ClientID [ClientId],
    c.Client [Client]
FROM
    Job j WITH (NOLOCK)
    INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
    INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
    INNER JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
    INNER JOIN SiteLog sl WITH (NOLOCK) ON at.AirTestID = sl.AirTestID
    INNER JOIN Employee e WITH (NOLOCK) ON sl.EmployeeID = e.EmployeeID
    INNER JOIN Photo p WITH (NOLOCK) ON sl.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
    CROSS JOIN Config cfg WITH (NOLOCK)
WHERE
    cfg.b__ShowAirTestImagesPortalNotes = 1

GO

-- EquipmentCalibrationForPeriod
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EquipmentCalibrationForPeriod')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EquipmentCalibrationForPeriod] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[EquipmentCalibrationForPeriod]
    @iDay as int = null,
    @iMonth as int = null,
    @iYear as int,
    @vcTime as varchar(8) = '',
    @forweek as int = 0,
    @needOutOfScope as bit = 0,
    @BranchOfficeID AS int = 0,
    @employeeHasEnquiryFollowUp AS bit = 0,
    @EquipmentAdministrator AS bit = 0,
    @employeeIDForEnquirees AS int =0

WITH RECOMPILE
AS
BEGIN
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT OFF;


    declare
        @passedAsDate datetime,
        @tmp varchar(MAX)

      /*
      NOTE 
            always pass a year
            if you pass in a day and month number this will list items for a day,
            if you pass in just a month number it will list for a month,
            just a year number then it will list for a year
      */

      if @forweek > 0 and not @iday is null
      begin
            select @tmp = convert(varchar,@iDay) + ' '
            select @tmp = @tmp + DATENAME(month, STR(@iYear, 4) + '/' + REPLACE(STR(@iMonth, 2), ' ', '0') + '/01') + ' '
            select @tmp = @tmp + convert(varchar,@iYear)
            select @tmp = @tmp + ' ' + isnull(@vcTime,'')
            select @passedAsDate = CONVERT(datetime,@tmp)
            
        SELECT
            [tbl].[scheduleSortOrder],
            [tbl].[id],
            [tbl].[refno],
            [tbl].[serialNumber],
            [tbl].[description],
            [tbl].[displayDate],
            [tbl].[EquipmentCategoryID],
            [tbl].[catDesc],
            [tbl].[isLate],
            [tbl].[actualDate],
            [tbl].[EquipmentAssignedEmployee]
        FROM 
        (
            SELECT
                0                                                   [scheduleSortOrder],
                [enq].[EnquiryID]                                   [id],
                dbo.[FormatTeamsReference]('E',[enq].[EnquiryNo]) /*+ 
                    CASE WHEN ISNULL([enq].[AssignedEmployeeid],0)=0 THEN 
                        '- UNASSIGNED'
                    END*/                                           [refno],
                NULL                                                [serialNumber],
                [enq].[Client]                                      [description],
                CONVERT(varchar,enq.[ReminderDate],107)             [displayDate],
                NULL                                                [EquipmentCategoryID],
                NULL                                                [catDesc],
                case
                    WHEN enq.[ReminderDate] <@passedAsDate and @needOutOfScope = 1 then
                          1
                   else
                          0
                END                                                 [isLate],
                enq.[ReminderDate]                                  [actualDate],
                0                                                   [EquipmentAssignedEmployee]
            FROM 
                [dbo].[Enquiry] enq
            WHERE
                (
                    ([enq].[ReminderDate] BETWEEN @passedAsDate AND DATEADD(DAY,@forweek * 7,@passedAsDate)) OR 
                    ([enq].[ReminderDate] <GETDATE() AND @needOutOfScope = 1)
                )            
                AND
                enq.[DateDiscarded] IS NULL AND
				enq.[QuoteID] IS NULL AND
                [enq].[ReminderDate] IS NOT NULL 
                AND
                (
                    (@employeeHasEnquiryFollowUp = 1 AND (enq.[AssignedEmployeeid] = @employeeIDForEnquirees)  AND @employeeIDForEnquirees>0) OR
                    ISNULL([enq].[AssignedEmployeeid],0)=0
                )

            UNION

            SELECT
                1                                                   [scheduleSortOrder],
                [q].[quoteid]                                       [id],
                dbo.[FormatTeamsReference]('Q',[q].[Quoteno])       [refno],
                NULL                                                [serialNumber],
                [c].[Client]                                        [description],
                CONVERT(varchar,q.[ReminderDate],107)               [displayDate],
                NULL                                                [EquipmentCategoryID],
                NULL                                                [catDesc],
                case
                    WHEN q.[ReminderDate] <@passedAsDate and @needOutOfScope = 1 then
                          1
                    else
                          0
                END                                                 [isLate],
                q.[ReminderDate]                                    [actualDate],
                0                                                   [EquipmentAssignedEmployee]
            FROM 
                [dbo].[quote] q
                LEFT OUTER JOIN [dbo].[Client] AS c ON q.[ClientID] = [c].[ClientID]
            WHERE
                (
                    ([q].[ReminderDate] BETWEEN @passedAsDate AND DATEADD(DAY,@forweek * 7,@passedAsDate)) OR 
                    ([q].[ReminderDate] <GETDATE() AND @needOutOfScope = 1)
                )            
                AND
                [q].[Rejected] IS NULL and
                [q].[Accepted] IS NULL and
                [q].[ReminderDate] IS NOT NULL 
                AND
                (
                    (@employeeHasEnquiryFollowUp = 1 AND ([q].[AssignedEmployeeID] = @employeeIDForEnquirees)  AND @employeeIDForEnquirees>0) OR
                    ISNULL([q].[AssignedEmployeeid],0)=0
                )

            UNION

            SELECT 
                2                                                   [scheduleSortOrder],
                Equipment.EquipmentID                               [id],
                Equipment.RefNo                                     [refno],
                Equipment.SerialNumber                              [serialNumber],
                Equipment.Description                               [description],
                CONVERT(varchar,dbo.CalibrationDueDate(EquipmentID),107) [displayDate],
                Equipment.EquipmentCategoryID                       [EquipmentCategoryID],
                equipmentcategory.Description                       [catDesc],
                CASE
                      when dbo.CalibrationDueDate(EquipmentID) <@passedAsDate and @needOutOfScope = 1 then
                            1
                      else
                            0
                END                                                 [isLate],
                dbo.CalibrationDueDate(EquipmentID)                 [actualdate],
                0                                                   [EquipmentAssignedEmployee]
            from 
                  Equipment 
                  inner join equipmentcategory on equipmentcategory.equipmentcategoryID = equipment.EquipmentCategoryID 
            where
                  (
                        (dbo.CalibrationDueDate(EquipmentID) between @passedAsDate and DATEADD(DAY,@forweek * 7,@passedAsDate)) or
                        (dbo.CalibrationDueDate(EquipmentID) <GETDATE() and @needOutOfScope = 1) 
                  )
                  And Equipment.NotInUse = 0
                  and Equipment.Deleted is null
                  and Equipment.IntervalCheck != 5
                and @EquipmentAdministrator = 1
                and
                (
                    (
                        @BranchOfficeID = 0
                    )
                    OR
                    (
                        @BranchOfficeID !=0 AND
                        Equipment.[BranchOfficeID] = @BranchOfficeID
                    )
                )

            UNION

            SELECT 
                3                                                   [scheduleSortOrder],
                Equipment.EquipmentID                               [id],
                Equipment.RefNo                                     [refno],
                Equipment.SerialNumber                              [serialNumber],
                Equipment.Description                               [description],
                CONVERT(varchar,dbo.CalibrationDueDate(Equipment.EquipmentID),107) [displayDate],
                Equipment.EquipmentCategoryID                       [EquipmentCategoryID],
                equipmentcategory.Description                       [catDesc],
                CASE
                    when dbo.CalibrationDueDate(Equipment.EquipmentID) <@passedAsDate and @needOutOfScope = 1 then
                          1
                    else
                          0
                END                                                 [isLate],
                dbo.CalibrationDueDate(Equipment.EquipmentID)       [actualdate],
                EquipmentAssigned.EmployeeID                        [EquipmentAssignedEmployee]
            from 
                  Equipment 
                  inner join equipmentcategory on equipmentcategory.equipmentcategoryID = equipment.EquipmentCategoryID 
                  INNER JOIN EquipmentAssigned on equipment.EquipmentID = EquipmentAssigned.EquipmentID and EquipmentAssigned.Deleted IS NULL
            where
                  (
                        (dbo.CalibrationDueDate(Equipment.EquipmentID) between @passedAsDate and DATEADD(DAY,@forweek * 7,@passedAsDate)) or
                        (dbo.CalibrationDueDate(Equipment.EquipmentID) <GETDATE() and @needOutOfScope = 1) 
                  )
                  And Equipment.NotInUse = 0
                  and Equipment.Deleted is null
                  and Equipment.IntervalCheck != 5
                and @EquipmentAdministrator = 1
                              AND
                        EquipmentCategory.LabType = 1
                and
                (
                    (
                        @BranchOfficeID = 0
                    )
                    OR
                    (
                        @BranchOfficeID !=0 AND
                        Equipment.[BranchOfficeID] = @BranchOfficeID
                    )
                )
        ) tbl
        order BY
            scheduleSortOrder,
            isLate,
            actualDate
      END
      ELSE
      BEGIN
        SELECT
            [tbl].[scheduleSortOrder],
            [tbl].[id],
            [tbl].[refno],
            [tbl].serialnumber,
            [tbl].[description],
            [tbl].[displayDate],
            [tbl].equipmentcategoryid,
            [tbl].catdesc,
            [tbl].[isLate],
            [tbl].[actualDate],
            [tbl].[EquipmentAssignedEmployee]
        FROM
        (
            SELECT
                0                                                   [scheduleSortOrder],
                [enq].[EnquiryID]                                   [id],
                dbo.[FormatTeamsReference]('E',[enq].[EnquiryNo]) /*+ 
                    CASE WHEN ISNULL([enq].[AssignedEmployeeid],0)=0 THEN 
                        '- UNASSIGNED'
                    END */                                          [refno],
                NULL                                                [serialnumber],
                [enq].[Client]                                      [description],
                CONVERT(varchar,enq.[ReminderDate],107)             [displayDate],
                NULL                                                [EquipmentCategoryID],
                NULL                                                [catDesc],
                CASE
                    WHEN enq.[ReminderDate] <@passedAsDate and @needOutOfScope = 1 then
                          1
                    else
                          0
                END                                                 [isLate],
                enq.[ReminderDate]                                  [actualDate],
                0                                                   [EquipmentAssignedEmployee]
            FROM 
                [dbo].[Enquiry] enq
            WHERE
                (
                        (
                              (DAY(enq.[ReminderDate])=@iDay or @iDay is null) and
                              (year(enq.[ReminderDate])=@iYear or @iYear is null) and 
                              (month(enq.[ReminderDate])=@iMonth or @iMonth is null)
                        )
                        or 
                        (
                            (enq.[ReminderDate] <GETDATE() and @needOutOfScope = 1)
                        )
                ) AND
                enq.[DateDiscarded] IS NULL AND
				enq.[QuoteID] IS NULL AND
                [enq].[ReminderDate] IS NOT NULL 
                AND
                (
                    (@employeeHasEnquiryFollowUp = 1 AND (enq.[AssignedEmployeeid] = @employeeIDForEnquirees)  AND @employeeIDForEnquirees>0) OR
                    ISNULL([enq].[AssignedEmployeeid],0)=0
                )

            UNION

            SELECT
                1                                                   [scheduleSortOrder],
                [QuoteID]                                           [id],
                dbo.[FormatTeamsReference]('Q',[q].[quoteno])       [refno],
                NULL                                                [serialnumber],
                [c].[Client]                                        [description],
                CONVERT(varchar,q.[ReminderDate],107)               [displayDate],
                NULL                                                [EquipmentCategoryID],
                NULL                                                [catDesc],
                case
                    WHEN q.[ReminderDate] <@passedAsDate and @needOutOfScope = 1 then
                          1
                    else
                          0
                END                                                 [isLate],
                q.[ReminderDate]                                    [actualDate],
                0                                                   [EquipmentAssignedEmployee]
            FROM 
                [dbo].[quote] q
                LEFT OUTER JOIN [dbo].[Client] c ON [c].[ClientID] = [q].[ClientID]
            WHERE
                (
                        (
                              (DAY(q.[ReminderDate])=@iDay or @iDay is null) and
                              (year(q.[ReminderDate])=@iYear or @iYear is null) and 
                              (month(q.[ReminderDate])=@iMonth or @iMonth is null)
                        )
                        or 
                        (
                            (q.[ReminderDate] <GETDATE() and @needOutOfScope = 1)
                        )
                ) AND
                [q].[Rejected] IS NULL AND
                [q].[ReminderDate] IS NOT NULL 
                AND
                (
                    (@employeeHasEnquiryFollowUp = 1 AND (q.[AssignedEmployeeid] = @employeeIDForEnquirees)  AND @employeeIDForEnquirees>0) OR
                    ISNULL([q].[AssignedEmployeeid],0)=0
                )

            UNION

            SELECT 
                2                                                   [scheduleSortOrder],
                Equipment.EquipmentID                               [id],
                Equipment.RefNo                                     [refNo],
                Equipment.SerialNumber                              [serialNumber],
                Equipment.Description                               [descrption],
                CONVERT(varchar,dbo.CalibrationDueDate(EquipmentID),107) [displayDate],
                Equipment.EquipmentCategoryID                       [equipmentCategoryid],
                equipmentcategory.Description                       [catDesc],
                case
                    when dbo.CalibrationDueDate(EquipmentID) <GETDATE() and @needOutOfScope=1 then
                          1
                    else
                          0
                END                                                 [isLate],
                dbo.CalibrationDueDate(EquipmentID)                 [actualdate],
                0                                                   [EquipmentAssignedEmployee]
            from 
                  Equipment 
                  inner join equipmentcategory on equipmentcategory.equipmentcategoryID = equipment.EquipmentCategoryID 
            where
                  ( 
                        (
                              (DAY(dbo.CalibrationDueDate(EquipmentID))=@iDay or @iDay is null) and
                              (year(dbo.CalibrationDueDate(EquipmentID))=@iYear or @iYear is null) and 
                              (month(dbo.CalibrationDueDate(EquipmentID))=@iMonth or @iMonth is null)
                        )
                        or 
                        (
                            dbo.CalibrationDueDate(EquipmentID) <GETDATE() and @needOutOfScope = 1
                        )
                  )
                  And Equipment.NotInUse = 0
                  and Equipment.Deleted is null
                  and Equipment.IntervalCheck != 5
                and @EquipmentAdministrator = 1
                and
                (
                    (
                        @BranchOfficeID = 0
                    )
                    OR
                    (
                        @BranchOfficeID !=0 AND
                        Equipment.[BranchOfficeID] = @BranchOfficeID
                    )
                )

            UNION

            SELECT 
                3                                                   [scheduleSortOrder],                                
                Equipment.EquipmentID                               [id],
                Equipment.RefNo                                     [refNo],
                Equipment.SerialNumber                              [serialNumber],
                Equipment.Description                               [descrption],
                CONVERT(varchar,dbo.CalibrationDueDate(Equipment.EquipmentID),107) [displayDate],
                Equipment.EquipmentCategoryID                       [equipmentCategoryid],
                equipmentcategory.Description                       [catDesc],
                CASE
                    when dbo.CalibrationDueDate(Equipment.EquipmentID) <GETDATE() and @needOutOfScope=1 then
                          1
                    else
                          0
                END                                                 [isLate],
                dbo.CalibrationDueDate(Equipment.EquipmentID)       [actualdate],
                EquipmentAssigned.EmployeeID                        [EquipmentAssignedEmployee]
            from 
                  Equipment 
                  inner join equipmentcategory on equipmentcategory.equipmentcategoryID = equipment.EquipmentCategoryID
                  INNER JOIN EquipmentAssigned on equipment.EquipmentID = EquipmentAssigned.EquipmentID and EquipmentAssigned.Deleted IS NULL
            where
                  ( 
                        (
                              (DAY(dbo.CalibrationDueDate(Equipment.EquipmentID))=@iDay or @iDay is null) and
                              (year(dbo.CalibrationDueDate(Equipment.EquipmentID))=@iYear or @iYear is null) and 
                              (month(dbo.CalibrationDueDate(Equipment.EquipmentID))=@iMonth or @iMonth is null)
                        )
                        or 
                        (
                            dbo.CalibrationDueDate(Equipment.EquipmentID) <GETDATE() and @needOutOfScope = 1
                        )
                  )
                  And Equipment.NotInUse = 0
                  and Equipment.Deleted is null
                  and Equipment.IntervalCheck != 5
                and @EquipmentAdministrator = 1
                              AND
                        EquipmentCategory.LabType = 1
                and
                (
                    (
                        @BranchOfficeID = 0
                    )
                    OR
                    (
                        @BranchOfficeID !=0 AND
                        Equipment.[BranchOfficeID] = @BranchOfficeID
                    )
                )
        ) tbl
        order by
            scheduleSortOrder,
            isLate,
            actualDate
      END

END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Latitude' AND OBJECT_ID = OBJECT_ID('Photo'))
BEGIN
    ALTER TABLE Photo
	ADD [Latitude] [varchar](max) NULL
END

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Longitude' AND OBJECT_ID = OBJECT_ID('Photo'))
BEGIN
    ALTER TABLE Photo
    ADD [Longitude] [varchar](max) NULL
END

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Location' AND OBJECT_ID = OBJECT_ID('Photo'))
BEGIN
    ALTER TABLE Photo
    ADD [Location] [geography] NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_OpenSurveys')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_OpenSurveys] AS BEGIN SET NOCOUNT ON; END')
END
GO
-- ======================================================
-- Author:			Lonny (Bulk of the logic done by Joe)
-- Create date:		11/11/2016
-- Changes:			18/11/2016 - No Access fixed by Joe
-- ======================================================
ALTER PROCEDURE [dbo].[Paged_OpenSurveys]
	-- Paging
    @PerPage INT = 30,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
	@JobID INT = 0,

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchId INT = 0, -- (0=all)
    @EmployeeId INT = 0, -- (0=all)
    @SurveyTypeId VARCHAR(MAX) = '', -- (0=all) 
	@Accessibility INT = 0,-- (0=all, 1=accessible, 2=not accessible)
	@OrgStateId INT = NULL, -- (NULL=all), 0 = Queued
	@ExcludeClientId INT = 0, -- (0=don't exclude any)
    @IsSupplementary INT = 0 --(0=all, 1=non supplementary, 2=only supplementary)

	/*
		0              Queued
		2              Import Failed
		5              Preview Generation Failed
		6              Preview Generation Succeeded
		9              Approved Generation Failed
		100         Rejected By Surveyor
		101         Rejected By Quality Control
		200         Awaiting Surveyor Approval
		201         Awaiting Final Approval
	*/
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;


    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @OpenSurveysView TABLE (JobID INT, SurveyTypeID INT, Created DATETIME, StartTime DATETIME, DueDate DATETIME, NoAccess BIT, orgStateID INT, orgInstructionID INT,AllRegistersComplete INT, [HasRegister] BIT, IsSupplementary BIT) -- Add columns as necessary

	Insert into @OpenSurveysView (JobID, SurveyTypeID, Created, StartTime, DueDate, NoAccess, orgStateID, orgInstructionID, AllRegistersComplete, [HasRegister], IsSupplementary)
	Select
		jd.JobID, IsNull(su.SurveyTypeID,jd.SurveyTypeID), jd.Created, jd.StartTime, jd.DueDate, 
		CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL /*AND s.SampleID IS NOT NULL*/ THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END [NoAccess], 
		MAX(o.orgStateID) [orgInstructionID], MAX(o.orgInstructionID) [orgInstructionID], MIN(ISNULL(CAST(reg.RegisterComplete as INT),1)) [AllRegistersComplete], MIN(ISNULL(CASE WHEN reg.RegisterID IS NOT NULL THEN 1 ELSE 0 END,0)) [HasRegister], MAX(ISNULL(CASE WHEN sc.JobId IS NOT NULL THEN 1 ELSE 0 END,0)) [IsSupplementary]
	FROM
		(
			Select 
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate]
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
				INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
				INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
				INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
				INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
				INNER JOIN Survey surv WITH (NOLOCK) ON r.SurveyID = surv.SurveyID
			WHERE
				(
					a.DateDeclined IS NULL
							AND
					j.JobID = CASE WHEN @JobID > 0 AND @ClientID = 0 AND @SiteID = 0 AND @ProjectID = 0 THEN @JobID END
				)
					OR
				(
					a.DateDeclined IS NULL
						AND
					(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN r.RegisterFinish BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
							AND		
					(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID!=@ExcludeClientId THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @SurveyTypeId = '' THEN 1 ELSE CASE WHEN ISNULL(surv.SurveyTypeID,aSurv.SurveyTypeID) IN ((select CONVERT(int,s) from dbo.SplitString(ltrim(rtrim(@SurveyTypeId)), ','))) THEN 1 ELSE 0 END END = 1)
				)
			GROUP BY
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved
		) jd
		LEFT OUTER JOIN SupplementaryChanges sc ON sc.JobId=jd.JobID AND @IsSupplementary IN (0,2)
		INNER JOIN Site si WITH (NOLOCK) ON jd.SiteID=si.SiteID
		LEFT OUTER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		LEFT OUTER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId-- AND (@Accessibility IN (0,1))
		LEFT OUTER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId 
		LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID AND na.Deleted IS NULL-- AND (@Accessibility IN (0,2))
		LEFT OUTER JOIN orgInstruction o WITH (NOLOCK) ON o.JobID=jd.JobID AND o.Completed IS NULL AND o.Deleted IS NULL AND ISNULL(NULLIF(o.GenerationType,'survey'),'')=''
		Left Outer Join orgState s On o.orgStateID = s.orgStateID
		Left Outer Join SurveyApproval sa On sa.orgInstructionId = o.orgInstructionId And sa.DateDeleted Is Null
		Left Outer Join JobEmployee saje On saje.JobId = jd.JobId And saje.EmployeeId = sa.EmployeeId And saje.MainEmployee = 1
		Cross Join Config
	WHERE
		(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN je.EmployeeID=@EmployeeId THEN 1 ELSE 0 END END = 1)
			AND
		(
			CASE WHEN @OrgStateId IS NULL THEN 
				1 
			ELSE 
				CASE @OrgStateId
					WHEN 100 THEN
						Case When jd.RejectedBySurveyor = 1 Then 1 ELSE 0 END
					WHEN 101 THEN
						CASE When jd.RejectedByQC = 1 Then 1 ELSE 0 END
					WHEN 200 THEN
						Case When 
						   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
								  And 
						   o.orgStateID = 6 -- Preview Generation Succeeded
								  And
						   sa.SurveyApprovalId IS NOT NULL -- Office Approved
								  And
						   saje.JobEmployeeId IS NULL -- Not Surveyor Approved
						Then 1 Else 0
						End
					WHEN 201 THEN
						Case When
						   sa.SurveyApprovalId IS NOT NULL -- Office Approved
								  And 
						   o.orgStateID = 6 -- Preview Generation Succeeded
						Then 1 Else 0
						End
					WHEN 202 THEN
						CASE When o.orgInstructionID IS NULL Then 1 ELSE 0 END
					ELSE
						CASE WHEN o.orgStateID=@OrgStateId THEN 
							CASE WHEN @OrgStateId = 6 THEN
								CASE WHEN
									jd.RejectedBySurveyor = 0 
										AND 
									jd.RejectedByQC = 0
										AND
									(
										sa.SurveyApprovalId IS NULL
											OR
										(
											NOT ((Config.b__SurveyorApprovalRequired) = 1 AND saje.JobEmployeeId IS NULL)
										)
									)
								THEN 1 ELSE 0 END
							ELSE 1 END
						ELSE 0 END
				END
			END = 1
		)
			AND
		(
			CASE WHEN @Accessibility = 0 THEN
				CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN 
					CASE WHEN reg.DateApproved IS NULL OR jd.Approved IS NULL THEN 
						1 
					ELSE 
						0 
					END 
				ELSE 
					CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) AND jd.Approved IS NULL THEN 
						1
					ELSE 
						0
					END 
				END
			ELSE
				CASE WHEN @Accessibility = 1 THEN
					CASE WHEN reg.DateApproved IS NULL OR jd.Approved IS NULL THEN 
						CASE WHEN reg.RegisterID IS NOT NULL AND CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) THEN 0 ELSE 1 END = 1 THEN 
							1 
						ELSE 
							0 
						END
					ELSE 
						0
					END
				ELSE
					CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END
				END
			End = 1
		)
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
	GROUP BY
		jd.JobID, jd.Created, IsNull(su.SurveyTypeID,jd.SurveyTypeID), jd.StartTime, jd.DueDate, CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL /*AND s.SampleID IS NOT NULL*/ THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END
	
	Insert into @OpenSurveysView (JobID, SurveyTypeID, Created, StartTime, DueDate, NoAccess, orgStateID, orgInstructionID, AllRegistersComplete, [HasRegister], IsSupplementary)
	Select
		jd.JobID, jd.SurveyTypeID, jd.Created, jd.StartTime, jd.DueDate, 
		1 [NoAccess], 
		NULL [orgInstructionID], NULL [orgInstructionID], 1 [AllRegistersComplete], 0 [HasRegister], 0 [IsSupplementary]
	FROM
		(
			Select 
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate]
			FROM
				NoAccess na WITH (NOLOCK)
				INNER JOIN Job j WITH (NOLOCK) ON na.JobID=j.JobID
				INNER JOIN Quote q WITH (NOLOCK) ON q.JobId = j.JobId
				INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteId = q.QuoteId
				INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentId = aSurv.AppointmentId
				LEFT OUTER JOIN @OpenSurveysView osv ON osv.JobID = j.JobID
			WHERE
				a.DateDeclined IS NULL
					AND
				osv.JobID IS NULL
					AND
				(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN na.Created BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID!=@ExcludeClientId THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SurveyTypeId = '' THEN 1 ELSE CASE WHEN aSurv.SurveyTypeID IN ((select CONVERT(int,s) from dbo.SplitString(ltrim(rtrim(@SurveyTypeId)), ','))) THEN 1 ELSE 0 END END = 1)
			GROUP BY
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved
		) jd
		INNER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID
		INNER JOIN Site si WITH (NOLOCK) ON jd.SiteID=si.SiteID
		/*
		LEFT OUTER JOIN SupplementaryChanges sc ON sc.JobId=jd.JobID AND @IsSupplementary IN (0,2)
		
		LEFT OUTER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		LEFT OUTER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId-- AND (@Accessibility IN (0,1))
		LEFT OUTER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId 
		LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID AND na.Deleted IS NULL-- AND (@Accessibility IN (0,2))
		LEFT OUTER JOIN orgInstruction o WITH (NOLOCK) ON o.JobID=jd.JobID AND o.Completed IS NULL AND o.Deleted IS NULL AND ISNULL(NULLIF(o.GenerationType,'survey'),'')=''
		Left Outer Join orgState s On o.orgStateID = s.orgStateID
		Left Outer Join SurveyApproval sa On sa.orgInstructionId = o.orgInstructionId And sa.DateDeleted Is Null
		Left Outer Join JobEmployee saje On saje.JobId = jd.JobId And saje.EmployeeId = sa.EmployeeId And saje.MainEmployee = 1
		*/
		Cross Join Config
	WHERE
		(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN na.EmployeeID=@EmployeeId THEN 1 ELSE 0 END END = 1)
			AND
		(
			CASE WHEN @OrgStateId IS NULL THEN 1 ELSE 0 END = 1
		)
			AND
		(
			CASE WHEN @Accessibility = 0 THEN
				1
			ELSE
				CASE WHEN @Accessibility = 1 THEN
					0
				ELSE
					1
				END
			End = 1
		)
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
	GROUP BY
		jd.JobID, jd.Created, jd.SurveyTypeID, jd.StartTime, jd.DueDate
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@OpenSurveysView
			)

	DECLARE @OpenSurveyTopLevel TABLE (TotalRows INT, Pages INT, page INT, RowNumber INT, JobID INT, BranchOfficeID INT, ClientID INT, SiteID INT, ReportType VARCHAR(MAX), SurveyTypeID INT, JobNo INT, ClientOrderNo VARCHAR(MAX), StartTime DATETIME, DueDate DATETIME, Client VARCHAR(MAX), SiteAddress VARCHAR(MAX), UPRN VARCHAR(MAX), orgStateID INT, orgInstructionID INT, NoAccess BIT,IsNew BIT, HasNotes BIT, NotesInLastHour BIT, HasRegister BIT, IsSupplementary BIT)
    DECLARE @OpenSurveyRiskFile TABLE (TotalRows INT, Pages INT, page INT, RowNumber INT, JobID INT, BranchOfficeID INT, ClientID INT, SiteID INT, ReportType VARCHAR(MAX), SurveyTypeID INT, JobNo INT, ClientOrderNo VARCHAR(MAX), StartTime DATETIME, DueDate DATETIME, Client VARCHAR(MAX), SiteAddress VARCHAR(MAX), UPRN VARCHAR(MAX), orgStateID INT, orgInstructionID INT, NoAccess BIT,IsNew BIT, HasNotes BIT, NotesInLastHour BIT, HasRegister BIT, IsSupplementary BIT, [RiskFileName] VARCHAR(MAX))
    DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
    DECLARE @SurveyData TABLE (JobID INT,FloorplanID INT,FloorplanHasData BIT,SampleID INT,PhotoID INT,HasPhotoData BIT,PhysicalSample BIT,Content BIT,Verified INT,IsSampleExchange INT,SentToSampleExchange INT,AllCheckedIn INT, Analysed INT, SampleCount INT)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.DueDate ASC, a.StartTime ASC)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.DueDate ASC, a.StartTime ASC) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @OpenSurveysView WHERE AllRegistersComplete = 1
            ) a
    )
        
    Insert into @OpenSurveyTopLevel (TotalRows, Pages, page, RowNumber, JobID, BranchOfficeID, ClientID, SiteID, ReportType, SurveyTypeID, JobNo, ClientOrderNo, StartTime, DueDate, Client, SiteAddress, UPRN, orgStateID,orgInstructionID, NoAccess, IsNew, HasNotes, HasRegister, IsSupplementary, NotesInLastHour)
    Select  
		-- Columns for paging
        @TotalRowNumber [TotalRows],
        main.Pages [Pages],
        main.Page [Page],
        main.RowNumber [RowNumber],

		-- ID columns 
        main.JobID [JobID],
		j.BranchOfficeID [BranchOfficeID],
		c.ClientID [ClientID],
		s.SiteId [SiteID],

		-- Columns for grid
		sut.[Description] [ReportType],
		sut.SurveyTypeID,
        j.JobNo [JobNo],
        j.ClientOrderNo [ClientOrderNo],
		main.StartTime [StartDate],
		main.DueDate [DueDate],
		c.Client + IsNull(Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' End, '') [Client],
        s.[Address] + ', ' + s.Postcode [SiteAddress],
		s.UPRN [UPRN],
		main.orgStateID [orgStateID],
		main.orgInstructionID [orgInstructionID],
		main.NoAccess [NoAccess],
		
		-- Columns needed for icons etc.
        CAST(ISNULL(CASE WHEN main.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) as BIT) [IsNew],
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
        main.HasRegister,
        main.IsSupplementary,
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour]

    From 
        Paging main
        LEFT OUTER JOIN SurveyType sut WITH (NOLOCK) On main.SurveyTypeID=sut.SurveyTypeID
        
        INNER JOIN Job j On main.JobID = j.JobId
        LEFT OUTER Join Client c On j.ClientID = c.ClientID 
        LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
        LEFT OUTER Join Site s On j.SiteID = s.SiteID
        
    Where 
        (
            main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )

	INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				ostl.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY ostl.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@OpenSurveyTopLevel ostl		
				INNER JOIN ClientTemplate ct ON ct.ClientID = ostl.ClientID
				INNER JOIN TemplateType tt ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1

	INSERT INTO @OpenSurveyRiskFile (TotalRows,Pages,page,RowNumber,JobID,BranchOfficeID,ClientID,SiteID,ReportType,SurveyTypeID,StartTime,DueDate,Client,SiteAddress,UPRN,orgStateID,orgInstructionID,NoAccess,IsNew,HasNotes,NotesInLastHour,HasRegister,IsSupplementary,RiskFileName)
	SELECT
		main.TotalRows, 
		main.Pages, 
		main.page, 
		main.RowNumber, 
		main.JobID,
		main.BranchOfficeID, 
		main.ClientID, 
		main.SiteID, 
		main.ReportType,
		main.SurveyTypeID, 
		main.StartTime, 
		main.DueDate, 
		main.Client, 
		main.SiteAddress, 
		main.UPRN,
		main.orgStateID, 
		main.orgInstructionID,
		main.NoAccess,
		main.IsNew, 
		main.HasNotes, 
		main.NotesInLastHour,
		main.HasRegister,
		main.IsSupplementary,
		main.[RiskFileName]
	FROM
	(
		Select
			ostl.TotalRows, 
			ostl.Pages, 
			ostl.page, 
			ostl.RowNumber, 
			ostl.JobID, 
			ostl.BranchOfficeID, 
			ostl.ClientID, 
			ostl.SiteID, 
			ostl.ReportType,
			ostl.SurveyTypeID, 
			ostl.StartTime, 
			ostl.DueDate, 
			ostl.Client, 
			ostl.SiteAddress, 
			ostl.UPRN,
			ostl.orgStateID, 
			ostl.orgInstructionID,
			ostl.NoAccess,
			ostl.IsNew, 
			ostl.HasNotes, 
			ostl.NotesInLastHour,
			ostl.HasRegister,
			ostl.IsSupplementary,
			PDF.[FileName] [RiskFileName],
			ROW_NUMBER() OVER (PARTITION BY ostl.JobID ORDER BY PDf.DateCreated DESC) [Identifier]
		FROM
			@OpenSurveyTopLevel ostl
			LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = ostl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] LIKE '%ra%'
	) main
	WHERE
		main.Identifier = 1

	Insert into @SurveyData (JobID,FloorplanID,FloorplanHasData,SampleID,PhotoID,HasPhotoData,PhysicalSample,Content,Verified,IsSampleExchange,SentToSampleExchange,AllCheckedIn,Analysed, SampleCount)
	Select 
		osrf.JobId,
		fp.FloorplanID,
		CAST(CASE WHEN fp.AutocadDataContentType IS NOT NULL THEN 1 ELSE 0 END as BIT) [FloorplanHasData],
		s.SampleID,
		p.PhotoID,
		CAST(CASE WHEN p.ContentType IS NOT NULL THEN 1 ELSE 0 END as BIT) [PhotoHasData],
		CAST(CASE WHEN s.SampleRef Is NOT Null And s.AsSample = 0 And s.SampleRef Not Like '%{%}%' And s.SampleRef Not Like '%*%' THEN 1 ELSE 0 END as BIT) [PhysicalSample],
		Cast(IsNull(reg.ReportInformationId,0) as bit) [Content],
		Cast(CASE WHEN j.SampleResultEmployeeID IS NOT NULL THEN 1 ELSE 0 END as bit) [Verified],
		Case When Not l.ServerCode Is Null Then 1 Else 0 End [IsSampleExchange],
		Case When Not s.SampleExchangeSampleId Is Null Then 1 Else 0 End [SentToSampleExchange],
		CASE WHEN s.LaboratoryID IS NULL THEN 0 ELSE 1 END [AllCheckedIn],
		CASE WHEN s.DateAnalysed IS NULL THEN 0 ELSE 1 END [Analysed],
		samp.sampCount
	From 
		@OpenSurveyRiskFile osrf
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=osrf.JobID
		INNER JOIN JobEmployee je WITH (NOLOCK) On osrf.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
		INNER JOIN Floorplan fp WITH (NOLOCK) On reg.RegisterId = fp.RegisterId
		LEFT OUTER JOIN Room rm WITH (NOLOCK) On fp.FloorplanId = rm.FloorplanId
		LEFT OUTER JOIN Sample s WITH (NOLOCK) On rm.RoomId = s.RoomId
		LEFT OUTER JOIN Photo p WITH (NOLOCK) on s.PhotoID = p.PhotoID
		LEFT OUTER JOIN Laboratory l WITH (NOLOCK) On s.LaboratoryId = l.LaboratoryId
		OUTER APPLY
		(
			SELECT
				COUNT(SampleID) [sampCount]
			FROM
				Job j
				INNER JOIN JobEmployee je ON j.JobID = je.JobID
				INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
				INNER JOIN Room rm ON r.RegisterID = rm.RegisterID
				INNER JOIN Sample s ON rm.RoomID = s.RoomID AND s.SampleRef IS NOT NULL AND s.SampleRef NOT LIKE '%{%' AND s.SampleRef NOT LIKE '%*%' AND s.AsSample = 0
			WHERE
				j.JobID = osrf.JobID					
		) samp

	SELECT
		fd.TotalRows, 
		fd.Pages, 
		fd.page [Page], 
		fd.RowNumber, 
		fd.JobID, 
		fd.JobNo,
		fd.ClientOrderNo,
		fd.BranchOfficeID, 
		fd.ClientID, 
		fd.SiteID, 
		fd.ReportType,
		fd.SurveyTypeID [SurveyTypeID], 
		fd.StartTime, 
		fd.DueDate, 
		fd.Client, 
		fd.SiteAddress, 
		fd.UPRN,
		orgDetail.State [OrgState], 
		CAST(ISNULL(fd.NoAccess,0) as BIT) [NoAccess],
		CAST(CASE WHEN Content.JobID IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasContent],
		CAST(CASE WHEN plans.JobID IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasPlans],
		ISNULL(Photos.UploadedPhotos,0) [UploadedPhotos],
		ISNULL(Photos.PhotoRecords,0) [PhotoRecords],
		CAST(ISNULL(sd.Verified,1) as BIT) [HasResults], --If is null, means no samples therefore no results to check
		fd.IsNew, 
		fd.HasNotes, 
		fd.NotesInLastHour,
		fd.[RiskFileName],
		fd.BulkSampleReport,
		fd.HasRegister [HasRegister],
		fd.IsSupplementary [IsSupplementary],
		bsct.TemplateID [BulkSampleClientTemplateID],
		CAST(ISNULL(sd.IsSampleExchange,0) as BIT) [IsSampleExchange],
		CAST(ISNULL(sd.SentToSampleExchange,0) as BIT) [SentToSampleExchange],
		CAST(ISNULL(sd.[AllCheckedIn],1) as BIT) [AllCheckedIn],
		CAST(CASE WHEN sd.JobId IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasSamples],
		CAST(ISNULL(sd.Verified,0) as BIT) [IsVerified],
		CAST(CASE WHEN ISNULL(sd.IsSampleExchange,0) = 1 AND ISNULL(sd.Verified,0) = 0 AND sd.Analysed = 1 THEN 1 ELSE 0 END as BIT) [IsUnverifiedSampleExchange],
		fd.FullName [Surveyor],
		sd.SampleCount
	FROM
	(
		SELECT
			main.TotalRows, 
			main.Pages, 
			main.page, 
			main.RowNumber, 
			main.JobID,
			main.BranchOfficeID, 
			main.ClientID, 
			main.SiteID, 
			main.ReportType, 
			main.SurveyTypeID,
			main.StartTime, 
			main.DueDate, 
			main.Client, 
			main.SiteAddress, 
			main.UPRN,
			main.orgStateID, 
			main.NoAccess,
			main.IsNew, 
			main.HasNotes, 
			main.NotesInLastHour,
			main.HasRegister,
			main.IsSupplementary,
			main.[RiskFileName],
			main.[BulkSampleReport],
			main.JobNo,
			main.ClientOrderNo,
			main.Fullname
		FROM
		(
			Select
				osrf.TotalRows, 
				osrf.Pages, 
				osrf.page, 
				osrf.RowNumber, 
				osrf.JobID, 
				osrf.BranchOfficeID, 
				osrf.ClientID, 
				osrf.SiteID, 
				osrf.ReportType, 
				osrf.SurveyTypeID,
				osrf.StartTime, 
				osrf.DueDate, 
				osrf.Client, 
				osrf.SiteAddress, 
				osrf.UPRN,
				osrf.orgStateID, 
				osrf.NoAccess,
				osrf.IsNew, 
				osrf.HasNotes, 
				osrf.NotesInLastHour,
				osrf.HasRegister,
				osrf.[IsSupplementary],
				osrf.RiskFileName,
				PDF.[FileName] [BulkSampleReport],
				ROW_NUMBER() OVER (PARTITION BY osrf.JobID ORDER BY PDf.DateCreated DESC) [Identifier],
				j.JobNo,
				j.ClientOrderNo,
				j.SampleResultEmployeeID,
				e.FullName
			FROM
				@OpenSurveyRiskFile osrf
				INNER JOIN Job j ON osrf.JobID=j.JobID
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = osrf.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
				LEFT OUTER JOIN JobEmployee je ON j.JobID = je.JobID
				LEFT OUTER JOIN Employee e ON je.EmployeeID = e.EmployeeID
		) main
		WHERE
			main.Identifier = 1
	) fd
	LEFT OUTER JOIN @BulkSampleClientTemplate bsct ON bsct.JobID=fd.JobID
	LEFT OUTER JOIN 
	(
		SELECT 
			sd.JobID,
			MAX(sd.Verified) [Verified],
			MAX(sd.IsSampleExchange) [IsSampleExchange],
			MAX(sd.SentToSampleExchange) [SentToSampleExchange],
			MIN(sd.AllCheckedIn) [AllCheckedIn],
			MAX(sd.[Analysed]) [Analysed],
			sd.SampleCount
		FROM
			@SurveyData sd
		WHERE
			sd.PhysicalSample = 1
		GROUP BY sd.JobID, sd.SampleCount
	) sd ON fd.JobID=sd.JobID
    LEFT OUTER JOIN 
	(
		SELECT JobID FROM @SurveyData sd WHERE sd.Content = 1 GROUP BY sd.JobId
	) Content ON fd.JobID=Content.JobID
    LEFT OUTER JOIN 
	(
		SELECT JobID FROM @SurveyData sd WHERE sd.FloorplanHasData = 1 GROUP BY sd.JobId
	) Plans ON fd.JobID=Plans.JobID
    LEFT OUTER JOIN 
	(
		SELECT sd.JobID, SUM(CASE WHEN sd.PhotoID IS NOT NULL THEN 1 ELSE 0 END) [PhotoRecords], SUM(CASE WHEN NULLIF(sd.HasPhotoData,0) IS NOT NULL THEN 1 ELSE 0 END) [UploadedPhotos] FROM @SurveyData sd GROUP BY sd.JobID
	) Photos ON fd.JobID=Photos.JobID
    LEFT OUTER JOIN
    (
		Select
			osrf.JobID,
			Case
				 When 
					   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
							  And
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And
					   Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
				 Then
					   'Awaiting Surveyor Approval'

				 When
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
				 Then
					   'Awaiting Final Approval'
			     
				 Else
					   Case
							  When osrf.orgStateID = 0 Then
									 'Queued'
							  Else
									 s.ShortDescription
					   End

			End [State],
			Case 
				 When 
					   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
							  And
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And
					   Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
				 Then
					   'The preview PDF has been approved but requires the surveyors approval.'

				 When
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
				 Then
					   'The preview PDF has been pre-approved and is waiting final approval.'
			     
				 Else
					   Case
							  When osrf.orgStateID = 0 Then
									 'The report has been added to the queue.'
							  Else
									 s.Description
					   End
			End [StateDescription]
		From
			   @OpenSurveyRiskFile osrf
			   Left Outer Join orgState s On osrf.orgStateID = s.orgStateID
			   Cross Join Config
			   Left Outer Join SurveyApproval sa On sa.orgInstructionId = osrf.orgInstructionId And sa.DateDeleted Is Null
			   Left Outer Join JobEmployee je On je.JobId = osrf.JobId And je.EmployeeId = sa.EmployeeId And je.MainEmployee = 1
		GROUP BY
			osrf.JobID,Config.b__SurveyorApprovalRequired, osrf.orgStateID,s.ShortDescription,s.Description
    ) orgDetail ON fd.JobID=orgDetail.JobID


    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'AppointmentColour' AND OBJECT_ID = OBJECT_ID('PropertyType'))
BEGIN
    ALTER TABLE [dbo].[PropertyType]
    ADD [AppointmentColour] [varchar] (20) NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'DiscardReason' AND OBJECT_ID = OBJECT_ID('Enquiry'))
BEGIN
    ALTER TABLE [dbo].[Enquiry]
    ADD [DiscardReason] [varchar] (MAX) NULL;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'AppointmentsWithCategory')
BEGIN
    EXEC('CREATE VIEW[dbo].[AppointmentsWithCategory] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[AppointmentsWithCategory]
AS
-- Stand alone site appointments.
Select
	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
	Case
		When Cast(a.StartTime as Date) = Cast(a.EndTime as Date) Then
			DateDiff(n, a.StartTime, a.EndTime)
		Else
			DateDiff(n, a.StartTime, DateAdd(d, 1, Cast(Cast(a.StartTime as date) as datetime)))
		End as Duration,
	a.StartTime, 
	a.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	s.Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	a.DateConfirmed,
--	Cast(a.Notes as varchar(max)) as Notes,
	a.CalendarFileID,
	e.EmployeeID, 
	e.FullName AS Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	a.AppointmentGroupId,
	a.ProjectAppointmentId,
	Case
		When a.ManuallyMarkWorkDone = 1 Then
			1
		When IsNull(qe.EmployeeId, 0) > 0 And a.AppointmentTypeId = 8 Then
			1
		Else
			CAST(jeappt.[jeappt] as BIT)
	End AS MobileDataReturned,
    CASE WHEN (
                SELECT 
                    Count(*) 
                FROM 
                    JobEmployeeAppointment WITH (NOLOCK)
                    left OUTER JOIN [dbo].[JobEmployee] sje WITH (NOLOCK) ON [sje].[JobEmployeeID] = [JobEmployeeAppointment].[JobEmployeeID] 
                WHERE 
                    [sje].[JobID] = [j].[JobID]
               )>0 THEN
         1
    ELSE
        0
    END MobileDataReturnedOutsideOfScope,
    Case
		When a.ManuallyMarkWorkDone = 1 Then
			1
	ELSE
		CASE a.AppointmentTypeID
			WHEN 1 THEN regcount.regcount
			WHEN 3 THEN aircount.aircount
			--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		END
    END MobileData,
	Cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID And Cast(Created as date) = Cast(a.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID) as bit) AS noAccessOutsideOfScope,
	DateDeclined,
	COALESCE(pt.AppointmentColour, st.AppointmentColour, airColour.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = a.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Quote q WITH (NOLOCK) On q.QuoteID = a.QuoteID
	Left Outer JOin QuoteEmployee qe WITH (NOLOCK) On qe.QuoteId = q.QuoteId
	Left Outer Join Job j WITH (NOLOCK) On j.JobID = q.JobID
	Left Outer Join AppointmentEmployee ae WITH (NOLOCK) On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e WITH (NOLOCK) On ae.EmployeeID = e.EmployeeID
	OUTER APPLY
	(
		Select COUNT(*) [regcount] FROM Register r WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID
	) regcount
	OUTER APPLY
	(
		Select COUNT(*) [aircount] FROM AirTest at WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID
	) aircount
	OUTER APPLY
	(
		Select Count(*) [jeappt] From JobEmployeeAppointment WITH (NOLOCK) Where AppointmentID = a.AppointmentID
	) jeappt
	OUTER APPLY
	(	
		SELECT
			CASE
				WHEN att.AirTestTypeID = 2 THEN att.AppointmentColour
				WHEN sub.MaxAirTestTypeCounter = 1 THEN att.AppointmentColour
			ELSE
				NULL
			END [AppointmentColour]
		FROM
			(
				SELECT
					main.AirTestTypeID,
					MAX(main.AirTestTypeCounter) MaxAirTestTypeCounter
				FROM
					(
						SELECT
							att.AirTestTypeID,
							ROW_NUMBER() OVER (PARTITION BY aamt.AirTestTypeID ORDER BY aamt.AirTestTypeID) [AirTestTypeCounter]
						FROM
							AppointmentAirMonitoring aam 
							INNER JOIN AppointmentAirMonitoringType aamt ON aam.AppointmentAirMonitoringID = aamt.AppointmentAirMonitoringID
							INNER JOIN AirTestType att ON aamt.AirTestTypeID = att.AirTestTypeID
						WHERE
							aam.AppointmentID = a.AppointmentID
					) main
				GROUP BY
					main.AirTestTypeID
			) sub
			INNER JOIN AirTestType att ON sub.AirTestTypeID = att.AirTestTypeID
		WHERE
			sub.AirTestTypeID = 2
				OR
			sub.MaxAirTestTypeCounter = 1
	) airColour
Where
	ProjectAppointmentId Is Null

Union

-- Project site appointments.
Select
	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)) as Duration,
	a.StartTime, 
	a.EndTime,
	(Select Min(AppointmentID) From Appointment WITH (NOLOCK)  Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentID,
	--a.AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Cast(Count(*) as varchar(10)) + ' Sites in total' as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	Null as JobId,
	Null as JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,	
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- ignore for project appointments, instead rely on returned jobs below.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	0 AS NoAccess,-- ignore for project appointments, instead rely on returned jobs below.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Outer Apply
	(
		Select Top 1 SiteId From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null)) Order By DateCreated
	) as ProjectAppointmentSite
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = ProjectAppointmentSite.SiteId
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join AppointmentEmployee ae WITH (NOLOCK) On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e WITH (NOLOCK) On ae.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
Group By
 	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime), 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)), 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime),
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)),
	a.StartTime, 
	a.EndTime,
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	ISNULL(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.Postcode,
	s.UPRN,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	pt.AppointmentColour,
	st.AppointmentColour

Union

-- Completed Project Site Jobs
Select
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime) as OffsetStart, 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime) as OffsetEnd,
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)) as Duration,
	jea.StartTime, 
	jea.EndTime,
--	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	a.AppointmentId,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	1 AS MobileDataReturned,-- Always true for returned jobs.
    0 AS MobileDataReturnedOutsideOfScope,
    CASE a.AppointmentTypeID
		WHEN 1 THEN (Select COUNT(*) FROM Register r WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		WHEN 3 THEN (Select COUNT(*) FROM AirTest at WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
    END MobileData,
	Cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID And Cast(Created as date) = Cast(jea.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID) as bit) AS noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	Inner Join JobEmployeeAppointment jea WITH (NOLOCK) On a.AppointmentID = jea.AppointmentID
	Inner Join JobEmployee je WITH (NOLOCK) On jea.JobEmployeeID = je.JobEmployeeID
	Inner Join Job j WITH (NOLOCK) On je.JobID = j.JobId
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = j.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Employee e WITH (NOLOCK) On je.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
Group By
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime), 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)), 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime),
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)),
	jea.StartTime, 
	jea.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	a.AppointmentTypeID,
	pt.AppointmentColour,
	st.AppointmentColour

Union

-- No Access Project Site Jobs
Select
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created) as OffsetStart, 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)) as Days, 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created) as OffsetEnd,
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)) as Duration,
	na.Created as StartTime, 
	na.Created as EndTime,
	(Select Min(AppointmentID) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- Never true since this section is only for things that have no JEA record!.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	1 AS NoAccess,-- Always true, this is no access query.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	Inner Join Quote q WITH (NOLOCK) On a.QuoteID = q.QuoteID
	Inner Join Job j WITH (NOLOCK) On q.JobID = j.JobID
	Inner Join NoAccess na WITH (NOLOCK) On q.JobID = na.JobID
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = j.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Employee e WITH (NOLOCK) On na.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	(Select COUNT(*) FROM Appointment WITH (NOLOCK) Inner Join JobEmployeeAppointment jea WITH (NOLOCK) On Appointment.AppointmentID = jea.AppointmentID Where Appointment.AppointmentID=a.AppointmentID)=0
Group By
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created), 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)), 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created),
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)),
	na.Created, 
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	pt.AppointmentColour,
	st.AppointmentColour
GO

UPDATE EquipmentCategory SET NoEquipmentAllowed = 1 WHERE EquipmentCategoryID = 62 AND Description = 'Phase Telescope'
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'b__UseNewEditRegister' AND Object_ID=Object_ID(N'Config'))
BEGIN
    ALTER TABLE [Config] ADD [b__UseNewEditRegister] bit NOT NULL
	CONSTRAINT [DF_Config_UseNewEditRegister] DEFAULT ((0))
END
GO

-- InvoiceVatCode
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='InvoiceVatCode'))
	BEGIN
		CREATE TABLE [dbo].[InvoiceVatCode](
			[InvoiceVatCodeId] [int] IDENTITY(1,1) NOT NULL,
			[Description] [varchar](50) NOT NULL,
			[VATRate] [decimal](12, 3) NOT NULL,
			[DefaultRate] bit NOT NULL,
			[SortOrder] int NOT NULL,
			[DateDeleted] [datetime] NULL,
		 CONSTRAINT [PK_InvoiceVatCode_InvoiceVatCodeId] PRIMARY KEY CLUSTERED 
		(
			[InvoiceVatCodeId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'InvoiceVatCodeId' AND Object_ID = Object_ID(N'Invoice'))
BEGIN
    ALTER TABLE [Invoice] ADD [InvoiceVatCodeId] INT NULL
END
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'InvoiceVatCodeId' AND Object_ID = Object_ID(N'InvoiceItem'))
BEGIN
    ALTER TABLE [InvoiceItem] ADD [InvoiceVatCodeId] INT NULL
END
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'InvoiceVatCodeId' AND Object_ID = Object_ID(N'CreditItem'))
BEGIN
    ALTER TABLE [CreditItem] ADD [InvoiceVatCodeId] INT NULL
END
GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'InvoiceVatCodeId' AND Object_ID = Object_ID(N'ProFormaItem'))
BEGIN
    ALTER TABLE [ProFormaItem] ADD [InvoiceVatCodeId] INT NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_Survey')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_Survey] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GridDetail_Survey] 
      @JobID INT
AS
BEGIN
SELECT 
	MIN(r.RegisterStart) 'WorkStarted', 
	MAX(r.RegisterFinish) 'WorkFinished', 
	e.FullName 'Employee', 
	(
		SELECT 
			TOP 1 a.Notes 
		FROM 
			Appointment a WITH (NOLOCK) 
			INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID 
		WHERE 
			q.JobID = @JobID
	) 'Notes',
	c.SageAccountNumber,
	sc.SampleCount
FROM 
	JobEmployee je WITH (NOLOCK) 
	INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
	INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
	INNER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID = je.EmployeeID 
	INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID 
		    --Get count of samples for all jobs only works for samples and bulks
    OUTER APPLY 
	(   
		SELECT
            COUNT(*) [SampleCount]
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
            INNER JOIN Room rm WITH (NOLOCK) ON r.RegisterID = rm.RegisterID
            INNER JOIN Sample s WITH (NOLOCK) ON rm.RoomID = s.RoomID
        WHERE
            je.JobID = j.JobID
                AND
            s.AsSample = 0
                AND
            s.SampleRef IS NOT NULL
				AND
			s.SampleRef NOT LIKE '%*%'
				AND
			s.SampleRef NOT LIKE '%{%'
    ) sc --Sample Count
WHERE 
	je.JobID = @JobID
GROUP BY 
	e.FullName,
	c.SageAccountNumber,
	sc.SampleCount
      
SET NOCOUNT OFF;
END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AirMonitoringReportResultsByRow')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AirMonitoringReportResultsByRow] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[AirMonitoringReportResultsByRow]
      @AirTestID INT
AS
BEGIN

--    DECLARE @AirTestID INT = 8750

SET NOCOUNT ON

      DECLARE @AirTestTypeID INT = (Select AirTestTypeID FROM AirTest Where AirTestID=@AirTestID)  
      
-- Get all inspection data up front to reduce table scans on the element table
      DECLARE @at_Inspection TABLE (AirTestID INT, InspectionID INT, InspectionlabelID INT, InspectionChoiceID INT, InspectionInt INT, InspectionText VARCHAR(MAX))

      INSERT INTO @at_Inspection (AirTestID, InspectionID, InspectionlabelID, InspectionChoiceID, InspectionInt, InspectionText)
      SELECT
            i.AirTestID, i.InspectionID, i.InspectionlabelID, i.InspectionChoiceID, i.InspectionInt, i.InspectionText
      FROM Inspection i WHERE AirTestID = @AirTestID

-- Get all equipment data up front to reduce table scans on the element table
      DECLARE @at_EquipmentUsed TABLE (AirTestID INT, EquipmentCategoryID INT, RefNo VARCHAR(MAX), EquipmentUsedID INT, CalibrationInt INT, CalibrationText VARCHAR(MAX), CalibrationInformationDescription VARCHAR(MAX), EquipmentDescription VARCHAR(MAX), CalibrationDueDate DATETIME, IntervalCheck VARCHAR(MAX))

      INSERT INTO @at_EquipmentUsed (AirTestID, EquipmentCategoryID, RefNo, EquipmentUsedID, CalibrationInt, CalibrationText, CalibrationInformationDescription, EquipmentDescription, CalibrationDueDate, IntervalCheck)
      SELECT
            eu.AirTestID, ec.EquipmentCategoryID, e.RefNo, eu.EquipmentUsedID, ci.CalibrationInt, ci.CalibrationText, cit.Description, e.Description,
            CASE e.IntervalCheck WHEN 0 THEN DATEADD(year,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 1 THEN DATEADD(month,6,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 2 THEN DATEADD(month,3,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 3 THEN DATEADD(month,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 4 THEN DATEADD(day,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 5 THEN DATEADD(year,100,GETDATE()) WHEN 6 THEN DATEADD(year,2,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 7 THEN DATEADD(year,5,ISNULL(cali.CalibrationDate,e.DatePurchased)) ELSE e.DatePurchased END [CalibrationDueDate],
            eic.Description
      FROM  
            AirTest at
            INNER JOIN EquipmentUsed eu ON at.AirTestID = eu.AirTestID
            INNER JOIN Equipment e ON eu.EquipmentID = e.EquipmentID
            INNER JOIN EquipmentCategory ec ON ec.EquipmentCategoryID = e.EquipmentCategoryID
            LEFT OUTER JOIN EquipmentIntervalCheck eic ON eic.IntervalCheckID = e.IntervalCheck
            --LEFT OUTER JOIN Calibration cali ON cali.CalibrationID = eu.CalibrationID AND cali.NotInUse IS NULL AND cali.DateDeleted IS NULL
            OUTER APPLY
            (
                  Select top 1 c.CalibrationID, c.CalibrationDate FROM Calibration c Where c.EquipmentID = e.EquipmentID AND c.CalibrationDate<ISNULL(at.AirTestFinish,GETDATE()) AND c.NotInUse IS NULL AND c.DateDeleted IS NULL Order by c.CalibrationDate DESC
            ) cali
            LEFT OUTER JOIN CalibrationInformation ci ON ci.CalibrationID = cali.CalibrationID
            LEFT OUTER JOIN CalibrationInformationType cit ON cit.CalibrationInformationTypeID = ci.CalibrationInformationTypeID
      WHERE eu.AirTestID = @AirTestID
            

-- Get all element data up front to reduce table scans on the element table
      DECLARE @ElementData TABLE (ElementID INT, AirTestID INT, AirSampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT)

      INSERT INTO @ElementData (ElementID, AirTestID, AirSampleID, ElementTypeID, ElementText, ElementIntID)
      SELECT
            u.ElementID, u.AirTestID, u.AirSampleID, u.ElementTypeID, u.ElementText, u.ElementIntID
      FROM
            (Select e.ElementID, e.AirTestID, e.AirSampleID, e.ElementTypeID, e.ElementText, e.ElementIntID FROM Element e WITH (NOLOCK) Where e.AirTestID=@AirTestID UNION Select e.ElementID, e.AirTestID, e.AirSampleID, e.ElementTypeID, e.ElementText, e.ElementIntID FROM AirSample airs INNER JOIN Element e WITH (NOLOCK) ON e.AirSampleID = airs.AirSampleID Where airs.AirTestID=@AirTestID) u
           
      DECLARE @PlanVolume VARCHAR(MAX) = (Select ElementText FROM @ElementData Where AirTestID=@AirTestID AND ElementTypeID=131)
      IF LEN(@PlanVolume) > 0 BEGIN
    IF @PlanVolume LIKE '%<%' OR @PlanVolume LIKE '%>%' BEGIN
      SET @PlanVolume = REPLACE(REPLACE(@PlanVolume,'<',''),'>','')
      SET @PlanVolume = CAST((CAST(@PlanVolume as DECIMAL(10,2))-0.01) as varchar)
    END
      END
      DECLARE @PlanArea VARCHAR(MAX) = (Select ElementText FROM @ElementData Where AirTestID=@AirTestID AND ElementTypeID=130)
      IF LEN(@PlanArea) > 0 BEGIN
    IF @PlanArea LIKE '%<%' OR @PlanArea LIKE '%>%' BEGIN
      SET @PlanArea = REPLACE(REPLACE(@PlanArea,'<',''),'>','')
      SET @PlanArea = CAST((CAST(@PlanArea as DECIMAL(10,2))-0.01) as varchar)
    END
      END

      If LEN(IsNull(@PlanVolume,'')) = 0 AND LEN(IsNull(@PlanArea,'')) = 0 AND (Select COUNT(*) FROM MobileConfig Where MobileConfigTypeID IN (94,95)) > 0 BEGIN
-- Now check for the dcu area or volume
    SET @PlanArea = (SELECT ISNULL(CAST(CAST((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigInt=i.InspectionLabelID AND mc.MobileConfigTypeID=94 WHERE a.AirTestID=@AirTestID)  as DECIMAL(10,2)) - CASE WHEN IsNull((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigText=i.InspectionLabelID AND mc.MobileConfigTypeID=94 WHERE a.AirTestID=@AirTestID),'')='<' THEN 0.01 ELSE 0.00 END as VARCHAR),''))
    SET @PlanVolume = (SELECT ISNULL(CAST(CAST((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigInt=i.InspectionLabelID AND mc.MobileConfigTypeID=95 WHERE a.AirTestID=@AirTestID)  as DECIMAL(10,2)) - CASE WHEN IsNull((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigText=i.InspectionLabelID AND mc.MobileConfigTypeID=95 WHERE a.AirTestID=@AirTestID),'')='<' THEN 0.01 ELSE 0.00 END as VARCHAR),''))
      END
      
      DECLARE @EstimatedMeasurementsRequired VARCHAR(MAX) = 
      IsNull(CAST((
      Select
        CASE WHEN LEN(@PlanVolume) > 0 THEN
          --Volume as the basis
          Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 10.00 THEN 
            '1'
          ELSE
            Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 150.00 THEN 
              '2'
            ELSE
              Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 300.00 THEN 
                '3'
              ELSE
                Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 600.00 THEN 
                  '4'
                ELSE
                  Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 1500.00 THEN 
                    '6'
                  ELSE
                    Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 3000.00 THEN 
                      '9'
                    ELSE
                      Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 15000.00 THEN 
                        '16'
                      ELSE
                        Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 30000.00 THEN 
                          '20'
                        END
                      END
                    END
                  END
                END
              END
            END
          END
        ELSE
          CASE WHEN LEN(@PlanArea) > 0 THEN
            Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 50.00 THEN 
              '2'
            ELSE
              Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 100.00 THEN 
                '3'
              ELSE
                Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 200.00 THEN 
                  '4'
                ELSE
                  Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 500.00 THEN 
                    '6'
                  ELSE
                    Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 1000.00 THEN 
                      '9'
                    ELSE
                      Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 5000.00 THEN 
                        '16'
                      ELSE
                        Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 10000.00 THEN 
                          '20'
                        END
                      END
                    END
                  END
                END
              END
            END
          END
        END
      ) as varchar(MAX)),'N/A')
      
-- Get all Air Sample data up front
      DECLARE @AirSampleData TABLE (RowNo INT, PhotoID INT,AirSampleID INT, AirTestID INT, SampleRef VARCHAR(MAX), PumpNo INT, AirSampleItemNo INT, Location VARCHAR(MAX), SubSampleItemNo INT,FieldBlank INT,SPStart VARCHAR(MAX), SPFinish VARCHAR(MAX), MinsRunning INT, FRStart VARCHAR(MAX), FRFinish VARCHAR(MAX), FlowRate DECIMAL(8,4), Volume DECIMAL(12,4), DirtySlide VARCHAR(MAX), Graticule VARCHAR(MAX), Fibres VARCHAR(MAX), RRMeasurement VARCHAR(MAX), ReportedResult VARCHAR(MAX), AirSampleTestType VARCHAR(MAX), ePumpNo VARCHAR(MAX), FilterHead VARCHAR(MAX), AirSampleTemp VARCHAR(MAX), AirSampleDurationOfBrushingStart VARCHAR(MAX), AirSampleDurationOfBrushingFinish VARCHAR(MAX), FRIntermediate VARCHAR(MAX), SPIntermediate VARCHAR(MAX), OverrideVolume BIT)

      INSERT INTO @AirSampleData 
            (
                  RowNo,PhotoID,AirSampleID, AirTestID, SampleRef, PumpNo, AirSampleItemNo, Location, SubSampleItemNo,FieldBlank,
                  SPStart, SPFinish, MinsRunning, FRStart, FRFinish, FlowRate, Volume,
                  DirtySlide, Graticule, Fibres, RRMeasurement, ReportedResult, AirSampleTestType, ePumpNo, 
                  FilterHead, AirSampleTemp, AirSampleDurationOfBrushingStart, AirSampleDurationOfBrushingFinish, FRIntermediate, SPIntermediate,
                  OverrideVolume
            )
      SELECT
            ROW_NUMBER() OVER (Order By airs.AirSampleItemNo, airs.SubSampleItemNo), p.PhotoID, 
           airs.AirSampleID, airs.AirTestID, airs.SampleRef, null, airs.AirSampleItemNo, airs.Location, airs.SubSampleItemNo, airs.FieldBlank,
            as_e101.ElementText, as_e102.ElementText, aiS_SPFR.MinsRunning, as_e103.ElementText, as_e104.ElementText, aiS_SPFR.FlowRate, aiS_Volume.Volume,
            as_e109.ElementText, as_e108.ElementText, as_e105.ElementText, as_e106.ElementText, as_e107.ElementText, as_e121.ElementText, as_e135.ElementText, 
            as_e136.ElementText, as_e110.ElementText, as_e137.ElementText, as_e138.ElementText, as_e100.ElementText, as_e99.ElementText,
            CASE WHEN 
          as_e103.ElementText = '0.0' OR as_e103.ElementText = '0' 
              OR
          as_e104.ElementText = '0.0' OR as_e104.ElementText = '0' 
        THEN
          1
        ELSE
          0
        END
      FROM
            AirSample airs
            LEFT OUTER JOIN Photo p ON p.PhotoID=airs.PhotoID AND p.PhotoData IS NOT NULL
            LEFT OUTER JOIN @ElementData as_e99 ON as_e99.AirSampleID=airs.AirSampleID AND as_e99.ElementTypeID = 99
            LEFT OUTER JOIN @ElementData as_e100 ON as_e100.AirSampleID=airs.AirSampleID AND as_e100.ElementTypeID = 100
            LEFT OUTER JOIN @ElementData as_e101 ON as_e101.AirSampleID=airs.AirSampleID AND as_e101.ElementTypeID = 101
            LEFT OUTER JOIN @ElementData as_e102 ON as_e102.AirSampleID=airs.AirSampleID AND as_e102.ElementTypeID = 102
            LEFT OUTER JOIN @ElementData as_e103 ON as_e103.AirSampleID=airs.AirSampleID AND as_e103.ElementTypeID = 103
            LEFT OUTER JOIN @ElementData as_e104 ON as_e104.AirSampleID=airs.AirSampleID AND as_e104.ElementTypeID = 104
            LEFT OUTER JOIN @ElementData as_e105 ON as_e105.AirSampleID=airs.AirSampleID AND as_e105.ElementTypeID = 105
            LEFT OUTER JOIN @ElementData as_e106 ON as_e106.AirSampleID=airs.AirSampleID AND as_e106.ElementTypeID = 106
            LEFT OUTER JOIN @ElementData as_e107 ON as_e107.AirSampleID=airs.AirSampleID AND as_e107.ElementTypeID = 107
            LEFT OUTER JOIN @ElementData as_e108 ON as_e108.AirSampleID=airs.AirSampleID AND as_e108.ElementTypeID = 108
            LEFT OUTER JOIN @ElementData as_e109 ON as_e109.AirSampleID=airs.AirSampleID AND as_e109.ElementTypeID = 109
            LEFT OUTER JOIN @ElementData as_e110 ON as_e110.AirSampleID=airs.AirSampleID AND as_e110.ElementTypeID = 110
            LEFT OUTER JOIN @ElementData as_e121 ON as_e121.AirSampleID=airs.AirSampleID AND as_e121.ElementTypeID = 121
            
            LEFT OUTER JOIN @ElementData as_e135 ON as_e135.AirSampleID=airs.AirSampleID AND as_e135.ElementTypeID = 135
            LEFT OUTER JOIN @ElementData as_e136 ON as_e136.AirSampleID=airs.AirSampleID AND as_e136.ElementTypeID = 136
            LEFT OUTER JOIN @ElementData as_e137 ON as_e137.AirSampleID=airs.AirSampleID AND as_e137.ElementTypeID = 137
            LEFT OUTER JOIN @ElementData as_e138 ON as_e138.AirSampleID=airs.AirSampleID AND as_e138.ElementTypeID = 138
            OUTER APPLY
            (
                  Select
                        Convert(decimal(8,4), (Convert(decimal(12,2), Convert(varchar, as_e103.ElementText)) + Convert(decimal(12,2), Convert(varchar, as_e104.ElementText))) / 2) [FlowRate],
                        Case When DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) > 0 Then DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) Else DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) + 1440 End [MinsRunning]
            ) aiS_SPFR
            OUTER APPLY
            (
                  Select convert(decimal(12,2),aiS_SPFR.MinsRunning) * convert(decimal(12,3),aiS_SPFR.FlowRate) [Volume]
            ) aiS_Volume
      Where 
    airs.AirTestID = @AirTestID

SELECT


-- Air Sample Photo bits
    airs.RowNo,
    CASE WHEN airs.RowNo % 2 = 0 THEN
    '#FFFFFF'
    ELSE
    '#D9D9D9'
    END [RowColour],
  airs.RowNo % 2 [OddRow],
CASE WHEN airs.RowNo % 2 = 1 THEN
'<td class="BorderL BorderT BorderB Bold Font6" rowspan=2 style="width:140">'
+
CASE WHEN airs.PhotoID IS NOT NULL THEN 
  '[AIRSAMPLEPHOTOIMGTAG:' + CAST(airs.PhotoID as VARCHAR) + ']'
Else '&nbsp;' END
+
'</td>'
+
'<td class="BorderL BorderT BorderB BorderR Bold Font6" rowspan=2 style="width:140">' +
CASE WHEN (Select PhotoID FROM @AirSampleData Where RowNo=airs.RowNo+1) IS NOT NULL THEN 
  '[AIRSAMPLEPHOTOIMGTAG:' + CAST((Select PhotoID FROM @AirSampleData Where RowNo=airs.RowNo+1) as VARCHAR) + ']'
Else '&nbsp;' END + '</td>'
END [AIRSAMPLEPHOTODOUBLEROW],
-- Bits just for the headerFooterSQL first
      Case at.AirTestTypeID When 2 Then 'RESULTS3' ELSE 'RESULTS' END [AIRMONRESULTREPLACE],
      Case at.AirTestTypeID When 2 Then 'STAGE 3 - ' Else '' End [STAGE3],    
      Case at.AirTestTypeID When 2 Then 'inherit' Else 'none' End [IncludeDurationOfBrushing],
      att.[Description] [AirTestType],
      DateDiff(Minute, at.AirTestStart, at.AirTestFinish) [AirTestDuration],    
      CASE WHEN euVehicle.RefNo IS NULL THEN
      IsNull(e116.ElementText, '&nbsp;') 
    ELSE
      'Mobile Lab'
    END [ANALYSISLOCATIONORMOBILELAB],
      CASE WHEN euVehicle.RefNo IS NULL THEN
      'N/A'
    ELSE
      IsNull(e116.ElementText, '&nbsp;') 
    END [ANALYSISLOCATIONONLYVEHICLE],
      IsNull(e116.ElementText, '&nbsp;') [AnalysisLocation],    
      IsNull(e113.ElementText, '&nbsp;') [SitePressure],
      IsNull(e112.ElementText, '&nbsp;') [SiteTemp],   
      Case Convert(varchar, e113.ElementText) When 'N/A' Then '' Else 'mb' End [SitePressuremb], 
      Case Convert(varchar, e112.ElementText) When 'N/A' Then '' When '' Then '' Else ' K' End [SiteTempK],   
      Case Convert(varchar, e112.ElementText) When 'N/A' Then '' When '' Then '' Else '<sup>o</sup>C' End [SiteTempC],   
      IsNull(e117.ElementText, '&nbsp;') [ExposedFilter],
      IsNull(eu.TallyCounter, '&nbsp;') [TallyCounter],
      IsNull(eu.AdditionalTallyCounter, '&nbsp;') [AdditionalTallyCounter],
      IsNull(eu.FlowmeterHi, '&nbsp;') [FlowmeterReference], 
      IsNull(e114.ElementText, '&nbsp;') [Flowmeter], 
      IsNull(eu.FlowmeterHi, '&nbsp;') [FlowmeterHi],  
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterHiTemperature],
      IsNull(Convert(varchar,eu.FlowmeterHiTemperature), 'N/A') [FlowmeterHiTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterHiTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterHiPressure],
      IsNull(eu.FlowmeterMed, '&nbsp;') [FlowmeterMed],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterMedTemperature],
      IsNull(Convert(varchar,eu.FlowmeterMedTemperature), 'N/A') [FlowmeterMedTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterMedTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterMedPressure],
      IsNull(eu.FlowmeterLow, '&nbsp;') [FlowmeterLow],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterLowTemperature],
      IsNull(Convert(varchar,eu.FlowmeterLowTemperature), 'N/A') [FlowmeterLowTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterLowTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterLowPressure],
      CASE WHEN eu.FlowmeterHi IS NOT NULL OR eu.FlowmeterMed IS NOT NULL OR eu.FlowmeterLow IS NOT NULL THEN
            LEFT(ISNULL(eu.FlowmeterHi + '/','') + ISNULL(eu.FlowmeterMed + '/','') + ISNULL(eu.FlowmeterLow + '/',''),LEN(ISNULL(eu.FlowmeterHi + '/','') + ISNULL(eu.FlowmeterMed + '/','') + ISNULL(eu.FlowmeterLow + '/',''))-1)
      ELSE 'N/A' END [FlowmeterAll],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN eu.FlowmeterHi ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN eu.FlowmeterMed ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN eu.FlowmeterLow ELSE 'N/A' END END  END 
      --ELSE 'N/A' End 
      [FlowmeterCoalesce],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + '<sup>o</sup>C', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + '<sup>o</sup>C', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' END END END 
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperature],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature), 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature), 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature), 'N/A') ELSE 'N/A' END END  END  
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperatureNo],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + ' K', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + ' K', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + ' K', 'N/A') ELSE 'N/A' END END END 
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperatureK],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiPressure) + 'mb', 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedPressure) + 'mb', 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowPressure) + 'mb', 'N/A')  ELSE 'N/A' END END END 
      --ELSE 'N/A' End 
      [FlowmeterCoalescePressure],
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiPressure), 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedPressure), 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowPressure), 'N/A')  ELSE 'N/A' END END END 
      --ELSE 'N/A' End 
      [FlowmeterCoalescePressureNo],
      IsNull(eu.ThermometerReference, '&nbsp;') [ThermometerReference],
        IsNull(eu.BarometerReference, '&nbsp;') [BarometerReference],
      IsNull(eu.TimerReference, '&nbsp;') [TimerReference],
      IsNull(eu.MicrometerReference, '&nbsp;') [MicrometerReference],
      IsNull(CAST(eu.MicrometerResult as varchar), '&nbsp;') [MicrometerResult],
      IsNull(e118.ElementText, '&nbsp;') [WaltonBeckett],
      IsNull(e115.ElementText, '&nbsp;') [SlidesStored],
      IsNull(e119.ElementText, '&nbsp;') [FifthLine],
      IsNull(eu.MicroscopeReference, '&nbsp;') [MicroscopeReference],
      IsNull(CAST(eu.MicroscopeResult as varchar), '&nbsp;') [MicroscopeResult],
      IsNull(eu.TestSlideReference, '&nbsp;') [TestSlideReference],
      IsNull(CAST(eu.TestSlideResult as varchar), '&nbsp;') [TestSlideResult],
      IsNull(eu.SlideBox, '&nbsp;') [SlideBox],
      IsNull(eu.FilterBox, '&nbsp;') [FilterBox],
      IsNull(CAST(eu.FilterBoxResult as varchar), '&nbsp;') [FilterBoxResult],
      ISNULL(cast(Convert(Date, eu.FilterBoxChecked) as varchar), '&nbsp;') [FilterBoxChecked],     
      IsNull(eu.PhaseTelescope, '&nbsp;') [PhaseTelescope],
      IsNull(CAST(eu.PhaseTelescopeResult as varchar), '&nbsp;') [PhaseTelescopeResult], 
      ISNULL(cast(Convert(Date, eu.PhaseTelescopeChecked) as varchar), '&nbsp;') [PhaseTelescopeChecked], 
      (Select STUFF((Select DISTINCT ',' + ' ' + subEU.EquipmentDescription FROM @at_EquipmentUsed subEU Where AirTestID=at.AirTestID FOR XML PATH ('')) , 1, 1, '')) [EQUIPMENTDESCRIPTIONGROUP],
      insp.FibreAnalyst [FibreAnalyst], 
      IsNull(emp.FullName,'&nbsp;') [Staff],
      e131.ElementText [EnclosureVolume],
      (Select SUM(CONVERT(decimal(12,2),convert(varchar,e111.ElementText))) From @ElementData e111 Where e111.ElementTypeID = 111 AND e111.ElementText<>'N/A' And e111.AirTestID =  at.AirTestID) [DurationOfBrushingTotal],

-- Bits for the rowSQL
      Case When airs.SubSampleItemNo IS NOT NULL Then  Convert(varchar,airs.AirSampleItemNo) + '.' + Convert(varchar,airs.SubSampleItemNo)  Else  IsNull(CAST(airs.AirSampleItemNo as varchar),'') End [AirSampleItemNo],
      IsNull(Convert(varchar(MAX),airs.Location), 'N/A') [Location],
      CASE WHEN airs.FieldBlank > 0 OR PooledSamples.Count IS NULL THEN 'Field Blank' ELSE '&nbsp;' END [FieldBlank],
      CASE WHEN airs.FieldBlank > 0 THEN 'FB' ELSE IsNull(airs.AirSampleTestType,'&nbsp;') END [FieldBlankOrTestType],
      IsNull(Convert(varchar(100),airs.SampleRef), 'N/A') [SampleRef],
      IsNull(Convert(varchar(100),airs.ePumpNo), 'N/A') [PumpNo],
      IsNull(Convert(varchar(100),airs.FilterHead), 'N/A') [FilterHead],
      IsNull(Convert(varchar(100),airs.AirSampleTemp), 'N/A') [Temp],
      IsNull(Convert(varchar(100),e113.ElementText), 'N/A') [Pressure],
      Case When airs.AirSampleDurationOfBrushingStart IS NULL AND airs.AirSampleDurationOfBrushingFinish IS NULL THEN 
            Case WHEN NULLIF(airs.FieldBlank,0) IS NULL THEN 
                  IsNull(Convert(varchar(100),e111.ElementText), 'N/A') 
            ELSE 
                  'N/A' 
            END
      ELSE 
            Convert(varchar(100),airs.AirSampleDurationOfBrushingStart) + '&nbsp;&nbsp;' + Convert(varchar(100),airs.AirSampleDurationOfBrushingFinish) 
      END [DurationOfBrushing],
      Case When NULLIF(airs.SubSampleItemNo,1) IS NULL Then 'inherit' Else 'none' END      [DurationOfBrushingDisplay],
      CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.01' ELSE CONVERT(varchar,CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) END [DetectionLimit],
      CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.01' ELSE CONVERT(varchar,CONVERT(DECIMAL(12,2), PooledSamples.QuantificationLevel)) END [DetectionLimit2D],
      CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.010' ELSE CASE WHEN CONVERT(varchar,CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) = '0.000' THEN 'N/A' ELSE CONVERT(varchar, CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) END END [DetectionLimit3DOverride],
      Isnull(Convert(varchar(100),airs.SPStart), 'N/A') [SPStart],
      Isnull(Convert(varchar(100),airs.SPFinish), 'N/A') [SPFinish],
      Isnull(airs.SPIntermediate, 'N/A') [SPIntermediate],
      IsNull(CAST(airs.MinsRunning as varchar),'N/A') [MinsRunning],
      Isnull(convert(varchar,convert(decimal(12,1),round(convert(varchar,airs.FRStart),1))), 'N/A') [FRStart],
      Isnull(convert(varchar,convert(decimal(12,1),round(convert(varchar,airs.FRFinish),1))), 'N/A') [FRFinish],
      Isnull(convert(varchar,convert(decimal(12,2),round(convert(varchar,airs.FRStart),2))), 'N/A') [FRStart2D],
      Isnull(convert(varchar,convert(decimal(12,2),round(convert(varchar,airs.FRFinish),2))), 'N/A') [FRFinish2D],
      IsNull(airs.FRIntermediate, 'N/A') [FRIntermediate],
      Isnull(convert(varchar,(Convert(decimal(12,1),Round(airs.FlowRate, 2)))), 'N/A') [FlowRate],
      Isnull(convert(varchar,(Convert(decimal(12,2),Round(airs.FlowRate, 2)))), 'N/A') [FlowRate2D],
      CASE WHEN (airs.FRStart = airs.FRFinish) OR PooledSamples.[Count] IS NULL OR airs.FieldBlank > 0 THEN '-' ELSE Isnull(convert(varchar,(Convert(decimal(12,1),Round(airs.Flowrate, 2)))), 'N/A') END [FlowRateOnlyDiff],
      CASE WHEN (airs.FRStart = airs.FRFinish) OR PooledSamples.[Count] IS NULL OR airs.FieldBlank > 0 THEN '-' ELSE Isnull(convert(varchar,(Convert(decimal(12,2),Round(airs.Flowrate, 2)))), 'N/A') END [FlowRateOnlyDiff2D],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
    convert(varchar,CAST(airs.Volume as DECIMAL(10,0)))
    END, 'N/A') [Volume],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
        convert(varchar,CAST(PooledSamples.PooledVolume as DECIMAL(10,0)))
      END, 'N/A') [PooledVolume],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
    convert(varchar,CAST(airs.Volume as DECIMAL(10,1)))
    END, 'N/A') [Volume1DP],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
        convert(varchar,CAST(PooledSamples.PooledVolume as DECIMAL(10,1)))
      END, 'N/A') [PooledVolume1DP],
      IsNull(airs.DirtySlide, '&nbsp;') [DirtySlide],
      Case WHEN NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide IS NOT Null THEN Case When NULLIF(airs.SubSampleItemNo,1) IS NULL Then 'inherit' Else 'none' End ELSE 'none' END [DirtySlideDisplay],
      Case When airs.DirtySlide Is Null Then 'inherit' Else 'none' End [GraticuleDisplay],
      Case When airs.DirtySlide Is Null Then 'inherit' Else 'none' End [FibresDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' End Else 'none' End [ConcentrationDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' END Else 'none' End [ReportedResultDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' END Else 'none' End [DetectionLimitDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [FieldBlankDisplay],
      Case When NULLIF(NULLIF(airs.FieldBlank,0),1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [PassedFieldBlankDisplay],
    Case When NULLIF(NULLIF(airs.FieldBlank,0),2) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [FailedFieldBlankDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' End [InvertFieldBlankDisplay],
      PooledSamples.[Count] * att.AirMonitoringRowAdjustment 'ROWSDEPENDANCY',
    Case When airs.SubSampleItemNo IS NULL AND PooledSamples.Count IS NOT NULL Then 2 ELSE 1 END 'COLPOOLEDDEPENDANCY',
    Case When airs.SubSampleItemNo = 1 AND PooledSamples.Count IS NOT NULL Then 'block' ELSE 'none' END 'COLPOOLEDDEPENDANCYDISPLAY',
      IsNull(airs.Graticule, '&nbsp;') [Graticule],
      Isnull(airs.Fibres, '&nbsp;') [Fibres],
      Isnull(convert(varchar,CAST(PooledSamples.PooledFibres as float)), '&nbsp;') [PooledFibres],
      Isnull(CASE WHEN ISNUMERIC(airs.Fibres)=1 AND airs.Fibres NOT LIKE '%.%' THEN airs.Fibres + '.0' ELSE airs.Fibres END, '&nbsp;') [Fibres1D],
      Isnull(CASE WHEN ISNUMERIC(convert(varchar,CAST(PooledSamples.PooledFibres as float)))=1 AND airs.Fibres NOT LIKE '%.%' THEN convert(varchar,CAST(PooledSamples.PooledFibres as float)) + '.0' ELSE convert(varchar,CAST(PooledSamples.PooledFibres as float)) END, '&nbsp;') [PooledFibres1D],
      Isnull(convert(varchar,LEFT(cast(PooledSamples.ResultConcentration as varchar),6)), 'N/A') [Concentration],
      Isnull(CASE WHEN NULLIF(PooledSamples.ResultConcentration,'N/A') IS NOT NULL THEN CAST(CAST(ROUND(PooledSamples.ResultConcentration,3) as DECIMAL(12,3)) as varchar) END, 'N/A') [Concentration3DP],
      IsNull(airs.RRMeasurement, '&nbsp;') [RRMeasurement],
      IsNull(airs.ReportedResult, '&nbsp;') [ReportedResult],
      CASE WHEN eu.FullFaceEquipmentUsedID IS NOT NULL AND eu.HalfMaskEquipmentUsedID IS NOT NULL THEN 'Half Mask and Full Face' WHEN eu.FullFaceEquipmentUsedID IS NOT NULL THEN 'Full Face' WHEN eu.HalfMaskEquipmentUsedID IS NOT NULL THEN 'Half Mask' ELSE '&nbsp;' END [RespiratorType],
      ISNULL(eu.AcetoneVaporiser, '&nbsp;') [AcetoneVaporiser],
      ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') [FlowMeterCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') [FlowMeterHiCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterMedCalibration) as varchar), '&nbsp;') [FlowMeterMedCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterLowCalibration) as varchar), '&nbsp;') [FlowMeterLowCalibration],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
            CASE WHEN NOT eu.FlowmeterHi IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterMedCalibration) as varchar), '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterLowCalibration) as varchar), '&nbsp;') ELSE 'N/A' END END  END 
      --ELSE 'N/A' End 
      [FlowmeterCoalesceCalibration],
      ISNULL(eu.FlowMeterHiInterval, '&nbsp;') [FlowMeterInterval],
      ISNULL(eu.FlowMeterHiInterval, '&nbsp;') [FlowMeterHiInterval],
      ISNULL(eu.FlowMeterLowInterval, '&nbsp;') [FlowMeterMedInterval],
      ISNULL(eu.FlowMeterMedInterval, '&nbsp;') [FlowMeterLowInterval],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
    CASE WHEN NOT eu.FlowmeterHi IS NULL THEN ISNULL(eu.FlowMeterHiInterval, '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN ISNULL(eu.FlowMeterMedInterval, '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN ISNULL(eu.FlowMeterLowInterval, '&nbsp;') ELSE '&nbsp;' END END  END 
    --ELSE '&nbsp;' End 
    [FlowMeterCoalesceInterval],
      ISNULL(eu.MicrometerInterval, '&nbsp;') [MicrometerInterval],
      ISNULL(cast(Convert(Date, eu.ThermometerCalibration) as varchar), '&nbsp;') [ThermometerCalibration],
      ISNULL(cast(Convert(Date, TimerCalibration) as varchar), '&nbsp;') [TimerCalibration],
      ISNULL(cast(Convert(Date, eu.AcetoneVaporiserCalibration) as varchar), '&nbsp;') [AcetoneVaporiserCalibration],   
      ISNULL(cast(Convert(Date, eu.MicroscopeCalibration) as varchar), '&nbsp;') [MicroscopeCalibration],
    ISNULL(cast(Convert(Date, eu.MicrometerCalibration) as varchar), '&nbsp;') [MicrometerCalibration],
    ISNULL(cast(Convert(Date, eu.TestSlideCalibration) as varchar), '&nbsp;') [TestSlideCalibration],
    ISNULL(cast(Convert(Date, eu.TallyCounterCalibration) as varchar), '&nbsp;') [TallyCounterCalibration],
    ISNULL(cast(Convert(Date, eu.AdditionalTallyCounterCalibration) as varchar), '&nbsp;') [AdditionalTallyCounterCalibration],
    IsNull(airs.AirSampleTestType,'&nbsp;') [TestType],
    at.SystemName + RIGHT('00' + CONVERT(VARCHAR, at.AirTestNo), 2) [AirTestRef],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'YES' ELSE 'NO' END [wereFieldBlanksTaken],
    CASE WHEN AirSampleCount.FieldBlankFailedCount > 0 THEN 'YES' ELSE 'NO' END [wereFieldBlanksCounted],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'inherit' ELSE 'none' END [DisplayIfFieldBlanksTaken],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'none' ELSE 'inherit' END [DisplayIfNoFieldBlanksTaken],
    Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then
    CASE WHEN Convert(decimal(12,2),airs.ReportedResult) <= Convert(decimal(12,2),0.01) AND IsNull(airs.RRMeasurement, '&nbsp;') = '<' Then
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=0),'#000000')
    Else
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=1),'#000000')
    End
    End [ResultColor001],
    Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then
    CASE WHEN Convert(decimal(12,2),airs.ReportedResult) <= CONVERT(DECIMAL(12,2), PooledSamples.QuantificationLevel) AND IsNull(airs.RRMeasurement, '&nbsp;') = '<' Then
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=0),'#000000')
    Else
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=1),'#000000')
    End
    End [ResultColorDetectionLimit],
    @EstimatedMeasurementsRequired [EstimatedMeasurementsRequired],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s1r.PassedStage1 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE1PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s1r.PassedStage1 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE1FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s2r.PassedStage2 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE2PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s2r.PassedStage2 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE2FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s3r.PassedStage3 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE3PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s3r.PassedStage3 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE3FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s4r.PassedStage4 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE4PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s4r.PassedStage4 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE4FAILED]
FROM
      AirTest at
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage1]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=2
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s1r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage2]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=3
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s2r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage3]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=4
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s3r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage4]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=5
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s4r
      
      
      
      INNER JOIN AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
      INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID
      INNER JOIN Employee emp ON emp.EmployeeID=je.EmployeeID
      LEFT OUTER JOIN @AirSampleData airs ON airs.AirTestID = at.AirTestID
      
      LEFT OUTER JOIN @ElementData e111 ON e111.AirTestID=at.AirTestID AND e111.ElementTypeID = 111
      LEFT OUTER JOIN @ElementData e112 ON e112.AirTestID=at.AirTestID AND e112.ElementTypeID = 112
      LEFT OUTER JOIN @ElementData e113 ON e113.AirTestID=at.AirTestID AND e113.ElementTypeID = 113
      LEFT OUTER JOIN @ElementData e114 ON e114.AirTestID=at.AirTestID AND e114.ElementTypeID = 114
      LEFT OUTER JOIN @ElementData e115 ON e115.AirTestID=at.AirTestID AND e115.ElementTypeID = 115
      LEFT OUTER JOIN @ElementData e116 ON e116.AirTestID=at.AirTestID AND e116.ElementTypeID = 116
      LEFT OUTER JOIN 
      (
      Select DISTINCT RefNo FROM @at_EquipmentUsed Where EquipmentCategoryID=16
      ) euVehicle ON euVehicle.RefNo=e116.ElementText
      LEFT OUTER JOIN @ElementData e117 ON e117.AirTestID=at.AirTestID AND e117.ElementTypeID = 117
      LEFT OUTER JOIN @ElementData e118 ON e118.AirTestID=at.AirTestID AND e118.ElementTypeID = 118
      LEFT OUTER JOIN @ElementData e119 ON e119.AirTestID=at.AirTestID AND e119.ElementTypeID = 119
      LEFT OUTER JOIN @ElementData e131 ON e131.AirTestID=at.AirTestID AND e131.ElementTypeID = 131
      
      LEFT OUTER JOIN 
      (
            Select @AirTestID [AirTestID],
            (Select top 1 eu1.RefNo FROM @at_EquipmentUsed eu1 Where eu1.AirTestID=@AirTestID AND eu1.EquipmentCategoryID=1 Order by eu1.EquipmentUsedID ASC) [AcetoneVaporiser],
            (Select top 1 eu1.CalibrationDueDate FROM @at_EquipmentUsed eu1 Where eu1.AirTestID=@AirTestID AND eu1.EquipmentCategoryID=1 Order by eu1.EquipmentUsedID ASC) [AcetoneVaporiserCalibration],
            (Select top 1 eu2.RefNo FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 Order by eu2.EquipmentUsedID ASC) [MicroscopeReference],
            (Select top 1 eu2.CalibrationText FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 AND eu2.CalibrationInformationDescription = 'Result' Order by eu2.EquipmentUsedID ASC) [MicroscopeResult],
            (Select top 1 eu2.CalibrationDueDate FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 Order by eu2.EquipmentUsedID ASC) [MicroscopeCalibration],
            (Select top 1 eu3.RefNo FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerReference], 
            (Select top 1 eu3.CalibrationDueDate FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerCalibration],
            (Select top 1 eu3.IntervalCheck FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerInterval],
            (Select top 1 eu3.CalibrationText FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 AND eu3.CalibrationInformationDescription = 'Result' Order by eu3.EquipmentUsedID ASC) [MicrometerResult],
            (Select top 1 eu4.RefNo FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 Order by eu4.EquipmentUsedID ASC) [TestSlideReference], 
            (Select top 1 eu4.CalibrationText FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 AND eu4.CalibrationInformationDescription = 'Result' Order by eu4.EquipmentUsedID ASC) [TestSlideResult],
            (Select top 1 eu4.CalibrationDueDate FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 Order by eu4.EquipmentUsedID ASC) [TestSlideCalibration],
            --ORDERED THIS WAY SINCE THEY ARE ALL FLOWMETER STUFF (HI/MED/LOW)
            (Select top 1 eu5.RefNo FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHi],
            (Select top 1 eu5.CalibrationInt FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 AND eu5.CalibrationInformationDescription = 'Temperature' Order by eu5.EquipmentUsedID ASC) [FlowmeterHiTemperature],
            (Select top 1 eu5.CalibrationInt FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 AND eu5.CalibrationInformationDescription = 'Pressure' Order by eu5.EquipmentUsedID ASC) [FlowmeterHiPressure],
            (Select top 1 eu5.CalibrationDueDate FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHiCalibration],
            (Select top 1 eu5.IntervalCheck FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHiInterval],
            (Select top 1 eu20.RefNo FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMed],
            (Select top 1 eu20.CalibrationInt FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 AND eu20.CalibrationInformationDescription = 'Temperature' Order by eu20.EquipmentUsedID ASC) [FlowmeterMedTemperature],
            (Select top 1 eu20.CalibrationInt FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 AND eu20.CalibrationInformationDescription = 'Pressure' Order by eu20.EquipmentUsedID ASC) [FlowmeterMedPressure],
            (Select top 1 eu20.CalibrationDueDate FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMedCalibration],
            (Select top 1 eu20.IntervalCheck FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMedInterval],
            (Select top 1 eu21.RefNo FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLow],
            (Select top 1 eu21.CalibrationInt FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 AND eu21.CalibrationInformationDescription = 'Temperature' Order by eu21.EquipmentUsedID ASC) [FlowmeterLowTemperature],
            (Select top 1 eu21.CalibrationInt FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 AND eu21.CalibrationInformationDescription = 'Pressure' Order by eu21.EquipmentUsedID ASC) [FlowmeterLowPressure],
            (Select top 1 eu21.CalibrationDueDate FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLowCalibration],
            (Select top 1 eu21.IntervalCheck FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLowInterval],
            ------------------------------------------------------------------
            (Select top 1 eu6.RefNo FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID ASC) [TallyCounter], 
            (Select top 1 eu6.CalibrationDueDate FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID ASC) [TallyCounterCalibration],
            (Select top 1 eu6.RefNo FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID DESC) [AdditionalTallyCounter],
            (Select top 1 eu6.CalibrationDueDate FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID DESC) [AdditionalTallyCounterCalibration],
            (Select top 1 eu7.RefNo FROM @at_EquipmentUsed eu7 Where eu7.AirTestID=@AirTestID AND eu7.EquipmentCategoryID=7 Order by eu7.EquipmentUsedID ASC) [ThermometerReference], 
            (Select top 1 eu7.CalibrationDueDate FROM @at_EquipmentUsed eu7 Where eu7.AirTestID=@AirTestID AND eu7.EquipmentCategoryID=7 Order by eu7.EquipmentUsedID ASC) [ThermometerCalibration],
            (Select top 1 eu8.EquipmentUsedID FROM @at_EquipmentUsed eu8 Where eu8.AirTestID=@AirTestID AND eu8.EquipmentCategoryID=8 Order by eu8.EquipmentUsedID ASC) [FullFaceEquipmentUsedID], 
            (Select top 1 eu9.EquipmentUsedID FROM @at_EquipmentUsed eu9 Where eu9.AirTestID=@AirTestID AND eu9.EquipmentCategoryID=9 Order by eu9.EquipmentUsedID ASC) [HalfMaskEquipmentUsedID], 
            (Select top 1 eu11.RefNo FROM @at_EquipmentUsed eu11 Where eu11.AirTestID=@AirTestID AND eu11.EquipmentCategoryID=11 Order by eu11.EquipmentUsedID ASC) [SlideBox],
            (Select top 1 eu12.RefNo FROM @at_EquipmentUsed eu12 Where eu12.AirTestID=@AirTestID AND eu12.EquipmentCategoryID=12 Order by eu12.EquipmentUsedID ASC) [TimerReference], 
            (Select top 1 eu12.CalibrationDueDate FROM @at_EquipmentUsed eu12 Where eu12.AirTestID=@AirTestID AND eu12.EquipmentCategoryID=12 Order by eu12.EquipmentUsedID ASC) [TimerCalibration],
            (Select top 1 eu13.RefNo FROM @at_EquipmentUsed eu13 Where eu13.AirTestID=@AirTestID AND eu13.EquipmentCategoryID=13 Order by eu13.EquipmentUsedID ASC) [BarometerReference],
            
            
            (Select top 1 eu17.RefNo FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 Order by eu17.EquipmentUsedID ASC) [FilterBox],
            (Select top 1 eu17.CalibrationText FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 AND eu17.CalibrationInformationDescription = 'Result' Order by eu17.EquipmentUsedID ASC) [FilterBoxResult],
            (Select top 1 eu17.CalibrationDueDate FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 Order by eu17.EquipmentUsedID ASC) [FilterBoxChecked],
            
            (Select top 1 eu62.RefNo FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 Order by eu62.EquipmentUsedID ASC) [PhaseTelescope],
            (Select top 1 eu62.CalibrationText FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 AND eu62.CalibrationInformationDescription = 'Result' Order by eu62.EquipmentUsedID ASC) [PhaseTelescopeResult],
            (Select top 1 eu62.CalibrationDueDate FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 Order by eu62.EquipmentUsedID ASC) [PhaseTelescopeChecked]
            
      ) EU ON eu.AirTestID=at.AirTestID
      
      LEFT OUTER JOIN
      (
            Select @AirTestID [AirTestID],
            (select IsNull(e.FullName,'&nbsp;') from @at_Inspection i LEFT OUTER JOIN Employee e on i.InspectionInt = e.EmployeeID where i.AirTestID = @AirTestID and i.InspectionLabelID = 6) [FibreAnalyst]
      
      ) INSP ON INSP.AirTestID=at.AirTestID
      
      CROSS JOIN
      (
            Select
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=0) [ActualAirSampleCount],
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=1) [FieldBlankFailedCount],
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=2) [FieldBlankPassedCount]
      ) AirSampleCount
      
      OUTER APPLY
      (
            Select
        tmp.Count,
        tmp.PooledVolume,
        tmp.PooledFibres,
        CASE WHEN tmp.QuantificationLevel < 0.01 AND tmp.PooledVolume > 480 THEN 0.01 ELSE tmp.QuantificationLevel END [QuantificationLevel],
        tmp.ResultConcentration
            FROM
            (Select COUNT(*) [Count], SUM(IsNull(pairs.Volume,0)) [PooledVolume], SUM(IsNull(Convert(decimal(12,3),pairs.Fibres),0)) [PooledFibres],
                  CASE WHEN CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) = Convert(decimal(12,3),0) OR AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)) = Convert(decimal(12,3),0) THEN
                        0
                  ELSE
                        (
                              Convert(decimal(12,3),96000)
                              / 
                              (Convert(decimal(12,3),CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT)) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)))
                        ) * Convert(decimal(12,3),0.01)
                  END [QuantificationLevel],
                  CASE WHEN ((IsNull(Convert(decimal(12,3),e118.ElementText),0) * IsNull(Convert(decimal(12,3),e118.ElementText),0)) * CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0))) > 0 THEN
                        CAST(
                              (1000 * SUM(IsNull(Convert(decimal(12,3),pairs.Fibres),0)) * (IsNull(Convert(decimal(12,3),e117.ElementText),0) * (IsNull(Convert(decimal(12,3),e117.ElementText),0))))
                                    /
                              ((IsNull(Convert(decimal(12,3),e118.ElementText),0) * IsNull(Convert(decimal(12,3),e118.ElementText),0)) * CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)))
                         AS varchar)
                  ELSE 'N/A' END [ResultConcentration]
            FROM 
        @AirSampleData pairs 
      Where 
        pairs.AirSampleItemNo=airs.AirSampleItemNo
            Group By pairs.AirSampleItemNo) tmp
      ) PooledSamples
WHERE
      at.AirTestID = @AirTestID
ORDER BY
      airs.RowNo

SET NOCOUNT OFF
End
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'DiscardReason' AND OBJECT_ID = OBJECT_ID('Enquiry'))
BEGIN
    ALTER TABLE [dbo].[Enquiry]
    ADD [DiscardReason] [varchar] (MAX) NULL;
END
GO

USE [TEAMS]
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_QuoteHistory')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_QuoteHistory] AS BEGIN SET NOCOUNT ON; END')
END

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Moving 'QuoteHistory' from a view to a stored procedure to increase speed.
-- In addition the the normal re-factoring, this requires a page number and number of items per page
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */

ALTER PROCEDURE [dbo].[Paged_QuoteHistory] 
      @PerPage INT = 15,
      @CurrentPage INT = 1,
      @ClientID INT = 0,
      @SiteID INT = 0,
      @ProjectID INT = 0,
      @QuoteHistoryFilterAssignedTo INT = 0,
      @QuoteHistoryFilterQuoteType INT = 0,
      @QuoteHistoryFilterHideInstaquote INT = 0,
	  @QuoteHistoryFilterQuoteEnquiry VARCHAR(10) = '',
      @QuoteID INT = 0,
      @EnquiryID INT = 0,
      @FilterStartDate DATETIME = NULL,
      @FilterEndDate DATETIME = NULL,
      @Filter VARCHAR(MAX) = ''
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @QuoteHistoryViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @QuoteHistoryView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX))
      
	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='Q' 
		OR @QuoteHistoryFilterQuoteEnquiry='Q_AC' OR @QuoteHistoryFilterQuoteEnquiry='Q_RJ'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
		  From
				Quote q 
				Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
				Left Outer Join Job j On q.JobId = j.JobId
				Left Outer Join Client c On c.ClientID = q.ClientID 
				Left Outer Join Project p On p.ProjectID = q.ProjectID 
				Left Outer Join Site s On s.SiteID = q.SiteID
				LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID
		  Where 
				(
					  LEN(@Filter ) = 0
							OR
					  (
							s.Address Like '%' + @Filter + '%'
								  Or 
							s.Postcode Like '%' + @Filter + '%'
								  Or 
							s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
							Or s.UPRN = @Filter
					)
				)
					  And
				(Not Accepted Is Null Or Not Rejected Is Null) 
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_AC' THEN
								CASE WHEN Not q.Accepted Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_RJ' THEN
								CASE WHEN Not q.Rejected Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND					  
				(@ProjectID=0 OR q.ProjectID=@ProjectID)
					  AND
				(@SiteID=0 OR q.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR q.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										q.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterHideInstaquote = 0 THEN 0 ELSE 
											Cast(
												Case When q.ReallyQuickQuote = 1 Then 
													1
												Else 
													0 
												End as bit) 
										END = 0
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
      END

	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='E'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select enq.EnquiryId,'E' as ItemType, enq.Created    
		  From
				Enquiries enq
		  Where
				(
					  LEN(@Filter ) = 0
							OR
					  (
							enq.SiteAddress Like '%' + @Filter + '%'
								  Or 
							enq.SitePostcode Like '%' + @Filter + '%'
								  Or 
							enq.SiteAddress + ', ' + enq.SitePostcode Like '%' + @Filter + '%'
							Or enq.SiteUPRN = @Filter
				)
				)
					  And
				(Not enq.Accepted Is Null Or Not enq.Rejected Is Null) 
					  And
				(
					  Not enq.QuoteId Is Null
							Or
					  (
							enq.QuoteId Is Null
								  And
							Not enq.Rejected Is Null
					  )
				)
					  AND
				(@ProjectID=0)
					  AND
				(@SiteID=0 OR enq.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR enq.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN @QuoteID = 0 AND @EnquiryID = enq.EnquiryID THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										enq.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN enq.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN enq.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
      END

	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='Q' 
		OR @QuoteHistoryFilterQuoteEnquiry='Q_AC' OR @QuoteHistoryFilterQuoteEnquiry='Q_RJ'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select DISTINCT q.QuoteID as ItemId, 'RQV' as ItemType, q.Created
		  FROM
				Quote q 
				INNER JOIN [dbo].[QuoteEmployee] qe ON qe.[QuoteID] = [q].[QuoteID]
				INNER JOIN [dbo].[QuoteVisit] qv ON qe.[QuoteEmployeeID] = [qv].[QuoteEmployeeID]   
				Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
				INNER JOIN Appointment a ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NOT NULL
				OUTER APPLY 
				(
					  /*count declined appointments and non declineds, if they have */
					  SELECT
							COUNT(*) [ValidAppointments]
					  FROM
							[dbo].[Appointment] _app 
					  WHERE
							_app.[QuoteID] = [q].[QuoteID]
								  AND
							_app.DateDeclined IS NULL
				) currentCount
				Left Outer Join Job j On q.JobId = j.JobId
				Left Outer Join Client c On c.ClientID = q.ClientID 
				Left Outer Join Project p On p.ProjectID = q.ProjectID 
				Left Outer Join Site s On s.SiteID = q.SiteID 
		  Where 
				(
					  LEN(@Filter ) = 0
							OR
					  (
							s.Address Like '%' + @Filter + '%'
								  Or 
							s.Postcode Like '%' + @Filter + '%'
								  Or 
							s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
							Or s.UPRN = @Filter
					  )
				)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_AC' THEN
								CASE WHEN Not q.Accepted Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_RJ' THEN
								CASE WHEN Not q.Rejected Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND					
				currentCount.ValidAppointments=0
					  AND
				(@ProjectID=0 OR q.ProjectID=@ProjectID)
					  AND
				(@SiteID=0 OR q.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR q.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										q.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterHideInstaquote = 0 THEN 0 ELSE 
											Cast(
												Case When q.ReallyQuickQuote = 1 Then 
													1
												Else 
													0 
												End as bit) 
										END = 0
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
      END
		         
			DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @QuoteHistoryViewID)				 
				    
      ;With Paging As 
    ( 
        Select 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
               Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
			END As Pages, 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
               ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
			END As Page, 

               Row_Number() Over(Order By a.Created DESC) as Row_Num, 
               *
               From 
               (
                              Select * FROM @QuoteHistoryViewID
                     ) a
    )
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
			CASE
				WHEN e.QuoteNo IS NOT NULL
				THEN dbo.FormatTeamsReference('Q', e.QuoteNo)
			ELSE
				q.Status
			END [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN COALESCE(e.DiscardReason, q.RejectReason, 'Rejected') ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
			ISNULL(e.EnquirySource,es.Description) [Source],
			ISNULL(e.LeadEmployee, qemp.FullName)	[SourceOrigin],
			CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo]
	From 
            Paging main
            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
			LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
			LEFT OUTER JOIN EnquirySource es ON q.EnquirySourceID = es.EnquirySourceID
			LEFT OUTER JOIN Employee qemp ON q.EnquiryEmployeeID = qemp.EmployeeID
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
			
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetJobStatus')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetJobStatus] AS BEGIN SET NOCOUNT ON; END')
END

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[GetJobStatus]    Script Date: 21/06/2017 13:10:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[GetJobStatus]
    @UPRN VARCHAR(50) = NULL,
    @JobNo INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Set default variable values if not passed in.
    SELECT
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @JobNo = NULLIF(@JobNo, 0)

    -- Make sure we have at least one parameter.
    IF @UPRN IS NULL AND @JobNo IS NULL
    BEGIN
        RAISERROR('No parameters passed in.', 12, 1)
        SET NOEXEC ON;
    END

    -- Start the main SELECT.
    SELECT
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName [ApprovedBy],
        Case
			WHEN na.NoAccess = 1 OR a.DateDeclined IS NOT NULL THEN 'No Access'
            When j.Approved IS NOT NULL Then 'Approved'
            When j.Approved IS NULL AND MAX(sc.SupplementaryChangeID) IS NOT NULL THEN 'Site Work Complete*'
            When reg.Samples > 0 AND reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
			When reg.Samples < 1 Then 'Sample Analysis Complete'    -- new
            When reg.Registers >= 1 Then 'Site Work Complete'
            When MAX(CAST(a.ManuallyMarkWorkDone AS INT)) = 1 THEN 'Marked as Complete'
            When [Log].SiteLogID Is Not null Then 'Work Started'
			Else 'Work Scheduled'
        End [Status],
        Case
			WHEN na.NoAccess = 1 THEN na.NoAccessCreated
			ELSE MIN(log.Created)
		End [AppointmentStartDate],
        MIN(reg.RegisterFinish) [WorkCompleted],
        iat.AnalysisCompleted
    FROM
        (
            SELECT
                j.JobID, j.JobNo, j.Approved, j.SampleContentEmployeeID
            FROM
                Job j WITH (NOLOCK)
                INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            WHERE
                CASE WHEN @JobNo IS NOT NULL
                    THEN CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END
                    ELSE CASE WHEN si.UPRN = @UPRN THEN 1 ELSE 0 END
                END = 1
        ) j
        LEFT JOIN Employee ae WITH (NOLOCK) ON j.SampleContentEmployeeID = ae.EmployeeID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobID
        LEFT JOIN SiteLog [log] on j.JobID = log.JobID and log.Description like '%started building%'
		Outer Apply
        (
            Select
                je.JobId,
                MAX(je.Created) [JobEmployeeCreated],
                Count(Distinct(reg.RegisterId)) as Registers,
                st.SurveyTypeId,
                st.Description as SurveyType,
                Max(reg.RegisterFinish) as RegisterFinish,
                Max(reg.DateApproved) as DateApproved,
                Count(s.SampleId) as Samples,
                Count(s.SampleResultId) as SampleResults,
                Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete,
                MIN(reg.RegisterStart) as RegisterStart
            From
                JobEmployee je WITH (NOLOCK)
                Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                Left Outer Join Sample s WITH (NOLOCK) On s.RoomId = r.RoomId And Not s.SampleRef Is Null And s.AsSample = 0
                Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
            Where
                je.JobId = j.JobID
            Group By
                je.JobId,
                st.SurveyTypeId,
                st.Description
        ) reg
		OUTER APPLY 
		(
			SELECT  
				na.JobID,
				1 [NoAccess],
				MAX(na.Created) [NoAccessCreated]
			FROM
				NoAccess na
				LEFT JOIN JobEmployee je ON na.JobID = je.JobID
				INNER JOIN Quote q ON na.JobID = q.JobID
				INNER JOIN Appointment a ON q.QuoteID = a.QuoteID
			WHERE
				na.JobID = j.JobID
					and 
				na.Deleted IS NULL 
			GROUP BY
				na.JobID
			HAVING
				(
					CASE WHEN MAX(na.Created) > MAX(a.StartTime) OR (MAX(na.Created) > MAX(a.StartTime) AND MAX(na.Created) > MAX(je.Created))  THEN --see gary for more info
						1
					ELSE
						0
					END = 1
				)
		) na
        OUTER APPLY
        (
            SELECT MAX(iat.DateCreated) [AnalysisCompleted]
            FROM
                IntranetAuditTrail iat WITH (NOLOCK)
            WHERE
                iat.DataId = j.JobID
                    AND
                iat.DataTable = 'Job'
                    AND
                iat.Message = 'Verified sample results'
        ) iat
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Approved,
        ae.FullName,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        iat.AnalysisCompleted,
        log.sitelogID,
		na.NoAccess,
		na.NoAccessCreated,
		a.DateDeclined
    ORDER BY
        j.Approved DESC,
        j.JobNo DESC

    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'UnmanagedSiteLeg' AND OBJECT_ID = OBJECT_ID('Site'))
BEGIN
	ALTER TABLE [Site] ADD [UnmanagedSiteLeg] BIT NOT NULL
	CONSTRAINT [DF_Site_UnmanagedSiteLeg]  DEFAULT ((0))
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ContactPostcode' AND OBJECT_ID = OBJECT_ID('AdditionalContactInfo'))
BEGIN
	ALTER TABLE [dbo].[AdditionalContactInfo]
	ADD [ContactPostcode] [varchar] (10) NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ContactAddress' AND OBJECT_ID = OBJECT_ID('AdditionalContactInfo'))
BEGIN
	ALTER TABLE [dbo].[AdditionalContactInfo]
	ADD [ContactAddress] [varchar] (200) NULL;
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SiteContact'))
	BEGIN
		CREATE TABLE [dbo].[SiteContact] (
        [SiteContactID] [int] IDENTITY (1, 1) NOT NULL,
        [ContactTypeID] [int] NOT NULL,
        [SiteID] [int] NOT NULL,
        [ProjectID] [int] NULL,
        [ContactText] [varchar] (MAX) NOT NULL,
        [EmployeeID] [int] NOT NULL,
        [DateCreated] [datetime] NOT NULL CONSTRAINT [DF_SiteContact_DateCreated] DEFAULT (getdate()),
        [Datedeleted] [datetime] NULL,
        CONSTRAINT [PK_SiteContact]
        PRIMARY KEY CLUSTERED
        (
            [SiteContactID] ASC
        )
        WITH (FILLFACTOR = 90, PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
        ON [PRIMARY]
        ) ON [PRIMARY]
        TEXTIMAGE_ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'ProjectJobSheet')
BEGIN
    EXEC('CREATE VIEW[dbo].[ProjectJobSheet] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[ProjectJobSheet]
AS

  Select
        0 as SortOrder,
        Min(a.AppointmentId) as AppointmentId,
        Case
                     When Max(reg.DateApproved) IS NOT Null Then 'Approved'
                     When j.Approved IS NULL AND sc.SupplementaryChangeId IS NOT NULL THEN 'Site Work Complete*'
                     When reg.Samples > 0 And reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
                     When reg.Registers >= 1 Then 'Site Work Complete'
                     When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
                     When j.Approved IS NULL AND sc.SupplementaryChangeId IS NOT NULL THEN 'Site Work Complete*'
              Else
            'Work Scheduled'
        End [Status],
        dbo.FormatTeamsDate(Case
              When Not reg.DateApproved Is Null Then
                              reg.DateApproved
              When reg.Samples > 0 And reg.Samples = reg.SampleResults Then
                    reg.AnalysisComplete
              When reg.Registers >= 1 Then
                    reg.RegisterFinish
              Else
                    Min(Cast(a.DateCreated as date))
        End, 1) [StatusDate],
        dbo.FormatTeamsReference('J', j.JobNo) as JobNo,
        s.[Address],
        s.Postcode,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        j.JobId,
        reg.SurveyTypeId,
        Min(Cast(a.StartTime as date)) as AppointmentDate,
        reg.SiteWorkComplete as DateSiteWorkComplete,
        reg.AnalysisComplete,
        Count(Distinct(j.JobId)) as TotalJobs,
        Count(Distinct(j.JobId)) - reg.Registers as WorkScheduled,
        reg.Registers as SiteWorkComplete,
        reg.Samples,
        reg.SampleResults,
        bsr.FileName as FileName,
        a.ClientOrderNo,
        dbo.FormatTeamsDate(Cast(Min(a.DateCreated) as date), 1) as DateReceived,
        dbo.FormatTeamsDate(Cast(Min(q.Created) as date), 1) as QuoteDate,
        s.uprn,
        reg.SurveyType,
        Surveyors.Surveyor,
        dbo.FormatTeamsDate(Min(Cast(a.StartTime as date)), 1) as SurveyStart,
        dbo.FormatTeamsDate(reg.RegisterFinish, 1) as SurveyCompleted,
        ISNULL(dbo.FormatTeamsDate(iat.AnalysisCompleted, 1), '') as AnalysisCompleted,
        dbo.FormatTeamsDate(Max(Cast(j.Approved as date)),1) as Approved,
        Approver.FullName as ApprovedBy,
        dbo.FormatTeamsDate(Min(Cast(aps.DueDate as date)), 1) DueDate,
        COUNT(na.NoAccessID) + COUNT(na2.NoAccessID) AS NoAccessAttempts,
        pc.PhoneCalls,
        l.Letters,
        [p].[GroupName],
        a.ClientId,
        a.ProjectId,
        a.SiteId,
        s.Other,
        MAX(na.Created) [LastNoAccessDate],
        MAX(reg.JobEmployeeCreated) [LastJobEmployeeDate],
        q.QuoteId,
		dbo.CleanDate(ii.ItemDate) [InvoiceDate]
  From
        Appointment a WITH (NOLOCK)
        Inner Join AppointmentSurvey as aps WITH (NOLOCK) On a.AppointmentID = aps.AppointmentID
        Inner Join [Site] s WITH (NOLOCK) On a.SiteId = s.SiteId and s.Deleted Is Null
        Inner Join Project p WITH (NOLOCK) On p.ProjectId = a.ProjectId
        Inner Join Quote q WITH (NOLOCK) On q.QuoteId = a.QuoteId
		LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
		
        Inner Join Job j WITH (NOLOCK) On q.JobId = j.JobId And j.Cancelled Is Null
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobId
        Outer Apply
        (
                  Select
                        je.JobId,
                        MAX(je.Created) [JobEmployeeCreated],
                        Count(Distinct(reg.RegisterId)) as Registers,
                        st.SurveyTypeId,
                        st.Description as SurveyType,
                        Max(Cast(reg.RegisterFinish as Date)) as RegisterFinish,
                        Max(reg.DateApproved) as DateApproved,
                        Count(s.SampleId) as Samples,
                        Count(s.SampleResultId) as SampleResults,
                        Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                        Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete
                  From
                        JobEmployee je WITH (NOLOCK)
                        Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                        Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                        Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                        Left Outer Join Samples s WITH (NOLOCK) On s.RoomId = r.RoomId And Not SampleRef Is Null And AsSample = 0
                        Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                        Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
                  Where
                        je.JobId = j.JobId
                  Group By
                        je.JobId,
                        st.SurveyTypeId,
                        st.Description
        ) reg
        Left Outer Join Employee as Approver WITH (NOLOCK) On j.SampleContentEmployeeId = Approver.EmployeeId
        Outer Apply
        (
              Select Top 1
                    e.FullName as Surveyor
              From
                    JobEmployee je2 WITH (NOLOCK)
                    Inner Join Employee e WITH (NOLOCK) On je2.EmployeeId = e.EmployeeId
              Where
                    je2.MainEmployee = 1
                          And
                    je2.JobId = j.JobId
              Order By
                    ActualStart
        ) as Surveyors
        Outer Apply
        (
              Select
                    Max(iat.DateCreated) as AnalysisCompleted
              From
                    IntranetAuditTrail iat WITH (NOLOCK)
              Where
                    iat.DataId = j.JobID and
                    iat.DataTable = 'Job' and 
                    iat.[Message] = 'Verified sample results'
        ) iat
        Outer Apply
        (
              Select Top 1 FileName From PDF WITH (NOLOCK) Where DateDeleted Is Null and FileName Like '%bsr%' and JobId = j.JobId Order By FileName DESC
        ) bsr
        LEFT JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
        LEFT JOIN NoAccess na2 WITH (NOLOCK) ON na2.SiteID = s.SiteID
        Outer Apply
        (
              Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) pc
        Outer Apply
        (
              Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) l
              OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone


  Where
        a.AppointmentId = (Select Min(AppointmentId) From Appointment WITH (NOLOCK) Where QuoteId = q.QuoteId And DateDeclined Is Null)
        and a.DateDeclined Is Null
  Group By
        j.JobId,
        j.JobNo,
        s.SiteId,
        s.[Address],
        s.Postcode,
        j.Approved,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        a.ClientOrderNo,
        s.uprn,
        Surveyors.Surveyor,
        Approver.FullName,
        [p].[GroupName],
        a.ClientId,
        a.ProjectId,
        a.SiteId,
        reg.SurveyTypeId,
        reg.SurveyType,
        reg.AnalysisComplete,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        reg.DateApproved,
        reg.RegisterFinish,
        reg.SiteWorkComplete,
        bsr.FileName,
        iat.AnalysisCompleted,
        s.Other,
        pc.PhoneCalls,
        l.Letters,
        q.QuoteId,
        workdone.ManuallyMarkWorkDone,
        sc.SupplementaryChangeId,
		ii.ItemDate

Union

Select
    1 as SortOrder,
    Null as AppointmentId, 
    'Unscheduled' as [Status],
    Null as [StatusDate],
    Null as JobNo,
    s.[Address],
    s.Postcode,
    s.Contact,
    s.Telephone,
    s.SiteEmail,
    Null as JobId,
    Null as SurveyTypeId,
    Null as AppointmentDate,
    Null as DateSiteWorkComplete,
    Null as AnalysisComplete,
    Null as TotalJobs,
    Null as WorkScheduled,
    Null as SiteWorkComplete,
    Null as Samples,
    Null as SampleResults,
    Null as FileName,
    Null as ClientOrderNo,
    Null as DateReceived,
    Case
        When Not Max(q.Created) Is Null Then
            dbo.FormatTeamsDate(Cast(Min(q.Created) as date), 1)
        Else
            null
    End [QuoteDate],
    s.UPRN,
    Null as SurveyType,
    Null as Surveyor,
    Null as SurveyStart,
    Null as SurveyCompleted,
    Null as AnalysisCompleted,
    Null as Approved,
    Null as ApprovedBy,
    Null as DueDate,
    0 as NoAccessAttempts,
    pc.PhoneCalls,
    l.Letters,
    p.GroupName,
    c.ClientId,
    ps.ProjectId,
    s.SiteId,
    s.Other,
    Null [LastNoAccessDate],
    Null [LastJobEmployeeDate],
    Case
        When Not Max(q.QuoteID) Is Null Then
            q.QuoteID
        Else
            null
    End [QuoteID],
	dbo.CleanDate(ii.ItemDate) [InvoiceDate]
From
    [Site] s WITH (NOLOCK)
    Inner Join ClientSite c WITH (NOLOCK) On s.SiteId = c.SiteId
    Inner join ProjectSite ps WITH (NOLOCK) On s.SiteId = ps.SiteId
    Inner Join Project p WITH (NOLOCK) On ps.ProjectId = p.ProjectId
    Left Outer Join Appointment a WITH (NOLOCK) On ps.ProjectId = a.ProjectId And s.SiteId = a.SiteId AND a.AppointmentTypeID IN (1,3,9)
    left outer join Appointment dc WITH (NOLOCK) On dc.DateDeclined IS NULL AND dc.ProjectID = p.ProjectID AND dc.SiteID = s.SiteID AND dc.AppointmentTypeID IN (1,3,9)
    left outer join Quote q WITH (NOLOCK) on q.SiteID = ps.SiteID AND q.ProjectID = ps.ProjectID AND q.Rejected IS NULL
	left join InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
    Outer Apply
    (
        Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
    ) pc
    Outer Apply
    (
        Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
    ) l
Where
      s.deleted Is NULL
    AND
      (
        (a.AppointmentId Is NULL)
        or
        (a.AppointmentID is not null and dc.AppointmentID is null)
    )
Group BY 
    s.[Address],
    s.Postcode,
    s.Contact,
    s.Telephone,
    s.SiteEmail,
    s.UPRN,
    p.GroupName,
    c.ClientId,
    ps.ProjectId,
    s.SiteId,
    s.Other,
    pc.PhoneCalls,
    l.Letters,
    q.QuoteID,
    q.Created,
	ii.ItemDate

union
--AIR TESTS
  Select
        3 as SortOrder,
        a.AppointmentId as AppointmentId,
        CASE
            WHEN atDetails.[firstId] IS NULL THEN 'Airtest Scheduled'
            WHEN atDetails.[airtestFinish] IS NULL THEN 'Approved'
            WHEN atDetails.[airtestFinish] IS NOT NULL THEN 'Site Work Complete'
                     When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
        End [Status],
        null [StatusDate],
        dbo.FormatTeamsReference('J', j.JobNo)  /*+  ISNULL(' - ' + jobAtt.string ,'')*/ AS JobNo,
        s.[Address],
        s.Postcode,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        j.JobId,
        [a].[AppointmentID],
        Cast(a.StartTime as date) AS AppointmentDate,
        atDetails.[airtestFinish] DateSiteWorkComplete,
        null AnalysisComplete,
        0 TotalJobs,
        0 WorkScheduled,
        0 SiteWorkComplete,
        0 Samples,
        0 SampleResults,
        null FileName,
        a.ClientOrderNo,
        dbo.FormatTeamsDate(Cast(a.DateCreated as date), 1) AS DateReceived,
        dbo.FormatTeamsDate(Cast(q.Created as date), 1) AS QuoteDate,
        s.uprn,
        AirtestTypesList.[string],
        jobAirTEmpl.[string] Surveyor,
        dbo.FormatTeamsDate(CAST(atDetails.[airtestStart] as date), 1) AS SurveyStart,
        dbo.FormatTeamsDate(CAST(atDetails.[airtestFinish] as date) , 1) AS SurveyCompleted,
        null AnalysisCompleted,
        dbo.FormatTeamsDate(Cast(j.Approved as date),1) as Approved,
        NULL ApprovedBy,
        null DueDate,
        na.NoAccessAttempts,
        pc.PhoneCalls,
        l.Letters,
        [p].[GroupName],
        j.ClientId,
        j.ProjectId,
        j.SiteId,
        s.Other,
        lna.Created [LastNoAccessDate],
        lje.Created [LastJobEmployeeDate],
        q.QuoteId,
		dbo.CleanDate(ii.ItemDate) [InvoiceDate]
  FROM
        [dbo].[Job] j WITH (NOLOCK)
        Inner Join [Site] s WITH (NOLOCK) On j.SiteId = s.SiteId and s.Deleted Is Null
        INNER JOIN project p WITH (NOLOCK) ON j.[ProjectID] = [p].[ProjectID]
		LEFT OUTER JOIN [dbo].[Quote] q WITH (NOLOCK) ON j.[JobID] = [q].[JobID] AND j.[Cancelled] IS NULL
		LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
        /*all the airtest types that have been done and passed back concatenate*/
        OUTER APPLY
        (
            select
            STUFF(
                    (
                        SELECT DISTINCT
                            ',' + ISNULL([att].[Description],'') [text()]
                        FROM
                            [dbo].[JobEmployee] je WITH (NOLOCK)
                            LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                            LEFT OUTER JOIN [dbo].[AirTest] at WITH (NOLOCK) ON [at].[JobEmployeeID] = [je].[JobEmployeeID]
                            LEFT OUTER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [at].[AirTestTypeID]
                        WHERE 
                            je.[JobID] = [j].[JobID]
                        FOR XML PATH('')
                     ),
                    1,
                    1,
                    ''
            )
        )jobAtt(string)
        /*all the airtest surveyor that have been passed back concatenate*/
        OUTER APPLY
        (
            select
            STUFF(
                    (
                        SELECT DISTINCT
                            ',' + ISNULL([emp].[FullName],'') [text()]
                        FROM
                            [dbo].[JobEmployee] je WITH (NOLOCK)
                            LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                        WHERE 
                            je.[JobID] = [j].[JobID]
                        FOR XML PATH('')
                     ),
                    1,
                    1,
                    ''
            )
        )jobAirTEmpl(string)
        /*all the airtest details concatenate*/
        OUTER apply(
            SELECT
                MIN([at].[AirTestID]),
                MIN([at].[AirTestStart]),
                MAX([at].[AirTestFinish])
            FROM
                [dbo].[JobEmployee] je WITH (NOLOCK)
                LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                LEFT OUTER JOIN [dbo].[AirTest] at WITH (NOLOCK) ON [at].[JobEmployeeID] = [je].[JobEmployeeID]
                LEFT OUTER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [at].[AirTestTypeID]
            WHERE 
                je.[JobID] = [j].[JobID]
        )atDetails(firstId,airtestStart,airtestFinish)
        
        
        
        /*get first appointment record for quote*/
        outer apply
        (
            SELECT TOP 1
                _a.[AppointmentID],
                _a.[StartTime],
                _a.[ProjectID]
            FROM
                [dbo].[Appointment] _a WITH (NOLOCK)
                INNER JOIN Quote _q WITH (NOLOCK) ON _q.QuoteID = _a.QuoteID
            WHERE
                _q.JobID = j.JobID
                AND _a.DateDeclined Is NULL
            ORDER BY 
                _a.[StartTime]
        )firstapp(id,startTime,projectId)
        LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.[AppointmentID]= [firstapp].[id]
        LEFT OUTER JOIN [dbo].[AppointmentAirMonitoring] as aps WITH (NOLOCK) On a.AppointmentID = aps.AppointmentID
        
        /*all the airtest types that were asked for IN THE APPOINTMENT*/
        OUTER APPLY
        (
            SELECT
                STUFF(
                        (
                            SELECT
                                ','+ ISNULL([att].[Description],'') [text()]
                            FROM
                                [dbo].[AppointmentAirMonitoringType] amt WITH (NOLOCK)
                                INNER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [amt].[AirTestTypeID]
                            WHERE 
                                [amt].[AppointmentAirMonitoringID] =[aps].[AppointmentAirMonitoringID]
                            FOR XML PATH('')
                        ),
                        1,
                        1,
                        ''
                )
        )AirtestTypesList(string)
        Outer Apply
        (
              Select Count(*) as NoAccessAttempts From NoAccess WITH (NOLOCK) Where JobId = j.jobid Or SiteId = s.SiteId
        ) na
        Outer Apply
        (
              Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) pc
        Outer Apply
        (
              Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) l
        Outer Apply
        (
            Select top 1 lna.Created From NoAccess lna WITH (NOLOCK) Where lna.jobid = j.jobid order by lna.Created desc
        ) lna
        Outer Apply
        (
            Select top 1 lje.Created From jobemployee lje WITH (NOLOCK) Where lje.jobid = j.jobid order by lje.Created desc
        ) lje
              OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone
    WHERE [q].[QuoteTypeID] =5

UNION -- Legionella

SELECT
    4 [SortOrder],
    a.AppointmentID [AppointmentId],
    CASE
        WHEN l.DateApproved IS NOT NULL THEN 'Approved'
        WHEN l.Registers >= 1 THEN 'Site Work Complete'
              When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
        ELSE 'Work Scheduled'
    END [Status],
    dbo.FormatTeamsDate(
        CASE
            WHEN l.DateApproved IS NOT NULL THEN l.DateApproved
            WHEN l.Registers >= 1 THEN l.LegionellaFinish
            ELSE CAST(a.DateCreated AS DATE)
        END, 1) [StatusDate],
    dbo.FormatTeamsReference('J', j.JobNo) [JobNo],
    si.Address,
    si.Postcode,
    si.Contact,
    si.Telephone,
    si.SiteEmail,
    j.JobID,
    legt.LegionellaTypeID [SurveyTypeId],
    CAST(a.StartTime AS DATE) [AppointmentDate],
    l.LegionellaFinish [DateSiteWorkComplete],
    NULL [AnalysisComplete],
    1 [TotalJobs],
    1 - l.Registers [WorkScheduled],
    l.Registers [SiteWorkComplete],
    NULL [Samples],
    NULL [SampleResults],
    NULL [FileName],
    a.ClientOrderNo,
    dbo.FormatTeamsDate(CAST(MIN(a.DateCreated) AS DATE), 1) [DateReceived],
    dbo.FormatTeamsDate(CAST(MIN(q.Created) AS DATE), 1) [QuoteDate],
    si.UPRN [uprn],
    legt.Description [SurveyType],
    sur.Surveyor,
    dbo.FormatTeamsDate(CAST(MIN(a.StartTime) AS DATE), 1) [SurveyStart],
    dbo.FormatTeamsDate(l.LegionellaFinish, 1) [SurveyCompleted],
    NULL [AnalysisCompleted],
    dbo.FormatTeamsDate(CAST(MAX(j.Approved) AS DATE), 1) [Approved],
    l.ApprovedBy,
    dbo.FormatTeamsDate(CAST(MIN(al.DueDate) AS DATE), 1) [DueDate],
    COUNT(na.NoAccessID) + COUNT(nasi.NoAccessID) [NoAccessAttempts],
    pc.PhoneCalls,
    le.Letters,
    p.GroupName,
    a.ClientID [ClientId],
    a.ProjectID [ProjectId],
    a.SiteID [SiteId],
    si.Other,
    MAX(na.Created) [LastNoAccessDate],
    MAX(l.JobEmployeeCreated) [LastJobEmployeeDate],
    q.QuoteID [QuoteId],
	dbo.CleanDate(ii.ItemDate) [InvoiceDate]
FROM
    Appointment a WITH (NOLOCK)
    INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON a.AppointmentID = al.AppointmentID
    INNER JOIN LegionellaType legt WITH (NOLOCK) ON al.LegionellaTypeID = legt.LegionellaTypeID
    INNER JOIN Project p WITH (NOLOCK) ON a.ProjectID = p.ProjectID AND p.Deleted IS NULL
    INNER JOIN Site si WITH (NOLOCK) ON a.SiteID = si.SiteID AND si.Deleted IS NULL
    INNER JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID AND q.Rejected IS NULL
	LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
	INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Cancelled IS NULL
    OUTER APPLY
    (
        SELECT
            je.JobID,
            MAX(je.Created) [JobEmployeeCreated],
            COUNT(DISTINCT(l.LegionellaID)) [Registers],
            MAX(l.DateApproved) [DateApproved],
            MAX(CAST(l.LegionellaFinish AS DATE)) [LegionellaFinish],
            MAX(ae.FullName) [ApprovedBy]
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
            LEFT JOIN Employee ae WITH (NOLOCK) ON l.EmployeeID = ae.EmployeeID
        WHERE
            je.JobId = j.JobId
        GROUP BY
            je.JobID
    ) l
    OUTER APPLY
    (
        SELECT TOP 1
            e.FullName [Surveyor]
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
        WHERE
            je.JobID = j.JobID
                AND
            je.MainEmployee = 1
        ORDER BY
            je.ActualStart
    ) sur -- Surveyors
    LEFT JOIN NoAccess na WITH (NOLOCK) ON j.JobID = na.JobID
    LEFT JOIN NoAccess nasi WITH (NOLOCK) ON si.SiteID = nasi.SiteID
    OUTER APPLY
    (
        SELECT COUNT(*) [PhoneCalls] FROM SiteContact WITH (NOLOCK) WHERE ProjectID = p.ProjectID AND SiteID = si.SiteID AND DateDeleted IS NULL AND ContactTypeID = 1
    ) pc -- Phone Calls
    OUTER APPLY
    (
        SELECT COUNT(*) [Letters] FROM SiteContact WITH (NOLOCK) WHERE ProjectID = p.ProjectID AND SiteID = si.SiteID AND DateDeleted IS NULL AND ContactTypeID = 2
    ) le -- Letters
       OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone
WHERE
    a.AppointmentID = (SELECT MIN(AppointmentID) FROM Appointment WITH (NOLOCK) WHERE QuoteID = q.QuoteID AND DateDeclined IS NULL)
GROUP BY
    q.QuoteID,
    a.AppointmentID,
    a.ClientID,
    a.ProjectID,
    a.SiteID,
    a.StartTime,
    a.ClientOrderNo,
    a.DateCreated,
    legt.LegionellaTypeID,
    legt.Description,
    p.Project,
    p.GroupName,
    si.SiteID,
    si.Address,
    si.Postcode,
    si.UPRN,
    si.Contact,
    si.Telephone,
    si.SiteEmail,
    si.Other,
    j.JobID,
    j.JobNo,
    j.Approved,
    l.JobEmployeeCreated,
    l.Registers,
    l.DateApproved,
    l.LegionellaFinish,
    l.ApprovedBy,
    sur.Surveyor,
    pc.PhoneCalls,
    le.Letters,
    workdone.ManuallyMarkWorkDone,
	ii.ItemDate

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'changeClientSiteForJobQuote')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[changeClientSiteForJobQuote] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[changeClientSiteForJobQuote]
	-- Add the parameters for the stored procedure here
	@quoteid int,
	@jobid int,
	@siteID int,
	@ClientID int,
    @projectId int = NULL
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	DECLARE 
	@errNo int,
	@errDesc varchar(255),
	@currentProjectID int,
    @currentClientId int,
    @currentSiteId int

	begin TRAN

	if not @jobid is null
	BEGIN 
        --before any changes take place get the details for the job
		select @currentProjectID = projectID,@currentClientId= [ClientID], @currentSiteId= [SiteID] from Job where JobID = @jobid
		                
        /*handle project site link*/        

        if @projectId!=@currentProjectID --check if project has changed
        BEGIN
            IF @projectId IS NOT NULL --the change was to a valid project
            BEGIN
                IF @siteID IS NOT NULL --check if there is a site passed in as a project and site are needed.
                BEGIN
                    IF NOT EXISTS(SELECT 'x' FROM [dbo].[ProjectSite] ps WHERE ps.[ProjectID]=@projectId AND [ps].[SiteID]=@siteID)  --check the project exists for the project and site
                    BEGIN 
                        --insert a new link to the project for the site
                        INSERT INTO [dbo].[ProjectSite] ([ProjectID], [SiteID])
                        SELECT @projectId,@siteID
                        
                		select @errNo = @@ERROR
                		if @errNo<>0 
                		begin
                			goto errHandle
                		END	    
                        
                    END 
                END 
                
                --remove the old link if there was a client and project selected originally
                IF @currentProjectID IS NOT NULL AND @currentSiteId IS NOT NULL
                BEGIN
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId                    
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	    
                END 
            END
            ELSE
            BEGIN
                --no project assigned, make sure that there is a project and site for the existing one 
                IF @currentProjectID IS NOT NULL AND @currentClientId IS NOT NULL
                BEGIN
                    --and remove it
                    delete FROM [dbo].[ProjectSite]  WHERE projectid = @currentProjectID AND siteid = @currentSiteId             
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	    
                END                     
            END
        END

        DECLARE @PreviousClientID INT = (Select ClientID FROM Job Where JobID = @jobid)
        DECLARE @PreviousSiteID INT = (Select SiteID FROM Job Where JobID = @jobid)
        update job set ClientID=@ClientID, siteID=@siteID, projectid=@projectId, contactid = NULL where jobid =@jobid
		DECLARE @Approved BIT = (SELECT CASE WHEN j.Approved IS NOT NULL THEN 1 ELSE 0 END [Approved] FROM Job j WHERE j.JobID = @jobid)

        -- Populate portal data for the new client & site of the job
		IF @Approved = 1
		BEGIN
			EXEC PopulateSampleComputedData @JobID
			If @PreviousClientID<>@ClientID OR @PreviousSiteID<>@siteID BEGIN
				Exec PopulateGuidSamples @PreviousClientID, @PreviousSiteID 
				Exec CreateSiteSampleResultsOverviewSorting @PreviousClientID, @PreviousSiteID
			END		
			Exec PopulateGuidSamples @ClientId, @SiteId 
			Exec CreateSiteSampleResultsOverviewSorting @ClientId, @SiteId
		
			-- Re-populate portal data for the old client & site.
			Exec PopulateGuidSamples @currentClientId, @currentSiteId 
			Exec CreateSiteSampleResultsOverviewSorting @currentClientId, @currentSiteId
		END
		
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating job'
			goto errHandle
		END
        
        /*clear out the jobs current client appendices by default*/
        
        UPDATE 
            R
        SET 
            r.[AppendicesClientTemplateID] = NULL 
        FROM
            [dbo].[Register] r
            INNER JOIN [dbo].[JobEmployee] je ON r.[JobEmployeeID] = [je].[JobEmployeeID]
            INNER JOIN [dbo].[Job] j ON je.[JobID] = [j].[JobID]
        WHERE 
            [j].[JobID] = @jobid
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while resetting job registers client appendix template id'
			goto errHandle
		END        
        
        DECLARE @ctid [int]
        SET @ctid = 
            (
                select TOP 1
                	[ct].[TemplateID]
                from
                	TemplateType t 
                	inner join ClientTemplate ct on t.TemplateTypeID = ct.TemplateTypeID
                where 
                	ct.ClientID = @ClientID and 
                	not version is null
                	and TemplateType = 'Survey - Appendices'
                order by
                	ct.Version DESC
            )
        IF @ctid IS NOT NULL
        BEGIN
        
            UPDATE 
                 R
            SET 
                r.[AppendicesClientTemplateID] = @ctid 
            FROM
                [dbo].[Register] r
                INNER JOIN [dbo].[JobEmployee] je ON r.[JobEmployeeID] = [je].[JobEmployeeID]
                INNER JOIN [dbo].[Job] j ON je.[JobID] = [j].[JobID]
            WHERE 
                [j].[JobID] = @jobid
        
            if @errNo<>0 
            BEGIN
                select @errDesc = 'ERROR while setting job registers to new client appendix template id'
                goto errHandle
            END
        end
	end 
	
	if not @quoteid is null
	begin 
		select @currentProjectID = projectID,@currentClientId= [ClientID],@currentSiteId= [SiteID] from quote where quoteID =@quoteid
                
        if @projectId!=@currentProjectID --check if project has changed
        BEGIN
            IF @projectId IS NOT NULL --the change was to a valid project
            BEGIN
                IF @siteID IS NOT NULL --check if there is a site passed in as a project and site are needed.
                BEGIN
                    IF NOT EXISTS(SELECT 'x' FROM [dbo].[ProjectSite] ps WHERE ps.[ProjectID]=@projectId AND [ps].[SiteID]=@siteID)  --check the project exists for the project and site
                    BEGIN 
                        --insert a new link to the project for the site
                        INSERT INTO [dbo].[ProjectSite] ([ProjectID], [SiteID])
                        SELECT @projectId,@siteID
                        
                        select @errNo = @@ERROR
                		if @errNo<>0 
                		begin
                			goto errHandle
                		END	        
                    END 
                END 
                
                --remove the old link if there was a client and project selected originally
                IF @currentProjectID IS NOT NULL AND @currentSiteId IS NOT NULL
                BEGIN
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId           
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	        
                END 
            END
            ELSE
            BEGIN
                --no project assigned, make sure that there is a project and site for the existing one 
                IF @currentProjectID IS NOT NULL AND @currentClientId IS NOT NULL
                BEGIN
                    --and remove it
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId                    
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	        
                END                     
            END
        END
	
		update quote set ClientID=@ClientID, siteID=@siteID, projectid=@projectId,@currentSiteId= [SiteID], contactID = NULL where quoteID =@quoteid
        
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating quote'
			goto errHandle
		end

		UPDATE Appointment set ClientID=@ClientID, siteID=@siteID, ProjectID=@projectid, ContactId = NULL where quoteID=@quoteid
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating appointment(s)'
			goto errHandle
		end

	end

	if not exists(select 'x' from ClientSite where SiteID = @siteID and ClientID=@ClientID)
	begin 
		insert into Clientsite (Clientsite.ClientID,Clientsite.SiteID) values (@ClientID,@siteID)
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			goto errHandle
		end	
	end

	commit tran
	goto exit_proc

	errHandle:
		rollback TRAN

	exit_proc:

    SET NOCOUNT off    
END

GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaWip')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaWip] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[dgLegionellaWip] AS 
	Select
		j.JobId,
		qvt.QuoteVisitTypeId [TypeID], 
		qvt.Description [Type], 
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		Cast(MIN(a.StartTime) as date) [Start],
		Cast(MIN(a.EndTime) as date) [Finish],
		Cast(MIN(a.EndTime) as date) [MonitoringSchedule],
		Cast(MAX(agt.DueDate) as date) [Due], 
		c.ClientId,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteId,
		s.Address [Site],
		0 As [Report],
		0 As [Photos],
		0 As [Plans],
		0 As [Documents],
		j.Approved [DateApproved],
		0 [HasNotes],
		0 [NotesInLastHour],
		0 [NewGrid],
		j.Status [Status],
		'' [OrgState],
		0 As [PDF],
		qe.EmployeeID [EmployeeID],
		e.FullName
	From 
		Quote q WITH (NOLOCK)
		INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID=qe.QuoteID
		INNER JOIN Employee e WITH (NOLOCK) ON qe.EmployeeID = e.EmployeeID
		INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
		INNER JOIN QuoteVisitType qvt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
		Inner Join Appointment a WITH (NOLOCK) On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)
		INNER JOIN
		(
			Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag WITH (NOLOCK)
					UNION
			Select null [DueDate], at.AppointmentID FROM AppointmentTraining at WITH (NOLOCK)
		) agt ON agt.AppointmentID=a.AppointmentID
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=q.JobID
		Left Outer Join Client c WITH (NOLOCK) On a.ClientId = c.ClientId
		Left Outer Join Site s WITH (NOLOCK) On a.SiteId = s.SiteId
		Outer Apply 
		(
			Select Top 1 [FileName] From PDF p WITH (NOLOCK) Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
		) oa_pdf
	Where
		(Select COUNT(*) FROM Appointment suba WITH (NOLOCK) Where ManuallyMarkWorkDone=1 AND QuoteID=q.QuoteID AND suba.AppointmentTypeID IN (5,4) AND suba.DateDeclined IS NULL) = 0
			And
		a.DateConfirmed IS NOT Null
			And
		a.DateDeclined Is Null
			And
		qvt.QuoteVisitTypeId=4
	GROUP BY
		j.JobId,
		qvt.QuoteVisitTypeId,
		qvt.Description,
		j.JobNo,
		c.ClientId,
		c.Client,
		c.BranchName,
		s.SiteId,
		s.Address,
		j.Approved,
		j.Status,
		qe.EmployeeID,
		e.FullName


GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaCompleted')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaCompleted] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[dgLegionellaCompleted] AS 
	Select
		j.JobId,
		qvt.QuoteVisitTypeId [TypeID], 
		qvt.Description [Type], 
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		Cast(MIN(a.StartTime) as date) [Start],
		Cast(MIN(a.EndTime) as date) [Finish],
		Cast(MIN(a.EndTime) as date) [MonitoringSchedule],
		Cast(MAX(agt.DueDate) as date) [Due], 
		c.ClientId,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteId,
		s.Address [Site],
		0 As [Report],
		0 As [Photos],
		0 As [Plans],
		0 As [Documents],
		j.Approved [DateApproved],
		0 [HasNotes],
		0 [NotesInLastHour],
		0 [NewGrid],
		j.Status [Status],
		'' [OrgState],
		0 As [PDF],
		qe.EmployeeID [EmployeeID],
		e.FullName [FullName]
	From 
		Quote q WITH (NOLOCK)
		INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID=qe.QuoteID
		INNER JOIN Employee e WITH (NOLOCK) ON qe.EmployeeID = e.EmployeeID
		INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
		INNER JOIN QuoteVisitType qvt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
		Inner Join Appointment a WITH (NOLOCK) On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)
		INNER JOIN
		(
			Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag WITH (NOLOCK)
				UNION
			Select null [DueDate], at.AppointmentID FROM AppointmentTraining at WITH (NOLOCK)
		) agt ON agt.AppointmentID=a.AppointmentID
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=q.JobID
		Left Outer Join Client c WITH (NOLOCK) On a.ClientId = c.ClientId
		Left Outer Join Site s WITH (NOLOCK) On a.SiteId = s.SiteId
		Outer Apply 
		(
			Select Top 1 [FileName] From PDF p WITH (NOLOCK) Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
		) oa_pdf
	Where
		a.ManuallyMarkWorkDone = 1
			And
		a.DateConfirmed IS NOT Null
			And
		a.DateDeclined Is Null
			And
		qvt.QuoteVisitTypeId=4
	GROUP BY
		j.JobId,
		qvt.QuoteVisitTypeId,
		qvt.Description,
		j.JobNo,
		c.ClientId,
		c.Client,
		c.BranchName,
		s.SiteId,
		s.Address,
		j.Approved,
		j.Status,
		qe.EmployeeID,
		e.FullName

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AppointmentToolTipData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AppointmentToolTipData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[AppointmentToolTipData]
	@AppointmentID int,
	@JobID INT = 0
AS
BEGIN
	SET NOCOUNT ON;
	
	
-- Stand alone site appointments.
Select
    q.Exclusions,
    q.ScopeOfWork,
    q.Notes,
    MobileDataReturned,
    MobileDataReturnedOutsideOfScope,
    MobileData,
    NoAccess,
    noAccessOutsideOfScope,
    ProjectId,
    Project,
    JobNo,
    DateDeclined,
    DateConfirmed,
    CASE
		WHEN main.AppointmentTypeId = 4
		THEN main.TrainingType
	ELSE
		AppointmentType
	END [AppointmentType],
    appCategoryDescription,
    HTML_COLOUR,
    Client,
    Site,
    Main.Cost,
    IsNull(AppointmentGroup.StartTime, Main.StartTime) as StartTime,
    IsNull(AppointmentGroup.EndTime, Main.EndTime) as EndTime,
    t.Description as SurveyType, 
    apBranch.branchoffice 
From 
(
	Select
		DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
		DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
		DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
		Case
			When Cast(a.StartTime as Date) = Cast(a.EndTime as Date) Then
				DateDiff(n, a.StartTime, a.EndTime)
			Else
				DateDiff(n, a.StartTime, DateAdd(d, 1, Cast(Cast(a.StartTime as date) as datetime)))
			End as Duration,
		a.StartTime, 
		a.EndTime,
		a.AppointmentID,
		IsNull(at.AppointmentType, '') As AppointmentType,
		c.ClientID,
		IsNull(c.Client, '') as Client,
		p.ProjectID,
		IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
		s.SiteID,
		Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
		s.Address,
		s.Postcode,
		s.UPRN,
		j.JobId,
		j.JobNo,
	--	a.ClientOrderNo,
		a.Cost,
		a.DateConfirmed,
	--	Cast(a.Notes as varchar(max)) as Notes,
		a.CalendarFileID,
		e.EmployeeID, 
		e.FullName AS Employee,
		a.BranchOfficeId,
		COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
		ac.HTML_Colour,
		a.AppointmentGroupId,
		a.ProjectAppointmentId,
		Case
			When a.ManuallyMarkWorkDone = 1 Then
				1
			When IsNull(qe.EmployeeId, 0) > 0 And a.AppointmentTypeId = 8 Then
				1
			Else
				Cast((Select Count(*) From JobEmployeeAppointment Where AppointmentID = a.AppointmentID) as bit)
		End AS MobileDataReturned,
	    CASE WHEN (
					SELECT 
	                    Count(*) 
					FROM 
	                    JobEmployeeAppointment 
						left OUTER JOIN [dbo].[JobEmployee] sje ON [sje].[JobEmployeeID] = [JobEmployeeAppointment].[JobEmployeeID] 
					WHERE 
	                    [sje].[JobID] = [j].[JobID]
				)>0 THEN
			1
		ELSE
	        0
	    END MobileDataReturnedOutsideOfScope,
		Case
			When a.ManuallyMarkWorkDone = 1 Then
				1
		ELSE
			CASE a.AppointmentTypeID
				WHEN 1 THEN (Select COUNT(*) FROM Register r INNER JOIN JobEmployee je ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
				WHEN 3 THEN (Select COUNT(*) FROM AirTest at INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
				--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
			END
		END MobileData,
		Cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL AND Cast(Created as date) = Cast(a.StartTime as date)) as bit) AS NoAccess,
		cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL) as bit) AS noAccessOutsideOfScope,
		DateDeclined,
		at.AppointmentTypeId,
		tt.TrainingType
	From
		Appointment a
		Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
		Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
		LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
		Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
		Left Outer Join Client c On a.ClientID = c.ClientID
		Left Outer Join Site s On s.SiteID = a.SiteID
		Left Outer Join Project p On p.ProjectID = a.ProjectID
		Left Outer Join Quote q On q.QuoteID = a.QuoteID
		Left Outer JOin QuoteEmployee qe On qe.QuoteId = q.QuoteId
		Left Outer Join Job j On j.JobID = q.JobID
		Left Outer Join AppointmentEmployee ae On ae.AppointmentID = a.AppointmentID
		Left Outer Join Employee e On ae.EmployeeID = e.EmployeeID
	Where
		ProjectAppointmentId Is Null
			AND
		a.AppointmentID=@AppointmentID
			AND
		(j.JobID = @JobID OR @JobID = 0)
			AND
		a.DateDeclined Is Null 
	Union

	-- Project site appointments.
	Select
		DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
		DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
		DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
		DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)) as Duration,
		a.StartTime, 
		a.EndTime,
		(Select Min(AppointmentID) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentID,
		--a.AppointmentID,
		IsNull(at.AppointmentType, '') As AppointmentType,
		c.ClientID,
		IsNull(c.Client, '') as Client,
			p.ProjectID,
		IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
		s.SiteID,
		Cast(Count(*) as varchar(10)) + ' Sites in total' as Site,
		Project as Address,
		s.Postcode,
		s.UPRN,
		Null as JobId,
		Null as JobNo,
		--	a.ClientOrderNo,
		a.Cost,
		(Select Min(DateConfirmed) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as DateConfirmed,
	--	cast(a.Notes as varchar(max)) Notes,
		0 as CalendarFileID,
		e.EmployeeID, 
		e.FullName as Employee,
		a.BranchOfficeId,
		COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
		ac.HTML_Colour,	
		(Select Min(AppointmentGroupId) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentGroupId,
		a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- ignore for project appointments, instead rely on returned jobs below.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	0 AS NoAccess,-- ignore for project appointments, instead rely on returned jobs below.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	Outer Apply
	(
		Select Top 1 SiteId From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null)) Order By DateCreated
	) as ProjectAppointmentSite
	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = ProjectAppointmentSite.SiteId
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join AppointmentEmployee ae On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e On ae.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	a.AppointmentID=@AppointmentID
		AND
	a.DateDeclined Is Null 
Group By
 	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime), 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)), 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime),
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)),
	a.StartTime, 
	a.EndTime,
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	ISNULL(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.Postcode,
	s.UPRN,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType

Union

-- Completed Project Site Jobs
Select
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime) as OffsetStart, 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime) as OffsetEnd,
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)) as Duration,
	jea.StartTime, 
	jea.EndTime,
--	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	a.AppointmentId,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	1 AS MobileDataReturned,-- Always true for returned jobs.
    0 AS MobileDataReturnedOutsideOfScope,
    CASE a.AppointmentTypeID
		WHEN 1 THEN (Select COUNT(*) FROM Register r INNER JOIN JobEmployee je ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		WHEN 3 THEN (Select COUNT(*) FROM AirTest at INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
    END MobileData,
	Cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL And Cast(Created as date) = Cast(jea.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL) as bit) AS noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	INNER JOIN Quote q ON a.QuoteID=q.QuoteID
	Inner Join JobEmployeeAppointment jea On a.AppointmentID = jea.AppointmentID
	Inner Join JobEmployee je On jea.JobEmployeeID = je.JobEmployeeID
	Inner Join Job j On je.JobID = j.JobId

	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = j.SiteID
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join Employee e On je.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	a.AppointmentID=@AppointmentID
		AND
	(j.JobID = @JobID OR @JobID = 0)
		AND
	a.DateDeclined Is Null 
Group By
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime), 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)), 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime),
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)),
	jea.StartTime, 
	jea.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
	q.JobID,
	a.AppointmentTypeID,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType

Union

-- No Access Project Site Jobs
Select
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created) as OffsetStart, 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)) as Days, 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created) as OffsetEnd,
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)) as Duration,
	na.Created as StartTime, 
	na.Created as EndTime,
	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- Never true since this section is only for things that have no JEA record!.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	1 AS NoAccess,-- Always true, this is no access query.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	Inner Join Quote q On a.QuoteID = q.QuoteID
	Inner Join Job j On q.JobID = j.JobID
	Inner Join NoAccess na On q.JobID = na.JobID

	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = j.SiteID
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join Employee e On na.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	(Select COUNT(*) FROM Appointment Inner Join JobEmployeeAppointment jea On Appointment.AppointmentID = jea.AppointmentID Where Appointment.AppointmentID=a.AppointmentID)=0
	AND
	a.AppointmentID=@AppointmentID
		AND
	(j.JobID = @JobID OR @JobID = 0)
		AND
	a.DateDeclined Is Null 
Group By
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created), 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)), 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created),
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)),
	na.Created, 
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType) Main
	Outer Apply
    (
        Select
            Min(StartTime) as StartTime,
            Max(EndTime) as EndTime
        From
            Appointment
        Where
            AppointmentGroupId = Main.AppointmentGroupId
               And
			DateDeclined Is Null
    ) AppointmentGroup 
    OUTER APPLY
    (
        Select 
            app.AppointmentID, 
            dbo.Ellipsis(IsNull(q.ScopeOfWork, ''), 50) as ScopeOfWork, 
            dbo.Ellipsis(IsNull(q.Exclusions, ''), 50) as Exclusions, 
            dbo.Ellipsis(IsNull(Notes, ''), 500) as Notes 
        From 
            Appointment app  
            Left Outer Join Quote q on app.QuoteId = q.QuoteId 
        Where
			app.AppointmentId = Main.AppointmentId 
    ) q 
    Left Outer Join AppointmentSurvey s On Main.AppointmentId = s.AppointmentId 
    Left Outer Join SurveyType t On s.SurveyTypeId = t.SurveyTypeId 
    Left Outer Join branchoffice apBranch On apBranch.branchofficeid = Main.branchofficeid 
	
	SET NOCOUNT OFF;
END

GO

-- MobileDtcIdMap table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='MobileDtcIdMap'))
	BEGIN
		CREATE TABLE [dbo].[MobileDtcIdMap](
			[MobileDtcIdMapId] [int] IDENTITY(1,1) NOT NULL,
			[SystemName] [varchar](50) NOT NULL,
			[DateCreated] [datetime] NOT NULL,
			[TableName] [varchar](50) NOT NULL,
			[MobileId] [int] NOT NULL,
			[ServerId] [int] NOT NULL,
		 CONSTRAINT [PK_MobileDtcIdMap_MobileDtcIdMapId] PRIMARY KEY CLUSTERED 
		(
			[MobileDtcIdMapId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type IN ('FN', 'IF', 'TF', 'FS', 'FT') AND name = 'fn_getSampleClassifcationExtendedPointsID')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[fn_getSampleClassifcationExtendedPointsID]() RETURNS VARCHAR(MAX) AS BEGIN RETURN '''' END')
END
GO

-- =============================================
-- Author:      Adam
-- Create date: 20 Jan 2012
-- Description: Returns the SampleClassificationExtendedPointsID of a Sample Classification.
-- =============================================
ALTER FUNCTION [dbo].[fn_getSampleClassifcationExtendedPointsID]
(
    @SampleID INT
)
RETURNS INT
AS
BEGIN

    DECLARE @ResultVar INT

    DECLARE
        @iSampleClassifcationExtendedID INT,
        @iSampleClassifcationExtendedPointsID INT

    SET @iSampleClassifcationExtendedID = (SELECT COALESCE(
        (SELECT SampleClassificationExtendedID FROM Sample WITH (NOLOCK) WHERE SampleID = @SampleID),
        (SELECT ISNULL(sce.SampleClassificationExtendedID, 0) FROM SampleClassificationExtended sce WITH (NOLOCK) RIGHT JOIN Element e WITH (NOLOCK) ON sce.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID WHERE e.ElementTypeID = 6 AND NULLIF(e.ElementIntMeaningExtendedID, 0) IS NOT NULL AND e.SampleID = @SampleID),
        (SELECT ISNULL(sce.SampleClassificationExtendedID, 0) FROM SampleClassificationExtended sce WITH (NOLOCK) RIGHT JOIN Element e WITH (NOLOCK) ON sce.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID WHERE e.ElementTypeID = 6 AND NULLIF(e.ElementIntMeaningSubOptionID, 0) IS NOT NULL AND e.SampleID = @SampleID),
        (SELECT TOP 1 sce.SampleClassificationExtendedID FROM Element e WITH (NOLOCK) INNER JOIN SampleClassification sc WITH (NOLOCK) ON e.ElementIntID = sc.Score INNER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sc.SampleClassificationID = sce.SampleClassificationID WHERE e.ElementTypeID = 6 AND e.SampleID = @SampleID),
        0)
    )
    SET @iSampleClassifcationExtendedPointsID = ISNULL((SELECT SampleClassificationExtendedPointsID FROM Sample WITH (NOLOCK) WHERE SampleID = @SampleID), 0)

    IF @iSampleClassifcationExtendedPointsID > 0
    BEGIN
        SET @ResultVar = @iSampleClassifcationExtendedPointsID
    END
    ELSE
    BEGIN
        SET @ResultVar = (
            SELECT TOP 1 scep.SampleClassificationExtendedPointsID
            FROM
                SampleClassificationExtendedPoints scep WITH (NOLOCK)
                LEFT JOIN SampleClassificationExtended sce WITH (NOLOCK) ON scep.SampleClassificationExtendedID = sce.SampleClassificationExtendedID
            WHERE
                scep.SampleClassificationExtendedID = @iSampleClassifcationExtendedID                    
        )
    END

    RETURN ISNULL(@ResultVar, 0)
END
GO

IF NOT EXISTS(select * FROM sys.views where name = 'QuoteHistory')
BEGIN
    EXEC('CREATE VIEW [dbo].[QuoteHistory] AS SELECT 0 [ItemId]')
END
GO

EXEC('ALTER VIEW [dbo].[QuoteHistory]
As

Select 
	q.QuoteID as ItemId,
	''Q'' as ItemType,
	q.QuoteNo as ItemNo,
	qt.QuoteTypeId,
	IsNull(qt.quotetype, '''') as QuoteType,
	qHistory.QuoteHistoryValue as Value,
	q.Created,
	q.Status,
	q.LastNoteCreated, 
	c.ClientId,
	c.Client + Case When Len(c.BranchName) > 0 Then '' ('' + c.BranchName + '')'' Else '''' End AS Client, 
	p.ProjectId,
    p.Project + '' / '' + ISNULL([p].[GroupName],'''') [Project],
	s.SiteId,
	s.Address AS Site, 	
    [s].[Address],
    [s].[Postcode],
    [s].[UPRN],
	q.Accepted,
	q.Rejected,
	Cast(Case When ABS(DateDiff(d, j.created, q.created)) = 0 Then
			Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 
				1 
			Else 
				0 
			End
		Else
			0
		End as bit) AS IsInstaQuote,
	q.AssignedEmployeeId,
    /*Joe B changes*/
	CASE WHEN Rejected IS NOT NULL THEN 
		''Rejected''
	ELSE
		''Accepted''
	END ''StatusText'',
	CASE WHEN q.Created > DATEADD(hh,-1,GetDate()) THEN
		1
	ELSE
		0
	END ''isNew'',
	CASE WHEN Accepted IS NOT NULL THEN
		Accepted
	ELSE
		Rejected
	END ''DateActioned'',
	CASE WHEN PDFId is not null then 
		1
	else
		0
	end ''HasPDF'',
	pdf.FileName ''File'',
	j.JobID
    /*end Joe B changes*/
    --NULL,
    --NULL,
    --null
    
From
	Quote q 
	Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
	Left Outer Join Job j On q.JobId = j.JobId
	Left Outer Join Client c On c.ClientID = q.ClientID 
	Left Outer Join Project p On p.ProjectID = q.ProjectID 
	Left Outer Join Site s On s.SiteID = q.SiteID
	
	OUTER APPLY
	(
		Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
	) qHistory
    outer APPLY
    (
        SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null order BY [Pdf].[DateCreated] DESC    
    )pdf(PDFId,filename)
    
    
Where 
	(Not Accepted Is Null Or Not Rejected Is Null) 

Union

Select
	EnquiryId,
	''E'' as ItemType,
	EnquiryNo,
	QuoteTypeId,
	QuoteType,
	Null as Value,
	Created,
	''Q'' + Right(''00000''+ Cast(QuoteNo as varchar), Case When Len(QuoteNo)<=6 Then 6 Else Len(QuoteNo) End) as Status,
	LastNoteCreated,
	ClientId,
	Client + Case When Len(ClientBranchName) > 0 Then '' ('' + ClientBranchName + '')'' Else '''' End as Client, 
	Null AS ProjectId,
    NULL AS Project,
	SiteId,
	SiteAddress AS Site, 	
    [SiteAddress] address ,
    sitepostcode,
    siteuprn,
	Accepted,
	Rejected,
	0 AS IsInstaQuote,
	AssignedEmployeeId,
    /*Joe B changes*/
	CASE WHEN Rejected IS NOT NULL THEN 
		''Discarded''
	ELSE
		''Quoted''
	END ''StatusText'',
	CASE WHEN Created > DATEADD(hh,-1,GetDate()) THEN
		1
	ELSE
		0
	END ''isNew'',
	CASE WHEN Accepted IS NOT NULL THEN
		Accepted
	ELSE
		Rejected
	END ''DateActioned'',
    NULL [HasPDF],
    NULL [File],
    NULL [JobID]
    /*end Joe B changes*/
    --NULL,
    --NULL,
    --null
    
From
	Enquiries
Where
	(Not Accepted Is Null Or Not Rejected Is Null) 
		And
	(
		Not QuoteId Is Null
			Or
		(
			QuoteId Is Null
				And
			Not Rejected Is Null
		)
	)

UNION

--quote visti appointments declined
Select 
	q.QuoteID as ItemId,
	''RQV'' as ItemType,
	q.QuoteNo AS ItemNo,
	qt.QuoteTypeId,
	''Quote Visit '' + IsNull(qt.quotetype, '''') as QuoteType,
	qHistory.QuoteHistoryValue as Value,
	q.Created,
	q.Status,
	q.LastNoteCreated, 
	c.ClientId,
	c.Client + Case When Len(c.BranchName) > 0 Then '' ('' + c.BranchName + '')'' Else '''' End AS Client, 
	p.ProjectId,
    p.Project + '' / '' + ISNULL([p].[GroupName],'''') [Project],
	s.SiteId,
	s.Address AS Site, 	
    [s].[Address],
    [s].[Postcode],
    [s].[UPRN],
	q.Accepted,
	AppCounts.lastDeclinedDate [Rejected],
	Cast(Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End as bit) AS IsInstaQuote,
	q.AssignedEmployeeId,
    /*Joe B changes*/
	''Discarded'' as ''StatusText'',
	CASE WHEN q.Created > DATEADD(hh,-1,GetDate()) THEN
		1
	ELSE
		0
	END ''isNew'',
	AppCounts.lastDeclinedDate as ''DateActioned'',
    NULL [HasPDF],
    NULL [File],
    NULL [JobID]
    /*end Joe B changes*/
    --[AppCounts].[declinedAppCount],
    --[AppCounts].[lastDeclinedDate],
    --[AppCounts].[nonDeclinedOrOpen]

FROM
	Quote q 
    INNER JOIN [dbo].[QuoteEmployee] qe ON qe.[QuoteID] = [q].[QuoteID]
    INNER JOIN [dbo].[QuoteVisit] qv ON qe.[QuoteEmployeeID] = [qv].[QuoteEmployeeID]   
    Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
    OUTER APPLY 
    (
        /*count declined appointments and non declineds, if they have */
        SELECT
            sum(CASE WHEN _app.[DateDeclined] IS not NULL THEN 1 ELSE 0 END),
            sum(CASE WHEN _app.[DateDeclined] IS NULL THEN 1 ELSE 0 END),
            MAX(_app.[DateDeclined])
        FROM
            [dbo].[Appointment] _app 
        WHERE
            _app.[QuoteID] = [q].[QuoteID]
        GROUP BY [_app].[QuoteID]
        
    )AppCounts(declinedAppCount,nonDeclinedOrOpen,lastDeclinedDate)
    
    
	Left Outer Join Job j On q.JobId = j.JobId
	Left Outer Join Client c On c.ClientID = q.ClientID 
	Left Outer Join Project p On p.ProjectID = q.ProjectID 
	Left Outer Join Site s On s.SiteID = q.SiteID 
	OUTER APPLY
	(
		Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.Value) [QuoteHistoryValue]
	) qHistory
Where 
	(AppCounts.lastDeclinedDate IS not NULL) AND
    ([AppCounts].[declinedAppCount]>0 AND [AppCounts].[nonDeclinedOrOpen]=0)
')
GO

-- Update 'Management survey with part Refurbishment (MA only)' to be the correct SurveyTypeGroupID.
UPDATE SurveyType
SET SurveyTypeGroupID = 8
WHERE SurveyTypeID = 59
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMSStoreCheck')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMSStoreCheck] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMSStoreCheck]
    @JobID INT

AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;

SELECT TOP 1
	main.*
FROM
	(
		SELECT TOP 1
			P.PhotoID
		FROM
			Job j
			INNER JOIN JobEmployee je ON j.JobID = je.JobID
			INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
			INNER JOIN Photo p ON r.PhotoID = p.PhotoID AND p.TEAMS_StoreID IS NOT NULL
		WHERE
			j.JobID = @JobID
		
		UNION

		SELECT TOP 1
			p.PhotoID
		FROM
			Job j
			INNER JOIN JobEmployee je ON j.JobID = je.JobID
			INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
			INNER JOIN Room rm ON r.RegisterID = rm.RegisterID
			INNER JOIN Sample s ON rm.RoomID = s.RoomID
			INNER JOIN Photo p ON s.PhotoID = p.PhotoID AND p.TEAMS_StoreID IS NOT NULL
		WHERE
			j.JobID = @JobID
	) main    

    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Store_TransferSurveyDataToServer')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_Store_TransferSurveyDataToServer] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMS_Store_TransferSurveyDataToServer](@JobID int)
AS
BEGIN 
	SET NOCOUNT ON;

	DECLARE @PhotoDetail TABLE (PhotoID INT, TEAMS_StoreID INT, HasData INT)
	Insert into @PhotoDetail (PhotoID,TEAMS_StoreID,HasData)
	SELECT 
        p.PhotoID,p.TEAMS_StoreID,CASE WHEN p.PhotoData IS NOT NULL THEN 1 ELSE 0 END
    FROM 
        (
            Select
                j.JobID,j.Approved
            FROM
                TEAMS.dbo.Job j
            WHERE
                    j.JobID=@JobID
        ) j
        INNER JOIN JobEmployee je ON je.JobID = j.JobID 
        INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
        INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
        INNER JOIN Sample s ON s.RoomID = rm.RoomID
        INNER JOIN Photo p ON p.PhotoID = s.PhotoID OR p.PhotoID=r.PhotoID
	
	UPDATE Photo Set 
		TEAMS_StoreID=NULL,
		PhotoData=u.PhotoData
	FROM
		Photo
		INNER JOIN
		(
			Select 
				pd.PhotoID,
				p.PhotoData
			FROM
				@PhotoDetail pd
				INNER JOIN TEAMS_Store1.dbo.Photo p ON pd.PhotoID=p.PhotoID AND pd.TEAMS_StoreID=1
			/*UNION ALL
			Select 
				pd.PhotoID,
				p.PhotoData
			FROM
				@PhotoDetail pd
				INNER JOIN TEAMS_Store2.dbo.Photo p ON pd.PhotoID=p.PhotoID AND pd.TEAMS_StoreID=2*/
		) u ON Photo.PhotoID=u.PhotoID
	
	DECLARE @FloorplanDetail TABLE (Approved DATETIME, FloorplanID INT, TEAMS_StoreID INT, HasData BIT)
    Insert into @FloorplanDetail (Approved, FloorplanID, TEAMS_StoreID, HasData)
    SELECT 
        j.Approved,fp.FloorplanID,fp.TEAMS_StoreID,MAX(CASE WHEN fp.FloorplanData IS NOT NULL OR fp.saveFloorplanImagedata IS NOT NULL OR fp.AutocadData IS NOT NULL THEN 1 ELSE 0 END)
    FROM 
        (
            Select
                j.JobID,j.Approved
            FROM
                TEAMS.dbo.Job j
            WHERE
                j.JobID=@JobID
        ) j
        INNER JOIN TEAMS.dbo.JobEmployee je ON je.JobID = j.JobID
        INNER JOIN TEAMS.dbo.Register r ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN TEAMS.dbo.Floorplan fp ON fp.RegisterID = r.RegisterID
    GROUP BY
        j.Approved,fp.FloorplanID,fp.TEAMS_StoreID
        
    Update Floorplan Set 
		TEAMS_StoreID=NULL
		,FloorplanData=CASE WHEN u.FloorplanData IS NOT NULL THEN u.FloorplanData ELSE NULL END
		,AutocadData=CASE WHEN u.AutocadData IS NOT NULL THEN u.AutocadData ELSE NULL END
		,saveFloorplanImagedata=CASE WHEN u.saveFloorplanImagedata IS NOT NULL THEN u.saveFloorplanImagedata ELSE NULL END
	FROM
		Floorplan
		INNER JOIN
		(
			Select 
				fd.FloorplanID,
				fp.FloorplanData,
				fp.AutocadData,
				fp.saveFloorplanImagedata
			FROM
				@FloorplanDetail fd
				INNER JOIN TEAMS_Store1.dbo.Floorplan fp ON fd.FloorplanID=fp.FloorplanID AND fd.TEAMS_StoreID=1
			/*UNION ALL
			Select 
				fd.FloorplanID,
				fp.FloorplanData,
				fp.AutocadData,
				fp.saveFloorplanImagedata
			FROM
				@FloorplanDetail fd
				INNER JOIN TEAMS_Store2.dbo.Floorplan fp ON fd.FloorplanID=fp.FloorplanID AND fd.TEAMS_StoreID=2*/
		) u ON Floorplan.FloorplanID=u.FloorplanID

	SET NOCOUNT OFF;
END 

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'FN' AND name = 'FloorNameToNumber')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[FloorNameToNumber] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER FUNCTION [dbo].[FloorNameToNumber](@FloorName VARCHAR(50))
RETURNS INT
WITH EXECUTE AS CALLER
AS
BEGIN

            SELECT @FloorName =UPPER(@FloorName)
      
      IF @FloorName ='ROOF VOID'
      BEGIN
            RETURN 999
      END
      
      IF @FloorName ='MEZZANINE'
      BEGIN
            RETURN 998
      END
      
      IF @FloorName ='LIFT SHAFT'
      BEGIN
            RETURN 997
      END
      
      IF @FloorName ='EXTERNAL'
      BEGIN
            RETURN-999
      END
      
      IF @FloorName ='GROUND FLOOR'
      BEGIN
            RETURN 0
      END
      
      IF @FloorName ='1ST FLOOR'
      BEGIN
            RETURN 1
      END
      
      IF @FloorName ='2ND FLOOR'
      BEGIN
            RETURN 2
      END
      
      IF @FloorName ='3RD FLOOR'
      BEGIN
            RETURN 3
      END
      
      IF LEFT(@FloorName, 11)='Z-SUB LEVEL'
      BEGIN
            RETURN CONVERT(INT,'-'+SUBSTRING(@FloorName, 13, 2))
      END
      
      IF LEFT(@FloorName, 8)='BASEMENT'
      BEGIN
            RETURN CONVERT(INT,'-'+SUBSTRING(@FloorName, 10, 2))
      END
    
      IF RIGHT(@FloorName, 8)='TH FLOOR'
      BEGIN
            RETURN CONVERT(INT,SUBSTRING(@FloorName, 1,LEN(@FloorName)- 8))
      END
      
      IF RIGHT(@FloorName, 8)='RD FLOOR'
      BEGIN
            RETURN CONVERT(INT,SUBSTRING(@FloorName, 1,LEN(@FloorName)- 8))
      END
            
      IF RIGHT(@FloorName, 8)='ND FLOOR'
      BEGIN
            RETURN CONVERT(INT,SUBSTRING(@FloorName, 1,LEN(@FloorName)- 8))
      END
      
      IF RIGHT(@FloorName, 8)='RD FLOOR'
      BEGIN
            RETURN CONVERT(INT,SUBSTRING(@FloorName, 1,LEN(@FloorName)- 8))
      END
      
    IF @FloorName ='1st Custom Floor'
      Begin
            Return 980
      End
      
      IF @FloorName ='2nd Custom Floor'
      Begin
            Return 981
      End
      
      IF @FloorName ='3rd Custom Floor'
      Begin
            Return 982
      End
      
      IF @FloorName ='4th Custom Floor'
      Begin
            Return 983
      End
      
      IF @FloorName ='5st Custom Floor'
      Begin
            Return 984
      End
      
      IF @FloorName ='6th Custom Floor'
      Begin
            Return 985
      End
      
      
      -- Shouldn't ever hit here.
      RETURN'Error'
END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'ReinspectionCheck_Failed_JobList')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[ReinspectionCheck_Failed_JobList] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER  PROCEDURE [dbo].[ReinspectionCheck_Failed_JobList](@ClientID int, @SiteID int, @JobID int, @AppointmentID int)
AS
BEGIN
       -- Created by Stephen Todd 17/2/11

       -- NOTES :-
       -- This function tells you if an action can't be performed against a job because there is a newer
       -- reinspection survey booked which would invalidate changing an older version of that survey.  The
       -- newer job only needs to be created as an appointment to invalidate changing an existing survey.
       
       -- Reinspections are classified as another survey of any type under the same combination of client
       -- and site.  At time of writing (02/2011), the following scenarios need to be validated :-
       
       -- 1) Creating a supplementary report if there is a newer job (pass in ClientID, SiteID while JobID is null)
       -- 2) Unapproving an approved report if there is a newer job (pass in ClientID, SiteID while JobID is null)
       -- 3) Booking a new appointment if there is an older unapproved report (pass in JobID while ClientID and SiteID are null)
       
       -- Returning 1 is ok, returning 0 is fail
       
       
       Declare @AppointmentGroupID Int= 0
       Select @AppointmentGroupID = AppointmentGroupID From Appointment Where AppointmentID = @AppointmentID
       
       If @JobID is null
       Begin
       
              -- We are checking a new appointment, ensure all other jobs for this site and client are completed

                     SELECT distinct
                           dbo.[FormatTeamsReference]('J',j.jobno) [JobNo]
                     FROM
                           Job j
                           LEFT JOIN JobEmployee je ON je.JobID = j.JobID
                           LEFT JOIN Register reg ON reg.JobEmployeeID = je.JobEmployeeID AND reg.DateApproved IS NULL
                           INNER JOIN Quote q ON q.JobID = j.JobID
                           INNER JOIN Appointment a ON a.QuoteID = q.QuoteID
                           INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID   -- This join required to ensure it's a survey
                     WHERE
                           j.ClientID = @ClientID
                                  AND
                           j.SiteID = @SiteID
                                  AND
                           (
                                  j.Approved IS NULL
                                         OR
                                  reg.RegisterID IS NOT NULL
                           )
                                  AND
                           j.Cancelled is null
                                  AND
                           a.DateDeclined is null
                                  AND
                           a.ManuallyMarkWorkDone = 0
                                  AND
                  isnull(a.AppointmentGroupID,-1)<> @AppointmentGroupID


       
       End
       Else
       Begin
       
              -- We are checking an existing job, ensure there isn't a newer reinspection survey job on the system for this site and client
              SELECT @ClientID = ClientID FROM Job WHERE JobID = @JobID
              SELECT @SiteID = SiteID FROM Job WHERE JobID = @JobID
              DECLARE @CurrentJobCreated datetime
              SELECT @CurrentJobCreated = Created FROM Job WHERE JobID = @JobID
              

                     SELECT distinct
                           dbo.[FormatTeamsReference]('J',j.jobno) [JobNo]
                     FROM
                           Job j
                           INNER JOIN Quote q ON q.JobID = j.JobID
                           INNER JOIN Appointment a ON a.QuoteID = q.QuoteID
                           INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID   -- This join required to ensure it's a survey
                     WHERE
                           j.ClientID = @ClientID
                                  AND
                           j.SiteID = @SiteID
                                  AND
                           j.Created > @CurrentJobCreated
                                  AND
                           j.Cancelled is null
                                  AND
                           a.DateDeclined is null
                                  AND
                           a.ManuallyMarkWorkDone = 0
                                  AND
                           asu.SurveyTypeID IN(
                                        3,
                                        13,
                                        14,
                                        15,
                                        32,
                                        39,
                                        56
                                    )

       
       End
       
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'FN' AND name = 'ReinspectionCheck')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[ReinspectionCheck] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER FUNCTION [dbo].[ReinspectionCheck] (@ClientID int, @SiteID int, @JobID int, @AppointmentID int)
RETURNS bit
WITH EXECUTE AS CALLER
AS
BEGIN

	-- Created by Stephen Todd 17/2/11

	-- NOTES :-
	-- This function tells you if an action can't be performed against a job because there is a newer
	-- reinspection survey booked which would invalidate changing an older version of that survey.  The
	-- newer job only needs to be created as an appointment to invalidate changing an existing survey.
	
	-- Reinspections are classified as another survey of any type under the same combination of client
	-- and site.  At time of writing (02/2011), the following scenarios need to be validated :-
	
	-- 1) Creating a supplementary report if there is a newer job (pass in ClientID, SiteID while JobID is null)
	-- 2) Unapproving an approved report if there is a newer job (pass in ClientID, SiteID while JobID is null)
	-- 3) Booking a new appointment if there is an older unapproved report (pass in JobID while ClientID and SiteID are null)
	
	-- Returning 1 is ok, returning 0 is fail
	
	
	Declare @AppointmentGroupID Int = 0
	Select @AppointmentGroupID = AppointmentGroupID From Appointment Where AppointmentID = @AppointmentID
	
	If @JobID is null
	Begin
	
		IF @SiteID IS NULL OR @ClientID IS NULL
		BEGIN
		
			-- Safety precaution - ensure both the ClientID and SiteID are supplied, else assume it fails
			Return 0
		
		END
	
		-- We are checking a new appointment, ensure all other jobs for this site and client are completed
		IF EXISTS (
			SELECT
				*
			FROM
				Job j
				LEFT JOIN JobEmployee je ON je.JobID = j.JobID
				LEFT JOIN Register reg ON reg.JobEmployeeID = je.JobEmployeeID AND reg.DateApproved IS NULL
				INNER JOIN Quote q ON q.JobID = j.JobID
				INNER JOIN Appointment a ON a.QuoteID = q.QuoteID
				INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID   -- This join required to ensure it's a survey
			WHERE
				j.ClientID = @ClientID
					AND
				j.SiteID = @SiteID
					AND
				(
					j.Approved IS NULL
						OR
					reg.RegisterID IS NOT NULL
				)
					AND
				j.Cancelled is null
					AND
				a.DateDeclined is null
					AND
				a.ManuallyMarkWorkDone = 0
					AND
    		    isnull(a.AppointmentGroupID,-1) <> @AppointmentGroupID
		)
		BEGIN
			RETURN 0
		END
	
	End
	Else
	Begin
	
		-- We are checking an existing job, ensure there isn't a newer reinspection survey job on the system for this site and client
		SELECT @ClientID = ClientID FROM Job WHERE JobID = @JobID
		SELECT @SiteID = SiteID FROM Job WHERE JobID = @JobID
		DECLARE @CurrentJobCreated datetime
		SELECT @CurrentJobCreated = Created FROM Job WHERE JobID = @JobID
		
		IF EXISTS (
			SELECT
				1
			FROM
				Job j
				INNER JOIN Quote q ON q.JobID = j.JobID
				INNER JOIN Appointment a ON a.QuoteID = q.QuoteID
				INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID   -- This join required to ensure it's a survey
			WHERE
				j.ClientID = @ClientID
					AND
				j.SiteID = @SiteID
					AND
				j.Created > @CurrentJobCreated
					AND
				j.Cancelled is null
					AND
				a.DateDeclined is null
					AND
				a.ManuallyMarkWorkDone = 0
					AND
				asu.SurveyTypeID IN (
                                        3,
                                        13,
                                        14,
                                        15,
                                        32,
                                        39,
                                        56
                                    )
		)
		BEGIN
			RETURN 0
		END
	
	End
	
	-- Passes ok
	RETURN 1
	
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ClientNote' AND OBJECT_ID = OBJECT_ID('Client'))
BEGIN
	ALTER TABLE [dbo].[Client]
	ADD [ClientNote] [varchar] (200) NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.key_constraints WHERE parent_object_id = OBJECT_ID('AppointmentAttachment') AND name = 'PK_AppointmentAttachment')
BEGIN
    ALTER TABLE AppointmentAttachment
    ADD CONSTRAINT PK_AppointmentAttachment PRIMARY KEY CLUSTERED 
    (
        [AppointmentAttachmentId] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='PhotoCollectionAutoInsert'))
	BEGIN
		CREATE TABLE [dbo].[PhotoCollectionAutoInsert] (
		  [PhotoCollectionAutoInsertID] [int] IDENTITY (1, 1) NOT NULL,
		  [AirTestDataCollectionQuestionID] [int] NULL,
		  [AirTestResultID] [int] NULL,
		  [LegionellaAssetOutletDataCollectionID] [int] NULL,
		  [Caption] [varchar] (MAX) NULL,
		  [Description] [varchar] (MAX) NULL,
		  [SortOrder] [int] NOT NULL CONSTRAINT [DF__PhotoColl__SortO__3AF91678] DEFAULT (0),
		  CONSTRAINT [PK_PhotoCollectionAutoInsertID]
		  PRIMARY KEY CLUSTERED
		  (
			[PhotoCollectionAutoInsertID] ASC
		  )
		  WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		  ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

/* BEGIN CUSTOM REPORT AUTOMATION */

-- 1. Config.
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__EnableCustomReportAutomation' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__EnableCustomReportAutomation BIT NOT NULL DEFAULT 0
END
GO

-- 2. Database tables.
IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'aeInstructionCustomReport')
BEGIN
    CREATE TABLE [dbo].[aeInstructionCustomReport](
	    [aeInstructionCustomReportID] [int] IDENTITY(1,1) NOT NULL,
	    [CustomReportID] [int] NOT NULL,
	    [aeInstructionID] [int] NOT NULL,
	    [Description] [varchar](50) NOT NULL,
	    [Deleted] [datetime] NULL,
     CONSTRAINT [PK_aeInstructionCustomReport] PRIMARY KEY CLUSTERED 
    (
	    [aeInstructionCustomReportID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]
END
GO

IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'aeInstructionCustomReportEmployee')
BEGIN
    CREATE TABLE [dbo].[aeInstructionCustomReportEmployee](
        [aeInstructionCustomReportEmployeeID] [int] IDENTITY(1,1) NOT NULL,
        [aeInstructionCustomReportID] [int] NOT NULL,
        [EmployeeID] [int] NOT NULL,
     CONSTRAINT [PK_aeInstructionCustomReportEmployee] PRIMARY KEY CLUSTERED 
    (
        [aeInstructionCustomReportEmployeeID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]

    EXEC('ALTER TABLE [dbo].[aeInstructionCustomReportEmployee]  WITH CHECK ADD  CONSTRAINT [FK_aeInstructionCustomReportFromEmployee] FOREIGN KEY([aeInstructionCustomReportID])
    REFERENCES [dbo].[aeInstructionCustomReport] ([aeInstructionCustomReportID])

    ALTER TABLE [dbo].[aeInstructionCustomReportEmployee] CHECK CONSTRAINT [FK_aeInstructionCustomReportFromEmployee]')
END
GO

IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'aeInstructionCustomReportParameter')
BEGIN
    CREATE TABLE [dbo].[aeInstructionCustomReportParameter](
	    [aeInstructionCustomReportParameterID] [int] IDENTITY(1,1) NOT NULL,
	    [aeInstructionCustomReportID] [int] NOT NULL,
	    [CustomReportParameterID] [int] NOT NULL,
     CONSTRAINT [PK_aeInstructionCustomReportParameter] PRIMARY KEY CLUSTERED 
    (
	    [aeInstructionCustomReportParameterID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]

    EXEC('ALTER TABLE [dbo].[aeInstructionCustomReportParameter]  WITH CHECK ADD  CONSTRAINT [FK_aeInstructionCustomReportFromParameter] FOREIGN KEY([aeInstructionCustomReportID])
    REFERENCES [dbo].[aeInstructionCustomReport] ([aeInstructionCustomReportID])

    ALTER TABLE [dbo].[aeInstructionCustomReportParameter] CHECK CONSTRAINT [FK_aeInstructionCustomReportFromParameter]')
END
GO

IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'aeInstructionCustomReportParameterData')
BEGIN
    CREATE TABLE [dbo].[aeInstructionCustomReportParameterData](
	    [aeInstructionCustomReportParameterDataID] [int] IDENTITY(1,1) NOT NULL,
	    [aeInstructionCustomReportParameterID] [int] NOT NULL,
	    [DataInt] [int] NULL,
	    [DataBool] [bit] NULL,
	    [DataString] [varchar](1000) NULL,
     CONSTRAINT [PK_aeInstructionCustomReportParameterData] PRIMARY KEY CLUSTERED 
    (
	    [aeInstructionCustomReportParameterDataID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]

    EXEC('ALTER TABLE [dbo].[aeInstructionCustomReportParameterData]  WITH CHECK ADD  CONSTRAINT [FK_aeInstructionCustomReportParameterFromParameterData] FOREIGN KEY([aeInstructionCustomReportParameterID])
    REFERENCES [dbo].[aeInstructionCustomReportParameter] ([aeInstructionCustomReportParameterID])

    ALTER TABLE [dbo].[aeInstructionCustomReportParameterData] CHECK CONSTRAINT [FK_aeInstructionCustomReportParameterFromParameterData]')
END
GO

IF NOT EXISTS(SELECT * FROM sys.tables WHERE name = 'aeInstructionCustomReportParameterDataOption')
BEGIN
    CREATE TABLE [dbo].[aeInstructionCustomReportParameterDataOption](
	    [aeInstructionCustomReportParameterDataOptionID] [int] IDENTITY(1,1) NOT NULL,
	    [Description] [varchar](50) NOT NULL,
	    [DateAddModifier] [varchar](20) NULL,
	    [DateAddValue] [int] NULL,
	    [ForYear] [bit] NOT NULL,
	    [ForMonth] [bit] NOT NULL,
	    [SortOrder] [int] NOT NULL,
	    [Deleted] [datetime] NULL,
     CONSTRAINT [PK_aeInstructionCustomReportParameterDataOption] PRIMARY KEY CLUSTERED 
    (
	    [aeInstructionCustomReportParameterDataOptionID] ASC
    )WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
    ) ON [PRIMARY]
END
GO

-- Insert into aeInstructionCustomReportParameterDataOption as it's a reference table.
IF NOT EXISTS(SELECT 1 FROM aeInstructionCustomReportParameterDataOption)
BEGIN
    INSERT INTO aeInstructionCustomReportParameterDataOption (Description, DateAddModifier, DateAddValue, ForYear, ForMonth, SortOrder)
    VALUES
        ('1 year ago', 'year', -1, 1, 0, 1),
        ('6 months ago', 'month', -6, 0, 1, 2),
        ('3 months ago', 'month', -3, 0, 1, 3),
        ('1 month ago', 'month', -1, 0, 1, 4),
        ('Start of this month', 'month', NULL, 0, 0, 5),
        ('14 days ago', 'day', -14, 0, 0, 6),
        ('7 days ago', 'day', -7, 0, 0, 7),
        ('Yesterday', 'day', -1, 0, 0, 8),
        ('Today', 'day', 0, 1, 1, 9),
        ('Tomorrow', 'day', 1, 0, 0, 10),
        ('7 days� time', 'day', 7, 0, 0, 11),
        ('14 days� time', 'day', 14, 0, 0, 12),
        ('End of this month', 'month', NULL, 0, 0, 13),
        ('1 months� time', 'month', 1, 0, 1, 14),
        ('3 months� time', 'month', 3, 0, 1, 15),
        ('6 months� time', 'month', 6, 0, 1, 16),
        ('1 years� time', 'year', 1, 1, 0, 17)
END

-- 3. Data grid.
IF NOT EXISTS(SELECT * FROM DataGrid WHERE DataGrid = 'Custom Report Automation')
BEGIN
    INSERT INTO DataGrid (DataGrid, DataGridTable, SQL, PageSize)
    VALUES ('Custom Report Automation', '<table id="{DataGrid}" class="data">      
        <col>            
        <col>      
        <thead>            
            <tr>                
                <th>Description</th>                                
                <th class="radio"></th>            
            </tr>      
        </thead>      
        <tbody>          
            <script type="text/html" class="template">              
                <![CDATA[              
                <tr>                  
                    <td><!= this.Description !></td>                                                      
                    <td class="radio"><input type="radio" name="id" value="<!= this.aeInstructionCustomReportID !>"></td>
                </tr>                
                ]]>          
            </script>      
        </tbody>      
        <tfoot>          
            <tr class="eof">              
                <td colspan="6">No Saved Reports. Click "Add Scheduled Report" below.</td>          
            </tr>          
            <tr class="progress">              
                <td colspan="6">Fetching data.</td>          
            </tr>      
        </tfoot>  
    </table>', 'SELECT
    aeicr.aeInstructionCustomReportID,
    aeicr.CustomReportID,
    aeicr.aeInstructionID,
    aeicr.Description,
    dbo.GetDayOfWeekForAeInstruction(aei.ExecOnDays) [DaysToRun],
    CAST(aei.TimeBetweenStart AS VARCHAR(5)) [TimeToRun],
    aeicre.EmployeesToSendTo [SendTo],
    aeicrp.ParametersAndValues [Parameters]
FROM
    aeInstructionCustomReport aeicr WITH (NOLOCK)
    INNER JOIN aeInstruction aei WITH (NOLOCK) ON aeicr.aeInstructionID = aei.aeInstructionID
    OUTER APPLY
    (
        SELECT STUFF((
            SELECT '', '' + e.FullName
            FROM
                aeInstructionCustomReportEmployee aeicre WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON aeicre.EmployeeID = e.EmployeeID
            WHERE
                aeicre.aeInstructionCustomReportID = aeicr.aeInstructionCustomReportID
            GROUP BY e.FullName
            ORDER BY e.FullName
        FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 2, '''') [EmployeesToSendTo]
    ) aeicre
    OUTER APPLY
    (
        SELECT STUFF((
            SELECT ''; '' + crp.Name + '' = '' +
                ISNULL(CASE
                    WHEN dov.DataBool IS NOT NULL THEN CASE WHEN dov.DataBool = 1 THEN ''True'' ELSE ''False'' END
                    WHEN dov.DataString IS NOT NULL THEN dov.DataString
                    WHEN div.DataIntValues IS NOT NULL THEN
                        CASE WHEN div.DataIntValues LIKE ''%,%''
                            THEN ''(Multiple values)''
                            ELSE
                                CASE
                                    WHEN crp.DataType IN (''year'', ''month'', ''date'') THEN (SELECT TOP 1 Description FROM aeInstructionCustomReportParameterDataOption WITH (NOLOCK) WHERE Deleted IS NULL AND aeInstructionCustomReportParameterDataOptionID = CAST(div.DataIntValues AS INT))
                                    WHEN crp.DataType IN (''id'', ''checkboxlist'') THEN
                                        CASE REPLACE(crp.LookUpTable, ''Session_'', '''')
                                            WHEN ''Client'' THEN (SELECT TOP 1 Client + ISNULL('' ('' + NULLIF(BranchName, '''') + '')'', '''') FROM Client WITH (NOLOCK) WHERE ClientID = CAST(div.DataIntValues AS INT))
                                            WHEN ''Project'' THEN (SELECT TOP 1 ISNULL(Project, '''') + CASE WHEN NULLIF(Project, '''') IS NOT NULL AND NULLIF(GroupName, '''') IS NOT NULL THEN '' / '' ELSE '''' END + ISNULL(GroupName, '''') FROM Project WITH (NOLOCK) WHERE ProjectID = CAST(div.DataIntValues AS INT))
                                            WHEN ''Site'' THEN (SELECT TOP 1 RTRIM(Address) + ISNULL('', '' + NULLIF(Postcode, ''''), '''') FROM Site WITH (NOLOCK) WHERE SiteID = CAST(div.DataIntValues AS INT))
                                            WHEN ''AirTestType'' THEN (SELECT TOP 1 Description FROM AirTestType WITH (NOLOCK) WHERE AirTestTypeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''BranchOffice'' THEN (SELECT TOP 1 BranchOffice FROM BranchOffice WITH (NOLOCK) WHERE BranchOfficeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''Job'' THEN (SELECT TOP 1 dbo.FormatTeamsReference(''J'', JobNo) FROM Job WITH (NOLOCK) WHERE JobID = CAST(div.DataIntValues AS INT))
                                            WHEN ''PortalUser'' THEN (SELECT TOP 1 FullName FROM PortalUser WITH (NOLOCK) WHERE PortalUserID = CAST(div.DataIntValues AS INT))
                                            WHEN ''PropertyType'' THEN (SELECT TOP 1 PropertyType FROM PropertyType WITH (NOLOCK) WHERE PropertyTypeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''QuoteType'' THEN (SELECT TOP 1 QuoteType FROM QuoteType WITH (NOLOCK) WHERE QuoteTypeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''SampleClassification'' THEN (SELECT TOP 1 SampleClassification FROM SampleClassification WITH (NOLOCK) WHERE SampleClassificationID = CAST(div.DataIntValues AS INT))
                                            WHEN ''SampleClassificationExtended'' THEN (SELECT TOP 1 SampleClassification FROM SampleClassificationExtended WITH (NOLOCK) WHERE SampleClassificationExtendedID = CAST(div.DataIntValues AS INT))
                                            WHEN ''SampleResult'' THEN (SELECT TOP 1 SampleResult FROM SampleResult WITH (NOLOCK) WHERE SampleResultID = CAST(div.DataIntValues AS INT))
                                            WHEN ''SurveyType'' THEN (SELECT TOP 1 Description FROM SurveyType WITH (NOLOCK) WHERE SurveyTypeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''TemplateType'' THEN (SELECT TOP 1 TemplateType FROM TemplateType WITH (NOLOCK) WHERE TemplateTypeID = CAST(div.DataIntValues AS INT))
                                            ELSE ''(A value from the database)''
                                        END
                                    ELSE
                                        CASE crp.DataType
                                            WHEN ''staff'' THEN (SELECT TOP 1 FullName FROM Employee WITH (NOLOCK) WHERE EmployeeID = CAST(div.DataIntValues AS INT))
                                            WHEN ''LabSelect'' THEN (SELECT TOP 1 Laboratory FROM Laboratory WITH (NOLOCK) WHERE LaboratoryID = CAST(div.DataIntValues AS INT))
                                            WHEN ''outstandingSampleJobSel'' THEN (SELECT TOP 1 dbo.FormatTeamsReference(''J'', JobNo) FROM Job WITH (NOLOCK) WHERE JobID = CAST(div.DataIntValues AS INT))
                                            WHEN ''projectGroup'' THEN (SELECT TOP 1 ProjectGroup FROM ProjectGroup WITH (NOLOCK) WHERE ProjectGroupID = CAST(div.DataIntValues AS INT))
                                            ELSE div.DataIntValues
                                        END
                                END
                        END
                END, ''(Value not available)'')
            FROM
                aeInstructionCustomReportParameter aeicrp WITH (NOLOCK)
                INNER JOIN CustomReportParameter crp WITH (NOLOCK) ON aeicrp.CustomReportParameterID = crp.CustomReportParameterID
                OUTER APPLY
                (
                    SELECT STUFF((
                        SELECT '','' + CAST(aeicrpd.DataInt AS VARCHAR(50))
                        FROM aeInstructionCustomReportParameterData aeicrpd WITH (NOLOCK)
                        WHERE aeicrpd.aeInstructionCustomReportParameterID = aeicrp.aeInstructionCustomReportParameterID AND aeicrpd.DataInt IS NOT NULL
                        GROUP BY aeicrpd.DataInt
                        ORDER BY aeicrpd.DataInt
                    FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 1, '''') [DataIntValues]
                ) div -- Data Int Values - Can be multiple (e.g. database IDs).
                OUTER APPLY
                (
                    SELECT TOP 1 aeicrpd.DataBool, aeicrpd.DataString
                    FROM aeInstructionCustomReportParameterData aeicrpd WITH (NOLOCK)
                    WHERE aeicrpd.aeInstructionCustomReportParameterID = aeicrp.aeInstructionCustomReportParameterID AND (aeicrpd.DataBool IS NOT NULL OR aeicrpd.DataString IS NOT NULL)
                ) dov -- Data Other Values - Anything else that only has one row (e.g. booleans and strings).
            WHERE
                aeicrp.aeInstructionCustomReportID = aeicr.aeInstructionCustomReportID
            GROUP BY crp.CustomReportParameterID, crp.Name, crp.DataType, crp.LookUpTable, dov.DataBool, dov.DataString, div.DataIntValues
            ORDER BY crp.CustomReportParameterID
        FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 2, '''') [ParametersAndValues]
    ) aeicrp
WHERE
    aeicr.Deleted IS NULL
    {Where}
ORDER BY
    Description', 5)
    DECLARE @DataGridID INT = SCOPE_IDENTITY()

    INSERT INTO DataGridButton (DataGridId, Eval, Action, RequiresId, SortOrder)
    VALUES
        (@DataGridID, 'Session("Manager")', 'Add Scheduled Report', 0, 1),
        (@DataGridID, 'Session("Manager")', 'Edit Scheduled Report', 1, 2),
        (@DataGridID, 'Session("Manager")', 'Delete Scheduled Report', 1, 3)

    INSERT INTO DataGridClauseCategory (Category)
    VALUES ('Custom Report Automation Filters')
    DECLARE @DataGridClauseCategoryID INT = SCOPE_IDENTITY()

    INSERT INTO DataGridClause (DataGridClauseCategoryId, Name, Eval, Clause)
    VALUES (@DataGridClauseCategoryID, 'Custom Report ID', 'True', '" AND aeicr.CustomReportID = " & SafeNumeric(Session("CurrentCustomReportID"))')
    DECLARE @DataGridClauseID INT = SCOPE_IDENTITY()

    INSERT INTO DataGridDataGridClause (DataGridId, DataGridClauseId)
    VALUES (@DataGridID, @DataGridClauseID)
END
GO

-- 5. Other bits of SQL such as SPROCs and functions.
IF NOT EXISTS(SELECT 1 FROM sys.objects WHERE type IN ('FN', 'IF', 'TF', 'FS', 'FT') AND name = 'fn_DateAddFromStringPart')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[fn_DateAddFromStringPart]() RETURNS VARCHAR(MAX) AS BEGIN RETURN '''' END')
END
GO
ALTER FUNCTION [dbo].[fn_DateAddFromStringPart]
(
    @Interval VARCHAR(11),
    @Increment INT,
    @Date DATETIME
)
RETURNS DATETIME
AS
BEGIN
    
    -- Return a DATEADD result. Used as SQL doesn't allow dynamic DATEPARTs from a database table.
    RETURN
        CASE
            WHEN @Interval IN ('year', 'yy', 'yyyy') THEN DATEADD(YEAR, @Increment, @Date)
            WHEN @Interval IN ('quarter', 'qq', 'q') THEN DATEADD(QUARTER, @Increment, @Date)
            WHEN @Interval IN ('month', 'mm', 'm') THEN DATEADD(MONTH, @Increment, @Date)
            WHEN @Interval IN ('dayofyear', 'dy', 'y') THEN DATEADD(DAYOFYEAR, @Increment, @Date)
            WHEN @Interval IN ('day', 'dd', 'd') THEN DATEADD(DAY, @Increment, @Date)
            WHEN @Interval IN ('week', 'wk', 'ww') THEN DATEADD(WEEK, @Increment, @Date)
            WHEN @Interval IN ('weekday', 'dw', 'w') THEN DATEADD(WEEKDAY, @Increment, @Date)
            WHEN @Interval IN ('hour', 'hh') THEN DATEADD(HOUR, @Increment, @Date)
            WHEN @Interval IN ('minute', 'mi', 'n') THEN DATEADD(MINUTE, @Increment, @Date)
            WHEN @Interval IN ('second', 'ss', 's') THEN DATEADD(SECOND, @Increment, @Date)
            WHEN @Interval IN ('millisecond', 'ms') THEN DATEADD(MILLISECOND, @Increment, @Date)
            WHEN @Interval IN ('microsecond', 'mcs') THEN DATEADD(MICROSECOND, @Increment, @Date)
            WHEN @Interval IN ('nanosecond', 'ns') THEN DATEADD(NANOSECOND, @Increment, @Date)
        END
    
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type IN ('FN', 'IF', 'TF', 'FS', 'FT') AND name = 'GetDayOfWeekForAeInstruction')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[GetDayOfWeekForAeInstruction]() RETURNS VARCHAR(MAX) AS BEGIN RETURN '''' END')
END
GO
ALTER FUNCTION [dbo].[GetDayOfWeekForAeInstruction](@ExecOnDays VARCHAR(50))
RETURNS VARCHAR(100)
AS
BEGIN
    -- Get the Days of the Week for an aeInstruction record.
    -- We need to get all of the days, spliting the comma-seperated list passed in.
    DECLARE @DaysOfWeekData TABLE (DayInt INT, DayOfWeekValue VARCHAR(10))
    INSERT INTO @DaysOfWeekData (DayInt, DayOfWeekValue)
    SELECT
        CAST(LTRIM(RTRIM(ss.s)) AS INT) [DayInt],
        CASE CAST(LTRIM(RTRIM(ss.s)) AS INT)
            WHEN 1 THEN 'Monday'
            WHEN 2 THEN 'Tuesday'
            WHEN 3 THEN 'Wednesday'
            WHEN 4 THEN 'Thursday'
            WHEN 5 THEN 'Friday'
            WHEN 6 THEN 'Saturday'
            WHEN 7 THEN 'Sunday'
        END [DayOfWeekValue]
    FROM
        dbo.SplitString(@ExecOnDays, ',') ss

    -- Combine the Days of the Week from the table variable.
    DECLARE @ReturnDays VARCHAR(100) = STUFF((
        SELECT ', ' + DayOfWeekValue
        FROM @DaysOfWeekData
        GROUP BY DayInt, DayOfWeekValue
        ORDER BY DayInt
    FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')

    RETURN @ReturnDays
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type IN ('FN', 'IF', 'TF', 'FS', 'FT') AND name = 'GetMonthForCustomReportOption')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[GetMonthForCustomReportOption]() RETURNS VARCHAR(MAX) AS BEGIN RETURN '''' END')
END
GO
ALTER FUNCTION [dbo].[GetMonthForCustomReportOption](@MonthInt INT)
RETURNS VARCHAR(10)
AS
BEGIN
    -- Get the month name from the int passed in.
    DECLARE @ReturnMonth VARCHAR(10) =
        CASE @MonthInt
            WHEN 1 THEN 'January'
            WHEN 2 THEN 'February'
            WHEN 3 THEN 'March'
            WHEN 4 THEN 'April'
            WHEN 5 THEN 'May'
            WHEN 6 THEN 'June'
            WHEN 7 THEN 'July'
            WHEN 8 THEN 'August'
            WHEN 9 THEN 'September'
            WHEN 10 THEN 'October'
            WHEN 11 THEN 'November'
            WHEN 12 THEN 'December'
        END

    RETURN @ReturnMonth
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AutomaticEmail_aeInstructionCustomReport')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AutomaticEmail_aeInstructionCustomReport] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[AutomaticEmail_aeInstructionCustomReport]
    @aeInstructionCustomReportID INT
/*
    For the Custom Report Automation functionality, get the data that we then use by orgTEAMS or inject into the row template. For example, all of the email receipients, the email subject, and the SPROC & parameters for each row of data.
*/
AS
BEGIN
    SET NOCOUNT ON;


    -- Start the main SELECT.
    SELECT
        aeicr.aeInstructionID,
        cr.CustomReportID,
        aeicre.EmployeesToSendTo [EmailRecipient],
        cr.Report + ' - ' + aeicr.Description [EmailSubject],
        'EXEC ' + cr.ProcedureName + ' ' + ISNULL(aeicrp.ParametersAndValues, '') [SprocAndParams]

    FROM
        aeInstructionCustomReport aeicr WITH (NOLOCK)
        INNER JOIN CustomReport cr WITH (NOLOCK) ON aeicr.CustomReportID = cr.CustomReportID
        OUTER APPLY
        (
            SELECT STUFF((
                SELECT '|' + e.Email + ';' + e.FullName
                FROM
                    aeInstructionCustomReportEmployee aeicre WITH (NOLOCK)
                    INNER JOIN Employee e WITH (NOLOCK) ON aeicre.EmployeeID = e.EmployeeID
                WHERE
                    aeicre.aeInstructionCustomReportID = aeicr.aeInstructionCustomReportID
                        AND
                    e.Deleted IS NULL
                        AND
                    e.Email LIKE '%@%' -- Add basic validation to make sure it's an email.
                GROUP BY e.Email, e.FullName
                ORDER BY e.FullName
            FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '') [EmployeesToSendTo]
        ) aeicre
        OUTER APPLY
        (
            SELECT STUFF((
                SELECT ', @' + CASE WHEN crp.DataType = 'outstandingSampleJobSel' THEN 'JobIDs' ELSE REPLACE(REPLACE(crp.Name, '(', ''), ')', '') END + ' = ' +
                    ISNULL(CASE
                        WHEN dov.DataBool IS NOT NULL THEN CAST(dov.DataBool AS VARCHAR(50))
                        WHEN dov.DataString IS NOT NULL THEN + '''' + REPLACE(dov.DataString, '''', '''''') + '''' -- Replace single quotes with double quotes.
                        WHEN div.DataIntValues IS NOT NULL THEN
                            CASE
                                WHEN crp.DataType IN ('staff', 'outstandingSampleJobSel', 'checkboxlist') THEN '''' + div.DataIntValues + ''''
                                WHEN crp.DataType IN ('year', 'month', 'date') THEN div.DataIntValues
                                ELSE div.DataIntValues
                            END
                    END, 'NULL')
                FROM
                    aeInstructionCustomReportParameter aeicrp WITH (NOLOCK)
                    INNER JOIN CustomReportParameter crp WITH (NOLOCK) ON aeicrp.CustomReportParameterID = crp.CustomReportParameterID
                    OUTER APPLY
                    (
                        SELECT STUFF((
                            SELECT ',' +
                                CASE WHEN crp.DataType IN ('year', 'month', 'date')
                                    THEN
                                        CASE
                                            WHEN crp.DataType = 'year' THEN CAST(DATEPART(YY, dbo.fn_DateAddFromStringPart(aeicrpdo.DateAddModifier, aeicrpdo.DateAddValue, GETDATE())) AS VARCHAR(50))
                                            WHEN crp.DataType = 'month' THEN '''' + CAST(CAST(dbo.fn_DateAddFromStringPart(aeicrpdo.DateAddModifier, aeicrpdo.DateAddValue, GETDATE()) AS DATE) AS VARCHAR(50)) + ''''
                                            WHEN crp.DataType = 'date' THEN
                                                CASE WHEN aeicrpdo.DateAddModifier IS NOT NULL AND aeicrpdo.DateAddValue IS NOT NULL
                                                    THEN '''' + CAST(CAST(dbo.fn_DateAddFromStringPart(aeicrpdo.DateAddModifier, aeicrpdo.DateAddValue, GETDATE()) AS DATE) AS VARCHAR(50)) + ''''
                                                    ELSE
                                                        CASE
                                                            WHEN aeicrpdo.Description = 'Start of this month' THEN '''' + CAST(CAST(DATEADD(MM, DATEDIFF(MM, 0, GETDATE()), 0) AS DATE) AS VARCHAR(50)) + ''''
                                                            WHEN aeicrpdo.Description = 'End of this month' THEN '''' + CAST(CAST(DATEADD(MM, ((YEAR(GETDATE()) - 1900) * 12) + MONTH(GETDATE()), -1) AS DATE) AS VARCHAR(50)) + ''''
                                                        END
                                                END
                                        END
                                    ELSE CAST(aeicrpd.DataInt AS VARCHAR(50))
                                END
                            FROM
                                aeInstructionCustomReportParameterData aeicrpd WITH (NOLOCK)
                                LEFT JOIN aeInstructionCustomReportParameterDataOption aeicrpdo WITH (NOLOCK) ON aeicrpd.DataInt = aeicrpdo.aeInstructionCustomReportParameterDataOptionID
                            WHERE aeicrpd.aeInstructionCustomReportParameterID = aeicrp.aeInstructionCustomReportParameterID AND aeicrpd.DataInt IS NOT NULL
                            GROUP BY aeicrpd.DataInt, aeicrpdo.Description, aeicrpdo.DateAddModifier, aeicrpdo.DateAddValue
                            ORDER BY aeicrpd.DataInt
                        FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '') [DataIntValues]
                    ) div -- Data Int Values - Can be multiple (e.g. database IDs).
                    OUTER APPLY
                    (
                        SELECT TOP 1 aeicrpd.DataBool, aeicrpd.DataString
                        FROM aeInstructionCustomReportParameterData aeicrpd WITH (NOLOCK)
                        WHERE aeicrpd.aeInstructionCustomReportParameterID = aeicrp.aeInstructionCustomReportParameterID AND (aeicrpd.DataBool IS NOT NULL OR aeicrpd.DataString IS NOT NULL)
                    ) dov -- Data Other Values - Anything else that only has one row (e.g. booleans and strings).
                WHERE
                    aeicrp.aeInstructionCustomReportID = aeicr.aeInstructionCustomReportID
                GROUP BY crp.CustomReportParameterID, crp.Name, crp.DataType, dov.DataBool, dov.DataString, div.DataIntValues
                ORDER BY crp.CustomReportParameterID
            FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [ParametersAndValues]
        ) aeicrp
    WHERE
        aeicr.aeInstructionCustomReportID = @aeInstructionCustomReportID
            AND
        aeicr.Deleted IS NULL
            AND
        aeicre.EmployeesToSendTo IS NOT NULL -- Add basic validation to make sure we've got an email to send to.


    SET NOCOUNT OFF;
END
GO


/* END CUSTOM REPORT AUTOMATION */

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__SendFromCompanyEmail' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE [dbo].[Config]
	ADD [b__SendFromCompanyEmail] [bit] NOT NULL
	CONSTRAINT [DF_Config_b__SendFromCompanyEmail]
	DEFAULT (0);
END

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PhotoCollection') AND name='AutoInsert') < 1
BEGIN
    ALTER TABLE PhotoCollection
      ADD AutoInsert BIT DEFAULT(0) NOT NULL
END

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AirTestDataCollectionQuestionPhotos')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos] AS BEGIN SET NOCOUNT ON; END')
END
GO
ALTER PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos]
      @AirTestID INT,
	  @IncludeAutoInsert BIT = 1,
	  @IncludePhotoEntry BIT = 1
AS
BEGIN
      
    SET NOCOUNT ON

	SELECT
		results.Type,
		ImageSize,
		PhotoID,
		PhotoReplaceVariable,
		Caption,
		CaptionReplaceVariable,
		TimeStamp,
		TimeStampVariable

	FROM
	(
		SELECT 
			main.[Type],
            ' width="' + CAST(mcWidth.[MobileConfigInt] as varchar) + '" height="' + CAST(mcHeight.[MobileConfigInt] as varchar) + '"' [ImageSize],
            main.PhotoID,
            main.PhotoReplaceVariable,
            main.Caption,
            main.CaptionReplaceVariable,
            main.TimeStamp,
            main.TimeStampVariable,
			main.AutoInsert,
			main.[Order]

		FROM
		(
			SELECT
				'PhotoEntry' [Type], ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by i.InspectionID) [Order], p.PhotoID [PhotoID], 0 [SELNO], '[AirTestQuestionPhotoID:' + CAST(p.PhotoID as varchar) + ']' [PhotoReplaceVariable], 'N/A' [Caption], '' [CaptionReplaceVariable], '' [TimeStamp],'' [TimeStampVariable], 0 [AutoInsert]

			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.EntryType='PhotoEntry'
				INNER JOIN Photo p ON i.InspectionInt = p.PhotoID

			WHERE
				i.AirTestID = @AirTestID
					AND
				@IncludePhotoEntry = 1

            UNION

			SELECT
				'PhotoCollection' [Type], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [Order], 
				p.PhotoID [PhotoID], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [SELNO], 
				REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariable], 
				IsNull(pc.Caption,'N/A') [Caption], 
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION]') [CaptionReplaceVariable],
				CONVERT(varchar,pc.Created,IsNull((Select MobileConfigInt FROM MobileConfig Where MobileConfigTypeID=88),103)) [TimeStamp],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME]') [TimeStampVariable],
				pc.AutoInsert

			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.PhotoCollection IS NOT NULL
				INNER JOIN PhotoCollection pc ON i.InspectionID = pc.InspectionID AND pc.IncludeInPDF IS NOT NULL
				INNER JOIN Photo p ON p.PhotoID=pc.PhotoID

			WHERE
				i.AirTestID = @AirTestID
		) main
		LEFT OUTER JOIN MobileConfig mcWidth WITH (NOLOCK) ON mcWidth.MobileConfigText='Width' AND mcWidth.MobileConfigTypeID=96
        LEFT OUTER JOIN MobileConfig mcHeight WITH (NOLOCK) ON mcHeight.MobileConfigText='Height' AND mcHeight.MobileConfigTypeID=96
	) results

	WHERE
		CASE
			WHEN @IncludeAutoInsert = 1
			THEN 1
			ELSE
				CASE
					WHEN AutoInsert = 1
					THEN 0
					ELSE 1
				END
			END = 1

	Order By
		results.[Order]

      SET NOCOUNT OFF
      
END
GO

-- getPatTestInformation dummy sp
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='P' AND name='getDetailsForAddToInvoice')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[getDetailsForAddToInvoice] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[getDetailsForAddToInvoice](
    @QuoteIdList varchar(MAX) = null,
    @QuoteIdNOACCESSList varchar(MAX) = null
)
AS
BEGIN

    DECLARE
        @Teams_s__SageDefaultNominalCode varchar(8),
        @Teams_i__SageDefaultDepartment int
        
    SELECT TOP 1
        @Teams_s__SageDefaultNominalCode = s__SageDefaultNominalCode,
        @Teams_i__SageDefaultDepartment = i__SageDefaultDepartment
    FROM
        config
    
    DECLARE @NOACCESSQUOTETYPE [int] 
    DECLARE @NOACCESSQUOTETYPE_DESC varchar(100)
    DECLARE @NOACCESS_NOM [varchar](8)
    DECLARE @NOACCESS_DEPT int
    set @NOACCESSQUOTETYPE = 125
    
    SELECT @NOACCESSQUOTETYPE_DESC = [QuoteType], @NOACCESS_DEPT = [SageDefaultDepartment], @NOACCESS_NOM = [SageDefaultNominalCode] FROM [dbo].[QuoteType] WHERE [QuoteTypeID] = @NOACCESSQUOTETYPE
    
       
        
    ;WITH IDTABLE (id,examfee,itemValue,valueadjust,description)
    AS 
    (
        Select splitStuff.ID, splitStuff.examfee, splitStuff.itemValue, splitStuff.valueadjust, splitStuff.Description
        FROM
        (
                        Select 
                              Main.ID [ID], null [examfee],null [itemValue], NULLIF(CAST(IsNull(q.ExamFee,0) as money)+CAST(IsNull(ItemSplitOnInvoice.splitCost,0) as money),CAST(0 as money)) [valueadjust], null [Description]  FROM
                              (
                              SELECT distinct
                                      CAST([ss].[s] AS int) [ID]
                              FROM
                                      [dbo].[SplitString](@QuoteIdList,',') ss
                              ) Main
                              INNER JOIN Quote q ON Main.ID=q.QuoteID
                              OUTER APPLY
                              (
                                    Select Coalesce(qvConsumable.Cost,qvEquipment.Cost,(qvi.Cost*qvi.Qty*qvi.Markup),(qvl.Cost*qvl.Qty*qvl.Markup)) [splitCost], COALESCE(qvConsumable.Description,qvEquipment.Description,qvi.Description,qvl.Description) [Description] FROM 
                                    QuoteEmployee qe INNER JOIN QuoteVisit qv ON qe.QuoteEmployeeID=qv.QuoteEmployeeID
                                    OUTER APPLY (Select (c.Price*qvc.Qty*qvc.Markup) [Cost], c.Description [Description] FROM QuoteVisitConsumable qvc INNER JOIN Consumable c ON qvc.ConsumableID=c.ConsumableID Where qvc.QuoteVisitID=qv.QuoteVisitID AND qvc.SplitOnInvoice=1 AND qvc.Qty IS NOT NULL)  qvConsumable
                                    OUTER APPLY (Select (qve.HireCost*qve.HireQty*qve.Markup) [Cost], ec.Description [Description] FROM QuoteVisitEquipment qve INNER JOIN EquipmentCategory ec ON qve.EquipmentCategoryID=ec.EquipmentCategoryID Where qve.QuoteVisitID=qv.QuoteVisitID AND qve.SplitOnInvoice=1 AND qve.HireQty IS NOT NULL) qvEquipment
                                    LEFT OUTER JOIN QuoteVisitItem qvi ON qvi.QuoteVisitID=qv.QuoteVisitID AND qvi.SplitOnInvoice=1 AND qvi.Qty IS NOT NULL
                                    LEFT OUTER JOIN QuoteVisitLabour qvl ON qvl.QuoteVisitID=qv.QuoteVisitID AND qvl.SplitOnInvoice=1 AND qvl.Qty IS NOT NULL
                                    Where qe.QuoteID = Main.ID
                              ) ItemSplitOnInvoice
                        UNION
                          (
                                    Select Main.ID, q.ExamFee [examfee],null [itemValue], null [valueadjust], null [Description] FROM
                                    (
                                    SELECT distinct
                                            CAST([ss].[s] AS int) [ID]
                                    FROM
                                            [dbo].[SplitString](@QuoteIdList,',') ss
                                    ) Main
                                    INNER JOIN Quote q ON Main.ID=q.QuoteID Where q.ExamFee IS NOT NULL AND q.ExamFee > 0
                          )
                        UNION
                        Select
                              Main.ID [ID], null [examfee], NULLIF(CAST(IsNull(ItemSplitOnInvoice.splitCost,0) as money),CAST(0 as money)) [itemValue], null [valueadjust], ItemSplitOnInvoice.Description [Description]  FROM
                              (
                              SELECT distinct
                                      CAST([ss].[s] AS int) [ID]
                              FROM
                                      [dbo].[SplitString](@QuoteIdList,',') ss
                              ) Main
                              INNER JOIN Quote q ON Main.ID=q.QuoteID
                              OUTER APPLY
                              (
                                    Select Coalesce(qvConsumable.Cost,qvEquipment.Cost,(qvi.Cost*qvi.Qty*qvi.Markup),(qvl.Cost*qvl.Qty*qvl.Markup)) [splitCost], COALESCE(qvConsumable.Description,qvEquipment.Description,qvi.Description,qvl.Description) [Description] FROM 
                                    QuoteEmployee qe INNER JOIN QuoteVisit qv ON qe.QuoteEmployeeID=qv.QuoteEmployeeID
                                    OUTER APPLY (Select (c.Price*qvc.Qty*qvc.Markup) [Cost], c.Description [Description] FROM QuoteVisitConsumable qvc INNER JOIN Consumable c ON qvc.ConsumableID=c.ConsumableID Where qvc.QuoteVisitID=qv.QuoteVisitID AND qvc.SplitOnInvoice=1 AND qvc.Qty IS NOT NULL)  qvConsumable
                                    OUTER APPLY (Select (qve.HireCost*qve.HireQty*qve.Markup) [Cost], ec.Description [Description] FROM QuoteVisitEquipment qve INNER JOIN EquipmentCategory ec ON qve.EquipmentCategoryID=ec.EquipmentCategoryID Where qve.QuoteVisitID=qv.QuoteVisitID AND qve.SplitOnInvoice=1 AND qve.HireQty IS NOT NULL) qvEquipment
                                    LEFT OUTER JOIN QuoteVisitItem qvi ON qvi.QuoteVisitID=qv.QuoteVisitID AND qvi.SplitOnInvoice=1 AND qvi.Qty IS NOT NULL
                                    LEFT OUTER JOIN QuoteVisitLabour qvl ON qvl.QuoteVisitID=qv.QuoteVisitID AND qvl.SplitOnInvoice=1 AND qvl.Qty IS NOT NULL
                                    Where qe.QuoteID = Main.ID
                              ) ItemSplitOnInvoice
                            Where ItemSplitOnInvoice.splitCost is not null
        ) splitStuff
    ),
    IDNOACCESSTABLE (id)
    AS 
    (
        SELECT distinct
            CAST([ss].[s] AS int)
        FROM
            [dbo].[SplitString](@QuoteIdNOACCESSList,',') ss
    )
        
        
    Select Main.* FROM
    (SELECT 
        q.QuoteID,
        COALESCE(qt.sagedefaultnominalcode,@Teams_s__SageDefaultNominalCode) quotenominalcode,
        (
            SELECT 
                COALESCE(sagedepartment, qt.sagedefaultdepartment,@Teams_i__SageDefaultDepartment) 
            FROM 
                branchoffice 
            WHERE 
                branchofficeid = q.branchofficeid
        ) quoteSageDepartment, 
        q.ClientID, 
        q.ProjectID, 
        q.SiteID, 
        q.QuoteTypeID, 
        q.STATUS, 
        COALESCE(idT.examfee,idT.itemValue,q.VALUE) [Value],
        q.Created, 
        qt.QuoteType, 
        Min(a.EndTime) AS EndTime, 
        a.ClientOrderNo, 
        j.JobID, 
        CASE WHEN LTRIM(RTRIM(ISNULL(j.ClientOrderNo,'')))='' THEN NULL ELSE j.ClientOrderNo end AS ClientOrderNo2, 
        j.JobNo, 
        q.ProFormaItemID,
        [q].[ContactId],
        idT.examfee [ExamFee],
        idT.valueadjust [ValueAdjust],
        idT.description [ItemDescription],
		c.SageAccountNumber
    FROM 
        Quote q 
        INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
        LEFT OUTER JOIN Appointment a ON q.QuoteID = a.QuoteID 
        LEFT OUTER JOIN Job j ON q.JobID = j.JobID
		LEFT JOIN Client c ON q.ClientID = c.ClientID
        LEFT OUTER JOIN IDtable idT ON [q].[QuoteID] = idt.[id]
        LEFT OUTER JOIN [IDNOACCESSTABLE] idNOACCESST ON q.[QuoteID] = [idNOACCESST].[id]
    WHERE 
        a.datedeclined is NULL 
        AND 
        (   
            [idT].[id] IS NOT NULL 
        )
    GROUP BY 
        q.QuoteID,
        qt.sagedefaultnominalcode,
        qt.sagedefaultdepartment,
        q.branchofficeid, 
        q.ClientID, 
        q.ProjectID, 
        q.SiteID, 
        q.QuoteTypeID, 
        q.STATUS, 
        COALESCE(idT.examfee,idT.itemValue,q.VALUE),
        q.Created, 
        qt.QuoteType,
        a.ClientOrderNo, 
        j.JobID, 
        CASE WHEN LTRIM(RTRIM(ISNULL(j.ClientOrderNo,'')))='' THEN NULL ELSE j.ClientOrderNo end , 
        j.JobNo, 
        q.ProFormaItemID,
        q.[ContactId],
        idT.examfee,
        idT.valueadjust,
        idT.description,
		c.SageAccountNumber
        
    UNION ALL 
    
    SELECT 
        q.QuoteID,
        COALESCE(@NOACCESS_NOM,@Teams_s__SageDefaultNominalCode) quotenominalcode,
        (
            SELECT 
                COALESCE(sagedepartment, @NOACCESS_DEPT,@Teams_i__SageDefaultDepartment) 
            FROM 
                branchoffice 
            WHERE 
                branchofficeid = q.branchofficeid
        ) quoteSageDepartment, 
        q.ClientID, 
        q.ProjectID, 
        q.SiteID, 
        125, 
        q.STATUS, 
        COALESCE(idT.examfee,idT.itemValue,q.VALUE) [Value],
        q.Created, 
        @NOACCESSQUOTETYPE_DESC, 
        Min(a.EndTime) AS EndTime, 
        a.ClientOrderNo, 
        j.JobID, 
        CASE WHEN LTRIM(RTRIM(ISNULL(j.ClientOrderNo,'')))='' THEN NULL ELSE j.ClientOrderNo end  AS ClientOrderNo2, 
        j.JobNo, 
        q.ProFormaItemID,
        [q].[ContactId],
        idT.examfee [ExamFee],
        idT.valueadjust [ValueAdjust],
        idT.description [ItemDescription],
		c.SageAccountNumber
    FROM 
        Quote q 
        INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
        inner JOIN Appointment a ON q.QuoteID = a.QuoteID 
        INNER join Job j ON q.JobID = j.JobID
		LEFT JOIN Client c ON q.ClientID = c.ClientID
        LEFT OUTER JOIN IDtable idT ON [q].[QuoteID] = idt.[id]
        LEFT OUTER JOIN [IDNOACCESSTABLE] idNOACCESST ON q.[QuoteID] = [idNOACCESST].[id]
    WHERE 
        a.datedeclined is NULL 
        AND 
        (   
            [idNOACCESST].[id] IS NOT NULL
        )
    GROUP BY 
        q.QuoteID,
        --qt.sagedefaultnominalcode,
        --qt.sagedefaultdepartment,
        q.branchofficeid, 
        q.ClientID, 
        q.ProjectID, 
        q.SiteID, 
        q.QuoteTypeID, 
        q.STATUS, 
        COALESCE(idT.examfee,idT.itemValue,q.VALUE), 
        q.Created, 
        --@NOACCESSQUOTETYPE_DESC,
        a.ClientOrderNo, 
        j.JobID, 
        CASE WHEN LTRIM(RTRIM(ISNULL(j.ClientOrderNo,'')))='' THEN NULL ELSE j.ClientOrderNo end , 
        j.JobNo, 
        q.ProFormaItemID,
        [q].[ContactId],
        idT.examfee,
        idT.valueadjust,
        idT.description,
		SageAccountNumber) Main
      Order BY
            Main.JobNo, [Main].[QuoteID],[Main].[ExamFee]
        
        --Main.ItemDescription
END


GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_InvoicesInProgress')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_InvoicesInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GridDetail_InvoicesInProgress]
	@InvoiceNo INT

AS
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

SELECT
	[JobNo] =			COALESCE(dbo.FormatTEAMSReference('J', j.JobNo), pi.JobNo, ci.JobNo, ii.JobNo),
	[QuoteNo] =			q.QuoteNo,
	[QuoteType] =		COALESCE(qt.QuoteType, qt1.QuoteType, qt2.QuoteType),
	[Description] =		COALESCE(ii.Description, pi.Description, ci.Description),
	[Value] =			CONVERT(VARCHAR(MAX),COALESCE(ii.Cost, pi.Cost, ci.Cost))
FROM
	Invoice i
	LEFT JOIN InvoiceItem ii ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
	LEFT JOIN CreditItem ci ON i.InvoiceID = ci.InvoiceID AND ii.DateRemoved IS NULL
	LEFT JOIN ProFormaItem pi ON i.InvoiceID = pi.InvoiceID AND ii.DateRemoved IS NULL
	LEFT JOIN QuoteType qt ON ii.QuoteTypeID = qt.QuoteTypeID
	LEFT JOIN QuoteType qt1 ON ci.QuoteTypeID = qt1.QuoteTypeID
	LEFT JOIN QuoteType qt2 ON pi.QuoteTypeID = qt2.QuoteTypeID
	LEFT JOIN Quote q ON ii.InvoiceItemID = q.InvoiceItemID
	LEFT JOIN Job j ON q.JobID = j.JobID
WHERE
	i.InvoiceNo = @InvoiceNo

END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'VerifiedSampleResultComparison')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[VerifiedSampleResultComparison] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[VerifiedSampleResultComparison]
	@jobid int = NULL,
	@sampleid int = NULL
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;

	select 
		case (select COUNT(*) from Floorplan fp where fp.RegisterID = reg.RegisterID)
			when 0 then
				'Bulk Sample'
			else
				'Normal'
		end 'type',
		j.jobno,
		s.sampleid,
		s.sampleref,
		dbo.getElementTextValue(e6.ElementID, 1) 'original_classification',
		Case when s.SampleClassificationExtendedID is null
			then sc.SampleClassification
			else sce.SampleClassification
		end 'verified_SampleClassification',
		(
			Select 
				CASE 
				WHEN eim.ShortDescription IS NOT NULL THEN 
					eim.ShortDescription 
				ELSE 
					convert(varchar(MAX), eim.Description) 
				END
			FROM 
				Element e
				FULL JOIN ElementIntMeaning eim ON e.ElementIntMeaningID = eim.ElementIntMeaningID
			WHERE 
				(
				    e.SampleID = s.sampleID 
				    /*OR e.SampleID IS NULL -- nulls can exist with removal*/
				) AND 
				e.ElementTypeID = 8
		)							'original_result',
		sr.SampleResult				'verified_SampleResult',
		regemployee.FullName		'original_employee',
		verifyingEmployee.FullName	'verified_by_employee',
        e2.[ElementText]            'SampleDescription',
		[Internal_Note] =			stc._sampleInternalNote
	from
		Job j 
		left outer join JobEmployee je on j.JobID = je.JobID 
		left outer join Register reg on je.JobEmployeeID = reg.JobEmployeeID
		left outer join Employee regemployee on reg.EmployeeID = regemployee.EmployeeID
		left outer join Room rm on reg.RegisterID = rm.RegisterID
		left outer join Sample s on ((@sampleid is null and (rm.RoomID = s.roomid)) or ((s.sampleid = @sampleid) and rm.RoomID = s.roomid))
		LEFT JOIN SampleTestCollection stc ON s.SampleID = stc._SampleID
		left outer join SampleClassification sc on sc.SampleClassificationID = s.SampleClassificationID
		left outer join SampleClassificationExtended sce on sce.SampleClassificationExtendedID = s.SampleClassificationExtendedID
		left outer join Element e6 on e6.SampleID = s.SampleID and e6.ElementTypeID = 6
		left outer join Employee verifyingEmployee on s.EmployeeID = verifyingEmployee.EmployeeID
		left outer join SampleResult sr on s.SampleResultID = sr.SampleResultID
        LEFT OUTER JOIN [dbo].[Element] e2 ON e2.[SampleID] = [s].[SampleID] AND e2.[ElementTypeID] = 2 
	where
		j.jobid = @jobid and
		s.assample = 0 and
		isnull(s.sampleref,'') != ''
END

GO

USE [TEAMS]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
ALTER FUNCTION [dbo].[fn_employeeAppClash]
(	
    @param_EmployeeID int,
    @param_From datetime,
    @param_To datetime,
    @param_currAppointmentID int
    
)
RETURNS @resDates TABLE (theDate date, appCount int, AppointmentTYpe VARCHAR(MAX))
AS
begin
    
    declare @employeeid int
    Declare @From datetime
    Declare @To datetime
    DECLARE @currAppointmentID int
    
    DECLARE @CurrAppointmentGroupId [int]
    

    set @Employeeid = @param_EmployeeID
    set @From = @param_From
    set @To = @param_To
    set @currAppointmentID = @param_currAppointmentID

    --debug
    --declare @resDates TABLE (theDate date, appCount int)
    --set @Employeeid = 2
    --set @From = '19 Feb 2014 09:00:00'
    --set @To = '19 Feb 2014 11:00:00'
    --set @currAppointmentID = 7967
    --debug

    --get the group id of the appointment, it may be null after as it is a one off appointment
    SELECT @CurrAppointmentGroupId = [AppointmentGroupId] FROM [dbo].[Appointment] WHERE [AppointmentID] = @currAppointmentID

    declare @Dates as table(startDate datetime, endDate datetime)
    Declare @i smallint
    Set @i = 0
    While @i <= DateDiff(d, @From, @To)
    Begin
          Insert Into @Dates (startDate,endDate) Values (DateAdd(d, @i, @From), Cast(Cast(DateAdd(d, @i, @From) as date) as varchar(10)) + ' ' + Cast(Cast(@To as time) as varchar(5)) )
       
          Set @i = @i + 1
    END

    insert into @resDates
    select 
        thedate,
		sum(appcount),
		a.AppointmentType
    from 
    (
        Select 
            cast(startdate as date) thedate,
			ISNULL(aptc.Description,aptt.AppointmentType) [AppointmentType],
			COUNT(ae.EmployeeID) appcount
        From    
            @dates d 
            Left Outer Join Appointment a On 
            (
                (d.startdate between a.StartTime and a.EndTime or d.endDate between a.StartTime and a.EndTime )
                or
                (a.StartTime between d.startDate and d.endDate or a.endTime between d.startDate and d.endDate)
            )
            left outer Join AppointmentEmployee ae On a.AppointmentID = ae.AppointmentID and ae.EmployeeID = @employeeid
			left join AppointmentType aptt ON a.AppointmentTypeID = aptt.AppointmentTypeId
			left join AppointmentCategory aptc ON a.AppointmentCategoryID = aptc.AppointmentCategoryID
        where 
            a.datedeclined is null and
            a.appointmentid != @currAppointmentID AND
            (
                (@CurrAppointmentGroupId IS NULL)
                OR
                ([a].[AppointmentGroupId] IS NOT NULL AND a.[AppointmentGroupId] != @CurrAppointmentGroupId)
            )
        Group By
            a.appointmentgroupid,
			d.startdate, 
			AppointmentType,
			aptc.Description
        having
            min(a.appointmentid) != @currAppointmentID
    ) as  a
    group BY 
		thedate,
		AppointmentType    
    
    --SELECT * FROM @resDates
    return
end



GO

IF not exists(SELECT * FROM sys.columns WHERE Name=N'AutoSendPDF' AND Object_ID=Object_ID(N'AirTest'))
BEGIN
    ALTER TABLE [AirTest] ADD [AutoSendPDF] BIT NOT NULL
	CONSTRAINT [DF__AirTest__AutoSen__72494B62]
DEFAULT (1);
END
GO


UPDATE LegionellaFrequencyCategory SET Description = REPLACE(Description, 'Quartlery', 'Quarterly')


IF not exists(SELECT * FROM sys.columns WHERE Name=N'Position' AND Object_ID=Object_ID(N'BuildingComponent'))
BEGIN
    ALTER TABLE [BuildingComponent] ADD [Position] VARCHAR(MAX) NULL

DEFAULT (1);
END
GO


IF not exists(SELECT * FROM sys.columns WHERE Name=N'Comments' AND Object_ID=Object_ID(N'BuildingComponent'))
BEGIN
    ALTER TABLE [BuildingComponent] ADD [Comments] VARCHAR(MAX) NULL

DEFAULT (1);
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AirMonitoringDiary')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AirMonitoringDiary] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[AirMonitoringDiary]
	@JobID INT,
    @IncludeSystemEntries BIT = 0,
    @SiteLogDayID INT = 0,
    @AirTestID int = 0,
    @AirTestScope BIT = 0,
    @NPE_String VARCHAR(MAX) = 'No photographic evidence'
AS
BEGIN
	SET NOCOUNT ON
      
    SELECT
		CONVERT(VARCHAR, CONVERT(DATE, sl.Recorded)) 'Date',
		RIGHT('0' + CONVERT(VARCHAR, DATEPART(HOUR, sl.Recorded)), 2) + ':' + RIGHT('0' + CONVERT(VARCHAR, DATEPART(MINUTE, sl.Recorded)), 2) 'Time',
		sl.[Description] 'Details',
		CASE WHEN p.PhotoData IS NOT NULL THEN
				'<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(sl.PhotoID as varchar) + '&[RND]"/>'
		Else
				@NPE_String
		END 'DiaryPhotoPath',
		CASE WHEN p.PhotoData IS NOT NULL THEN
				sl.PhotoID
		END [PhotoID],
		CASE WHEN p.PhotoData IS NOT NULL THEN
			ROW_NUMBER() OVER (Partition By CASE WHEN p.PhotoData IS NOT NULL THEN 1 ELSE 0 END Order By sl.Recorded)
		End [PhotoData_RowNumber]
    FROM
        SiteLog sl
        Left Outer Join Photo p ON sl.PhotoID=p.PhotoID
		OUTER APPLY
		(
			SELECT
				AirTestStart,
				AirTestFinish,
				at.AirTestID
			FROM
				AirTest at
			WHERE
				at.AirTestID = @AirTestID
		) at
    WHERE
		sl.JobID = @JobID
			AND
        sl.SystemTypeID IN  (0,(Select Case WHEN  @IncludeSystemEntries=1 THEN 1 ELSE 0 END),(Select Case WHEN  @IncludeSystemEntries=1 THEN 2 ELSE 0 END),(Select Case WHEN  @IncludeSystemEntries=1 THEN 3 ELSE 0 END))
			AND
	   (CASE WHEN @AirTestID = 0 THEN
			CASE WHEN @SiteLogDayID = 0 THEN 
				1
			ELSE
				CASE WHEN sl.SiteLogDayID = @SiteLogDayID THEN 1 ELSE 0 END
			END
		ELSE
			CASE WHEN @AirTestScope = 0 THEN
				CASE WHEN sl.Recorded BETWEEN ISNULL(at.AirTestStart, GETDATE()) AND ISNULL(at.AirTestFinish, GETDATE()) THEN 
					1
				ELSE 
					0
				END
			ELSE
				CASE WHEN at.AirTestID = sl.AirTestID THEN
					1
				ELSE
					0
				END
			END
		END = 1)
			AND
		sl.Deleted IS NULL
    ORDER BY
		COALESCE(sl.Recorded,sl.Created)

    SET NOCOUNT OFF
END
GO

UPDATE CustomReport SET Notes = 'Using this tool will generate today''s override code for use with updating mobileTEAMS on tablets. PLEASE NOTE: using this code on the tablet and updating will remove all TEAMS data from the tablet. Any data that has not been transferred to the office, may be lost.' WHERE Report = 'mobileTEAMS Override'

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'MobileDataCheck')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[MobileDataCheck] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[MobileDataCheck]
	@AppointmentID INT = NULL

AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

-- Start the main select
SELECT
	[MobileDataReturned] =		CASE
									WHEN a.ManuallyMarkWorkDone = 1 THEN 1
									WHEN ISNULL(qe.EmployeeID, 0) > 0 AND a.AppointmentTypeID = 8 THEN 1
									WHEN jea.JobEmployeeAppointmentID IS NOT NULL THEN 1
								ELSE
									0
								END,								
	[MobileData] =				CASE
									WHEN a.ManuallyMarkWorkDone = 1 THEN 1
								ELSE
									CASE
										WHEN a.AppointmentTypeID = 1 THEN regCount.regCount
										WHEN a.AppointmentTypeID = 3 THEN airCount.airCount
										WHEN a.AppointmentTypeID = 9 THEN legCount.legCount
									END
								END
FROM
	Appointment a 
	LEFT JOIN Quote q ON a.QuoteID = q.QuoteID
	LEFT JOIN Job j ON q.JobID = j.JobID	
	LEFT JOIN QuoteEmployee qe ON q.QuoteID = qe.QuoteID
	LEFT JOIN JobEmployeeAppointment jea ON a.AppointmentID = jea.AppointmentID
	LEFT JOIN NoAccess na ON j.JobID = na.JobID	
	OUTER APPLY
	(
    SELECT
        COUNT(at.AirTestID) [airCount]
    FROM
        Job _j
        INNER JOIN JobEmployee je ON _j.JobID = je.JobID
        INNER JOIN Airtest at ON je.JobEmployeeID = at.JobEmployeeID
    WHERE
        _j.JobId = j.JobID
    )  airCount	
	OUTER APPLY
	(
	SELECT
		COUNT(r.RegisterID) [regCount]
	FROM
		Job _j
		INNER JOIN JobEmployee je ON _j.JobID = je.JobID
		INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
	WHERE
		_j.JobId = j.JobID
	)  regCount
	OUTER APPLY
	(
	SELECT
		COUNT(l.LegionellaID) [legCount]
	FROM
		Job _j
		INNER JOIN JobEmployee je ON _j.JobID = je.JobID
		INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
	WHERE
		_j.JobId = j.JobID
	)  legCount
WHERE
	a.AppointmentID = @AppointmentID
END

GO

ALTER PROCEDURE [dbo].[Paged_SiteList] 

	-- Paging

    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	@PropertytypeID INT = 0, -- (0=all)
	@ConstructiontypeID INT = 0, -- (0=all)
	@ConstructionDate VARCHAR(MAX) = '', -- (''=all)
	@Other VARCHAR(MAX) = '', -- (''=all)
	@ShowPost2000 INT = 0
AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX),
								PropertyTypeID INT,ConstructionTypeID INT)

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview,
								PropertyTypeID,ConstructionTypeID)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview],
		ISNULL(si.PropertyTypeID, 0) [PropertyTypeID],
		ISNULL(si.ConstructionTypeID, 0) [ConstructionTypeID]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
		(@PropertytypeID=0 OR si.PropertyTypeID=@PropertytypeID)
			And
		(@ConstructiontypeID=0 OR si.ConstructionTypeID=@ConstructiontypeID)
			AND
		(@ConstructionDate='' OR si.ConstructionDate=@ConstructionDate)
			AND
		(@Other='' OR si.Other=@Other)
			AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
			AND
		(@ShowPost2000=1 OR (si.Post2000=0 OR si.Post2000 IS NULL))
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID,
		si.PropertyTypeID,
		si.ConstructionTypeID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview,
		main.PropertyTypeID,
		main.ConstructionTypeID
	From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

ALTER PROCEDURE [dbo].[Paged_MyRisksAsbestos]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	-- From original portal SP
    @Risk VARCHAR(100) = '',
    @RecAction VARCHAR(100) = '',

	@SampleClassificationID INT = 0, -- (0=all)
	@HideInaccessibleItems INT = 0,
	@HideInaccessibleRooms INT = 0

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;

    -- Set variables for logic.
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = ISNULL(NULLIF(cfg.s__BasementName, ''), 'Z-Sub Level')
    FROM
        Config cfg WITH (NOLOCK)

	DECLARE @ListView TABLE (JobNo INT,Address VARCHAR(200),Postcode VARCHAR(10),UPRN VARCHAR(50),Building VARCHAR(1000),FloorNumber INT,
								FloorDescription VARCHAR(MAX),RoomCode VARCHAR(MAX),RoomNumber INT,RoomDescription VARCHAR(50),
								RegisterItemNo INT,AsSample BIT,SampleRef VARCHAR(50),SourceDescription NVARCHAR(MAX),AsbestosType NVARCHAR(MAX),
								MaterialAssessmentScore INT,PriorityAssessmentScore INT,RiskScore INT,RiskScoreGroupColour VARCHAR(10),
								RecommendedAction NVARCHAR(100),RecommendedActionColour VARCHAR(6),TimescaleForCompletion VARCHAR(MAX),
								SurveyTypeID INT,JobID INT,SampleID INT,IsMAOnly BIT,SurveyStartDate DATE,SurveyFinishDate DATE,SampleClassificationID INT)

	INSERT INTO @ListView (JobNo,Address,Postcode,UPRN,Building,FloorNumber,
							FloorDescription,RoomCode,RoomNumber,RoomDescription,
							RegisterItemNo,AsSample,SampleRef,SourceDescription,AsbestosType,
							MaterialAssessmentScore,PriorityAssessmentScore,RiskScore,RiskScoreGroupColour,
							RecommendedAction,RecommendedActionColour,TimescaleForCompletion,
							SurveyTypeID,JobID,SampleID,IsMAOnly,SurveyStartDate,SurveyFinishDate,SampleClassificationID)
	SELECT DISTINCT
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        ISNULL(r.BuildingDesignation, 'No Building Designation') [Building],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorDescription],
        rm.RoomCode,
        rm.Number [RoomNumber],
        rm.Description [RoomDescription],
        s.RegisterItemNo,
        s.AsSample,
        s.SampleRef,
        scd.SourceDescription,
        scd.AsbestosType,
        scd.MaterialAssessmentScore,
        scd.PriorityAssessmentScore,
        scd.RiskScore,
        scd.RiskScoreGroupColour,
        scd.RecommendedAction,
        scd.RecommendedActionColour,
        DATENAME(MONTH, scd.TimescaleForCompletion) + ' ' + CAST(DATEPART(YEAR, scd.TimescaleForCompletion) AS VARCHAR(4)) [TimescaleForCompletion],
        su.SurveyTypeID,
        j.JobID,
        s.SampleID,
        scd.IsMAOnly,
        CAST(r.RegisterStart AS DATE) [SurveyStartDate],
        CAST(r.RegisterFinish AS DATE) [SurveyFinishDate],
		ISNULL(s.SampleClassificationID, 0) [SampleClassificationID]
    FROM
        GuidSamples gs WITH (NOLOCK) 
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON gs.SampleID = scd.SampleID AND gs.ClientID = scd.ClientID AND gs.SiteID = scd.SiteID
        INNER JOIN Sample s WITH (NOLOCK) ON scd.SampleID = s.SampleID
		LEFT JOIN Element e5 WITH (NOLOCK) ON s.SampleID = e5.SampleID AND e5.ElementTypeID = 5
        INNER JOIN Room rm WITH (NOLOCK) ON s.RoomID = rm.RoomID
        INNER JOIN Floorplan f WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Register r WITH (NOLOCK) ON f.RegisterID = r.RegisterID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN Site si WITH (NOLOCK) ON scd.SiteID = si.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON scd.ClientID = c.ClientID
        LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
    WHERE
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
            AND
        si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this table. */
            AND
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
        scd.Removed = 0
            AND
        scd.RecommendedAction IS NOT NULL
			AND
		(@RecAction='' OR scd.RecommendedAction=@RecAction)
			AND
		(@SampleClassificationID=0 OR s.SampleClassificationID=@SampleClassificationID)
			AND
		(@HideInaccessibleRooms=0 OR rm.Inaccessible=0)
			AND
		(@HideInaccessibleItems = 0 OR e5.ElementIntID != 0)
    ORDER BY
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        Building,
        f.FloorNumber,
        rm.RoomCode,
        rm.Number,
        s.RegisterItemNo

    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@ListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @ListView
            ) a
    )

    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.JobNo,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Building,
        main.FloorNumber,
        main.FloorDescription,
        main.RoomCode,
        main.RoomNumber,
        main.RoomDescription,
        main.RegisterItemNo,
        main.AsSample,
        main.SampleRef,
        main.SourceDescription,
        main.AsbestosType,
        main.MaterialAssessmentScore,
        main.PriorityAssessmentScore,
        main.RiskScore,
        main.RiskScoreGroupColour,
        main.RecommendedAction,
        main.RecommendedActionColour,
        main.TimescaleForCompletion,
        main.SurveyTypeID,
        main.JobID,
        main.SampleID,
        main.IsMAOnly,
        main.SurveyStartDate,
        main.SurveyFinishDate,
		main.SampleClassificationID
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaRisk_Export')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetLegionellaRisk_Export] AS BEGIN SET NOCOUNT ON; END')
END

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[GetPortalLegionellaHomeTabGraphData]    Script Date: 25/10/2017 13:34:24 ******/
SET ANSI_NULLS ON
GO

GO

ALTER PROCEDURE [dbo].[GetLegionellaRisk_Export]
	@JobID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;

-- Get Legionella Items data up front to reduce table scans on the Legionella/Asset/Location/Outlet tables.
DECLARE @LegionellaItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, DateApproved DATETIME, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT,  OutletEnabledCold BIT, OutletEnabledHot BIT, OutletEnabledMixed BIT, OutletEnabledMains BIT, OutletLowUse BIT)

INSERT INTO @LegionellaItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, DateApproved, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, OutletEnabledCold, OutletEnabledHot, OutletEnabledMixed, OutletEnabledMains, OutletLowUse)
SELECT
	si.SiteID,
	j.JobID,
	lao.RowType,
	l.LegionellaID,
	l.GUID [LegGUID],
	l.GUIDVersion [LegGUIDVersion],
	l.DateApproved,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lao.OutletEnabledCold,
	lao.OutletEnabledHot,
	lao.OutletEnabledMixed,
	lao.OutletEnabledMains,
	CASE WHEN (lao.OutletEnabledCold = 1 AND lao.OutletLowUseCold = 1) OR (lao.OutletEnabledHot = 1 AND lao.OutletLowUseHot = 1) OR (lao.OutletEnabledMixed = 1 AND lao.OutletLowUseMixed = 1) OR (lao.OutletEnabledMains = 1 AND lao.OutletLowUseMains = 1)
		THEN 1
		ELSE 0
	END [OutletLowUse]
FROM
	Job j WITH (NOLOCK)
	INNER JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Client c ON j.ClientID = c.ClientID
	INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
	INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
	INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
	INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
	INNER JOIN (
		SELECT
			1 [RowType],
			l.LegionellaID,
			NULL [LegionellaAssetOutletID],
			NULL [AssetOutletSystemRef],
			NULL [AssetOutletGUID],
			NULL [AssetOutletGUIDVersion],
			NULL [LegionellaLocationID],
			NULL [AssetOutletLocation],
			NULL [LocationGUID],
			NULL [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			Legionella l WITH (NOLOCK)

		UNION ALL

		SELECT
			2 [RowType],
			la.LegionellaID,
			la.LegionellaAssetID [LegionellaAssetOutletID],
			la.SystemRef [AssetOutletSystemRef],
			la.GUID [AssetOutletGUID],
			la.GUIDVersion [AssetOutletGUIDVersion],
			NULL [LegionellaLocationID],
			la.Location [AssetOutletLocation],
			NULL [LocationGUID],
			NULL [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			LegionellaAsset la WITH (NOLOCK)
		WHERE
			la.Deleted IS NULL

		UNION ALL

		SELECT
			3 [RowType],
			ll.LegionellaID,
			NULL [LegionellaAssetOutletID],
			NULL [AssetOutletSystemRef],
			NULL [AssetOutletGUID],
			NULL [AssetOutletGUIDVersion],
			ll.LegionellaLocationID,
			ll.Location [AssetOutletLocation],
			ll.GUID [LocationGUID],
			ll.GUIDVersion [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			LegionellaLocation ll WITH (NOLOCK)
		WHERE
			ll.Deleted IS NULL

		UNION ALL

		SELECT
			4 [RowType],
			ll.LegionellaID,
			lo.LegionellaOutletID [LegionellaAssetOutletID],
			lo.SystemRef [AssetOutletSystemRef],
			lo.GUID [AssetOutletGUID],
			lo.GUIDVersion [AssetOutletGUIDVersion],
			ll.LegionellaLocationID,
			ll.Location [AssetOutletLocation],
			ll.GUID [LocationGUID],
			ll.GUIDVersion [LocationGUIDVersion],
			lo.EnabledCold [OutletEnabledCold],
			lo.EnabledHot [OutletEnabledHot],
			lo.EnabledMixed [OutletEnabledMixed],
			lo.EnabledMains [OutletEnabledMains],
			lo.LowUseCold [OutletLowUseCold],
			lo.LowUseHot [OutletLowUseHot],
			lo.LowUseMixed [OutletLowUseMixed],
			lo.LowUseMains [OutletLowUseMains]
		FROM
			LegionellaLocation ll WITH (NOLOCK)
			INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID AND lo.Deleted IS NULL
		WHERE
			ll.Deleted IS NULL
	) lao ON l.LegionellaID = lao.LegionellaID
WHERE
	j.JobID = @JobID
GROUP BY
	si.SiteID,
	j.JobID,
	lao.RowType,
	l.LegionellaID,
	l.GUID,
	l.GUIDVersion,
	l.DateApproved,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lao.OutletEnabledCold,
	lao.OutletEnabledHot,
	lao.OutletEnabledMixed,
	lao.OutletEnabledMains,
	lao.OutletLowUseCold,
	lao.OutletLowUseHot,
	lao.OutletLowUseMixed,
	lao.OutletLowUseMains

-- Get Legionella Task up front to reduce table scans on the LegionellaTask table.
-- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
DECLARE @LegionellaTasksData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, /* ADDITIONAL COLUMNS */ RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaPriorityRatingID INT)

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaID = lt.LegionellaID AND lt.Deleted IS NULL AND lao.RowType=1
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaAssetOutletID = lt.LegionellaAssetID AND lt.Deleted IS NULL AND lao.LegionellaLocationID IS NULL AND lao.RowType=2
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaLocationID = lt.LegionellaLocationID AND lt.Deleted IS NULL AND lao.LegionellaLocationID IS NOT NULL AND lao.RowType=3
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaAssetOutletID = lt.LegionellaOutletID AND lt.Deleted IS NULL AND lao.RowType=4
WHERE
	lt.Deleted IS NULL

-- Get Legionella Risk Items data up front as used below. Basically GUID Tasks.
-- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
DECLARE @LegionellaRiskItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, /* ADDITIONAL COLUMNS */ JobNo INT, SiteAddress VARCHAR(200), SitePostcode VARCHAR(10), BuildingDesignation VARCHAR(50), AssetOutletSystemRef VARCHAR(8000), Location VARCHAR(8000), RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(8000), LegionellaPriorityRatingID INT, PriorityRating VARCHAR(20), PriorityColour VARCHAR(15))

INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, JobNo, SiteAddress, SitePostcode, BuildingDesignation, AssetOutletSystemRef, Location, RiskDescription, Action, LegionellaFrequencyCategoryID, FrequencyCategory, LegionellaPriorityRatingID, PriorityRating, PriorityColour)
SELECT
	lt.SiteID,
	lt.JobID,
	lt.RowType,
	lt.LegionellaID,
	lt.LegGUID,
	lt.LegGUIDVersion,
	lt.LegionellaAssetOutletID,
	lt.AssetOutletGUID,
	lt.AssetOutletGUIDVersion,
	lt.LegionellaLocationID,
	lt.LocationGUID,
	lt.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.TaskGUID,
	lt.TaskGUIDVersion,
	lrr.LegionellaRiskRatingID,
	ISNULL(lrr.Description, 'None') [RiskRating],
	'#' + ISNULL(lrr.RiskColour, 'CCCCCC') [RiskColour],
	lrr.SortOrder [RiskRatingSortOrder],
	j.JobNo,
	si.Address [SiteAddress],
	si.Postcode [SitePostcode],
	ISNULL(NULLIF(l.BuildingDesignation, ''), 'No Building Designation') [BuildingDesignation],
	ISNULL(NULLIF(ISNULL(la.SystemRef, lo.SystemRef), ''), 'N/A') [AssetOutletSystemRef],
	ISNULL(ISNULL(la.Location, ll.Location), '') [Location],
	ISNULL(lt.RiskDescription, 'N/A') [RiskDescription],
	ISNULL(lt.Action, 'N/A') [Action],
	lfc.LegionellaFrequencyCategoryID,
	ISNULL(lfc.Description, '') [FrequencyCategory],
	lpr.LegionellaPriorityRatingID,
	ISNULL(lpr.ShortDescription, 'None') [PriorityRating],
	'#' + ISNULL(lpr.PriorityColour, 'CCCCCC') [PriorityColour]
FROM
	(
		SELECT -- Get each Legionella Task record with the max GUID.
			lt.SiteID,
			lt.JobID,
			lt.RowType,
			lt.LegionellaID,
			lt.LegGUID,
			lt.LegGUIDVersion,
			lt.LegionellaAssetOutletID,
			lt.AssetOutletGUID,
			lt.AssetOutletGUIDVersion,
			lt.LegionellaLocationID,
			lt.LocationGUID,
			lt.LocationGUIDVersion,
			lt.LegionellaTaskID,
			lt.TaskGUID,
			lt.TaskGUIDVersion,
			lt.LegionellaRiskRatingID,
			lt.RiskDescription,
			lt.Action,
			lt.LegionellaFrequencyCategoryID,
			lt.LegionellaPriorityRatingID,
			ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
		FROM @LegionellaTasksData lt
	) lt
	INNER JOIN Job j WITH (NOLOCK) ON lt.JobID = j.JobID
	INNER JOIN Site si WITH (NOLOCK) ON lt.SiteID = si.SiteID
	INNER JOIN Legionella l WITH (NOLOCK) ON lt.LegionellaID = l.LegionellaID
	LEFT JOIN LegionellaAsset la WITH (NOLOCK) ON lt.LegionellaAssetOutletID = la.LegionellaAssetID AND lt.RowType = 2
	LEFT JOIN LegionellaLocation ll WITH (NOLOCK) ON lt.LegionellaLocationID = ll.LegionellaLocationID
	LEFT JOIN LegionellaOutlet lo WITH (NOLOCK) ON lt.LegionellaAssetOutletID = lo.LegionellaOutletID AND lt.RowType = 4
	LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
	LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
	LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
WHERE lt.RowID = 1

-- Start the main SELECT.
SELECT 
	dbo.FormatTEAMSReference('J',lrid.JobNo) [JobNo],
	lrid.SiteAddress,
	lrid.BuildingDesignation,
	lrid.AssetOutletSystemRef,
	lrid.Location,
	lrid.RiskDescription,
	lrid.Action,
	lrid.RiskRating,
	lrid.FrequencyCategory,
	lrid.PriorityRating
FROM 
	@LegionellaRiskItemsData lrid
ORDER BY 
	lrid.SiteID

    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'QuoteVisitType_CompletedJobs')
BEGIN
    EXEC('CREATE VIEW[dbo].[QuoteVisitType_CompletedJobs] AS SELECT 1 GO')
END
GO

ALTER View [dbo].[QuoteVisitType_CompletedJobs]
as
Select
	ISNULL(qvt.QuoteVisitTypeId, qt2.QuoteVisitTypeID) [QuoteVisitTypeID], 
	COALESCE(ac.Description, qvt.Description, qvt2.Description) [ReportType], 
	q.QuoteId as QuoteId,
	Cast(MIN(a.StartTime) as date) AS StartDate, 
	dbo.FormatTeamsDate(MIN(a.StartTime), 1) as StartDateChar,
	Cast(MAX(agt.DueDate) as date) AS DueDate, 
	dbo.FormatTeamsDate(MAX(agt.DueDate), 1) as DueDateChar,
	j.JobId,
	dbo.FormatTEAMSReference('J',j.JobNo) [JobNo],
	j.LastNoteCreated,
	dbo.New(j.LastNoteCreated) as LastNoteCreatedIsNew,
	j.BranchOfficeId,
	j.ProjectId,
	j.Created,
	c.ClientId,
	c.Client,
	s.SiteId,
    s.Postcode,
    s.UPRN,
    a.ClientOrderNo,
	s.Address as [Site],
	j.Status,
	oa_pdf.FileName
From 
	Quote q
	LEFT JOIN QuoteEmployee qe ON q.QuoteID=qe.QuoteID
	LEFT JOIN QuoteVisit qv ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
	LEFT JOIN QuoteVisitType qvt ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
	LEFT JOIN QuoteType qt2 ON q.QuoteTypeID = qt2.QuoteTypeID
	LEFT JOIN QuoteVisitType qvt2 ON qt2.QuoteVisitTypeID = qvt2.QuoteVisitTypeID
	LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID=qt.QuoteTypeID AND qt.Deleted IS NULL
    LEFT OUTER JOIN AppointmentCategory ac ON qt.QuoteType=ac.Description
	Inner Join Appointment a On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)
	INNER JOIN
	(
		Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag
			UNION
		Select null [DueDate], at.AppointmentID FROM AppointmentTraining at
	) agt ON agt.AppointmentID=a.AppointmentID
	INNER JOIN Job j ON j.JobID=q.JobID
    Left Outer Join Client c On a.ClientId = c.ClientId
    Left Outer Join Site s On a.SiteId = s.SiteId
	Outer Apply 
	(
		Select Top 1 [FileName] From PDF p Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
	) oa_pdf
Where
	a.ManuallyMarkWorkDone = 1
		And
	a.DateConfirmed IS NOT Null
		And
	a.DateDeclined Is Null
GROUP BY
	qvt.QuoteVisitTypeId, 
	qt2.QuoteVisitTypeID,
    COALESCE(ac.Description, qvt.Description, qvt2.Description),
	q.QuoteId,
	j.JobId,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeId,
	j.ProjectId,
	j.Created,
	c.ClientId,
	c.Client,
	s.SiteId,
    s.Postcode,
    s.UPRN,
    a.ClientOrderNo,
	s.Address,
	j.Status,
	oa_pdf.FileName

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_ManagementGetSites')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_ManagementGetSites] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMS_ManagementGetSites]
	@Client INT,
	@Project INT,
	@Site INT,
	@Filter varchar(max) = ''

AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

SET	@Client = ISNULL(@Client, 0)
SET	@Project = ISNULL(@Project, 0)
SET @Site = ISNULL(@Site, 0)

-- Start the main select
SELECT
	[SiteID] =			si.SiteID,
	[Address] =			si.Address,
	[Postcode] =		si.Postcode,
	[UPRN] =			si.UPRN,
	[PropertyType] =	pt.PropertyType
FROM
	Site si
	LEFT JOIN PropertyType pt ON si.PropertyTypeID = pt.PropertyTypeID
	INNER JOIN ClientSite cs ON si.SiteID = cs.SiteID
	LEFT JOIN ProjectSite ps ON si.SiteID = ps.SiteID
WHERE
	si.Deleted IS NULL
		AND
	((cs.ClientID = @Client) OR @Client = 0)
		AND
	((ps.ProjectID = @Project) OR @Project = 0)
		AND
	((si.SiteID = @Site) OR @Site = 0)
		AND
	(
		CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE
			CASE WHEN
				(
					si.Address LIKE '%' + @Filter + '%'
						OR
					si.Postcode LIKE '%' + @Filter + '%'
						OR
					si.Address + ', ' + si.Postcode LIKE '%' + @Filter + '%'
						OR
					si.UPRN = @Filter
				) THEN 1 ELSE 0 END
			END = 1
	)
GROUP BY
	si.SiteID,
	si.Address,
	si.Postcode,
	si.UPRN,
	pt.PropertyType

SET NOCOUNT OFF;
END
GO

-- tblfn_getContactGroupEmails function
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type='TF' AND name='tblfn_getContactGroupEmails')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[tblfn_getContactGroupEmails] (@additionalContactInfoID_forGroup int) RETURNS @rezTable TABLE(N INT) AS BEGIN  RETURN END')
END
GO

ALTER FUNCTION [dbo].[tblfn_getContactGroupEmails](@additionalContactInfoID_forGroup int)

RETURNS @rezTable TABLE(contacts varchar(MAX),emails varchar(MAX),sendString varchar(max))
AS
BEGIN
    --debug
        --DECLARE @additionalContactInfoID_forGroup int
        --SET @additionalContactInfoID_forGroup = 323
    --end debug
    
    
    DECLARE @contact_TypeId_ForGroup [int]
    SELECT @contact_TypeId_ForGroup = additionalcontacttypeid FROM [dbo].[AdditionalContactType] WHERE [ContactTypeDescription] = 'Contact Group'
    
    --DECLARE @contacts varchar(MAX),@emails varchar(MAX),@sendString varchar(MAX)
    
    INSERT INTO
        @rezTable ([contacts], [emails], [sendString])
        SELECT 
            STUFF(
                (
                    SELECT (
                            SELECT distinct
                                ', ' + [acm].[Contact]
                            FROM 
                                [dbo].[AdditionalContactInfo] ac 
                                INNER JOIN [dbo].[AdditionalContactGroupLinks] acgl ON [acgl].[AdditionalContactInfoId_forGroup] = [ac].[AdditionalContactInfoID]
                                INNER JOIN [dbo].[AdditionalContactInfo] acm ON acgl.[AdditionalContactInfoId_forMember]= [acm].[AdditionalContactInfoID]
                            WHERE 
                                ac.additionalcontactinfoid = @additionalContactInfoID_forGroup AND [ac].[AdditionalContactTypeID] = @contact_TypeId_ForGroup
                                AND rtrim(ltrim(ISNULL(acm.email,'')))!='' AND acm.Deleted IS NULL
                            FOR XML PATH(''),root('root'),type
                            ).value('.','varchar(max)')
                )
                ,1,2,''     
             ),
            STUFF(
                (
                    SELECT (
                            SELECT distinct
                                ', ' + [acm].[Email]
                            FROM 
                                [dbo].[AdditionalContactInfo] ac 
                                INNER JOIN [dbo].[AdditionalContactGroupLinks] acgl ON [acgl].[AdditionalContactInfoId_forGroup] = [ac].[AdditionalContactInfoID]
                                INNER JOIN [dbo].[AdditionalContactInfo] acm ON acgl.[AdditionalContactInfoId_forMember]= [acm].[AdditionalContactInfoID]
                            WHERE 
                                ac.additionalcontactinfoid = @additionalContactInfoID_forGroup AND [ac].[AdditionalContactTypeID] = @contact_TypeId_ForGroup
                                AND rtrim(ltrim(ISNULL(acm.email,'')))!='' AND acm.Deleted IS NULL
                            FOR XML PATH(''),root('root'),type
                            ).value('.','varchar(max)')
                )
                ,1,2,''     
             ),
            STUFF(
                (
                    SELECT (
                            SELECT DISTINCT
                                '; ' + [acm].[Contact]  + ' <' + [acm].[Email] + '>'
                            FROM 
                                [dbo].[AdditionalContactInfo] ac 
                                INNER JOIN [dbo].[AdditionalContactGroupLinks] acgl ON [acgl].[AdditionalContactInfoId_forGroup] = [ac].[AdditionalContactInfoID]
                                INNER JOIN [dbo].[AdditionalContactInfo] acm ON acgl.[AdditionalContactInfoId_forMember]= [acm].[AdditionalContactInfoID]
                            WHERE 
                                ac.additionalcontactinfoid = @additionalContactInfoID_forGroup AND [ac].[AdditionalContactTypeID] = @contact_TypeId_ForGroup
                                AND rtrim(ltrim(ISNULL(acm.email,'')))!='' AND acm.Deleted IS NULL
                            FOR XML PATH(''),root('root'),type
                            ).value('.','varchar(max)')
                )
                ,1,2,''     
             )
             
    return 
end
GO


-- getClientEmailFromJobIDOrInvoiceID procedure
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'getClientEmailFromJobIDOrInvoiceID')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[getClientEmailFromJobIDOrInvoiceID] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[getClientEmailFromJobIDOrInvoiceID]
	@jobid INT = NULL,
	@invoiceid INT = NULL

AS
BEGIN
    SET NOCOUNT ON
    --debug
        --DECLARE @jobid int, @invoiceid int        
        --SET @jobid = 39090
    --end debug
    
    DECLARE @clientid [int]
    DECLARE @contactID [int]
    DECLARE @client varchar(max)
    DECLARE @contact varchar(max)
    DECLARE @email varchar(MAX)
    DECLARE @address varchar(max)
    DECLARE @jobno varchar(max)
    DECLARE @invoiceno varchar(MAX)
    
    DECLARE @isJob AS bit=0,@isAirTest AS bit=0, @isInvoice AS bit=0,@isbulk AS bit=0
    
    set @client =NULL 
    set @contact =NULL 
    set @email =NULL 
    set @address =NULL 
    SET @jobno =NULL 
    set @invoiceno =NULL 
    
    /*GET DEFAULTS contactid FROM WORK ITEM LEVEL
    */
    
    IF NOT @invoiceid IS NULL
    BEGIN
        SELECT
            @invoiceno = [dbo].[FormatTeamsReference]('I',[i].InvoiceNo),
            @clientid=[i].[ClientID],
            @contactID = [i].[ContactId],
            @address = ''
        FROM 
            invoice i 
        WHERE 
            [i].[invoiceid] = @invoiceid
        
        SELECT @isInvoice = 1
    END
    ELSE
    BEGIN
        IF NOT @jobid IS NULL
        BEGIN

            SELECT 
                @jobno = [dbo].[FormatTeamsReference]('J',j.jobno),
                @clientid=[j].[ClientID],
                @contactID = [j].[ContactId],
                @address = [si].[Address],
                @isJob = CASE WHEN qt.[quotetypeid]!=5 THEN 1 ELSE 0 END ,
                @isAirTest = CASE WHEN qt.[quotetypeid] = 5 THEN 1 ELSE 0 end
            FROM 
                [dbo].[Job] j 
                INNER JOIN [dbo].[Quote] q ON j.[JobID] = [q].[JobID]
                INNER JOIN [dbo].[Site] si ON [si].[SiteID] = [j].[SiteID]
                INNER JOIN [dbo].[QuoteType] qt ON q.[QuoteTypeID]= [qt].[quotetypeid]
                --LEFT OUTER JOIN 
                --( 
                    --SELECT TOP 1
                        --je.JobID,
                        --CASE WHEN reg.[RegisterID] IS NOT NULL  THEN 
                            --1
                        --ELSE
                            --0
                        --END,
                        --CASE WHEN airt.[AirTestID] IS NOT NULL  THEN 
                            --1
                        --ELSE
                            --0
                        --END
                    --FROM 
                        --dbo.JobEmployee je
                        --LEFT OUTER JOIN dbo.Register reg ON reg.JobEmployeeID = je.JobEmployeeID
                        --LEFT OUTER JOIN dbo.AirTest airt ON airt.JobEmployeeID = je.JobEmployeeID
                    --WHERE
                        --NOT (reg.RegisterID IS NULL AND airt.AirTestID IS NULL) 
                --) firstreg(jobid, job, airtest) ON j.JobID = firstreg.jobid
            WHERE [j].[JobID] = @jobid


            IF @isJob=1
            BEGIN
                --is a job, but it is a bulk survey (has rooms but no floors)
                
                    if not EXISTS(
                        SELECT TOP 1 
                            'x'
                        FROM
                            [dbo].[Job] _j
                            INNER JOIN jobemployee _je ON [_j].[JobID] = _je.[JobID]
                            INNER JOIN [dbo].[Register] _reg ON [_reg].[JobEmployeeID] = [_je].[JobEmployeeID]
                            INNER JOIN [dbo].[Room] _room ON [_room].[RegisterID] = [_reg].[RegisterID]
                            INNER JOIN [dbo].[Floorplan] _fp ON _room.[RegisterID] = _fp.[RegisterID]
                        WHERE
                            _j.jobid = @jobid
                    )
                    begin
                        SELECT
                            @isbulk = 1,
                            @isJob = 0
                            
                        --print 'isbulk'
                    END
                    --ELSE
                    --BEGIN
                        --print 'isjob '    
                    --END 
            END 
            
            
        END
    END 
    
    /*now get from the client, default contact info and email with client name along with client overrides*/
    DECLARE 
        @ApprovalEmailSurvey_USE_MainContact                AS bit,
        @ApprovalEMailAirTest_USE_MainContact               AS bit,
        @ApprovalEmailBulk_USE_MainContact                  AS bit,
        @InvoiceCompleteEmail_USE_MainContact               AS bit,
        @ApprovalEmailSurvey_AdditionalContactInfoID        AS int,
        @ApprovalEMailAirTest_AdditionalContactInfoID       AS int,
        @ApprovalEmailBulk_AdditionalContactInfoID          AS int,
        @InvoiceCompleteEmail_AdditionalContactInfoID       AS int
        
            
    SELECT
        @client = [c].[Client],
        @contact =  c.MainContact, 
        @email = ISNULL(c.MainContact,'')  + ' <' + [c].[Email] + '>',
        @ApprovalEmailSurvey_USE_MainContact             =   isnull(ApprovalEmailSurvey_USE_MainContact,0),
        @ApprovalEMailAirTest_USE_MainContact            =   isnull(ApprovalEMailAirTest_USE_MainContact,0),
        @ApprovalEmailBulk_USE_MainContact               =   isnull(ApprovalEmailBulk_USE_MainContact,0),
        @InvoiceCompleteEmail_USE_MainContact            =   ISNULL(InvoiceCompleteEmail_USE_MainContact,0),
        @ApprovalEmailSurvey_AdditionalContactInfoID     =   ApprovalEmailSurvey_AdditionalContactInfoID ,
        @ApprovalEMailAirTest_AdditionalContactInfoID    =   ApprovalEMailAirTest_AdditionalContactInfoID ,
        @ApprovalEmailBulk_AdditionalContactInfoID       =   ApprovalEmailBulk_AdditionalContactInfoID ,
        @InvoiceCompleteEmail_AdditionalContactInfoID    =   InvoiceCompleteEmail_AdditionalContactInfoID
    FROM 
        [dbo].[Client] c
    WHERE
        [c].[ClientID] = @clientid
    
    /*
    SELECT

        @ApprovalEmailSurvey_USE_MainContact            [@ApprovalEmailSurvey_USE_MainContact],
        @ApprovalEMailAirTest_USE_MainContact           [@ApprovalEMailAirTest_USE_MainContact],
        @ApprovalEmailBulk_USE_MainContact              [@ApprovalEmailBulk_USE_MainContact],
        @InvoiceCompleteEmail_USE_MainContact           [@InvoiceCompleteEmail_USE_MainContact],
        @ApprovalEmailSurvey_AdditionalContactInfoID    [@ApprovalEmailSurvey_AdditionalContactInfoID],
        @ApprovalEMailAirTest_AdditionalContactInfoID   [@ApprovalEMailAirTest_AdditionalContactInfoID],
        @ApprovalEmailBulk_AdditionalContactInfoID      [@ApprovalEmailBulk_AdditionalContactInfoID],
        @InvoiceCompleteEmail_AdditionalContactInfoID   [@InvoiceCompleteEmail_AdditionalContactInfoID],
        @isJob                                          [@isJob],
        @isAirTest                                      [@isAirTest],
        @isbulk                                         [@isbulk],
        @isbulk                                         [@isbulk]

    */
    /*check the client over rides*/
    IF (
        (@ApprovalEmailSurvey_USE_MainContact = 1 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NULL AND @isJob=1) or
        (@ApprovalEMailAirTest_USE_MainContact = 1 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NULL AND @isAirTest=1) or
        (@ApprovalEmailBulk_USE_MainContact = 1 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NULL AND @isbulk=1) or
        (@InvoiceCompleteEmail_USE_MainContact = 1 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NULL AND @isInvoice=1)
       )
    BEGIN 
        --default client is forced to be used by the client config
        SET @contactID= NULL 
        --print 'client override use main contact'
    END 
    ELSE
    BEGIN 
        IF (
            (@ApprovalEmailSurvey_USE_MainContact = 0 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NOT NULL AND @isJob=1) or
            (@ApprovalEMailAirTest_USE_MainContact = 0 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NOT NULL AND @isAirTest=1) or
            (@ApprovalEmailBulk_USE_MainContact = 0 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NOT NULL AND @isbulk=1) or
            (@InvoiceCompleteEmail_USE_MainContact = 0 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NOT NULL AND @isInvoice=1)
           )
        BEGIN 
            --client has a forced contactid use that overriding anything else
            IF (@ApprovalEmailSurvey_USE_MainContact = 0 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NOT NULL AND @isJob=1) 
                    select @contactid = @ApprovalEmailSurvey_AdditionalContactInfoID
            IF (@ApprovalEMailAirTest_USE_MainContact = 0 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NOT NULL AND @isAirTest=1) 
                    select @contactid = @ApprovalEMailAirTest_AdditionalContactInfoID
            IF (@ApprovalEmailBulk_USE_MainContact = 0 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NOT NULL AND @isbulk=1) 
                    select @contactid = @ApprovalEmailBulk_AdditionalContactInfoID
            IF (@InvoiceCompleteEmail_USE_MainContact = 0 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NOT NULL AND @isInvoice=1) 
                    select @contactID = @InvoiceCompleteEmail_AdditionalContactInfoID
            --print 'client override additional contact'
        END 
    END 
    --print 'using contactid ' + CAST(@contactID AS varchar)
    
    /*
    with the flow from above by the time we have gotten here, the contact inforation will be set for the default client, or a contactid will be set from the job or client override
    */
    
    IF EXISTS(SELECT 'x' FROM  [dbo].[AdditionalContactInfo] WHERE AdditionalContactTypeID=1 AND [AdditionalContactInfoID] = @contactID AND Deleted IS NULL)
    BEGIN
        --single contact is used
        SELECT 
            @contact=aci.[Contact], 
            @email= ISNULL([aci].[Contact],'')  + ' <' + [aci].[Email] + '>'
        FROM 
            AdditionalContactInfo aci
        WHERE 
            aci.AdditionalContactTypeID=1 AND 
            [aci].[AdditionalContactInfoID] = @contactID
            AND LTRIM(rtrim(ISNULL([aci].[Email],'')))!=''
			AND Deleted IS NULL
         
         --print 'single contact'
    END
    ELSE
    BEGIN
        --csv of email addresses used.
        DECLARE @contact_TypeId_ForGroup [int]
        SELECT @contact_TypeId_ForGroup = additionalcontacttypeid FROM [dbo].[AdditionalContactType] WHERE [ContactTypeDescription] = 'Contact Group'
    
        IF EXISTS(SELECT 'x' FROM  [dbo].[AdditionalContactInfo] WHERE AdditionalContactTypeID=@contact_TypeId_ForGroup AND [AdditionalContactInfoID] = @contactID AND Deleted IS NULL)
        BEGIN
            select 
                @contact = x.[contacts],
                @email = x.sendstring
            FROM 
               tblfn_getContactGroupEmails(@contactID) x
        END 
        --print 'contact group'
    END 
    
    SELECT
        @client [Client],
        @contact [Contact],
        @email [Email],
        @address [Address],
        coalesce(@invoiceno,@jobno)ref,
        c.s__CompanyName,
        c.s__CompanyAddress,
        c.s__CompanyTelephone,
        c.s__CompanyEmail,
        c.b__TEAMSPortalHTTPS,
        c.s__TEAMSPortalhost
    FROM
        (
            SELECT TOP 1
                config.s__CompanyName, 
                config.s__CompanyAddress,
                config.s__CompanyTelephone,
                config.s__CompanyEmail,
                config.b__TEAMSPortalHTTPS,
                config.s__TEAMSPortalHost
            FROM 
                config
        )c
        
    SET NOCOUNT off
end
GO

IF not exists(select * from teamsv2subtab where tabtext = 'Work In Progress' AND Teamsv2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Other Services'))
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], IsMvcTab, IsHidden, EnableMvcGrid)
    VALUES
    ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Other Services'), 'Work In Progress', 1, 1, 0, 1)
END
GO

IF not exists(select * from teamsv2subtab where tabtext = 'Completed Jobs' AND Teamsv2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Other Services'))
BEGIN
    INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], IsMvcTab, IsHidden, EnableMvcGrid)
    VALUES
    ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Other Services'), 'Completed Jobs', 2, 1, 0, 1)
END
GO



IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesWorkInProgress')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
	DECLARE @UseDefaultOrdering INT = 0

    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))    
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesCompletedJobs')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
	DECLARE @UseDefaultOrdering INT = 0

    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))    
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO

-- New columns for new legionella portal chart
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__DisplayPortalLegActionPrioritiesGraph' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD b__DisplayPortalLegActionPrioritiesGraph BIT NOT NULL DEFAULT 0
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'b__DisplayPortalLegSitesSurveyedGraph' AND object_id = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE Config
    ADD [b__DisplayPortalLegSitesSurveyedGraph] [bit] NOT NULL DEFAULT 0
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'LegActionPrioritiesChart' AND object_id = OBJECT_ID('PortalUser'))
BEGIN
    ALTER TABLE PortalUser
    ADD LegActionPrioritiesChart BIT NOT NULL DEFAULT 0
END
GO
IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'LegSitesSurveyedChart' AND object_id = OBJECT_ID('PortalUser'))
BEGIN
    ALTER TABLE PortalUser
    ADD LegSitesSurveyedChart BIT NOT NULL DEFAULT 0
END
GO

-- New table TeamsV2SubSubTab
IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='TeamsV2SubSubTab'))
BEGIN
    CREATE TABLE [dbo].[TeamsV2SubSubTab](
        [TeamsV2SubSubTabID] [int] IDENTITY(1,1) NOT NULL,
        [TeamsV2SubTabID] [int] NOT NULL,
        [TabText] [varchar](50) NOT NULL,
        [Order] [int] NOT NULL,
        [DateDeleted] [datetime] NULL,
        [IsMvcTab] [bit] NULL,
        [IsHidden] [bit] NOT NULL,
        [EnableMvcGrid] [bit] NULL,
    PRIMARY KEY CLUSTERED 
    (
        [TeamsV2SubSubTabID] ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
    ) ON [PRIMARY]
    INSERT [dbo].[TeamsV2SubSubTab] ([TeamsV2SubTabID], [TabText], [Order], [DateDeleted], [IsMvcTab], [IsHidden], [EnableMvcGrid]) 
    VALUES 
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Job Wizard', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Remove Job', 2, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Add To Project', 3, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Merge Site', 4, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Supplementary Reason', 5, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Remove No Access', 6, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Move Air Test', 7, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Job Tools'), N'Move Site Log', 8, NULL, 1, 1, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Unapprove Report', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Remove Report Content', 2, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Move Register', 3, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Change Survey Type', 4, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Remove PDFs', 5, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Report Tools'), N'Offline Report Generation Queue', 6, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Invoice Tools'), N'Mark Invoice as Incomplete', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Invoice Tools'), N'Un-Discard Invoice', 2, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Invoice Tools'), N'Undelete Invoice Item', 3, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Quote Tools'), N'Quote Wizard', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Quote Tools'), N'Quote Project Tool', 2, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Quote Tools'), N'Undelete Invoice Item', 3, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Quote Tools'), N'Update Quote to Latest Template', 4, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Quote Tools'), N'Update Quote to Latest Method Statement', 5, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Sample Tools'), N'Remove Sample Analysis', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Staff Tools'), N'Restore Deleted Employee', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Update Client Order Number', 1, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Update Due Date', 2, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Update Sample Due Date', 3, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Unconfirm Appointment', 4, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Change Branch', 5, NULL, NULL, 0, NULL),
    ((select TeamsV2SubTabID from TeamsV2SubTab where TabText = 'Appointment Tools'), N'Unmark Appointment as complete', 6, NULL, NULL, 0, NULL)
    ALTER TABLE [dbo].[TeamsV2SubSubTab] ADD  CONSTRAINT [DF_TeamsV2SubSubTab_IsHidden]  DEFAULT ((0)) FOR [IsHidden]
END 

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Export_ProjectJobSheetSites')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Export_ProjectJobSheetSites] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Export_ProjectJobSheetSites]
	@ProjectGroupID INT = 0,
	@ProjectID INT = 0

WITH RECOMPILE
AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

SELECT
	[Address] =				REPLACE(REPLACE(REPLACE(si.Address, CHAR(10), ''), CHAR(13), ''), CHAR(9), ''),
	[Postcode] =			si.Postcode,
	[Telephone] =			si.Telephone,
	[Contact] =				si.Contact,
	[UPRN] =				si.UPRN,	
	[TEAMSUPRN] =			si.TEAMSUPRN
FROM
	Project p
	INNER JOIN Projectsite ps ON p.ProjectID = ps.ProjectID
	INNER JOIN Site si ON ps.SiteID = si.SiteID
WHERE
	p.ProjectGroupId = @ProjectGroupID
		AND
	(p.ProjectID = @ProjectID OR @ProjectID = 0)

SET NOCOUNT OFF;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'AppointmentColour' AND OBJECT_ID = OBJECT_ID('AirTestType'))
BEGIN
    ALTER TABLE AirTestType
    ADD [AppointmentColour] [varchar] (20) NULL;
END
GO



IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'Enquiries')
BEGIN
    EXEC('CREATE VIEW[dbo].[Enquiries] AS SELECT 1 GO')
END
GO

ALTER View [dbo].[Enquiries]
as
Select
	e.EnquiryID,
	e.EnquiryNo,

	e.ClientId,
	Coalesce(c.Client, e.Client) as Client,
	Coalesce(c.BranchName, e.ClientBranchName) as ClientBranchName,
	Coalesce(c.Address, e.ClientAddress) as ClientAddress,
	Coalesce(c.Postcode, e.ClientPostcode) as ClientPostcode,
	Coalesce(c.Email, e.ClientEmail) as ClientEmail,
	Coalesce(c.Telephone, e.ClientTelephone) as ClientTelephone,
	Coalesce(c.Fax, e.ClientFax) as ClientFax,
	Coalesce(c.MainContact, e.ClientMainContact) as ClientMainContact,
	
	e.SiteId,
	Coalesce(s.Address, e.SiteAddress) as SiteAddress,
	Coalesce(s.Postcode, e.SitePostcode) as SitePostcode,
	Coalesce(s.Telephone, e.SiteTelephone) as SiteTelephone,
	Coalesce(s.Contact, e.SiteContact) as SiteContact,
	Coalesce(s.UPRN, e.SiteUPRN) as SiteUPRN,
	
	e.QuoteTypeID,
	qt.QuoteType,
	e.DetailsOfWork,
	e.LikelihoodID,
	l.Description as Likelihood,
	es.Description as EnquirySource,
	e.EmployeeId,
	em.FullName as LeadEmployee,
	e.AssignedEmployeeId,
	em2.FullName as AssignedEmployee,
	e.QuoteID,
	q.QuoteNo,
	e.DateCreated as Created,
	e.DateAccepted as Accepted,
	e.DateDiscarded as Rejected,
	e.LastNoteCreated,
	e.DiscardReason	
From
	Enquiry e WITH (NOLOCK)
	Left Outer Join Client c WITH (NOLOCK) On e.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On e.SiteID = s.SiteId
	Left Outer Join QuoteType qt WITH (NOLOCK) On e.QuoteTypeID = qt.QuoteTypeId
	Left Outer Join Likelihood l WITH (NOLOCK) On e.LikelihoodID = l.LikelihoodID
	Left Outer Join EnquirySource es WITH (NOLOCK) On e.EnquirySourceID = es.EnquirySourceID
	Left Outer Join Employee em WITH (NOLOCK) On e.EnquiryEmployeeID = em.EmployeeID
	Left Outer Join Employee em2 WITH (NOLOCK) On e.AssignedEmployeeID = em2.EmployeeID
	Left Outer Join Quote q WITH (NOLOCK) On e.QuoteID = q.QuoteID

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetViewQuoteItems')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetViewQuoteItems] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetViewQuoteItems]
	-- Add the parameters for the stored procedure here
	@QuoteID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	DECLARE 
		@QuoteVisitID int = ISNULL((SELECT qv.QuoteVisitID FROM Quote q INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID = qe.QuoteID INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qe.QuoteEmployeeID = qv.QuoteEmployeeID WHERE q.QuoteID = @QuoteID), 0),
		@ClientID int = ISNULL((SELECT q.ClientID FROM Quote q WHERE q.QuoteID = @QuoteID), 0),
		@QuoteVisitTypeID int = ISNULL((SELECT qv.QuoteVisitTypeID FROM Quote q INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID = qe.QuoteID INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qe.QuoteEmployeeID = qv.QuoteEmployeeID WHERE q.QuoteID = @QuoteID), 0)

	IF (@QuoteVisitID > 0)
	BEGIN
		SELECT 
			qvis.ItemType,
			qvis.ItemId,
			qvis.Description,
			qvis.Cost,
			qvis.Qty,
			qvis.Total,
			qvis.locked,
			(qvis.Markup - 1) * 100 Markup,
			qvis.PercentageLocked,
			qvis.TotalPrice,
			Overall.OverallTotal,
			Overall.OverallTotalPrice
		FROM 
			QuoteVisitItems qvis
			OUTER APPLY
			(
				SELECT
					ISNULL(SUM(qvis2.Total), 0) OverallTotal,
					ISNULL(SUM(qvis2.TotalPrice), 0) OverallTotalPrice
				FROM
					QuoteVisitItems qvis2
				WHERE
					qvis2.QuoteVisitID = qvis.QuoteVisitID
			) Overall
		WHERE 
			qvis.QuoteVisitID = @QuoteVisitID 
		ORDER BY
			qvis.QuoteVisitSectionNo, 
			qvis.SortOrder, 
			qvis.ItemType, 
			qvis.ItemSortOrder, 
			qvis.Description

		-- This is only needed if this going to be used as a replacement for the 'Modify Quote Items' screen.
		--IF ((SELECT COUNT(*) FROM QuoteVisitItems qvis WHERE qvis.QuoteVisitID = @QuoteVisitID) = 0)
		--BEGIN

		--	-- Temp table to store the default quote visit items before inserting them into the database.
		--	DECLARE @DefaultQuoteVisitItems TABLE (RowID INT IDENTITY(1,1), ClientQuoteVisitTabEntryID INT, QuoteVisitTabEntryID INT, QuoteVisitTypeID INT, QuoteVisitTab VARCHAR(50), Description VARCHAR(MAX), Value MONEY, ValueField VARCHAR(15), QuoteVisitSection BIT, Locked BIT, DefaultPercentageMarkup DECIMAL(6, 4), PercentageLocked BIT, DirectCost BIT, SortOrder INT, SplitOnInvoice BIT)
		--	INSERT INTO @DefaultQuoteVisitItems
		--	SELECT
		--		qvtec.QuoteVisitTabEntryID ClientQuoteVisitTabEntryID,
		--		qvte.QuoteVisitTabEntryID,
		--		qvte.QuoteVisitTypeID,
		--		qvte.QuoteVisitTab,
		--		qvte.Description,
		--		COALESCE(qvtec.Value, qvte.Value) Value,
		--		COALESCE(qvtec.ValueField, qvte.ValueField) ValueField,
		--		qvte.QuoteVisitSection,
		--		qvte.Locked,
		--		COALESCE(qvtec.DefaultPercentageMarkup, qvte.DefaultPercentageMarkup, 1) DefaultPercentageMarkup,
		--		COALESCE(qvtec.PercentageLocked, qvte.PercentageLocked) PercentageLocked,
		--		qvte.DirectCost,
		--		qvte.SortOrder,
		--		qvte.SplitOnInvoice
		--	FROM
		--		QuoteVisitTabEntry qvte
		--		LEFT JOIN QuoteVisitTabEntryClient qvtec WITH (NOLOCK) ON qvte.QuoteVisitTabEntryID = qvtec.QuoteVisitTabEntryID AND qvte.ValueField = qvtec.ValueField AND qvtec.clientid = @ClientID
		--	WHERE
		--		qvte.Site = 1
		--			AND
		--		qvte.QuoteVisitTypeID = @QuoteVisitTypeID
		--			AND
		--		qvte.Deleted IS NULL

		--	SELECT * FROM @DefaultQuoteVisitItems

		--	--Insert the default quote visit items into the database.
		--	DECLARE
		--		@Counter INT = 1, @MaxID INT = (SELECT COUNT(*) FROM @DefaultQuoteVisitItems)

		--	WHILE (@Counter <= @MaxID)
		--	BEGIN
		--		DECLARE
		--			@SQL VARCHAR(MAX) = (
		--				SELECT
		--					'INSERT INTO QuoteVisit' + dqvi.QuoteVisitTab + ' (QuoteVisitID, Description, ' + dqvi.ValueField + ', Locked, Markup, PercentageLocked, SortOrder, SplitOnInvoice) VALUES (' + CAST(@QuoteVisitID AS VARCHAR(MAX)) + ', '' + dqvi.Description + '', ' + CAST(dqvi.Value AS VARCHAR(MAX)) + ', ' + CAST(dqvi.Locked AS VARCHAR(1)) + ', ' + CAST(dqvi.DefaultPercentageMarkup AS VARCHAR(MAX)) + ', ' + CAST(dqvi.PercentageLocked AS VARCHAR(1)) + ', ' + CAST(dqvi.SortOrder AS VARCHAR(MAX)) + ', ' + CAST(dqvi.SplitOnInvoice AS VARCHAR(1)) + ')'
		--				FROM
		--					@DefaultQuoteVisitItems dqvi
		--				WHERE
		--					dqvi.RowID = @Counter
		--			)

		--			--SELECT @SQL
		--			EXEC (@SQL)

		--			-- Increment the counter to move to the next row
		--			SET @Counter = @Counter + 1
		--	END

		--END
	END
	ELSE
	BEGIN
		SELECT 
			'QuoteItem' ItemType,
			qi.QuoteItemID ItemID,
			qi.Description,
			qi.Price Cost,
			qi.Qty,
			qi.Price * qi.Qty Total,
			0 Locked,
			null Markup,
			0 PercentageLocked,
			null TotalPrice,
			Overall.OverallTotal,
			null OverallTotalPrice
		FROM
			QuoteItem qi
			OUTER APPLY
			(
				SELECT
					ISNULL(SUM(qi2.Price * qi2.Qty), 0) OverallTotal
				FROM
					QuoteItem qi2
				WHERE
					qi2.QuoteID = qi.QuoteID
			) Overall
		WHERE
			qi.QuoteID = @QuoteID
	END
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='BackupLocationType'))
BEGIN
    CREATE TABLE [dbo].[BackupLocationType](
        [BackupLocationTypeID] [int] NOT NULL,
        [Type] [varchar](max) NULL,
        [Location] [varchar](max) NULL,
    CONSTRAINT [PK_BackupLocationType] PRIMARY KEY CLUSTERED 
    (
        [BackupLocationTypeID] ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='BackupLog'))
BEGIN
    CREATE TABLE [dbo].[BackupLog](
        [BackupLogID] [int] IDENTITY(1,1) NOT NULL,
        [BackupLocationTypeID] [int] NOT NULL,
        [DatePassed] [datetime] NULL,
        [DateFailed] [datetime] NULL,
        [FailedDescription] [varchar](max) NULL,
    CONSTRAINT [PK_BackupLog] PRIMARY KEY CLUSTERED 
    (
        [BackupLogID] ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetBackupLogEntries')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetBackupLogEntries] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetBackupLogEntries]
	-- Add the parameters for the stored procedure here
	@BackupLogType int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	-- Get a list of the dates that we need to check against
	DECLARE @BackupLogDates table (RowID int identity(1, 1), BackupDate datetime, BackUpType int, NewBackupDate datetime, WeekendDay bit)
	
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -6, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -5, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -4, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -3, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -2, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -1, GETDATE()), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (GETDATE(), 1, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -6, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -5, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -4, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -3, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -2, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -1, GETDATE()), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (GETDATE(), 2, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -6, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -5, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -4, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -3, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -2, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (DATEADD(DAY, -1, GETDATE()), 3, 0)
	INSERT INTO @BackupLogDates (BackupDate, BackUpType, WeekendDay) VALUES (GETDATE(), 3, 0)

	-- Insert a new backup date for any dates that are on a weekend
	DECLARE @tempBackupLogType int = 1
	WHILE @tempBackupLogType <= 3
	BEGIN
		UPDATE @BackupLogDates
		SET NewBackupDate = (DATEADD(day, -(SELECT COUNT(*) FROM @BackupLogDates bld2 WHERE DATEPART(dw, bld2.BackupDate) IN (1,7) AND bld2.BackUpType = @tempBackupLogType), BackupDate)), WeekendDay = 1
		WHERE
			DATEPART(dw, BackupDate) IN (1,7)
				AND
			BackUpType = @tempBackupLogType

		SET @tempBackupLogType = @tempBackupLogType + 1;
	END

	-- Remove any weekend days
	DELETE FROM @BackupLogDates WHERE WeekendDay = 1

	-- Get whether the backup was successful or not for the dates in the table above
	DECLARE @BackupLog table (RowID int identity(1, 1), BackupLogType int, BackupUpDate datetime, Result varchar(20), ErrorMessage varchar(max))

	INSERT INTO @BackupLog (BackupLogType, BackupUpDate, Result, ErrorMessage)
	SELECT
		bld.BackUpType,
		ISNULL(bld.NewBackupDate, bld.BackupDate) BackUpDate,
		(CASE 
			WHEN Success.Success IS NOT NULL
			THEN 'SUCCESS' 
			ELSE
				CASE
					WHEN Failed.Failed IS NOT NULL
					THEN 'FAILED'
					ELSE 'NOT CONFIGURED'
					END
			END),
		Failed.FailedDescription
	FROM
		@BackupLogDates bld
		OUTER APPLY
		(
			SELECT TOP 1
				COALESCE(DateFailed, DatePassed, GETDATE()) Date
			FROM
				BackupLog bl
			WHERE
				(DATEPART(DAY, COALESCE(DateFailed, DatePassed, GETDATE())) = DATEPART(DAY, bld.BackupDate))
					AND
				(DATEPART(MONTH, COALESCE(DateFailed, DatePassed, GETDATE())) = DATEPART(MONTH, bld.BackupDate))
					AND
				(DATEPART(YEAR, COALESCE(DateFailed, DatePassed, GETDATE())) = DATEPART(YEAR, bld.BackupDate))
					AND
				bl.BackupLocationTypeID = bld.BackUpType
			ORDER BY
				COALESCE(DateFailed, DatePassed, GETDATE()) DESC
		) MaxDate
		OUTER APPLY
		(
			SELECT TOP 1
				'SUCCESS' Success
			FROM
				BackupLog bl
			WHERE
				(DATEPART(DAY, bl.DatePassed) = DATEPART(DAY, bld.BackupDate))
					AND
				(DATEPART(MONTH, bl.DatePassed) = DATEPART(MONTH, bld.BackupDate))
					AND
				(DATEPART(YEAR, bl.DatePassed) = DATEPART(YEAR, bld.BackupDate))
					AND
				bl.BackupLocationTypeID = bld.BackUpType
					AND
				(DATEPART(DAY, bl.DatePassed) = DATEPART(DAY, bld.BackupDate))
					AND
				(DATEPART(MONTH, bl.DatePassed) = DATEPART(MONTH, bld.BackupDate))
					AND
				(DATEPART(YEAR, bl.DatePassed) = DATEPART(YEAR, bld.BackupDate))
			ORDER BY
				bl.DatePassed DESC
			
		) Success
		OUTER APPLY
		(
			SELECT TOP 1
				'FAILED' Failed,
				bl.FailedDescription
			FROM
				BackupLog bl
			WHERE
				(DATEPART(DAY, bl.DateFailed) = DATEPART(DAY, bld.BackupDate))
					AND
				(DATEPART(MONTH, bl.DateFailed) = DATEPART(MONTH, bld.BackupDate))
					AND
				(DATEPART(YEAR, bl.DateFailed) = DATEPART(YEAR, bld.BackupDate))
					AND
				bl.BackupLocationTypeID = bld.BackUpType
					AND
				(DATEPART(DAY, bl.DateFailed) = DATEPART(DAY, bld.BackupDate))
					AND
				(DATEPART(MONTH, bl.DateFailed) = DATEPART(MONTH, bld.BackupDate))
					AND
				(DATEPART(YEAR, bl.DateFailed) = DATEPART(YEAR, bld.BackupDate))
			ORDER BY
				bl.DateFailed DESC
			
		) Failed
	WHERE
		(CASE
			WHEN @BackupLogType = 0
			THEN 1
			ELSE CASE WHEN bld.BackUpType = @BackupLogType THEN 1 ELSE 0 END
		END) = 1

	DECLARE
		@LatestBackupDate DATETIME = (SELECT MAX(BackupUpDate) FROM @BackupLog)

	SELECT
		*,
		(CASE WHEN (SELECT COUNT(*) FROM @BackupLog bl WHERE DATEPART(DAY, bl.BackupUpDate) = DATEPART(DAY, @LatestBackupDate) AND DATEPART(MONTH, bl.BackupUpDate) = DATEPART(MONTH, @LatestBackupDate) AND DATEPART(YEAR, bl.BackupUpDate) = DATEPART(YEAR, @LatestBackupDate) AND bl.Result = 'SUCCESS') = 3 THEN 'SUCCESS' ELSE CASE WHEN (SELECT COUNT(*) FROM BackupLog bl) > 0 THEN 'NOT SUCCESSFUL' ELSE 'NOT SETUP' END END) [Overall],
		(CASE WHEN (SELECT COUNT(*) FROM @BackupLog bl WHERE bl.BackupLogType = 1 AND DATEPART(DAY, bl.BackupUpDate) = DATEPART(DAY, @LatestBackupDate) AND DATEPART(MONTH, bl.BackupUpDate) = DATEPART(MONTH, @LatestBackupDate) AND DATEPART(YEAR, bl.BackupUpDate) = DATEPART(YEAR, @LatestBackupDate) AND bl.Result = 'SUCCESS') = 1 THEN 'SUCCESS' ELSE CASE WHEN (SELECT COUNT(*) FROM BackupLog bl WHERE bl.BackupLocationTypeID = 1) > 0 THEN 'NOT SUCCESSFUL' ELSE 'NOT SETUP' END END) [DBLocalOverall],
		(CASE WHEN (SELECT COUNT(*) FROM @BackupLog bl WHERE bl.BackupLogType = 2 AND DATEPART(DAY, bl.BackupUpDate) = DATEPART(DAY, @LatestBackupDate) AND DATEPART(MONTH, bl.BackupUpDate) = DATEPART(MONTH, @LatestBackupDate) AND DATEPART(YEAR, bl.BackupUpDate) = DATEPART(YEAR, @LatestBackupDate) AND bl.Result = 'SUCCESS') = 1 THEN 'SUCCESS' ELSE CASE WHEN (SELECT COUNT(*) FROM BackupLog bl WHERE bl.BackupLocationTypeID = 2) > 0 THEN 'NOT SUCCESSFUL' ELSE 'NOT SETUP' END END) [DBNetworkOverall],
		(CASE WHEN (SELECT COUNT(*) FROM @BackupLog bl WHERE bl.BackupLogType = 3 AND DATEPART(DAY, bl.BackupUpDate) = DATEPART(DAY, @LatestBackupDate) AND DATEPART(MONTH, bl.BackupUpDate) = DATEPART(MONTH, @LatestBackupDate) AND DATEPART(YEAR, bl.BackupUpDate) = DATEPART(YEAR, @LatestBackupDate) AND bl.Result = 'SUCCESS') = 1 THEN 'SUCCESS' ELSE CASE WHEN (SELECT COUNT(*) FROM BackupLog bl WHERE bl.BackupLocationTypeID = 3) > 0 THEN 'NOT SUCCESSFUL' ELSE 'NOT SETUP' END END) [CSNetworkOverall]--,
		--DATENAME(dw, bl.BackupUpDate),
		--DATEPART(dw, bl.BackupUpDate)
	FROM
		@BackupLog bl
	WHERE
		(CASE
			WHEN @BackupLogType = 0
			THEN 1
			ELSE CASE WHEN bl.BackUpLogType = @BackupLogType THEN 1 ELSE 0 END
		END) = 1
	ORDER BY
		BackupLogType,
		BackupUpDate DESC
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GetAdditionalClientContactsGridData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GetAdditionalClientContactsGridData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetAdditionalClientContactsGridData]
	-- Add the parameters for the stored procedure here
	@ClientID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT
		groups.Names [Groups],
		aci.AdditionalContactInfoID,
		aci.Contact,
		'Client - ' + c.Client [ClientDescription],
		aci.Email,
		aci.Phone,
		aci.Salutation,
		aci.ContactAddress,
		aci.ContactPostcode,
		c.ClientID
	FROM
		AdditionalContactInfo aci
		INNER JOIN Client c WITH (NOLOCK) ON aci.LinkID = c.ClientID
		OUTER APPLY
		(SELECT
			STUFF(
				(
					SELECT
						', ' + aci2.Contact
					FROM
						AdditionalContactInfo aci2
						INNER JOIN AdditionalContactGroupLinks acgl WITH (NOLOCK) ON aci2.AdditionalContactInfoID = acgl.AdditionalContactInfoId_forGroup
					WHERE
						aci.Deleted IS NULL
							AND
						aci2.AdditionalContactTypeID = (SELECT AdditionalContactTypeID FROM AdditionalContactType act2 WHERE act2.ContactTypeDescription = 'Contact Group' AND act2.Deleted IS NULL)
							AND
						aci2.LinkID = @ClientID
							AND
						acgl.AdditionalContactInfoId_forMember = aci.AdditionalContactInfoID
							AND
						aci2.b_isTemp = 0
					FOR XML PATH(''), TYPE
				).value('.', 'nvarchar(max)'),
				1,
				1,
				''
			)
		) [groups](names)
	WHERE
		aci.b_isTemp = 0
			AND
		aci.Deleted IS NULL
			AND
		aci.AdditionalContactTypeID = (SELECT AdditionalContactTypeID FROM AdditionalContactType act2 WHERE act2.ContactTypeDescription = 'Client' AND act2.Deleted IS NULL)
			AND
		aci.LinkID = @ClientID
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'CheckIfCanGenerateReport')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[CheckIfCanGenerateReport] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[CheckIfCanGenerateReport]
	-- Add the parameters for the stored procedure here
	@JobID int = 0,
	@ClientID int = 0,
	@ProjectID int = 0,
	@SiteID int = 0

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	DECLARE
		@Message VARCHAR(MAX) = NULL

	-- Insert data into temp table
	DECLARE @JobData TABLE (IndexID int identity(1, 1), JobID int, Samples int, SampleResultEmployeeID int, ResultsLeft int, AllReinspectionSamples int, ContentLeft int, IsReinspection bit, RegisterComplete bit, ExternalPhotoID int, ExternalPhotoData image)
	INSERT INTO @JobData
	SELECT
		j.JobID,
		Samples.Count [Samples],
		j.SampleResultEmployeeID,
		(Samples.Count - SamplesNoResult.Count) [ResultsLeft],
		CASE WHEN (AllSamples.Count	= ThirdPartyorReinspecSamples.Count) THEN 1 ELSE 0 END [AllReinspectionSamples],
		CASE WHEN r.ReportInformationID IS NULL THEN 1 ELSE 0 END [ContentLeft],
		CASE WHEN st.Description LIKE '%reinspection%' THEN 1 ELSE 0 END [IsReinspection],
		r.RegisterComplete,
		r.PhotoID [ExternalPhotoID],
		p.PhotoData [ExternalPhotoData]
	FROM
		Job j
		INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
		INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
		INNER JOIN Survey s WITH (NOLOCK) ON r.SurveyID = s.SurveyID
		INNER JOIN SurveyType st WITH (NOLOCK) ON s.SurveyTypeID = st.SurveyTypeID
	
		LEFT JOIN Photo p WITH (NOLOCK) ON r.PhotoID = p.PhotoID

		OUTER APPLY
		(
			SELECT 
				COUNT(s2.sampleid) [Count]
			FROM
				JobEmployee je2
				INNER JOIN Register r2 WITH (NOLOCK) ON je2.JobEmployeeID = r2.JobEmployeeID
				INNER JOIN Room rm2 WITH (NOLOCK) ON r2.RegisterID = rm2.RegisterID
				INNER JOIN Sample s2 WITH (NOLOCK) ON rm2.RoomID = s2.RoomID
			WHERE
				r2.DateApproved Is Null And
				s2.SampleRef Is Not Null And 
				s2.AsSample = 0 And
				s2.SampleRef Not Like '%*%' And
				je2.JobID = j.JobID
		) Samples

		OUTER APPLY
		(
			SELECT 
				COUNT(s2.sampleid) [Count]
			FROM
				JobEmployee je2
				INNER JOIN Register r2 WITH (NOLOCK) ON je2.JobEmployeeID = r2.JobEmployeeID
				INNER JOIN Room rm2 WITH (NOLOCK) ON r2.RegisterID = rm2.RegisterID
				INNER JOIN Sample s2 WITH (NOLOCK) ON rm2.RoomID = s2.RoomID
			WHERE
				r2.DateApproved is Null and
				s2.SampleResultID is not null and
				s2.SampleRef is not null And 
				s2.AsSample = 0 and
				s2.SampleRef Not Like '%*%' And
				je2.JobID = j.JobID
		) SamplesNoResult

		OUTER APPLY
		(
			SELECT 
				COUNT(s2.sampleid) [Count]
			FROM
				JobEmployee je2
				INNER JOIN Register r2 WITH (NOLOCK) ON je2.JobEmployeeID = r2.JobEmployeeID
				INNER JOIN Room rm2 WITH (NOLOCK) ON r2.RegisterID = rm2.RegisterID
				INNER JOIN Sample s2 WITH (NOLOCK) ON rm2.RoomID = s2.RoomID
			WHERE
				r2.DateApproved is Null and
				s2.SampleRef is not null And 
				s2.AsSample = 0 and
				je2.JobID = j.JobID
		) AllSamples

		OUTER APPLY
		(
			SELECT 
				COUNT(s2.sampleid) [Count]
			FROM
				JobEmployee je2
				INNER JOIN Register r2 WITH (NOLOCK) ON je2.JobEmployeeID = r2.JobEmployeeID
				INNER JOIN Room rm2 WITH (NOLOCK) ON r2.RegisterID = rm2.RegisterID
				INNER JOIN Sample s2 WITH (NOLOCK) ON rm2.RoomID = s2.RoomID
			WHERE
				r2.DateApproved is Null and
				s2.SampleRef is not null And 
				s2.AsSample = 0 and
				je2.JobID = j.JobID and
				(s2.SampleRef Like '%{%' Or Right(s2.SampleRef, 1) = '*')	
		) ThirdPartyorReinspecSamples
	WHERE 
		j.JobID = @JobID
			AND
		(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID = @ClientID THEN 1 ELSE 0 END END) = 1
			AND
		(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID = @ProjectID THEN 1 ELSE 0 END END) = 1
			AND
		(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID = @SiteID THEN 1 ELSE 0 END END) = 1

	--SELECT * FROM @JobData

	-- Make sure the report is currently in Open Surveys
	DECLARE @InOpenSurveys bit = 0
	IF EXISTS(SELECT 1 FROM @JobData)
	BEGIN
		SET @InOpenSurveys = 1
	END
	ELSE
	BEGIN
		-- If report not in Open Surveys then make sure it is in Completed Surveys and show a message to the user
		DECLARE @InCompletedSurveys bit = CASE WHEN EXISTS(
			SELECT
				1
			FROM
				CompletedSurveys 
			WHERE 
				JobID = @JobID
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN ClientID = @ClientID THEN 1 ELSE 0 END END) = 1
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN ProjectID = @ProjectID THEN 1 ELSE 0 END END) = 1
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN SiteID = @SiteID THEN 1 ELSE 0 END END) = 1
			) THEN 1 ELSE 0 END

			IF (@InCompletedSurveys = 1)
			BEGIN
				SET @Message = 'FYI: The report has been moved to completed surveys.'
			END
			ELSE
			BEGIN
				SET @Message = 'ERROR: The report data could not be found to approve this report.'
			END
	END

	IF @InOpenSurveys = 1
	BEGIN
		-- Check that all the registers have had data received back from the tablet.
		DECLARE @HasIncompleteRegisters bit = CASE WHEN EXISTS(
			SELECT
				1
			FROM
				@JobData
			WHERE
				RegisterComplete = 0
		) THEN 1 ELSE 0 END

		IF (@HasIncompleteRegisters = 1)
		BEGIN
			SET @Message = 'FYI: The survey has registers waiting for data to come back.'
		END
		ELSE
		BEGIN
			-- Check that samples that need to be verified have been verified
			DECLARE @SamplesNeedVerifying bit = CASE WHEN EXISTS(
				SELECT
					1
				FROM
					@JobData
				WHERE
					JobID = @JobID
						AND
					Samples > 0
						AND
					(
						(SampleResultEmployeeID IS NULL AND IsReinspection = 0)
							OR
						(ResultsLeft > 0 AND IsReinspection = 1)
					)
						AND
					AllReinspectionSamples = 0
						AND
					(SELECT b__ApproveSurveyBeforeLabFinished FROM Config) = 0
			) THEN 1 ELSE 0 END

			IF (@SamplesNeedVerifying = 1)
			BEGIN
				SET @Message = 'FYI: You must have verified the sample results before approving the report.'
			END
			ELSE
			BEGIN
				-- Check that they have completed the checklist
				DECLARE @ChecklistNotComplete bit = CASE WHEN EXISTS(
					SELECT
						1
					FROM
						@JobData
					WHERE
						(
							Samples > 0
								AND
							(ContentLeft + ResultsLeft) > 0
								AND
							SampleResultEmployeeID IS NOT NULL
						)
							OR
						(
							Samples = 0
								AND
							ContentLeft > 0
						)
				) THEN 1 ELSE 0 END

				IF (@ChecklistNotComplete = 1)
				BEGIN
					-- This stored procedure is only currently used by the 'Add Report Content + Generate Preview' option in the right click menu on 'Open Surveys' therefore we do not need to check if the report has report content.
					--IF Exists(SELECT 1 FROM @JobData WHERE ContentLeft > 0) 
					--BEGIN
					--	SET @Message = ISNULL(@Message, '') + 'Report Content, '
					--END
					IF Exists(SELECT 1 FROM @JobData WHERE ResultsLeft > 0) 
					BEGIN
						SET @Message = ISNULL(@Message, '') + 'Results, '
					END
					SET @Message = LEFT(@Message, LEN(@Message) - 1)
					SET @Message = 'FYI: You must have completed the checklist for this report before you can approve it. Items missing : - ' + @Message
				END
				ELSE
				BEGIN
					-- Check if an external photos is required
					DECLARE @ExternalPhotoNotUploaded bit = CASE WHEN (SELECT b__ExternalPhotoRequired FROM Config) = 1 AND (SELECT COUNT(*) FROM @JobData WHERE ExternalPhotoID IS NOT NULL AND ExternalPhotoData IS NOT NULL) = 0 THEN 1 ELSE 0 END

					IF (@ExternalPhotoNotUploaded = 1)
					BEGIN
						SET @Message = 'FYI: The survey report is missing an external photo.'
					END
				END
			END
		END
	END

	SELECT
		COALESCE(@Message, 'Proceed') [Message]
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'BadClientNote' AND OBJECT_ID = OBJECT_ID('Client'))
BEGIN
    ALTER TABLE Client
    ADD [BadClientNote] [varchar] (max) NULL
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ReminderDate' AND OBJECT_ID = OBJECT_ID('Notification'))
BEGIN
    ALTER TABLE [dbo].[Notification]
    ADD [ReminderDate] [datetime] NULL;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_CreateSurveyJobList')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_CreateSurveyJobList] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE TEAMS_CreateSurveyJobList
	@ClientID INT = 0,
	@ProjectID INT = 0,
	@SiteID INT = 0

AS
BEGIN
SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

SELECT
	[JobID] =			j.JobID,
	[Description] =		dbo.FormatTeamsReference('J', j.JobNo) + ' - (' +  CONVERT(VARCHAR(11), MIN(a.StartTime), 106) +
						ISNULL(' To ' + CONVERT(VARCHAR(11), MAX(a.EndTime), 106) + ')', '') + ' - ' + st.Description	
FROM
	Job j
	LEFT JOIN JobEmployee je ON j.JobID = je.JobID
	INNER JOIN Quote q On j.JobID = q.JobId
	INNER JOIN Appointment a On q.QuoteId = a.QuoteID
	INNER JOIN AppointmentSurvey apts ON a.AppointmentID = apts.AppointmentID
	INNER JOIN SurveyType st On apts.SurveyTypeID = st.SurveyTypeID
WHERE
	je.JobEmployeeID IS NULL
		AND
	((j.ClientId = @ClientID) OR @ClientID = 0)
		AND
    ((j.ProjectId = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteId = @SiteID) OR @SiteID = 0)
        AND
	j.Cancelled IS NULL
        AND
	a.DateConfirmed IS NOT NULL
        AND
	a.DateDeclined IS NULL
GROUP BY	
	j.JobID,
	j.JobNo,
	st.Description
ORDER BY
	JobID

END
GO

-- MobileDtcIdMap table
BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SamplePhoto'))
	BEGIN
		CREATE TABLE [dbo].[SamplePhoto] (
        [SamplePhotoID] [int] IDENTITY (1, 1) NOT NULL,
        [SampleID] [int] NOT NULL,
        [PhotoData] [image] NULL,
        ) ON [PRIMARY]
        TEXTIMAGE_ON [PRIMARY];        
	END
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'JobLogNoteIdList')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[JobLogNoteIdList] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[JobLogNoteIdList]
       @EnquiryId INT = NULL
       , @JobId INT = NULL
       , @SiteId INT = NULL
       , @QuoteId INT = NULL
       , @AirTestId INT = NULL
       , @InvoiceId INT = NULL
       , @RemovalId INT = NULL,
	   @ProjectGroupId INT = NULL
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

       -- tidy input variables
       SELECT @EnquiryId = ISNULL(@EnquiryId, 0)
       SELECT @JobId = ISNULL(@JobId, 0)
       SELECT @SiteId = ISNULL(@SiteId, 0)
	   SELECT @ProjectGroupId = ISNULL(@ProjectGroupId, 0)
       SELECT @QuoteId = ISNULL(@QuoteId, 0)
       SELECT @AirTestId = ISNULL(@AirTestId, 0)
       SELECT @InvoiceId = ISNULL(@InvoiceId, 0)
       SELECT @RemovalId = ISNULL(@RemovalId, 0)
       
       /**************************************************************************************************************************************
       -- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
       --   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
       **************************************************************************************************************************************/
       DECLARE @DynamicSQL NVARCHAR(MAX)

       IF @InvoiceId > 0 BEGIN

              SELECT @DynamicSQL = '
              SELECT DISTINCT
                     0 AS EnquiryId
                     , 0 AS JobId
                     , 0 AS JobProjectId
                     , 0 AS SiteId
                     , 0 AS QuoteId
                     , 0 AS QuoteProjectId
                     , 0 AS ParentQuoteId
                     , IsNull(i.InvoiceId, 0) as InvoiceId
                     , 0 AS RemovalId
              FROM
                     InvoiceItem i
              WHERE 
                     1=1 
                     AND i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000)) + ' 
              UNION SELECT
                     0 AS EnquiryId
                     , 0 AS JobId
                     , 0 AS JobProjectId
                     , 0 AS SiteId
                     , 0 AS QuoteId
                     , 0 AS QuoteProjectId
                     , 0 AS ParentQuoteId
                     , i.InvoiceId 
                     , 0 AS RemovalId
              FROM
                     Invoice i
                     LEFT OUTER JOIN ProFormaItem p On i.InvoiceID = p.InvoiceID
                     LEFT OUTER JOIN CreditItem c On i.InvoiceID = c.InvoiceID
              WHERE 
                     i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000))   

       END ELSE BEGIN

              IF ( @EnquiryId > 0 OR @QuoteId > 0 OR @JobId > 0 OR @AirTestId > 0 OR @RemovalID > 0 OR @InvoiceId > 0 ) AND @SiteId = 0 BEGIN

                     SELECT @DynamicSQL = '
                     SELECT DISTINCT
                IsNull(e.EnquiryId, 0) AS EnquiryId
                           , IsNull(j.JobID, 0) AS JobId
                           , IsNull(j.ProjectID, 0) As JobProjectId
                           , IsNull(j.SiteID, 0) AS SiteId
                , IsNull(q.QuoteID, 0) AS QuoteId
                           , IsNull(q.ProjectID, 0) As QuoteProjectId
                , IsNull(q.ParentId, 0) AS ParentQuoteId
                , 0 AS InvoiceId
                , IsNull(r.RemovalId, 0) AS RemovalId
            FROM
                Enquiry e
                FULL OUTER JOIN Quote q ON q.QuoteId = e.QuoteId
                FULL OUTER JOIN InvoiceItem i ON q.InvoiceItemId = i.InvoiceItemId
                FULL OUTER JOIN Job j ON j.JobId = q.JobId
                OUTER APPLY (SELECT r.RemovalID FROM JobEmployee je INNER JOIN Removal r ON je.JobEmployeeID = r.JobEmployeeID WHERE je.JobID=j.JobID) r
            WHERE
                           1=1'

                     IF @RemovalId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND r.RemovalId = ' + CAST(@RemovalId AS nvarchar(4000))
                     END

                     IF @EnquiryId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND e.EnquiryId = ' + CAST(@EnquiryId AS nvarchar(4000))
                     END

                     IF @QuoteId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND q.QuoteId = ' + CAST(@QuoteId AS nvarchar(4000))
                     END

                     IF @JobId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND j.JobId = ' + CAST(@JobId AS nvarchar(4000))
                     END

                     IF @InvoiceId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL 
                                  + ' AND i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000)) + ' 
                                  UNION SELECT 
                                         0 AS EnquiryId
                                         , 0 AS JobId
                                         , 0 AS JobProjectId
                                         , 0 AS SiteId
                                         , 0 AS QuoteId
                                         , 0 AS QuoteProjectId
                                         , 0 AS ParentQuoteId
                                         , i.InvoiceId
                                         , 0 AS RemovalId
                                  FROM
                                         Invoice i
                                         LEFT OUTER JOIN ProFormaItem p On i.InvoiceID = p.InvoiceID
                                         LEFT OUTER JOIN CreditItem c On i.InvoiceID = c.InvoiceID
                                  WHERE
                                         i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000))
                     END
              END

              IF @SiteId > 0 BEGIN
                     SELECT @DynamicSQL = '
                     SELECT 
                           0 AS EnquiryId
                           , 0 AS JobId
                           , 0 AS JobProjectId
                           , IsNull(SiteID, 0) AS SiteId
                           , 0 AS ProjectId
                           , 0 AS QuoteId
                           , 0 AS QuoteProjectId
                           , 0 AS ParentQuoteId
                           , 0 AS InvoiceId 
                           , 0 AS RemovalId
                     FROM
                           Site
                     WHERE
                           SiteId = ' + CAST(@SiteId AS nvarchar(4000))
              END

			  IF @ProjectGroupId > 0 BEGIN
                     SELECT @DynamicSQL = '
                     SELECT 
                           0 AS EnquiryId
                           , 0 AS JobId
                           , 0 AS JobProjectId
                           , 0 AS SiteId
                           , ISNULL(ProjectGroupID, 0) AS ProjectId
                           , 0 AS QuoteId
                           , 0 AS QuoteProjectId
                           , 0 AS ParentQuoteId
                           , 0 AS InvoiceId 
                           , 0 AS RemovalId
                     FROM
                           ProjectGroup
                     WHERE
                           ProjectGroupID = ' + CAST(@ProjectGroupId AS nvarchar(4000))
              END
       END

       -- execute the SQL
       EXECUTE sp_executesql @DynamicSQL
END

GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='PhotoChunk'))
BEGIN
    CREATE TABLE [dbo].[PhotoChunk](
	[PhotoChunkID] [int] IDENTITY(1,1) NOT NULL,
	[PhotoData] [varchar](max) NOT NULL,
	[ChunkNumber] [int] NOT NULL,
	[ObjectType] [varchar](50) NULL,
	[ObjectID] [int] NOT NULL,
	[TryNumber] [int] NOT NULL,
    CONSTRAINT [PK_PhotoChunk_PhotoChunkID] PRIMARY KEY CLUSTERED 
    (
        [PhotoChunkID] ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PDF') AND name='mobileTEAMSv2') < 1
BEGIN
  ALTER TABLE PDF
      ADD mobileTEAMSv2 BIT NOT NULL DEFAULT(0)
END

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'SurveyPhotoCollections')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[SurveyPhotoCollections] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[SurveyPhotoCollections]
    @JobID INT,
    @IncludeAutoInsert BIT = 1
   
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

    SET NOCOUNT ON

    SELECT
            results.Type,
            ImageSize,
            PhotoID,
            PhotoReplaceVariable,
            Caption,
            CaptionReplaceVariable,
            TimeStamp,
            TimeStampReplaceVariable
    FROM
    (
        SELECT 
                    main.[Type],
                    ' width="' + CAST(ISNULL(mcWidth.[MobileConfigInt],400) as varchar) + '" height="' + CAST(ISNULL(mcHeight.[MobileConfigInt],300) as varchar) + '"' [ImageSize],
                    main.PhotoID,
                    main.PhotoReplaceVariable,
                    main.Caption,
                    main.CaptionReplaceVariable,
                    main.TimeStamp,
                    main.TimeStampReplaceVariable,
                    main.AutoInsert,
                    main.[Order]

                FROM
                (
                SELECT
                    'PhotoCollection' [Type], 
                    ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) [Order], 
                    p.PhotoID [PhotoID], 
                    ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) [SELNO], 
                    REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariable], 
                    IsNull(pc.Caption,'N/A') [Caption], 
                    REPLACE(REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION]') [CaptionReplaceVariable],
                    CONVERT(varchar,pc.Created,IsNull((Select MobileConfigInt FROM MobileConfig Where MobileConfigTypeID=88),103)) [TimeStamp],
                    REPLACE(REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME]') [TimeStampReplaceVariable],
                    pc.AutoInsert
                FROM
                                Job j
                                INNER JOIN JobEmployee je ON je.JobID = j.JobID
                                INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
                                --INNER JOIN Survey su ON su.SurveyID = r.SurveyID
                                INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
                                INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
                                INNER JOIN Sample s ON s.RoomID = rm.RoomID
                                LEFT OUTER JOIN PhotoCollection pc ON s.SampleID = pc.SampleID AND pc.IncludeInPDF IS NOT NULL
                                LEFT OUTER JOIN Photo p ON p.PhotoID=pc.PhotoID
                WHERE
                    j.JobID = @JobID
                ) main
        LEFT OUTER JOIN MobileConfig mcWidth WITH (NOLOCK) ON mcWidth.MobileConfigText='Width' AND mcWidth.MobileConfigTypeID=116
                LEFT OUTER JOIN MobileConfig mcHeight WITH (NOLOCK) ON mcHeight.MobileConfigText='Height' AND mcHeight.MobileConfigTypeID=116
    ) results

    WHERE
                CASE WHEN @IncludeAutoInsert = 1 THEN 
                    1
                ELSE
                    CASE WHEN AutoInsert = 1 THEN 0 ELSE 1 END
                END = 1
    Order By
        results.[Order]

    SET NOCOUNT OFF
       
END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'mobile_NextSampleRefBySystemName')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[mobile_NextSampleRefBySystemName] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[mobile_NextSampleRefBySystemName]
    @SystemName NVARCHAR(MAX)
   
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

    SET NOCOUNT ON;   
      
    DECLARE @SampleRefList TABLE (SampleRef VARCHAR(MAX))
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRef FROM Sample WHERE SampleRef LIKE @SystemName + '%' AND SampleRef NOT LIKE '%{%'  ORDER BY SampleRef DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) FROM Sample WHERE SampleRef LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) DESC 
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRef FROM AirSample WHERE SampleRef LIKE @SystemName + '%' AND SampleRef NOT LIKE '%{%'  ORDER BY SampleRef DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) FROM AirSample WHERE SampleRef LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) DESC 
    
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefCold FROM LegionellaSample WHERE SampleRefCold LIKE @SystemName + '%' AND SampleRefCold NOT LIKE '%{%'  ORDER BY SampleRefCold DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefCold, PATINDEX('%{%', SampleRefCold) + 1, LEN(SampleRefCold) - PATINDEX('%{%', SampleRefCold)) FROM LegionellaSample WHERE SampleRefCold LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefCold, PATINDEX('%{%', SampleRefCold) + 1, LEN(SampleRefCold) - PATINDEX('%{%', SampleRefCold)) DESC 
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefHot FROM LegionellaSample WHERE SampleRefHot LIKE @SystemName + '%' AND SampleRefHot NOT LIKE '%{%'  ORDER BY SampleRefHot DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefHot, PATINDEX('%{%', SampleRefHot) + 1, LEN(SampleRefHot) - PATINDEX('%{%', SampleRefHot)) FROM LegionellaSample WHERE SampleRefHot LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefHot, PATINDEX('%{%', SampleRefHot) + 1, LEN(SampleRefHot) - PATINDEX('%{%', SampleRefHot)) DESC 
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefMixed FROM LegionellaSample WHERE SampleRefMixed LIKE @SystemName + '%' AND SampleRefMixed NOT LIKE '%{%'  ORDER BY SampleRefMixed DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefMixed, PATINDEX('%{%', SampleRefMixed) + 1, LEN(SampleRefMixed) - PATINDEX('%{%', SampleRefMixed)) FROM LegionellaSample WHERE SampleRefMixed LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefMixed, PATINDEX('%{%', SampleRefMixed) + 1, LEN(SampleRefMixed) - PATINDEX('%{%', SampleRefMixed)) DESC 
    INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefMains FROM LegionellaSample WHERE SampleRefMains LIKE @SystemName + '%' AND SampleRefMains NOT LIKE '%{%'  ORDER BY SampleRefMains DESC
    INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefMains, PATINDEX('%{%', SampleRefMains) + 1, LEN(SampleRefMains) - PATINDEX('%{%', SampleRefMains)) FROM LegionellaSample WHERE SampleRefMains LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefMains, PATINDEX('%{%', SampleRefMains) + 1, LEN(SampleRefMains) - PATINDEX('%{%', SampleRefMains)) DESC 
    
    DECLARE @SampleRefIntList TABLE (SampleRef INT)
    INSERT INTO @SampleRefIntList SELECT TOP 1 NULLIF(REPLACE(SampleRef,@SystemName,''),'') FROM @SampleRefList WHERE ISNUMERIC(REPLACE(SampleRef,@SystemName,''))=1 ORDER BY SampleRef DESC
    
    SELECT ISNULL((SELECT TOP 1 SampleRef FROM @SampleRefIntList Order By SampleRef DESC),0)+1
    
    SET NOCOUNT OFF;
       
END

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='AirtestdataCollectionQuestion') AND name='DescriptionSuffix') < 1
BEGIN
    ALTER TABLE AirtestdataCollectionQuestion
      ADD [DescriptionSuffix] VARCHAR(MAX) NULL
END

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='AirtestdataCollectionQuestion') AND name='DescriptionPrefix') < 1
BEGIN
    ALTER TABLE AirtestdataCollectionQuestion
      ADD [DescriptionPrefix] VARCHAR(MAX) NULL
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'DataMatching' AND OBJECT_ID = OBJECT_ID('Employee'))
BEGIN
    ALTER TABLE [dbo].[Employee]
    ADD [DataMatching] [bit] NOT NULL
    CONSTRAINT [DF_Employee_DataMatching]
    DEFAULT (0);
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'GridDetail_InvoicesInProgressModifyItems')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[GridDetail_InvoicesInProgressModifyItems] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GridDetail_InvoicesInProgressModifyItems]
	@InvoiceItemID INT

AS
BEGIN

	SET NOCOUNT ON

	DECLARE @JobID int = (SELECT q.JobID FROM Quote q WHERE q.InvoiceItemID = @InvoiceItemID)

	DECLARE @AppointmentType VARCHAR(MAX) = (SELECT COALESCE(t.AppointmentType,(SELECT [qt].[QuoteType] WHERE [qt].[QuoteType] = 'Samples')) AS AppointmentType FROM QuoteType qt WITH (NOLOCK) LEFT OUTER JOIN AppointmentType t WITH (NOLOCK) ON [t].[AppointmentTypeId] = [qt].[AppointmentTypeId] INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID WHERE q.JobID = @JobID)

	DECLARE @InvoiceItemData TABLE (IndexID INT IDENTITY(1,1), WorkStarted DATETIME, WorkFinished DATETIME, Employee VARCHAR(MAX), Notes VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AirTests VARCHAR(MAX), FieldNotes VARCHAR(MAX), Samples int)

	IF @AppointmentType = 'Air Monitoring'
	BEGIN

		INSERT INTO @InvoiceItemData (WorkStarted, WorkFinished, Employee, Notes, ScopeOfWork, AirTests, FieldNotes, Samples)
		SELECT
			MIN(a.AirTestStart) 'WorkStarted',
			MAX(a.AirTestFinish) 'WorkFinished',
			e.FullName 'Employee',
			(SELECT TOP 1 Notes FROM Appointment a WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID WHERE q.JobID = @JobID) 'Notes',
			(SELECT TOP 1 ScopeOfWork FROM Quote WITH (NOLOCK) WHERE JobID = @JobID) 'ScopeOfWork',
			SUBSTRING((SELECT ',' + a.SystemName + RIGHT('0' + CONVERT(VARCHAR,a.AirTestNo),2) + ' (' + att.[Description] + ')' FROM AirTest a WITH (NOLOCK) INNER JOIN AirTestType att WITH (NOLOCK) ON a.AirTestTypeID = att.AirTestTypeID INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID = a.JobEmployeeID WHERE je.JobID = @JobID ORDER BY a.AirTestNo FOR XML PATH( '' )),2,1000) 'AirTests',
			ISNULL(fieldNotes.Description, '') [Fieldnotes],
			COUNT(airs.AirSampleId) [Samples]
		FROM 
			JobEmployee je WITH (NOLOCK) 
			INNER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID = je.EmployeeID
			INNER JOIN AirTest a WITH (NOLOCK) ON a.JobEmployeeID = je.JobEmployeeID
			LEFT JOIN AirSample airs ON airs.AirTestID = a.AirTestID AND airs.FieldBlank=0
			OUTER APPLY
			(
				select 
					SUBSTRING 
					((
						SELECT 
							', ' + [sl].[Description]
						FROM 
							[dbo].[SiteLog] sl WITH (NOLOCK) 
						WHERE 
							[sl].[JobID] = [je].[JobID]
								AND
							sl.[SystemTypeID] = 0
					for xml PATH('') ), 3, 1000) [Description]
			) fieldNotes
		WHERE
			je.JobID = @JobID
		GROUP BY
			e.FullName,
			fieldNotes.Description

	END

	IF @AppointmentType = 'Survey'
	BEGIN
		
		INSERT INTO @InvoiceItemData (WorkStarted, WorkFinished, Employee, Notes, ScopeOfWork, AirTests, FieldNotes, Samples)
		SELECT
			MIN(r.RegisterStart) 'WorkStarted',
			MAX(r.RegisterFinish) 'WorkFinished',
			e.FullName 'Employee',
			(SELECT TOP 1 Notes FROM Appointment a WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID WHERE q.JobID = @JobID) 'Notes',
			(SELECT TOP 1 ScopeOfWork FROM Quote WITH (NOLOCK) WHERE JobID = @JobID) 'ScopeOfWork',
			'' 'AirTests',
			ISNULL(fieldNotes.Description, '') [Fieldnotes],
			samplecount.samplecount [Samples]
		FROM 
			JobEmployee je WITH (NOLOCK) 
			INNER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID = je.EmployeeID
			INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			OUTER APPLY
			(
				select 
					SUBSTRING 
					((
						SELECT 
							', ' + [sl].[Description]
						FROM 
							[dbo].[SiteLog] sl WITH (NOLOCK) 
						WHERE 
							[sl].[JobID] = [je].[JobID]
								AND
							sl.[SystemTypeID] = 0
					for xml PATH('') ), 3, 1000) [Description]
			) fieldNotes
			OUTER APPLY
			(
				SELECT
					COUNT(*) [samplecount]
				FROM
					Job _j
					INNER JOIN JobEmployee _je WITH (NOLOCK) ON _je.JobID = _j.JobID
					INNER JOIN dbo.Register _r WITH (NOLOCK) ON _r.JobEmployeeID = _je.JobEmployeeID
					INNER JOIN dbo.Floorplan _f WITH (NOLOCK) ON _f.RegisterID = _r.RegisterID
					INNER JOIN dbo.Room _rm WITH (NOLOCK) ON _rm.FloorplanID = _f.FloorplanID
					INNER JOIN dbo.Sample _s WITH (NOLOCK) ON _s.RoomID = _rm.RoomID
				WHERE
					_j.JobID = @JobID
						AND
					_s.SampleRef IS NOT NULL
						AND
					_s.AsSample = 0
			) samplecount
		WHERE
			je.JobID = @JobID
		GROUP BY
			e.FullName,
			fieldNotes.Description,
			samplecount.samplecount

	END

	IF (@AppointmentType = 'Training' OR @AppointmentType = 'General')
	BEGIN

		INSERT INTO @InvoiceItemData (WorkStarted, WorkFinished, Employee, Notes, ScopeOfWork, AirTests, FieldNotes, Samples)
		SELECT
			MIN(a.StartTime) 'WorkStarted',
			MAX(a.EndTime) 'WorkFinished',
			MAX(e.FullName) 'Employee',
			(SELECT TOP 1 Notes FROM Appointment a WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON q.QuoteID = a.QuoteID WHERE q.JobID = @JobID) 'Notes',
			(SELECT TOP 1 ScopeOfWork FROM Quote WITH (NOLOCK) WHERE JobID = @JobID) 'ScopeOfWork',
			'' 'AirTests',
			'' [Fieldnotes],
			0 [Samples]
		FROM 
			Appointment a WITH (NOLOCK) 
			INNER JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
			INNER JOIN AppointmentEmployee ae WITH (NOLOCK) ON a.AppointmentID = ae.AppointmentID
			INNER JOIN Employee e WITH (NOLOCK) ON ae.EmployeeID = e.EmployeeID
		WHERE
			q.JobID = @JobID

	END

	IF @AppointmentType = 'Samples'
	BEGIN

		INSERT INTO @InvoiceItemData (WorkStarted, WorkFinished, Employee, Notes, ScopeOfWork, AirTests, FieldNotes, Samples)
		SELECT
			NULL 'WorkStarted',
			NULL 'WorkFinished',
			'' 'Employee',
			'' 'Notes',
			'' 'ScopeOfWork',
			'' 'AirTests',
			'' [Fieldnotes],
			COUNT(*) [Samples]
		FROM 
			JobEmployee je WITH (NOLOCK)
			INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			INNER JOIN Room rm WITH (NOLOCK) ON rm.RegisterID = r.RegisterID
			INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
		WHERE
			je.JobID = @JobID
				AND
			s.AsSample = 0
				AND
			s.SampleRef IS NOT NULL

	END

	-- Main Select
	SELECT
		WorkStarted,
		WorkFinished,
		Employee,
		Notes,
		ScopeOfWork,
		AirTests,
		FieldNotes,
		Samples
	FROM
		@InvoiceItemData

	SET NOCOUNT OFF

END

GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 's__EnableMobileLicensing' AND OBJECT_ID = OBJECT_ID('Config'))
BEGIN
    ALTER TABLE [dbo].[Config]
    ADD [s__EnableMobileLicensing] [datetime] NULL;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'mobile_NextSampleRefBySystemName')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[mobile_NextSampleRefBySystemName] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROC [dbo].[mobile_NextSampleRefBySystemName]
(
	@SystemName nvarchar(MAX)
)
AS
BEGIN
	SET NOCOUNT ON;	
	
	DECLARE
		@enableLicensing BIT = (SELECT
									CASE
										WHEN DATEDIFF(MINUTE, (SELECT ISNULL(s__EnableMobileLicensing, DATEADD(DAY, -1, GETDATE())) FROM Config), GETDATE()) <= 5
										THEN 1
									ELSE
										0
									END)	

	DECLARE @SampleRefList TABLE (SampleRef VARCHAR(MAX))
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRef FROM Sample WHERE SampleRef LIKE @SystemName + '%' AND SampleRef NOT LIKE '%{%'  ORDER BY SampleRef DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) FROM Sample WHERE SampleRef LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) DESC 
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRef FROM AirSample WHERE SampleRef LIKE @SystemName + '%' AND SampleRef NOT LIKE '%{%'  ORDER BY SampleRef DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) FROM AirSample WHERE SampleRef LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRef, PATINDEX('%{%', SampleRef) + 1, LEN(SampleRef) - PATINDEX('%{%', SampleRef)) DESC 
	
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefCold FROM LegionellaSample WHERE SampleRefCold LIKE @SystemName + '%' AND SampleRefCold NOT LIKE '%{%'  ORDER BY SampleRefCold DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefCold, PATINDEX('%{%', SampleRefCold) + 1, LEN(SampleRefCold) - PATINDEX('%{%', SampleRefCold)) FROM LegionellaSample WHERE SampleRefCold LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefCold, PATINDEX('%{%', SampleRefCold) + 1, LEN(SampleRefCold) - PATINDEX('%{%', SampleRefCold)) DESC 
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefHot FROM LegionellaSample WHERE SampleRefHot LIKE @SystemName + '%' AND SampleRefHot NOT LIKE '%{%'  ORDER BY SampleRefHot DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefHot, PATINDEX('%{%', SampleRefHot) + 1, LEN(SampleRefHot) - PATINDEX('%{%', SampleRefHot)) FROM LegionellaSample WHERE SampleRefHot LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefHot, PATINDEX('%{%', SampleRefHot) + 1, LEN(SampleRefHot) - PATINDEX('%{%', SampleRefHot)) DESC 
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefMixed FROM LegionellaSample WHERE SampleRefMixed LIKE @SystemName + '%' AND SampleRefMixed NOT LIKE '%{%'  ORDER BY SampleRefMixed DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefMixed, PATINDEX('%{%', SampleRefMixed) + 1, LEN(SampleRefMixed) - PATINDEX('%{%', SampleRefMixed)) FROM LegionellaSample WHERE SampleRefMixed LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefMixed, PATINDEX('%{%', SampleRefMixed) + 1, LEN(SampleRefMixed) - PATINDEX('%{%', SampleRefMixed)) DESC 
	INSERT INTO @SampleRefList (SampleRef) SELECT SampleRefMains FROM LegionellaSample WHERE SampleRefMains LIKE @SystemName + '%' AND SampleRefMains NOT LIKE '%{%'  ORDER BY SampleRefMains DESC
	INSERT INTO @SampleRefList (SampleRef) SELECT SUBSTRING(SampleRefMains, PATINDEX('%{%', SampleRefMains) + 1, LEN(SampleRefMains) - PATINDEX('%{%', SampleRefMains)) FROM LegionellaSample WHERE SampleRefMains LIKE '%{' + @SystemName + '%' ORDER BY SUBSTRING(SampleRefMains, PATINDEX('%{%', SampleRefMains) + 1, LEN(SampleRefMains) - PATINDEX('%{%', SampleRefMains)) DESC 
	
	DECLARE @SampleRefIntList TABLE (SampleRef INT)
	INSERT INTO @SampleRefIntList SELECT TOP 1 NULLIF(REPLACE(SampleRef,@SystemName,''),'') FROM @SampleRefList WHERE ISNUMERIC(REPLACE(SampleRef,@SystemName,''))=1 ORDER BY SampleRef DESC

	
	IF @enableLicensing = 1
		BEGIN
			INSERT INTO MobileAuditTrail (Category, SystemName, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated)
			SELECT 1, @SystemName, 'Attempted Connection', 'MobileAuditTrail', 0, 'mobile_NextSampleRefBySystemName', '0.0.0.0', '0.0.0.0', GETDATE()

			SELECT ISNULL((SELECT TOP 1 SampleRef FROM @SampleRefIntList Order By SampleRef DESC),0)+1
		END
	ELSE
		BEGIN
			SELECT ''
		END
	
	SET NOCOUNT OFF;
	
END



GO



/****** Object:  StoredProcedure [dbo].[GetLegionellaFloorplans]    Script Date: 03/04/2018 10:43:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GetLegionellaFloorplans]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @DefaultTemplatePageLayout VARCHAR(100),
    @LegionellaID INT = 0,
    @FloorplanID INT = 0,
    @FloorplanAdditionalID INT = 0
/**********************************************************************
** Overview: Get Legionella Floorplans.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@DefaultTemplatePageLayout VARCHAR(100) = 'tpl_LegionellaFloorplansA4Landscape_tpl',
        --@LegionellaID INT = 0,
        --@FloorplanID INT = 0,
        --@FloorplanAdditionalID INT = 0
    -- END DEBUG
    
    -- Set IDs lower down the tree if IDs higher up the tree are set.
    IF @FloorplanAdditionalID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(f.LegionellaID, @LegionellaID)
        FROM
            FloorplanAdditional fa WITH (NOLOCK)
            INNER JOIN Floorplan f WITH (NOLOCK) ON fa.FloorplanID = f.FloorplanID
        WHERE fa.FloorplanAdditionalID = @FloorplanAdditionalID
    END
    IF @FloorplanID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM Floorplan WITH (NOLOCK)
        WHERE FloorplanID = @FloorplanID
    END
    
    
    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)
    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)
    
    
    -- Get all floorplan data up front to reduce table scans on the Floorplan table
    DECLARE @FloorplanData TABLE (LegionellaID INT, FloorplanID INT, FloorNumber INT, HasFloorplanData INT, FloorplanDataContentType VARCHAR(200), HasAutocadData INT, AutocadDataContentType VARCHAR(200), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    INSERT INTO @FloorplanData (LegionellaID, FloorplanID, FloorNumber, HasFloorplanData, FloorplanDataContentType, HasAutocadData, AutocadDataContentType, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
                                main.LegionellaID,
                                main.FloorplanID,
                                main.FloorNumber,
                                main.HasFloorplanData,
                                main.FloorplanDataContentType,
                                main.HasAutocadData,
                                main.AutocadDataContentType,
                                main.DescriptionOverride,
                                main.ShortDescriptionOverride,
                                main.TemplatePageLayout_SearchString,
                                main.CanvasSize
                FROM
                (
                                SELECT
                                                l.LegionellaID,
                                                f.FloorplanID,
                                                f.FloorNumber,
                                                CASE WHEN f.FloorplanData IS NOT NULL THEN 1 ELSE 0 END [HasFloorplanData],
                                                f.FloorplanDataContentType,
                                                CASE WHEN f.AutocadData IS NOT NULL THEN 1 ELSE 0 END [HasAutocadData],
                                                f.AutocadDataContentType,
                                                f.DescriptionOverride,
                                                f.ShortDescriptionOverride,
                                                f.TemplatePageLayout_SearchString,
                                                f.CanvasSize
                                FROM
                                                @LegionellaData l
                                                INNER JOIN Floorplan f WITH (NOLOCK) ON l.LegionellaID = f.LegionellaID
                                WHERE
                                                /*(
                                                                f.FloorplanData IS NOT NULL
                                                                                OR
                                                                f.AutocadData IS NOT NULL
                                                )
                                                                AND*/
                                                ISNULL(f.ExcludeFromReport, 0) = 0
                                                                AND
                                                (f.FloorplanID = @FloorplanID OR @FloorplanID = 0)
    ) main
    WHERE
                                main.HasAutocadData = 1 OR main.HasFloorplanData = 1

    -- Get all additional floorplan data up front to reduce table scans on the FloorplanAdditional table
    DECLARE @FloorplanAdditionalData TABLE (LegionellaID INT, FloorplanAdditionalID INT, FloorplanID INT, FloorNumber INT, HasFloorplanData INT, FloorplanDataContentType VARCHAR(200), HasAutocadData INT, AutocadDataContentType VARCHAR(200), Description VARCHAR(MAX), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    INSERT INTO @FloorplanAdditionalData (LegionellaID, FloorplanAdditionalID, FloorplanID, FloorNumber, HasFloorplanData, FloorplanDataContentType, HasAutocadData, AutocadDataContentType, Description, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
                                main.LegionellaID,
                                main.FloorplanAdditionalID,
                                main.FloorplanID,
                                main.FloorNumber,
                                main.HasFloorplanData,
                                main.FloorplanDataContentType,
                                main.HasAutocadData,
                                main.AutocadDataContentType,
                                main.Description,
                                main.DescriptionOverride,
                                main.ShortDescriptionOverride,
                                main.TemplatePageLayout_SearchString,
                                main.CanvasSize
                FROM
                (
                                SELECT
                                                l.LegionellaID,
                                                fa.FloorplanAdditionalID,
                                                fa.FloorplanID,
                                                f.FloorNumber,
                                                CASE WHEN fa.FloorplanData IS NOT NULL THEN 1 ELSE 0 END [HasFloorplanData],
                                                fa.FloorplanDataContentType,
                                                CASE WHEN fa.AutocadData IS NOT NULL THEN 1 ELSE 0 END [HasAutocadData],
                                                fa.AutocadDataContentType,
                                                fa.Description,
                                                f.DescriptionOverride,
                                                f.ShortDescriptionOverride,
                                                f.TemplatePageLayout_SearchString,
                                                f.CanvasSize
                                FROM
                                                @LegionellaData l
                                                INNER JOIN Floorplan f WITH (NOLOCK) ON l.LegionellaID = f.LegionellaID
                                                INNER JOIN FloorplanAdditional fa WITH (NOLOCK) ON f.FloorplanID = fa.FloorplanID
                                WHERE
                                                /*(
                                                                fa.FloorplanData IS NOT NULL
                                                                                OR
                                                                fa.AutocadData IS NOT NULL
                                                )
                                                                AND*/
                                                ISNULL(fa.ExcludeFromReport, 0) = 0
                                                                AND
                                                (fa.FloorplanAdditionalID = @FloorplanAdditionalID OR @FloorplanAdditionalID = 0)
    ) main
    WHERE
                                main.HasAutocadData = 1 OR main.HasFloorplanData = 1
    
    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), Additional BIT, FloorplanID INT, FloorplanRecordID INT, FloorplanAdditionalRecordID INT, DescriptionOverride VARCHAR(MAX), FloorplanSource VARCHAR(1000))
    
    INSERT INTO @MainData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, Additional, FloorplanID, FloorplanRecordID, FloorplanAdditionalRecordID, DescriptionOverride, FloorplanSource)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        f.Additional,
        f.FloorplanID,
        f.FloorplanRecordID,
        f.FloorplanAdditionalRecordID,
        f.DescriptionOverride,
        f.FloorplanSource
        
    FROM
        @LegionellaData l
        LEFT JOIN Photo lp WITH (NOLOCK) ON l.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        INNER JOIN (
            -- Get the normal onsite Floorplans.
            SELECT
                0 [Additional],
                                                                f.LegionellaID,
                f.FloorplanID [FloorplanID],
                f.FloorplanID [FloorplanRecordID],
                NULL [FloorplanAdditionalRecordID],
                f.DescriptionOverride,
                CASE WHEN f.HASAutocadData > 0
                    THEN
                        CASE WHEN f.AutocadDataContentType != 'application/pdf' -- Use the office Floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(100)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                            ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(100)) + ']'
                        END
                    ELSE
                        CASE WHEN f.FloorplanDataContentType != 'application/pdf' -- Use the mobile unit Floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(100)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use the site Floorplan image
                            ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(100)) + ']'
                        END
                END [FloorplanSource]
            FROM
                @FloorplanData f
            
            UNION ALL -- Join together the queries. ALL means that duplicates can appear.
            
            -- Get additional office Floorplans.
            SELECT
                1 [Additional],
                                                                fa.LegionellaID,
                fa.FloorplanAdditionalID [FloorplanID],
                fa.FloorplanID [FloorplanRecordID],
                fa.FloorplanAdditionalID [FloorplanAdditionalRecordID],
                ISNULL(fa.Description, fa.DescriptionOverride) [DescriptionOverride],
                CASE WHEN fa.HasAutocadData  > 0
                    THEN
                        CASE WHEN fa.AutocadDataContentType != 'application/pdf' -- Use the office Floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                            ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + ']'
                        END
                    ELSE
                        CASE WHEN fa.FloorplanDataContentType != 'application/pdf' -- Use the mobile unit Floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use the site Floorplan image
                            ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + ']'
                        END
                END [FloorplanSource]
            FROM
                @FloorplanAdditionalData fa
        ) f ON l.LegionellaID = f.LegionellaID
        
    ORDER BY
        l.LegionellaStart,
        f.Additional
    
    
    -- Start the main SELECT
    SELECT
        -- Main data from the table variable
        m.RowID,
        (SELECT COUNT(*) FROM @MainData) [TotalRows],
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaPhotoNo,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.LegionellaPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [LegionellaPhoto],
        m.Additional,
        m.FloorplanID,
        m.FloorplanRecordID,
        m.FloorplanAdditionalRecordID,
        m.DescriptionOverride,
        m.FloorplanSource,
        
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionella],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaEnd]
        
    FROM
        @MainData m
    
    
    SET NOCOUNT OFF;
END

GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[PopulateLegionellaOutletComputedData]    Script Date: 04/05/2018 17:48:39 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER Proc [dbo].[PopulateLegionellaOutletComputedData]
    @JobID INT
As
Begin
    Set NoCount On;


	DECLARE @SiteID INT = (Select SiteID FROM Job Where JobID=@JobId)
	DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobId)

	--Clear out the data for the given job
	DELETE LegionellaOutletComputedData Where SiteID = @SiteID

	--Get historic temp data per outlet associated with the job
	DECLARE @LegionellaOutlet TABLE (JobID INT,PerformedByEmployeeID INT,LegionellaOutletID INT, LegionellaLocationID INT, [GUID] VARCHAR(MAX), GUIDVersion INT, LegionellaFinish DATETIME, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	Insert into @LegionellaOutlet (JobID,PerformedByEmployeeID,LegionellaOutletID,LegionellaLocationID,[GUID],GUIDVersion,LegionellaFinish,Cold,Hot,[Mixed],Mains, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		j.JobID,
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		ISNULL(lo.FlushedCold, 0) [FlushedCold],
		ISNULL(lo.FlushedHot, 0) [FlushedHot],
		ISNULL(lo.FlushedMixed, 0) [FlushedMixed],
		ISNULL(lo.FlushedMains, 0) [FlushedMains],
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains
	FROM
		Job j WITH (NOLOCK)
		INNER JOIN Quote q WITH (NOLOCK) ON q.JobID=j.JobID
		INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL
		INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
		INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
		INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON ll.LegionellaID=l.LegionellaID AND ll.Deleted IS NULL
		INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON lo.LegionellaLocationID=ll.LegionellaLocationID AND lo.Deleted IS NULL
	Where
		j.SiteID=@SiteID
			AND
		j.ClientID=@ClientID
			AND
		(
			j.Approved IS NOT NULL
				OR
			j.JobID = @JobID
		)
	Group By
		j.jobID,
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		lo.FlushedCold,
		lo.FlushedHot,
		lo.FlushedMixed,
		lo.FlushedMains,
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains

	DECLARE @LegionellaOutletComputedData TABLE (JobID INT, OriginalOutletID INT,LegionellaOutletID INT, LegionellaLocationID INT, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), PerformedByEmployeeID INT, PerformedByPortalUserID INT, PerformedByThirdParty VARCHAR(MAX), Comments VARCHAR(MAX), Recorded DATETIME, FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		main.JobID, main.[OriginalOutletID],main.LegionellaOutletID [LegionellaOutletID], main.LegionellaLocationID [LegionellaLocationID],main.Cold,main.Hot,main.[Mixed],main.Mains,main.PerformedByEmployeeID,main.PerformedByPortalUserID,main.PerformedByThirdParty,main.Comments,main.Recorded, main.FlushedCold, main.FlushedHot, main.FlushedMixed, main.FlushedMains, main.LowUseCold, main.LowUseHot, main.LowUseMixed, main.LowUseMains
	FROM
		(
			Select
				lo.JobID [JobID],
				loMax.LegionellaOutletID [OriginalOutletID],
				ROW_NUMBER() OVER (Partition By loMax.GUID,loMax.LegionellaFinish Order by lo.GuidVersion desc,lo.LegionellaFinish DESC) [Identifier],
				lo.LegionellaLocationID [LegionellaLocationID],
				lo.LegionellaOutletID,
				lo.[GUID],
				loMax.Cold,
				loMax.Hot,
				loMax.Mixed,
				loMax.Mains,
				loMax.PerformedByEmployeeID,
				NULL [PerformedByPortalUserID],
				NULL [PerformedByThirdParty],
				NULL [Comments],
				loMax.LegionellaFinish [Recorded],
				loMax.FlushedCold,
				loMax.FlushedHot,
				loMax.FlushedMixed,
				loMax.FlushedMains,
				loMax.LowUseCold,
				loMax.LowUseHot,
				loMax.LowUseMixed,
				loMax.LowUseMains
			FROM 
				@LegionellaOutlet lo INNER JOIN @LegionellaOutlet loMax ON lo.GUID=loMax.GUID AND lo.GUIDVersion >= loMax.GUIDVersion
		) main
	Where
		main.Identifier = 1
	--SELECT * FROM @LegionellaOutletComputedData
		
	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	SELECT
		locd.JobID,locd.LegionellaOutletID,locd.LegionellaOutletID,locd.LegionellaLocationID,lopd.Cold,lopd.Hot,lopd.[Mixed],lopd.Mains,NULL [PerformedByEmployeeID],lopd.PerformedByPortalUserID,lopd.PerformedByThirdParty,lopd.Comments,lopd.Recorded, lopd.FlushedCold, lopd.FlushedHot, lopd.FlushedMixed, lopd.FlushedMains, lopd.LowUseCold, lopd.LowUseHot, lopd.LowUseMixed, lopd.LowUseMains
	FROM
		@LegionellaOutletComputedData locd
		INNER JOIN LegionellaOutletPortalData lopd ON locd.OriginalOutletID = lopd.LegionellaOutletID

	Insert into LegionellaOutletComputedData (ClientID,SiteID,JobID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		@ClientID,@SiteID,JobID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains
	FROM
		@LegionellaOutletComputedData


    Set NoCount Off;
End

GO


IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'ClientInvoiceDetailID' AND OBJECT_ID = OBJECT_ID('Quote'))
BEGIN
    ALTER TABLE [dbo].[Quote]
    ADD [ClientInvoiceDetailID] [int] NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Name' AND OBJECT_ID = OBJECT_ID('ClientInvoiceDetail'))
BEGIN
    ALTER TABLE [dbo].[ClientInvoiceDetail]
    ADD [Name] [varchar] (MAX) NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Email' AND OBJECT_ID = OBJECT_ID('ClientInvoiceDetail'))
BEGIN
    ALTER TABLE [dbo].[ClientInvoiceDetail]
    ADD [Email] [varchar] (MAX) NULL;
END
GO

IF NOT EXISTS(SELECT * FROM sys.columns WHERE name = 'Telephone' AND OBJECT_ID = OBJECT_ID('ClientInvoiceDetail'))
BEGIN
    ALTER TABLE [dbo].[ClientInvoiceDetail]
    ADD [Telephone] [varchar] (MAX) NULL;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'OfflineReportGeneration')
BEGIN
    EXEC('CREATE VIEW[dbo].[OfflineReportGeneration] AS SELECT 1 GO')
END

USE [TEAMS]
GO

/****** Object:  View [dbo].[OfflineReportGeneration]    Script Date: 09/05/2018 08:55:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER View [dbo].[OfflineReportGeneration]
As
/*
       Changes to this view need to be reflected in the trg_orgIntruction trigger on the orgInstruction table.
*/
Select
       i.orgInstructionID,
       i.JobID,
       JobNo,
       GenerateScriptURL,
       i.Created,
       i.EmployeeId,
       e.FullName as Employee,
       p.Description as Priority,
       i.orgStateID,
       Case When i.GenerationType = 'legionella' Then
              Case
                     When 
                           (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                                  And
                           Count(la.LegionellaApprovalId) > 0 -- Office Approved
                                  And
                           Count(je2.JobEmployeeId) = 0 -- Not Surveyor Approved
                     Then
                           'Awaiting Surveyor Approval'

                     When
                           Count(la.LegionellaApprovalId) > 0 -- Office Approved
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                     Then
                           'Awaiting Final Approval'
                     
                     Else
                           Case
                                  When i.orgStateID = 0 Then
                                         'Queued'
                                  Else
                                         s.ShortDescription
                           End
              End 

       Else
              Case
                     When 
                           (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                                  And
                           Count(sa.SurveyApprovalId) > 0 -- Office Approved
                                  And
                           Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
                     Then
                           'Awaiting Surveyor Approval'

                     When
                           Count(sa.SurveyApprovalId) > 0 -- Office Approved
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                     Then
                           'Awaiting Final Approval'
                     
                     Else
                           Case
                                  When i.orgStateID = 0 Then
                                         'Queued'
                                  Else
                                         s.ShortDescription
                           End
              End 
       
       End    as [State],
       Case When i.GenerationType = 'legionella' Then
              Case 
                     When 
                           (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                                  And
                           Count(la.LegionellaApprovalId) > 0 -- Office Approved
                                  And
                           Count(je2.JobEmployeeId) = 0 -- Not Surveyor Approved
                     Then
                           'The preview PDF has been approved but requires the surveyors approval.'

                     When
                           Count(la.LegionellaApprovalId) > 0 -- Office Approved
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                     Then
                           'The preview PDF has been pre-approved and is waiting final approval.'
                     
                     Else
                           Case
                                  When i.orgStateID = 0 Then
                                         'The report has been added to the queue.'
                                  Else
                                         s.Description
                           End
              End
       Else
              Case 
                     When 
                           (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                                  And
                           Count(sa.SurveyApprovalId) > 0 -- Office Approved
                                  And
                           Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
                     Then
                           'The preview PDF has been approved but requires the surveyors approval.'

                     When
                           Count(sa.SurveyApprovalId) > 0 -- Office Approved
                                  And 
                           i.orgStateID = 6 -- Preview Generation Succeeded
                     Then
                           'The preview PDF has been pre-approved and is waiting final approval.'
                     
                     Else
                           Case
                                  When i.orgStateID = 0 Then
                                         'The report has been added to the queue.'
                                  Else
                                         s.Description
                           End
              End
       End as StateDescription,
       EstimatedCompletion,
       PreApprovalPath,
       ApprovalPath,
       pdfDestination,
       PreApprovalGenerated,
       ApprovalGenerated,
       Completed,
       Cast(Count(sa.SurveyApprovalId) as bit) as SurveyApproved,
       Cast(Count(je.JobEmployeeId) as bit) as SurveyorApproved,
       Scheduled,
	   i.RetryAttempt
From
       orgInstruction i
       Inner Join Job j On i.JobID = j.JobId
       Inner Join orgPriority p On i.orgPriorityID = p.orgPriorityID
       Left Outer Join orgState s On i.orgStateID = s.orgStateID
       Inner Join Employee e On i.EmployeeId = e.EmployeeID
       Cross Join Config
       Left Outer Join SurveyApproval sa On sa.orgInstructionId = i.orgInstructionId And sa.DateDeleted Is Null
       Left Outer Join LegionellaApproval la On la.orgInstructionId = i.orgInstructionId And la.DateDeleted Is Null
       Left Outer Join JobEmployee je On je.JobId = i.JobId And je.EmployeeId = sa.EmployeeId And je.MainEmployee = 1
       Left Outer Join JobEmployee je2 On je2.JobId = i.JobId And je2.EmployeeId = la.EmployeeId And je2.MainEmployee = 1
Where
       i.Deleted Is Null
              AND
       IsNull(i.GenerationType,'')<>'bulk sample report'
Group By
       i.orgInstructionID,
       i.JobID,
       JobNo,
       GenerateScriptURL,
       i.Created,
       i.EmployeeId,
       e.FullName,
       p.Description,
       i.orgStateID,
       s.ShortDescription,
       s.Description,
       EstimatedCompletion,
       PreApprovalPath,
       ApprovalPath,
       pdfDestination,
       PreApprovalGenerated,
       ApprovalGenerated,
       Completed,
       Scheduled,       
       Config.b__SurveyorApprovalRequired,
       i.GenerationType,
	   i.RetryAttempt



GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[AutomaticEmail_PortalUserForSite]    Script Date: 05/14/2018 16:08:05 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[AutomaticEmail_PortalUserForSite]
    @PortalUserAutoEmailTypeID INT = NULL
/*
    For the Portal Automatic Email functionality, get the data that the Client can access. However, we only get the SiteID if we are want emails for this Site.
*/
AS
BEGIN
    SET NOCOUNT ON;


    -- Start the main SELECT.
    SELECT
        pu.PortalUserId [PortalUserID],
        pu.Email + ';' + pu.FullName [EMAILRECIPIENT],
        dbo.FormatTeamsDate(GETDATE(), 1) [EmailDate],
        si.Address + ISNULL(', ' + NULLIF(si.Postcode, ''), '') [SiteAddressWithPostcode],
        c.ClientIDs,
        ISNULL(pu.ProjectGroupID, 0) [ProjectGroupID],
        ISNULL(pu.ProjectID, 0) [ProjectID],
        si.SiteID [SiteID]
    FROM
        PortalUserAutoEmail puae WITH (NOLOCK)
        INNER JOIN PortalUserAutoEmailType puaet WITH (NOLOCK) ON puae.PortalUserAutoEmailTypeID = puaet.PortalUserAutoEmailTypeID
        INNER JOIN PortalUser pu WITH (NOLOCK) ON puae.PortalUserID = pu.PortalUserId AND pu.Deleted IS NULL
        INNER JOIN Site si WITH (NOLOCK) ON puae.SiteID = si.SiteID
        OUTER APPLY
        (
            SELECT STUFF((
                SELECT ',' + CAST(c.ClientID AS VARCHAR(50))
                FROM
                    ClientPortalUser cpu WITH (NOLOCK)
                    INNER JOIN Client c WITH (NOLOCK) ON cpu.ClientId = c.ClientID
                WHERE cpu.PortalUserId = pu.PortalUserId AND c.Deleted IS NULL
                GROUP BY c.ClientID
            FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '') [ClientIDs]
        ) c
    WHERE
        puae.PortalUserAutoEmailTypeID = @PortalUserAutoEmailTypeID
            AND
        puaet.Deleted IS NULL
            AND
        pu.Email LIKE '%@%' -- Add basic validation to make sure it's an email.


    SET NOCOUNT OFF;
END

GO


