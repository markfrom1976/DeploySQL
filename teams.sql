
-- IMPORTANT - DO NOT REMOVE --
USE [TEAMS]
GO
-- IMPORTANT - DO NOT REMOVE - END --

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_ServerwideReplaceVariables') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_ServerwideReplaceVariables] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Joe McLaughlin
-- Create date: 17/05/2018
-- Description:	Generic stored procedure, to go everywhere - MUST BE SAME EVERYWHERE!.
-- =============================================
ALTER PROCEDURE [dbo].[TEAMS_ServerwideReplaceVariables] 
	@DataID int
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @ReturnList TABLE (Ordering INT, ReplaceVariable VARCHAR(MAX), Replacement VARCHAR(MAX))
	
	--################ [SURVEYDATEALLREGISTERS] ################
		DECLARE @DateList TABLE (dayDate DATE)
		INSERT INTO @DateList (dayDate)
		SELECT
			exploded.Date
		FROM 
			(SELECT r.RegisterStart, r.RegisterFinish FROM JobEmployee je INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID WHERE je.JobID = @DataID) r
			OUTER APPLY (SELECT CAST(DATEADD(d,n.i,r.RegisterStart) as DATE) [Date] FROM (SELECT ROW_NUMBER() OVER (Order By c.Object_id)-1 [i] FROM sys.columns c) n WHERE n.i BETWEEN 0 AND datediff(d,r.RegisterStart,r.RegisterFinish)) exploded
		GROUP BY
			exploded.Date
		ORDER BY
			exploded.Date

		INSERT INTO @ReturnList (ReplaceVariable,Replacement)
		SELECT
			'[SURVEYDATEALLREGISTERS]',
			STUFF
			(
				(
					SELECT 
						', ' + 
						CAST(DAY(filteredDates.StartDate) AS varchar(2)) + ' ' + DATENAME(mm, filteredDates.StartDate) + ' ' + CAST(YEAR(filteredDates.StartDate) AS varchar(4))  +
						CASE WHEN filteredDates.StartDate != filteredDates.EndDate THEN ' - ' + CAST(DAY(filteredDates.EndDate) AS varchar(2)) + ' ' + DATENAME(mm, filteredDates.EndDate) + ' ' + CAST(YEAR(filteredDates.EndDate) AS varchar(4)) ELSE '' END
					FROM
						(
							SELECT
								MIN(dlg.dayDate) [StartDate], MAX(dlg.dayDate) [EndDate]
							FROM
								(SELECT dayDate,ROW_NUMBER() OVER(ORDER BY dayDate) [Identifier] FROM @DateList GROUP BY dayDate) dlg
							GROUP BY 
								DATEDIFF(day,dlg.Identifier,dlg.dayDate)
						) filteredDates
					GROUP BY
						filteredDates.StartDate, filteredDates.EndDate
					FOR XML PATH('')
				), 1, 2, ' '
			)
	--################ END [SURVEYDATEALLREGISTERS] ################

END

GO


IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='TestSignOff') AND name='LegionellaID') < 1
BEGIN
  ALTER TABLE TestSignOff
      ADD LegionellaID INT NULL
END
GO


INSERT INTO EquipmentCategory (EquipmentCategoryID,Description,SurveyType,AirTestType,RemovalType,SampleType,AirSampleType,NoEquipmentAllowed,LabType,LegionellaType,Deleted)
SELECT 67,'Centring Telescope',0,1,0,0,0,0,0,0,GETDATE() WHERE (SELECT COUNT(*) FROM EquipmentCategory WHERE EquipmentCategoryID=67)=0
INSERT INTO EquipmentCategory (EquipmentCategoryID,Description,SurveyType,AirTestType,RemovalType,SampleType,AirSampleType,NoEquipmentAllowed,LabType,LegionellaType,Deleted)
SELECT 68,'Personal Sampler',0,1,0,0,0,0,0,0,GETDATE() WHERE (SELECT COUNT(*) FROM EquipmentCategory WHERE EquipmentCategoryID=68)=0
INSERT INTO EquipmentCategory (EquipmentCategoryID,Description,SurveyType,AirTestType,RemovalType,SampleType,AirSampleType,NoEquipmentAllowed,LabType,LegionellaType,Deleted)
SELECT 69,'Rotameter',0,1,0,0,0,0,0,0,GETDATE() WHERE (SELECT COUNT(*) FROM EquipmentCategory WHERE EquipmentCategoryID=69)=0
INSERT INTO EquipmentCategory (EquipmentCategoryID,Description,SurveyType,AirTestType,RemovalType,SampleType,AirSampleType,NoEquipmentAllowed,LabType,LegionellaType,Deleted)
SELECT 70,'Water Bath',0,1,0,0,0,0,0,0,GETDATE() WHERE (SELECT COUNT(*) FROM EquipmentCategory WHERE EquipmentCategoryID=70)=0

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'JobLogNotes') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[JobLogNotes] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[JobLogNotes]
	@EnquiryId INT = NULL
	, @JobId INT = NULL
	, @SiteId INT = NULL
	, @QuoteId INT = NULL
	, @ParentQuoteId INT = NULL
	, @InvoiceId INT = NULL
	, @RemovalId INT = NULL
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

	-- tidy input variables
	SELECT @EnquiryId = ISNULL(@EnquiryId, 0)
	SELECT @JobId = ISNULL(@JobId, 0)
	SELECT @SiteId = ISNULL(@SiteId, 0)
	SELECT @QuoteId = ISNULL(@QuoteId, 0)
	SELECT @ParentQuoteId = ISNULL(@ParentQuoteId, 0)
	SELECT @InvoiceId = ISNULL(@InvoiceId, 0)
	SELECT @RemovalId = ISNULL(@RemovalId, 0)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)

	SELECT @DynamicSQL = ''

	IF @JobId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + '
			WITH
				Samples AS (
					SELECT 
						s.sampleid 
					FROM 
						Job j 
						INNER JOIN JobEmployee je ON je.JobID = j.JobID 
						INNER JOIN Register r On r.JobEmployeeID = je.JobEmployeeID 
						INNER JOIN Room rm ON rm.registerid = r.RegisterID 
						INNER JOIN Sample s ON s.RoomID = rm.RoomID 
					WHERE 
						j.jobid = ' + CAST(@JobId AS nvarchar(4000)) + ')
				,Airtests As (
					SELECT 
						AirTestId 
					FROM 
						AirTest a 
						INNER JOIN JobEmployee je ON a.JobEmployeeID = je.JobEmployeeID 
					WHERE 
						JobId = ' + CAST(@JobId AS nvarchar(4000)) + ') '
	END

	SELECT @DynamicSQL = @DynamicSQL + 'SELECT * FROM EmployeeNotes Where 1=2'

	IF @EnquiryId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Enquiry'' AND ItemId = ' + CAST(@EnquiryId AS nvarchar(4000)) + ') '
	END

	IF @QuoteId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Quote'' AND ItemId = ' + CAST(@QuoteId AS nvarchar(4000)) + ') '
	END

	IF @ParentQuoteId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Quote'' AND ItemId = ' + CAST(@ParentQuoteId AS nvarchar(4000)) + ') '
	END

	IF @RemovalId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Removal'' AND ItemId = ' + CAST(@RemovalId AS nvarchar(4000)) + ') '
	END

	IF @InvoiceId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Invoice'' AND ItemId = ' + CAST(@InvoiceId AS nvarchar(4000)) + ') '
	END

	IF @SiteId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' Or (NoteType = ''Site'' AND ItemId = ' + CAST(@SiteId AS nvarchar(4000)) + ') '
	END

	IF @JobId > 0 BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' 
			Or (NoteType = ''Job'' AND ItemId = ' + CAST(@JobId AS nvarchar(4000)) + ') 
			UNION
				SELECT 
					n.* 
				FROM 
					EmployeeNotes n 
					INNER JOIN Samples s ON n.NoteType = ''Sample'' AND n.ItemId = s.SampleId 
			UNION
				SELECT 
					n.* 
				FROM 
					EmployeeNotes n 
					INNER JOIN Airtests a On n.NoteType = ''AirTest'' AND n.ItemId = a.AirTestId'

		DECLARE
			@jobSiteID INT,
			@jobProjectId INT

		SELECT
			@jobSiteID = (SELECT SiteID FROM Job WHERE JobID = @JobId),
			@jobProjectId = (SELECT ProjectId FROM Job WHERE JobID = @JobId)

		IF @jobSiteID > 0 AND @jobProjectId > 0 BEGIN
			SELECT @DynamicSQL = @DynamicSQL + 
			' UNION
				SELECT
					SiteContactID,
					ContactText,
					''0.00'',
					DateCreated,
					CASE sc.ContactTypeID
						WHEN 1 THEN ''Phone call''
						WHEN 2 THEN ''Letter''
					END	,
					NULL,
					''000001'',
					e.Fullname,
					sc.EmployeeID,
					NULL,
					NULL,
					0,
					''SiteContact''
				FROM
					SiteContact sc
					INNER JOIN Employee e ON sc.EmployeeID = e.EmployeeID
				WHERE
					sc.DateDeleted IS NULL
						AND
					sc.SiteID = ' + CONVERT(VARCHAR(MAX), @jobSiteID) + 
					' AND
					sc.ProjectID = ' + CONVERT(VARCHAR(MAX), @jobProjectId)
		END

	END

	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY IsStarred DESC, DateCreated DESC'

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
END

GO

UPDATE LegionellaType Set LegionellaMonitoring=1

GO

update TeamsV2Tab set IsMvcTab = 1, EnableMvcGrid = NULL where TabText = 'Search Results'
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesCompletedJobs') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs] AS BEGIN SET NOCOUNT ON; END')
End
GO

ALTER PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesWorkInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='UserSalt'))
	BEGIN
		CREATE TABLE [dbo].[UserSalt] (
		[UserSaltID] [int] IDENTITY (1, 1) NOT NULL,
		[EmployeeID] [int] NULL,
		[PortalUserID] [int] NULL,
		[Salt] [varchar] (MAX) NULL,
		CONSTRAINT [PK_UserSalt]
		PRIMARY KEY CLUSTERED
		(
			[UserSaltID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF (SELECT CHARACTER_MAXIMUM_LENGTH
FROM INFORMATION_SCHEMA.COLUMNS
WHERE 
	TABLE_NAME = 'Employee'
		AND
	COLUMN_NAME = 'Password') = 50
BEGIN
	ALTER TABLE Employee ALTER COLUMN Password VARCHAR(MAX) NOT NULL
END
GO

IF (SELECT CHARACTER_MAXIMUM_LENGTH
FROM INFORMATION_SCHEMA.COLUMNS
WHERE 
	TABLE_NAME = 'PortalUser'
		AND
	COLUMN_NAME = 'Password') = 50
BEGIN
	ALTER TABLE PortalUser ALTER COLUMN Password nVARCHAR(MAX) NOT NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_AppointmentReinspectionCheck')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_AppointmentReinspectionCheck] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMS_AppointmentReinspectionCheck]
	@ProjectID INT = 0,
	@SiteID INT = 0,
	@JobID INT = 0,
	@ApplyGUID BIT = 0
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;

DECLARE @JobList TABLE (JobID INT)

-- Joe code to get current and previous version of a job
IF @ApplyGUID = 1
	BEGIN
		DECLARE @BaseSurveys TABLE (GroupNo INT,JobID INT,OrderingDate DATETIME)
		INSERT INTO @BaseSurveys (GroupNo,JobID,OrderingDate)
		SELECT
				ROW_NUMBER() OVER (Order by MAX(r.RegisterFinish)),j.JobID, MAX(r.RegisterFinish)
		FROM
			Job j
			INNER JOIN JobEmployee je ON je.JobID = j.JobID
			INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
			INNER JOIN Survey su ON su.SurveyID = r.SurveyID
			OUTER APPLY
			(
				SELECT TOP 1
					a.DateDeclined
				FROM
					Quote q
					INNER JOIN Appointment a ON q.QuoteID = a.QuoteID
				WHERE
					q.JobID = j.JobID
				ORDER BY
					a.DateDeclined
			) appDecl
		WHERE
			j.SiteID=@SiteID
				AND
			j.Approved IS NOT NULL
				AND
			appDecl.DateDeclined IS NULL
				AND
			(
				su.SurveyTypeID NOT IN (13,14,15,32,39,56,60,61,62,64,65,66,67,68,69)
					OR
				(r.GUID IS NOT NULL AND r.GUIDVersion = 1)
			)
		GROUP BY
			j.JobID,j.Approved

		DECLARE @ReMatch TABLE (GroupNo INT, GroupOrder INT,OriginalJobID INT,JobID INT,OrderingDate DATETIME)
		Insert into @ReMatch (GroupNo,GroupOrder,OriginalJobID,JobID,OrderingDate)
		SELECT
			bs.GroupNo,ROW_NUMBER() OVER (Partition By bs.GroupNo Order by ISNULL(filt.OrderingDate,bs.OrderingDate)),bs.JobID,filt.JobID,ISNULL(filt.OrderingDate,bs.OrderingDate)
		FROM
			@BaseSurveys bs
			INNER JOIN
			(
				SELECT
					j.JobID [OriginalJobID],rein.JobID, MAX(rein.RegisterStart) [OrderingDate]
				FROM
					Job j
					INNER JOIN 
					(
						Select JobID FROM @BaseSurveys
					) filt ON j.JobID=filt.JobID
					INNER JOIN JobEmployee je ON je.JobID = j.JobID
					INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
					INNER JOIN Survey su ON su.SurveyID = r.SurveyID
					INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
					INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
					INNER JOIN Sample s ON s.RoomID = rm.RoomID
					INNER JOIN
					(
						Select _j.JobID,_j.SiteID,_r.RegisterFinish [RegisterStart],_s.SampleRef FROM Job _j INNER JOIN JobEmployee _je ON _j.JobID=_je.JobID INNER JOIN Register _r ON _je.JobEmployeeID=_r.JobEmployeeID INNER JOIN Survey _su ON _su.SurveyID = _r.SurveyID INNER JOIN Floorplan _fp ON _r.RegisterID=_fp.RegisterID INNER JOIN Room _rm ON _rm.FloorplanID=_fp.FloorplanID INNER JOIN Sample _s ON _s.RoomID=_rm.RoomID Where _j.SiteID=@SiteID AND _s.SampleRef IS NOT NULL AND _s.AsSample=0
					) rein ON REPLACE(rein.SampleRef,'*','')=s.SampleRef AND j.JobID<>rein.JobID
				GROUP BY
						j.JobID,rein.JobID
			) filt ON filt.OriginalJobID=bs.JobID

			INSERT INTO @BaseSurveys (GroupNo,JobID,OrderingDate)
			SELECT
				ROW_NUMBER() OVER (Order by MAX(r.RegisterFinish))+(SELECT MAX(GroupNo) FROM @BaseSurveys), j.JobID, MAX(r.RegisterFinish)
			FROM
				Job j
				INNER JOIN JobEmployee je ON je.JobID = j.JobID
				INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp ON r.RegisterID=fp.RegisterID
			WHERE
				j.Approved IS NOT NULL
						AND
				j.SiteID=@SiteID
						AND
				j.JobID NOT IN (SELECT JobID FROM @BaseSurveys UNION SELECT JobID FROM @ReMatch)
			GROUP BY
				j.JobID

			SELECT
				ISNULL(bs.GroupNo, 0), 0 [GroupOrder],NULL [OriginalJobID], JobID, OrderingDate
			FROM
				@BaseSurveys bs
			UNION
			(
				SELECT
					bs.GroupNo, rm.GroupOrder [GroupOrder],IsNull((SELECT JobID FROM @ReMatch WHERE GroupNo=rm.GroupNo AND GroupOrder=rm.GroupOrder-1),rm.OriginalJobID) [OriginalJobID], rm.JobID, rm.OrderingDate
				FROM
					@BaseSurveys bs
					INNER JOIN @ReMatch rm ON bs.JobID=rm.OriginalJobID
			)
	END
ELSE
	-- Small basic check to get any jobs requiring a GUID
	BEGIN
		-- Get our jobs up front
		IF @ProjectID > 0 AND @SiteID = 0
		BEGIN
		INSERT INTO @JobList 
		SELECT
			JobID
		FROM
			Job j
		WHERE
			j.ProjectID = @ProjectID
				AND
			j.Approved IS NOT NULL
		END
		IF @SiteID > 0
		BEGIN
		INSERT INTO @JobList 
		SELECT
			JobID
		FROM
			Job j
		WHERE
			j.SiteID = @SiteID
				AND
			j.Approved IS NOT NULL
		END
		IF @JobID > 0
		BEGIN
		INSERT INTO @JobList 
		SELECT
			JobID
		FROM
			Job j
		WHERE
			j.JobId = @JobID
				AND
			j.Approved IS NOT NULL
		END

		-- Start the main select
		SELECT 
		ISNULL(STUFF((
			SELECT DISTINCT
				', ' + CONVERT(VARCHAR(MAX), j.JobID)
			FROM
				@JobList j
				INNER JOIN JobEmployee je ON j.JobID = je.JobID
				INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
				INNER JOIN Floorplan f ON r.RegisterId = f.RegisterID
				INNER JOIN Room rm ON f.FloorplanID = rm.FloorplanID
				INNER JOIN Sample s ON s.RoomID = rm.RoomID
			WHERE
				r.GUID IS NULL OR f.GUID IS NULL OR rm.GUID IS NULL OR s.GUID IS NULL
			FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''),'') [JobIdString]

		SET NOCOUNT OFF;
	END
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_DataBySiteSearch')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_DataBySiteSearch] AS BEGIN SET NOCOUNT ON; END')
END
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_DataBySiteSearch]    Script Date: 20/07/2018 11:47:15 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[TEAMS_DataBySiteSearch]
	@Site INT = NULL

AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

SELECT
	[Type] =			'Enquiry - ' + qvt.Description,
	[TypeNumber] =		e.EnquiryNo,
	[Status] =			CASE
							WHEN e.DateAccepted IS NOT NULL THEN 'Accepted'
							WHEN e.DateDiscarded IS NOT NULL THEN 'Discarded'
						ELSE
							'Outstanding'
						END						
FROM
	Enquiry e
	INNER JOIN QuoteType qt ON e.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
WHERE
	e.SiteID = @Site

	UNION

SELECT
	[Type] =			'Quote - ' + qvt.Description,
	[TypeNumber] =		q.QuoteNo,
	[Status] =			CASE
							WHEN q.Accepted IS NOT NULL THEN 'Accepted'
							WHEN q.Rejected IS NOT NULL THEN 'Rejected'
						ELSE
							'Outstanding'
						END						
FROM
	Quote q
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
WHERE
	q.SiteID = @Site

	UNION

SELECT
	[Type] =			'Job - ' + qvt.Description,
	[TypeNumber] =		j.JobNo,
	[Status] =			CASE
							WHEN a.ManuallyMarkWorkDone = 1 THEN 'Completed'
							WHEN qt.QuoteTypeID = 5 AND je.JobEmployeeID IS NOT NULL THEN 'Completed'
						ELSE
							CASE
								WHEN j.Approved IS NULL THEN 'In Progress'
							ELSE
								'Completed'
							END
						END
FROM
	Job j
	LEFT JOIN JobEmployee je ON j.JobID = je.JobID
	INNER JOIN Quote q ON j.JobID = q.JobID
	OUTER APPLY
	(
		SELECT TOP 1
			_a.ManuallyMarkWorkDone
		FROM
			Appointment _a
		WHERE
			_a.QuoteID = q.QuoteID		
				AND
			_a.DateDeclined IS NULL
		ORDER BY
			_a.ManuallyMarkWorkDone
	) a
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
WHERE
	j.SiteID = @Site

	UNION

SELECT
	[Type] =			it.InvoiceType,
	[TypeNumber] =		i.InvoiceNo,
	[Status] =			CASE
							WHEN i.DateCompleted IS NOT NULL THEN 'Completed'
							WHEN i.DateDiscarded IS NOT NULL THEN 'Discarded'
						ELSE
							'In Progress'
						END
FROM
	InvoiceItem ii
	INNER JOIN Invoice i ON ii.InvoiceID = i.InvoiceID
	INNER JOIN InvoiceType it ON i.InvoiceTypeID = it.InvoiceTypeID
WHERE
	ii.SiteID = @Site
ORDER BY
	Type,
	TypeNumber DESC

	SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Employee') AND name='HTMLRiskAssessorInfo') < 1
BEGIN
  ALTER TABLE Employee
      ADD HTMLRiskAssessorInfo VARCHAR(MAX) NULL
END

GO

IF (SELECT COUNT(*) FROM TeamsV2SubSubTab WHERE TabText = 'Seperate Appointment') = 0
BEGIN
	insert into TeamsV2SubSubTab (TeamsV2SubTabID, TabText, [Order], IsMvcTab, IsHidden)
	SELECT TeamsV2SubTabID, 'Seperate Appointment', 9, 1, IsHidden FROM TeamsV2SubSubTab WHERE TabText = 'Job Wizard'
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Management_GetProjects')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[TEAMS_Management_GetProjects] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_Management_GetProjects]    Script Date: 26/07/2018 08:45:08 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






-- =============================================
-- Author:		Daniel Wilton
-- Create date: 12/07/2018
-- Description:	Stored procedure for the new V2 Management - Projects grid
-- =============================================
ALTER PROCEDURE [dbo].[TEAMS_Management_GetProjects]
	-- Add the parameters for the stored procedure here
	@Client int = 0,
	@project int = 0,
	@HideCompleted bit = 1,
	@HideSubProjects bit = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	-- Project Data
	DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), SiteCount INT, PrjGrpMaximumNumberOfSites INT, SitesBookedCount INT, SitesCompletedCount INT, DueDate DATETIME, GroupEmployeeID INT)

	INSERT INTO @ProjectData (ClientID, Client, ProjectID, SubProjectName, ProjectGroupID, ProjectGroup, SiteCount, PrjGrpMaximumNumberOfSites, SitesBookedCount, SitesCompletedCount, DueDate, GroupEmployeeID)
	SELECT
		c.ClientID,
		c.Client,
		p.ProjectID,
		p.GroupName,
		pg.ProjectGroupID,
		pg.ProjectGroup,
		SiteCount.SiteCount,
		p.PrjGrpMaximumNumberOfSites,
		SitesCount.SitesBookedCount,
		SitesCount.SitesCompletedCount,
		p.DueDate,
		pg.EmployeeId
	FROM
		Project p
		INNER JOIN ProjectGroup pg WITH (NOLOCK) ON p.ProjectGroupId = pg.ProjectGroupId
		INNER JOIN Client c WITH (NOLOCK) ON p.ClientID = c.ClientID

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
				ProjectSite ps
			WHERE
				ps.ProjectID = p.ProjectID
		) SiteCount

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT a.SiteID) [SitesBookedCount],
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
			WHERE
				a.ProjectID = p.ProjectID
					AND
				a.DateDeclined IS NULL
		) SitesCount

	WHERE
		(
			CASE
				WHEN @Client > 0
				THEN
					CASE
						WHEN @Client = c.ClientID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @Project > 0
				THEN
					CASE
						WHEN @Project = p.ProjectID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @HideCompleted = 1
				THEN
					CASE
						WHEN pg.DateCompleted IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		pg.DateDeleted IS NULL

	-- Data for all appointments for projects gotten above
	DECLARE @ProjectAppointmentData TABLE (IndexID INT IDENTITY(1,1), SiteID INT, Starts DATETIME, Ends DATETIME, ProjectID INT, ProjectGroupID INT, AppointmentProjectID INT)

	INSERT INTO @ProjectAppointmentData (SiteID, Starts, Ends, ProjectID, ProjectGroupID, AppointmentProjectID)

	SELECT
		a.SiteID,
		a.StartTime,
		a.EndTime,
		pd.ProjectID,
		pd.ProjectGroupID,
		a.ProjectID
	FROM
		Appointment a
		INNER JOIN @ProjectData pd ON a.ProjectID = pd.ProjectID
	WHERE
		a.DateDeclined IS NULL
			AND
		a.AppointmentTypeID IN (1,3)

	-- Data for all project group for projects gotten above
	DECLARE @ProjectGroupData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupID INT, SiteCount INT, SitesRequiredCount INT, SitesBookedCount INT, SitesCompletedCount INT)

	INSERT INTO @ProjectGroupData (ProjectGroupID, SiteCount, SitesRequiredCount, SitesBookedCount, SitesCompletedCount)
	SELECT
		pd.ProjectGroupID,
		ProjectGroupSite.SiteCount,
		ISNULL(NULLIF(ProjectGroupSitesRequired.SitesRequiredCount, 0), ProjectGroupSite.SiteCount),
		(SELECT SUM(pd2.SitesBookedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID),
		(SELECT SUM(pd2.SitesCompletedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID)
	FROM
		@ProjectData pd

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
			(
				SELECT
					ps.SiteID
				FROM
					ProjectSite ps
					INNER JOIN Project p WITH (NOLOCK) ON p.ProjectID = ps.ProjectID
				WHERE
					p.ProjectGroupId = pd.ProjectGroupID
				
			) a
		) ProjectGroupSite

		OUTER APPLY
		(
			SELECT
				SUM(ISNULL(NULLIF(pd2.PrjGrpMaximumNumberOfSites, 0), pd2.SiteCount)) [SitesRequiredCount]
			FROM
				@ProjectData pd2
			WHERE
				pd2.ProjectGroupId = pd.ProjectGroupID
		) ProjectGroupSitesRequired

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL

				LEFT JOIN Project p WITH (NOLOCK) ON a.ProjectId = p.ProjectID
			WHERE
				p.ProjectGroupID = pd.ProjectGroupID
					AND
				a.DateDeclined IS NULL
		) ProjectGroupSitesCount


	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT)

	INSERT INTO @MainData (ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive)
	SELECT
		pd.ClientID,
		pd.Client,

		-- Project Data
		pd.ProjectID,
		pd.SubProjectName,
		pd.SiteCount,
		CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pd.SiteCount > 0 AND ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(pd.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pd.SiteCount AS FLOAT)) / CAST(pd.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
		pd.SitesBookedCount,
		pd.SitesCompletedCount,
		CAST((ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) - pd.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) [OutstandingJobsCount],
		CONVERT(VARCHAR, pd.DueDate, 104) [DueDate],

		-- Project Group Data
		pd.ProjectGroupID,
		pd.ProjectGroup,
		ProjectGroupSite.SiteCount [PGSiteCount],
		CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) + ' (' + CASE WHEN ProjectGroupSite.SiteCount > 0 AND ProjectGroupSitesCount.SitesRequiredCount > 0 THEN CAST(LEFT(((CAST(ProjectGroupSitesCount.SitesRequiredCount AS FLOAT) / CAST(ProjectGroupSite.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [PGSitesRequiredCount],
		ProjectGroupSitesCount.SitesBookedCount [PGSitesBookedCount],
		ProjectGroupSitesCount.SitesCompletedCount [PGSitesCompletedCount],
		CAST((ProjectGroupSitesCount.SitesRequiredCount - ProjectGroupSitesCount.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) [PGOutstandingJobsCount],
		AppData.MinStart [Starts],
		AppData.MaxEnd [Ends],
		e.FullName [ProjectManager],
		CASE WHEN AppData.MinStart < GETDATE() AND AppData.MaxEnd > GETDATE() THEN 1 ELSE 0 END [IsActive]
	FROM
		@ProjectData pd
		LEFT JOIN Employee e WITH (NOLOCK) ON pd.GroupEmployeeId = e.EmployeeID
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SiteCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSite
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SitesRequiredCount, pgd.SitesBookedCount, pgd.SitesCompletedCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSitesCount
	
		OUTER APPLY
		(
			SELECT
				MIN(pad.Starts) [MinStart],
				MAX(pad.Ends) [MaxEnd]
			FROM
				@ProjectAppointmentData pad
			WHERE
				pad.ProjectGroupID = pd.ProjectGroupID
		) AppData
	ORDER BY
		ProjectGroup, SubProjectName

	-- Insert the header rows
	INSERT INTO @MainData
	SELECT DISTINCT ClientID, Client, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive
	FROM @MainData

	-- Main select
	SELECT
		md.ClientID,
		md.Client,
		CASE
			WHEN md.ProjectID IS NULL
			THEN 1
			ELSE 0
		END [IsProjectGroup],
		md.ProjectGroupID [ProjectGroupID],
		ISNULL(md.ProjectID, 0) [ProjectID],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectGroup
			ELSE md.SubProjectName
		END [Name],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSiteCount
			ELSE md.SiteCount
		END [Sites],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesRequiredCount
			ELSE md.SitesRequiredCount
		END [SitesRequired],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesBookedCount
			ELSE md.SitesBookedCount
		END [SitesBooked],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesCompletedCount
			ELSE md.SitesCompletedCount
		END [SitesCompleted],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGOutstandingJobsCount
			ELSE md.OutstandingJobsCount
		END [OutstandingJobs],
		md.DueDate,
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Starts
			ELSE null
		END [Starts],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Ends
			ELSE null
		END [Ends],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectManager
			ELSE null
		END [ProjectManager],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.IsActive
			ELSE null
		END [IsActive]
	FROM
		@MainData md
	WHERE
		(CASE
			WHEN @HideSubProjects = 1
			THEN
				CASE
					WHEN md.ProjectID IS NULL
					THEN 1
					ELSE 0
				END
			ELSE 1
		END) = 1
	ORDER BY
		md.ProjectGroup,
		md.SubProjectName
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'AppointmentToolTipData')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[AppointmentToolTipData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[AppointmentToolTipData]
	@AppointmentID int,
	@JobID INT = 0
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;
	
	
-- Stand alone site appointments.
Select
    q.Exclusions,
    q.ScopeOfWork,
    q.Notes,
    MobileDataReturned,
    MobileDataReturnedOutsideOfScope,
    MobileData,
    NoAccess,
    noAccessOutsideOfScope,
    ProjectId,
    Project,
    JobNo,
    DateDeclined,
    DateConfirmed,
    CASE
		WHEN main.AppointmentTypeId = 4
		THEN main.TrainingType
	ELSE
		AppointmentType
	END [AppointmentType],
    appCategoryDescription,
    HTML_COLOUR,
    Client,
    Site,
	ISNULL(UPRN,'') as UPRN,
    Main.Cost,
    IsNull(AppointmentGroup.StartTime, Main.StartTime) as StartTime,
    IsNull(AppointmentGroup.EndTime, Main.EndTime) as EndTime,
    t.Description as SurveyType, 
    apBranch.branchoffice 
From 
(
	Select
		DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
		DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
		DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
		Case
			When Cast(a.StartTime as Date) = Cast(a.EndTime as Date) Then
				DateDiff(n, a.StartTime, a.EndTime)
			Else
				DateDiff(n, a.StartTime, DateAdd(d, 1, Cast(Cast(a.StartTime as date) as datetime)))
			End as Duration,
		a.StartTime, 
		a.EndTime,
		a.AppointmentID,
		IsNull(at.AppointmentType, '') As AppointmentType,
		c.ClientID,
		IsNull(c.Client, '') as Client,
		p.ProjectID,
		IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
		s.SiteID,
		Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
		s.Address,
		s.Postcode,
		s.UPRN,
		j.JobId,
		j.JobNo,
	--	a.ClientOrderNo,
		a.Cost,
		a.DateConfirmed,
	--	Cast(a.Notes as varchar(max)) as Notes,
		a.CalendarFileID,
		e.EmployeeID, 
		e.FullName AS Employee,
		a.BranchOfficeId,
		COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
		ac.HTML_Colour,
		a.AppointmentGroupId,
		a.ProjectAppointmentId,
		Case
			When a.ManuallyMarkWorkDone = 1 Then
				1
			When IsNull(qe.EmployeeId, 0) > 0 And a.AppointmentTypeId = 8 Then
				1
			Else
				Cast((Select Count(*) From JobEmployeeAppointment Where AppointmentID = a.AppointmentID) as bit)
		End AS MobileDataReturned,
	    CASE WHEN (
					SELECT 
	                    Count(*) 
					FROM 
	                    JobEmployeeAppointment 
						left OUTER JOIN [dbo].[JobEmployee] sje ON [sje].[JobEmployeeID] = [JobEmployeeAppointment].[JobEmployeeID] 
					WHERE 
	                    [sje].[JobID] = [j].[JobID]
				)>0 THEN
			1
		ELSE
	        0
	    END MobileDataReturnedOutsideOfScope,
		Case
			When a.ManuallyMarkWorkDone = 1 Then
				1
		ELSE
			CASE a.AppointmentTypeID
				WHEN 1 THEN (Select COUNT(*) FROM Register r INNER JOIN JobEmployee je ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
				WHEN 3 THEN (Select COUNT(*) FROM AirTest at INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
				--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
			END
		END MobileData,
		Cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL AND Cast(Created as date) = Cast(a.StartTime as date)) as bit) AS NoAccess,
		cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL) as bit) AS noAccessOutsideOfScope,
		DateDeclined,
		at.AppointmentTypeId,
		tt.TrainingType
	From
		Appointment a
		Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
		Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
		LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
		Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
		Left Outer Join Client c On a.ClientID = c.ClientID
		Left Outer Join Site s On s.SiteID = a.SiteID
		Left Outer Join Project p On p.ProjectID = a.ProjectID
		Left Outer Join Quote q On q.QuoteID = a.QuoteID
		Left Outer JOin QuoteEmployee qe On qe.QuoteId = q.QuoteId
		Left Outer Join Job j On j.JobID = q.JobID
		Left Outer Join AppointmentEmployee ae On ae.AppointmentID = a.AppointmentID
		Left Outer Join Employee e On ae.EmployeeID = e.EmployeeID
	Where
		ProjectAppointmentId Is Null
			AND
		a.AppointmentID=@AppointmentID
			AND
		(j.JobID = @JobID OR @JobID = 0)
			AND
		a.DateDeclined Is Null 
	Union

	-- Project site appointments.
	Select
		DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
		DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
		DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
		DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)) as Duration,
		a.StartTime, 
		a.EndTime,
		(Select Min(AppointmentID) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentID,
		--a.AppointmentID,
		IsNull(at.AppointmentType, '') As AppointmentType,
		c.ClientID,
		IsNull(c.Client, '') as Client,
			p.ProjectID,
		IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
		s.SiteID,
		Cast(Count(*) as varchar(10)) + ' Sites in total' as Site,
		Project as Address,
		s.Postcode,
		s.UPRN,
		Null as JobId,
		CASE
			WHEN COUNT(*) = 1 
			THEN j.JobNo
		ELSE
			NULL
		END as JobNo,
		--	a.ClientOrderNo,
		a.Cost,
		(Select Min(DateConfirmed) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as DateConfirmed,
	--	cast(a.Notes as varchar(max)) Notes,
		0 as CalendarFileID,
		e.EmployeeID, 
		e.FullName as Employee,
		a.BranchOfficeId,
		COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
		ac.HTML_Colour,	
		(Select Min(AppointmentGroupId) From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentGroupId,
		a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- ignore for project appointments, instead rely on returned jobs below.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	0 AS NoAccess,-- ignore for project appointments, instead rely on returned jobs below.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	Outer Apply
	(
		Select Top 1 SiteId From Appointment Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null)) Order By DateCreated
	) as ProjectAppointmentSite
	OUTER APPLY
	(
		SELECT TOP 1 
			j.JobNo
		FROM
			Job j
			INNER JOIN Quote q ON j.JobID = q.JobID
		WHERE
			q.QuoteID = a.QuoteID
	) j
	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = ProjectAppointmentSite.SiteId
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join AppointmentEmployee ae On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e On ae.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	a.AppointmentID=@AppointmentID
		AND
	a.DateDeclined Is Null 
Group By
 	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime), 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)), 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime),
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)),
	a.StartTime, 
	a.EndTime,
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	ISNULL(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.Postcode,
	s.UPRN,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType,
	j.JobNo

Union

-- Completed Project Site Jobs
Select
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime) as OffsetStart, 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime) as OffsetEnd,
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)) as Duration,
	jea.StartTime, 
	jea.EndTime,
--	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	a.AppointmentId,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	1 AS MobileDataReturned,-- Always true for returned jobs.
    0 AS MobileDataReturnedOutsideOfScope,
    CASE a.AppointmentTypeID
		WHEN 1 THEN (Select COUNT(*) FROM Register r INNER JOIN JobEmployee je ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		WHEN 3 THEN (Select COUNT(*) FROM AirTest at INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
    END MobileData,
	Cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL And Cast(Created as date) = Cast(jea.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess Where JobID = j.JobID And Deleted IS NULL) as bit) AS noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	INNER JOIN Quote q ON a.QuoteID=q.QuoteID
	Inner Join JobEmployeeAppointment jea On a.AppointmentID = jea.AppointmentID
	Inner Join JobEmployee je On jea.JobEmployeeID = je.JobEmployeeID
	Inner Join Job j On je.JobID = j.JobId

	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = j.SiteID
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join Employee e On je.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	a.AppointmentID=@AppointmentID
		AND
	(j.JobID = @JobID OR @JobID = 0)
		AND
	a.DateDeclined Is Null 
Group By
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime), 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)), 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime),
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)),
	jea.StartTime, 
	jea.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
	q.JobID,
	a.AppointmentTypeID,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType

Union

-- No Access Project Site Jobs
Select
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created) as OffsetStart, 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)) as Days, 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created) as OffsetEnd,
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)) as Duration,
	na.Created as StartTime, 
	na.Created as EndTime,
	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- Never true since this section is only for things that have no JEA record!.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	1 AS NoAccess,-- Always true, this is no access query.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	at.AppointmentTypeId,
	tt.TrainingType
From
	Appointment a
	Inner Join Quote q On a.QuoteID = q.QuoteID
	Inner Join Job j On q.JobID = j.JobID
	Inner Join NoAccess na On q.JobID = na.JobID

	Left Outer Join AppointmentCategory ac On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at On at.AppointmentTypeId = a.AppointmentTypeID
	LEFT JOIN AppointmentTraining att ON a.AppointmentID = att.AppointmentID
	Left Outer Join TrainingType tt On att.TrainingTypeID = tt.TrainingTypeID
	Left Outer Join Client c On a.ClientID = c.ClientID
	Left Outer Join Site s On s.SiteID = j.SiteID
	Left Outer Join Project p On p.ProjectID = a.ProjectID
	Left Outer Join Employee e On na.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	(Select COUNT(*) FROM Appointment Inner Join JobEmployeeAppointment jea On Appointment.AppointmentID = jea.AppointmentID Where Appointment.AppointmentID=a.AppointmentID)=0
	AND
	a.AppointmentID=@AppointmentID
		AND
	(j.JobID = @JobID OR @JobID = 0)
		AND
	a.DateDeclined Is Null 
Group By
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created), 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)), 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created),
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)),
	na.Created, 
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	at.AppointmentTypeId,
	tt.TrainingType) Main
	Outer Apply
    (
        Select
            Min(StartTime) as StartTime,
            Max(EndTime) as EndTime
        From
            Appointment
        Where
            AppointmentGroupId = Main.AppointmentGroupId
               And
			DateDeclined Is Null
    ) AppointmentGroup 
    OUTER APPLY
    (
        Select 
            app.AppointmentID, 
            dbo.Ellipsis(IsNull(q.ScopeOfWork, ''), 50) as ScopeOfWork, 
            dbo.Ellipsis(IsNull(q.Exclusions, ''), 50) as Exclusions, 
            dbo.Ellipsis(IsNull(Notes, ''), 500) as Notes 
        From 
            Appointment app  
            Left Outer Join Quote q on app.QuoteId = q.QuoteId 
        Where
			app.AppointmentId = Main.AppointmentId 
    ) q 
    Left Outer Join AppointmentSurvey s On Main.AppointmentId = s.AppointmentId 
    Left Outer Join SurveyType t On s.SurveyTypeId = t.SurveyTypeId 
    Left Outer Join branchoffice apBranch On apBranch.branchofficeid = Main.branchofficeid 
	
	SET NOCOUNT OFF;
END

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__XeroInvoiceIntegrated') < 1
BEGIN
  ALTER TABLE [dbo].[Config]
	ADD [b__XeroInvoiceIntegrated] [bit] NOT NULL
	CONSTRAINT [DF_Config_b__XeroInvoiceIntegrated]
	DEFAULT (0);
END

GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='XeroConfig'))
	BEGIN
		CREATE TABLE [dbo].[XeroConfig] (
		[XeroConfigID] [int] IDENTITY (1, 1) NOT NULL,
		[ConsumerKey] [varchar] (MAX) NOT NULL,
		[ConsumerSecret] [varchar] (MAX) NOT NULL,
		[CertificatePassword] [varchar] (MAX) NULL,
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaWip')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaWip] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[dgLegionellaWip] AS 
	Select
		j.JobId,
		qvt.QuoteVisitTypeId [TypeID], 
		qvt.Description [Type], 
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		Cast(MIN(a.StartTime) as date) [Start],
		Cast(MIN(a.EndTime) as date) [Finish],
		Cast(MIN(a.EndTime) as date) [MonitoringSchedule],
		Cast(MAX(agt.DueDate) as date) [Due], 
		c.ClientId,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteId,
		s.Address [Site],
		0 As [Report],
		0 As [Photos],
		0 As [Plans],
		0 As [Documents],
		j.Approved [DateApproved],
		0 [HasNotes],
		0 [NotesInLastHour],
		0 [NewGrid],
		j.Status [Status],
		'' [OrgState],
		0 As [PDF],
		qe.EmployeeID [EmployeeID],
		e.FullName,
		j.ProjectID
	From 
		Quote q WITH (NOLOCK)
		INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID=qe.QuoteID
		INNER JOIN Employee e WITH (NOLOCK) ON qe.EmployeeID = e.EmployeeID
		INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
		INNER JOIN QuoteVisitType qvt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
		Inner Join Appointment a WITH (NOLOCK) On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)
		INNER JOIN
		(
			Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag WITH (NOLOCK)
					UNION
			Select null [DueDate], at.AppointmentID FROM AppointmentTraining at WITH (NOLOCK)
		) agt ON agt.AppointmentID=a.AppointmentID
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=q.JobID
		Left Outer Join Client c WITH (NOLOCK) On a.ClientId = c.ClientId
		Left Outer Join Site s WITH (NOLOCK) On a.SiteId = s.SiteId
		Outer Apply 
		(
			Select Top 1 [FileName] From PDF p WITH (NOLOCK) Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
		) oa_pdf
	Where
		(Select COUNT(*) FROM Appointment suba WITH (NOLOCK) Where ManuallyMarkWorkDone=1 AND QuoteID=q.QuoteID AND suba.AppointmentTypeID IN (5,4) AND suba.DateDeclined IS NULL) = 0
			And
		a.DateConfirmed IS NOT Null
			And
		a.DateDeclined Is Null
			And
		qvt.QuoteVisitTypeId=4
	GROUP BY
		j.JobId,
		qvt.QuoteVisitTypeId,
		qvt.Description,
		j.JobNo,
		c.ClientId,
		c.Client,
		c.BranchName,
		s.SiteId,
		s.Address,
		j.Approved,
		j.Status,
		qe.EmployeeID,
		e.FullName,
		j.ProjectID
GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'AirTestDataCollectionQuestionPhotos') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[AirTestDataCollectionQuestionPhotos]    Script Date: 16/08/2018 10:38:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos]
      @AirTestID INT,
	  @IncludeAutoInsert BIT = 1,
	  @IncludePhotoEntry BIT = 1
AS
BEGIN
      
    SET NOCOUNT ON

	SELECT
		results.Type,
		ImageSize,
		PhotoID,
		PhotoReplaceVariable,
		PhotoReplaceVariableNoAutoInsert,
	    Caption,
	    CaptionReplaceVariable,
	    CaptionReplaceVariableNoAutoInsert,
	    TimeStamp,
	    TimeStampVariable,
	    TimeStampReplaceNoAutoInsert
	FROM
	(
		SELECT 
			main.[Type],
            ' width="' + CAST(mcWidth.[MobileConfigInt] as varchar) + '" height="' + CAST(mcHeight.[MobileConfigInt] as varchar) + '"' [ImageSize],
            main.PhotoID,
            main.PhotoReplaceVariable,
			main.PhotoReplaceVariableNoAutoInsert,
            main.Caption,
            main.CaptionReplaceVariable,
			main.CaptionReplaceVariableNoAutoInsert,
            main.TimeStamp,
            main.TimeStampVariable,
			main.TimeStampReplaceNoAutoInsert,
			main.AutoInsert,
			main.[Order]

		FROM
		(
			SELECT
				'PhotoEntry' [Type], ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by i.InspectionID) [Order], p.PhotoID [PhotoID], 0 [SELNO], 
				'[AirTestQuestionPhotoID:' + CAST(p.PhotoID as varchar) + ']' [PhotoReplaceVariable], '' [PhotoReplaceVariableNoAutoInsert], 'N/A' [Caption], '' [CaptionReplaceVariable], '' [CaptionReplaceVariableNoAutoInsert], '' [TimeStamp],'' [TimeStampVariable], '' [TimeStampReplaceNoAutoInsert], 0 [AutoInsert]
			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.EntryType='PhotoEntry'
				INNER JOIN Photo p ON i.InspectionInt = p.PhotoID

			WHERE
				i.AirTestID = @AirTestID
					AND
				@IncludePhotoEntry = 1

            UNION

			SELECT
				'PhotoCollection' [Type], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [Order], 
				p.PhotoID [PhotoID], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [SELNO], 
				REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariable], 
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,']]',']:NOAUTOINSERT]') + '','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariableNoAutoInsert], 
				IsNull(pc.Caption,'N/A') [Caption], 
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION]') [CaptionReplaceVariable],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION:NOAUTOINSERT]') [CaptionReplaceVariableNoAutoInsert],
				CONVERT(varchar,pc.Created,IsNull((Select MobileConfigInt FROM MobileConfig Where MobileConfigTypeID=88),103)) [TimeStamp],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME]') [TimeStampVariable],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME:NOAUTOINSERT]') [TimeStampReplaceNoAutoInsert],
				pc.AutoInsert

			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.PhotoCollection IS NOT NULL
				INNER JOIN PhotoCollection pc ON i.InspectionID = pc.InspectionID AND pc.IncludeInPDF IS NOT NULL
				INNER JOIN Photo p ON p.PhotoID=pc.PhotoID

			WHERE
				i.AirTestID = @AirTestID
		) main
		LEFT OUTER JOIN MobileConfig mcWidth WITH (NOLOCK) ON mcWidth.MobileConfigText='Width' AND mcWidth.MobileConfigTypeID=96
        LEFT OUTER JOIN MobileConfig mcHeight WITH (NOLOCK) ON mcHeight.MobileConfigText='Height' AND mcHeight.MobileConfigTypeID=96
	) results

	WHERE
		CASE
			WHEN @IncludeAutoInsert = 1
			THEN 1
			ELSE
				CASE
					WHEN AutoInsert = 1
					THEN 0
					ELSE 1
				END
			END = 1

	Order By
		results.[Order]

      SET NOCOUNT OFF
      
END

IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'Projects') < 1
BEGIN
	INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order]) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'Projects', 2)
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Quote') AND name='CurrencyId') < 1
BEGIN
  ALTER TABLE Quote
      ADD CurrencyId INT NULL
END
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_Management_GetProjects]    Script Date: 21/08/2018 11:08:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Project') AND name='LegionellaTypeID') < 1
BEGIN
  ALTER TABLE Project
      ADD LegionellaTypeID INT NULL
END
GO

-- =============================================
-- Author:		Daniel Wilton
-- Create date: 12/07/2018
-- Description:	Stored procedure for the new V2 Management - Projects grid
-- =============================================
ALTER PROCEDURE [dbo].[TEAMS_Management_GetProjects]
	-- Add the parameters for the stored procedure here
	@Client int = 0,
	@project int = 0,
	@HideCompleted bit = 1,
	@HideSubProjects bit = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	-- Project Data
	DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), SiteCount INT, PrjGrpMaximumNumberOfSites INT, SitesBookedCount INT, SitesCompletedCount INT, DueDate DATETIME, GroupEmployeeID INT, LegionellaTypeID INT)

	INSERT INTO @ProjectData (ClientID, Client, ProjectID, SubProjectName, ProjectGroupID, ProjectGroup, SiteCount, PrjGrpMaximumNumberOfSites, SitesBookedCount, SitesCompletedCount, DueDate, GroupEmployeeID, LegionellaTypeID)
	SELECT
		c.ClientID,
		c.Client,
		p.ProjectID,
		p.GroupName,
		pg.ProjectGroupID,
		pg.ProjectGroup,
		SiteCount.SiteCount,
		p.PrjGrpMaximumNumberOfSites,
		SitesCount.SitesBookedCount,
		SitesCount.SitesCompletedCount,
		p.DueDate,
		pg.EmployeeId,
		ISNULL(p.LegionellaTypeID, 0)
	FROM
		Project p
		INNER JOIN ProjectGroup pg WITH (NOLOCK) ON p.ProjectGroupId = pg.ProjectGroupId
		INNER JOIN Client c WITH (NOLOCK) ON p.ClientID = c.ClientID

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
				ProjectSite ps
			WHERE
				ps.ProjectID = p.ProjectID
		) SiteCount

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT a.SiteID) [SitesBookedCount],
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
			WHERE
				a.ProjectID = p.ProjectID
					AND
				a.DateDeclined IS NULL
		) SitesCount

	WHERE
		(
			CASE
				WHEN @Client > 0
				THEN
					CASE
						WHEN @Client = c.ClientID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @Project > 0
				THEN
					CASE
						WHEN @Project = p.ProjectID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @HideCompleted = 1
				THEN
					CASE
						WHEN pg.DateCompleted IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		pg.DateDeleted IS NULL

	-- Data for all appointments for projects gotten above
	DECLARE @ProjectAppointmentData TABLE (IndexID INT IDENTITY(1,1), SiteID INT, Starts DATETIME, Ends DATETIME, ProjectID INT, ProjectGroupID INT, AppointmentProjectID INT)

	INSERT INTO @ProjectAppointmentData (SiteID, Starts, Ends, ProjectID, ProjectGroupID, AppointmentProjectID)

	SELECT
		a.SiteID,
		a.StartTime,
		a.EndTime,
		pd.ProjectID,
		pd.ProjectGroupID,
		a.ProjectID
	FROM
		Appointment a
		INNER JOIN @ProjectData pd ON a.ProjectID = pd.ProjectID
	WHERE
		a.DateDeclined IS NULL
			AND
		a.AppointmentTypeID IN (1,3)

	-- Data for all project group for projects gotten above
	DECLARE @ProjectGroupData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupID INT, SiteCount INT, SitesRequiredCount INT, SitesBookedCount INT, SitesCompletedCount INT)

	INSERT INTO @ProjectGroupData (ProjectGroupID, SiteCount, SitesRequiredCount, SitesBookedCount, SitesCompletedCount)
	SELECT
		pd.ProjectGroupID,
		ProjectGroupSite.SiteCount,
		ISNULL(NULLIF(ProjectGroupSitesRequired.SitesRequiredCount, 0), ProjectGroupSite.SiteCount),
		(SELECT SUM(pd2.SitesBookedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID),
		(SELECT SUM(pd2.SitesCompletedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID)
	FROM
		@ProjectData pd

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
			(
				SELECT
					ps.SiteID
				FROM
					ProjectSite ps
					INNER JOIN Project p WITH (NOLOCK) ON p.ProjectID = ps.ProjectID
				WHERE
					p.ProjectGroupId = pd.ProjectGroupID
				
			) a
		) ProjectGroupSite

		OUTER APPLY
		(
			SELECT
				SUM(ISNULL(NULLIF(pd2.PrjGrpMaximumNumberOfSites, 0), pd2.SiteCount)) [SitesRequiredCount]
			FROM
				@ProjectData pd2
			WHERE
				pd2.ProjectGroupId = pd.ProjectGroupID
		) ProjectGroupSitesRequired

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL

				LEFT JOIN Project p WITH (NOLOCK) ON a.ProjectId = p.ProjectID
			WHERE
				p.ProjectGroupID = pd.ProjectGroupID
					AND
				a.DateDeclined IS NULL
		) ProjectGroupSitesCount


	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella BIT)

	INSERT INTO @MainData (ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
	SELECT
		pd.ClientID,
		pd.Client,

		-- Project Data
		pd.ProjectID,
		pd.SubProjectName,
		pd.SiteCount,
		CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pd.SiteCount > 0 AND ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(pd.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pd.SiteCount AS FLOAT)) / CAST(pd.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
		pd.SitesBookedCount,
		pd.SitesCompletedCount,
		CAST((ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) - pd.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) [OutstandingJobsCount],
		CONVERT(VARCHAR, pd.DueDate, 104) [DueDate],

		-- Project Group Data
		pd.ProjectGroupID,
		pd.ProjectGroup,
		ProjectGroupSite.SiteCount [PGSiteCount],
		CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) + ' (' + CASE WHEN ProjectGroupSite.SiteCount > 0 AND ProjectGroupSitesCount.SitesRequiredCount > 0 THEN CAST(LEFT(((CAST(ProjectGroupSitesCount.SitesRequiredCount AS FLOAT) / CAST(ProjectGroupSite.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [PGSitesRequiredCount],
		ProjectGroupSitesCount.SitesBookedCount [PGSitesBookedCount],
		ProjectGroupSitesCount.SitesCompletedCount [PGSitesCompletedCount],
		CAST((ProjectGroupSitesCount.SitesRequiredCount - ProjectGroupSitesCount.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) [PGOutstandingJobsCount],
		AppData.MinStart [Starts],
		AppData.MaxEnd [Ends],
		e.FullName [ProjectManager],
		CASE WHEN AppData.MinStart < GETDATE() AND AppData.MaxEnd > GETDATE() THEN 1 ELSE 0 END [IsActive],
		ISNULL(pd.LegionellaTypeID, 0) [LegionellaTypeID],
		CASE WHEN ISNULL(pd.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
	FROM
		@ProjectData pd
		LEFT JOIN Employee e WITH (NOLOCK) ON pd.GroupEmployeeId = e.EmployeeID
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SiteCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSite
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SitesRequiredCount, pgd.SitesBookedCount, pgd.SitesCompletedCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSitesCount
	
		OUTER APPLY
		(
			SELECT
				MIN(pad.Starts) [MinStart],
				MAX(pad.Ends) [MaxEnd]
			FROM
				@ProjectAppointmentData pad
			WHERE
				pad.ProjectGroupID = pd.ProjectGroupID
		) AppData
	ORDER BY
		ProjectGroup, SubProjectName

	-- Insert the header rows
	INSERT INTO @MainData
	SELECT DISTINCT ClientID, Client, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, NULL, IsLegionella
	FROM @MainData

	-- Main select
	SELECT
		md.ClientID,
		md.Client,
		CASE
			WHEN md.ProjectID IS NULL
			THEN 1
			ELSE 0
		END [IsProjectGroup],
		md.ProjectGroupID [ProjectGroupID],
		ISNULL(md.ProjectID, 0) [ProjectID],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectGroup
			ELSE md.SubProjectName
		END [Name],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSiteCount
			ELSE md.SiteCount
		END [Sites],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesRequiredCount
			ELSE md.SitesRequiredCount
		END [SitesRequired],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesBookedCount
			ELSE md.SitesBookedCount
		END [SitesBooked],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesCompletedCount
			ELSE md.SitesCompletedCount
		END [SitesCompleted],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGOutstandingJobsCount
			ELSE md.OutstandingJobsCount
		END [OutstandingJobs],
		md.DueDate,
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Starts
			ELSE null
		END [Starts],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Ends
			ELSE null
		END [Ends],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectManager
			ELSE null
		END [ProjectManager],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.IsActive
			ELSE null
		END [IsActive],
		CASE
			WHEN md.ProjectID IS NOT NULL
			THEN ISNULL(md.LegionellaTypeID, 0)
			ELSE 0
		END [LegionellaTypeID],
		IsLegionella
	FROM
		@MainData md
	WHERE
		(CASE
			WHEN @HideSubProjects = 1
			THEN
				CASE
					WHEN md.ProjectID IS NULL
					THEN 1
					ELSE 0
				END
			ELSE 1
		END) = 1
	ORDER BY
		md.ProjectGroup,
		md.SubProjectName
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EmployeePreference'))
BEGIN
	CREATE TABLE [dbo].[EmployeePreference](
	[EmployeePreferenceID] [int] IDENTITY(1,1) NOT NULL,
	[EmployeeID] [int] NULL,
	[DarkTheme] [bit] NULL,
	[BackgroundImage] [varchar](max) NULL,
	CONSTRAINT [PK_EmployeePreference] PRIMARY KEY CLUSTERED 
	(
		[EmployeePreferenceID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='LegionellaAssetOutletQuestion') AND name='AssetChartQuestion') < 1
BEGIN
  ALTER TABLE LegionellaAssetOutletQuestion
      ADD AssetChartQuestion BIT NOT NULL DEFAULT(0)
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseExternalSite'))
BEGIN
	CREATE TABLE [dbo].[EnterpriseExternalSite](
	[EnterpriseExternalSiteID] [int] IDENTITY(1,1) NOT NULL,
	[ClientID] [int] NOT NULL,
	[Address] [varchar](200) NOT NULL,
	[Postcode] [varchar](10) NOT NULL,
	[Telephone] [varchar](50) NOT NULL,
	[Contact] [varchar](100) NOT NULL,
	[UPRN] [varchar](50) NULL,
	[TEAMSUPRN] [varchar](max) NULL,
	[OriginalSiteID] [int] NULL,
	[Deleted] [datetime] NULL,
	CONSTRAINT [PK_EnterpriseExternalSite] PRIMARY KEY CLUSTERED 
	(
		[EnterpriseExternalSiteID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'AppointmentsWithCategory')
BEGIN
    EXEC('CREATE VIEW[dbo].[AppointmentsWithCategory] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[AppointmentsWithCategory]
AS
-- Stand alone site appointments.
Select
	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
	Case
		When Cast(a.StartTime as Date) = Cast(a.EndTime as Date) Then
			DateDiff(n, a.StartTime, a.EndTime)
		Else
			DateDiff(n, a.StartTime, DateAdd(d, 1, Cast(Cast(a.StartTime as date) as datetime)))
		End as Duration,
	a.StartTime, 
	a.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	s.Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	a.DateConfirmed,
--	Cast(a.Notes as varchar(max)) as Notes,
	a.CalendarFileID,
	e.EmployeeID, 
	e.FullName AS Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	a.AppointmentGroupId,
	a.ProjectAppointmentId,
	Case
		When a.ManuallyMarkWorkDone = 1 Then 1
		When IsNull(qe.EmployeeId, 0) > 0 And a.AppointmentTypeId = 8 Then 1
		WHEN a.AppointmentTypeId = 9 THEN CAST((Select COUNT(*) FROM Legionella l WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID) as BIT)
		Else
			CAST(jeappt.[jeappt] as BIT)
	End AS MobileDataReturned,
    CASE WHEN (
                SELECT 
                    Count(*) 
                FROM 
                    JobEmployeeAppointment WITH (NOLOCK)
                    left OUTER JOIN [dbo].[JobEmployee] sje WITH (NOLOCK) ON [sje].[JobEmployeeID] = [JobEmployeeAppointment].[JobEmployeeID] 
                WHERE 
                    [sje].[JobID] = [j].[JobID]
               )>0 THEN
         1
    ELSE
        0
    END MobileDataReturnedOutsideOfScope,
    Case
		When a.ManuallyMarkWorkDone = 1 Then
			1
	ELSE
		CASE a.AppointmentTypeID
			WHEN 1 THEN regcount.regcount
			WHEN 3 THEN aircount.aircount
			WHEN 9 THEN (Select COUNT(*) FROM Legionella l WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		END
    END MobileData,
	Cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID And Cast(Created as date) = Cast(a.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID) as bit) AS noAccessOutsideOfScope,
	DateDeclined,
	COALESCE(pt.AppointmentColour, st.AppointmentColour, airColour.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = a.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Quote q WITH (NOLOCK) On q.QuoteID = a.QuoteID
	Left Outer JOin QuoteEmployee qe WITH (NOLOCK) On qe.QuoteId = q.QuoteId
	Left Outer Join Job j WITH (NOLOCK) On j.JobID = q.JobID
	Left Outer Join AppointmentEmployee ae WITH (NOLOCK) On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e WITH (NOLOCK) On ae.EmployeeID = e.EmployeeID
	OUTER APPLY
	(
		Select COUNT(*) [regcount] FROM Register r WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID
	) regcount
	OUTER APPLY
	(
		Select COUNT(*) [aircount] FROM AirTest at WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID
	) aircount
	OUTER APPLY
	(
		Select Count(*) [jeappt] From JobEmployeeAppointment WITH (NOLOCK) Where AppointmentID = a.AppointmentID
	) jeappt
	OUTER APPLY
	(	
		SELECT
			CASE
				WHEN att.AirTestTypeID = 2 THEN att.AppointmentColour
				WHEN sub.MaxAirTestTypeCounter = 1 THEN att.AppointmentColour
			ELSE
				NULL
			END [AppointmentColour]
		FROM
			(
				SELECT
					main.AirTestTypeID,
					MAX(main.AirTestTypeCounter) MaxAirTestTypeCounter
				FROM
					(
						SELECT
							att.AirTestTypeID,
							ROW_NUMBER() OVER (PARTITION BY aamt.AirTestTypeID ORDER BY aamt.AirTestTypeID) [AirTestTypeCounter]
						FROM
							AppointmentAirMonitoring aam WITH (NOLOCK)
							INNER JOIN AppointmentAirMonitoringType aamt WITH (NOLOCK) ON aam.AppointmentAirMonitoringID = aamt.AppointmentAirMonitoringID
							INNER JOIN AirTestType att WITH (NOLOCK) ON aamt.AirTestTypeID = att.AirTestTypeID
						WHERE
							aam.AppointmentID = a.AppointmentID
					) main
				GROUP BY
					main.AirTestTypeID
			) sub
			INNER JOIN AirTestType att ON sub.AirTestTypeID = att.AirTestTypeID
		WHERE
			sub.AirTestTypeID = 2
				OR
			sub.MaxAirTestTypeCounter = 1
	) airColour
Where
	ProjectAppointmentId Is Null

Union

-- Project site appointments.
Select
	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime) as OffsetStart, 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime) as OffsetEnd,
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)) as Duration,
	a.StartTime, 
	a.EndTime,
	(Select Min(AppointmentID) From Appointment WITH (NOLOCK)  Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentID,
	--a.AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Cast(Count(*) as varchar(10)) + ' Sites in total' as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	Null as JobId,
	Null as JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,	
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null))) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- ignore for project appointments, instead rely on returned jobs below.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	0 AS NoAccess,-- ignore for project appointments, instead rely on returned jobs below.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Outer Apply
	(
		Select Top 1 SiteId From Appointment WITH (NOLOCK) Where ProjectAppointmentId = a.ProjectAppointmentId And ((Cast(a.DateDeclined as Date) Is Null And DateDeclined Is Null) Or (Not Cast(a.DateDeclined as Date) Is Null And Not DateDeclined Is Null)) Order By DateCreated
	) as ProjectAppointmentSite
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = ProjectAppointmentSite.SiteId
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join AppointmentEmployee ae WITH (NOLOCK) On ae.AppointmentID = a.AppointmentID
	Left Outer Join Employee e WITH (NOLOCK) On ae.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
Group By
 	DateDiff(n, Cast(Cast(a.StartTime as date) as datetime), a.StartTime), 
	DateDiff(d, Cast(a.StartTime as date), Cast(a.EndTime as date)), 
	DateDiff(n, Cast(Cast(a.EndTime as date) AS datetime), a.EndTime),
	DateDiff(n, Cast(a.StartTime as Time), Cast(a.EndTime as Time)),
	a.StartTime, 
	a.EndTime,
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	ISNULL(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.Postcode,
	s.UPRN,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	pt.AppointmentColour,
	st.AppointmentColour

Union

-- Completed Project Site Jobs
Select
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime) as OffsetStart, 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)) as Days, 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime) as OffsetEnd,
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)) as Duration,
	jea.StartTime, 
	jea.EndTime,
--	(Select Min(AppointmentID) From Appointment Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	a.AppointmentId,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	1 AS MobileDataReturned,-- Always true for returned jobs.
    0 AS MobileDataReturnedOutsideOfScope,
    CASE a.AppointmentTypeID
		WHEN 1 THEN (Select COUNT(*) FROM Register r WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		WHEN 3 THEN (Select COUNT(*) FROM AirTest at WITH (NOLOCK) INNER JOIN JobEmployee je WITH (NOLOCK) ON at.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
		--WHEN 9 THEN (Select COUNT(*) FROM Legionella l INNER JOIN JobEmployee je ON l.JobEmployeeID=je.JobEmployeeID Where je.JobID=j.JobID)
    END MobileData,
	Cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID And Cast(Created as date) = Cast(jea.StartTime as date)) as bit) AS NoAccess,
    cast((Select Count(*) From NoAccess WITH (NOLOCK) Where JobID = j.JobID) as bit) AS noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	Inner Join JobEmployeeAppointment jea WITH (NOLOCK) On a.AppointmentID = jea.AppointmentID
	Inner Join JobEmployee je WITH (NOLOCK) On jea.JobEmployeeID = je.JobEmployeeID
	Inner Join Job j WITH (NOLOCK) On je.JobID = j.JobId
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = j.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Employee e WITH (NOLOCK) On je.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
Group By
	DateDiff(n, Cast(Cast(jea.StartTime as date) as datetime), jea.StartTime), 
	DateDiff(d, Cast(jea.StartTime as date), Cast(jea.EndTime as date)), 
	DateDiff(n, Cast(Cast(jea.EndTime as date) AS datetime), jea.EndTime),
	DateDiff(n, Cast(jea.StartTime as Time), Cast(jea.EndTime as Time)),
	jea.StartTime, 
	jea.EndTime,
	a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	a.AppointmentTypeID,
	pt.AppointmentColour,
	st.AppointmentColour

Union

-- No Access Project Site Jobs
Select
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created) as OffsetStart, 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)) as Days, 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created) as OffsetEnd,
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)) as Duration,
	na.Created as StartTime, 
	na.Created as EndTime,
	(Select Min(AppointmentID) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentID,
	IsNull(at.AppointmentType, '') As AppointmentType,
	c.ClientID,
	IsNull(c.Client, '') as Client,
	p.ProjectID,
	IsNull(p.Project, '') + ' / ' + p.GroupName as Project,
	s.SiteID,
	Case When Not s.Address Is Null Then s.Address + ', ' + s.Postcode Else '' End as Site,
	Project as Address,
	s.Postcode,
	s.UPRN,
	j.JobId,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
	(Select Min(DateConfirmed) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as DateConfirmed,
--	cast(a.Notes as varchar(max)) Notes,
	0 as CalendarFileID,
	e.EmployeeID, 
	e.FullName as Employee,
	a.BranchOfficeId,
	COALESCE([a].[DiaryLabel], ac.Description) as appCategoryDescription,
	ac.HTML_Colour,
	(Select Min(AppointmentGroupId) From Appointment WITH (NOLOCK) Where DateDeclined Is Null And ProjectAppointmentId = a.ProjectAppointmentId) as AppointmentGroupId,
	a.ProjectAppointmentId,
	0 AS MobileDataReturned,-- Never true since this section is only for things that have no JEA record!.
    0 as MobileDataReturnedOutsideOfScope,
    0 as MobileData,
	1 AS NoAccess,-- Always true, this is no access query.
    0 noAccessOutsideOfScope,
	Cast(DateDeclined as Date) as DateDeclined,
	ISNULL(pt.AppointmentColour, st.AppointmentColour) [SurveyAppointmentColour]
From
	Appointment a WITH (NOLOCK)
	Inner Join Quote q WITH (NOLOCK) On a.QuoteID = q.QuoteID
	Inner Join Job j WITH (NOLOCK) On q.JobID = j.JobID
	Inner Join NoAccess na WITH (NOLOCK) On q.JobID = na.JobID
	LEFT OUTER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentID=aSurv.AppointmentID
	LEFT OUTER JOIN SurveyType st WITH (NOLOCK) ON aSurv.SurveyTypeID=st.SurveyTypeID
	LEFT JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
	Left Outer Join AppointmentCategory ac WITH (NOLOCK) On a.AppointmentCategoryID = ac.AppointmentCategoryID 
	Left Outer Join AppointmentType at WITH (NOLOCK) On at.AppointmentTypeId = a.AppointmentTypeID
	Left Outer Join Client c WITH (NOLOCK) On a.ClientID = c.ClientID
	Left Outer Join Site s WITH (NOLOCK) On s.SiteID = j.SiteID
	Left Outer Join Project p WITH (NOLOCK) On p.ProjectID = a.ProjectID
	Left Outer Join Employee e WITH (NOLOCK) On na.EmployeeID = e.EmployeeID
Where
	Not ProjectAppointmentId Is Null
		AND
	(Select COUNT(*) FROM Appointment WITH (NOLOCK) Inner Join JobEmployeeAppointment jea WITH (NOLOCK) On Appointment.AppointmentID = jea.AppointmentID Where Appointment.AppointmentID=a.AppointmentID)=0
Group By
	DateDiff(n, Cast(Cast(na.Created as date) as datetime), na.Created), 
	DateDiff(d, Cast(na.Created as date), Cast(na.Created as date)), 
	DateDiff(n, Cast(Cast(na.Created as date) AS datetime), na.Created),
	DateDiff(n, Cast(na.Created as Time), Cast(na.Created as Time)),
	na.Created, 
	--a.AppointmentID,
	IsNull(at.AppointmentType, ''),
	c.ClientID,
	IsNull(c.Client, ''),
	p.ProjectID,
	IsNull(p.Project, ''),
	s.SiteID,
	p.Project,
	p.GroupName,
	s.ADDRESS,
	s.Postcode,
	s.UPRN,
	j.JobID,
	j.JobNo,
--	a.ClientOrderNo,
	a.Cost,
--	cast(a.Notes as varchar(max)),
	e.EmployeeID, 
	e.FullName,
	a.BranchOfficeId,
	ac.Description,
    [a].[DiaryLabel],
	ac.HTML_Colour,
	ProjectAppointmentId,
	Cast(DateDeclined as Date),
	pt.AppointmentColour,
	st.AppointmentColour
GO


ALTER PROCEDURE [dbo].[outstandingSampleReportCounts]
    @labid int=null
AS
BEGIN
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
    SET NOCOUNT ON 
    DECLARE 
        @dontuseLabs bit,
        @internal_labid int

    SET @dontuseLabs =0
    IF EXISTS(SELECT 'x' FROM Config WHERE b__UseSampleCheckIn = 0)
    BEGIN 
        SET @dontuseLabs = 1
    END 
    
    IF @labid=0 --0 = all labs
    BEGIN
        set @labid=null
    END 
     
    SET @internal_labid = @labid 
    
   
    
    --debug
    
        --set @internal_labid =null
    
    --end debug
    
    
    --the counts in outstandingsamplereports seem to be wrong because of labs and appointments.
    --stripped to bare bones, jobs(which have valid appointments) and proper samples
    SELECT
        COUNT(sam.sampleid) [Total],
        isnull(SUM(CASE WHEN sam.[DateAnalysed] IS not NULL THEN 1 ELSE 0 END),0) [Analysed],
        COUNT(sam.sampleid) - isnull(SUM(CASE WHEN sam.[DateAnalysed] IS not NULL THEN 1 ELSE 0 END),0) [AwaitingAnalysis]
    FROM
        [dbo].[Job] j
        INNER JOIN [dbo].[Client] cl ON [j].[ClientID] = [cl].[ClientID]
        INNER JOIN [dbo].[Site] si ON [j].[SiteID] = si.[SiteID]
        INNER JOIN [dbo].[JobEmployee] jobemployee ON [j].[JobID] = [jobemployee].[JobID]
        INNER JOIN [dbo].[Register] reg ON [jobemployee].[JobEmployeeID] = [reg].[JobEmployeeID]  
        INNER JOIN [dbo].[Room] rm ON reg.[RegisterID] = [rm].[RegisterID]
        inner JOIN [dbo].[Sample] sam ON rm.[RoomID] = [sam].[RoomID]
        LEFT OUTER JOIN [dbo].[SampleTurnaround] sta ON [sam].[SampleTurnaroundID] = [sta].[SampleTurnaroundID]
        outer APPLY
        (
            /*make sure the appointment has not been declined*/
            SELECT 
                SUM(CASE WHEN app.[DateDeclined] IS NOT NULL THEN 
                        1
                    ELSE
                        0
                    END),
                SUM(CASE WHEN app.[DateDeclined] IS NULL THEN 
                        1
                    ELSE
                        0
                    END),
                MIN(DueDate)
                    
                    
            FROM 
                quote q 
                INNER JOIN [dbo].[Appointment] app ON [app].[QuoteID] = [q].[QuoteID]
                inner JOIN [dbo].[AppointmentSurvey] apps ON [apps].[AppointmentID] = [app].[AppointmentID]
            WHERE
                --[app].[DateDeclined] IS NULL
                --AND 
                [q].[JobID] = [j].[JobID]                
            GROUP BY 
                [q].[JobID]
        )validApp(declinedCount,openCount,duedate)
        outer APPLY(
            SELECT
                MAX(subreg.[RegisterFinish]),
                SUM(
                    CASE WHEN subreg.[RegisterFinish] IS NULL THEN 
                        1   
                    ELSE
                        0
                    END 
                ) registersNotFinished
            FROM 
                [dbo].[Job] subj
                INNER JOIN [dbo].[JobEmployee] subje ON subj.[JobID] = [subje].[JobID]           --included to make sure reg exists by inner join 
                INNER JOIN register subreg ON subje.[JobEmployeeID]  = subreg.[JobEmployeeID]    --this also makes sure that it is a survey
            WHERE 
                [subj].[JobID] = [j].[JobID]
            GROUP BY
                subj.[JobID]
        )overAllRegDetails(finishDate,uncompletedCount)
        
    WHERE
        [j].[Approved] IS NULL AND 
        (([sam].[DateCheckedIn] IS NOT NULL) OR (@dontuseLabs = 1))
        AND 
    	JobEmployee.MainEmployee = 1 
    		AND
    	Not IsNull(SampleRef,'') = ''
    		AND
    	AsSample = 0 
    		And
    	-- Added Stephen 7/3/11 - ignores reinspections samples
    	RIGHT(SampleRef,1) <> '*'
    		AND
    	-- Added Stephen 12/6/12 - Ignore Samples that were surveyed prior to TEAMS
    	Not SampleRef Like '%{%'
    		And
    	(
    		SampleResultEmployeeID IS NULL 
    			OR
    		SampleContentEmployeeID IS NULL
    	) 
        AND 
        (
            --appointment open
            (ISNULL(validApp.[openCount],0)>0) OR
            --no open appointments and no closed appointments
            (ISNULL([validApp].[declinedCount],0)=0 AND ISNULL([validApp].[openCount],0) = 0)
            --hides any which have been cancelled and have no open
        )
        AND 
        (
            (@dontuseLabs =1)
            OR
            (
                @dontuseLabs =0
                AND
                (
                    (
                        (
                            (@internal_labid IS NOT NULL) 
                            AND 
                            LaboratoryId = @internal_labid 
                        )
                        
                    )
                    OR 
                    (@internal_labid IS NULL)
                )
            )
        )
        
    SET NOCOUNT off        
END 

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_LegionellaProjectMonitoring') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_LegionellaProjectMonitoring] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_LegionellaProjectMonitoring]    Script Date: 30/08/2018 15:17:07 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[TEAMS_LegionellaProjectMonitoring]
	@ProjectGroupID INT = 0,
	@Year DATETIME = NULL
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;

SELECT
	@Year = DATEPART(YEAR, ISNULL(@Year, GETDATE()))

-- Get a list of jobs upfront
DECLARE @JobList TABLE (JobID INT, ProjectID INT, SiteID INT, LegionellaTypeID INT, Created DATETIME, Approved DATETIME)
INSERT INTO @JobList
SELECT
	j.JobID,
	j.ProjectID,
	j.SiteID,
	al.LegionellaTypeID,
	j.Created,
	j.Approved
FROM
	Job	j
	INNER JOIN Project p ON j.ProjectID = p.ProjectID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN Appointment a ON q.QuoteId = a.QuoteID AND AppointmentTypeID = 9
	INNER JOIN AppointmentLegionella al ON a.AppointmentID = al.AppointmentID
WHERE
	(p.ProjectGroupId = @ProjectGroupID OR @ProjectGroupID = 0)
		AND
	DATEPART(YEAR, j.Created) = @Year

-- Start the main select
SELECT 
	p.ProjectID,
	p.GroupName,
	janApproved.[Count] + '/' + janCount.[Count] [Jan],
	febApproved.[Count] + '/' + febCount.[Count] [Feb],
	marApproved.[Count] + '/' + marCount.[Count] [Mar],
	aprApproved.[Count] + '/' + aprCount.[Count] [Apr],	
	mayApproved.[Count] + '/' + mayCount.[Count] [May],
	junApproved.[Count] + '/' + junCount.[Count] [Jun],
	julApproved.[Count] + '/' + julCount.[Count] [Jul],
	augApproved.[Count] + '/' + augCount.[Count] [Aug],
	sepApproved.[Count] + '/' + sepCount.[Count] [Sep],
	octApproved.[Count] + '/' + octCount.[Count] [Oct],
	novApproved.[Count] + '/' + novCount.[Count] [Nov],
	decApproved.[Count] + '/' + decCount.[Count] [Dec]
FROM 
	@JobList j
	INNER JOIN Project p ON j.ProjectID = p.ProjectID
	--INNER JOIN LegionellaType lt ON j.LegionellaTypeID = lt.LegionellaTypeID

	-- Dont look at this, something written quickly just get something working, if slow please feel free to re-write
	-- January
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 1 AND _j.Approved IS NOT NULL
	) janApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 1
	) janCount

	-- February
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 2 AND _j.Approved IS NOT NULL
	) febApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 2
	) febCount

	-- March
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 3 AND _j.Approved IS NOT NULL
	) marApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 3
	) marCount

	-- April
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 4 AND _j.Approved IS NOT NULL
	) aprApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 4
	) aprCount
	
	-- May
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 5 AND _j.Approved IS NOT NULL
	) mayApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 5
	) mayCount

	-- June
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 6 AND _j.Approved IS NOT NULL
	) junApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 6
	) junCount

	-- July
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 7 AND _j.Approved IS NOT NULL
	) julApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 7
	) julCount

	-- August
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 8 AND _j.Approved IS NOT NULL
	) augApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 8
	) augCount

	-- September
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 9 AND _j.Approved IS NOT NULL
	) sepApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 9
	) sepCount

	-- October
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 10 AND _j.Approved IS NOT NULL
	) octApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 10
	) octCount

	-- November
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 11 AND _j.Approved IS NOT NULL
	) novApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 11
	) novCount

	-- December
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 12 AND _j.Approved IS NOT NULL
	) decApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.Created) = 12
	) decCount
GROUP BY
	p.ProjectID,
	p.GroupName,
	janApproved.[Count],
	janCount.[Count],
	febApproved.[Count],
	febCount.[Count],
	marApproved.[Count],
	marCount.[Count],
	aprApproved.[Count],
	aprCount.[Count],
	mayApproved.[Count],
	mayCount.[Count],
	junApproved.[Count],
	junCount.[Count],
	julApproved.[Count],
	julCount.[Count],
	augApproved.[Count],
	augCount.[Count],
	sepApproved.[Count],
	sepCount.[Count],
	octApproved.[Count],
	octCount.[Count],
	novApproved.[Count],
	novCount.[Count],
	decApproved.[Count],
	decCount.[Count]

	SET NOCOUNT OFF;
END
GO

UPDATE TeamsV2Tab SET EnableMvcGrid = 1 WHERE TabText = 'projects'

USE [TEAMS]
GO

/****** Object:  View [dbo].[MobileUnitSummary]    Script Date: 31/08/2018 11:21:15 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[MobileUnitSummary]
As

SELECT
	[SystemName] =			SystemName, 
	[LastUsed] =			m1.DateCreated, 
	[SoftwareVersion] =		DataQueryString, 
	[SerialNumber] =		eq.SerialNumber,
	[Employee] =			ISNULL(e.FullName,'Unknown') ,
	[UserBranch] =			b.BranchOffice,
	[LicenceKey] =			mlk.LicenceKey,
	[EquipmentID] =			eq.EquipmentID,
	[LastUpdate] =			lastUpd.DateCreated,
	[DataScript] =			recentScript.DataScript
From
	MobileAuditTrail m1 WITH (NOLOCK)
	INNER JOIN Equipment eq WITH (NOLOCK) ON eq.RefNo = m1.SystemName And eq.EquipmentCategoryID = 19
	LEFT JOIN Employee e WITH (NOLOCK) ON m1.EmployeeID = e.EmployeeID
	LEFT JOIN BranchOffice b WITH (NOLOCK) ON e.BranchOfficeID = b.BranchOfficeID
	LEFT JOIN MobileUnitLicenceKey mlk WITH (NOLOCK) ON eq.[MobileUnitLicenceKeyID] = [mlk].[MobileUnitLicenceKeyID]
	--Last time an update was done
	OUTER APPLY
	(
		SELECT TOP 1
			DateCreated
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
				AND
			_mat.DataQueryString != m1.DataQueryString
		ORDER BY
			DateCreated DESC
	) lastUpd
	OUTER APPLY
	(
		SELECT TOP 1
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
		ORDER BY
			DateCreated DESC
	) recentScript
Where
	MobileAuditTrailID = (Select Top 1 MobileAuditTrailID from MobileAuditTrail m2 WITH (NOLOCK) Where m1.SystemName = m2.SystemName Order By MobileAuditTrailID DESC)
		AND
	m1.[DateCreated] BETWEEN CONVERT(varchar(20),DATEADD(day,-30,GETDATE()),106) AND CONVERT(VARCHAR(20),DATEADD(day,1,GETDATE()),106)

UNION

SELECT
	[SystemName] =			SystemName, 
	[LastUsed] =			m1.DateCreated, 
	[SoftwareVersion] =		DataQueryString, 
	[SerialNumber] =		eq.SerialNumber,
	[Employee] =			ISNULL(e.FullName,'Unknown') ,
	[UserBranch] =			b.BranchOffice,
	[LicenceKey] =			mlk.LicenceKey,
	[EquipmentID] =			eq.EquipmentID,
	[LastUpdate] =			lastUpd.DateCreated,
	[DataScript] =			recentScript.DataScript
From
	MobileAuditTrail m1 WITH (NOLOCK)
	LEFT JOIN Equipment eq WITH (NOLOCK) ON eq.RefNo = m1.SystemName And eq.EquipmentCategoryID = 19
	LEFT JOIN Employee e WITH (NOLOCK) ON m1.EmployeeID = e.EmployeeID
	LEFT JOIN BranchOffice b WITH (NOLOCK) ON e.BranchOfficeID = b.BranchOfficeID
	LEFT JOIN MobileUnitLicenceKey mlk WITH (NOLOCK) ON eq.[MobileUnitLicenceKeyID] = [mlk].[MobileUnitLicenceKeyID]
	--Last time an update was done
	OUTER APPLY
	(
		SELECT TOP 1
			DateCreated,
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
				AND
			_mat.DataQueryString != m1.DataQueryString
		ORDER BY
			DateCreated DESC
	) lastUpd
    OUTER APPLY
	(
		SELECT TOP 1
			_mat.DataScript
		FROM
			MobileAuditTrail _mat WITH (NOLOCK)
		WHERE
			_mat.SystemName = m1.SystemName
		ORDER BY
			DateCreated DESC
	) recentScript
Where
	MobileAuditTrailID = (Select Top 1 MobileAuditTrailID from MobileAuditTrail m2 WITH (NOLOCK) Where m1.SystemName = m2.SystemName Order By MobileAuditTrailID DESC)
		AND
	m1.[DateCreated] BETWEEN CONVERT(varchar(20),DATEADD(day,-30,GETDATE()),106) AND CONVERT(VARCHAR(20),DATEADD(day,1,GETDATE()),106)
		AND
	eq.EquipmentID IS NULL


GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[TEAMS_Management_GetProjects]    Script Date: 03/09/2018 12:01:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Daniel Wilton
-- Create date: 12/07/2018
-- Description:	Stored procedure for the new V2 Management - Projects grid
-- =============================================
ALTER PROCEDURE [dbo].[TEAMS_Management_GetProjects]
	-- Add the parameters for the stored procedure here
	@Client int = 0,
	@project int = 0,
	@HideCompleted bit = 1,
	@HideSubProjects bit = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	-- Project Data
	DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), SiteCount INT, PrjGrpMaximumNumberOfSites INT, SitesBookedCount INT, SitesCompletedCount INT, DueDate DATETIME, GroupEmployeeID INT, LegionellaTypeID INT)

	INSERT INTO @ProjectData (ClientID, Client, ProjectID, SubProjectName, ProjectGroupID, ProjectGroup, SiteCount, PrjGrpMaximumNumberOfSites, SitesBookedCount, SitesCompletedCount, DueDate, GroupEmployeeID, LegionellaTypeID)
	SELECT
		c.ClientID,
		c.Client,
		p.ProjectID,
		p.GroupName,
		pg.ProjectGroupID,
		pg.ProjectGroup,
		SiteCount.SiteCount,
		p.PrjGrpMaximumNumberOfSites,
		SitesCount.SitesBookedCount,
		SitesCount.SitesCompletedCount,
		p.DueDate,
		pg.EmployeeId,
		ISNULL(p.LegionellaTypeID, 0)
	FROM
		Project p
		INNER JOIN ProjectGroup pg WITH (NOLOCK) ON p.ProjectGroupId = pg.ProjectGroupId
		INNER JOIN Client c WITH (NOLOCK) ON p.ClientID = c.ClientID

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
				ProjectSite ps
			WHERE
				ps.ProjectID = p.ProjectID
		) SiteCount

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT a.SiteID) [SitesBookedCount],
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
			WHERE
				a.ProjectID = p.ProjectID
					AND
				a.DateDeclined IS NULL
		) SitesCount

	WHERE
		(
			CASE
				WHEN @Client > 0
				THEN
					CASE
						WHEN @Client = c.ClientID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @Project > 0
				THEN
					CASE
						WHEN @Project = p.ProjectID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @HideCompleted = 1
				THEN
					CASE
						WHEN pg.DateCompleted IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		pg.DateDeleted IS NULL
			AND
		p.Deleted IS NULL

	-- Data for all appointments for projects gotten above
	DECLARE @ProjectAppointmentData TABLE (IndexID INT IDENTITY(1,1), SiteID INT, Starts DATETIME, Ends DATETIME, ProjectID INT, ProjectGroupID INT, AppointmentProjectID INT)

	INSERT INTO @ProjectAppointmentData (SiteID, Starts, Ends, ProjectID, ProjectGroupID, AppointmentProjectID)

	SELECT
		a.SiteID,
		a.StartTime,
		a.EndTime,
		pd.ProjectID,
		pd.ProjectGroupID,
		a.ProjectID
	FROM
		Appointment a
		INNER JOIN @ProjectData pd ON a.ProjectID = pd.ProjectID
	WHERE
		a.DateDeclined IS NULL
			AND
		a.AppointmentTypeID IN (1,3)

	-- Data for all project group for projects gotten above
	DECLARE @ProjectGroupData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupID INT, SiteCount INT, SitesRequiredCount INT, SitesBookedCount INT, SitesCompletedCount INT)

	INSERT INTO @ProjectGroupData (ProjectGroupID, SiteCount, SitesRequiredCount, SitesBookedCount, SitesCompletedCount)
	SELECT
		pd.ProjectGroupID,
		ProjectGroupSite.SiteCount,
		ISNULL(NULLIF(ProjectGroupSitesRequired.SitesRequiredCount, 0), ProjectGroupSite.SiteCount),
		(SELECT SUM(pd2.SitesBookedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID),
		(SELECT SUM(pd2.SitesCompletedCount) FROM @ProjectData pd2 WHERE pd.ProjectGroupID = pd2.ProjectGroupID)
	FROM
		@ProjectData pd

		OUTER APPLY
		(
			SELECT
				COUNT(*) [SiteCount]
			FROM
			(
				SELECT
					ps.SiteID
				FROM
					ProjectSite ps
					INNER JOIN Project p WITH (NOLOCK) ON p.ProjectID = ps.ProjectID
				WHERE
					p.ProjectGroupId = pd.ProjectGroupID
				
			) a
		) ProjectGroupSite

		OUTER APPLY
		(
			SELECT
				SUM(ISNULL(NULLIF(pd2.PrjGrpMaximumNumberOfSites, 0), pd2.SiteCount)) [SitesRequiredCount]
			FROM
				@ProjectData pd2
			WHERE
				pd2.ProjectGroupId = pd.ProjectGroupID
		) ProjectGroupSitesRequired

		OUTER APPLY
		(
			SELECT
				COUNT(DISTINCT j.JobID) [SitesCompletedCount]
			FROM
				Appointment a
				LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
				LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL

				LEFT JOIN Project p WITH (NOLOCK) ON a.ProjectId = p.ProjectID
			WHERE
				p.ProjectGroupID = pd.ProjectGroupID
					AND
				a.DateDeclined IS NULL
		) ProjectGroupSitesCount


	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella BIT)

	INSERT INTO @MainData (ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
	SELECT
		pd.ClientID,
		pd.Client,

		-- Project Data
		pd.ProjectID,
		pd.SubProjectName,
		pd.SiteCount,
		CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pd.SiteCount > 0 AND ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(pd.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pd.SiteCount AS FLOAT)) / CAST(pd.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
		pd.SitesBookedCount,
		pd.SitesCompletedCount,
		CAST((ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) - pd.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ISNULL(pd.PrjGrpMaximumNumberOfSites, pd.SiteCount) AS VARCHAR(MAX)) [OutstandingJobsCount],
		CONVERT(VARCHAR, pd.DueDate, 104) [DueDate],

		-- Project Group Data
		pd.ProjectGroupID,
		pd.ProjectGroup,
		ProjectGroupSite.SiteCount [PGSiteCount],
		CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) + ' (' + CASE WHEN ProjectGroupSite.SiteCount > 0 AND ProjectGroupSitesCount.SitesRequiredCount > 0 THEN CAST(LEFT(((CAST(ProjectGroupSitesCount.SitesRequiredCount AS FLOAT) / CAST(ProjectGroupSite.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [PGSitesRequiredCount],
		ProjectGroupSitesCount.SitesBookedCount [PGSitesBookedCount],
		ProjectGroupSitesCount.SitesCompletedCount [PGSitesCompletedCount],
		CAST((ProjectGroupSitesCount.SitesRequiredCount - ProjectGroupSitesCount.SitesCompletedCount) AS VARCHAR(MAX)) + ' of ' + CAST(ProjectGroupSitesCount.SitesRequiredCount AS VARCHAR(MAX)) [PGOutstandingJobsCount],
		AppData.MinStart [Starts],
		AppData.MaxEnd [Ends],
		e.FullName [ProjectManager],
		CASE WHEN AppData.MinStart < GETDATE() AND AppData.MaxEnd > GETDATE() THEN 1 ELSE 0 END [IsActive],
		ISNULL(pd.LegionellaTypeID, 0) [LegionellaTypeID],
		CASE WHEN ISNULL(pd.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
	FROM
		@ProjectData pd
		LEFT JOIN Employee e WITH (NOLOCK) ON pd.GroupEmployeeId = e.EmployeeID
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SiteCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSite
	
		OUTER APPLY
		(
			SELECT
				TOP 1 pgd.SitesRequiredCount, pgd.SitesBookedCount, pgd.SitesCompletedCount
			FROM
				@ProjectGroupData pgd
			WHERE
				pgd.ProjectGroupID = pd.ProjectGroupID
		) ProjectGroupSitesCount
	
		OUTER APPLY
		(
			SELECT
				MIN(pad.Starts) [MinStart],
				MAX(pad.Ends) [MaxEnd]
			FROM
				@ProjectAppointmentData pad
			WHERE
				pad.ProjectGroupID = pd.ProjectGroupID
		) AppData
	ORDER BY
		ProjectGroup, SubProjectName

	-- Insert the header rows
	INSERT INTO @MainData
	SELECT DISTINCT ClientID, Client, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, NULL, IsLegionella
	FROM @MainData

	-- Main select
	SELECT
		md.ClientID,
		md.Client,
		CASE
			WHEN md.ProjectID IS NULL
			THEN 1
			ELSE 0
		END [IsProjectGroup],
		md.ProjectGroupID [ProjectGroupID],
		ISNULL(md.ProjectID, 0) [ProjectID],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectGroup
			ELSE md.SubProjectName
		END [Name],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSiteCount
			ELSE md.SiteCount
		END [Sites],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesRequiredCount
			ELSE md.SitesRequiredCount
		END [SitesRequired],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesBookedCount
			ELSE md.SitesBookedCount
		END [SitesBooked],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGSitesCompletedCount
			ELSE md.SitesCompletedCount
		END [SitesCompleted],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.PGOutstandingJobsCount
			ELSE md.OutstandingJobsCount
		END [OutstandingJobs],
		md.DueDate,
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Starts
			ELSE null
		END [Starts],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.Ends
			ELSE null
		END [Ends],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.ProjectManager
			ELSE null
		END [ProjectManager],
		CASE
			WHEN md.ProjectID IS NULL
			THEN md.IsActive
			ELSE null
		END [IsActive],
		CASE
			WHEN md.ProjectID IS NOT NULL
			THEN ISNULL(md.LegionellaTypeID, 0)
			ELSE 0
		END [LegionellaTypeID],
		IsLegionella
	FROM
		@MainData md
	WHERE
		(CASE
			WHEN @HideSubProjects = 1
			THEN
				CASE
					WHEN md.ProjectID IS NULL
					THEN 1
					ELSE 0
				END
			ELSE 1
		END) = 1
	ORDER BY
		md.ProjectGroup,
		md.SubProjectName
END

GO



ALTER PROCEDURE [dbo].[TEAMS_SiteMerge](@KeepSiteID int,@RemoveSiteID int, @rez bit OUTPUT, @rezMessage varchar(MAX) output)
AS
BEGIN 
    SET NOCOUNT on

    DECLARE @internalKeepSiteID [int]
    DECLARE @internalRemoveSiteId [int] 
    
    SET @internalKeepSiteID = @keepSiteID
    SET @internalRemoveSiteId = @removeSiteID
    
    SET @rez = 1 
    SET @rezMessage = ''
    --debug
        --set @internalKeepSiteID  = 5455
        --set @internalRemoveSiteID  = 5456
    --end debug

    BEGIN TRAN
    
    BEGIN TRY
        --tables that contain a siteid column
        --store these in a temp table for use in the final stage
       
        
        DECLARE @tableNames AS table(TABLENAME VARCHAR(255) NULL)
        
        --INSERT INTO @tableNames ([TABLENAME])VALUES('Site')   --this is the root table leave out
        --INSERT INTO @tableNames ([TABLENAME])VALUES('ImportData')   --ignore this as it is used by imports only
        
        
        INSERT INTO @tableNames ([TABLENAME])VALUES('Appointment')   
        
        INSERT INTO @tableNames ([TABLENAME])VALUES('CreditItem')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('Enquiry')   
        
        INSERT INTO @tableNames ([TABLENAME])VALUES('InvoiceItem')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('Job')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('NoAccess')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('PortalUser')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('ProFormaItem')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('ProjectSite')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('Quote')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('SampleComputedData')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('SiteDocument')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('SiteSampleResultsOverviewSorting')   
        INSERT INTO @tableNames ([TABLENAME])VALUES('GuidSamples')   
        
        
        --SELECT 'Keep' [Action],si.[SiteID],[si].[Address],[Deleted] FROM [dbo].[Site] si WHERE [SiteID] = @internalKeepSiteID
        --UNION ALL
        --SELECT 'Remove' [Action],si.[SiteID],[si].[Address],[Deleted] FROM [dbo].[Site] si WHERE [SiteID] = @internalRemoveSiteID
        
        DECLARE @tbname varchar(255)
        DECLARE @sql [varchar](MAX)
        DECLARE db_cursor CURSOR FOR 
        SELECT tablename FROM @tableNames
    
        
        OPEN db_cursor
        FETCH NEXT FROM db_cursor INTO @tbname
        
        WHILE @@FETCH_STATUS = 0
        BEGIN
            --SET @sql = 'SELECT * FROM ' + @tbname + ' where siteid = ' + CAST(@internalRemoveSiteID AS varchar)
            --PRINT 'o/put'
            --EXECUTE(@sql)
            SET @sql = 'update ' + @tbname + ' set siteid = ' + CAST(@internalKeepSiteID AS varchar) + ' where siteid = ' + CAST(@internalRemoveSiteID AS varchar)
            --PRINT 'update'
            EXECUTE(@sql)
            
            FETCH NEXT FROM db_cursor INTO @tbname  
            
            
        END 
        --UPDATE [dbo].[Site] SET [Deleted]=GETDATE() WHERE [SiteID] = @internalRemoveSiteID --site merged should be kept
        UPDATE [dbo].[Site] SET [ImportID]=null WHERE [SiteID] = @internalKeepSiteID
        DELETE FROM [dbo].[ClientSite] WHERE [SiteID] = @internalRemoveSiteID
        --PRINT 'remove old'
        
        CLOSE db_cursor   
        DEALLOCATE db_cursor 
    END TRY
    BEGIN CATCH
        SET @rez = 0
        SET @rezMessage = ERROR_MESSAGE()
        IF @@TRANCOUNT>0
            ROLLBACK TRAN
    END CATCH
    
    --IF @@TRANCOUNT>0 
        --ROLLBACK TRAN   --debug
    

    IF @@TRANCOUNT>0 
        COMMIT TRAN 
    
    
    
    SET NOCOUNT off
END 
GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[TEAMS_LegionellaProjectMonitoring]    Script Date: 03/09/2018 13:45:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[TEAMS_LegionellaProjectMonitoring]
	@ProjectGroupID INT = 0,
	@Year DATETIME = NULL
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;

SELECT
	@Year = DATEPART(YEAR, ISNULL(@Year, GETDATE()))

-- Get a list of jobs upfront
DECLARE @JobList TABLE (JobID INT, ProjectID INT, SiteID INT, LegionellaTypeID INT, StartTime DATETIME, Approved DATETIME)
INSERT INTO @JobList
SELECT
	j.JobID,
	j.ProjectID,
	j.SiteID,
	al.LegionellaTypeID,
	a.StartTime,
	j.Approved
FROM
	Job	j
	INNER JOIN Project p ON j.ProjectID = p.ProjectID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN Appointment a ON q.QuoteId = a.QuoteID AND AppointmentTypeID = 9
	INNER JOIN AppointmentLegionella al ON a.AppointmentID = al.AppointmentID
WHERE
	(p.ProjectGroupId = @ProjectGroupID OR @ProjectGroupID = 0)
		AND
	DATEPART(YEAR, a.StartTime) = @Year

-- Start the main select
SELECT 
	p.ProjectID,
	p.GroupName,
	janApproved.[Count] + '/' + janCount.[Count] [Jan],
	febApproved.[Count] + '/' + febCount.[Count] [Feb],
	marApproved.[Count] + '/' + marCount.[Count] [Mar],
	aprApproved.[Count] + '/' + aprCount.[Count] [Apr],	
	mayApproved.[Count] + '/' + mayCount.[Count] [May],
	junApproved.[Count] + '/' + junCount.[Count] [Jun],
	julApproved.[Count] + '/' + julCount.[Count] [Jul],
	augApproved.[Count] + '/' + augCount.[Count] [Aug],
	sepApproved.[Count] + '/' + sepCount.[Count] [Sep],
	octApproved.[Count] + '/' + octCount.[Count] [Oct],
	novApproved.[Count] + '/' + novCount.[Count] [Nov],
	decApproved.[Count] + '/' + decCount.[Count] [Dec]
FROM 
	@JobList j
	INNER JOIN Project p ON j.ProjectID = p.ProjectID
	--INNER JOIN LegionellaType lt ON j.LegionellaTypeID = lt.LegionellaTypeID

	-- Dont look at this, something written quickly just get something working, if slow please feel free to re-write
	-- January
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 1 AND _j.Approved IS NOT NULL
	) janApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 1
	) janCount

	-- February
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 2 AND _j.Approved IS NOT NULL
	) febApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 2
	) febCount

	-- March
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 3 AND _j.Approved IS NOT NULL
	) marApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 3
	) marCount

	-- April
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 4 AND _j.Approved IS NOT NULL
	) aprApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 4
	) aprCount
	
	-- May
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 5 AND _j.Approved IS NOT NULL
	) mayApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 5
	) mayCount

	-- June
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 6 AND _j.Approved IS NOT NULL
	) junApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 6
	) junCount

	-- July
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 7 AND _j.Approved IS NOT NULL
	) julApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 7
	) julCount

	-- August
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 8 AND _j.Approved IS NOT NULL
	) augApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 8
	) augCount

	-- September
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 9 AND _j.Approved IS NOT NULL
	) sepApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 9
	) sepCount

	-- October
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 10 AND _j.Approved IS NOT NULL
	) octApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 10
	) octCount

	-- November
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 11 AND _j.Approved IS NOT NULL
	) novApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 11
	) novCount

	-- December
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 12 AND _j.Approved IS NOT NULL
	) decApproved
	OUTER APPLY (
		SELECT CONVERT(VARCHAR(MAX), COUNT(*)) [Count] FROM @JobList _j
		WHERE _j.ProjectID = p.ProjectID AND DATEPART(MONTH, _j.StartTime) = 12
	) decCount
GROUP BY
	p.ProjectID,
	p.GroupName,
	janApproved.[Count],
	janCount.[Count],
	febApproved.[Count],
	febCount.[Count],
	marApproved.[Count],
	marCount.[Count],
	aprApproved.[Count],
	aprCount.[Count],
	mayApproved.[Count],
	mayCount.[Count],
	junApproved.[Count],
	junCount.[Count],
	julApproved.[Count],
	julCount.[Count],
	augApproved.[Count],
	augCount.[Count],
	sepApproved.[Count],
	sepCount.[Count],
	octApproved.[Count],
	octCount.[Count],
	novApproved.[Count],
	novCount.[Count],
	decApproved.[Count],
	decCount.[Count]

	SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 05/09/2018 14:35:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Paged_Projects]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella BIT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName

		-- Insert the header rows
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], IsLegionella
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
				AND
			(a.DateConfirmed IS NOT NULL OR a.AppointmentID IS NULL)
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager, IsLegionella
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
				AND
			(a.DateConfirmed IS NOT NULL OR a.AppointmentID IS NULL)
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			+ ' (' + 
					CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],
			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			IsLegionella
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END

GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 09/06/2018 16:51:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			[Identifier] =				ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC),
			[Row_Num] =					md.Row_Num,
			[Row_Total] =				md.Row_Total,
			[Page] =					md.Page,
			[Pages] =					md.Pages,
			[ClientID] =				md.ClientID,
			[Client] =					md.Client,
			[IsProjectGroup] =			CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1
											ELSE 0
										END,
			[ProjectGroupID] =			md.ProjectGroupID,
			[ProjectID] =				ISNULL(md.ProjectID, 0),
			[Name] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.ProjectGroup
											ELSE md.SubProjectName
										END,
			[Sites] =					ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END,
			[SitesRequired] =			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
										+ ' (' + 
										CASE 
											WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 
											THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
										ELSE 
											'N/A' 
										END + ')',
			[SitesBooked] =				SiteStatus.BookedCount,
			[SitesCompleted] =			SiteStatus.CompletedCount,
			[OutstandingJobs] =			CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN  CAST(ProjectGroupTotal.TotalJobs - ProjectGroupApproved.ApprovedJobs as VARCHAR(MAX)) + ' of ' + CAST(ProjectGroupTotal.TotalJobs as VARCHAR(MAX))
											ELSE
											--CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - 
											--CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) 
										CAST(ProjectJobCount.[TotalJobs] - SiteStatus.CompletedCount as VARCHAR(MAX))
											+ ' of ' + 
										CAST(ProjectJobCount.[TotalJobs] as VARCHAR(MAX))
										END,
										--CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - 
											--CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar),
			[DueDate] =					md.DueDate,
			[Starts] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.Starts
											ELSE null
										END,
			[Ends] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.Ends
											ELSE null
										END,
			[ProjectManager] =			CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.ProjectManager
											ELSE null
										END,
			[IsActive] =				CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.IsActive
											ELSE null
										END,
			[LegionellaTypeID] =		CASE
											WHEN md.ProjectID IS NOT NULL
											THEN ISNULL(md.LegionellaTypeID, 0)
											ELSE 0
										END,
			[IsLegionella] =			CAST(IsLegionella as BIT)
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT _j.JobID) [TotalJobs]
				FROM
					Job _j
					INNER JOIN Quote q ON _j.JobID = q.JobID
					INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
				WHERE
					_j.ProjectId = md.ProjectID			
			) ProjectJobCount
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT j.JobID) [TotalJobs]
				FROM
					ProjectGroup _pg
					INNER JOIN Project p ON _pg.ProjectGroupId = p.ProjectGroupId
					INNER JOIN Job j ON p.ProjectID = j.ProjectID
					INNER JOIN Quote q ON j.JobID = q.JobID
					INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
				WHERE
					_pg.ProjectGroupID = md.ProjectGroupID
			) ProjectGroupTotal
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT j.JobID) [ApprovedJobs]
				FROM
					ProjectGroup _pg
					INNER JOIN Project p ON _pg.ProjectGroupId = p.ProjectGroupId
					INNER JOIN Job j ON p.ProjectID = j.ProjectID
					INNER JOIN Quote q ON j.JobID = q.JobID
					INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
				WHERE
					_pg.ProjectGroupID = md.ProjectGroupID
						AND
					j.Approved IS NOT NULL
			) ProjectGroupApproved
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_SiteConsolidationList') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_SiteConsolidationList] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[TEAMS_SiteConsolidationList]
	@ClientID INT,
	@SiteID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT OFF;

-- Get a list of sites upfront
DECLARE @OverallSiteList TABLE (CurrentSiteID INT, Client VARCHAR(MAX), CurrentAddress VARCHAR(MAX), CurrentPostcode VARCHAR(MAX), CurrentUPRN VARCHAR(MAX), Identifier INT)
IF @SiteID = 0
BEGIN
	INSERT INTO @OverallSiteList
	SELECT
		si.SiteID,
		c.Client,
		si.Address,
		si.Postcode,
		si.UPRN,
		ROW_NUMBER() OVER (PARTITION BY si.UPRN ORDER BY si.SiteID ASC) [Identifier]
	FROM
		Client c
		INNER JOIN ClientSite cs ON c.ClientID = cs.ClientID
		INNER JOIn Site si ON cs.SiteID = si.SiteID
	WHERE
		NULlIF(si.UPRN, '') IS NOT NULL
			AND
		c.ClientID = @ClientID
			AND
		si.Deleted IS NULL
	ORDER BY 
		si.UPRN, 
		si.SiteID
END
ELSE
BEGIN
	INSERT INTO @OverallSiteList
	SELECT
		si.SiteID,
		c.Client,
		si.Address,
		si.Postcode,
		si.UPRN,
		ROW_NUMBER() OVER (PARTITION BY si.UPRN ORDER BY si.SiteID ASC) [Identifier]
	FROM
		Site si
		INNER JOIN ClientSite cs ON si.SiteID = cs.SiteID
		INNER JOIN Client c ON cs.ClientID = c.ClientID
	WHERE
		si.UPRN = (SELECT UPRN FROM Site WHERE SiteID = @SiteID)
			AND
		c.ClientID = @ClientID
END

-- Get a list of UPRNS that appear more than once to join onto later
DECLARE @DuplicateUPRNList TABLE (UPRN VARCHAR(MAX), UPRNCount INT)
INSERT INTO @DuplicateUPRNList
SELECT
	osl.CurrentUPRN,
	COUNT(*)
FROM
	@OverallSiteList osl
GROUP BY
	osl.CurrentUPRN
HAVING
	COUNT(*) > 1

-- Filter the initial site list to only return the ones with a duplicated UPRN
DECLARE @FinalDataSet TABLE (CurrentSiteID INT, Client VARCHAR(MAX), CurrentAddress VARCHAR(MAX),CurrentPostcode VARCHAR(MAX), CurrentUPRN Varchar(MAX),Identifier INT)
INSERT INTO @FinalDataSet (CurrentSiteID, Client, CurrentAddress,CurrentPostcode, CurrentUPRN,Identifier)
SELECT
	si.CurrentSiteID,
	si.Client,
	si.CurrentAddress,
	si.CurrentPostcode,
	si.CurrentUPRN,
	si.Identifier
FROM
	@OverallSiteList si
	INNER JOIN @DuplicateUPRNList ul ON si.CurrentUPRN = ul.UPRN

-- Start the main select
SELECT
	[CurrentSiteID] =		keeping.CurrentSiteID,
	[CurrentUPRN] =			keeping.CurrentUPRN,
	[CurrentAddress] =		keeping.CurrentAddress,
	[NewSiteID]	=			changing.CurrentSiteID,
	[NewSiteAddress] =		changing.CurrentAddress,
	[CurrentSiteJobs] =		ISNULL(' - ' + jobList.Jobs, NULL)
FROM
	@FinalDataSet changing
	INNER JOIN @FinalDataSet keeping ON changing.CurrentUPRN = keeping.CurrentUPRN --AND main.Identifier<subList.Identifier
	OUTER APPLY
	(
		SELECT
			STUFF((
				SELECT DISTINCT
					', ' + dbo.FormatTEAMSReference('J', j.JobNo)
				FROM
					Job j
				WHERE
					j.SiteID = keeping.CurrentSiteID
			FOR XML PATH('')), 1, 2, '') [Jobs]
	) jobList
WHERE
	changing.Identifier = 1
ORDER BY
	keeping.CurrentUPRN,
	keeping.CurrentSiteID

	SET NOCOUNT ON;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'merge_Client_Site') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[merge_Client_Site] AS BEGIN SET NOCOUNT ON; END')
End

GO

/****** Object:  StoredProcedure [dbo].[merge_Client_Site]    Script Date: 10/09/2018 17:02:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[merge_Client_Site]
	@ClientID int,
	@KeepSiteID int,
	@RemoveSiteID int, 
	@err bit OUTPUT, 
	@errMessage varchar(MAX) output
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRAN

	IF @KeepSiteID=@RemoveSiteID BEGIN
		select @err = 1
		select @errMessage = 'ERROR supplied keepsite/removesite have the same value'
		goto errHandle
	END

	IF (SELECT COUNT(*) FROM ClientSite WHERE ClientID=@ClientID AND SiteID=@KeepSiteID)=0 OR (SELECT COUNT(*) FROM ClientSite WHERE ClientID=@ClientID AND SiteID=@RemoveSiteID)=0 BEGIN
		select @err = 1
		select @errMessage = 'ERROR supplied client/keepsite/removesite does not match'
		goto errHandle
	END

	DECLARE @ExecString NVARCHAR(MAX)
	declare job_cursor cursor for 
	SELECT 
		'EXEC changeClientSiteForJobQuote @QuoteID=' + CAST(q.QuoteID as varchar) + ',@JobID=' + CAST(j.JobID as varchar) + ',@SiteID=' + CAST(@KeepSiteID as varchar) + ',@ClientID=' + CAST(j.ClientID as varchar) + IsNULL(',@ProjectID=' + CAST(j.ProjectID as varchar),'')
	FROM 
		Job j
		INNER JOIN Quote q ON j.JobID=q.JobID
	WHERE 
		j.ClientID=@ClientID
			AND
		j.SiteID=@RemoveSiteID
	
	OPEN job_cursor
	FETCH NEXT FROM job_cursor INTO @ExecString

	WHILE @@FETCH_STATUS = 0
	BEGIN
		EXECUTE sp_executesql  @ExecString
		FETCH NEXT FROM job_cursor INTO @ExecString
	END
	CLOSE job_cursor
	DEALLOCATE job_cursor
	select @err = @@ERROR
	if @err<>0 
	begin
		select @errMessage = 'ERROR while running changeClientSiteForJobQuote'
		goto errHandle
	END


    EXEC TEAMS_SiteMerge @KeepSiteID,@RemoveSiteID,@err,@errMessage			
	
	select @err = @@ERROR
	if @err<>0 
	begin
		select @errMessage = 'ERROR while running TEAMS_SiteMerge'
		goto errHandle
	END

	update site set deleted = GETDATE() where siteid = @RemoveSiteID
    
	commit tran
	goto exit_proc

	errHandle:
		rollback TRAN

	exit_proc:

    SET NOCOUNT off    
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'SurveyPhotoCollections') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[SurveyPhotoCollections] AS BEGIN SET NOCOUNT ON; END')
End

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[SurveyPhotoCollections]
    @JobID INT,
    @IncludeAutoInsert BIT = 1
   
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
    SET NOCOUNT ON

    SELECT
		results.Type,
		ImageSize,
		PhotoID,
		PhotoReplaceVariable,
		Caption,
		CaptionReplaceVariable,
		TimeStamp,
		TimeStampReplaceVariable
    FROM
    (
        SELECT 
			main.[Type],
			' width="' + CAST(ISNULL(mcWidth.[MobileConfigInt],400) as varchar) + '" height="' + CAST(ISNULL(mcHeight.[MobileConfigInt],300) as varchar) + '"' [ImageSize],
			main.PhotoID,
			main.PhotoReplaceVariable,
			main.Caption,
			main.CaptionReplaceVariable,
			main.TimeStamp,
			main.TimeStampReplaceVariable,
			main.AutoInsert,
			main.[Order]
		FROM
			(
				SELECT
					'PhotoCollection' [Type], 
					ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) [Order], 
					p.PhotoID [PhotoID], 
					ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) [SELNO], 
					REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariable], 
					IsNull(pc.Caption,'N/A') [Caption], 
					REPLACE(REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION]') [CaptionReplaceVariable],
					CONVERT(varchar,pc.Created,IsNull((Select MobileConfigInt FROM MobileConfig Where MobileConfigTypeID=88),103)) [TimeStamp],
					REPLACE(REPLACE('[SAMPLEPHOTOCOLLECTION:' + CAST(s.SampleID as varchar) + ':[SELNO]]','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By s.SampleID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME]') [TimeStampReplaceVariable],
					pc.AutoInsert
				FROM
					Job j
					INNER JOIN JobEmployee je ON je.JobID = j.JobID
					INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
					--INNER JOIN Survey su ON su.SurveyID = r.SurveyID
					INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
					INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
					INNER JOIN Sample s ON s.RoomID = rm.RoomID
					LEFT OUTER JOIN PhotoCollection pc ON s.SampleID = pc.SampleID AND pc.IncludeInPDF IS NOT NULL AND pc.Deleted IS NULL
					LEFT OUTER JOIN Photo p ON p.PhotoID=pc.PhotoID
				WHERE
					j.JobID = @JobID
			) main
        LEFT OUTER JOIN MobileConfig mcWidth WITH (NOLOCK) ON mcWidth.MobileConfigText='Width' AND mcWidth.MobileConfigTypeID=116
		LEFT OUTER JOIN MobileConfig mcHeight WITH (NOLOCK) ON mcHeight.MobileConfigText='Height' AND mcHeight.MobileConfigTypeID=116
    ) results
	WHERE
		CASE 
			WHEN @IncludeAutoInsert = 1 THEN 1
			ELSE
				CASE
					WHEN AutoInsert = 1 THEN 0
					ELSE 1
				END
			END = 1
    ORDER BY
        results.[Order]

    SET NOCOUNT OFF
       
END
GO

USE [TEAMS]
GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[EnterpriseSiteData]
(
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
	  @IncludePhotoNoColumn BIT = 0
)
AS
BEGIN
       SET NOCOUNT ON;

	   DECLARE @DisableBuildingDescription BIT = (SELECT CASE WHEN (SELECT MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=31 AND MobileConfigText='txtBuildingDescription') > 0 THEN 1 ELSe 0 END)
	   DECLARE @DisabletxtBuildingAge BIT = (SELECT CASE WHEN (SELECT MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=31 AND MobileConfigText='txtBuildingAge') > 0 THEN 1 ELSe 0 END)
	   DECLARE @DisabletxtBuildingConstructionType BIT = (SELECT CASE WHEN (SELECT MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=31 AND MobileConfigText='txtBuildingConstructionType') > 0 THEN 1 ELSe 0 END)

       DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
       -- crack @ClientIDs into a table
       DECLARE @Clients TABLE ( ClientID INT )

       INSERT
              @Clients (ClientID)
       SELECT
              ClientID
       FROM
              ClientSite
       WHERE
              SiteID = @SiteID

       DECLARE @IDList TABLE (UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
       Insert into @IDList (UseRoomCode, RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
       SELECT 
              CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
              r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
              fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
              rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
              s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
       FROM 
              (
                     SELECT 
                           j.JobID, j.SiteID
                     FROM
                           Job j WITH (NOLOCK)
                           INNER JOIN @Clients c ON j.ClientID=c.ClientID
                           INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
                           INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
                     WHERE
                           a.DateDeclined IS NULL
                                  AND
                           j.Approved IS NOT NULL
              ) j
              INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
              INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
              LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
              LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
              LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
       WHERE 
              j.SiteID=@SiteID

       SELECT
              main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, p.PhotoData, p.ContentType,
              r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode
       FROM
              (
                     Select
                           'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                  MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RegisterID,BuildingGUID,BuildingGUIDVersion
                     ) _r
                     WHERE
                           _r.Identifier = 1
              ) main
              INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
              LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
       
       SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
              main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
              fp.FloorNumber, 
              CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END [FloorplanData],
              CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType]
       FROM
              (      
                     Select
                           'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
                                  FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
                     ) _f
                     WHERE
                           _f.Identifier = 1
              ) main
              INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
       
       SELECT
              main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
              rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode
       FROM
              (
                     Select
                           'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
                                  RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
                     ) _rm
                     WHERE
                           _rm.Identifier = 1
              ) main
              INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
       
       DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
       
       INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion)
       SELECT
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion
       FROM
              (      
                     Select
                           'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],
                                  SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
                     ) _s
                     WHERE
                           _s.Identifier = 1
              ) main
              INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
              INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID
              INNER JOIN @Clients c ON gs.ClientID=c.ClientID
       GROUP BY
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion

	   IF @IncludePhotoNoColumn = 1
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,p.PhotoData, p.PhotoNo, s.SampleRef, s.AsSample,  
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee]
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID

		ELSE
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,p.PhotoData, s.SampleRef, s.AsSample, 
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee]
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
       
       SELECT
              main.TableName,
              main.SampleID,
              main.RegisterID,
              main.ElementTypeID,
              main.ElementText
       FROM
       (
              SELECT
                     'Element' [TableName],
                     e.SampleID, 
                     NULL [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,eim.Description)
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     @GuidSamples main
                     INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
              WHERE
                     e.ElementTypeID NOT IN (32)
              UNION
              SELECT
                     'Element' [TableName],
                     NULL [SampleID], 
                     e.RegisterID [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,eim.Description)
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     (
                           Select
                                  _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
                           FROM
                           (
                                  SELECT
                                         ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                         MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                                  FROM
                                         @IDList
                                  GROUP BY
                                         RegisterID,BuildingGUID,BuildingGUIDVersion
                           ) _r
                           WHERE
                                  _r.Identifier = 1
                     ) main
                     INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
                     INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
              WHERE
					 CASE WHEN (e.ElementTypeID=140 AND @DisableBuildingDescription = 1) OR (e.ElementTypeID=141 AND @DisabletxtBuildingAge = 1) OR (e.ElementTypeID=142 AND @DisabletxtBuildingConstructionType = 1) THEN
						0
					 ELSE
						 CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
							   1 
						 ELSE
							   CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
						 END 
					 END
					 = 1
       ) main
       
       SET NOCOUNT OFF;
END


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'DeleteDuplicatedElement_ByJob_FromMobile') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[DeleteDuplicatedElement_ByJob_FromMobile] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[DeleteDuplicatedElement_ByJob_FromMobile]    Script Date: 12/09/2018 11:40:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[DeleteDuplicatedElement_ByJob_FromMobile]
      @JobID INT
AS
BEGIN
      SET NOCOUNT ON;

	DECLARE @ElementSampleList TABLE (SampleId INT,retain_ElementID INT,ElementTypeID INT)
	Insert into @ElementSampleList (SampleId,retain_ElementID,ElementTypeID)
	SELECT s.SampleID, DeleteE.retain_ElementID, DeleteE.ElementTypeID
	  FROM 
		(Select JobID FROM Job WITH (NOLOCK) Where JobID=@JobID) j
	  INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
	  INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
	  INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
	  INNER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
	  INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
	  CROSS APPLY
	  (
			Select MIN(e.ElementID) 'retain_ElementID', e.ElementTypeID FROM Element e WITH (NOLOCK) Where e.SampleID=s.SampleID
			GROUP BY e.SampleID,e.AirSampleID,e.ElementTypeID,e.ElementText, e.ElementDateTime,e.ElementIntID, e.ElementIntMeaningID, e.ElementIntMeaningExtendedID, e.ElementIntMeaningSubOptionID, e.RegisterID,e.AirTestID,e.RemovalID,e.ImportID
			HAVING COUNT(e.ElementTypeID)>1
	  ) DeleteE

      Delete Element FROM  
      Element INNER JOIN 
      @ElementSampleList Main ON Element.SampleID=Main.SampleID AND Main.ElementTypeID=Element.ElementTypeID
      Where Element.ElementID NOT IN (Main.retain_ElementID)
      
      
      DECLARE @ElementRegisterList TABLE (RegisterID INT,retain_ElementID INT,ElementTypeID INT)
	  Insert into @ElementRegisterList (RegisterID,retain_ElementID,ElementTypeID)
      SELECT r.RegisterID, DeleteE.retain_ElementID, DeleteE.ElementTypeID
                  FROM 
                  (Select JobID FROM Job WITH (NOLOCK) Where JobID=@JobID) j
                  INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
                  INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
                  CROSS APPLY
                  (
                        Select MIN(e.ElementID) 'retain_ElementID', e.ElementTypeID FROM Element e WITH (NOLOCK) Where e.RegisterID=r.RegisterID
                        GROUP BY e.SampleID,e.AirSampleID,e.ElementTypeID,e.ElementText, e.ElementDateTime,e.ElementIntID, e.ElementIntMeaningID, e.ElementIntMeaningExtendedID, e.ElementIntMeaningSubOptionID, e.RegisterID,e.AirTestID,e.RemovalID,e.ImportID
                        HAVING COUNT(e.ElementTypeID)>1
                  ) DeleteE
                  
      Delete Element FROM  Element INNER JOIN 
      @ElementRegisterList
      Main ON Element.RegisterID=Main.RegisterID AND Main.ElementTypeID=Element.ElementTypeID
      Where Element.ElementID NOT IN (Main.retain_ElementID)
 
      SET NOCOUNT OFF; 
      
END

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__DisplayPortalLegSitesCheckedLastMonth') < 1
BEGIN
	ALTER TABLE [dbo].[Config]
	ADD [b__DisplayPortalLegSitesCheckedLastMonth] [bit] NOT NULL
	CONSTRAINT [DF_Config_b__DisplayPortalLegSitesCheckedLastMonth]
	DEFAULT (0);
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PortalUser') AND name='LegSitesCheckedLastMonthChart') < 1
BEGIN
	ALTER TABLE [dbo].[PortalUser]
	ADD [LegSitesCheckedLastMonthChart] [bit] NOT NULL
	CONSTRAINT [DF_PortalUser_LegSitesCheckedLastMonthChart]
	DEFAULT (0);
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaCompleted')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaCompleted] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[dgLegionellaCompleted] AS 
	Select
		j.JobId,
		qvt.QuoteVisitTypeId [TypeID], 
		qvt.Description [Type], 
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		Cast(MIN(a.StartTime) as date) [Start],
		Cast(MIN(a.EndTime) as date) [Finish],
		Cast(MIN(a.EndTime) as date) [MonitoringSchedule],
		Cast(MAX(agt.DueDate) as date) [Due], 
		c.ClientId,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteId,
		s.Address [Site],
		0 As [Report],
		0 As [Photos],
		0 As [Plans],
		0 As [Documents],
		j.Approved [DateApproved],
		0 [HasNotes],
		0 [NotesInLastHour],
		0 [NewGrid],
		j.Status [Status],
		'' [OrgState],
		0 As [PDF],
		qe.EmployeeID [EmployeeID],
		e.FullName [FullName],
		j.ProjectID [ProjectID]
	From 
		Quote q WITH (NOLOCK)
		INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID=qe.QuoteID
		INNER JOIN Employee e WITH (NOLOCK) ON qe.EmployeeID = e.EmployeeID
		INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
		INNER JOIN QuoteVisitType qvt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
		Inner Join Appointment a WITH (NOLOCK) On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)
		INNER JOIN
		(
			Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag WITH (NOLOCK)
				UNION
			Select null [DueDate], at.AppointmentID FROM AppointmentTraining at WITH (NOLOCK)
		) agt ON agt.AppointmentID=a.AppointmentID
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=q.JobID
		Left Outer Join Client c WITH (NOLOCK) On a.ClientId = c.ClientId
		Left Outer Join Site s WITH (NOLOCK) On a.SiteId = s.SiteId
		Outer Apply 
		(
			Select Top 1 [FileName] From PDF p WITH (NOLOCK) Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
		) oa_pdf
	Where
		a.ManuallyMarkWorkDone = 1
			And
		a.DateConfirmed IS NOT Null
			And
		a.DateDeclined Is Null
			And
		qvt.QuoteVisitTypeId=4
	GROUP BY
		j.JobId,
		qvt.QuoteVisitTypeId,
		qvt.Description,
		j.JobNo,
		c.ClientId,
		c.Client,
		c.BranchName,
		s.SiteId,
		s.Address,
		j.Approved,
		j.Status,
		qe.EmployeeID,
		e.FullName,
		j.ProjectID

GO
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'MobileUnitSummary')
BEGIN
    EXEC('CREATE VIEW[dbo].[MobileUnitSummary] AS SELECT 1 GO')
END
GO

USE [TEAMS]
GO

/****** Object:  View [dbo].[MobileUnitSummary]    Script Date: 21/09/2018 14:37:57 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[MobileUnitSummary]
As

-- Get a list of all of the different tablets (including tablets with different Mobile V2 Types (e.g. survey, air, legionella))
WITH 
MobileUnits (SystemName, Category) AS
(
	SELECT
		DISTINCT
		mat.SystemName,
		mat.Category
	FROM
		MobileAuditTrail mat
	WHERE
		mat.[DateCreated] BETWEEN CONVERT(varchar(20),DATEADD(day,-30,GETDATE()),106) AND CONVERT(VARCHAR(20),DATEADD(day,1,GETDATE()),106)
			--AND
		--Category <> 2
)

SELECT TOP 100 PERCENT
	mu.SystemName [SystemName],
	LastUsedDetails.Date [LastUsed],
	CASE
		WHEN Category = 1 THEN 'Mobile V1'
		WHEN Category = 3 THEN 'Mobile V2 AirTesting'
		WHEN Category = 4 THEN 'Mobile V2 Surveying'
		WHEN Category = 5 THEN 'Mobile V2 Legionella'
		ELSE
			CASE
				WHEN LastUsedDetails.DataScript = 'DataTransferService.cs'
				THEN 'Mobile V1'
				ELSE 'Mobile V2'
			END
	END + ' (' + LastUsedDetails.Version + ')' [SoftwareVersion],
	ISNULL(eq.SerialNumber, '') [SerialNumber],
	ISNULL(LastUsedDetails.Employee, '') [Employee],
	ISNULL(LastUsedDetails.Branch, '') [UserBranch],
	mulk.LicenceKey [LicenceKey],
	eq.EquipmentID [EquipmentID],
	LastUpdate.Date [LastUpdate],
	LastUsedDetails.DataScript [DataScript]
FROM
	MobileUnits mu
	LEFT JOIN Equipment eq WITH (NOLOCK) ON eq.RefNo = mu.SystemName AND eq.EquipmentCategoryID = 19
	LEFT JOIN MobileUnitLicenceKey mulk	WITH (NOLOCK) ON eq.MobileUnitLicenceKeyID = mulk.MobileUnitLicenceKeyID

	OUTER APPLY
	(
		SELECT
			TOP 1
			mat.DataQueryString [Version],
			mat.DateCreated [Date],
			e.FullName [Employee],
			bo.BranchOffice [Branch],
			mat.DataScript [DataScript]
		FROM
			MobileAuditTrail mat
			LEFT JOIN Employee e WITH (NOLOCK) ON mat.EmployeeID = e.EmployeeID
			LEFT JOIN BranchOffice bo WITH (NOLOCK) ON e.BranchOfficeID = bo.BranchOfficeID
		WHERE
			mat.SystemName = mu.SystemName
				AND
			mat.Category = mu.Category
		ORDER BY
			mat.DateCreated DESC
	) LastUsedDetails

	OUTER APPLY
	(
		SELECT TOP 1
			mat1.DateCreated [Date]
		FROM
			MobileAuditTrail mat1
		WHERE
			mat1.SystemName = mu.SystemName
					AND
			mat1.Category = mu.Category
				AND
			mat1.DataQueryString != LastUsedDetails.Version
		ORDER BY
			mat1.DateCreated DESC
	) LastUpdate
ORDER BY
	mu.SystemName
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PortalUser') AND name='Fire') < 1
BEGIN
	ALTER TABLE [dbo].[PortalUser]
	ADD [Fire] [bit] NOT NULL
	CONSTRAINT [DF_PortalUser_Fire]
	DEFAULT (0);
END
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 26/09/2018 15:05:19 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Paged_Projects]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			+ ' (' + 
					CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],
			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'JobSurveyTypeCount') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[JobSurveyTypeCount] AS BEGIN SET NOCOUNT ON; END')
End

GO
USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[JobSurveyTypeCount]    Script Date: 28/09/2018 11:48:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[JobSurveyTypeCount](@Jobid int)
AS 
BEGIN        
    SET NOCOUNT on
    DECLARE @t TABLE(_idx int IDENTITY(1,1), jobid [int] NOT NULL, surveytypeid [int],jobno varchar(10))
    INSERT INTO @t ([jobid], [surveytypeid], [jobno])
        SELECT DISTINCT
            j.[JobID],
            [su].[SurveyTypeID],
            dbo.[FormatTeamsReference]('J',[j].[JobNo]) [JobNo]
        FROM
            [dbo].[Job] j
            INNER JOIN [dbo].[JobEmployee] je ON [je].[JobID] = [j].[JobID]
            INNER JOIN [dbo].[Register] reg ON [reg].[JobEmployeeID] = [je].[JobEmployeeID]
            INNER JOIN [dbo].[Survey] su ON [su].[SurveyID] = [reg].[SurveyID]                
        WHERE
            j.[JobID] = @jobid
        ORDER BY [j].[JobID]
            
            
    SELECT DISTINCT 
        _t.jobid [jobid], 
        _t.[jobno],
        COUNT(_t.jobid) [surveyTypeCount]
    FROM 
        @t _t 
    WHERE 
        _t.[jobid] = @Jobid
    GROUP BY 
        [_t].[jobid],
        [_t].[jobno]
    
    SET NOCOUNT OFF
END 
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SurveyTypePropertyTypeCost'))
	BEGIN
		CREATE TABLE [dbo].[SurveyTypePropertyTypeCost] (
		[SurveyTypePropertyTypeCostID] [int] IDENTITY (1, 1) NOT NULL,
		[SurveyTypeID] [int] NOT NULL,
		[PropertyTypeId] [int] NOT NULL,
		[Cost] [money] NULL,
		[clientid] [int] NULL,
		CONSTRAINT [PK_SurveyTypePropertyTypeCost]
		PRIMARY KEY CLUSTERED
		(
			[SurveyTypePropertyTypeCostID] ASC
		)
		WITH (FILLFACTOR = 90, PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'modifyEmployeeAuthorisation') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[modifyEmployeeAuthorisation] AS BEGIN SET NOCOUNT ON; END')
End

GO
USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[modifyEmployeeAuthorisation]    Script Date: 19/08/2020 16:38:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[modifyEmployeeAuthorisation]
    @employeeId INT,
    @surveytypeid INT,
    @airtesttypeid INT,
    @enabled BIT,
    @expirydate DATETIME,
    @surveytypeGroupId INT = NULL,
    @propertytypeId INT = NULL,
    @SampleAnalysis BIT = 0,
    @AirtestAuthorisationTypeID INT = NULL,
	@SessionEmployeeID INT = 0,
	@SessionDataScript VARCHAR(MAX) = NULL,
	@SessionDataQueryString VARCHAR(MAX) = NULL,
	@SessionDataIPAddress VARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;


    -- DEBUG
        --DECLARE
        --    @employeeId INT = 92,
        --    @surveytypeid INT = NULL,
        --    @airtesttypeid INT = NULL,
        --    @enabled BIT = 0,
        --    @expirydate DATETIME = NULL,
        --    @surveytypeGroupId INT = 16,
        --    @propertytypeId INT = 1,
        --    @SampleAnalysis BIT = 0,
        --    @AirtestAuthorisationTypeID INT = NULL
    -- END DEBUG
	
	DECLARE @SurveyTypeGroupString VARCHAR(MAX) = (SELECT Description FROM SurveyTypeGroup WHERE SurveyTypeGroupID = @surveytypeGroupId)
	DECLARE @AirTestTypeString VARCHAR(MAX) = (SELECT Description FROM AirTestType WHERE AirTestTypeID = @airtesttypeid)
	DECLARE @ExpiryDateString VARCHAR(MAX) = CASE WHEN @expirydate IS NULL THEN 'No Expiry' ELSE CONVERT(varchar(max), @expirydate) END
	DECLARE @CurrentEnabled BIT

    IF @surveytypeGroupId IS NOT NULL AND @propertytypeId IS NULL
    BEGIN
		-- insert an audit
		SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM SurveyType st INNER JOIN EmployeeAuthorisation ea WITH (NOLOCK) ON st.SurveyTypeID = ea.SurveyTypeID WHERE SurveyTypeGroupID = @surveytypeGroupId AND ea.EmployeeID = @employeeId AND st.Deleted IS NULL)

		IF @enabled = 1 AND @CurrentEnabled = 0
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
		ELSE IF @enabled = 0 AND @CurrentEnabled = 1
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END

        --firstly update the records that do exist
        UPDATE ea
        SET
            ea.[Enabled] = CASE WHEN st.Deleted IS NOT NULL THEN 0 ELSE @enabled END,
            ea.[ExpiryDate] = @expirydate
        FROM
            [dbo].[SurveyType] st
            INNER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId]
        WHERE 
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            [ea].[EmployeeID] = @employeeId AND
			ea.PropertyTypeID IS NULL

        --secondly, insert the new EmployeeAuthorisation that do not exist for the client
        INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate])
        SELECT
            @employeeId,
            st.surveytypeid,
            @enabled,
            @expirydate
        FROM
            [dbo].[SurveyType] st
            LEFT OUTER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId] AND [ea].[EmployeeID] = @employeeId
        WHERE
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            ea.[EmployeeAuthorisationID] IS NULL
    END
    ELSE IF @surveytypeGroupId IS NOT NULL AND @propertytypeId IS NOT NULL
    BEGIN
		-- insert an audit
		DECLARE @PropertyTypeString VARCHAR(MAX) = (SELECT PropertyType FROM PropertyType WHERE PropertyTypeID = @propertytypeId)
		SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM SurveyType st INNER JOIN EmployeeAuthorisation ea WITH (NOLOCK) ON st.SurveyTypeID = ea.SurveyTypeID WHERE SurveyTypeGroupID = @surveytypeGroupId AND ea.EmployeeID = @employeeId AND ea.PropertyTypeID = @propertytypeId AND st.Deleted IS NULL)

		IF @enabled = 1 AND @CurrentEnabled = 0
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', PropertyType: ' + @PropertyTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
		ELSE IF @enabled = 0 AND @CurrentEnabled = 1
		BEGIN
		INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for SurveyTypeGroup: ' + @SurveyTypeGroupString + ', PropertyType: ' + @PropertyTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
		END
        --firstly update the records that do exist
        UPDATE ea
            SET 
                ea.[Enabled] = CASE WHEN st.Deleted IS NOT NULL THEN 0 ELSE @enabled END,
                ea.[ExpiryDate] = @expirydate
        FROM 
            [dbo].[SurveyType] st
            INNER JOIN EmployeeAuthorisation ea ON st.[SurveyTypeID] = [ea].[SurveyTypeId]
        WHERE 
            [SurveyTypeGroupID] = @surveytypeGroupId AND
            [ea].[EmployeeID] = @employeeId AND 
            [ea].[PropertyTypeID] = @propertytypeId

        IF not EXISTS(SELECT 'x' FROM [dbo].[SurveyType] st INNER JOIN EmployeeAuthorisation ea ON [ea].[SurveyTypeId] = [st].[SurveyTypeID] 
                        WHERE [EmployeeID] = @employeeId AND st.[SurveyTypeGroupID] = @surveytypeGroupId AND [PropertyTypeID] = @propertytypeId AND st.Deleted IS NULL) AND @enabled = 1 AND @propertytypeId IS not null
        BEGIN             
            INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate], [PropertyTypeID])
            SELECT
                @employeeId,
                st.surveytypeid,
                @enabled,
                @expirydate,
                @propertytypeId
             FROM 
                [dbo].[SurveyType] st
            WHERE
                [SurveyTypeGroupID] = @surveytypeGroupId  AND st.Deleted IS NULL
                --AND [ea].[Enabled] = 1
                --AND
                --ea.[EmployeeAuthorisationID] IS NULL        
        END 
    END 
    ELSE IF @surveytypeid IS NOT NULL
    BEGIN
        IF EXISTS(SELECT 'x' FROM EmployeeAuthorisation WHERE [EmployeeID] = @employeeId AND surveytypeid = @surveytypeid) 
        BEGIN
            UPDATE EmployeeAuthorisation SET [Enabled] = @enabled, [ExpiryDate] = @expirydate WHERE [EmployeeID] = @employeeId AND surveytypeid = @surveytypeid            
        END
        ELSE
        BEGIN
            INSERT [dbo].[EmployeeAuthorisation] ([EmployeeID], [SurveyTypeId], [Enabled], [ExpiryDate])
            SELECT
                @employeeId,
                @surveytypeid,
                @enabled,
                @expirydate
        END
    END 
    ELSE IF @airtesttypeid IS NOT NULL
    BEGIN
        IF @AirtestAuthorisationTypeID IS NOT NULL
        BEGIN
			-- insert an audit
			DECLARE @AirTestAuthorisationTypeString VARCHAR(MAX) = (SELECT Description FROM AirTestAuthorisationType WHERE AirTestAuthorisationTypeID = @AirtestAuthorisationTypeID)
			SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM EmployeeAuthorisation ea WHERE ea.AirtestTypeId = @airtesttypeid AND ea.EmployeeID = @employeeId AND ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID)

			IF @enabled = 1 AND @CurrentEnabled = 0
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for AirTestType: ' + @AirTestTypeString + ', AirTestAuthorisationType: ' + @AirTestAuthorisationTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END
			ELSE IF @enabled = 0 AND @CurrentEnabled = 1
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for AirTestType: ' + @AirTestTypeString + ', AirTestAuthorisationType: ' + @AirTestAuthorisationTypeString + ' Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END

            -- Run an UPDATE if a record exists for this employee.
            IF EXISTS (SELECT 1 FROM EmployeeAuthorisation ea WHERE ea.EmployeeID = @employeeId AND ea.AirtestTypeId = @airtesttypeid AND ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID)
            BEGIN
                UPDATE ea
                SET
                    ea.Enabled = @enabled,
                    ea.ExpiryDate = @expirydate
                FROM
                    EmployeeAuthorisation ea
                WHERE
                    ea.EmployeeID = @employeeId
                        AND
                    ea.AirtestTypeId = @airtesttypeid
                        AND
                    ea.AirtestAuthorisationTypeID = @AirtestAuthorisationTypeID
            END
            ELSE
            BEGIN
                INSERT INTO EmployeeAuthorisation (EmployeeID, AirtestTypeID, Enabled, ExpiryDate, AirtestAuthorisationTypeID)
                SELECT
                    @employeeId,
                    @airtesttypeid,
                    @enabled,
                    @expirydate,
                    @AirtestAuthorisationTypeID
            END
        END
        ELSE
        BEGIN
			-- insert an audit
			SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM EmployeeAuthorisation ea WHERE AirTestTypeID = @airtesttypeid AND ea.EmployeeID = @employeeId)

			IF @enabled = 1 AND @CurrentEnabled = 0
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for AirTestType: ' + @AirTestTypeString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END
			ELSE IF @enabled = 0 AND @CurrentEnabled = 1
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for AirTestType: ' + @AirTestTypeString + ', Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END

            -- Run an UPDATE if a record exists for this employee.
            IF EXISTS (SELECT 1 FROM EmployeeAuthorisation ea WHERE ea.EmployeeID = @employeeId AND ea.AirtestTypeId = @airtesttypeid)
            BEGIN
                UPDATE ea
                SET
                    ea.Enabled = @enabled,
                    ea.ExpiryDate = @expirydate
                FROM 
                    EmployeeAuthorisation ea
                WHERE
                    ea.EmployeeID = @employeeId
                        AND
                    ea.AirtestTypeId = @airtesttypeid
            END
            ELSE
            BEGIN
                INSERT INTO EmployeeAuthorisation (EmployeeID, AirtestTypeID, Enabled, ExpiryDate)
                SELECT
                    @employeeId,
                    @airtesttypeid,
                    @enabled,
                    @expirydate
            END
        END
    END
    ELSE IF @SampleAnalysis = 1
    BEGIN
        IF EXISTS(SELECT 1 FROM EmployeeAuthorisation WITH (NOLOCK) WHERE EmployeeID = @employeeId AND SampleAnalysis = 1)
		BEGIN
			-- Insert an audit
			SET @CurrentEnabled = (SELECT TOP 1 ea.Enabled FROM EmployeeAuthorisation ea WHERE ea.SampleAnalysis = 1 AND ea.EmployeeID = @employeeId)

			IF @enabled = 1 AND @CurrentEnabled = 0
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for Sample Analysis, Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END
			ELSE IF @enabled = 0 AND @CurrentEnabled = 1
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for Sample Analysis, Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END

			BEGIN
				UPDATE EmployeeAuthorisation
				SET
					Enabled = @enabled,
					ExpiryDate = @expirydate
				WHERE
					EmployeeID = @employeeId
						AND
					SampleAnalysis = 1
			END
		END
        ELSE
        BEGIN
			IF @enabled = 1
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Enabled employee authorisation for Sample Analysis, Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END
			ELSE IF @enabled = 0
			BEGIN
			INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (1, @SessionEmployeeID, 'Disabled employee authorisation for Sample Analysis, Expiry: ' + @ExpiryDateString, 'Employee', @employeeId, @SessionDataScript, @SessionDataQueryString, @SessionDataIPAddress, getdate())
			END

            INSERT INTO EmployeeAuthorisation (EmployeeID, Enabled, ExpiryDate, SampleAnalysis)
            SELECT
                @employeeId,
                @enabled,
                @expirydate,
                1
        END
    END


    SET NOCOUNT OFF;
END

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Room') AND name='RoomGroupID') < 1
BEGIN
	ALTER TABLE [dbo].[Room]
	ADD [RoomGroupID] [int] NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Room') AND name='ParentGroupID') < 1
BEGIN
	ALTER TABLE [dbo].[Room]
	ADD [ParentGroupID] [int] NULL
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='RoomGroup'))
BEGIN
	CREATE TABLE [dbo].[RoomGroup](
	[RoomGroupID] [int] IDENTITY(1,1) NOT NULL,
	CONSTRAINT [PK_RoomGroup] PRIMARY KEY CLUSTERED 
	(
		[RoomGroupID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='AppointmentLegionellaType'))
	BEGIN
		CREATE TABLE [dbo].[AppointmentLegionellaType] (
		[AppointmentLegionellaTypeID] [int] IDENTITY (1, 1) NOT NULL,
		[AppointmentLegionellaID] [int] NOT NULL,
		[LegionellaTypeID] [int] NOT NULL,
		CONSTRAINT [PK__Appointm__19F120281A223292]
		PRIMARY KEY CLUSTERED
		(
			[AppointmentLegionellaTypeID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetCountsForReport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetCountsForReport] AS BEGIN SET NOCOUNT ON; END')
END

GO

ALTER PROCEDURE [dbo].[GetCountsForReport]
    @JobID INT
AS
BEGIN
    SET NOCOUNT ON;
        
        
        -- DEBUG
            --DECLARE @JobID INT = 14378

        -- END DEBUG
        
		-- Get Summary of Findings data
		DECLARE @SummaryOfFindingsData TABLE (SampleID INT, RegisterItemNo INT, SampleResult VARCHAR(50), SampleResultValue INT, Description VARCHAR(MAX), SummaryType VARCHAR(1000), Room VARCHAR(100), RandD BIT, Inaccessible BIT)
		
		INSERT INTO @SummaryOfFindingsData
		SELECT SampleID, RegisterItemNo, SampleResult, Value, Description, SummaryType, Room, RandD, Inaccessible FROM SummaryOfFindings WITH (NOLOCK) WHERE JobID = @JobID
		
		
		-- Get basic Sample Data.
		DECLARE @SampleData TABLE (RoomID INT, RoomInaccessible BIT, SampleID INT, SampleRef VARCHAR(50), AsSample BIT, SampleResultID INT, SampleClassificationID INT, PhysicalSampleResultValue INT)
		
		INSERT INTO @SampleData
		SELECT
			rm.RoomID,
			rm.Inaccessible,
			s.SampleID,
			s.SampleRef,
			s.AsSample,
			s.SampleResultID,
			s.SampleClassificationID,
			sr.Value [PhysicalSampleResultValue] -- NOTE: This should only be used for logic with Physical Samples.
		FROM
			JobEmployee je WITH (NOLOCK)
			INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
			INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
			INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
			LEFT JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID = sr.SampleResultID
		WHERE
			je.JobID = @JobID
		
		
		-- Get all element data up front to reduce table scans on the element table.
		-- NOTE: Only gets certain Element Types. Add more to WHERE if you need more.
		DECLARE @ElementData TABLE (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX))
		
		INSERT INTO @ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription)
		
		SELECT
			e.ElementID,
			e.SampleID,
			e.ElementTypeID,
			e.ElementText,
			e.ElementIntID,
			e.ElementIntMeaningID,
			e.ElementIntMeaningExtendedID,
			e.ElementIntMeaningSubOptionID,
			COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description)
		FROM
			@SampleData s
			INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
			LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
			LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
			LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID
		WHERE
			e.ElementTypeID IN (5, 48)
		
		
		-- Start the Main Select
		SELECT
			(
				SELECT COUNT(*) FROM @SummaryOfFindingsData
			) 'SampleCount',
			(
				SELECT COUNT(*) FROM @SampleData
			) 'AllSampleCount',
			(
				SELECT COUNT(*)
				FROM @SummaryOfFindingsData
				WHERE
					SampleResult IS NOT NULL
						AND
					SampleResult <> 'No Asbestos Detected'
			) 'PositiveSampleCount',
			(
				SELECT COUNT(*)
				FROM @SampleData
				WHERE
					ISNULL(SampleResultID, 0) > 1
						OR
					AsSample = 1
			) 'TotalPositiveSampleCount',
			(
				SELECT COUNT(SampleRef)
				FROM @SampleData
				WHERE AsSample = 0
			) 'AnalysedSampleCount',
			(
				SELECT COUNT(*)
				FROM @SampleData
				WHERE ISNULL(SampleResultID, 0) > 1
			) 'AnalysedPositiveSampleCount',
			(
				SELECT COUNT(*)
				FROM @SampleData
				WHERE ISNULL(SampleResultID, 0) > 1 AND RIGHT(SampleRef, 1) <> '*' AND SampleRef NOT LIKE '%{%'
			) 'AnalysedPositiveSampleTakenInReinspecCount',
			(
				SELECT COUNT(*)
				FROM
				    @SampleData s
				    LEFT JOIN @ElementData e48 ON s.SampleID = e48.SampleID AND e48.ElementTypeID = 48
				WHERE
				    ISNULL(SampleResultID, 0) > 1
				        AND
				    ISNULL(e48.ElementIntID, -1) <> 1
			) 'AnalysedPositiveSampleCountExcludingRemoved',
			(
			    SELECT COUNT(*)
			    FROM
			        @SampleData s
			        LEFT JOIN @ElementData e48 ON s.SampleID = e48.SampleID AND e48.ElementTypeID = 48
			    WHERE ISNULL(e48.ElementIntID, -1) = 1
			) 'RemovedSamplesCount',
			(
				SELECT COUNT(*)
				FROM
					@SampleData s
					LEFT JOIN @ElementData e5 ON s.SampleID = e5.SampleID AND e5.ElementTypeID = 5
				WHERE e5.ElementIntID = 0
			) 'InaccessibleItemsCount',
			(
				SELECT COUNT(DISTINCT RoomID)
				FROM @SampleData
				WHERE RoomInaccessible = 1
			) 'InaccessibleRoomsCount',
			(
				SELECT ISNULL(qs.NumberOfSamples, 0)
				FROM
					Job j WITH (NOLOCK)
					INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
					LEFT JOIN QuoteSurvey qs WITH (NOLOCK) ON q.QuoteID = qs.QuoteID
				WHERE j.JobID = @JobID
			) 'QuoteSamples',
            (
                SELECT COUNT(SampleRef)
                FROM @SampleData
                WHERE
                    AsSample = 0
                        AND
                    SampleRef NOT LIKE '%*%'
                        AND
                    SampleRef NOT LIKE '%{%'
            ) [AnalysisSampleCount],
            (
                SELECT COUNT(SampleRef)
                FROM @SampleData
                WHERE
                    AsSample = 0
                        AND
                    SampleRef NOT LIKE '%*%'
                        AND
                    SampleRef NOT LIKE '%{%'
                        AND
                    PhysicalSampleResultValue > 0
            ) [AnalysisSampleCountPositive],
            (
                SELECT COUNT(SampleRef)
                FROM @SampleData
                WHERE
                    AsSample = 0
                        AND
                    SampleRef NOT LIKE '%*%'
                        AND
                    SampleRef NOT LIKE '%{%'
                        AND
                    PhysicalSampleResultValue = 0
            ) [AnalysisSampleCountNegative],
            
            (
                SELECT COUNT(SampleRef)
                FROM @SampleData
                WHERE
                    AsSample = 0
                        AND
                    SampleRef LIKE '%{%'
                    
            ) [ThirdPartySampleCount]
    
    
    
    SET NOCOUNT OFF;
END
GO



IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Employee') AND name='ParityCheck') < 1
BEGIN
  ALTER TABLE [dbo].[Employee]
	ADD [ParityCheck] [varchar](50) NOT NULL
	CONSTRAINT [DF_Employee_Access]
	DEFAULT NEWID();
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PDF ') AND name='mobileTEAMSv2') < 1
BEGIN
  ALTER TABLE PDF 
	ADD [mobileTEAMSv2] [bit] NOT NULL DEFAULT ((0))
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubSubTab WHERE TabText = 'Delete Supplementary') = 0
BEGIN
	insert into TeamsV2SubSubTab (TeamsV2SubTabID, TabText, [Order], IsMvcTab, IsHidden)
	SELECT TeamsV2SubTabID, 'Delete Supplementary', 10, 1, IsHidden FROM TeamsV2SubSubTab WHERE TabText = 'Job Wizard'
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'FloorplanRerender_GetText') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[FloorplanRerender_GetText] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetText]    Script Date: 15/10/2018 21:27:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





ALTER PROC [dbo].[FloorplanRerender_GetText]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = 
      (
			SELECT 
				j.JobID 
			FROM 
				Job j WITH (NOLOCK)
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
			WHERE 
				fp.FloorplanID=@FloorplanID
      )
	  DECLARE @SurveyTypeID INT = (SELECT su.SurveyTypeID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 1 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            CASE WHEN e48.ElementIntMeaningID=121 THEN
                        0
                  ELSE
                        COALESCE(sr.Value,e8.ElementIntID,-1)
            END,
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
			e48.ElementIntMeaningID
      FROM
            job j WITH (NOLOCK)
            inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
            INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            je.JobID = @JobID
                  AND
            su.SurveyTypeID = @SurveyTypeID
	  END

	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 0 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
				s.SampleID,
				s.SampleRef,
				s.AsSample,
				COALESCE(sr.Value,e8.ElementIntID,-1),
				CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
					  1 
				ELSE
					  0 
				END,
				rm.RoomID,
				f.FloorplanID,
				e48.ElementIntMeaningID
		  FROM
				Floorplan f
				INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
				INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
				INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
				LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
				LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
				LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
				LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
				LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
		  WHERE
				f.FloorplanID=@FloorplanID
	  END
            
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            0
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=r.JobEmployeeID
            INNER JOIN Job j WITH (NOLOCK) ON j.JobID=je.JobID
      WHERE
			j.JobID=@JobID
      
      Update @SampleData
            Set 
                  SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)

      Select 
            fi.FloorplanItemID,fi.FloorplanID,fi.FloorplanAdditionalID,fi.SampleID,fi.AirSampleID,fi.RoomID,fi.Autosize,fi.BackColor,fi.BorderStyle,fi.Font,fi.ForeColor,fi.IconImage,fi.Location,fi.MaximumSize,fi.MinimumSize,fi.Padding,fi.Size,fi.Text,fi.TextAlign,fi.ZOrder,fi.Locked,fi.IsSampleRef,fi.IsRegisterItemNo,
            CASE WHEN sd.ReinspectionElementIntMeaningID = 121 THEN
                        'Removed'
            ELSE
                        CASE WHEN sd.Inaccessible > 0 THEN
                                          'Inaccessible'
                                Else
                                          CASE sd.SampleResultValue 
                                          WHEN -1 THEN 'Reference Only'
                                          WHEN 0 THEN 'Negative Asbestos'
                                          Else
                                                  CASE WHEN sd.SampleResultValue > 0 THEN
                                                            'Asbestos'
                                                  END
                        End
            END
            END [TextType]
      FROM
            FloorplanItem fi
            LEFT OUTER JOIN @SampleData sd ON sd.SampleID=fi.SampleID
      Where 
            fi.FloorplanID = @FloorplanID 
                  AND 
            fi.IconImage IS NULL 
                  AND 
            fi.IsRoomOverlay=0 
                  AND 
            fi.IsGraphic=0 
            	  AND
			fi.IsSampleOverlay=0
      Order by 
            fi.ZOrder desc
      
End


GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'FloorplanRerender_GetRooms') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[FloorplanRerender_GetRooms] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetRooms]    Script Date: 15/10/2018 21:43:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FloorplanRerender_GetRooms]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = (SELECT j.JobID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      DECLARE @SurveyTypeID INT = (SELECT su.SurveyTypeID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 1 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            CASE WHEN e48.ElementIntMeaningID=121 THEN
                        0
                  ELSE
                        COALESCE(sr.Value,e8.ElementIntID,-1)
            END,
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
			e48.ElementIntMeaningID
      FROM
            job j WITH (NOLOCK)
            inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
            INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            je.JobID = @JobID
                  AND
            su.SurveyTypeID = @SurveyTypeID
	  END

	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 0 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
				s.SampleID,
				s.SampleRef,
				s.AsSample,
				COALESCE(sr.Value,e8.ElementIntID,-1),
				CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
					  1 
				ELSE
					  0 
				END,
				rm.RoomID,
				f.FloorplanID,
				e48.ElementIntMeaningID
		  FROM
				Floorplan f
				INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
				INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
				INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
				LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
				LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
				LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
				LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
				LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
		  WHERE
				f.FloorplanID=@FloorplanID
	  END
      
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
      
      Update @SampleData
            Set SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)
      
      Select RoomID,
            CASE WHEN MAX(SampleResultValue) > 0 THEN
                  'Asbestos'
            ELSE
                  CASE WHEN MAX(Inaccessible) > 0 THEN
                        'Inaccessible'
                  ELSE
					CASE WHEN MAX(SampleResultValue) = 0 THEN
                        'Negative Asbestos'
					END
                  END
            END [OverlayType]
      FROM @SampleData
      Group By RoomID
      
End

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'FloorplanRerender_GetSampleOverlay') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[FloorplanRerender_GetSampleOverlay] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetSampleOverlay]    Script Date: 15/10/2018 21:44:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FloorplanRerender_GetSampleOverlay]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = 
      (
			SELECT 
				j.JobID 
			FROM 
				Job j WITH (NOLOCK)
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
			WHERE 
				fp.FloorplanID=@FloorplanID
      )
	  DECLARE @SurveyTypeID INT = (SELECT su.SurveyTypeID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 1 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            CASE WHEN e48.ElementIntMeaningID=121 THEN
                        0
                  ELSE
                        COALESCE(sr.Value,e8.ElementIntID,-1)
            END,
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
			e48.ElementIntMeaningID
      FROM
            job j WITH (NOLOCK)
            inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
            INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            je.JobID = @JobID
                  AND
            su.SurveyTypeID = @SurveyTypeID
	  END

	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 0 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
				s.SampleID,
				s.SampleRef,
				s.AsSample,
				COALESCE(sr.Value,e8.ElementIntID,-1),
				CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
					  1 
				ELSE
					  0 
				END,
				rm.RoomID,
				f.FloorplanID,
				e48.ElementIntMeaningID
		  FROM
				Floorplan f
				INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
				INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
				INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
				LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
				LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
				LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
				LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
				LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
		  WHERE
				f.FloorplanID=@FloorplanID
	  END
            
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            0
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
            INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=r.JobEmployeeID
            INNER JOIN Job j WITH (NOLOCK) ON j.JobID=je.JobID
      WHERE
			j.JobID=@JobID
      
      Update @SampleData
            Set 
                  SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)

      Select 
            fi.FloorplanItemID,fi.FloorplanID,fi.FloorplanAdditionalID,fi.SampleID,fi.AirSampleID,fi.RoomID,fi.Autosize,fi.BackColor,fi.BorderStyle,fi.Font,fi.ForeColor,fi.IconImage,fi.Location,fi.MaximumSize,fi.MinimumSize,fi.Padding,fi.Size,fi.Text,fi.TextAlign,fi.ZOrder,fi.Locked,fi.IsSampleRef,fi.IsRegisterItemNo,fi.PolygonPath,
            CASE WHEN sd.ReinspectionElementIntMeaningID = 121 THEN
                        'Removed'
            ELSE
                        CASE WHEN sd.Inaccessible > 0 THEN
                                          'Inaccessible'
                                Else
                                          CASE sd.SampleResultValue 
                                          WHEN -1 THEN 'Reference Only'
                                          WHEN 0 THEN 'Negative Asbestos'
                                          Else
                                                  CASE WHEN sd.SampleResultValue > 0 THEN
                                                            'Asbestos'
                                                  END
                        End
            END
            END [OverlayType]
      FROM
            FloorplanItem fi
            LEFT OUTER JOIN @SampleData sd ON sd.SampleID=fi.SampleID
      Where 
            fi.FloorplanID = @FloorplanID 
                  AND 
            fi.IconImage IS NULL 
                  AND 
            fi.IsRoomOverlay=0 
                  AND 
            fi.IsGraphic=0 
				AND
			fi.IsSampleOverlay=1
      Order by 
            fi.ZOrder desc
      
End


GO

INSERT INTO LegionellaAssetcategory (LegionellaAssetcategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 12,'Cooling Tower','Cooling Tower','CT',2,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=12)=0
DECLARE @TemplateType VARCHAR(MAX) = 'Monthly Cooling Towers'
DECLARE @ReportFooterString VARCHAR(MAX) = 'Report -'
DECLARE @QuoteTypeID INT = 257
DECLARE @TemplateTypeID [int] = 415
DECLARE @QuoteVisitTypeID [int] = 4
DECLARE @LegionellaTypeID [int] = 18
DECLARE @LegionellaFrequencyCategoryID INT = 3
DECLARE @LegionellaAssetCategoryID INT = 12
DECLARE @AppointmentTypeID INT = 9
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Quote - Legionella ' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into QuoteType (QuoteTypeID,TemplateTypeID,QuoteType,InvoiceQuoteType,Deleted,AppointmentTypeId,QuoteVisitTypeID) Select @QuoteTypeID,@TemplateTypeID,@TemplateType,@TemplateType,GETDATE(),@AppointmentTypeID,@QuoteVisitTypeID WHERE (SELECT COUNT(*) FROM QuoteType WHERE QuoteTypeID=@QuoteTypeID)=0
Set @TemplateTypeID = @TemplateTypeID+1
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Legionella ' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into LegionellaType (LegionellaTypeID,Description,TemplateTypeID,LegionellaFrequencyCategoryID,LegionellaAssetCategoryID,LegionellaMonitoring,Deleted) Select @LegionellaTypeID,@TemplateType,@TemplateTypeID,@LegionellaFrequencyCategoryID,@LegionellaAssetCategoryID,1,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaType WHERE LegionellaTypeID=@LegionellaTypeID)=0
SET @TemplateTypeID = @TemplateTypeID+1
SET @QuoteTypeID = @QuoteTypeID+1
SET @TemplateType = '6 Month Cooling Towers'
SET @LegionellaTypeID = @LegionellaTypeID+1
SET @LegionellaFrequencyCategoryID = 7
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Quote - Legionella ' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into QuoteType (QuoteTypeID,TemplateTypeID,QuoteType,InvoiceQuoteType,Deleted,AppointmentTypeId,QuoteVisitTypeID) Select @QuoteTypeID,@TemplateTypeID,@TemplateType,@TemplateType,GETDATE(),@AppointmentTypeID,@QuoteVisitTypeID WHERE (SELECT COUNT(*) FROM QuoteType WHERE QuoteTypeID=@QuoteTypeID)=0
Set @TemplateTypeID = @TemplateTypeID+1
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Legionella ' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into LegionellaType (LegionellaTypeID,Description,TemplateTypeID,LegionellaFrequencyCategoryID,LegionellaAssetCategoryID,LegionellaMonitoring,Deleted) Select @LegionellaTypeID,@TemplateType,@TemplateTypeID,@LegionellaFrequencyCategoryID,@LegionellaAssetCategoryID,1,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaType WHERE LegionellaTypeID=@LegionellaTypeID)=0

GO

IF (SELECT COUNT(*) FROM CustomReport WHERE Report = 'mobileTEAMS Override') < 1
BEGIN
	INSERT INTO CustomReport (Report, ProcedureName, Notes, DateCreated, SubTabName, ManagerOnly) VALUES ('mobileTEAMS Override', 'TEAMS_Report_GenerateOverrideCode', 'Using this tool will generate today''s override code for use with updating mobileTEAMS on tablets. PLEASE NOTE: using this code on the tablet and updating will remove all TEAMS data from the tablet. Any data that has not been transferred to the office, may be lost.', GETDATE(), 'TEAMS', 1)
END
GO

UPDATE CustomReport SET SubTabName = 'TEAMS' WHERE Report = 'mobileTEAMS Override'

IF (SELECT COUNT(*) FROM CustomReport WHERE Report = 'Clear GDPR Data') < 1
BEGIN
	INSERT INTO CustomReport (Report, ProcedureName, Notes, DateCreated, SubTabName, ManagerOnly) VALUES ('Clear GDPR Data', 'TEAMS_Report_ClearGDPRData', 'Using this tool will remove the "Telephone", "Contact" and "Email" details from any Sites linked to any Jobs done within the specified date range for the specified client.', GETDATE(), 'TEAMS', 1)
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Report_ClearGDPRData') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_Report_ClearGDPRData] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_Report_ClearGDPRData]    Script Date: 22/10/2018 15:56:17 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER PROC [dbo].[TEAMS_Report_ClearGDPRData]
    @StartDate DATETIME,
    @EndDate DATETIME,
	@SessionEmployeeID INT = 0,
	@Client INT = 0,
	@ReplaceWith VARCHAR(MAX) = ''
AS
BEGIN
SET NOCOUNT ON;
SET ANSI_WARNINGS OFF;

-- Set default variable values if not passed in.
SELECT
    @StartDate = ISNULL(@StartDate, '01/01/2008'),
    @EndDate = ISNULL(@EndDate, GETDATE())

-- Cast DATETIME to DATE. Add one day to the FinishDate - this will set @EndDate as the next day but it will be at midnight.
SET @StartDate  = CAST(@StartDate AS DATE)
SET @EndDate = DATEADD(d, 1, CAST(@EndDate AS DATE))

-- Get a list of jobs within the specified date range
DECLARE @JobSiteData TABLE (IndexID INT IDENTITY(1,1) PRIMARY KEY, JobID INT, JobNo INT, SiteID INT)

INSERT INTO @JobSiteData
SELECT DISTINCT
    j.JobID,
    j.JobNo,
    j.SiteID
FROM
    Job j WITH (NOLOCK)
WHERE
    j.Approved IS NOT NULL
        AND
    (j.Created >= @StartDate AND j.Created < @EndDate)
		AND
	(
		(
			@Client > 0
				AND
			j.ClientID = @Client
		)
			OR
		(
			@Client = 0
		)
	)

-- Get the sites for the above jobs
DECLARE @SiteData TABLE (IndexID INT IDENTITY(1,1) PRIMARY KEY, SiteID INT, Address VARCHAR(MAX), Postcode VARCHAR(MAX), Telephone VARCHAR(MAX), Contact VARCHAR(MAX), Email VARCHAR(MAX))

INSERT INTO @SiteData
SELECT DISTINCT
	jsd.SiteID,
	si.Address,
	si.Postcode,
	si.Telephone,
	si.Contact,
	si.SiteEmail
FROM
	@JobSiteData jsd
	INNER JOIN Site si WITH (NOLOCK) ON jsd.SiteID = si.SiteID
WHERE
	si.Telephone != ''
		OR
	si.Contact != ''
		OR
	(si.SiteEmail != '' AND si.SiteEmail IS NOT NULL)

-- Get the emaployee that ran the custom report
--DECLARE @employeeID int = (SELECT TOP 1 EmployeeID FROM IntranetAuditTrail WHERE Message LIKE '%Custom report started. TEAMS_Report_GenerateOverrideCode%' AND DataTable = 'CustomReport' ORDER BY DateCreated DESC)

-- Loop through the above sites and blank the Telephone and Contact
DECLARE
	@i INT = 0,
	@siteCount INT = (SELECT COUNT(*) FROM @SiteData),
	@siteID INT = 0

WHILE @i < @siteCount
BEGIN
	SELECT
		@i = @i +1

	SELECT @siteID = (SELECT SiteID FROM @SiteData WHERE IndexID = @i)

	UPDATE Site SET Telephone = @ReplaceWith, Contact = @ReplaceWith, SiteEmail = @ReplaceWith WHERE SiteID = @siteID

	INSERT INTO IntranetAuditTrail (Category, EmployeeID, Message, DataTable, DataID, DataScript, DataQueryString, DataIPAddress, DateCreated) VALUES (5, @SessionEmployeeID, 'Site Telephone, Contact, Email removed using the "Clear GDPR Data Custom Report"', 'Site', @siteID, '', '', '', GETDATE())
END

-- Final Select
--SELECT * FROM @JobSiteData
--SELECT
--	sd.Address [Address],
--	sd.Postcode [Postcode],
--	sd.Telephone [Old Telephone],
--	sd.Contact [Old Contact],
--	ISNULL(sd.Email, '') [Old Email],
--	si.Telephone [New Telephone],
--	si.Contact [New Contact],
--	ISNULL(si.SiteEmail, '') [New Email]
--FROM
--	@SiteData sd
--	INNER JOIN Site si WITH (NOLOCK) ON sd.SiteID = si.SiteID
--SELECT TOP 10 * FROM IntranetAuditTrail WHERE DataTable = 'Site' ORDER BY DateCreated DESC

SELECT
	'Data successfully cleared.' [Message]

SET ANSI_WARNINGS ON;
SET NOCOUNT OFF;
END

GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Report_GenerateOverrideCode') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_Report_GenerateOverrideCode] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[TEAMS_Report_GenerateOverrideCode]    Script Date: 22/10/2018 15:57:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROC [dbo].[TEAMS_Report_GenerateOverrideCode]
	
AS
BEGIN
SET NOCOUNT ON;

DECLARE 
	@Code TABLE (Code VARCHAR(5))

INSERT INTO @Code (Code)
EXEC mobile_DTSOverrideCode

SELECT 
	[Message] =		'WARNING: Please before using the code ensure that the tablet has been checked for data in progress, if you need help doing this please contact TEAMS',
	[Code] =		c.Code
FROM
	@Code c

SET NOCOUNT OFF;
END

GO


IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='s__EmailPort') < 1
BEGIN
  ALTER TABLE Config
      ADD s__EmailPort INT NOT NULL DEFAULT 25
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'AirTestDataCollectionQuestionPhotos') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 R2 (10.50.4000)
    Source Database Engine Edition : Microsoft SQL Server Express Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008 R2
    Target Database Engine Edition : Microsoft SQL Server Express Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[AirTestDataCollectionQuestionPhotos]    Script Date: 26/10/2018 13:51:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[AirTestDataCollectionQuestionPhotos]
      @AirTestID INT,
	  @IncludeAutoInsert BIT = 1,
	  @IncludePhotoEntry BIT = 1
AS
BEGIN
      
    SET NOCOUNT ON

	SELECT
		results.Type,
		ImageSize,
		PhotoID,
		PhotoReplaceVariable,
		PhotoReplaceVariableNoAutoInsert,
	    Caption,
	    CaptionReplaceVariable,
	    CaptionReplaceVariableNoAutoInsert,
	    TimeStamp,
	    TimeStampVariable,
	    TimeStampReplaceNoAutoInsert
	FROM
	(
		SELECT 
			main.[Type],
            ' width="' + CAST(mcWidth.[MobileConfigInt] as varchar) + '" height="' + CAST(mcHeight.[MobileConfigInt] as varchar) + '"' [ImageSize],
            main.PhotoID,
            main.PhotoReplaceVariable,
			main.PhotoReplaceVariableNoAutoInsert,
            main.Caption,
            main.CaptionReplaceVariable,
			main.CaptionReplaceVariableNoAutoInsert,
            main.TimeStamp,
            main.TimeStampVariable,
			main.TimeStampReplaceNoAutoInsert,
			main.AutoInsert,
			main.[Order]

		FROM
		(
			SELECT
				'PhotoEntry' [Type], ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by i.InspectionID) [Order], p.PhotoID [PhotoID], 0 [SELNO], 
				'[AirTestQuestionPhotoID:' + CAST(p.PhotoID as varchar) + ']' [PhotoReplaceVariable], '' [PhotoReplaceVariableNoAutoInsert], 'N/A' [Caption], '' [CaptionReplaceVariable], '' [CaptionReplaceVariableNoAutoInsert], '' [TimeStamp],'' [TimeStampVariable], '' [TimeStampReplaceNoAutoInsert], 0 [AutoInsert]
			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.EntryType='PhotoEntry'
				INNER JOIN Photo p ON i.InspectionInt = p.PhotoID

			WHERE
				i.AirTestID = @AirTestID
					AND
				@IncludePhotoEntry = 1

            UNION

			SELECT
				'PhotoCollection' [Type], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [Order], 
				p.PhotoID [PhotoID], 
				ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) [SELNO], 
				REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariable], 
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,']]',']:NOAUTOINSERT]') + '','[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))) [PhotoReplaceVariableNoAutoInsert], 
				IsNull(pc.Caption,'N/A') [Caption], 
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION]') [CaptionReplaceVariable],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_CAPTION:NOAUTOINSERT]') [CaptionReplaceVariableNoAutoInsert],
				CONVERT(varchar,pc.Created,IsNull((Select MobileConfigInt FROM MobileConfig Where MobileConfigTypeID=88),103)) [TimeStamp],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME]') [TimeStampVariable],
				REPLACE(REPLACE(adcq.PhotoCollectionReplaceVariable,'[SELNO]',(CAST(ROW_NUMBER() OVER (Partition By adcq.AirTestDataCollectionQuestionID Order by pc.IncludeInPDF) as varchar))),']','_DATETIME:NOAUTOINSERT]') [TimeStampReplaceNoAutoInsert],
				pc.AutoInsert

			FROM
				Inspection i
				INNER JOIN AirTestDataCollectionQuestion adcq ON i.InspectionLabelID = adcq.InspectionLabelID AND adcq.PhotoCollection IS NOT NULL
				INNER JOIN PhotoCollection pc ON i.InspectionID = pc.InspectionID AND pc.IncludeInPDF IS NOT NULL
				INNER JOIN Photo p ON p.PhotoID=pc.PhotoID

			WHERE
				i.AirTestID = @AirTestID
					AND
				pc.Deleted IS NULL
		) main
		LEFT OUTER JOIN MobileConfig mcWidth WITH (NOLOCK) ON mcWidth.MobileConfigText='Width' AND mcWidth.MobileConfigTypeID=96
        LEFT OUTER JOIN MobileConfig mcHeight WITH (NOLOCK) ON mcHeight.MobileConfigText='Height' AND mcHeight.MobileConfigTypeID=96
	) results

	WHERE
		CASE
			WHEN @IncludeAutoInsert = 1
			THEN 1
			ELSE
				CASE
					WHEN AutoInsert = 1
					THEN 0
					ELSE 1
				END
			END = 1

	Order By
		results.[Order]

      SET NOCOUNT OFF
      
END
GO




IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Export_QuoteHistory') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Export_QuoteHistory] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Export_QuoteHistory]    Script Date: 31/10/2018 09:40:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Export_QuoteHistory]
      @internal_ClientID INT = 0,
      @internal_SiteID INT = 0,
      @internal_ProjectID INT = 0,
      @internal_QuoteHistoryFilterAssignedTo INT = 0,
      @internal_QuoteHistoryFilterQuoteType INT = 0,
      @internal_QuoteHistoryFilterHideInstaquote INT = 0,
      @internal_QuoteHistoryFilterQuoteEnquiry VARCHAR(10) = '',
      @internal_QuoteID INT = 0,
      @internal_EnquiryID INT = 0,
      @internal_FilterStartDate DATETIME = NULL,
      @internal_FilterEndDate DATETIME = NULL,
      @internal_Filter VARCHAR(MAX) = ''
      
/*********************************************************************************************************
** Overview: Wraps Paged_QuoteHistory for export purposes   
**
** NOTE - Please make sure this proc and Paged_QuoteHistory are synced at all times
**********************************************************************************************************
**    Change History
**********************************************************************************************************
**    Rev               Date              Author                  Details
**    ---               ----------        ----------        -------------------
**    INITIAL           16/10/2015        STodd             Created
**    FIX               04/04/2016        Joe               Completely wrong implementation of an sp wrap!
**    FIX               17/05/2016        Lonny             Added Quote/Enquiry filter
**********************************************************************************************************/
      
AS
BEGIN

	SET NOCOUNT ON;

    DECLARE @data TABLE  (
		[Row_Total] INT
        , Pages INT
        , Page INT
        , Row_Num INT
        , ItemId INT
        , Itemtype VARCHAR(10)
        , ItemNo INT
        , QuoteTypeID INT
        , QuoteType VARCHAR(MAX)
        , Value MONEY
        , Created DATETIME
        , [Status] VARCHAR(MAX)
        , LastNoteCreated DATETIME
        , ClientId INT
        , Client VARCHAR(MAX)
        , ProjectID INT
        , Project VARCHAR(MAX)
        , SiteID INT
        , [Site] VARCHAR(MAX)
        , [Address] VARCHAR(MAX)
        , Postcode VARCHAR(50)
        , Accepted DATETIME
        , Rejected DATETIME
        , IsInstaQuote BIT
        , AssignedEmployeeID INT
        , StatusText VARCHAR(MAX)
        , isNew BIT
        , DateActioned DATETIME
        , HasPDF BIT
        , [File] VARCHAR(50)
        , JobID INT
        , [Source] VarChar(MAX)
        , [Source Origin] VarChar(MAX)
		, [UseMethodStatement] BIT
        , [HasNotes] BIT
        , [NotesInLastHour] BIT
		, [Assigned To] VarChar(MAX)
		, CurrencyID INT
    )

    INSERT INTO @data (
		[Row_Total]
        , Pages
        , Page
        , Row_Num
        , ItemId
        , Itemtype
        , ItemNo 
        , QuoteTypeID
        , QuoteType 
        , Value 
        , Created 
        , [Status]
        , LastNoteCreated 
        , ClientId 
        , Client
        , ProjectID 
        , Project 
        , SiteID 
        , [Site] 
        , [Address] 
        , Postcode 
        , Accepted 
        , Rejected 
        , IsInstaQuote
        , AssignedEmployeeID 
        , StatusText 
        , isNew 
        , DateActioned 
        , HasPDF 
        , [File]
        , JobID
		, [Source]
		, [Source Origin]
		, [UseMethodStatement]
        , [HasNotes]
        , [NotesInLastHour]
		, [Assigned To]
		, CurrencyID
    )
    EXEC Paged_QuoteHistory @PerPage=0, @CurrentPage=0
		, @ClientID=@internal_ClientID, @SiteID=@internal_SiteID, @ProjectID=@internal_ProjectID
		, @QuoteHistoryFilterAssignedTo=@internal_QuoteHistoryFilterAssignedTo
		, @QuoteHistoryFilterQuoteType=@internal_QuoteHistoryFilterQuoteType
		, @QuoteHistoryFilterHideInstaquote=@internal_QuoteHistoryFilterHideInstaquote
		, @QuoteHistoryFilterQuoteEnquiry=@internal_QuoteHistoryFilterQuoteEnquiry
		, @QuoteID=@internal_QuoteID, @EnquiryID=@internal_EnquiryID
		, @FilterStartDate=@internal_FilterStartDate, @FilterEndDate=@internal_FilterEndDate
		, @Filter=@internal_Filter
            
    SELECT 
		QuoteType
		, Client
		, Project
		, [Site]
		, dbo.FormatTeamsReference(ItemType, ItemNo) AS Number
		, [Value]
		, [Source]
		, [Source Origin]
		, CASE WHEN Created IS NOT NULL THEN dbo.FormatTeamsDate(Created, 1) END AS Created
		, [Status] AS Notes
		, CASE
			WHEN NOT Rejected IS NULL AND ItemType = 'Q' Then 'Rejected'
			WHEN NOT Rejected IS NULL AND NOT ItemType = 'Q' Then 'Discarded'
			WHEN Rejected IS NULL AND ItemType = 'Q' Then 'Accepted.' + CASE WHEN JobID IS NULL THEN ' Unscheduled' ELSE ' Work scheduled' END
			WHEN Rejected IS NULL AND NOT ItemType = 'Q' Then 'Quoted'
			END AS [Status]
		, [Assigned To]
    FROM
        @data
            
    SET NOCOUNT OFF;

END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoicesInProgress') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoicesInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoicesInProgress]    Script Date: 31/10/2018 11:15:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_InvoicesInProgress]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
	@SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
    @InvoiceID INT = 0,
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0,
    @Filter VARCHAR(MAX) = '' -- Text entered in search box (part of address, postcode etc.)
/**********************************************************************
** Overview: Get the data for the Invoices In Progress tab. Replaces the InvoicesInProgress view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceNo = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice In Progress data - just the minimum ammount of data for speed.
    DECLARE @InvoicesInProgressData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoicesInProgressData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                i.DateCompleted IS NULL
                    AND
                i.DateDiscarded IS NULL
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
                    AND
				(@SiteID = 0 OR ii.SiteID = @SiteID)
					AND
                i.DateCreated BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoicesInProgressData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoicesInProgressData
           ) a
    )   
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        i.LastNoteCreated,
        CAST(CASE WHEN i.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN i.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN i.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        CASE WHEN oi.InvoiceNo IS NOT NULL
            THEN dbo.FormatTeamsReference('I', oi.InvoiceNo)
            ELSE NULL
        END [OrigInvoiceNo],
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO



IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoiceHistory') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoiceHistory] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoiceHistory]    Script Date: 31/10/2018 11:16:19 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[Paged_InvoiceHistory]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
    @InvoiceID INT = 0,
	@InvoiceState INT = 0,
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0,
    @Filter VARCHAR(MAX) = '' -- Text entered in search box (part of address, postcode etc.)
/**********************************************************************
** Overview: Get the data for the Invoice History tab. Replaces the InvoiceHistory view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice History data - just the minimum ammount of data for speed.
    DECLARE @InvoiceHistoryData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoiceHistoryData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                (
                    i.DateCompleted IS NOT NULL
                        OR
                    i.DateDiscarded IS NOT NULL
                )
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
					AND
				(
					CASE WHEN @SiteID = 0 THEN
						1
					ELSE
						CASE WHEN @SiteID IN (Select SiteID FROM InvoiceItems Where InvoiceID=i.InvoiceID) THEN
							1
						ELSE
							0
						END
					END = 1				
				)
                    AND
                i.InvoiceDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
					(@InvoiceState = 0)
						OR
					(@InvoiceState = 1 AND i.DateDiscarded IS NULL)
						OR
					(@InvoiceState = 2 AND i.DateDiscarded IS NOT NULL)
				)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC,
	i.InvoiceNo DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoiceHistoryData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoiceHistoryData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        i.DateCompleted,
        i.DateDiscarded,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        lnc.DateCreated [LastNoteCreated],
        CAST(CASE WHEN lnc.DateCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN lnc.DateCreated IS NOT NULL
                THEN
                    CASE WHEN lnc.DateCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        i.OriginalInvoiceID,
        CAST(CASE WHEN EXISTS(SELECT 1 FROM Invoice _i WITH (NOLOCK) WHERE _i.OriginalInvoiceID = i.InvoiceID AND _i.DateDiscarded IS NULL) THEN 1 ELSE 0 END AS BIT) [HasAdditionalInvoices],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.InvoiceID = i.InvoiceID
                    AND
                _pf.DateDeleted IS NULL
            ORDER BY
                _pf.DateCreated DESC
        ) [FileName],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
        OUTER APPLY
        (
            SELECT MAX(n.DateCreated) [DateCreated]
            FROM Note n WITH (NOLOCK)
            WHERE
                n.NoteTypeID = 4 -- Invoice
                    AND
                n.ItemID = i.InvoiceID
        ) lnc -- Last Note Created
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END
GO

DECLARE @ReportFooterString VARCHAR(MAX) = 'Report -'
DECLARE @TemplateTypeID [int] = 419
DECLARE @QuoteVisitTypeID [int] = 2
DECLARE @AirTestTypeID [int] = 210
DECLARE @TemplateType VARCHAR(MAX) = 'Dynamic type (210)'
DECLARE @AppointmentTypeID INT = 3
DECLARE @AirMonitoringRowAdjustment INT = (Select MAX(AirMonitoringRowAdjustment) FROM AirTestType)

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test ' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

SET @TemplateTypeID = @TemplateTypeID+1
SET @TemplateType = 'Dynamic type (211)'
SET @AirTestTypeID = @AirTestTypeID+1

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test -' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

SET @TemplateTypeID = @TemplateTypeID+1
SET @TemplateType = 'Dynamic type (212)'
SET @AirTestTypeID = @AirTestTypeID+1

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test -' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

SET @TemplateTypeID = @TemplateTypeID+1
SET @TemplateType = 'Dynamic type (213)'
SET @AirTestTypeID = @AirTestTypeID+1

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test -' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

SET @TemplateTypeID = @TemplateTypeID+1
SET @TemplateType = 'Dynamic type (214)'
SET @AirTestTypeID = @AirTestTypeID+1

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test -' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

SET @TemplateTypeID = @TemplateTypeID+1
SET @TemplateType = 'Dynamic type (215)'
SET @AirTestTypeID = @AirTestTypeID+1

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select @TemplateTypeID,'Report - Air Test -' + @TemplateType,(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%' + @ReportFooterString + '%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=@TemplateTypeID)=0
Insert into AirTestType (AirTestTypeID,Description,TemplateTypeID,Deleted,DynamicContent,BackColorARGB,AirMonitoringRowAdjustment) Select @AirTestTypeID,@TemplateType,@TemplateTypeID,GETDATE(),1,'255,175,175,175',@AirMonitoringRowAdjustment WHERE (Select COUNT(*) FROM AirTestType Where AirTestTypeID=@AirTestTypeID)=0

GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='FloorplanDesignerItem'))
	BEGIN
		CREATE TABLE [dbo].[FloorplanDesignerItem](
			[FloorplanDesignerItemID] [int] IDENTITY(1,1) NOT NULL,
			[FloorplanID] [int] NULL,
			[FloorplanItemID] [int] NULL,
			[JsonObject] [varchar](max) NULL,
			[Created] [datetime] NOT NULL CONSTRAINT [DF_FloorplanDesignerItem_Created]  DEFAULT (getdate()),
		 CONSTRAINT [PK_FloorplanDesignerItem_FloorplanDesignerItemID] PRIMARY KEY CLUSTERED 
		(
			[FloorplanDesignerItemID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS') < 1
BEGIN
	INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order], UsesMvcSubTabs) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'mobileTEAMS', 10, 1)
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Mobile Unit Summary') < 1
BEGIN
	INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order]) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS'), 'Mobile Unit Summary', 1)
END
GO

UPDATE TeamsV2SubTab SET EnableMvcGrid = 1 WHERE TabText = 'Mobile Unit Summary'
GO

ALTER PROCEDURE [dbo].[Paged_ProjectJobSheet]
	@PerPage INT = 15
	, @CurrentPage INT = 1
	, @ClientID INT = NULL
	, @ProjectGroupID INT = NULL
	, @ProjectID INT = NULL
	, @SiteID INT = NULL
	, @Status VARCHAR(24) = ''
	, @Other VARCHAR(MAX) = ''
	, @Address VARCHAR(200) = ''
	, @PhoneCalls INT = NULL
	, @Letters INT = NULL,
	@NoAccessAttempts INT = NULL
/**********************************************************************
** Overview: Get data for the View Project JobSheet tab - procedurised
**		to improve performance over previous code + add paging capability
**
** PLEASE NOTE: The Change Log has now been removed as this has been added to SQL SVN instead.
** Please use the latest version from SVN before making changes. Commit the changes when done.
**********************************************************************/
AS
SET ANSI_WARNINGS OFF
BEGIN
    SET NOCOUNT ON;
    
	-- tidy input variables
	SELECT @ClientID = NULLIF(@ClientID, 0)
	SELECT @ProjectGroupID = NULLIF(@ProjectGroupID, 0)
	SELECT @ProjectID = NULLIF(@ProjectID, 0)
	SELECT @SiteID = NULLIF(@SiteID, 0)
	SELECT @Status = NULLIF(@Status, '')
	SELECT @Other = NULLIF(@Other, '')
	SELECT @Address = NULLIF(@Address, '')
	SELECT @PhoneCalls = NULLIF(@PhoneCalls, 0)
	SELECT @Letters = NULLIF(@Letters, 0)
	SELECT @NoAccessAttempts = NULLIF(@NoAccessAttempts, 0)

	-- ensure we have at least 1 filter ID (don't want to kill the server!)
	IF (@ClientID IS NULL) AND (@ProjectGroupID IS NULL) AND (@ProjectID IS NULL) AND (@SiteID IS NULL) BEGIN
		RAISERROR('No ID values passed to GetProjectJobSheet', 16, 1)
		RETURN
	END
	
	-- get ProjectIDs into a table to join to, based on @ProjectGroupID AND @ProjectID inputs
	CREATE TABLE #ProjectIDs (ProjectID INT)
	IF @ProjectID IS NOT NULL BEGIN
	
		INSERT
			#ProjectIDs
		SELECT
			@ProjectID
			
	END ELSE BEGIN
		
		INSERT
			#ProjectIDs
		SELECT
			ProjectID
		FROM
			Project
		WHERE
			ProjectGroupId = @ProjectGroupID
	END
	
	-- change #ProjectIDs into a comma separated string of IDs 
	DECLARE @ProjectIDsString VARCHAR(MAX)
	SELECT @ProjectIDsString = STUFF 
	((
		SELECT ',' + CONVERT(VARCHAR(20), ProjectID)
		FROM #ProjectIDs
		FOR XML PATH('')
	), 1, 1, '')
	
	-- select from existing ProjectJobSheet view into a temp table
	CREATE TABLE #JobSheetData (
		JobSheetDataID INT IDENTITY (1,1) NOT NULL
		, AppointmentID INT NULL
		, JobId INT NULL
		, SurveyTypeId INT NULL
		, ClientId INT NULL
		, ProjectId INT NULL
		, SiteId INT NULL
		, SurveyCompleted INT NULL
		, SurveyStillDue INT NULL
		, Approved INT NULL
		, SurveyOnTime INT NULL
		, SurveyOverTime INT NULL
		, Unscheduled INT NULL
		, SurveyCompletedRaw NVARCHAR(40) NULL
		, DueDateRaw NVARCHAR(40) NULL
		, ApprovedRaw NVARCHAR(40) NULL
		, SortOrder INT NOT NULL
		, Samples INT NULL
		, SampleResults INT NULL
		, [Status] VARCHAR(24)
		, Other VARCHAR(MAX)
		, [Address] VARCHAR(200)
		, PhoneCalls INT NULL
		, Letters INT NULL
		, NoAccessAttempts INT NULL
		, StatusFilterTypeID INT NULL
		, StatusFilterType VARCHAR(MAX) NULL
	)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)
	SELECT @DynamicSQL = 'INSERT
		#JobSheetData
	SELECT
		pjs.AppointmentID
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyCompleted
		, CASE WHEN pjs.[Status] = ''Unscheduled'' OR SortOrder = 3 THEN 0 ELSE 1 END AS SurveyStillDue
		, CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS Approved
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) <= 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOnTime
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) > 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOverTime
		, CASE WHEN pjs.[Status] = ''Unscheduled'' AND SortOrder <> 3 THEN 1 ELSE 0 END AS Unscheduled
		, SurveyCompleted
		, DueDate
		, Approved
		, SortOrder
		, Samples
		, SampleResults
		, pjs.[Status]
		, pjs.Other
		, pjs.[Address]
		, [PhoneCalls]
		, [Letters]
		, pjs.NoAccessAttempts
		, s.StatusFilterTypeID
		, sft.[Status] As StatusFilterType
	FROM
		ProjectJobSheet pjs
		LEFT JOIN Site s ON pjs.SiteId = s.SiteID
		LEFT JOIN StatusFilterType sft ON s.StatusFilterTypeID = sft.StatusFilterTypeID
	WHERE
		pjs.ProjectID IN (' + @ProjectIDsString + ') '

	-- add default order by
	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY SortOrder, JobNo, Address'

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- ClientID filter (not applied to view above as extra view filters slow performance)
	IF @ClientID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE ClientID <> @ClientID
	END
	
	-- SiteID filter (not applied to view above as extra view filters slow performance)
	IF @SiteID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE SiteID <> @SiteID
	END

	-- @PhoneCalls filter (not applied to view above as extra view filters slow performance)
	IF @PhoneCalls IS NOT NULL BEGIN
		
		IF @PhoneCalls > 3 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls < 4
		END

		IF @PhoneCalls < 4 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls <> @PhoneCalls
		END
	END

	-- @Letters filter (not applied to view above as extra view filters slow performance)
	IF @Letters IS NOT NULL BEGIN

		IF @Letters > 3 BEGIN
			DELETE FROM #JobSheetData WHERE Letters < 4
		END

		IF @Letters < 4 BEGIN
			DELETE FROM #JobSheetData WHERE Letters <> @Letters
		END
	END
	
	-- @NoAccessAttempts filter (not applied to view above as extra view filters slow performance)
	IF @NoAccessAttempts IS NOT NULL BEGIN

		IF @NoAccessAttempts > 3 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts < 4
		END

		IF @NoAccessAttempts < 4 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts <> @NoAccessAttempts
		END
	END

	-- calculate useful totals
    DECLARE @SurveysCompleted INT
    DECLARE @SurveysStillDue INT
    DECLARE @Approved INT
    DECLARE @SurveysOnTime INT
    DECLARE @SurveysOverTime INT
    DECLARE @UnScheduled INT
    DECLARE @KPI DECIMAL(12,2)
    DECLARE @TotalJobs_HasSampleResults INT
    DECLARE @Approved_HasSampleResults INT
    DECLARE @TotalRows INT
    
	SELECT
		@SurveysCompleted = ISNULL(SUM(SurveyCompleted), 0)
		, @SurveysStillDue = ISNULL(SUM(SurveyStillDue), 0) - ISNULL(SUM(SurveyCompleted), 0)
		, @Approved = ISNULL(SUM(Approved), 0)
		, @SurveysOnTime = ISNULL(SUM(SurveyOnTime), 0)
		, @SurveysOverTime = ISNULL(SUM(SurveyOverTime), 0)
		, @UnScheduled = ISNULL(SUM(UnScheduled), 0)
		, @KPI = ISNULL(CASE WHEN COUNT(SurveyCompletedRaw) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN DueDateRaw > SurveyCompletedRaw AND SortOrder <> 3 THEN 1 ELSE 0 END)
					/ CONVERT(FLOAT,COUNT(SurveyCompletedRaw)), 3) * 100 END, 0)
		, @TotalRows = COUNT(1)
	FROM 
		#JobSheetData
		
	SELECT
		@TotalJobs_HasSampleResults = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' OR SortOrder = 3 THEN 0 ELSE 1 END), 0) 
		, @Approved_HasSampleResults = ISNULL(SUM(CASE WHEN NOT ApprovedRaw IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
	FROM 
		#JobSheetData
	WHERE
		Samples > 0
		AND Samples = SampleResults
	
	-- return paged raw data to front end
	-- NOTE - @Status, @Other and @Address filters only filter this data, not the count data
	;WITH Paging AS 
    ( 
       SELECT 
           CAST(CEILING(COUNT(*) OVER(PARTITION BY '') * 1.00 / @PerPage) AS INT) AS Pages
           , ((ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) - 1) / @PerPage) + 1 AS Page
           , ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) AS Row_Num
           , *
       FROM 
       (
			SELECT * FROM #JobSheetData jsd
			WHERE
				( (jsd.[Status] = @Status) OR (jsd.[StatusFilterType] = @Status) OR (@Status IS NULL) )
				AND ( (jsd.Other = @Other) OR (@Other IS NULL) )
				AND ( (jsd.[Address] = @Address) OR (@Address IS NULL) )
	   ) a
    )	
	SELECT  
		main.Pages
		, main.Page
		, main.Row_Num
		, pjs.SortOrder
		, pjs.AppointmentID
		, pjs.[Status]
		, pjs.StatusDate
		, pjs.JobNo
		, pjs.[Address]
		, pjs.Postcode
		, pjs.Contact
		, pjs.Telephone
		, pjs.SiteEmail
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.AppointmentDate
		, pjs.DateSiteWorkComplete
		, pjs.AnalysisComplete
		, pjs.TotalJobs
		, pjs.WorkScheduled
		, pjs.SiteWorkComplete
		, pjs.Samples
		, pjs.SampleResults
		, pjs.[FileName]
		, pjs.ClientOrderNo
		, pjs.DateReceived
		, pjs.UPRN
		, pjs.SurveyType
		, pjs.Surveyor
		, pjs.SurveyStart
		, pjs.SurveyCompleted
		, pjs.AnalysisCompleted
		, pjs.Approved
		, pjs.ApprovedBy
		, pjs.DueDate
		, pjs.NoAccessAttempts
		, pjs.PhoneCalls
		, pjs.Letters
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 1
				FOR XML PATH('')
			), 1, 1, '')) AS PhoneCallSiteContactIDs
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 2
				FOR XML PATH('')
			), 1, 1, '')) AS LetterSiteContactIDs
		, pjs.GroupName
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, pjs.Other
		, pjspa.ProjectAppointmentID
		, pjs.LastNoAccessDate
		, pjs.LastJobEmployeeDate
		, pjs.QuoteId
		, pjs.QuoteDate
		, pjs.InvoiceDate
		, main.StatusFilterTypeID
		, main.StatusFilterType
    FROM 
		Paging main
		INNER JOIN ProjectJobSheet pjs 
			ON ISNULL(main.AppointmentID, 0) = ISNULL(pjs.AppointmentID, 0)
			AND ISNULL(main.JobID, 0) = ISNULL(pjs.JobID, 0)
			AND ISNULL(main.SurveyTypeID, 0) = ISNULL(pjs.SurveyTypeID, 0)
			AND ISNULL(main.ClientID, 0) = ISNULL(pjs.ClientID, 0)
			AND ISNULL(main.ProjectID, 0) = ISNULL(pjs.ProjectID, 0)
			AND ISNULL(main.SiteID, 0) = ISNULL(pjs.SiteID, 0)
		LEFT JOIN Appointment pjspa ON pjs.AppointmentID = pjspa.AppointmentID
    WHERE 
		main.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage
	ORDER BY
		main.Row_Num
	
	-- drop temp tables
	DROP TABLE #ProjectIDs
	DROP TABLE #JobSheetData
	
	-- return useful counts to front end
	SELECT
		@SurveysStillDue AS WorkScheduled
		, @SurveysStillDue AS SurveysStillDue
		, @Approved AS Approved
		, @SurveysOnTime AS SurveysOnTime
		, @SurveysOverTime AS SurveysOverTime
		, @UnScheduled AS UnScheduled
		, @KPI AS KPI
		, @TotalJobs_HasSampleResults - @Approved_HasSampleResults AS SampleAnalysisComplete
		--, @SurveysCompleted - @TotalJobs_HasSampleResults - @Approved AS SiteWorkComplete
		, @TotalRows - @UnScheduled - @SurveysStillDue - @TotalJobs_HasSampleResults + @Approved_HasSampleResults - @Approved AS SiteWorkComplete
    
    
    SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='FloorplanDesignerItem') AND name='Deleted') < 1
BEGIN
  ALTER TABLE FloorplanDesignerItem
      ADD Deleted DATETIME NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__UseRequestServerNameInReportGen') < 1
BEGIN
  ALTER TABLE [dbo].[Config]
	ADD [b__UseRequestServerNameInReportGen] [bit] NOT NULL
	DEFAULT (0);
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='FloorplanImageBackup'))
BEGIN
	CREATE TABLE [dbo].[FloorplanImageBackup](
		[FloorplanImageBackupID] [int] IDENTITY(1,1) NOT NULL,
		[FloorplanID] [int] NOT NULL,
		[FloorplanData] [image] NULL,
		[saveFloorplanImagedata] [image] NULL,
		[Created] [datetime] NOT NULL,
		CONSTRAINT [PK_FloorplanImageBackup_FloorplanImageBackupID] PRIMARY KEY CLUSTERED 
	(
		[FloorplanImageBackupID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

	ALTER TABLE [dbo].[FloorplanImageBackup] ADD  CONSTRAINT [DF_FloorplanImageBackup_Created]  DEFAULT (getdate()) FOR [Created]
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Surveying_v2.4.1.5') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Surveying_v2.4.1.5] AS BEGIN SET NOCOUNT ON; END')
End
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[EnterpriseSiteData_Surveying_v2.4.1.5]    Script Date: 15/11/2018 15:11:20 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[EnterpriseSiteData_Surveying_v2.4.1.5]
(
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
	  @IncludePhotoNoColumn BIT = 0,
	  @ExcludeBinaryData BIT = 0,
	  @JobReinspectionStructureID INT = 0,
	  @FilterToJobID INT = 0
)
AS
BEGIN
       SET NOCOUNT ON;
	   
	   If @RequestingServerCode != (SELECT s__ServerCode FROM Config) BEGIN
			SET @FilterToJobID = 0
	   END

	   IF @FilterToJobID > 0 BEGIN
			SET @JobReinspectionStructureID = (SELECT ISNULL((SELECT TOP 1 JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID=@FilterToJobID AND NoDataRequired=0),0))
			IF @JobReinspectionStructureID = 0 BEGIN
				SET @FilterToJobID = 0
			END
	   END

       DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
       -- crack @ClientIDs into a table
       DECLARE @Clients TABLE ( ClientID INT )

       INSERT
              @Clients (ClientID)
       SELECT
              ClientID
       FROM
              ClientSite
       WHERE
              SiteID = @SiteID

       DECLARE @IDList TABLE (UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
       Insert into @IDList (UseRoomCode, RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
       SELECT 
              CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
              r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
              fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
              rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
              s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
       FROM 
              (
                     SELECT 
                           j.JobID, j.SiteID
                     FROM
                           Job j WITH (NOLOCK)
                           INNER JOIN @Clients c ON j.ClientID=c.ClientID
                           INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
                           INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
                     WHERE
                           a.DateDeclined IS NULL
                                  AND
                           j.Approved IS NOT NULL
              ) j
              INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
              INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
              LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
              LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
              LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
			  LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON 
			  (
						CASE WHEN s.SampleID IS NOT NULL THEN
							CASE WHEN jrsd.SampleID=s.SampleID THEN 1 ELSE 0 END
						ELSE
							CASE WHEN rm.RoomID IS NOT NULL THEN
								CASE WHEN jrsd.RoomID=rm.RoomID THEN 1 ELSE 0 END
							ELSE
								CASE WHEN fp.FloorplanID IS NOT NULL THEN
									CASE WHEN jrsd.FloorplanID=fp.FloorplanID THEN 1 ELSE 0 END
								ELSE
									CASE WHEN jrsd.RegisterID=r.RegisterID THEN 1 ELSE 0 END
								END
							END
						END = 1
					  ) AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
       WHERE 
              j.SiteID=@SiteID
				AND
			  CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1

       SELECT
              main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.ContentType,
              r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode,
			  main.Included
       FROM
              (
                     Select
                           'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode,
						   CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                  MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RegisterID,BuildingGUID,BuildingGUIDVersion
                     ) _r
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RegisterID=_r.RegisterID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                           _r.Identifier = 1
					GROUP BY
						_r.RegisterID, BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode, CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
              ) main
              INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
              LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
	   WHERE
			r.[GUID] IS NOT NULL AND r.[GUIDVersion] IS NOT NULL
       
       SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
              main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
              fp.FloorNumber, 
              CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END END [FloorplanData],
              CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType],
			  main.Included
       FROM
              (      
                     Select
                           'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,
							CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
                                  id.FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
                           FROM
                                  @IDList id
                           GROUP BY
                                  id.FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
                     ) _f
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.FloorplanID=_f.FloorplanID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                        _f.Identifier = 1
							AND
						CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
					 GROUP BY
						 _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
              ) main
              INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
	   WHERE
			fp.[GUID] IS NOT NULL AND fp.[GUIDVersion] IS NOT NULL

       SELECT
              main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
              rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode,
			  CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included],
			  rm.RoomGroupID [ServerRoomGroupID], rm.ParentGroupID [ServerParentGroupID]
       FROM
              (
                     Select
                           'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
                                  RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
                     ) _rm
                     WHERE
                           _rm.Identifier = 1
              ) main
              INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
			  LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RoomID=rm.RoomID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
	   WHERE
			CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
				AND
			rm.[GUID] IS NOT NULL AND rm.[GUIDVersion] IS NOT NULL
	   GROUP BY
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode, rm.RoomGroupID, rm.ParentGroupID,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
       
       DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT, Included INT)
       
       INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion,Included)
       SELECT
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included
       FROM
              (      
                     Select
                           'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion,
							CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],
                                  SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
                     ) _s
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.SampleID=_s.SampleID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                        _s.Identifier = 1
							AND
						CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
              ) main
              INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
              INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID
              INNER JOIN @Clients c ON gs.ClientID=c.ClientID
	   WHERE
			  s.[GUID] IS NOT NULL AND s.[GUIDVersion] IS NOT NULL
       GROUP BY
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
			  main.Included

	   IF @IncludePhotoNoColumn = 1
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.PhotoNo, REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample,  
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
		ELSE
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample, 
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
       SELECT
              main.TableName,
              main.SampleID,
              main.RegisterID,
              main.ElementTypeID,
              main.ElementText
       FROM
       (
              SELECT
                     'Element' [TableName],
                     e.SampleID, 
                     NULL [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,eim.Description)
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,ISNULL(eimso.Description,eim.Description)) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     @GuidSamples main
                     INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
					 LEFT OUTER JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID=e.ElementIntMeaningSubOptionID
              WHERE
                     e.ElementTypeID NOT IN (32)
              UNION
              SELECT
                     'Element' [TableName],
                     NULL [SampleID], 
                     e.RegisterID [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,eim.Description)
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     (
                           Select
                                  _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
                           FROM
                           (
                                  SELECT
                                         ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                         MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                                  FROM
                                         @IDList
                                  GROUP BY
                                         RegisterID,BuildingGUID,BuildingGUIDVersion
                           ) _r
                           WHERE
                                  _r.Identifier = 1
                     ) main
                     INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
                     INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
              WHERE
                     CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
                           1 
                     ELSE
                           CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
                     END = 1
       ) main
       
       SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Surveying_v2.4.1.8') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Surveying_v2.4.1.8] AS BEGIN SET NOCOUNT ON; END')
End
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[EnterpriseSiteData_Surveying_v2.4.1.8]    Script Date: 15/11/2018 15:12:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROC [dbo].[EnterpriseSiteData_Surveying_v2.4.1.8]
(
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
	  @IncludePhotoNoColumn BIT = 0,
	  @ExcludeBinaryData BIT = 0,
	  @JobReinspectionStructureID INT = 0,
	  @FilterToJobID INT = 0
)
AS
BEGIN
       SET NOCOUNT ON;
	   
	   If @RequestingServerCode != (SELECT s__ServerCode FROM Config) BEGIN
			SET @FilterToJobID = 0
	   END

	   IF @FilterToJobID > 0 BEGIN
			SET @JobReinspectionStructureID = (SELECT ISNULL((SELECT TOP 1 JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID=@FilterToJobID AND NoDataRequired=0),0))
			IF @JobReinspectionStructureID = 0 BEGIN
				SET @FilterToJobID = 0
			END
	   END

       DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
       -- crack @ClientIDs into a table
       DECLARE @Clients TABLE ( ClientID INT )

       INSERT
              @Clients (ClientID)
       SELECT
              ClientID
       FROM
              ClientSite
       WHERE
              SiteID = @SiteID

       DECLARE @IDList TABLE (UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
       Insert into @IDList (UseRoomCode, RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
       SELECT 
              CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
              r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
              fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
              rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
              s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
       FROM 
              (
                     SELECT 
                           j.JobID, j.SiteID
                     FROM
                           Job j WITH (NOLOCK)
                           INNER JOIN @Clients c ON j.ClientID=c.ClientID
                           INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
                           INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
                     WHERE
                           a.DateDeclined IS NULL
                                  AND
                           j.Approved IS NOT NULL
              ) j
              INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
              INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
              LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
              LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
              LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
              LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON 
              (
				CASE WHEN s.SampleID IS NOT NULL THEN
					CASE WHEN jrsd.SampleID=s.SampleID THEN 1 ELSE 0 END
				ELSE
					CASE WHEN rm.RoomID IS NOT NULL THEN
						CASE WHEN jrsd.RoomID=rm.RoomID THEN 1 ELSE 0 END
					ELSE
						CASE WHEN fp.FloorplanID IS NOT NULL THEN
							CASE WHEN jrsd.FloorplanID=fp.FloorplanID THEN 1 ELSE 0 END
						ELSE
							CASE WHEN jrsd.RegisterID=r.RegisterID THEN 1 ELSE 0 END
						END
					END
				END = 1
              )
              AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
       WHERE 
              j.SiteID=@SiteID
				AND
			  CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1

       SELECT
              main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.ContentType,
              r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode,
			  main.Included
       FROM
              (
                     Select
                           'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode,
						   CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                  MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RegisterID,BuildingGUID,BuildingGUIDVersion
                     ) _r
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RegisterID=_r.RegisterID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                           _r.Identifier = 1
					GROUP BY
						_r.RegisterID, BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode, CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
              ) main
              INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
              LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
	   WHERE
			r.[GUID] IS NOT NULL AND r.[GUIDVersion] IS NOT NULL
       
       SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
              main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
              fp.FloorNumber, 
              CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END END [FloorplanData],
              CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType],
			  main.Included
       FROM
              (      
                     Select
                           'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,
							CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
                                  id.FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
                           FROM
                                  @IDList id
                           GROUP BY
                                  id.FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
                     ) _f
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.FloorplanID=_f.FloorplanID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                        _f.Identifier = 1
							AND
						CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
					 GROUP BY
						 _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
              ) main
              INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
	   WHERE
			fp.[GUID] IS NOT NULL AND fp.[GUIDVersion] IS NOT NULL
	   
       SELECT
              main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
              rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode,
			  CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included],
			  rm.RoomGroupID [ServerRoomGroupID], rm.ParentGroupID [ServerParentGroupID]
       FROM
              (
                     Select
                           'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
                                  RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
                     ) _rm
                     WHERE
                           _rm.Identifier = 1
              ) main
              INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
			  LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RoomID=rm.RoomID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
	   WHERE
			CASE WHEN @FilterToJobID > 0 THEN 
				CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 
			END = 1
				AND
			rm.[GUID] IS NOT NULL AND rm.[GUIDVersion] IS NOT NULL
	   GROUP BY
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode, rm.RoomGroupID, rm.ParentGroupID,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
       
       DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT, Included INT)
       
       INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion,Included)
       SELECT
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included
       FROM
              (      
                     Select
                           'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion,
							CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
                     FROM
                     (
                           SELECT
                                  ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],
                                  SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
                           FROM
                                  @IDList
                           GROUP BY
                                  SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
                     ) _s
					 LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.SampleID=_s.SampleID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
                     WHERE
                        _s.Identifier = 1
							AND
						CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
              ) main
              INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
              INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID
              INNER JOIN @Clients c ON gs.ClientID=c.ClientID
	   WHERE
			  s.[GUID] IS NOT NULL AND s.[GUIDVersion] IS NOT NULL
       GROUP BY
              main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
			  main.Included

	   IF @IncludePhotoNoColumn = 1
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.PhotoNo, REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample,  
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
		ELSE
		   SELECT
				main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
				s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample, 
				s.SampleResultID, s.SampleClassificationID, 
				sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
				s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included
			FROM
				@GuidSamples main
				INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
				LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
				LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
				LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
       SELECT
              main.TableName,
              main.SampleID,
              main.RegisterID,
              main.ElementTypeID,
              main.ElementText
       FROM
       (
              SELECT
                     'Element' [TableName],
                     e.SampleID, 
                     NULL [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,eim.Description)
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     @GuidSamples main
                     INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
              WHERE
                     e.ElementTypeID NOT IN (32)
              UNION
              SELECT
                     'Element' [TableName],
                     NULL [SampleID], 
                     e.RegisterID [RegisterID],
                     e.ElementTypeID,
                     CASE WHEN e.ElementText IS NOT NULL THEN
                           e.ElementText
                     ELSE
                           CASE WHEN e.ElementTypeID = 20 THEN
                                  ISNULL(eime.Description,ISNULL(eim.ShortDescription,eim.Description))
                           ELSE
                                  CASE WHEN e.ElementTypeID = 32 THEN
                                         CAST(e.ElementIntID as varchar)
                                  ELSE
                                         ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
                                  END
                           END
                     END [ElementText]
              FROM
                     (
                           Select
                                  _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
                           FROM
                           (
                                  SELECT
                                         ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
                                         MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
                                  FROM
                                         @IDList
                                  GROUP BY
                                         RegisterID,BuildingGUID,BuildingGUIDVersion
                           ) _r
                           WHERE
                                  _r.Identifier = 1
                     ) main
                     INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
                     INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
                     LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
                     LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
              WHERE
                     CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
                           1 
                     ELSE
                           CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
                     END = 1
       ) main
   
	  SELECT
            main.TableName,
            main.RoomID,
            main.ItemNo,
            main.[Description],
            main.[Position],
			main.[Comments]
       FROM
       (
              SELECT
                     'BuildingComponent' [TableName],
                     main.RoomID,
					 bc.ItemNo,
					 bc.[Description],
					 bc.[Position],
					 bc.[Comments]
              FROM
	                (
						Select
							'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
						FROM
						(
							SELECT
									ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
									RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
							FROM
									@IDList
							GROUP BY
									RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
						) _rm
						WHERE
							_rm.Identifier = 1
					  ) main
					  INNER JOIN BuildingComponent bc WITH (NOLOCK) ON main.RoomID=bc.RoomID
       ) main
       
       SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'FloorplanRerender_GetSamples') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[FloorplanRerender_GetSamples] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROC [dbo].[FloorplanRerender_GetSamples]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = 
      (
			SELECT 
				j.JobID 
			FROM 
				Job j WITH (NOLOCK)
				INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
			WHERE 
				fp.FloorplanID=@FloorplanID
      )
	  DECLARE @SurveyTypeID INT = (SELECT su.SurveyTypeID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 1 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            CASE WHEN e48.ElementIntMeaningID=121 THEN
                        0
                  ELSE
                        COALESCE(sr.Value,e8.ElementIntID,-1)
            END,
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
			e48.ElementIntMeaningID
      FROM
            job j WITH (NOLOCK)
            inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
            INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            je.JobID = @JobID
                  AND
            su.SurveyTypeID = @SurveyTypeID
	  END

	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 0 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
				s.SampleID,
				s.SampleRef,
				s.AsSample,
				COALESCE(sr.Value,e8.ElementIntID,-1),
				CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
					  1 
				ELSE
					  0 
				END,
				rm.RoomID,
				f.FloorplanID,
				e48.ElementIntMeaningID
		  FROM
				Floorplan f
				INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
				INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
				INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
				LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
				LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
				LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
				LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
				LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
		  WHERE
				f.FloorplanID=@FloorplanID
	  END
            
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
            0
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
            INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=r.JobEmployeeID
            INNER JOIN Job j WITH (NOLOCK) ON j.JobID=je.JobID
      WHERE
			j.JobID=@JobID

      Update @SampleData
            Set 
                  SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)

      Select 
		sd.SampleID,
		CASE WHEN sd.ReinspectionElementIntMeaningID = 121 THEN
			'Removed'
		ELSE
			CASE WHEN sd.Inaccessible > 0 THEN
				'Inaccessible'
			Else
				CASE sd.SampleResultValue 
					WHEN -1 THEN 'Reference Only'
					WHEN 0 THEN 'Negative Asbestos'
				Else
					CASE WHEN sd.SampleResultValue > 0 THEN
						'Asbestos'
					END
				END
			END
		END [OverlayType]
      FROM
			@SampleData sd
End
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesCompletedJobs') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesCompletedJobs]    Script Date: 27/11/2018 09:39:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO



IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesWorkInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesWorkInProgress]    Script Date: 27/11/2018 09:40:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'changeClientSiteForJobQuote') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[changeClientSiteForJobQuote] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[changeClientSiteForJobQuote]
	-- Add the parameters for the stored procedure here
	@quoteid int,
	@jobid int,
	@siteID int,
	@ClientID int,
    @projectId int = NULL
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	DECLARE 
	@errNo int,
	@errDesc varchar(255),
	@currentProjectID int,
    @currentClientId int,
    @currentSiteId int

	begin TRAN

	if not @jobid is null
	BEGIN 
        --before any changes take place get the details for the job
		select @currentProjectID = projectID,@currentClientId= [ClientID], @currentSiteId= [SiteID] from Job where JobID = @jobid
		                
        /*handle project site link*/        

        if @projectId!=@currentProjectID --check if project has changed
        BEGIN
            IF @projectId IS NOT NULL --the change was to a valid project
            BEGIN
                IF @siteID IS NOT NULL --check if there is a site passed in as a project and site are needed.
                BEGIN
                    IF NOT EXISTS(SELECT 'x' FROM [dbo].[ProjectSite] ps WHERE ps.[ProjectID]=@projectId AND [ps].[SiteID]=@siteID)  --check the project exists for the project and site
                    BEGIN 
                        --insert a new link to the project for the site
                        INSERT INTO [dbo].[ProjectSite] ([ProjectID], [SiteID])
                        SELECT @projectId,@siteID
                        
                		select @errNo = @@ERROR
                		if @errNo<>0 
                		begin
                			goto errHandle
                		END	    
                        
                    END 
                END 
                
                --remove the old link if there was a client and project selected originally
                IF @currentProjectID IS NOT NULL AND @currentSiteId IS NOT NULL
                BEGIN
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId                    
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	    
                END 
            END
            ELSE
            BEGIN
                --no project assigned, make sure that there is a project and site for the existing one 
                IF @currentProjectID IS NOT NULL AND @currentClientId IS NOT NULL
                BEGIN
                    --and remove it
                    delete FROM [dbo].[ProjectSite]  WHERE projectid = @currentProjectID AND siteid = @currentSiteId             
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	    
                END                     
            END
        END

        DECLARE @PreviousClientID INT = (Select ClientID FROM Job Where JobID = @jobid)
        DECLARE @PreviousSiteID INT = (Select SiteID FROM Job Where JobID = @jobid)
        update job set ClientID=@ClientID, siteID=@siteID, projectid=@projectId, contactid = NULL where jobid =@jobid
		DECLARE @Approved BIT = (SELECT CASE WHEN j.Approved IS NOT NULL THEN 1 ELSE 0 END [Approved] FROM Job j WHERE j.JobID = @jobid)

        -- Populate portal data for the new client & site of the job
		IF @Approved = 1
		BEGIN
			EXEC PopulateSampleComputedData @JobID
			If @PreviousClientID<>@ClientID OR @PreviousSiteID<>@siteID BEGIN
				Exec PopulateGuidSamples @PreviousClientID, @PreviousSiteID 
				Exec CreateSiteSampleResultsOverviewSorting @PreviousClientID, @PreviousSiteID
			END		
			Exec PopulateGuidSamples @ClientId, @SiteId 
			Exec CreateSiteSampleResultsOverviewSorting @ClientId, @SiteId
		
			-- Re-populate portal data for the old client & site.
			Exec PopulateGuidSamples @currentClientId, @currentSiteId 
			Exec CreateSiteSampleResultsOverviewSorting @currentClientId, @currentSiteId
		END
		
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating job'
			goto errHandle
		END
        
        /*clear out the jobs current client appendices by default*/
        
        UPDATE 
            R
        SET 
            r.[AppendicesClientTemplateID] = NULL 
        FROM
            [dbo].[Register] r
            INNER JOIN [dbo].[JobEmployee] je ON r.[JobEmployeeID] = [je].[JobEmployeeID]
            INNER JOIN [dbo].[Job] j ON je.[JobID] = [j].[JobID]
        WHERE 
            [j].[JobID] = @jobid
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while resetting job registers client appendix template id'
			goto errHandle
		END
        
        
        DECLARE @ctid [int]
        SET @ctid = 
            (
                select TOP 1
                	[ct].[TemplateID]
                from
                	TemplateType t 
                	inner join ClientTemplate ct on t.TemplateTypeID = ct.TemplateTypeID
                where 
                	ct.ClientID = @ClientID and 
                	not version is null
                	and TemplateType = 'Survey - Appendices'
                order by
                	ct.Version DESC
            )
        IF @ctid IS NOT NULL
        BEGIN
        
            UPDATE 
                 R
            SET 
                r.[AppendicesClientTemplateID] = @ctid 
            FROM
                [dbo].[Register] r
                INNER JOIN [dbo].[JobEmployee] je ON r.[JobEmployeeID] = [je].[JobEmployeeID]
                INNER JOIN [dbo].[Job] j ON je.[JobID] = [j].[JobID]
            WHERE 
                [j].[JobID] = @jobid
        
            if @errNo<>0 
            BEGIN
                select @errDesc = 'ERROR while setting job registers to new client appendix template id'
                goto errHandle
            END
        end

		-- Update the job reinspection structure records for the job if it has any
		IF EXISTS (SELECT JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID = @jobid)
		BEGIN			
			UPDATE JobReinspectionStructure SET ClientID = @ClientID, SiteID = @SiteId WHERE JobID = @jobid
		END
	end 
	
	if not @quoteid is null
	begin 
		select @currentProjectID = projectID,@currentClientId= [ClientID],@currentSiteId= [SiteID] from quote where quoteID =@quoteid
                
        if @projectId!=@currentProjectID --check if project has changed
        BEGIN
            IF @projectId IS NOT NULL --the change was to a valid project
            BEGIN
                IF @siteID IS NOT NULL --check if there is a site passed in as a project and site are needed.
                BEGIN
                    IF NOT EXISTS(SELECT 'x' FROM [dbo].[ProjectSite] ps WHERE ps.[ProjectID]=@projectId AND [ps].[SiteID]=@siteID)  --check the project exists for the project and site
                    BEGIN 
                        --insert a new link to the project for the site
                        INSERT INTO [dbo].[ProjectSite] ([ProjectID], [SiteID])
                        SELECT @projectId,@siteID
                        
                        select @errNo = @@ERROR
                		if @errNo<>0 
                		begin
                			goto errHandle
                		END	        
                    END 
                END 
                
                --remove the old link if there was a client and project selected originally
                IF @currentProjectID IS NOT NULL AND @currentSiteId IS NOT NULL
                BEGIN
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId           
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	        
                END 
            END
            ELSE
            BEGIN
                --no project assigned, make sure that there is a project and site for the existing one 
                IF @currentProjectID IS NOT NULL AND @currentClientId IS NOT NULL
                BEGIN
                    --and remove it
                    delete FROM [dbo].[ProjectSite] WHERE projectid = @currentProjectID AND siteid = @currentSiteId                    
            		select @errNo = @@ERROR
            		if @errNo<>0 
            		begin
            			goto errHandle
            		END	        
                END                     
            END
        END
        
        
	
		update quote set ClientID=@ClientID, siteID=@siteID, projectid=@projectId,@currentSiteId= [SiteID], contactID = NULL where quoteID =@quoteid
        
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating quote'
			goto errHandle
		end

		UPDATE Appointment set ClientID=@ClientID, siteID=@siteID, ProjectID=@projectid, ContactId = NULL where quoteID=@quoteid
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			select @errDesc = 'ERROR while updating appointment(s)'
			goto errHandle
		end

	end



	if not exists(select 'x' from ClientSite where SiteID = @siteID and ClientID=@ClientID)
	begin 
		insert into Clientsite (Clientsite.ClientID,Clientsite.SiteID) values (@ClientID,@siteID)
		select @errNo = @@ERROR
		if @errNo<>0 
		begin
			goto errHandle
		end	
	end 


	commit tran
	goto exit_proc

	errHandle:
		rollback TRAN


	exit_proc:

    SET NOCOUNT off    
END

GO

-- IF (SELECT COUNT(*) FROM Employee WHERE Username = 'swetherell') > 0
-- BEGIN
-- 	UPDATE Employee SET FullName = 'TEAMS Support', Email = 'noreply@teams-software.co.uk' WHERE Username = 'swetherell'
-- END
-- GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Photo') AND name='IVF_DataFileID') < 1
BEGIN
  ALTER TABLE Photo
      ADD IVF_DataFileID INT NULL
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='LegionellaTaskAutoInsertClient'))
BEGIN
	CREATE TABLE [dbo].[LegionellaTaskAutoInsertClient](
	[LegionellaTaskAutoInsertClientID] [int] IDENTITY(1,1) NOT NULL,
	[ClientID] [int] NOT NULL,
	[LegionellaTaskAutoInsertID] [int] NOT NULL,
	[RiskDescription] [varchar](max) NULL,
	[Action] [varchar](max) NULL,
	[LegionellaFrequencyCategoryID] [int] NULL,
	[LegionellaRiskRatingID] [int] NULL,
	[LegionellaPriorityRatingID] [int] NULL,
	CONSTRAINT [PK_LegionellaTaskAutoInsertClient_LegionellaTaskAutoInsertClientID] PRIMARY KEY CLUSTERED 
	(
		[LegionellaTaskAutoInsertClientID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='PhotoCollectionAutoInsert') AND name='LegionellaAssetOutletQuestionID') < 1
BEGIN
  ALTER TABLE PhotoCollectionAutoInsert
      ADD LegionellaAssetOutletQuestionID INT NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ProjectSite') AND name='ProjectSpecificSiteNotes') < 1
BEGIN
  ALTER TABLE ProjectSite
      ADD ProjectSpecificSiteNotes VARCHAR(MAX) NULL
END
GO

IF (SELECT COUNT(*) FROM DataGrid WHERE DataGrid = 'Portal Access') > 0
BEGIN
	IF (SELECT COUNT(*) FROM DataGridButton WHERE Action = 'Export Users' AND DataGridId = (SELECT DataGridID FROM DataGrid WHERE DataGrid = 'Portal Access')) = 0
	BEGIN
		INSERT INTO DataGridButton (DataGridId, Eval, Action, RequiresId, SortOrder) VALUES ((SELECT DataGridID FROM DataGrid WHERE DataGrid = 'Portal Access'), 'Session("Manager")', 'Export Users', 0, 0)
	END
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ClientSite') AND name='SiteAlerts') < 1
BEGIN
  ALTER TABLE ClientSite
      ADD SiteAlerts VARCHAR(MAX) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__OfficeFloorplanDesigner') < 1
BEGIN
  ALTER TABLE Config
      ADD b__OfficeFloorplanDesigner BIT NOT NULL DEFAULT 0
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'standardPhrase_NonMatchingData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[standardPhrase_NonMatchingData] AS BEGIN SET NOCOUNT ON; END')
END
GO
/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 R2 (10.50.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008 R2
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[standardPhrase_NonMatchingData]    Script Date: 17/12/2018 15:50:51 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[standardPhrase_NonMatchingData]
      @ClientID INT,
      @ButtonType VARCHAR(MAX),
      @PartialMode BIT

WITH RECOMPILE
AS
BEGIN

	Set NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @StandardPhraseTypeID INT = (Select sptc.StandardPhraseTypeID FROM StandardPhraseTypeClient sptc Where sptc.ButtonType=@ButtonType AND sptc.PartialMode=@PartialMode AND sptc.ClientID=@ClientID)

DECLARE @NonMatchTable TABLE (NonMatchingID INT, NonMatchingText VARCHAR(MAX))
Insert into @NonMatchTable
Select 
	NonMatching.[Non-Matching_ID],
	NonMatching.[Non-Matching_Text] 
FROM 
	(
		SELECT 
			[Non-Matching_ID] =		CASE @ButtonType 
										WHEN 'ROOM' THEN RM.RoomID
										WHEN 'ROOMPRAT' THEN RM.RoomID
										WHEN 'POSITION' THEN e1.ElementID
										WHEN 'DESCRIPTION' THEN e2.ElementID
									END,
			[Non-Matching_Text] =	CASE @ButtonType 
										WHEN 'ROOM' THEN RM.Description
										WHEN 'ROOMPRAT' THEN RM.Description
										WHEN 'POSITION' THEN e1.ElementText
										WHEN 'DESCRIPTION' THEN e2.ElementText
									END
		FROM 
			Job j 
			INNER JOIN JobEmployee je ON je.JobID = j.JobID 
			INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID 
			INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID 
			INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID 
			LEFT OUTER JOIN Sample s ON s.RoomID = rm.RoomID 
			LEFT OUTER JOIN Element e1 ON s.SampleID = e1.SampleID AND e1.ElementTypeID=1 
			LEFT OUTER JOIN Element e2 ON s.SampleID = e2.SampleID AND e2.ElementTypeID=2 
		WHERE 
			(
				CASE @ButtonType 
					WHEN 'ROOM' THEN 
						(Select COUNT(StandardPhraseID) FROM StandardPhrase Where LTRIM(RTRIM(rm.Description)) Like CASE WHEN @PartialMode=1 THEN ('%'+Description+'%') ELSE Description End AND StandardPhraseTypeID IN (@StandardPhraseTypeID)) 
					WHEN 'ROOMPRAT' THEN 																																												  
						(Select COUNT(StandardPhraseID) FROM StandardPhrase Where LTRIM(RTRIM(rm.Description)) Like CASE WHEN @PartialMode=1 THEN ('%'+Description+'%') ELSE Description End AND StandardPhraseTypeID IN (@StandardPhraseTypeID)) 
					WHEN 'POSITION' THEN 																																												  
						(Select COUNT(StandardPhraseID) FROM StandardPhrase Where LTRIM(RTRIM(e1.ElementText)) Like CASE WHEN @PartialMode=1 THEN ('%'+Description+'%') ELSE Description End AND StandardPhraseTypeID IN (@StandardPhraseTypeID)) 
					WHEN 'DESCRIPTION' THEN  																																											  
						(Select COUNT(StandardPhraseID) FROM StandardPhrase Where LTRIM(RTRIM(e2.ElementText)) Like CASE WHEN @PartialMode=1 THEN ('%'+Description+'%') ELSE Description End AND StandardPhraseTypeID IN (@StandardPhraseTypeID))
				END
			)=0
				AND 
			j.ClientID = @ClientID
	) NonMatching 
Where 
	NonMatching.[Non-Matching_Text] IS NOT NULL 
Order by 
	NonMatching.[Non-Matching_Text]

SELECT top 50 
	[NonMatchingText] =			md.NonMatchingText,
    [array_NonMatchingID] =		STUFF((    SELECT ',' + CAST(SUB.NonMatchingID as varchar) AS [text()]
									FROM @NonMatchTable SUB
									WHERE
									SUB.NonMatchingText = md.NonMatchingText
									FOR XML PATH('') ), 1, 1, '' )
FROM
	@NonMatchTable md
GROUP BY
	md.NonMatchingText

Set NOCOUNT OFF;

END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='FloorplanImageBackup') AND name='AutocadData') < 1
BEGIN
	ALTER TABLE FloorplanImageBackup
	ADD AutocadData IMAGE NULL
END
GO


USE [TEAMS]
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'mobile_Surveying_v2.4.2.12_DataTransfer_JobQuoteAppointment') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[mobile_Surveying_v2.4.2.12_DataTransfer_JobQuoteAppointment] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[mobile_Surveying_v2.4.2.12_DataTransfer_JobQuoteAppointment]
(
	@SystemName nvarchar(MAX),
	@Version nvarchar(MAX),
	@EmployeeID INT,
	@AppointmentWindowDate DATETIME = NULL,
	@QuoteList VARCHAR(MAX) = '',
	@ExtraClientIds VARCHAR(MAX) = '',
	@ExtraSiteIds VARCHAR(MAX) = ''
)
AS
BEGIN
	SET NOCOUNT ON;
	
	SET @AppointmentWindowDate = ISNULL(@AppointmentWindowDate,GETDATE())
	
	DECLARE @JobQuoteAppointmentIDList TABLE (ClientID INT, SiteID INT,JobID INT, QuoteID INT, AppointmentID INT)
	INSERT INTO @JobQuoteAppointmentIDList (ClientID,SiteID,JobID,QuoteID,AppointmentID)
	SELECT 
		q.ClientID,
		q.SiteID,
		j.JobID,
		q.QuoteID,
		a.AppointmentID
	FROM 
		Appointment a
		INNER JOIN AppointmentEmployee ae ON a.AppointmentID = ae.AppointmentID 
		LEFT OUTER JOIN Quote q ON q.QuoteID=a.QuoteID
		LEFT OUTER JOIN Site si ON q.SiteID = si.SiteID
		LEFT OUTER JOIN Client c ON c.ClientID = q.ClientID
		LEFT OUTER JOIN Project p ON a.ProjectID = p.ProjectID 
		LEFT OUTER JOIN Job j ON q.JobID = j.JobID
	WHERE 
		@AppointmentWindowDate BETWEEN DATEADD(DAY,-6, a.StartTime) AND DATEADD(DAY, 3, a.EndTime)
			AND 
		ae.EmployeeID=@EmployeeID
			AND 
		a.DateDeclined IS NULL

	INSERT INTO @JobQuoteAppointmentIDList (ClientID)
	SELECT
		a.ClientID
	FROM
	(
		SELECT 
			ClientID
		FROM
			ClientSpecificElement
		UNION
		SELECT
			s [ClientID]
		FROM
			dbo.SplitString(@ExtraClientIds,',')
	) a
	GROUP BY
		a.ClientID

/*
	ORIGINAL
	DECLARE @ClientTable TABLE ([ClientID|INTEGER|NOTNULL] INT NOT NULL ,[Email|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Telephone|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Fax|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[MainContact|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[EnterpriseServerCode|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @ClientTable ([ClientID|INTEGER|NOTNULL],[Email|VARCHAR|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Fax|VARCHAR|NOTNULL],[MainContact|VARCHAR|NOTNULL],[EnterpriseServerCode|VARCHAR|NULL]) Select c.[ClientID],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode] FROM Client c WITH (NOLOCK) INNER JOIN (SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID) jqa ON c.ClientID=jqa.ClientID SELECT [ClientID|INTEGER|NOTNULL],[Email|VARCHAR|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Fax|VARCHAR|NOTNULL],[MainContact|VARCHAR|NOTNULL],[EnterpriseServerCode|VARCHAR|NULL] FROM @ClientTable
	DECLARE @SiteTable TABLE ([SiteID|INTEGER|NOTNULL] INT NOT NULL ,[Telephone|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Contact|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[UPRN|VARCHAR|NULL] VARCHAR(MAX) NULL ,[ClientOrderNumber|VARCHAR|NULL] VARCHAR(MAX) NULL ,[TEAMSUPRN|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @SiteTable ([SiteID|INTEGER|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Contact|VARCHAR|NOTNULL],[UPRN|VARCHAR|NULL],[ClientOrderNumber|VARCHAR|NULL],[TEAMSUPRN|VARCHAR|NULL]) Select si.[SiteID],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] FROM Site si WITH (NOLOCK) INNER JOIN (SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID) jqa ON si.SiteID=jqa.SiteID	SELECT [SiteID|INTEGER|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Contact|VARCHAR|NOTNULL],[UPRN|VARCHAR|NULL],[ClientOrderNumber|VARCHAR|NULL],[TEAMSUPRN|VARCHAR|NULL] FROM @SiteTable
	DECLARE @AppointmentTable TABLE ([AppointmentID|INTEGER|NOTNULL] INT NOT NULL ,[AppointmentTypeID|INTEGER|NOTNULL] INT NOT NULL ,[ClientID|INTEGER|NULL] INT NULL ,[SiteID|INTEGER|NULL] INT NULL ,[StartTime|DATETIME|NOTNULL] DATETIME NOT NULL ,[EndTime|DATETIME|NOTNULL] DATETIME NOT NULL ,[Notes|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[ClientOrderNo|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[DateCreated|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[QuoteID|INTEGER|NULL] INT NULL ,[DateConfirmed|DATETIME|NULL] DATETIME NULL ,[DateDeclined|DATETIME|NULL] DATETIME NULL ,[AppointmentCategoryID|INTEGER|NULL] INT NULL DEFAULT (NULL),[ProjectAppointmentId|INTEGER|NULL] INT NULL ,[AppointmentGroupId|INTEGER|NULL] INT NULL ,[BranchOfficeID|INTEGER|NOTNULL] INT NOT NULL DEFAULT ((0))) INSERT INTO @AppointmentTable ([AppointmentID|INTEGER|NOTNULL],[AppointmentTypeID|INTEGER|NOTNULL],[ClientID|INTEGER|NULL],[SiteID|INTEGER|NULL],[StartTime|DATETIME|NOTNULL],[EndTime|DATETIME|NOTNULL],[Notes|VARCHAR|NOTNULL],[ClientOrderNo|VARCHAR|NOTNULL],[DateCreated|DATETIME|NOTNULL],[QuoteID|INTEGER|NULL],[DateConfirmed|DATETIME|NULL],[DateDeclined|DATETIME|NULL],[AppointmentCategoryID|INTEGER|NULL],[ProjectAppointmentId|INTEGER|NULL],[AppointmentGroupId|INTEGER|NULL],[BranchOfficeID|INTEGER|NOTNULL]) Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID] FROM Appointment a WITH (NOLOCK) INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID SELECT [AppointmentID|INTEGER|NOTNULL],[AppointmentTypeID|INTEGER|NOTNULL],[ClientID|INTEGER|NULL],[SiteID|INTEGER|NULL],[StartTime|DATETIME|NOTNULL],[EndTime|DATETIME|NOTNULL],[Notes|VARCHAR|NOTNULL],[ClientOrderNo|VARCHAR|NOTNULL],[DateCreated|DATETIME|NOTNULL],[QuoteID|INTEGER|NULL],[DateConfirmed|DATETIME|NULL],[DateDeclined|DATETIME|NULL],[AppointmentCategoryID|INTEGER|NULL],[ProjectAppointmentId|INTEGER|NULL],[AppointmentGroupId|INTEGER|NULL],[BranchOfficeID|INTEGER|NOTNULL] FROM @AppointmentTable
	DECLARE @JobTable TABLE ([JobID|INTEGER|NOTNULL] INT NOT NULL ,[JobNo|INTEGER|NOTNULL] INT NOT NULL ,[ClientID|INTEGER|NOTNULL] INT NOT NULL ,[SiteID|INTEGER|NULL] INT NULL ,[ClientOrderNo|VARCHAR|NULL] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[ProjectManagerID|INTEGER|NULL] INT NULL) INSERT INTO @JobTable ([JobID|INTEGER|NOTNULL],[JobNo|INTEGER|NOTNULL],[ClientID|INTEGER|NOTNULL],[SiteID|INTEGER|NULL],[ClientOrderNo|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[ProjectManagerID|INTEGER|NULL]) Select j.[JobID],j.[JobNo],j.[ClientID],j.[SiteID],j.[ClientOrderNo],j.[Created],j.[ProjectManagerID] FROM Job j WITH (NOLOCK) INNER JOIN (SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID) jqa ON j.JobID = jqa.JobID SELECT [JobID|INTEGER|NOTNULL],[JobNo|INTEGER|NOTNULL],[ClientID|INTEGER|NOTNULL],[SiteID|INTEGER|NULL],[ClientOrderNo|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[ProjectManagerID|INTEGER|NULL] FROM @JobTable
	DECLARE @QuoteTable TABLE ([QuoteID|INTEGER|NOTNULL] INT NOT NULL ,[QuoteTypeID|INTEGER|NULL] INT NULL ,[QuoteNo|INTEGER|NOTNULL] INT NOT NULL ,[ScopeOfWork|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL DEFAULT (''),[Status|VARCHAR|NULL] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[Accepted|DATETIME|NULL] DATETIME NULL ,[JobID|INTEGER|NULL] INT NULL ,[Rejected|DATETIME|NULL] DATETIME NULL ,[Exclusions|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @QuoteTable ([QuoteID|INTEGER|NOTNULL],[QuoteTypeID|INTEGER|NULL],[QuoteNo|INTEGER|NOTNULL],[ScopeOfWork|VARCHAR|NOTNULL],[Status|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[Accepted|DATETIME|NULL],[JobID|INTEGER|NULL],[Rejected|DATETIME|NULL],[Exclusions|VARCHAR|NULL]) Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID	SELECT [QuoteID|INTEGER|NOTNULL],[QuoteTypeID|INTEGER|NULL],[QuoteNo|INTEGER|NOTNULL],[ScopeOfWork|VARCHAR|NOTNULL],[Status|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[Accepted|DATETIME|NULL],[JobID|INTEGER|NULL],[Rejected|DATETIME|NULL],[Exclusions|VARCHAR|NULL] FROM @QuoteTable
*/
/*
	--Select c.[ClientID],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode] FROM Client c WITH (NOLOCK) INNER JOIN (SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID) jqa ON c.ClientID=jqa.ClientID
	--Select si.[SiteID],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] FROM Site si WITH (NOLOCK) INNER JOIN (SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID) jqa ON si.SiteID=jqa.SiteID
	--Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID] FROM Appointment a WITH (NOLOCK) INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID 
	--Select j.[JobID],j.[JobNo],j.[ClientID],j.[SiteID],j.[ClientOrderNo],j.[Created],j.[ProjectManagerID] FROM Job j WITH (NOLOCK) INNER JOIN (SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID) jqa ON j.JobID = jqa.JobID
	--Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID
*/
	--DECLARE @AppointmentSurveyTable TABLE ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL,[SurveyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[PropertyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[DueDate|DATETIME|NULL||] DATETIME NULL)	INSERT INTO @AppointmentSurveyTable ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||]) Select asu.[AppointmentSurveyID],asu.[AppointmentID],asu.[SurveyTypeID],asu.[PropertyTypeID],asu.[DueDate] FROM AppointmentSurvey asu WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=asu.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||] FROM @AppointmentSurveyTable GROUP BY [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||]
	DECLARE @AppointmentSurveyTable TABLE ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL,[SurveyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[PropertyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[DueDate|DATETIME|NOTNULL||] DATETIME NOT NULL)	INSERT INTO @AppointmentSurveyTable ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||]) Select asu.[AppointmentSurveyID],asu.[AppointmentID],asu.[SurveyTypeID],asu.[PropertyTypeID], ISNULL(asu.[DueDate], GETDATE()) [DueDate] FROM AppointmentSurvey asu WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=asu.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||] FROM @AppointmentSurveyTable GROUP BY [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||]
	DECLARE @AppointmentAirMonitoringTable TABLE ([AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL ,[NumberOfPumps|INTEGER|NOTNULL||] INT NOT NULL,[RemovalContractorID|INTEGER|NOTNULL||] INT NOT NULL,[SampleResultID|INTEGER|NULL||] INT NULL)	INSERT INTO @AppointmentAirMonitoringTable ([AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[NumberOfPumps|INTEGER|NOTNULL||],[RemovalContractorID|INTEGER|NOTNULL||],[SampleResultID|INTEGER|NULL||]) Select aam.[AppointmentAirMonitoringID],aam.[AppointmentID],aam.[NumberOfPumps],aam.[RemovalContractorID],aam.SampleResultID FROM AppointmentAirMonitoring aam WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[NumberOfPumps|INTEGER|NOTNULL||],[RemovalContractorID|INTEGER|NOTNULL||],[SampleResultID|INTEGER|NULL||] FROM @AppointmentAirMonitoringTable
	DECLARE @AppointmentAirMonitoringTypeTable TABLE ([AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentAirMonitoringID|INTEGER|NOTNULL||] INT NOT NULL ,[AirTestTypeID|INTEGER|NOTNULL||] INT NOT NULL)	INSERT INTO @AppointmentAirMonitoringTypeTable ([AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[AirTestTypeID|INTEGER|NOTNULL||]) Select aamt.[AppointmentAirMonitoringTypeID],aamt.[AppointmentAirMonitoringID],aamt.[AirTestTypeID] FROM AppointmentAirMonitoringType aamt WITH (NOLOCK) INNER JOIN AppointmentAirMonitoring aam WITH (NOLOCK) ON aamt.AppointmentAirMonitoringID=aam.AppointmentAirMonitoringID INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[AirTestTypeID|INTEGER|NOTNULL||] FROM @AppointmentAirMonitoringTypeTable
	DECLARE @AppointmentAirMonitoringSampleClassificationTable TABLE ([AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentAirMonitoringID|INTEGER|NOTNULL||] INT NOT NULL ,[SampleClassificationID|INTEGER|NOTNULL||] INT NOT NULL)	INSERT INTO @AppointmentAirMonitoringSampleClassificationTable ([AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[SampleClassificationID|INTEGER|NOTNULL||]) Select aamsc.[AppointmentAirMonitoringSampleClassificationID],aamsc.[AppointmentAirMonitoringID],aamsc.[SampleClassificationID] FROM AppointmentAirMonitoringSampleClassification aamsc WITH (NOLOCK) INNER JOIN AppointmentAirMonitoring aam  WITH (NOLOCK) ON aamsc.AppointmentAirMonitoringID=aam.AppointmentAirMonitoringID INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[SampleClassificationID|INTEGER|NOTNULL||] FROM @AppointmentAirMonitoringSampleClassificationTable

	--------------------------------------------------------
	-- Clients - PJL: I split these up so I could read them!
	DECLARE @ClientTable TABLE ([ClientID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[ClientName|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[ClientAddress|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL  ,[Email|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Telephone|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Fax|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[MainContact|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[EnterpriseServerCode|VARCHAR|NULL||] VARCHAR(MAX) NULL,[EnterpriseAuthEnc|VARCHAR|NULL||] VARCHAR(MAX) NULL )	
	
	INSERT INTO @ClientTable ([ClientID|INTEGER|NOTNULL||SERVERKEY],[ClientName|VARCHAR|NOTNULL||],[ClientAddress|VARCHAR|NOTNULL||],[Email|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Fax|VARCHAR|NOTNULL||],[MainContact|VARCHAR|NOTNULL||],[EnterpriseServerCode|VARCHAR|NULL||],[EnterpriseAuthEnc|VARCHAR|NULL||]) 
		Select 
			c.[ClientID],c.[Client],c.[Address],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode], c.[EnterpriseAuthEnc]
		FROM 
			Client c WITH (NOLOCK) 
			INNER JOIN (
				SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID UNION SELECT [RemovalContractorID|INTEGER|NOTNULL||] [ClientID] FROM @AppointmentAirMonitoringTable GROUP BY [RemovalContractorID|INTEGER|NOTNULL||]
			) jqa ON c.ClientID=jqa.ClientID 

	SELECT [ClientID|INTEGER|NOTNULL||SERVERKEY],[ClientName|VARCHAR|NOTNULL||],[ClientAddress|VARCHAR|NOTNULL||],[Email|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Fax|VARCHAR|NOTNULL||],[MainContact|VARCHAR|NOTNULL||],[EnterpriseServerCode|VARCHAR|NULL||],[EnterpriseAuthEnc|VARCHAR|NULL||] FROM @ClientTable
	--------------------------------------------------------
	

	--------------------------------------------------------
	-- Sites - PJL: I split these up so I could read them!
	DECLARE @SiteTable TABLE ([SiteID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[SiteAddress|VARCHAR|NOTNULL||] VARCHAR(MAX), [Telephone|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Contact|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[UPRN|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[ClientOrderNumber|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[TEAMSUPRN|VARCHAR|NULL||] VARCHAR(MAX) NULL )

	INSERT INTO @SiteTable ([SiteID|INTEGER|NOTNULL||SERVERKEY],[SiteAddress|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Contact|VARCHAR|NOTNULL||],[UPRN|VARCHAR|NULL||],[ClientOrderNumber|VARCHAR|NULL||],[TEAMSUPRN|VARCHAR|NULL||]) 
		Select 
			si.[SiteID],si.[Address] + ', ' + si.[Postcode] [SiteAddress],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] 
		FROM 
			Site si WITH (NOLOCK) 
			INNER JOIN (
				SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID UNION SELECT s [SiteID] FROM dbo.SplitString(@ExtraSiteIds,',')
			) jqa ON si.SiteID=jqa.SiteID	

	SELECT [SiteID|INTEGER|NOTNULL||SERVERKEY],[SiteAddress|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Contact|VARCHAR|NOTNULL||],[UPRN|VARCHAR|NULL||],[ClientOrderNumber|VARCHAR|NULL||],[TEAMSUPRN|VARCHAR|NULL||] FROM @SiteTable
	--------------------------------------------------------


	DECLARE @AppointmentTable TABLE ([AppointmentID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[AppointmentTypeID|INTEGER|NOTNULL||] INT NOT NULL ,[ClientID|INTEGER|NULL|Client|] INT NULL ,[SiteID|INTEGER|NULL|Site|] INT NULL ,[StartTime|DATETIME|NOTNULL||] DATETIME NOT NULL ,[EndTime|DATETIME|NOTNULL||] DATETIME NOT NULL ,[Notes|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[ClientOrderNo|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[DateCreated|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[QuoteID|INTEGER|NULL||] INT NULL ,[DateConfirmed|DATETIME|NULL||] DATETIME NULL ,[DateDeclined|DATETIME|NULL||] DATETIME NULL ,[AppointmentCategoryID|INTEGER|NULL||] INT NULL DEFAULT (NULL),[ProjectAppointmentId|INTEGER|NULL||] INT NULL ,[AppointmentGroupId|INTEGER|NULL||] INT NULL ,[BranchOfficeID|INTEGER|NOTNULL||] INT NOT NULL DEFAULT ((0)), [SiteAlert|VARCHAR|NULL||] VARCHAR(MAX))	INSERT INTO @AppointmentTable ([AppointmentID|INTEGER|NOTNULL||SERVERKEY],[AppointmentTypeID|INTEGER|NOTNULL||],[ClientID|INTEGER|NULL|Client|],[SiteID|INTEGER|NULL|Site|],[StartTime|DATETIME|NOTNULL||],[EndTime|DATETIME|NOTNULL||],[Notes|VARCHAR|NOTNULL||],[ClientOrderNo|VARCHAR|NOTNULL||],[DateCreated|DATETIME|NOTNULL||],[QuoteID|INTEGER|NULL||],[DateConfirmed|DATETIME|NULL||],[DateDeclined|DATETIME|NULL||],[AppointmentCategoryID|INTEGER|NULL||],[ProjectAppointmentId|INTEGER|NULL||],[AppointmentGroupId|INTEGER|NULL||],[BranchOfficeID|INTEGER|NOTNULL||],[SiteAlert|VARCHAR|NULL||]) Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID], cs.SiteAlerts FROM Appointment a WITH (NOLOCK) LEFT OUTER JOIN Site si WITH (NOLOCK) ON a.SiteID=si.SiteID LEFT OUTER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID AND cs.ClientID=a.ClientID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentID|INTEGER|NOTNULL||SERVERKEY],[AppointmentTypeID|INTEGER|NOTNULL||],[ClientID|INTEGER|NULL|Client|],[SiteID|INTEGER|NULL|Site|],[StartTime|DATETIME|NOTNULL||],[EndTime|DATETIME|NOTNULL||],[Notes|VARCHAR|NOTNULL||],[ClientOrderNo|VARCHAR|NOTNULL||],[DateCreated|DATETIME|NOTNULL||],[QuoteID|INTEGER|NULL||],[DateConfirmed|DATETIME|NULL||],[DateDeclined|DATETIME|NULL||],[AppointmentCategoryID|INTEGER|NULL||],[ProjectAppointmentId|INTEGER|NULL||],[AppointmentGroupId|INTEGER|NULL||],[BranchOfficeID|INTEGER|NOTNULL||],[SiteAlert|VARCHAR|NULL||] FROM @AppointmentTable
	DECLARE @AppointmentEmployeeTable TABLE ([AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL ,[EmployeeID|INTEGER|NULL||] INT NULL)	INSERT INTO @AppointmentEmployeeTable ([AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NULL||]) Select ae.[AppointmentEmployeeID],ae.[AppointmentID],ae.[EmployeeID] FROM AppointmentEmployee ae WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=ae.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NULL||] FROM @AppointmentEmployeeTable
	DECLARE @JobTable TABLE ( [JobID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL, [JobNo|INTEGER|NOTNULL||] INT NOT NULL, [ClientID|INTEGER|NOTNULL|Client|] INT NOT NULL, [SiteID|INTEGER|NULL|Site|] INT NULL, [ClientOrderNo|VARCHAR|NULL||] VARCHAR(MAX) NULL, [Created|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT ( getdate() ), [ProjectManagerID|INTEGER|NULL||] INT NULL, [HasSiteData|INTEGER|NULL||] INT NULL, [Notes|VARCHAR|NULL||] VARCHAR(MAX), [SiteAlert|VARCHAR|NULL||] VARCHAR(MAX) ) INSERT INTO @JobTable ( [JobID|INTEGER|NOTNULL||SERVERKEY], [JobNo|INTEGER|NOTNULL||], [ClientID|INTEGER|NOTNULL|Client|], [SiteID|INTEGER|NULL|Site|], [ClientOrderNo|VARCHAR|NULL||], [Created|DATETIME|NOTNULL||], [ProjectManagerID|INTEGER|NULL||], [HasSiteData|INTEGER|NULL||], [Notes|VARCHAR|NULL||], [SiteAlert|VARCHAR|NULL||] ) Select j.[JobID], j.[JobNo], j.[ClientID], j.[SiteID], j.[ClientOrderNo], j.[Created], j.[ProjectManagerID], CASE WHEN sd.DataCount > 0 THEN 1 END [HasSiteData], ( SELECT top 1 a.Notes FROM @JobQuoteAppointmentIDList jqal INNER JOIN Appointment a WITH (NOLOCK) ON jqal.AppointmentID = a.AppointmentID WHERE jqal.JobID = j.JobID ), cs.SiteAlerts FROM Job j WITH (NOLOCK) INNER JOIN ( SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID ) jqa ON j.JobID = jqa.JobID OUTER APPLY ( SELECT COUNT(*) [DataCount] FROM Site subSi WITH (NOLOCK) INNER JOIN Job subJ WITH (NOLOCK) ON subSi.SiteID = subJ.SiteID INNER JOIN JobEmployee subje WITH (NOLOCK) ON subje.JobID = subj.JobID INNER JOIN Register subr WITH (NOLOCK) ON subje.JobEmployeeID = subr.JobEmployeeID INNER JOIN Floorplan subfp WITH (NOLOCK) ON subfp.RegisterID = subr.RegisterID WHERE subSi.SiteID = j.SiteID ) sd INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID AND cs.ClientID=j.ClientID SELECT [JobID|INTEGER|NOTNULL||SERVERKEY], [JobNo|INTEGER|NOTNULL||], [ClientID|INTEGER|NOTNULL|Client|], [SiteID|INTEGER|NULL|Site|], [ClientOrderNo|VARCHAR|NULL||], [Created|DATETIME|NOTNULL||], [ProjectManagerID|INTEGER|NULL||], [HasSiteData|INTEGER|NULL||], [Notes|VARCHAR|NULL||], [SiteAlert|VARCHAR|NULL||] FROM @JobTable
	DECLARE @QuoteTable TABLE ([QuoteID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteTypeID|INTEGER|NULL||] INT NULL ,[QuoteNo|INTEGER|NOTNULL||] INT NOT NULL ,[ScopeOfWork|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL DEFAULT (''),[Status|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[Accepted|DATETIME|NULL||] DATETIME NULL ,[JobID|INTEGER|NULL|Job|] INT NULL ,[Rejected|DATETIME|NULL||] DATETIME NULL ,[Exclusions|VARCHAR|NULL||] VARCHAR(MAX) NULL )	INSERT INTO @QuoteTable ([QuoteID|INTEGER|NOTNULL||SERVERKEY],[QuoteTypeID|INTEGER|NULL||],[QuoteNo|INTEGER|NOTNULL||],[ScopeOfWork|VARCHAR|NOTNULL||],[Status|VARCHAR|NULL||],[Created|DATETIME|NOTNULL||],[Accepted|DATETIME|NULL||],[JobID|INTEGER|NULL|Job|],[Rejected|DATETIME|NULL||],[Exclusions|VARCHAR|NULL||]) Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID SELECT [QuoteID|INTEGER|NOTNULL||SERVERKEY],[QuoteTypeID|INTEGER|NULL||],[QuoteNo|INTEGER|NOTNULL||],[ScopeOfWork|VARCHAR|NOTNULL||],[Status|VARCHAR|NULL||],[Created|DATETIME|NOTNULL||],[Accepted|DATETIME|NULL||],[JobID|INTEGER|NULL|Job|],[Rejected|DATETIME|NULL||],[Exclusions|VARCHAR|NULL||] FROM @QuoteTable

	DECLARE @QuoteEmployeeTable TABLE ([QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteID|INTEGER|NOTNULL||] INT NOT NULL ,[EmployeeID|INTEGER|NOTNULL||] INT NOT NULL ,[ScheduledStart|DATETIME|NULL||] DATETIME NULL ,[ScheduledFinish|DATETIME|NULL||] DATETIME NULL ,[ActualStart|DATETIME|NULL||] DATETIME NULL ,[ActualFinish|DATETIME|NULL||] DATETIME NULL )	INSERT INTO @QuoteEmployeeTable ([QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY],[QuoteID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NOTNULL||],[ScheduledStart|DATETIME|NULL||],[ScheduledFinish|DATETIME|NULL||],[ActualStart|DATETIME|NULL||],[ActualFinish|DATETIME|NULL||])	Select qe.[QuoteEmployeeID],qe.[QuoteID],qe.[EmployeeID],qe.[ScheduledStart],qe.[ScheduledFinish],qe.[ActualStart],qe.[ActualFinish] FROM QuoteEmployee qe INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) q ON qe.QuoteID=q.QuoteID AND qe.EmployeeID>0 SELECT [QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY],[QuoteID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NOTNULL||],[ScheduledStart|DATETIME|NULL||],[ScheduledFinish|DATETIME|NULL||],[ActualStart|DATETIME|NULL||],[ActualFinish|DATETIME|NULL||] FROM @QuoteEmployeeTable
	DECLARE @QuoteVisitTable TABLE ([QuoteVisitID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteVisitTypeID|INTEGER|NOTNULL||] INT NOT NULL ,[QuoteEmployeeID|INTEGER|NULL||] INT NULL ,[QuoteVisitStart|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[QuoteVisitFinish|DATETIME|NULL||] DATETIME NULL ,[Notes|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[PhotoID|INTEGER|NULL||] INT NULL ,[SystemName|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Closed|BIT|NOTNULL||] BIT NOT NULL DEFAULT ((0)),[Finished|BIT|NOTNULL||] BIT NOT NULL DEFAULT ((0)),[SignatureID|INTEGER|NULL||] INT NULL ,[_QuoteVisitConsumableMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL ,[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL ,[_QuoteVisitLabourMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL )	INSERT INTO @QuoteVisitTable ([QuoteVisitID|INTEGER|NOTNULL||SERVERKEY],[QuoteVisitTypeID|INTEGER|NOTNULL||],[QuoteEmployeeID|INTEGER|NULL||],[QuoteVisitStart|DATETIME|NOTNULL||],[QuoteVisitFinish|DATETIME|NULL||],[Notes|VARCHAR|NULL||],[PhotoID|INTEGER|NULL||],[SystemName|VARCHAR|NOTNULL||],[Closed|BIT|NOTNULL||],[Finished|BIT|NOTNULL||],[SignatureID|INTEGER|NULL||],[_QuoteVisitConsumableMarkup|DECIMAL|NULL||],[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||],[_QuoteVisitLabourMarkup|DECIMAL|NULL||]) Select qv.[QuoteVisitID],qv.[QuoteVisitTypeID],qv.[QuoteEmployeeID],qv.[QuoteVisitStart],qv.[QuoteVisitFinish],qv.[Notes],qv.[PhotoID],qv.[SystemName],qv.[Closed],qv.[Finished],qv.[SignatureID],qv.[_QuoteVisitConsumableMarkup],qv.[_QuoteVisitEquipmentMarkup],qv.[_QuoteVisitLabourMarkup] FROM QuoteVisit qv INNER JOIN @QuoteEmployeeTable qet ON qet.[QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY]=qv.QuoteEmployeeID	SELECT [QuoteVisitID|INTEGER|NOTNULL||SERVERKEY],[QuoteVisitTypeID|INTEGER|NOTNULL||],[QuoteEmployeeID|INTEGER|NULL||],[QuoteVisitStart|DATETIME|NOTNULL||],[QuoteVisitFinish|DATETIME|NULL||],[Notes|VARCHAR|NULL||],[PhotoID|INTEGER|NULL||],[SystemName|VARCHAR|NOTNULL||],[Closed|BIT|NOTNULL||],[Finished|BIT|NOTNULL||],[SignatureID|INTEGER|NULL||],[_QuoteVisitConsumableMarkup|DECIMAL|NULL||],[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||],[_QuoteVisitLabourMarkup|DECIMAL|NULL||] FROM @QuoteVisitTable
	DECLARE @DataCollectionTable TABLE ([DataCollectionID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[DataCollectionQuestionID|INTEGER|NOTNULL||] INT NOT NULL ,[DataText|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[DataInt|INTEGER|NULL||] INT NULL ,[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||] INT NULL ,[Deleted|DATETIME|NULL||] DATETIME NULL ,[QuoteVisitID|INTEGER|NULL||] INT NULL ,[DataCollectionCategoryTypeID|INTEGER|NOTNULL||] INT NOT NULL )	INSERT INTO @DataCollectionTable ([DataCollectionID|INTEGER|NOTNULL||SERVERKEY],[DataCollectionQuestionID|INTEGER|NOTNULL||],[DataText|VARCHAR|NULL||],[DataInt|INTEGER|NULL||],[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||],[Deleted|DATETIME|NULL||],[QuoteVisitID|INTEGER|NULL||],[DataCollectionCategoryTypeID|INTEGER|NOTNULL||])	Select dc.[DataCollectionID],dc.[DataCollectionQuestionID],dc.[DataText],dc.[DataInt],dc.[DataCollectionQuestionOptionOrInsertID],dc.[Deleted],dc.[QuoteVisitID],dc.[DataCollectionCategoryTypeID] FROM DataCollection	dc INNER JOIN @QuoteVisitTable qvt ON dc.QuoteVisitID=qvt.[QuoteVisitID|INTEGER|NOTNULL||SERVERKEY] SELECT [DataCollectionID|INTEGER|NOTNULL||SERVERKEY],[DataCollectionQuestionID|INTEGER|NOTNULL||],[DataText|VARCHAR|NULL||],[DataInt|INTEGER|NULL||],[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||],[Deleted|DATETIME|NULL||],[QuoteVisitID|INTEGER|NULL||],[DataCollectionCategoryTypeID|INTEGER|NOTNULL||] FROM @DataCollectionTable


	SET NOCOUNT OFF;
END

GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'FloorplanRerender_GetRooms') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[FloorplanRerender_GetRooms] AS BEGIN SET NOCOUNT ON; END')
End

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[FloorplanRerender_GetRooms]    Script Date: 15/01/2019 10:28:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[FloorplanRerender_GetRooms]
      @FloorplanID int
As

Begin
      Set NoCount On
      
      DECLARE @JobID INT = (SELECT j.JobID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      DECLARE @SurveyTypeID INT = (SELECT su.SurveyTypeID FROM Job j INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID INNER JOIN Survey su ON su.SurveyID = r.SurveyID INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID WHERE fp.FloorplanID=@FloorplanID)
      
      DECLARE @SampleData TABLE (SampleID INT, SampleRef VARCHAR(MAX), AsSample BIT, SampleResultValue INT, Inaccessible INT,RoomID INT,FloorplanID INT,ReinspectionElementIntMeaningID INT)
      
	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 1 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            CASE WHEN e48.ElementIntMeaningID=121 THEN
                        0
                  ELSE
                        COALESCE(sr.Value,e8.ElementIntID,-1)
            END,
            CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID,
			e48.ElementIntMeaningID
      FROM
            job j WITH (NOLOCK)
            inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
            INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
            INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
            INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
            LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
            LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
            LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
            LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
      WHERE
            je.JobID = @JobID
                  AND
            su.SurveyTypeID = @SurveyTypeID
	  END

	  If (SELECT ISNULL((SELECT TOP 1 MobileConfigInt FROM MobileConfig WHERE MobileConfigTypeID=51),0)) = 0 BEGIN
		  INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID,ReinspectionElementIntMeaningID)
		  SELECT
				s.SampleID,
				s.SampleRef,
				s.AsSample,
				COALESCE(sr.Value,e8.ElementIntID,-1),
				CASE WHEN rm.Inaccessible = 1 OR IsNull(e5.ElementIntID,1)=0 THEN 
					  1 
				ELSE
					  0 
				END,
				rm.RoomID,
				f.FloorplanID,
				e48.ElementIntMeaningID
		  FROM
				job j WITH (NOLOCK)
				inner join JobEmployee je WITH (NOLOCK) on je.jobid = j.jobid
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
				INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
				INNER JOIN [Floor] fp WITH (NOLOCK) ON f.FloorNumber = fp.[Floor]
				INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
				INNER JOIN [Sample] s WITH (NOLOCK) ON s.RoomID = rm.RoomID
				LEFT OUTER JOIN Element e5 WITH (NOLOCK) ON e5.SampleID=s.SampleID AND e5.ElementTypeID=5
				LEFT OUTER JOIN Element e8 WITH (NOLOCK) ON e8.SampleID=s.SampleID AND e8.ElementTypeID=8
				LEFT OUTER JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID=eim8.ElementIntMeaningID
				LEFT OUTER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
				LEFT OUTER JOIN Element e48 WITH (NOLOCK) ON e48.SampleID=s.SampleID AND e48.ElementTypeID=48
		  WHERE
				f.FloorplanID=@FloorplanID
					AND
		        je.JobID = @JobID
					  AND
				su.SurveyTypeID = @SurveyTypeID
	  END
      
      INSERT INTO @SampleData (SampleID,SampleRef,AsSample,SampleResultValue,Inaccessible,RoomID,FloorplanID)
      SELECT DISTINCT
            s.SampleID,
            s.SampleRef,
            s.AsSample,
            sr.Value,
            CASE WHEN rm.Inaccessible = 1 THEN 
                  1 
            ELSE
                  0 
            END,
            rm.RoomID,
            f.FloorplanID
      FROM
            @SampleData sd
            INNER JOIN Sample s ON sd.SampleRef=s.SampleRef AND s.AsSample=0 AND (Select COUNT(*) FROM @SampleData subSD Where subSD.AsSample=0 AND subSD.SampleRef=sd.SampleRef)=0
            INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID = s.RoomID
            INNER JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID=sr.SampleResultID
            INNER JOIN Floorplan f WITH (NOLOCK) ON f.FloorplanID = rm.FloorplanID
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=f.RegisterID
			INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
			INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			INNER JOIN job j WITH (NOLOCK) on je.jobid = j.jobid
		WHERE
			je.JobID = @JobID
				AND
			su.SurveyTypeID = @SurveyTypeID
      
      Update @SampleData
            Set SampleResultValue=(Select subSD.SampleResultValue FROM @SampleData subSD Where subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
      FROM @SampleData updateSD 
      Where (updateSD.AsSample=1)
      
      Select RoomID,
            CASE WHEN MAX(SampleResultValue) > 0 THEN
                  'Asbestos'
            ELSE
                  CASE WHEN MAX(Inaccessible) > 0 THEN
                        'Inaccessible'
                  ELSE
					CASE WHEN MAX(SampleResultValue) = 0 THEN
                        'Negative Asbestos'
					END
                  END
            END [OverlayType]
      FROM @SampleData
      Group By RoomID
      
End
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__OfficeFloorplanDesigner') < 1
BEGIN
  ALTER TABLE Config
      ADD b__OfficeFloorplanDesigner BIT NOT NULL DEFAULT 0
END
GO

UPDATE Config SET b__OfficeFloorplanDesigner = 1 WHERE ConfigId = 1
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'mobile_Surveying_v2.4.2.13_DataTransfer_JobQuoteAppointment') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[mobile_Surveying_v2.4.2.13_DataTransfer_JobQuoteAppointment] AS BEGIN SET NOCOUNT ON; END')
End
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[mobile_Surveying_v2.4.2.13_DataTransfer_JobQuoteAppointment]    Script Date: 31/01/2019 09:16:27 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[mobile_Surveying_v2.4.2.13_DataTransfer_JobQuoteAppointment]
(
	@SystemName nvarchar(MAX),
	@Version nvarchar(MAX),
	@EmployeeID INT,
	@AppointmentWindowDate DATETIME = NULL,
	@QuoteList VARCHAR(MAX) = '',
	@ExtraClientIds VARCHAR(MAX) = '',
	@ExtraSiteIds VARCHAR(MAX) = ''
)
AS
BEGIN
	SET NOCOUNT ON;
	
	SET @AppointmentWindowDate = ISNULL(@AppointmentWindowDate,GETDATE())
	
	DECLARE @JobQuoteAppointmentIDList TABLE (ClientID INT, SiteID INT,JobID INT, QuoteID INT, AppointmentID INT)
	INSERT INTO @JobQuoteAppointmentIDList (ClientID,SiteID,JobID,QuoteID,AppointmentID)
	SELECT 
		q.ClientID,
		q.SiteID,
		j.JobID,
		q.QuoteID,
		a.AppointmentID
	FROM 
		Appointment a
		INNER JOIN AppointmentEmployee ae ON a.AppointmentID = ae.AppointmentID 
		LEFT OUTER JOIN Quote q ON q.QuoteID=a.QuoteID
		LEFT OUTER JOIN Site si ON q.SiteID = si.SiteID
		LEFT OUTER JOIN Client c ON c.ClientID = q.ClientID
		LEFT OUTER JOIN Project p ON a.ProjectID = p.ProjectID 
		LEFT OUTER JOIN Job j ON q.JobID = j.JobID
	WHERE 
		@AppointmentWindowDate BETWEEN DATEADD(DAY,-6, a.StartTime) AND DATEADD(DAY, 3, a.EndTime)
			AND 
		ae.EmployeeID=@EmployeeID
			AND 
		a.DateDeclined IS NULL

	INSERT INTO @JobQuoteAppointmentIDList (ClientID)
	SELECT
		a.ClientID
	FROM
	(
		SELECT 
			ClientID
		FROM
			ClientSpecificElement
		UNION
		SELECT
			s [ClientID]
		FROM
			dbo.SplitString(@ExtraClientIds,',')
	) a
	GROUP BY
		a.ClientID

/*
	ORIGINAL
	DECLARE @ClientTable TABLE ([ClientID|INTEGER|NOTNULL] INT NOT NULL ,[Email|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Telephone|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Fax|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[MainContact|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[EnterpriseServerCode|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @ClientTable ([ClientID|INTEGER|NOTNULL],[Email|VARCHAR|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Fax|VARCHAR|NOTNULL],[MainContact|VARCHAR|NOTNULL],[EnterpriseServerCode|VARCHAR|NULL]) Select c.[ClientID],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode] FROM Client c WITH (NOLOCK) INNER JOIN (SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID) jqa ON c.ClientID=jqa.ClientID SELECT [ClientID|INTEGER|NOTNULL],[Email|VARCHAR|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Fax|VARCHAR|NOTNULL],[MainContact|VARCHAR|NOTNULL],[EnterpriseServerCode|VARCHAR|NULL] FROM @ClientTable
	DECLARE @SiteTable TABLE ([SiteID|INTEGER|NOTNULL] INT NOT NULL ,[Telephone|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[Contact|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[UPRN|VARCHAR|NULL] VARCHAR(MAX) NULL ,[ClientOrderNumber|VARCHAR|NULL] VARCHAR(MAX) NULL ,[TEAMSUPRN|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @SiteTable ([SiteID|INTEGER|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Contact|VARCHAR|NOTNULL],[UPRN|VARCHAR|NULL],[ClientOrderNumber|VARCHAR|NULL],[TEAMSUPRN|VARCHAR|NULL]) Select si.[SiteID],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] FROM Site si WITH (NOLOCK) INNER JOIN (SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID) jqa ON si.SiteID=jqa.SiteID	SELECT [SiteID|INTEGER|NOTNULL],[Telephone|VARCHAR|NOTNULL],[Contact|VARCHAR|NOTNULL],[UPRN|VARCHAR|NULL],[ClientOrderNumber|VARCHAR|NULL],[TEAMSUPRN|VARCHAR|NULL] FROM @SiteTable
	DECLARE @AppointmentTable TABLE ([AppointmentID|INTEGER|NOTNULL] INT NOT NULL ,[AppointmentTypeID|INTEGER|NOTNULL] INT NOT NULL ,[ClientID|INTEGER|NULL] INT NULL ,[SiteID|INTEGER|NULL] INT NULL ,[StartTime|DATETIME|NOTNULL] DATETIME NOT NULL ,[EndTime|DATETIME|NOTNULL] DATETIME NOT NULL ,[Notes|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[ClientOrderNo|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL ,[DateCreated|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[QuoteID|INTEGER|NULL] INT NULL ,[DateConfirmed|DATETIME|NULL] DATETIME NULL ,[DateDeclined|DATETIME|NULL] DATETIME NULL ,[AppointmentCategoryID|INTEGER|NULL] INT NULL DEFAULT (NULL),[ProjectAppointmentId|INTEGER|NULL] INT NULL ,[AppointmentGroupId|INTEGER|NULL] INT NULL ,[BranchOfficeID|INTEGER|NOTNULL] INT NOT NULL DEFAULT ((0))) INSERT INTO @AppointmentTable ([AppointmentID|INTEGER|NOTNULL],[AppointmentTypeID|INTEGER|NOTNULL],[ClientID|INTEGER|NULL],[SiteID|INTEGER|NULL],[StartTime|DATETIME|NOTNULL],[EndTime|DATETIME|NOTNULL],[Notes|VARCHAR|NOTNULL],[ClientOrderNo|VARCHAR|NOTNULL],[DateCreated|DATETIME|NOTNULL],[QuoteID|INTEGER|NULL],[DateConfirmed|DATETIME|NULL],[DateDeclined|DATETIME|NULL],[AppointmentCategoryID|INTEGER|NULL],[ProjectAppointmentId|INTEGER|NULL],[AppointmentGroupId|INTEGER|NULL],[BranchOfficeID|INTEGER|NOTNULL]) Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID] FROM Appointment a WITH (NOLOCK) INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID SELECT [AppointmentID|INTEGER|NOTNULL],[AppointmentTypeID|INTEGER|NOTNULL],[ClientID|INTEGER|NULL],[SiteID|INTEGER|NULL],[StartTime|DATETIME|NOTNULL],[EndTime|DATETIME|NOTNULL],[Notes|VARCHAR|NOTNULL],[ClientOrderNo|VARCHAR|NOTNULL],[DateCreated|DATETIME|NOTNULL],[QuoteID|INTEGER|NULL],[DateConfirmed|DATETIME|NULL],[DateDeclined|DATETIME|NULL],[AppointmentCategoryID|INTEGER|NULL],[ProjectAppointmentId|INTEGER|NULL],[AppointmentGroupId|INTEGER|NULL],[BranchOfficeID|INTEGER|NOTNULL] FROM @AppointmentTable
	DECLARE @JobTable TABLE ([JobID|INTEGER|NOTNULL] INT NOT NULL ,[JobNo|INTEGER|NOTNULL] INT NOT NULL ,[ClientID|INTEGER|NOTNULL] INT NOT NULL ,[SiteID|INTEGER|NULL] INT NULL ,[ClientOrderNo|VARCHAR|NULL] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[ProjectManagerID|INTEGER|NULL] INT NULL) INSERT INTO @JobTable ([JobID|INTEGER|NOTNULL],[JobNo|INTEGER|NOTNULL],[ClientID|INTEGER|NOTNULL],[SiteID|INTEGER|NULL],[ClientOrderNo|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[ProjectManagerID|INTEGER|NULL]) Select j.[JobID],j.[JobNo],j.[ClientID],j.[SiteID],j.[ClientOrderNo],j.[Created],j.[ProjectManagerID] FROM Job j WITH (NOLOCK) INNER JOIN (SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID) jqa ON j.JobID = jqa.JobID SELECT [JobID|INTEGER|NOTNULL],[JobNo|INTEGER|NOTNULL],[ClientID|INTEGER|NOTNULL],[SiteID|INTEGER|NULL],[ClientOrderNo|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[ProjectManagerID|INTEGER|NULL] FROM @JobTable
	DECLARE @QuoteTable TABLE ([QuoteID|INTEGER|NOTNULL] INT NOT NULL ,[QuoteTypeID|INTEGER|NULL] INT NULL ,[QuoteNo|INTEGER|NOTNULL] INT NOT NULL ,[ScopeOfWork|VARCHAR|NOTNULL] VARCHAR(MAX) NOT NULL DEFAULT (''),[Status|VARCHAR|NULL] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL] DATETIME NOT NULL DEFAULT (getdate()),[Accepted|DATETIME|NULL] DATETIME NULL ,[JobID|INTEGER|NULL] INT NULL ,[Rejected|DATETIME|NULL] DATETIME NULL ,[Exclusions|VARCHAR|NULL] VARCHAR(MAX) NULL )	INSERT INTO @QuoteTable ([QuoteID|INTEGER|NOTNULL],[QuoteTypeID|INTEGER|NULL],[QuoteNo|INTEGER|NOTNULL],[ScopeOfWork|VARCHAR|NOTNULL],[Status|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[Accepted|DATETIME|NULL],[JobID|INTEGER|NULL],[Rejected|DATETIME|NULL],[Exclusions|VARCHAR|NULL]) Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID	SELECT [QuoteID|INTEGER|NOTNULL],[QuoteTypeID|INTEGER|NULL],[QuoteNo|INTEGER|NOTNULL],[ScopeOfWork|VARCHAR|NOTNULL],[Status|VARCHAR|NULL],[Created|DATETIME|NOTNULL],[Accepted|DATETIME|NULL],[JobID|INTEGER|NULL],[Rejected|DATETIME|NULL],[Exclusions|VARCHAR|NULL] FROM @QuoteTable
*/
/*
	--Select c.[ClientID],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode] FROM Client c WITH (NOLOCK) INNER JOIN (SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID) jqa ON c.ClientID=jqa.ClientID
	--Select si.[SiteID],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] FROM Site si WITH (NOLOCK) INNER JOIN (SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID) jqa ON si.SiteID=jqa.SiteID
	--Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID] FROM Appointment a WITH (NOLOCK) INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID 
	--Select j.[JobID],j.[JobNo],j.[ClientID],j.[SiteID],j.[ClientOrderNo],j.[Created],j.[ProjectManagerID] FROM Job j WITH (NOLOCK) INNER JOIN (SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID) jqa ON j.JobID = jqa.JobID
	--Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID
*/
	--DECLARE @AppointmentSurveyTable TABLE ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL,[SurveyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[PropertyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[DueDate|DATETIME|NULL||] DATETIME NULL)	INSERT INTO @AppointmentSurveyTable ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||]) Select asu.[AppointmentSurveyID],asu.[AppointmentID],asu.[SurveyTypeID],asu.[PropertyTypeID],asu.[DueDate] FROM AppointmentSurvey asu WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=asu.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||] FROM @AppointmentSurveyTable GROUP BY [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NULL||]
	DECLARE @AppointmentSurveyTable TABLE ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL,[SurveyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[PropertyTypeID|INTEGER|NOTNULL||] INT NOT NULL,[DueDate|DATETIME|NOTNULL||] DATETIME NOT NULL)	INSERT INTO @AppointmentSurveyTable ([AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||]) Select asu.[AppointmentSurveyID],asu.[AppointmentID],asu.[SurveyTypeID],asu.[PropertyTypeID], ISNULL(asu.[DueDate], GETDATE()) [DueDate] FROM AppointmentSurvey asu WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=asu.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||] FROM @AppointmentSurveyTable GROUP BY [AppointmentSurveyID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[SurveyTypeID|INTEGER|NOTNULL||],[PropertyTypeID|INTEGER|NOTNULL||],[DueDate|DATETIME|NOTNULL||]
	DECLARE @AppointmentAirMonitoringTable TABLE ([AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL ,[NumberOfPumps|INTEGER|NOTNULL||] INT NOT NULL,[RemovalContractorID|INTEGER|NOTNULL||] INT NOT NULL,[SampleResultID|INTEGER|NULL||] INT NULL)	INSERT INTO @AppointmentAirMonitoringTable ([AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[NumberOfPumps|INTEGER|NOTNULL||],[RemovalContractorID|INTEGER|NOTNULL||],[SampleResultID|INTEGER|NULL||]) Select aam.[AppointmentAirMonitoringID],aam.[AppointmentID],aam.[NumberOfPumps],aam.[RemovalContractorID],aam.SampleResultID FROM AppointmentAirMonitoring aam WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[NumberOfPumps|INTEGER|NOTNULL||],[RemovalContractorID|INTEGER|NOTNULL||],[SampleResultID|INTEGER|NULL||] FROM @AppointmentAirMonitoringTable
	DECLARE @AppointmentAirMonitoringTypeTable TABLE ([AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentAirMonitoringID|INTEGER|NOTNULL||] INT NOT NULL ,[AirTestTypeID|INTEGER|NOTNULL||] INT NOT NULL)	INSERT INTO @AppointmentAirMonitoringTypeTable ([AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[AirTestTypeID|INTEGER|NOTNULL||]) Select aamt.[AppointmentAirMonitoringTypeID],aamt.[AppointmentAirMonitoringID],aamt.[AirTestTypeID] FROM AppointmentAirMonitoringType aamt WITH (NOLOCK) INNER JOIN AppointmentAirMonitoring aam WITH (NOLOCK) ON aamt.AppointmentAirMonitoringID=aam.AppointmentAirMonitoringID INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringTypeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[AirTestTypeID|INTEGER|NOTNULL||] FROM @AppointmentAirMonitoringTypeTable
	DECLARE @AppointmentAirMonitoringSampleClassificationTable TABLE ([AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentAirMonitoringID|INTEGER|NOTNULL||] INT NOT NULL ,[SampleClassificationID|INTEGER|NOTNULL||] INT NOT NULL)	INSERT INTO @AppointmentAirMonitoringSampleClassificationTable ([AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[SampleClassificationID|INTEGER|NOTNULL||]) Select aamsc.[AppointmentAirMonitoringSampleClassificationID],aamsc.[AppointmentAirMonitoringID],aamsc.[SampleClassificationID] FROM AppointmentAirMonitoringSampleClassification aamsc WITH (NOLOCK) INNER JOIN AppointmentAirMonitoring aam  WITH (NOLOCK) ON aamsc.AppointmentAirMonitoringID=aam.AppointmentAirMonitoringID INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=aam.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentAirMonitoringSampleClassificationID|INTEGER|NOTNULL||SERVERKEY],[AppointmentAirMonitoringID|INTEGER|NOTNULL||],[SampleClassificationID|INTEGER|NOTNULL||] FROM @AppointmentAirMonitoringSampleClassificationTable

	--------------------------------------------------------
	-- Clients - PJL: I split these up so I could read them!
	DECLARE @ClientTable TABLE ([ClientID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[ClientName|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[ClientAddress|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL  ,[Email|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Telephone|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Fax|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[MainContact|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[EnterpriseServerCode|VARCHAR|NULL||] VARCHAR(MAX) NULL,[EnterpriseAuthEnc|VARCHAR|NULL||] VARCHAR(MAX) NULL )	
	
	INSERT INTO @ClientTable ([ClientID|INTEGER|NOTNULL||SERVERKEY],[ClientName|VARCHAR|NOTNULL||],[ClientAddress|VARCHAR|NOTNULL||],[Email|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Fax|VARCHAR|NOTNULL||],[MainContact|VARCHAR|NOTNULL||],[EnterpriseServerCode|VARCHAR|NULL||],[EnterpriseAuthEnc|VARCHAR|NULL||]) 
		Select 
			c.[ClientID],c.[Client],c.[Address],c.[Email],c.[Telephone],c.[Fax],c.[MainContact],c.[EnterpriseServerCode], c.[EnterpriseAuthEnc]
		FROM 
			Client c WITH (NOLOCK) 
			INNER JOIN (
				SELECT ClientID FROM @JobQuoteAppointmentIDList WHERE ClientID IS NOT NULL GROUP BY ClientID UNION SELECT [RemovalContractorID|INTEGER|NOTNULL||] [ClientID] FROM @AppointmentAirMonitoringTable GROUP BY [RemovalContractorID|INTEGER|NOTNULL||]
			) jqa ON c.ClientID=jqa.ClientID 

	SELECT [ClientID|INTEGER|NOTNULL||SERVERKEY],[ClientName|VARCHAR|NOTNULL||],[ClientAddress|VARCHAR|NOTNULL||],[Email|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Fax|VARCHAR|NOTNULL||],[MainContact|VARCHAR|NOTNULL||],[EnterpriseServerCode|VARCHAR|NULL||],[EnterpriseAuthEnc|VARCHAR|NULL||] FROM @ClientTable
	--------------------------------------------------------
	

	--------------------------------------------------------
	-- Sites - PJL: I split these up so I could read them!
	DECLARE @SiteTable TABLE ([SiteID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[SiteAddress|VARCHAR|NOTNULL||] VARCHAR(MAX), [Telephone|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Contact|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[UPRN|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[ClientOrderNumber|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[TEAMSUPRN|VARCHAR|NULL||] VARCHAR(MAX) NULL )

	INSERT INTO @SiteTable ([SiteID|INTEGER|NOTNULL||SERVERKEY],[SiteAddress|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Contact|VARCHAR|NOTNULL||],[UPRN|VARCHAR|NULL||],[ClientOrderNumber|VARCHAR|NULL||],[TEAMSUPRN|VARCHAR|NULL||]) 
		Select 
			si.[SiteID],si.[Address] + ', ' + si.[Postcode] [SiteAddress],si.[Telephone],si.[Contact],si.[UPRN],si.[ClientOrderNumber],si.[TEAMSUPRN] 
		FROM 
			Site si WITH (NOLOCK) 
			INNER JOIN (
				SELECT SiteID FROM @JobQuoteAppointmentIDList WHERE SiteID IS NOT NULL GROUP BY SiteID UNION SELECT s [SiteID] FROM dbo.SplitString(@ExtraSiteIds,',')
			) jqa ON si.SiteID=jqa.SiteID	

	SELECT [SiteID|INTEGER|NOTNULL||SERVERKEY],[SiteAddress|VARCHAR|NOTNULL||],[Telephone|VARCHAR|NOTNULL||],[Contact|VARCHAR|NOTNULL||],[UPRN|VARCHAR|NULL||],[ClientOrderNumber|VARCHAR|NULL||],[TEAMSUPRN|VARCHAR|NULL||] FROM @SiteTable
	--------------------------------------------------------


	DECLARE @AppointmentTable TABLE ([AppointmentID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[AppointmentTypeID|INTEGER|NOTNULL||] INT NOT NULL ,[ClientID|INTEGER|NULL|Client|] INT NULL ,[SiteID|INTEGER|NULL|Site|] INT NULL ,[StartTime|DATETIME|NOTNULL||] DATETIME NOT NULL ,[EndTime|DATETIME|NOTNULL||] DATETIME NOT NULL ,[Notes|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[ClientOrderNo|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[DateCreated|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[QuoteID|INTEGER|NULL||] INT NULL ,[DateConfirmed|DATETIME|NULL||] DATETIME NULL ,[DateDeclined|DATETIME|NULL||] DATETIME NULL ,[AppointmentCategoryID|INTEGER|NULL||] INT NULL DEFAULT (NULL),[ProjectAppointmentId|INTEGER|NULL||] INT NULL ,[AppointmentGroupId|INTEGER|NULL||] INT NULL ,[BranchOfficeID|INTEGER|NOTNULL||] INT NOT NULL DEFAULT ((0)), [SiteAlert|VARCHAR|NULL||] VARCHAR(MAX))	INSERT INTO @AppointmentTable ([AppointmentID|INTEGER|NOTNULL||SERVERKEY],[AppointmentTypeID|INTEGER|NOTNULL||],[ClientID|INTEGER|NULL|Client|],[SiteID|INTEGER|NULL|Site|],[StartTime|DATETIME|NOTNULL||],[EndTime|DATETIME|NOTNULL||],[Notes|VARCHAR|NOTNULL||],[ClientOrderNo|VARCHAR|NOTNULL||],[DateCreated|DATETIME|NOTNULL||],[QuoteID|INTEGER|NULL||],[DateConfirmed|DATETIME|NULL||],[DateDeclined|DATETIME|NULL||],[AppointmentCategoryID|INTEGER|NULL||],[ProjectAppointmentId|INTEGER|NULL||],[AppointmentGroupId|INTEGER|NULL||],[BranchOfficeID|INTEGER|NOTNULL||],[SiteAlert|VARCHAR|NULL||]) Select a.[AppointmentID],a.[AppointmentTypeID],a.[ClientID],a.[SiteID],a.[StartTime],a.[EndTime],a.[Notes],a.[ClientOrderNo],a.[DateCreated],a.[QuoteID],a.[DateConfirmed],a.[DateDeclined],a.[AppointmentCategoryID],a.[ProjectAppointmentId],a.[AppointmentGroupId],a.[BranchOfficeID], cs.SiteAlerts FROM Appointment a WITH (NOLOCK) LEFT OUTER JOIN Site si WITH (NOLOCK) ON a.SiteID=si.SiteID LEFT OUTER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID AND cs.ClientID=a.ClientID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentID|INTEGER|NOTNULL||SERVERKEY],[AppointmentTypeID|INTEGER|NOTNULL||],[ClientID|INTEGER|NULL|Client|],[SiteID|INTEGER|NULL|Site|],[StartTime|DATETIME|NOTNULL||],[EndTime|DATETIME|NOTNULL||],[Notes|VARCHAR|NOTNULL||],[ClientOrderNo|VARCHAR|NOTNULL||],[DateCreated|DATETIME|NOTNULL||],[QuoteID|INTEGER|NULL||],[DateConfirmed|DATETIME|NULL||],[DateDeclined|DATETIME|NULL||],[AppointmentCategoryID|INTEGER|NULL||],[ProjectAppointmentId|INTEGER|NULL||],[AppointmentGroupId|INTEGER|NULL||],[BranchOfficeID|INTEGER|NOTNULL||],[SiteAlert|VARCHAR|NULL||] FROM @AppointmentTable
	DECLARE @AppointmentEmployeeTable TABLE ([AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL,[AppointmentID|INTEGER|NOTNULL||] INT NOT NULL ,[EmployeeID|INTEGER|NULL||] INT NULL)	INSERT INTO @AppointmentEmployeeTable ([AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NULL||]) Select ae.[AppointmentEmployeeID],ae.[AppointmentID],ae.[EmployeeID] FROM AppointmentEmployee ae WITH (NOLOCK) INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID=ae.AppointmentID INNER JOIN (SELECT AppointmentID FROM @JobQuoteAppointmentIDList WHERE AppointmentID IS NOT NULL GROUP BY AppointmentID) jqa ON jqa.AppointmentID=a.AppointmentID  SELECT [AppointmentEmployeeID|INTEGER|NOTNULL||SERVERKEY],[AppointmentID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NULL||] FROM @AppointmentEmployeeTable
	DECLARE @JobTable TABLE ( [JobID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL, [JobNo|INTEGER|NOTNULL||] INT NOT NULL, [ClientID|INTEGER|NOTNULL|Client|] INT NOT NULL, [SiteID|INTEGER|NULL|Site|] INT NULL, [ClientOrderNo|VARCHAR|NULL||] VARCHAR(MAX) NULL, [Created|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT ( getdate() ), [ProjectManagerID|INTEGER|NULL||] INT NULL, [HasSiteData|INTEGER|NULL||] INT NULL, [Notes|VARCHAR|NULL||] VARCHAR(MAX), [SiteAlert|VARCHAR|NULL||] VARCHAR(MAX) ) INSERT INTO @JobTable ( [JobID|INTEGER|NOTNULL||SERVERKEY], [JobNo|INTEGER|NOTNULL||], [ClientID|INTEGER|NOTNULL|Client|], [SiteID|INTEGER|NULL|Site|], [ClientOrderNo|VARCHAR|NULL||], [Created|DATETIME|NOTNULL||], [ProjectManagerID|INTEGER|NULL||], [HasSiteData|INTEGER|NULL||], [Notes|VARCHAR|NULL||], [SiteAlert|VARCHAR|NULL||] ) Select j.[JobID], j.[JobNo], j.[ClientID], j.[SiteID], j.[ClientOrderNo], j.[Created], j.[ProjectManagerID], CASE WHEN sd.DataCount > 0 THEN 1 END [HasSiteData], ( SELECT top 1 a.Notes FROM @JobQuoteAppointmentIDList jqal INNER JOIN Appointment a WITH (NOLOCK) ON jqal.AppointmentID = a.AppointmentID WHERE jqal.JobID = j.JobID ), cs.SiteAlerts FROM Job j WITH (NOLOCK) INNER JOIN ( SELECT JobID FROM @JobQuoteAppointmentIDList WHERE JobID IS NOT NULL GROUP BY JobID ) jqa ON j.JobID = jqa.JobID OUTER APPLY ( SELECT COUNT(*) [DataCount] FROM Site subSi WITH (NOLOCK) INNER JOIN Job subJ WITH (NOLOCK) ON subSi.SiteID = subJ.SiteID INNER JOIN JobEmployee subje WITH (NOLOCK) ON subje.JobID = subj.JobID INNER JOIN Register subr WITH (NOLOCK) ON subje.JobEmployeeID = subr.JobEmployeeID INNER JOIN Floorplan subfp WITH (NOLOCK) ON subfp.RegisterID = subr.RegisterID WHERE subSi.SiteID = j.SiteID ) sd INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID AND cs.ClientID=j.ClientID SELECT [JobID|INTEGER|NOTNULL||SERVERKEY], [JobNo|INTEGER|NOTNULL||], [ClientID|INTEGER|NOTNULL|Client|], [SiteID|INTEGER|NULL|Site|], [ClientOrderNo|VARCHAR|NULL||], [Created|DATETIME|NOTNULL||], [ProjectManagerID|INTEGER|NULL||], [HasSiteData|INTEGER|NULL||], [Notes|VARCHAR|NULL||], [SiteAlert|VARCHAR|NULL||] FROM @JobTable
	DECLARE @QuoteTable TABLE ([QuoteID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteTypeID|INTEGER|NULL||] INT NULL ,[QuoteNo|INTEGER|NOTNULL||] INT NOT NULL ,[ScopeOfWork|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL DEFAULT (''),[Status|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[Created|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[Accepted|DATETIME|NULL||] DATETIME NULL ,[JobID|INTEGER|NULL|Job|] INT NULL ,[Rejected|DATETIME|NULL||] DATETIME NULL ,[Exclusions|VARCHAR|NULL||] VARCHAR(MAX) NULL )	INSERT INTO @QuoteTable ([QuoteID|INTEGER|NOTNULL||SERVERKEY],[QuoteTypeID|INTEGER|NULL||],[QuoteNo|INTEGER|NOTNULL||],[ScopeOfWork|VARCHAR|NOTNULL||],[Status|VARCHAR|NULL||],[Created|DATETIME|NOTNULL||],[Accepted|DATETIME|NULL||],[JobID|INTEGER|NULL|Job|],[Rejected|DATETIME|NULL||],[Exclusions|VARCHAR|NULL||]) Select q.[QuoteID],q.[QuoteTypeID],q.[QuoteNo],q.[ScopeOfWork],q.[Status],q.[Created],q.[Accepted],q.[JobID],q.[Rejected],q.[Exclusions] FROM Quote q WITH (NOLOCK) INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) jqa ON q.QuoteID=jqa.QuoteID SELECT [QuoteID|INTEGER|NOTNULL||SERVERKEY],[QuoteTypeID|INTEGER|NULL||],[QuoteNo|INTEGER|NOTNULL||],[ScopeOfWork|VARCHAR|NOTNULL||],[Status|VARCHAR|NULL||],[Created|DATETIME|NOTNULL||],[Accepted|DATETIME|NULL||],[JobID|INTEGER|NULL|Job|],[Rejected|DATETIME|NULL||],[Exclusions|VARCHAR|NULL||] FROM @QuoteTable

	DECLARE @QuoteEmployeeTable TABLE ([QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteID|INTEGER|NOTNULL||] INT NOT NULL ,[EmployeeID|INTEGER|NOTNULL||] INT NOT NULL ,[ScheduledStart|DATETIME|NULL||] DATETIME NULL ,[ScheduledFinish|DATETIME|NULL||] DATETIME NULL ,[ActualStart|DATETIME|NULL||] DATETIME NULL ,[ActualFinish|DATETIME|NULL||] DATETIME NULL )	INSERT INTO @QuoteEmployeeTable ([QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY],[QuoteID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NOTNULL||],[ScheduledStart|DATETIME|NULL||],[ScheduledFinish|DATETIME|NULL||],[ActualStart|DATETIME|NULL||],[ActualFinish|DATETIME|NULL||])	Select qe.[QuoteEmployeeID],qe.[QuoteID],qe.[EmployeeID],qe.[ScheduledStart],qe.[ScheduledFinish],qe.[ActualStart],qe.[ActualFinish] FROM QuoteEmployee qe INNER JOIN (SELECT QuoteID FROM @JobQuoteAppointmentIDList WHERE QuoteID IS NOT NULL GROUP BY QuoteID) q ON qe.QuoteID=q.QuoteID AND qe.EmployeeID>0 SELECT [QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY],[QuoteID|INTEGER|NOTNULL||],[EmployeeID|INTEGER|NOTNULL||],[ScheduledStart|DATETIME|NULL||],[ScheduledFinish|DATETIME|NULL||],[ActualStart|DATETIME|NULL||],[ActualFinish|DATETIME|NULL||] FROM @QuoteEmployeeTable
	DECLARE @QuoteVisitTable TABLE ([QuoteVisitID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[QuoteVisitTypeID|INTEGER|NOTNULL||] INT NOT NULL ,[QuoteEmployeeID|INTEGER|NULL||] INT NULL ,[QuoteVisitStart|DATETIME|NOTNULL||] DATETIME NOT NULL DEFAULT (getdate()),[QuoteVisitFinish|DATETIME|NULL||] DATETIME NULL ,[Notes|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[PhotoID|INTEGER|NULL||] INT NULL ,[SystemName|VARCHAR|NOTNULL||] VARCHAR(MAX) NOT NULL ,[Closed|BIT|NOTNULL||] BIT NOT NULL DEFAULT ((0)),[Finished|BIT|NOTNULL||] BIT NOT NULL DEFAULT ((0)),[SignatureID|INTEGER|NULL||] INT NULL ,[_QuoteVisitConsumableMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL ,[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL ,[_QuoteVisitLabourMarkup|DECIMAL|NULL||] DECIMAL(38,38) NULL )	INSERT INTO @QuoteVisitTable ([QuoteVisitID|INTEGER|NOTNULL||SERVERKEY],[QuoteVisitTypeID|INTEGER|NOTNULL||],[QuoteEmployeeID|INTEGER|NULL||],[QuoteVisitStart|DATETIME|NOTNULL||],[QuoteVisitFinish|DATETIME|NULL||],[Notes|VARCHAR|NULL||],[PhotoID|INTEGER|NULL||],[SystemName|VARCHAR|NOTNULL||],[Closed|BIT|NOTNULL||],[Finished|BIT|NOTNULL||],[SignatureID|INTEGER|NULL||],[_QuoteVisitConsumableMarkup|DECIMAL|NULL||],[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||],[_QuoteVisitLabourMarkup|DECIMAL|NULL||]) Select qv.[QuoteVisitID],qv.[QuoteVisitTypeID],qv.[QuoteEmployeeID],qv.[QuoteVisitStart],qv.[QuoteVisitFinish],qv.[Notes],qv.[PhotoID],qv.[SystemName],qv.[Closed],qv.[Finished],qv.[SignatureID],qv.[_QuoteVisitConsumableMarkup],qv.[_QuoteVisitEquipmentMarkup],qv.[_QuoteVisitLabourMarkup] FROM QuoteVisit qv INNER JOIN @QuoteEmployeeTable qet ON qet.[QuoteEmployeeID|INTEGER|NOTNULL||SERVERKEY]=qv.QuoteEmployeeID	SELECT [QuoteVisitID|INTEGER|NOTNULL||SERVERKEY],[QuoteVisitTypeID|INTEGER|NOTNULL||],[QuoteEmployeeID|INTEGER|NULL||],[QuoteVisitStart|DATETIME|NOTNULL||],[QuoteVisitFinish|DATETIME|NULL||],[Notes|VARCHAR|NULL||],[PhotoID|INTEGER|NULL||],[SystemName|VARCHAR|NOTNULL||],[Closed|BIT|NOTNULL||],[Finished|BIT|NOTNULL||],[SignatureID|INTEGER|NULL||],[_QuoteVisitConsumableMarkup|DECIMAL|NULL||],[_QuoteVisitEquipmentMarkup|DECIMAL|NULL||],[_QuoteVisitLabourMarkup|DECIMAL|NULL||] FROM @QuoteVisitTable
	DECLARE @DataCollectionTable TABLE ([DataCollectionID|INTEGER|NOTNULL||SERVERKEY] INT NOT NULL ,[DataCollectionQuestionID|INTEGER|NOTNULL||] INT NOT NULL ,[DataText|VARCHAR|NULL||] VARCHAR(MAX) NULL ,[DataInt|INTEGER|NULL||] INT NULL ,[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||] INT NULL ,[Deleted|DATETIME|NULL||] DATETIME NULL ,[QuoteVisitID|INTEGER|NULL||] INT NULL ,[DataCollectionCategoryTypeID|INTEGER|NOTNULL||] INT NOT NULL )	INSERT INTO @DataCollectionTable ([DataCollectionID|INTEGER|NOTNULL||SERVERKEY],[DataCollectionQuestionID|INTEGER|NOTNULL||],[DataText|VARCHAR|NULL||],[DataInt|INTEGER|NULL||],[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||],[Deleted|DATETIME|NULL||],[QuoteVisitID|INTEGER|NULL||],[DataCollectionCategoryTypeID|INTEGER|NOTNULL||])	Select dc.[DataCollectionID],dc.[DataCollectionQuestionID],dc.[DataText],dc.[DataInt],dc.[DataCollectionQuestionOptionOrInsertID],dc.[Deleted],dc.[QuoteVisitID],dc.[DataCollectionCategoryTypeID] FROM DataCollection	dc INNER JOIN @QuoteVisitTable qvt ON dc.QuoteVisitID=qvt.[QuoteVisitID|INTEGER|NOTNULL||SERVERKEY] SELECT [DataCollectionID|INTEGER|NOTNULL||SERVERKEY],[DataCollectionQuestionID|INTEGER|NOTNULL||],[DataText|VARCHAR|NULL||],[DataInt|INTEGER|NULL||],[DataCollectionQuestionOptionOrInsertID|INTEGER|NULL||],[Deleted|DATETIME|NULL||],[QuoteVisitID|INTEGER|NULL||],[DataCollectionCategoryTypeID|INTEGER|NOTNULL||] FROM @DataCollectionTable


	SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'QualityControlSampleList_2') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[QualityControlSampleList_2] AS BEGIN SET NOCOUNT ON; END')
END
GO


ALTER PROCEDURE [dbo].[QualityControlSampleList_2]
    @startdate [datetime] =NULL,
    @enddate [datetime] =NULL,
    @clientid [int] =NULL,
    @ProjectId int =NULL,
    @siteid int =NULL,
    @employeeid int= 0,
    @mode int = 1,
    @forceUpdateCounts bit = 1
AS
BEGIN
set transaction ISOLATION level READ uncommitted 

SET NOCOUNT ON 
--update QCOutnstandingCountByDay for some bizare reason!
DECLARE @internalstartdate [datetime],@internalenddate [datetime]

DECLARE @maxpoints int
SET @maxpoints = (SELECT Max(i__MaxDailyPoints) FROM Config)

DECLARE @ceilingpercentage decimal(5, 3)
SET @ceilingpercentage = (SELECT Max(i__QcCeilingPercentage) FROM Config)

SET @internalstartdate = @startdate
SET @internalenddate = @enddate

IF @employeeid IS NULL
BEGIN
	set @employeeid = 0
END

IF @internalstartdate IS NULL 
BEGIN
    set @internalstartdate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 00:00:00' as datetime)
END 

IF @internalenddate IS NULL 
BEGIN
    set @internalenddate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 23:59:59' as datetime)
END 

if (CONVERT(VARCHAR(8),@internalenddate,108) = '00:00:00')
begin 
    set @internalenddate = cast(CONVERT(VARCHAR(11),@internalenddate,106) + ' 23:59:59' as datetime)
END 

If @mode = 3 BEGIN
	Select
		rs.theDay  [_day],
		rs.Total [c]	
	FROM
		QCOutstandingCountByDay rs
	Where 
		rs.theDay = @internalstartdate
END


If @mode < 3 BEGIN

DECLARE @SampleTable TABLE (SessionRef VARCHAR(50),SampleID INT, OrderIdentifier INT, TimeIdentifier INT,CreatedDate DATE,CreatedDateTime DATETIME, sampleTestCollectionID INT, SampleTestID INT,datasaved INT, _name VARCHAR(MAX), EmployeeID INT)
Insert into @SampleTable (SessionRef,SampleID,OrderIdentifier, TimeIdentifier,CreatedDate,CreatedDateTime,sampleTestCollectionID,SampleTestID,datasaved,_name,EmployeeID)
SELECT 
	test_st._sessionRef,
	test_st._sampleID,
	ROW_NUMBER() OVER (Partition By test_st._sampleID,test_st._EmployeeID Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [OrderIdentifier],
	ROW_NUMBER() OVER (Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [TimeIdentifier],
	[test_st].[_testCreatedOn] [_testCreatedOn],
	[test_st].[_testCreatedOn] [_testCreatedOn],
    test_st.[sampleTestCollectionID],
    test_st.[sampleTestID],
    test_st._wasSaved [datasaved],
    [test_st].[_name],
    [test_st]._employeeID
FROM 
    sampletest test_st 
    INNER JOIN Sample s ON test_st._sampleID=s.SampleID
    INNER JOIN SampleTestCollection stc ON test_st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
    LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = test_st.sampleTestCollectionID
		AND
		test_st._SessionRef = stcs.sessionref
WHERE
    ((test_st.[_name] ='AnalysisTest') OR (test_st.[_name] ='AnalysisQC'))
    AND (test_st.[_testCancelledOn] IS NULL)
    AND [test_st].[_wasSaved] = 1
    AND ([test_st].[_testCreatedOn] BETWEEN @internalstartdate AND @internalenddate) 
    AND (test_st._employeeID = @employeeid OR @employeeid = 0)
Order By
	test_st._sampleID

DECLARE @SampleRowNumber TABLE (SampleID INT, RowNumber INT)
Insert into @SampleRowNumber (SampleID, RowNumber)
Select
	st.SampleID, ROW_NUMBER() OVER (PARTITION BY MAX(st.CreatedDate) ORDER BY MAX(st.CreatedDateTime), MAX(st.SampleTestID)) [rownumber]
FROM 
	@SampleTable st
GROUP BY
	st.SampleID

DECLARE @OriginalTest TABLE (SampleTestID INT,SampleID INT, EmployeeID INT, CreatedDate DATE, Analysed DATETIME)
Insert into @OriginalTest (SampleTestID,SampleID,EmployeeID,CreatedDate,Analysed)
Select main.SampleTestID,main.SampleID, main.EmployeeID, main.CreatedDate, main.Analysed
FROM
(Select
	_ori.SampleTestID,ROW_NUMBER() OVER (PARTITION BY st.SampleID ORDER BY _ori._testCreatedOn DESC) [OrderIdentifier],st.SampleID, _ori._employeeID [EmployeeID], _ori._testCreatedOn [CreatedDate], stcs.sample_dateanalysed [Analysed]
FROM
	@SampleTable st 
	LEFT OUTER JOIN SampleTest _ori ON st.SampleID=_ori._sampleID 
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
Where
	_ori._testCreatedOn <= st.CreatedDateTime
		AND
	_ori._name = 'AnalysisTest' --AND 
) main
Where
	main.OrderIdentifier=1

DECLARE @SampleAllResult TABLE (SampleID INT, _testCreatedOn DATE, RowNumber INT,sampleTestCollectionSessionID INT)
Insert into @SampleAllResult (SampleID, RowNumber,sampleTestCollectionSessionID)
Select
	srn.SampleID, srn.RowNumber [rownumber],MAX(stcs.sampleTestCollectionSessionID)
FROM
	@SampleRowNumber srn
	INNER JOIN @SampleTable st ON srn.SampleID=st.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
		AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
Group By
	srn.SampleID,srn.RowNumber

DECLARE @QCSample TABLE (SampleTestID INT,SampleID INT, EmployeeID INT,sampleTestCollectionSessionID INT, Analysed DATETIME)
Insert into @QCSample (SampleTestID,SampleID,EmployeeID,sampleTestCollectionSessionID,Analysed)
Select 
	main.SampleTestID, main.SampleID, main.EmployeeID, main.sampleTestCollectionSessionID, main.Analysed
FROM
(Select
	st.SampleTestID,st.SampleID, st.EmployeeID,stcs.sampleTestCollectionSessionID, stcs.sample_dateanalysed [Analysed],
	ROW_NUMBER() OVER (Partition By st.SampleID Order By st.CreatedDateTime DESC) [OrderIdentifier]
FROM
	@SampleTable st
	INNER JOIN SampleTestCollection stc ON st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
	INNER JOIN SampleTestCollectionSession stcs ON 
		stcs.sampleTestCollectionID = st.sampleTestCollectionID
			AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
		--	AND 
		--stcs.sessionref = st.SessionRef
Where
	st._name = 'AnalysisQC'
) main
Where main.OrderIdentifier=1

DECLARE @FutureSamples TABLE (SampleID INT, EmployeeID INT, _name VARCHAR(MAX), TestCreatedOn DATETIME)
Insert into @FutureSamples
Select main._SampleID, main._EmployeeID, main._Name, main._TestCreatedOn
FROM
(
Select
	test_st._sampleID, test_st._employeeID, test_st._name, test_st._testCreatedOn
FROM
	sampletest test_st
	INNER JOIN @SampleTable st ON st.SampleID=test_st._SampleID
Where
	test_st._testCancelledOn IS NULL
) main


DECLARE @FutureQCSample TABLE (SampleID INT, EmployeeID INT, TestCreatedOn VARCHAR(MAX))
Insert into @FutureQCSample (SampleID,EmployeeID, TestCreatedOn)
Select main.SampleID, main.EmployeeID, main.TestCreatedOn
FROM
(Select
	st.SampleID, st.EmployeeID, fs.TestCreatedOn, ROW_NUMBER() OVER (Partition By st.SampleID Order By fs.TestCreatedOn DESC) [OrderIdentifier] --NEED TO MAKE THIS STUFF
FROM
	@SampleTable st
	INNER JOIN @FutureSamples fs ON st.SampleID=fs.SampleID AND fs._name='AnalysisQC'
Where
	st._name = 'AnalysisTest'
) main
Where
	main.OrderIdentifier=1

--DECLARE A TABLE VALUE SO WE CAN TALLY UP POINTS
DECLARE @ResultSet TABLE (EmployeeID INT,[otSampleTestID] INT,[OriginalAnalystEmployeeID] INT,[qcEmployeeID] INT,[stSampleTestID] INT,[qcSampleTestID] INT,[Test No] INT,[SampleID] INT,[analysed] INT,[OriginalAnalystName] VARCHAR(MAX),[qc] INT,[datasaved] BIT,[qcdInFuture] INT,[sampleTestCollectionSessionID] INT,[sampleref] VARCHAR(MAX),[totalsofar] INT,[rownumber] INT,[OverMaxPoints] INT,[Points] INT, [Star] BIT,[sampleClassificationDetails] VARCHAR(MAX),[sampleresultdetails] VARCHAR(MAX),[loggedSampleClassificationExtendedID] INT,[loggedSampleClassificationID] INT,[loggedSampleResultID] INT,[testCreatedOn] DATE,[JobID] INT,[jobno] VARCHAR(MAX),[FullName] VARCHAR(MAX),[Approved] INT,[allowcheck] INT,[futuredates_string] VARCHAR(MAX),[CreatedDate] DATE,[AnalysedToday] INT,[qcdToday] INT,[otCreatedDate] DATE)
Insert into @ResultSet (EmployeeID,[OriginalAnalystEmployeeID],[qcEmployeeID],[otSampleTestID],[stSampleTestID],[qcSampleTestID],[Test No],[SampleID],[analysed],[OriginalAnalystName],[qc],[datasaved],[qcdInFuture],[sampleTestCollectionSessionID],[sampleref],[totalsofar],[rownumber],[OverMaxPoints],[Points],[Star],[sampleClassificationDetails],[sampleresultdetails],[loggedSampleClassificationExtendedID],[loggedSampleClassificationID],[loggedSampleResultID],[testCreatedOn],[JobID],[jobno],[FullName],[Approved],[allowcheck],[futuredates_string],[CreatedDate],[AnalysedToday],[qcdToday],[otCreatedDate])
Select 
	e.EmployeeID,
	OriginalAnalyst.EmployeeID [OriginalAnalystEmployeeID],
	qc.EmployeeID [qcEmployeeID],
	ot.SampleTestID [otSampleTestID],
	st.SampleTestID [stSampleTestID],
	CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END [qcSampleTestID],
	ROW_NUMBER() OVER (Partition By e.FullName Order by s.DateAnalysed) [Test No],
	st.SampleID,
	CASE WHEN (((IsNull(ot.EmployeeID,0) = st.EmployeeID) AND st.CreatedDate = ot.CreatedDate) OR (ot.EmployeeID = qc.EmployeeID)) THEN 1 ELSE 0 END [analysed],
	OriginalAnalyst.FullName [OriginalAnalystName],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 1 ELSE 0 END [qc],
	CASE WHEN st.SampleTestID=IsNull(qc.SampleTestID,st.SampleTestID) AND IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND (stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef) THEN 1 ELSE 0 END [datasaved], -- NO LONGER USED?
	CASE WHEN fqc.EmployeeID IS NULL THEN 0 ELSE 1 END [qcdInFuture],
	stcs.sampleTestCollectionSessionID,
	s.SampleRef [sampleref],
	NULL [totalsofar],
	sar.RowNumber [rownumber],
	--SUM(sar.RowNumber) OVER(PARTITION BY e.FullName ORDER BY s.DateAnalysed ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)  -- ONLY 2012 :/
	NULL as [OverMaxPoints],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) AND ot.CreatedDate=st.CreatedDate THEN scePoints.Points * 2 ELSE scePoints.Points END [Points],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) THEN 1 ELSE 0 END [Star],
	sce.SampleClassification [sampleClassificationDetails],
	sr.SampleResult [sampleresultDetails],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationExtendedID END [loggedSampleClassificationExtendedID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationID END [loggedSampleClassificationID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleResultID END [loggedSampleResultID],
	dbo.formatteamsdate(st.CreatedDate,1) [testCreatedOn],
	j.JobID [JobID],
	dbo.FormatTeamsReference('J',j.JobNo) [jobno],
	e.FullName,
	case when (not j.SampleResultEmployeeID IS NULL AND not j.SampleContentEmployeeID IS NULL) then 1 else 0 end [Approved],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 0 ELSE 1 END [allowcheck],
	IsNull(fqc.TestCreatedOn,'') [futuredates_string],
	st.CreatedDate [CreatedDate],
	CASE WHEN ot.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [AnalysedToday],
	CASE WHEN qc.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [qcdToday],
	ot.CreatedDate [otCreatedDate]
FROM 
	@SampleTable st
	LEFT OUTER JOIN @OriginalTest ot ON st.SampleID = ot.SampleID
	LEFT OUTER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = ot.EmployeeID
	
	LEFT OUTER JOIN @SampleAllResult sar ON st.SampleID=sar.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.SampleTestCollectionSessionID=sar.SampleTestCollectionSessionID
	
	LEFT OUTER JOIN @QCSample qc ON st.SampleID=qc.SampleID-- AND qc.EmployeeID=st.EmployeeID
	
	
	LEFT OUTER JOIN @FutureQCSample fqc ON fqc.SampleID=st.SampleID
		AND fqc.TestCreatedOn > cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
	
	INNER JOIN Employee e ON st.EmployeeID = e.EmployeeID
	INNER JOIN Sample s ON s.SampleID = st.SampleID
	
	
	--INNER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = s.EmployeeID
	INNER JOIN Room rm ON rm.RoomID = s.RoomID
	INNER JOIN Register r ON rm.RegisterID=r.RegisterID
	INNER JOIN JobEmployee je ON r.JobEmployeeID = je.JobEmployeeID
	INNER JOIN Job j ON je.JobID = j.JobID
	
	LEFT OUTER JOIN SampleClassificationExtended sce ON sce.SampleClassificationExtendedID = s.SampleClassificationExtendedID
	LEFT OUTER JOIN SampleResult sr ON sr.SampleResultID = s.SampleResultID
	
	LEFT OUTER JOIN SampleClassificationExtendedPoints scePoints  ON scePoints.SampleClassificationExtendedPointsID=s.SampleClassificationExtendedPointsID
	
Where 
	OrderIdentifier = 1
		AND
	(
		CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) THEN 
			CASE WHEN ot.EmployeeID=qc.EmployeeID THEN CASE WHEN st.EmployeeID = qc.EmployeeID THEN 1 ELSE 0 END ELSE 1 END
		ELSE 
			1
		END = 1
	)
		AND
	(st.EmployeeID = @employeeid OR @employeeid = 0)

/*
	Select 
		checked.SampleID
	FROM
		@ResultSet rs
		OUTER APPLY
		(
			Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
			FROM
			(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
				UNION
			Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
			Where
				rs.SampleID = main.SampleID AND rs.qc=0
				AND
				(
					(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
				)
			Group By EmployeeID, SampleID
		) checked
	Where rs.EmployeeID=8 AND checked.SampleID IS NOT NULL
*/	

	If @mode = 0 BEGIN
		DECLARE @Mode0Table TABLE ([_day] DATETIME,[c] INT,[qcd] INT,[qcdone] INT,[points] INT,[EmployeeID] INT,[FullName] VARCHAR(MAX),[QCCountNeededMethod1] INT, [QCCountNeededMethod1_Outstanding] INT, [QCCountNeededMethod2] INT, [QCCountNeededMethod2_Outstanding] INT, [checked_count] INT, [samplecount] INT, [ac] INT)
		Insert into @Mode0Table
		Select 
			main._day,
			SUM(main.c) [c],
			SUM(main.qcd) [qcd],
			SUM(main.qcdone) [qcdone],
			SUM(main.points) [points],
			main.EmployeeID [EmployeeID],
			main.FullName [FullName],
			--MIN(main.MaxPoints),
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod1],
			CASE WHEN  CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END > 0 THEN
				CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) ElSE 0 END - SUM(main.checked_count)
			ELSE
				0
			END [QCCountNeededMethod1_Outstanding],
			--SUM(main.QCCountNeededMethod1_Outstanding - main.checked_count) [QCCountNeededMethod1_Outstanding],
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod2],
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding - main.checked_count > 0 THEN main.QCCountNeededMethod2_Outstanding - main.checked_count ELSE 0 END) [QCCountNeededMethod2_Outstanding],
			IsNull(SUM(main.checked_count),0) [checked_count],
			IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) [samplecount],
			ISNULL(SUM(main.ac),0) [ac]
			--*/
		FROM
		(
			Select
				a.allEmployees,
				a._day,
				CASE WHEN ISNULL(inner_main.c,qconly.c) > 0 THEN ISNULL(inner_main.c,qconly.c) ELSE 0 END [c],
				CASE WHEN qconly.qcd IS NOT NULL THEN IsNull(inner_main.qcd,qconly.qcdone) ELSE qconly.qcdone END [qcd],
				ISNULL(inner_main.qcdone,0) [qcdone],
				ISNULL(inner_main.points,0) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				inner_main.MaxPoints,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				--ISNULL(CASE WHEN IsNull(inner_main.qcd,qconly.qcd) > 0 THEN checked.[count] END,0)
				inner_main.checked [checked_count],
				inner_main.samplecount [samplecount],
				inner_main.ac+qconly.ac [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					SUM(rs.Analysed) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					MIN(CASE WHEN rs.OverMaxPoints = 1 THEN rs.totalsofar ELSE 99999 END) [MaxPoints],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					SUM(CASE WHEN rs.OriginalAnalystEmployeeID <> rs.qcEmployeeID THEN 1 ELSE 0 END) [checked_count],
					CEILING(COUNT(
						CASE WHEN rs.totalsofar > @maxpoints Then
							rs.SampleID
						End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac],
					--SUM(CASE WHEN (checked.EmployeeID != rs.EmployeeID AND checked.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND checked.EmployeeID = rs.EmployeeID) Then 1 ELSE 0 END) [checked]
					COUNT(checked.SampleID) [checked]
				FROM
					(
						Select 
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[OriginalAnalystName],rs.Analysed,rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],
							CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],
							rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
					) rs
					OUTER APPLY
					(
						Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
						FROM
						(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
							UNION
						Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
						Where
							rs.SampleID = main.SampleID AND rs.qc=0
							AND
							(
								(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) --OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
									OR 
								((rs.AnalysedToday = 1 OR rs.qcdInFuture = 1) AND main.EmployeeID = rs.EmployeeID)
							)
						Group By EmployeeID, SampleID
					) checked
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.qc=0
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					0 [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		GROUP BY
			main.[_day],main.EmployeeID,main.FullName
		Order By
			main.EmployeeID
		
		If @forceUpdateCounts = 1 AND @employeeid = 0 BEGIN
			DECLARE @QCOutstandingCountByDayID INT = (Select top 1 QCOutstandingCountByDayID FROM QCOutstandingCountByDay Where theDay=@internalstartdate)
			IF(@QCOutstandingCountByDayID = 0) BEGIN
				Insert into QCOutstandingCountByDay (theDay,Total) Select m0t._day,SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day
			END
			IF(@QCOutstandingCountByDayID > 0) BEGIN
				DECLARE @CurrentTotal INT = (Select Total FROM QCOutstandingCountByDay Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID)
				If ((Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) != @CurrentTotal) BEGIN
					Update QCOutstandingCountByDay Set Total = (Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID
				END
			END		
		END	
		
		Select * FROM @Mode0Table m0t Where (m0t.EmployeeID = @employeeid OR @employeeid=0) Order by m0t.EmployeeID
	END
	
	If @mode = 1 BEGIN
		Select 
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],
			--rs.[sampleTestCollectionSessionID],
			--rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID,
			rs.[sampleref],
			CAST(SUM(rs2.[Points]) as varchar) + CASE WHEN rs.[Star] = 1 THEN '*' ELSE '' END [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
			CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
				RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
			ELSE
				CONVERT(varchar(11), rs.[testCreatedOn], 106)
			END [testCreatedOn]
			,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
		FROM 
			@ResultSet rs
			INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
		GROUP BY
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleTestCollectionSessionID],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
			--,rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID
		Order By
			--rs.rownumber,
			rs.FullName
			, rs.rownumber
	END

	If @mode = 2 BEGIN
			Select
				main._day,SUM(main.QCCountNeededMethod1),SUM(main.QCCountNeededMethod2)
			FROM
			(
			Select
					CAST(rs.CreatedDate as DATETIME) [_day],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber AND rs.CreatedDate=rs2.CreatedDate
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.CreatedDate,qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.CreatedDate,qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.CreatedDate=qcd.CreatedDate
				Group By
					rs.CreatedDate,rs.EmployeeID
			) main
		GROUP BY
			main._day
	END
	
	
	If @mode = 3 BEGIN
		Select 
			main._day,
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding > 0 THEN main.QCCountNeededMethod2_Outstanding ELSE 0 END) [c]
		FROM
		(
			Select
				a._day,
				CASE WHEN inner_main.c > 0 THEN inner_main.c ELSE 0 END [c],
				IsNull(inner_main.qcd,qconly.qcd) [qcd],
				ISNULL(inner_main.qcdone,qconly.qcdone) [qcdone],
				ISNULL(inner_main.points,qconly.points) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				ISNULL(inner_main.checked_count,qconly.checked_count) [checked_count],
				ISNULL(inner_main.samplecount,qconly.samplecount) [samplecount],
				ISNULL(inner_main.ac,qconly.ac) [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		Group By
			main._day
	END
	
	END

SET NOCOUNT OFF

END

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='Restricted') < 1
BEGIN
  ALTER TABLE Client
      ADD Restricted BIT NOT NULL DEFAULT 0
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EmployeeRestrictedClientAccess'))
BEGIN
	CREATE TABLE [dbo].[EmployeeRestrictedClientAccess](
		[EmployeeRestrictedClientAccessID] [int] IDENTITY(1,1) NOT NULL,
		[EmployeeID] [int] NOT NULL,
		[ClientID] [int] NOT NULL,
	PRIMARY KEY CLUSTERED 
	(
		[EmployeeRestrictedClientAccessID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
End

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 04/02/2019 15:16:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[Paged_Projects]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],
			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			+ ' (' + 
					CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],
			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[TEAMS_ManagementGetSites]    Script Date: 06/02/2019 15:35:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[TEAMS_ManagementGetSites]
	@Client INT,
	@Project INT,
	@Site INT,
	@Filter varchar(max) = ''

AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

DECLARE
	@InternalClient INT = @Client,
	@InternalProject INT = @Project,
	@InternalSite INT = @Site,
	@InternalFilter VARCHAR(MAX) = @Filter

SET	@InternalClient = ISNULL(@Client, 0)
SET	@InternalProject = ISNULL(@Project, 0)
SET @InternalSite = ISNULL(@Site, 0)

-- Start the main select
SELECT
	[SiteID] =			si.SiteID,
	[Address] =			si.Address,
	[Postcode] =		si.Postcode,
	[UPRN] =			si.UPRN,
	[PropertyType] =	pt.PropertyType
FROM
	Site si
	LEFT JOIN PropertyType pt ON si.PropertyTypeID = pt.PropertyTypeID
	INNER JOIN ClientSite cs ON si.SiteID = cs.SiteID
	LEFT JOIN ProjectSite ps ON si.SiteID = ps.SiteID
WHERE
	si.Deleted IS NULL
		AND
	((cs.ClientID = @InternalClient) OR @InternalClient = 0)
		AND
	((ps.ProjectID = @InternalProject) OR @InternalProject = 0)
		AND
	((si.SiteID = @InternalSite) OR @InternalSite = 0)
		AND
	(
		CASE WHEN LEN(@InternalFilter) = 0 THEN 1 ELSE
			CASE WHEN
				(
					si.Address LIKE '%' + @InternalFilter + '%'
						OR
					si.Postcode LIKE '%' + @InternalFilter + '%'
						OR
					si.Address + ', ' + si.Postcode LIKE '%' + @InternalFilter + '%'
						OR
					si.UPRN = @InternalFilter
				) THEN 1 ELSE 0 END
			END = 1
	)
GROUP BY
	si.SiteID,
	si.Address,
	si.Postcode,
	si.UPRN,
	pt.PropertyType

SET NOCOUNT OFF;
END
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 06/02/2019 14:29:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			[Identifier] =				ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC),
			[Row_Num] =					md.Row_Num,
			[Row_Total] =				md.Row_Total,
			[Page] =					md.Page,
			[Pages] =					md.Pages,
			[ClientID] =				md.ClientID,
			[Client] =					md.Client,
			[IsProjectGroup] =			CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1
											ELSE 0
										END,
			[ProjectGroupID] =			md.ProjectGroupID,
			[ProjectID] =				ISNULL(md.ProjectID, 0),
			[Name] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.ProjectGroup
											ELSE md.SubProjectName
										END,
			[Sites] =					ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END,
			[SitesRequired] =			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
										+ ' (' + 
										CASE 
											WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 
											THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
										ELSE 
											'N/A' 
										END + ')',
			[SitesBooked] =				SiteStatus.BookedCount,
			[SitesCompleted] =			SiteStatus.CompletedCount,
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar) [OutstandingJobs],
			[DueDate] =					md.DueDate,
			[Starts] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.Starts
											ELSE null
										END,
			[Ends] =					CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.Ends
											ELSE null
										END,
			[ProjectManager] =			CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.ProjectManager
											ELSE null
										END,
			[IsActive] =				CASE
											WHEN NULLIF(md.ProjectID,0) IS NULL THEN md.IsActive
											ELSE null
										END,
			[LegionellaTypeID] =		CASE
											WHEN md.ProjectID IS NOT NULL
											THEN ISNULL(md.LegionellaTypeID, 0)
											ELSE 0
										END,
			[IsLegionella] =			CAST(IsLegionella as BIT)
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			--OUTER APPLY
			--(
			--	SELECT
			--		COUNT(DISTINCT _j.JobID) [TotalJobs]
			--	FROM
			--		Job _j
			--		INNER JOIN Quote q ON _j.JobID = q.JobID
			--		INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
			--	WHERE
			--		_j.ProjectId = md.ProjectID			
			--) ProjectJobCount
			--OUTER APPLY
			--(
			--	SELECT
			--		COUNT(DISTINCT j.JobID) [TotalJobs]
			--	FROM
			--		ProjectGroup _pg
			--		INNER JOIN Project p ON _pg.ProjectGroupId = p.ProjectGroupId
			--		INNER JOIN Job j ON p.ProjectID = j.ProjectID
			--		INNER JOIN Quote q ON j.JobID = q.JobID
			--		INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
			--	WHERE
			--		_pg.ProjectGroupID = md.ProjectGroupID
			--) ProjectGroupTotal
			--OUTER APPLY
			--(
			--	SELECT
			--		COUNT(DISTINCT j.JobID) [ApprovedJobs]
			--	FROM
			--		ProjectGroup _pg
			--		INNER JOIN Project p ON _pg.ProjectGroupId = p.ProjectGroupId
			--		INNER JOIN Job j ON p.ProjectID = j.ProjectID
			--		INNER JOIN Quote q ON j.JobID = q.JobID
			--		INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
			--	WHERE
			--		_pg.ProjectGroupID = md.ProjectGroupID
			--			AND
			--		j.Approved IS NOT NULL
			--) ProjectGroupApproved
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__GenerateAirTestHTTPS') < 1
BEGIN
  ALTER TABLE Config
      ADD b__GenerateAirTestHTTPS BIT NOT NULL DEFAULT 0
END
GO



IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='MobileGuid')) BEGIN
	CREATE TABLE [dbo].[MobileGuid](
		[MobileGuidID] [int] IDENTITY(1,1) NOT NULL,
		[DeviceGuid] [uniqueidentifier] DEFAULT (newid()) NOT NULL,
		[DevDevice] [bit] NOT NULL,
		[Licensable] [bit] DEFAULT ((1)) NOT NULL,
		[LicensableExpiry] [datetime] NULL,
	 CONSTRAINT [PK_MobileGuid] PRIMARY KEY CLUSTERED 
	(
		[MobileGuidID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='App') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD App VARCHAR(50) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='Version') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD [Version] VARCHAR(50) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='Platform') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD [Platform] VARCHAR(50) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='DatabaseSize') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD DatabaseSize INT NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='DtsGuid') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD DtsGuid UNIQUEIDENTIFIER NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileAuditTrail') AND name='DeviceGuid') < 1
BEGIN
  ALTER TABLE MobileAuditTrail
      ADD DeviceGuid UNIQUEIDENTIFIER NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Equipment') AND name='DeviceGuid') < 1
BEGIN
  ALTER TABLE Equipment
      ADD DeviceGuid UNIQUEIDENTIFIER NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileDtcIdMap') AND name='DtsGuid') < 1
BEGIN
  ALTER TABLE MobileDtcIdMap
      ADD DtsGuid UNIQUEIDENTIFIER NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='MobileDtcLog') AND name='DtsGuid') < 1
BEGIN
  ALTER TABLE MobileDtcLog
      ADD DtsGuid UNIQUEIDENTIFIER NULL
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_MobileGuidUnitSummary') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_MobileGuidUnitSummary] AS BEGIN SET NOCOUNT ON; END')
END

GO


ALTER PROCEDURE [dbo].[TEAMS_MobileGuidUnitSummary]
	@IncludeDevDevice BIT

AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET NOCOUNT ON;

DECLARE @MobileAudit TABLE (SystemName VARCHAR(10), DateCreated DATETIME, EmployeeID INT, App VARCHAR(50), Version VARCHAR(50), DeviceGuid UNIQUEIDENTIFIER, DevDevice BIT, Licensable BIT, LicenseExpiry DATETIME)
INSERT INTO @MobileAudit
SELECT
	main.SystemName,
	main.DateCreated,
	main.EmployeeID,
	main.App,
	main.Version,
	main.DeviceGuid,
	main.DevDevice,
	main.Licensable,
	main.LicensableExpiry
FROM
	(
		SELECT
			mat.SystemName,
			DateCreated,
			EmployeeID,
			App,
			Version,
			mat.DeviceGuid,
			mg.DevDevice,
			mg.Licensable,
			mg.LicensableExpiry,
			ROW_NUMBER() OVER(PARTITION BY mat.DeviceGuid, mat.App ORDER BY mat.DateCreated DESC) [RowNo]
		FROM
			MobileAuditTrail mat
			INNER JOIN MobileGuid mg ON mat.DeviceGuid = mg.DeviceGuid
	) main
WHERE
	main.RowNo = 1

-- Star the main select
SELECT
	[DeviceGUID] =					mat.DeviceGuid,
	[DevDevice] =					mat.DevDevice,
	[Licensable] =					mat.Licensable,
	[LicensableExpiry] =			mat.LicenseExpiry,
	[LicenseKey] =					mulk.LicenceKey,
	[classicSystemName] =			classicData.[SystemName],
	[classicLastTransfer] =			classicData.[LastTransfer],
	[classicFullName] =				classicData.FullName,
	[classicVersion] =				classicData.Version,
	[SurveyingSystemName] =			survData.[SystemName],
	[SurveyingLastTransfer] =		survData.[LastTransfer],
	[SurveyingFullName] =			survData.FullName,
	[SurveyingVersion] =			survData.Version,
	[AirTestingSystemName] =		airData.[SystemName],
	[AirTestingLastTransfer] =		airData.LastTransfer,
	[AirTestingFullName] =			airData.FullName,
	[AirTestingVersion] =			airData.Version,
	[LegionellaSystemName] =		legData.[SystemName],
	[LegionellaLastTransfer] =		legData.LastTransfer,
	[LegionellaFullName] =			legData.FullName,
	[LegionellaVerion] =			legData.Version
FROM
	@MobileAudit mat
	LEFT JOIN Equipment eq ON mat.DeviceGuid = eq.DeviceGuid
	LEFT JOIN MobileUnitLicenceKey mulk ON eq.MobileUnitLicenceKeyID = mulk.MobileUnitLicenceKeyID
	OUTER APPLY
	(
		SELECT
			_mat.SystemName,
			_mat.DateCreated [LastTransfer],
			ISNULL(e.FullName,'Not Logged In') FullName,
			_mat.Version
		FROM
			@MobileAudit _mat
			LEFT OUTER JOIN Employee e ON _mat.EmployeeID = e.EmployeeID 
		WHERE
			mat.DeviceGuid = _mat.DeviceGuid
				AND
			_mat.App = 'Windows'
	) classicData
	OUTER APPLY
	(
		SELECT
			_mat.SystemName,
			_mat.DateCreated [LastTransfer],
			ISNULL(e.FullName,'Not Logged In') FullName,
			_mat.Version
		FROM
			@MobileAudit _mat
			LEFT OUTER JOIN Employee e ON _mat.EmployeeID = e.EmployeeID 
		WHERE
			mat.DeviceGuid = _mat.DeviceGuid
				AND
			_mat.App = 'Surveying'
	) survData
	OUTER APPLY
	(
		SELECT
			_mat.SystemName,
			_mat.DateCreated [LastTransfer],
			ISNULL(e.FullName,'Not Logged In') FullName,
			_mat.Version
		FROM
			@MobileAudit _mat
			LEFT OUTER JOIN Employee e ON _mat.EmployeeID = e.EmployeeID 
		WHERE
			mat.DeviceGuid = _mat.DeviceGuid
				AND
			_mat.App = 'AirTesting'
	) airData
	OUTER APPLY
	(
		SELECT
			_mat.SystemName,
			_mat.DateCreated [LastTransfer],
			ISNULL(e.FullName,'Not Logged In') FullName,
			_mat.Version
		FROM
			@MobileAudit _mat
			LEFT OUTER JOIN Employee e ON _mat.EmployeeID = e.EmployeeID 
		WHERE
			mat.DeviceGuid = _mat.DeviceGuid
				AND
			_mat.App = 'Legionella'
	) legData
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_CompletedSurveys') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_CompletedSurveys] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_CompletedSurveys]    Script Date: 12/02/2019 14:21:17 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER PROCEDURE [dbo].[Paged_CompletedSurveys] 
    -- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
    @Filter VARCHAR(MAX) = '',
    @JobID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@BranchId INT = 0,
    @EmployeeId INT = 0,
    @SurveyTypeId INT = 0,
    @SurveyStatus INT = 0,
	@FilterStartDate DATETIME = NULL,
    @FilterEndDate DATETIME = NULL

AS
BEGIN
    SET NOCOUNT ON;
    
    
    Set @FilterStartDate = ISNULL(@FilterStartDate,'1900-01-01 00:00:00') -- DATEADD(year,-1,GETDATE())
    Set @FilterEndDate = ISNULL(@FilterEndDate,'2099-12-31 23:59:59') -- DATEADD(month,3,GETDATE())

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1
      
    DECLARE @CompletedSurveysView TABLE (JobID INT,SurveyTypeID INT,Created DATETIME,EndDate DATETIME, PropertyType VARCHAR(50))
      
    Insert into @CompletedSurveysView (JobID,SurveyTypeID,Created,EndDate, PropertyType)
    Select  
        jd.JobID,
        su.SurveyTypeID,
        jd.Created,
        MAX(reg.RegisterFinish),
		jd.PropertyType
    From
        (
			Select 
				j.JobID, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate], pt.PropertyType
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
				INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
				INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
				INNER JOIN PropertyType pt WITH (NOLOCK) ON aSurv.PropertyTypeID = pt.PropertyTypeID
			WHERE
				a.DateDeclined IS NULL
					AND
				(CASE WHEN @FilterStartDate IS NULL OR @FilterEndDate IS NULL THEN 1 ELSE CASE WHEN j.Created BETWEEN @FilterStartDate AND @FilterEndDate THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
					AND
				j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
			GROUP BY
				j.JobID, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, pt.PropertyType
		) jd
		INNER JOIN Site si ON jd.SiteID=si.SiteID
        INNER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
		LEFT JOIN TestEmployee te WITH (NOLOCK) On reg.RegisterID = te.RegisterID
		LEFT JOIN Floorplan fp WITH (NOLOCK) On fp.RegisterID = reg.RegisterID
		INNER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId        
    Where 
		jd.Approved IS NOT NULL
			AND
		(
			(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN je.EmployeeID = @EmployeeId THEN 1 ELSE 0 END END = 1)
				OR
			(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN te.EmployeeID = @EmployeeId THEN 1 ELSE 0 END END = 1)
		)
		
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
			AND
		(CASE WHEN @SurveyTypeId = 0 THEN 1 ELSE CASE WHEN su.SurveyTypeID=@SurveyTypeId THEN 1 ELSE 0 END END = 1)
            And
        (
			CASE WHEN @SurveyStatus = 0 THEN
				1
			ELSE
				CASE WHEN NULLIF(reg.[Status],'') IS NULL THEN 
					CASE WHEN @SurveyStatus = 1 THEN 1 ELSE 0 END
				ELSE 
					CASE WHEN @SurveyStatus = 2 THEN 1 ELSE 0 END
				END
			END = 1
        )
    Group By
        jd.JobID,
        su.SurveyTypeID,
        jd.Created,
		jd.PropertyType
      
    DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @CompletedSurveysView)
    DECLARE @CompletedSurveysTopLevel TABLE (Pages INT, Page INT, Row_Num INT, JobID INT, EndDate DATETIME, SurveyTypeID INT, PropertyType VARCHAR(50))
    DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
    DECLARE @RegisterStatus TABLE (JobID INT, [Status] VARCHAR(MAX))
    DECLARE @EmployeesOnJob TABLE (JobID INT, EmployeeID INT)
    DECLARE @ReportFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
    DECLARE @RiskAssessmentFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
    DECLARE @BSRFile TABLE (JobID INT, [Filename] VARCHAR(MAX))
                    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.Created DESC) as Row_Num, 

            *
        From 
			(
				Select * FROM @CompletedSurveysView
			) a
    )
    
    Insert into @CompletedSurveysTopLevel (Pages, Page, Row_Num, JobID, EndDate, SurveyTypeID, PropertyType)
    Select
		main.Pages,
        main.Page,
        main.Row_Num,
        main.JobID,
        main.EndDate,
        main.SurveyTypeID,
		main.PropertyType
    FROM
		Paging main
	Where 
        (
            main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )
	
	INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				cstl.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@CompletedSurveysTopLevel cstl
				INNER JOIN Job j WITH (NOLOCK) On cstl.JobID = j.JobId
				INNER JOIN ClientTemplate ct WITH (NOLOCK) ON ct.ClientID = j.ClientID
				INNER JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1
		
	Insert into @RegisterStatus (JobID, [Status])
	Select
		cstl.JobID, reg.[Status]
	FROM
		@CompletedSurveysTopLevel cstl
		INNER JOIN JobEmployee je WITH (NOLOCK) On cstl.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
	GROUP BY
		cstl.JobID, reg.[Status]
    
    Insert into @EmployeesOnJob (JobID, EmployeeID)
    SELECT
		cstl.JobID, je.EmployeeID
    FROM
		@CompletedSurveysTopLevel cstl
		INNER JOIN JobEmployee je WITH (NOLOCK) On cstl.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId
	GROUP BY
		cstl.JobID, je.EmployeeID
	
	INSERT INTO @ReportFile(JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
		
	INSERT INTO @RiskAssessmentFile (JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
	
	INSERT INTO @BSRFile(JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				cstl.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY cstl.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSurveysTopLevel cstl
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = cstl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
	
	SELECT
		rd.[Row_Total],
		rd.Pages,
		rd.Page,
		rd.Row_Num,
		rd.JobID,
		rd.EndDate,
		rd.[Surveyors],
		rd.JobNo,
		rd.ClientOrderNo,
		rd.BranchOfficeID,
		rd.Created,
		rd.LastNoteCreated,
		rd.SurveyTypeID,
		rd.[Description],
		rd.ClientID,
		rd.Client, 
		rd.MiCADId,
		rd.ProjectId,
		rd.[ProjectName], 
		rd.SiteId,
		rd.[Address],
		rd.Postcode,
		rd.UPRN,
		rd.[Status],
		rd.[isNew], 
		rd.[HasNotes],
		rd.[NotesInLastHour],
		rd.[FileName],
		rd.[RiskFileName],
		rd.[BSRFileName],
		rd.[BSRClientTemplateID],
		rd.[IsSupplementary],
		rd.PropertyType,
		rd.Approved
	FROM
	(
		SELECT  
			@TotalRowNumber [Row_Total],
			main.Pages,
			main.Page,
			main.Row_Num,
			main.JobID,
			main.EndDate,
			surveyors.List [Surveyors],
			j.JobNo,
			j.ClientOrderNo,
			j.BranchOfficeID,
			j.Created,
			j.LastNoteCreated,
			main.SurveyTypeID,
			sut.[Description],
			c.ClientID,
			c.Client + IsNull(Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' End, '') Client, 
			c.MiCADId,
			p.ProjectId,
			p.Project + ' / ' + p.GroupName [ProjectName], 
			s.SiteId,
			s.[Address],
			s.Postcode,
			s.UPRN,
			rs.[Status],
			ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
			CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
			CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			rep_File.[Filename] [FileName],
			rep_RA.[Filename] [RiskFileName],
			rep_BSR.[Filename] [BSRFileName],
			bsr_CT.TemplateID [BSRClientTemplateID],
			CASE	
				WHEN sc.SupplementaryChangeId IS NOT NULL
				THEN 1
			ELSE
				0
			END [IsSupplementary],
			main.PropertyType,
			j.Approved,
			ROW_NUMBER() OVER (Partition BY main.JobID Order by sc.DateCreated DESC) [Identifier]
		From 
			@CompletedSurveysTopLevel main
			INNER JOIN Job j WITH (NOLOCK) On main.JobID = j.JobId
			INNER JOIN SurveyType sut WITH (NOLOCK) ON sut.SurveyTypeID=main.SurveyTypeID
			INNER JOIN @RegisterStatus rs ON main.JobID=rs.JobID
			INNER JOIN
				(
					SELECT
						eoj.JobID, 
						e.[List]
					FROM
						@EmployeesOnJob eoj
						OUTER APPLY
						(
							SELECT STUFF((SELECT ', ' + e.FullName FROM Employee e WITH(NOLOCK) INNER JOIN @EmployeesOnJob sub_eoj ON e.EmployeeID=sub_eoj.EmployeeID WHERE eoj.JobID=sub_eoj.JobID GROUP BY e.FullName Order by e.FullName FOR XML PATH('')), 1, 2, '') [List]
						) e
					GROUP BY
						eoj.JobID, e.List
				) surveyors ON surveyors.JobID = j.JobID
			LEFT OUTER Join Client c On j.ClientID = c.ClientID 
			LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
			LEFT OUTER Join Site s On j.SiteID = s.SiteID
			
			LEFT OUTER JOIN @ReportFile rep_File ON rep_File.JobID = j.JobID
			LEFT OUTER JOIN @RiskAssessmentFile rep_RA ON rep_RA.JobID = j.JobID
			LEFT OUTER JOIN @BSRFile rep_BSR ON rep_BSR.JobID = j.JobID
			LEFT OUTER JOIN @BulkSampleClientTemplate bsr_CT ON bsr_CT.JobID=j.JobID
			LEFT OUTER JOIN SupplementaryChanges sc ON j.JobID = sc.JobId
		) rd
	WHERE
		rd.Identifier = 1
    Order By
        rd.Row_Num
    
    
    SET NOCOUNT OFF;
END
GO



IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesWorkInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesWorkInProgress]    Script Date: 12/02/2019 14:25:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesCompletedJobs') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesCompletedJobs]    Script Date: 12/02/2019 14:31:06 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingQuotes') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingQuotes] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OutstandingQuotes]    Script Date: 12/02/2019 14:33:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Clone of Paged_QuoteHistory changed to Outstanding to repalce view
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */

ALTER PROCEDURE [dbo].[Paged_OutstandingQuotes]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filter
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@QuoteID INT = 0,
	@EnquiryID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@OutstandingQuotesFilterAssignedTo INT = 0,
	@OutstandingQuotesFilterQuoteType INT = 0,
	@OutstandingQuotesHideInstaquote INT = 0,
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @OutstandingQuotesViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @OutstandingQuotesView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX))
      
  	  Insert into @OutstandingQuotesViewID (ItemID,ItemType,Created)
	  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
	  From
			Quote q 
			Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
			Left Outer Join Job j On q.JobId = j.JobId
			Left Outer Join Client c On c.ClientID = q.ClientID 
			Left Outer Join Project p On p.ProjectID = q.ProjectID 
			Left Outer Join Site s On s.SiteID = q.SiteID
			LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID
			OUTER APPLY
			(
				SELECT CASE when
				EXISTS 
				( 
		        
					SELECT 
						'x'
					FROM
						[dbo].[Appointment] [a]
						INNER JOIN [dbo].[AppointmentType] [at] ON [at].[AppointmentTypeId] = [a].[AppointmentTypeID]
					WHERE
						[a].[QuoteID] = [q].[QuoteID]     
							AND
						[a].[AppointmentTypeID] = 8
				)
				THEN 
					1
				ELSE 
					0
				END 
			)isQuoteVisitApointment(val)
	  Where 
			(
				  LEN(@Filter ) = 0
						OR
				  (
						s.Address Like '%' + @Filter + '%'
							  Or 
						s.Postcode Like '%' + @Filter + '%'
							  Or 
						s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
						Or s.UPRN = @Filter
				)
			)
				  AND
			(
				CASE WHEN qt.QuoteVisitTypeID IS NOT NULL AND [isQuoteVisitApointment].[val] = 1 THEN
					(Select COUNT(*) FROM QuoteVisit qv INNER JOIN QuoteEmployee qe ON qv.QuoteEmployeeID=qe.QuoteEmployeeID Where qe.QuoteID=q.QuoteID AND qe.EmployeeID>0)
				ELSE
					1
				END = 1
			)
				And
			(Accepted Is Null) 
				AND
			(Rejected IS NULL)
				AND					  
			(@ProjectID=0 OR q.ProjectID=@ProjectID)
				  AND
			(@SiteID=0 OR q.SiteID=@SiteID)
				  AND
			(@ClientID=0 OR q.ClientID=@ClientID)
				  AND
			(
				  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
						CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
				  ELSE
						CASE WHEN
							  (
									q.Created BETWEEN @FilterStartDate AND @FilterEndDate
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @OutstandingQuotesFilterAssignedTo THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @OutstandingQuotesFilterQuoteType THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesHideInstaquote = 0 THEN 0 ELSE 
										Cast(
											Case When q.ReallyQuickQuote = 1 Then 
												1
											Else 
												0 
											End as bit) 
									END = 0
							  )
						THEN 1 ELSE 0 END
				  END = 1
			)
      
	  DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @OutstandingQuotesViewID)
		            
      ;With Paging As 
		( 
			Select 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
				END As Pages, 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
				END As Page, 

				   Row_Number() Over(Order By a.Created DESC) as Row_Num, 
				   *
				   From 
				   (
						Select * FROM @OutstandingQuotesViewID
				   ) a
		)
	
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
            ISNULL('Q' + Right('00000'+ Cast(e.QuoteNo as varchar), Case When Len(e.QuoteNo)<=6 Then 6 Else Len(e.QuoteNo) End),q.Status) [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.SiteUPRN,s.UPRN) [UPRN], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN 'Rejected' ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CAST(CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END as BIT) [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
            q.ReminderDate [ReminderDate],
            CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(ISNULL(s.SiteID,bQuoteHasSite.[Count]) as BIT) [bQuoteHasSite],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo],
			q.CurrencyId [CurrencyID]
    From 
            Paging main

            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
            
            LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
            
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null AND [FileName] Not  Like '%ra%'  order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            OUTER APPLY
            (
				Select COUNT(*) [Count] FROM ProjectSite Where ProjectID=p.ProjectID
            ) bQuoteHasSite
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoicesInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoicesInProgress] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoicesInProgress]    Script Date: 12/02/2019 14:35:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [dbo].[Paged_InvoicesInProgress]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
	@SiteID INT = 0,
    @Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
    @InvoiceID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,

	-- Order bys
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0
/**********************************************************************
** Overview: Get the data for the Invoices In Progress tab. Replaces the InvoicesInProgress view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceNo = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice In Progress data - just the minimum ammount of data for speed.
    DECLARE @InvoicesInProgressData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoicesInProgressData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                i.DateCompleted IS NULL
                    AND
                i.DateDiscarded IS NULL
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
                    AND
				(@SiteID = 0 OR ii.SiteID = @SiteID)
					AND
                i.DateCreated BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoicesInProgressData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoicesInProgressData
           ) a
    )   
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        i.LastNoteCreated,
        CAST(CASE WHEN i.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN i.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN i.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        CASE WHEN oi.InvoiceNo IS NOT NULL
            THEN dbo.FormatTeamsReference('I', oi.InvoiceNo)
            ELSE NULL
        END [OrigInvoiceNo],
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoiceHistory') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoiceHistory] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoiceHistory]    Script Date: 12/02/2019 14:36:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_InvoiceHistory]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
    @Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
    @InvoiceID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
	@InvoiceState INT = 0,

	-- Order bys
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0
/**********************************************************************
** Overview: Get the data for the Invoice History tab. Replaces the InvoiceHistory view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice History data - just the minimum ammount of data for speed.
    DECLARE @InvoiceHistoryData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoiceHistoryData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                (
                    i.DateCompleted IS NOT NULL
                        OR
                    i.DateDiscarded IS NOT NULL
                )
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
					AND
				(
					CASE WHEN @SiteID = 0 THEN
						1
					ELSE
						CASE WHEN @SiteID IN (Select SiteID FROM InvoiceItems Where InvoiceID=i.InvoiceID) THEN
							1
						ELSE
							0
						END
					END = 1				
				)
                    AND
                i.InvoiceDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
					(@InvoiceState = 0)
						OR
					(@InvoiceState = 1 AND i.DateDiscarded IS NULL)
						OR
					(@InvoiceState = 2 AND i.DateDiscarded IS NOT NULL)
				)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC,
	i.InvoiceNo DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoiceHistoryData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoiceHistoryData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        i.DateCompleted,
        i.DateDiscarded,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        lnc.DateCreated [LastNoteCreated],
        CAST(CASE WHEN lnc.DateCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN lnc.DateCreated IS NOT NULL
                THEN
                    CASE WHEN lnc.DateCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        i.OriginalInvoiceID,
        CAST(CASE WHEN EXISTS(SELECT 1 FROM Invoice _i WITH (NOLOCK) WHERE _i.OriginalInvoiceID = i.InvoiceID AND _i.DateDiscarded IS NULL) THEN 1 ELSE 0 END AS BIT) [HasAdditionalInvoices],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.InvoiceID = i.InvoiceID
                    AND
                _pf.DateDeleted IS NULL
            ORDER BY
                _pf.DateCreated DESC
        ) [FileName],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
        OUTER APPLY
        (
            SELECT MAX(n.DateCreated) [DateCreated]
            FROM Note n WITH (NOLOCK)
            WHERE
                n.NoteTypeID = 4 -- Invoice
                    AND
                n.ItemID = i.InvoiceID
        ) lnc -- Last Note Created
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 12/02/2019 14:37:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],
			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			+ ' (' + 
					CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],
			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='NewFeatures') AND name='Title') < 1
BEGIN
  ALTER TABLE NewFeatures
      ADD [Title] VARCHAR(MAX) NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 18/02/2019 10:58:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
					AND
				(c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL))
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],
			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			+ ' (' + 
					CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],
			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END


GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Report_Turnover') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_Report_Turnover] AS BEGIN SET NOCOUNT ON; END')
END

GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[TEAMS_Report_Turnover]    Script Date: 23/10/2019 09:10:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[TEAMS_Report_Turnover]
    @StartMonth datetime
AS 
BEGIN

    SET NOCOUNT on
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SET @StartMonth = CAST(@StartMonth AS datetime)
    
DECLARE @rez AS TABLE([TurnOver] money,quotetypeid int)
INSERT INTO @rez
SELECT 
    IsNull(Sum(isnull(ii.Cost,0) + isnull(pfi.Cost,0) + isnull(-ci.Cost,0)),0) TurnOver,
    ISNULL(q.QuoteTypeID,-1) quotetypeid
FROM 
    [dbo].[Invoice] i 
    LEFT OUTER JOIN [dbo].[CreditItem] ci ON i.[InvoiceID] = [ci].[InvoiceID] AND [ci].[DateRemoved] IS NULL 
    LEFT OUTER JOIN invoiceitem [ii] ON i.invoiceid = [ii].[InvoiceID] AND [ii].[DateRemoved] IS NULL 
    LEFT OUTER JOIN [dbo].[ProFormaItem] pfi ON i.[InvoiceID] = [pfi].[InvoiceID] AND pfi.[DateRemoved] IS NULL     
    LEFT OUTER JOIN [dbo].[Quote] q ON 
	(
		ci.[InvoiceItemID] = [q].[InvoiceItemID] OR 
		[ii].[InvoiceItemID] = [q].[InvoiceItemID] OR 
		[pfi].[ProFormaItemID] = [q].[ProFormaItemID]
    )
WHERE 
    DateDiscarded Is NULL 
		AND 
    ( 
        Cast(i.invoicedate as datetime) BETWEEN @startmonth and dateadd(MONTH,1,@StartMonth)
    )   
GROUP BY 
	rollup(ISNULL([q].QuoteTypeID,-1))
        
        
SELECT 
    CASE
        WHEN rez.quotetypeid IS NULL THEN 'Grand TOTAL'
        WHEN rez.quotetypeid = -1 THEN 'Items not assigned to Quotes'
    ELSE
        qt.QuoteType
    END QuoteType,
    cast(cast(ROUND(rez.[TurnOver],2,1) AS decimal(10,2)) AS varchar) [Total Turnover]
FROM 
    @rez rez
    LEFT OUTER JOIN QuoteType qt on qt.QuoteTypeID = rez.quotetypeid
    
    SET NOCOUNT off
END 

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 26/02/2019 09:24:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
					AND
				(c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL))
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
	
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		WHERE
			a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

		-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],

			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],

			--CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			--+ ' (' + 
			--		CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
			--			CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
			--		ELSE 'N/A' END + ')' [SitesRequired],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) as varchar)
			+ ' (' + 
					CASE WHEN CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) / CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],

			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],

			--CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			-- [OutstandingJobs],
			CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END as varchar)
			 [OutstandingJobs],

			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoiceHistory') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoiceHistory] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoiceHistory]    Script Date: 14/02/2019 15:18:00 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_InvoiceHistory]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
    @Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
    @InvoiceID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,
	@InvoiceState INT = 0,

	-- Order bys
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0
/**********************************************************************
** Overview: Get the data for the Invoice History tab. Replaces the InvoiceHistory view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice History data - just the minimum ammount of data for speed.
    DECLARE @InvoiceHistoryData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoiceHistoryData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                (
                    i.DateCompleted IS NOT NULL
                        OR
                    i.DateDiscarded IS NOT NULL
                )
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
					AND
				(
					CASE WHEN @SiteID = 0 THEN
						1
					ELSE
						CASE WHEN @SiteID IN (Select SiteID FROM InvoiceItems Where InvoiceID=i.InvoiceID) THEN
							1
						ELSE
							0
						END
					END = 1				
				)
                    AND
                i.InvoiceDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
					(@InvoiceState = 0)
						OR
					(@InvoiceState = 1 AND i.DateDiscarded IS NULL)
						OR
					(@InvoiceState = 2 AND i.DateDiscarded IS NOT NULL)
				)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
					AND
				i.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC,
	i.InvoiceNo DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoiceHistoryData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoiceHistoryData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        i.DateCompleted,
        i.DateDiscarded,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        lnc.DateCreated [LastNoteCreated],
        CAST(CASE WHEN lnc.DateCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN lnc.DateCreated IS NOT NULL
                THEN
                    CASE WHEN lnc.DateCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        i.OriginalInvoiceID,
        CAST(CASE WHEN EXISTS(SELECT 1 FROM Invoice _i WITH (NOLOCK) WHERE _i.OriginalInvoiceID = i.InvoiceID AND _i.DateDiscarded IS NULL) THEN 1 ELSE 0 END AS BIT) [HasAdditionalInvoices],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.InvoiceID = i.InvoiceID
                    AND
                _pf.DateDeleted IS NULL
            ORDER BY
                _pf.DateCreated DESC
        ) [FileName],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
        OUTER APPLY
        (
            SELECT MAX(n.DateCreated) [DateCreated]
            FROM Note n WITH (NOLOCK)
            WHERE
                n.NoteTypeID = 4 -- Invoice
                    AND
                n.ItemID = i.InvoiceID
        ) lnc -- Last Note Created
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_InvoicesInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_InvoicesInProgress] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_InvoicesInProgress]    Script Date: 14/02/2019 14:44:51 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER PROCEDURE [dbo].[Paged_InvoicesInProgress]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
	@SiteID INT = 0,
    @Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
    @InvoiceID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @InvoiceTypeID INT = 0,
    @EmployeeID INT = 0,

	-- Order bys
    @OrderByInvoiceType INT = 0,
    @OrderByInvoiceNo INT = 0,
    @OrderByClient INT = 0,
    @OrderByCreatedBy INT = 0,
    @OrderByItems INT = 0,
    @OrderByValue INT = 0,
    @OrderByInvoiceDate INT = 0,
    @OrderByStatus INT = 0
/**********************************************************************
** Overview: Get the data for the Invoices In Progress tab. Replaces the InvoicesInProgress view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByInvoiceType = 0 AND @OrderByInvoiceNo = 0 AND @OrderByClient = 0 AND @OrderByCreatedBy = 0 AND @OrderByItems = 0 AND @OrderByValue = 0 AND @OrderByInvoiceDate = 0 AND @OrderByStatus = 0
    BEGIN
        SET @OrderByInvoiceNo = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByInvoiceType [OrderByInvoiceType],
        @OrderByInvoiceNo [OrderByInvoiceNo],
        @OrderByClient [OrderByClient],
        @OrderByCreatedBy [OrderByCreatedBy],
        @OrderByItems [OrderByItems],
        @OrderByValue [OrderByValue],
        @OrderByInvoiceDate [OrderByInvoiceDate],
        @OrderByStatus [OrderByStatus]
    */
    
    -- Get all the Invoice In Progress data - just the minimum ammount of data for speed.
    DECLARE @InvoicesInProgressData TABLE (IndexID INT IDENTITY(1,1), InvoiceID INT, InvoiceNo INT, InvoiceDate DATETIME, Status VARCHAR(100), EmployeeID INT, Employee VARCHAR(50), ClientID INT, Client VARCHAR(210), InvoiceTypeID INT, InvoiceType VARCHAR(50), TemplateTypeID INT, Items INT, Total MONEY, Discount INT)
    
    INSERT INTO @InvoicesInProgressData
    SELECT
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID,
        SUM(i.Items) [Items],
        SUM(i.Total) [Total],
        SUM(i.Discount) [Discount]
    FROM
        (
            SELECT
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.Status,
                e.EmployeeID,
                e.FullName [Employee],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                COUNT(ii.InvoiceID) + COUNT(pfi.InvoiceID) + COUNT(ci.InvoiceID) [Items],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SampleDiscount) / 100
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.SurveyDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.AirtestDiscount) / 100
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0)) * (100 - i.TrainingDiscount) / 100
                    ELSE SUM(ISNULL(ii.Cost, 0) + ISNULL(pfi.Cost, 0) + ISNULL(ci.Cost, 0))
                END [Total],
                CASE
                    WHEN qt.InvoiceQuoteType = 'Bulk Sample Analysis' AND i.SampleDiscount > 0 THEN
                        i.SampleDiscount
                    WHEN qt.InvoiceQuoteType LIKE '%Survey%' AND i.SurveyDiscount > 0 THEN
                        i.SurveyDiscount
                    WHEN qt.InvoiceQuoteType = 'Air Monitoring' AND i.AirtestDiscount > 0 THEN
                        i.AirtestDiscount
                    WHEN qt.InvoiceQuoteType = 'Training' AND i.TrainingDiscount > 0 THEN
                        i.TrainingDiscount
                    ELSE 0
                END [Discount]
            FROM
                Invoice i WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON i.EmployeeID = e.EmployeeID
                INNER JOIN Client c WITH (NOLOCK) ON i.ClientID = c.ClientID
                INNER JOIN InvoiceType it WITH (NOLOCK) ON i.InvoiceTypeID = it.InvoiceTypeID
                LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
                LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON i.InvoiceID = ii.InvoiceID AND ii.DateRemoved IS NULL
                LEFT JOIN ProFormaItem pfi WITH (NOLOCK) ON i.InvoiceID = pfi.InvoiceID AND pfi.DateRemoved IS NULL
                LEFT JOIN CreditItem ci WITH (NOLOCK) ON i.InvoiceID = ci.InvoiceID AND ci.DateRemoved IS NULL
                LEFT JOIN QuoteType qt WITH (NOLOCK) ON (ii.QuoteTypeID = qt.QuoteTypeID OR pfi.QuoteTypeID = qt.QuoteTypeID OR ci.QuoteTypeID = qt.QuoteTypeID)
                LEFT OUTER JOIN Site si WITH (NOLOCK) ON (si.SiteID=ii.SiteID OR si.SiteID=pfi.SiteID OR si.SiteID=ci.SiteID)
            WHERE
                i.DateCompleted IS NULL
                    AND
                i.DateDiscarded IS NULL
                    AND
                (@ClientID = 0 OR i.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR i.ProjectID = @ProjectID)
                    AND
				(@SiteID = 0 OR ii.SiteID = @SiteID)
					AND
                i.DateCreated BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@InvoiceTypeID = 0 OR i.InvoiceTypeID = @InvoiceTypeID)
                    AND
                (@EmployeeID = 0 OR i.EmployeeID = @EmployeeID)
                    AND
                (@InvoiceID = 0 OR i.InvoiceID = @InvoiceID)
					AND
				(
				  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
								OR
							i.InvoiceClientOrderNo LIKE '%' + @Filter + '%'
					  ) THEN 1 ELSE 0 END
				  END = 1
				)
					AND
				i.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
            GROUP BY
                i.InvoiceID,
                i.InvoiceNo,
                i.InvoiceDate,
                i.SampleDiscount,
                i.SurveyDiscount,
                i.AirtestDiscount,
                i.TrainingDiscount,
                i.Status,
                e.EmployeeID,
                e.FullName,
                c.ClientID,
                c.Client,
                c.BranchName,
                it.InvoiceTypeID,
                it.InvoiceType,
                it.TemplateTypeID,
                qt.InvoiceQuoteType
        ) i
    GROUP BY
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.EmployeeID,
        i.Employee,
        i.ClientID,
        i.Client,
        i.InvoiceTypeID,
        i.InvoiceType,
        i.TemplateTypeID
    ORDER BY
        CASE WHEN @OrderByInvoiceType = 1 THEN i.InvoiceType ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceType = 2 THEN i.InvoiceType ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceNo = 1 THEN i.InvoiceNo ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceNo = 2 THEN i.InvoiceNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderByCreatedBy = 1 THEN i.Employee ELSE NULL END ASC,
        CASE WHEN @OrderByCreatedBy = 2 THEN i.Employee ELSE NULL END DESC,
        CASE WHEN @OrderByItems = 1 THEN SUM(i.Items) ELSE NULL END ASC,
        CASE WHEN @OrderByItems = 2 THEN SUM(i.Items) ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN SUM(i.Total) ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN SUM(i.Total) ELSE NULL END DESC,
        CASE WHEN @OrderByInvoiceDate = 1 THEN i.InvoiceDate ELSE NULL END ASC,
        CASE WHEN @OrderByInvoiceDate = 2 THEN i.InvoiceDate ELSE NULL END DESC,
        CASE WHEN @OrderByStatus = 1 THEN i.Status ELSE NULL END ASC,
        CASE WHEN @OrderByStatus = 2 THEN i.Status ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @InvoicesInProgressData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @InvoicesInProgressData
           ) a
    )   
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        i.InvoiceID,
        i.InvoiceNo,
        i.InvoiceDate,
        i.Status,
        i.DateCreated,
        CAST(CASE WHEN i.DateCreated > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        i.LastNoteCreated,
        CAST(CASE WHEN i.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN i.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN i.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.EmployeeID,
        pag.Employee,
        pag.ClientID,
        pag.Client,
        i.ProjectID,
        ipt.InvoicePaymentTermID,
        ipt.Term [PaymentTerm],
        pag.InvoiceTypeID,
        pag.InvoiceType,
        pag.TemplateTypeID,
        CASE WHEN oi.InvoiceNo IS NOT NULL
            THEN dbo.FormatTeamsReference('I', oi.InvoiceNo)
            ELSE NULL
        END [OrigInvoiceNo],
        pag.Items,
        pag.Total,
		i.InvoiceClientOrderNo,
		i.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Invoice i WITH (NOLOCK) ON pag.InvoiceID = i.InvoiceID
        INNER JOIN InvoicePaymentTerm ipt WITH (NOLOCK) ON i.InvoicePaymentTermID = ipt.InvoicePaymentTermID
        LEFT JOIN Invoice oi WITH (NOLOCK) ON i.OriginalInvoiceID = oi.InvoiceID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesCompletedJobs') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesCompletedJobs]    Script Date: 13/02/2019 09:30:43 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_OtherServicesCompletedJobs]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)

DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
SELECT
	c.ClientID,
	Access.EmployeeRestrictedClientAccessID
FROM
	Client c
	OUTER APPLY
	(
		SELECT
			erca.EmployeeRestrictedClientAccessID
		FROM
			EmployeeRestrictedClientAccess erca
		WHERE
			erca.EmployeeID = @LoggedInEmployeeID
				AND
			erca.ClientID = c.ClientID
	) Access
WHERE
	c.Restricted = 1
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
		AND
	j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 1
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
		AND
	j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
WHERE
	(
		CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE
			CASE
				WHEN (
						si.Address LIKE '%' + @Filter + '%'	
							OR
						si.Postcode LIKE '%' + @Filter + '%'	
							OR
						si.Address + ', ' + si.Postcode LIKE '%' + @Filter + '%'	
							OR
						si.UPRN = @Filter
					) THEN 1 ELSE 0
			END
		END = 1
	)
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END


GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OtherServicesWorkInProgress') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OtherServicesWorkInProgress]    Script Date: 13/02/2019 09:06:45 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[Paged_OtherServicesWorkInProgress]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @EmployeeID INT = 0,
	@QuoteVisitTypeID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
DECLARE @UseDefaultOrdering INT = 0

-- Set default variable values if not passed in.
SELECT
    @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
    @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME))

DECLARE
	@LegionellaEnabled BIT = (SELECT CASE WHEN DateDeleted IS NULL THEN 1 ELSE 0 END FROM TeamsV2Tab WHERE TabText = 'Legionella' AND TeamsV2SectionID = 5 AND DateDeleted IS NULL)

DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
SELECT
	c.ClientID,
	Access.EmployeeRestrictedClientAccessID
FROM
	Client c
	OUTER APPLY
	(
		SELECT
			erca.EmployeeRestrictedClientAccessID
		FROM
			EmployeeRestrictedClientAccess erca
		WHERE
			erca.EmployeeID = @LoggedInEmployeeID
				AND
			erca.ClientID = c.ClientID
	) Access
WHERE
	c.Restricted = 1
    
-- Get list of jobs upfront
DECLARE @OtherServicesJobList TABLE (JobID INT, JobNo INT, ClientID INT, SiteID INT, ProjectID INT, BranchOfficeID INT, LastNoteCreated DATETIME, Status VARCHAR(100), 
									Created DATETIME, AppointmentID INT)
INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID NOT IN (1, 3, 9)
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
		AND
	j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created

IF @LegionellaEnabled = 0
BEGIN
	INSERT INTO @OtherServicesJobList
SELECT
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created,
	MAX(a.AppointmentID)
FROM
	Job j
	INNER JOIN Quote q ON j.JobId = q.JobID
	LEFT JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID = 9
WHERE
	a.ManuallyMarkWorkDone = 0
		AND
	a.DateDeclined IS NULL
		AND
	a.DateConfirmed IS NOT NULL
		AND 
	((j.ClientID = @ClientID) OR @ClientID = 0)
		AND
	((j.ProjectID = @ProjectID) OR @ProjectID = 0)
		AND
	((j.SiteID = @SiteID) OR @SiteID = 0)
		AND
	((j.BranchOfficeID = @BranchOfficeID) OR @BranchOfficeID = 0)
		AND
	a.StartTime BETWEEN @FilterStartDate AND @FilterFinishDate
		AND
	((qt.QuoteVisitTypeID = @QuoteVisitTypeID) OR @QuoteVisitTypeID = 0)
		AND
	j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
GROUP BY
	j.JobID,
	j.JobNo,
	j.ClientID,
	j.SiteID,
	j.ProjectID,
	j.BranchOfficeID,
	j.LastNoteCreated,
	j.Status,
	j.Created	
END

-- Get all of the data needed for the procedure
DECLARE @OtherServicesJobData TABLE (IndexID INT IDENTITY(1,1), QuoteVisitTypeID INT, ReportType VARCHAR(MAX), QuoteID INT, StartDate DATETIME, DueDate DATETIME, JobID INT, JobNo INT,
									LastNoteCreated DATETIME, BranchOfficeID INT, ProjectID INT, Created DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, PostCode VARCHAR(50),
									UPRN VARCHAR(50), Address VARCHAR(MAX), Status VARCHAR(100))

INSERT INTO @OtherServicesJobData
SELECT
	qt.QuoteVisitTypeID,
	COALESCE(ac.Description, qvt.Description, qt.QuoteType),
	q.QuoteID,
	a.StartTime,
	ag.DueDate,
	j.JobID,
	j.JobNo,
	j.LastNoteCreated,
	j.BranchOfficeID,
	j.ProjectID,
	j.Created,
	j.ClientID,
	c.Client,
	j.SiteID,
	si.Postcode,
	si.UPRN,
	si.Address,
	j.Status
FROM
	@OtherServicesJobList j
	INNER JOIN Client c ON j.ClientID = c.ClientID
	LEFT JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Quote q ON j.JobID = q.JobID
	INNER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID
	INNER JOIN Appointment a ON j.AppointmentID = a.AppointmentID
	LEFT JOIN AppointmentGeneral ag ON a.AppointmentID = ag.AppointmentID
	LEFT JOIN AppointmentCategory ac ON a.AppointmentCategoryID = ac.AppointmentCategoryID
	LEFT JOIN QuoteVisitType qvt ON qt.QuoteVisitTypeID = qvt.QuoteVisitTypeID
WHERE
	(
		CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE
			CASE
				WHEN (
						si.Address LIKE '%' + @Filter + '%'
							OR
						si.Postcode LIKE '%' + @Filter + '%'
							OR
						si.Address + ', ' + si.Postcode LIKE '%' + @Filter + '%'
							OR
						si.UPRN = @Filter
					) THEN 1 ELSE 0
			END
		END = 1
	)
    
-- Get the total number of rows.
DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OtherServicesJobData);
    
-- Use a CTE to setup paging.
WITH Paging AS
(
    SELECT
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE ((a.IndexID - 1) / @PerPage) + 1
        END [Page],
        CASE WHEN @PerPage = 0
            THEN 1
            ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
        END [Pages],
        a.*
    FROM
        (
            SELECT * FROM @OtherServicesJobData
        ) a
) 

-- Start the main select
SELECT
	@TotalRowNumber [TotalRowNumber],
	p.* 
FROM
	Paging p
WHERE
	(
		(p.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
			OR
		(@PerPage = 0 AND @CurrentPage = 0)
    )
    
    SET NOCOUNT OFF;
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingQuotes') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingQuotes] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OutstandingQuotes]    Script Date: 13/02/2019 14:24:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Clone of Paged_QuoteHistory changed to Outstanding to repalce view
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */

ALTER PROCEDURE [dbo].[Paged_OutstandingQuotes]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filter
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@QuoteID INT = 0,
	@EnquiryID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@OutstandingQuotesFilterAssignedTo INT = 0,
	@OutstandingQuotesFilterQuoteType INT = 0,
	@OutstandingQuotesHideInstaquote INT = 0,
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))

	  DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	  INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	  SELECT
			c.ClientID,
			Access.EmployeeRestrictedClientAccessID
	  FROM
			Client c
			OUTER APPLY
			(
				SELECT
					erca.EmployeeRestrictedClientAccessID
				FROM
					EmployeeRestrictedClientAccess erca
				WHERE
					erca.EmployeeID = @LoggedInEmployeeID
						AND
					erca.ClientID = c.ClientID
			) Access
	  WHERE
			c.Restricted = 1
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @OutstandingQuotesViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @OutstandingQuotesView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX))
      
  	  Insert into @OutstandingQuotesViewID (ItemID,ItemType,Created)
	  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
	  From
			Quote q 
			Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
			Left Outer Join Job j On q.JobId = j.JobId
			Left Outer Join Client c On c.ClientID = q.ClientID 
			Left Outer Join Project p On p.ProjectID = q.ProjectID 
			Left Outer Join Site s On s.SiteID = q.SiteID
			LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID
			OUTER APPLY
			(
				SELECT CASE when
				EXISTS 
				( 
		        
					SELECT 
						'x'
					FROM
						[dbo].[Appointment] [a]
						INNER JOIN [dbo].[AppointmentType] [at] ON [at].[AppointmentTypeId] = [a].[AppointmentTypeID]
					WHERE
						[a].[QuoteID] = [q].[QuoteID]     
							AND
						[a].[AppointmentTypeID] = 8
				)
				THEN 
					1
				ELSE 
					0
				END 
			)isQuoteVisitApointment(val)
	  Where 
			(
				  LEN(@Filter ) = 0
						OR
				  (
						s.Address Like '%' + @Filter + '%'
							  Or 
						s.Postcode Like '%' + @Filter + '%'
							  Or 
						s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
						Or s.UPRN = @Filter
				)
			)
				  AND
			(
				CASE WHEN qt.QuoteVisitTypeID IS NOT NULL AND [isQuoteVisitApointment].[val] = 1 THEN
					(Select COUNT(*) FROM QuoteVisit qv INNER JOIN QuoteEmployee qe ON qv.QuoteEmployeeID=qe.QuoteEmployeeID Where qe.QuoteID=q.QuoteID AND qe.EmployeeID>0)
				ELSE
					1
				END = 1
			)
				And
			(Accepted Is Null) 
				AND
			(Rejected IS NULL)
				AND					  
			(@ProjectID=0 OR q.ProjectID=@ProjectID)
				  AND
			(@SiteID=0 OR q.SiteID=@SiteID)
				  AND
			(@ClientID=0 OR q.ClientID=@ClientID)
				  AND
			(
				  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
						CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
				  ELSE
						CASE WHEN
							  (
									q.Created BETWEEN @FilterStartDate AND @FilterEndDate
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @OutstandingQuotesFilterAssignedTo THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @OutstandingQuotesFilterQuoteType THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesHideInstaquote = 0 THEN 0 ELSE 
										Cast(
											Case When q.ReallyQuickQuote = 1 Then 
												1
											Else 
												0 
											End as bit) 
									END = 0
							  )
						THEN 1 ELSE 0 END
				  END = 1
			)
				AND
			q.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      
	  DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @OutstandingQuotesViewID)
		            
      ;With Paging As 
		( 
			Select 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
				END As Pages, 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
				END As Page, 

				   Row_Number() Over(Order By a.Created DESC) as Row_Num, 
				   *
				   From 
				   (
						Select * FROM @OutstandingQuotesViewID
				   ) a
		)
	
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
            ISNULL('Q' + Right('00000'+ Cast(e.QuoteNo as varchar), Case When Len(e.QuoteNo)<=6 Then 6 Else Len(e.QuoteNo) End),q.Status) [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.SiteUPRN,s.UPRN) [UPRN], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN 'Rejected' ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CAST(CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END as BIT) [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
            q.ReminderDate [ReminderDate],
            CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(ISNULL(s.SiteID,bQuoteHasSite.[Count]) as BIT) [bQuoteHasSite],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo],
			q.CurrencyId [CurrencyID]
    From 
            Paging main

            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
            
            LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
            
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null AND [FileName] Not  Like '%ra%'  order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            OUTER APPLY
            (
				Select COUNT(*) [Count] FROM ProjectSite Where ProjectID=p.ProjectID
            ) bQuoteHasSite
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END
GO
IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 27/02/2019 09:29:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO









ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
					AND
				(c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL))
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

	-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],

			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],

			--CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			--+ ' (' + 
			--		CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
			--			CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
			--		ELSE 'N/A' END + ')' [SitesRequired],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) as varchar)
			+ ' (' + 
					CASE WHEN CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) / CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],

			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],

			--CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			-- [OutstandingJobs],
			CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END as varchar)
			 [OutstandingJobs],

			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END


GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END

GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 R2 (10.50.6560)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008 R2
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 28/02/2019 09:48:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
					AND
				(c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL))
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

	-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],

			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],

			--CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			--+ ' (' + 
			--		CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
			--			CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
			--		ELSE 'N/A' END + ')' [SitesRequired],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) as varchar)
			+ ' (' + 
					CASE WHEN CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) / CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],

			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],

			CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar)
			 [OutstandingJobs],
			--CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END as varchar)
			-- [OutstandingJobs],

			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						AND
					s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						AND
					s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END


GO


IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'mobileTEAMS') < 1
BEGIN
	INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order], IsMvcTab, UsesMvcSubTabs) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'mobileTEAMS', 10, 1, 1)
END
GO

UPDATE TeamsV2Tab SET IsMvcTab = 1 WHERE TabText = 'mobileTEAMS' AND TeamsV2SectionID = (SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management')

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__DisableInvoicing') < 1
BEGIN
  ALTER TABLE Config
      ADD b__DisableInvoicing BIT NOT NULL DEFAULT 0
END
GO

IF (SELECT COUNT(*) FROM TeamsV2Tab WHERE TabText = 'System Preferences' AND TeamsV2SectionID = (SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management')) < 1
BEGIN
	INSERT INTO TeamsV2Tab (TeamsV2SectionID, TabText, [Order], IsMvcTab, UsesMvcSubTabs) VALUES ((SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management'), 'System Preferences', 12, 1, 1)
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'General' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'General', 0, NULL, 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Appointments' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Appointments', 1, GETDATE(), 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

UPDATE TeamsV2SubTab
SET DateDeleted = NULL WHERE TabText = 'Appointments' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Quotes & Enquiries' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Quotes & Enquiries', 2, GETDATE(), 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Management' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Management', 3, GETDATE(), 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Reports' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Reports', 4, GETDATE(), 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

UPDATE TeamsV2SubTab
SET DateDeleted = NULL WHERE TabText = 'Reports' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Invoicing' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Invoicing', 5, NULL, 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Samples' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')) = 0
BEGIN
	insert into TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab, IsHidden)
	SELECT TeamsV2TabID, 'Samples', 6, GETDATE(), 1, 0 FROM TeamsV2Tab WHERE TabText = 'System Preferences'
END
GO

UPDATE TeamsV2SubTab
SET DateDeleted = NULL WHERE TabText = 'Samples' AND TeamsV2TabID = (SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'System Preferences')
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ServiceStatusUpdate'))
BEGIN
	CREATE TABLE [dbo].[ServiceStatusUpdate](
		[ServiceStatusUpdateID] [int] IDENTITY(1,1) NOT NULL,
		[DateCreated] [datetime] NOT NULL,
		[Title] [varchar](max) NULL,
		[HTML] [varchar](max) NULL,
		[Active] [bit] NOT NULL,
	CONSTRAINT [PK_ServiceStatusUpdate] PRIMARY KEY CLUSTERED 
	(
		[ServiceStatusUpdateID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (Select COUNT(*) FROM sys.columns c INNER JOIN sys.tables t ON c.object_id=t.object_id INNER JOIN sys.default_constraints dc ON dc.object_id=c.default_object_id where  c.name='DateCreated' AND t.name='ServiceStatusUpdate') = 0 
BEGIN
	ALTER TABLE [dbo].[ServiceStatusUpdate] ADD  DEFAULT (getdate()) FOR [DateCreated]
END
GO

IF (Select COUNT(*) FROM sys.columns c INNER JOIN sys.tables t ON c.object_id=t.object_id INNER JOIN sys.default_constraints dc ON dc.object_id=c.default_object_id where  c.name='Active' AND t.name='ServiceStatusUpdate') = 0 
BEGIN
	ALTER TABLE [dbo].[ServiceStatusUpdate] ADD  DEFAULT ((0)) FOR [Active]
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetPortalLegionellaHomeTabGraphDataSitesCheckedLastMonth') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetPortalLegionellaHomeTabGraphDataSitesCheckedLastMonth] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 R2 (10.50.4000)
    Source Database Engine Edition : Microsoft SQL Server Express Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008 R2
    Target Database Engine Edition : Microsoft SQL Server Express Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[GetPortalLegionellaHomeTabGraphDataSitesCheckedLastMonth]    Script Date: 21/03/2019 09:06:06 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[GetPortalLegionellaHomeTabGraphDataSitesCheckedLastMonth]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = 0,
	@ChartSeriesClick VARCHAR(MAX) = ''

/**********************************************************************
** Overview: Get Legionella data which is used by the graphs on the Home tab of the Portal.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;

    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0),
		@ChartSeriesClick = NULLIF(@ChartSeriesClick, '')

	DECLARE 
		@SitesCheckedClick BIT = 0

	IF @ChartSeriesClick = 'Sites Checked' 
	BEGIN 
		SET @SitesCheckedClick = 1
	END

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
				AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
				AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

DECLARE @SiteComputedData TABLE (SiteID INT, MaxRecorded DATETIME)
INSERT INTO @SiteComputedData
SELECT
	SiteID,
	scd.Recorded
FROM
	@ClientSiteData cd	
	CROSS APPLY
	(
		SELECT TOP 1
			lo.LegionellaOutletID
		FROM
			Job j 
			INNER JOIN JobEmployee je ON j.JobId = je.JobID
			INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
			INNER JOIN LegionellaLocation ll On l.LegionellaID = ll.LegionellaID
			INNER JOIN LegionellaOutlet lo ON ll.LegionellaLocationID = lo.LegionellaLocationID
	) lo
	OUTER APPLY
	(
		SELECT
			MAX(scd.Recorded) [Recorded]
		FROM
			LegionellaOutletComputedData scd
		WHERE
			cd.SiteId = scd.SiteId
				AND
			(scd.Hot IS NOT NULL OR scd.Cold IS NOT NULL OR scd.Mixed IS NOT NULL OR scd.Mains IS NOT NULL)
				AND
			-- Not include dates that are past the last date of the last month
			(scd.Recorded <= DATEADD(d, -DAY(GETDATE()), GETDATE()))
	) scd


DECLARE
	@TotalSites INT = (SELECT COUNT(scd.SiteID) FROM @SiteComputedData scd)

-- Start the main select
IF @ReturnAsChart = 1
BEGIN
	SELECT
		[category] =		'Sites Not Checked',
		[Colour] =			'#E8412D',
		[Share] =			@TotalSites - main.[Sites that were Checked],
		[TotalItems] =		@TotalSites
	FROM
	(
		SELECT
			(SELECT
				COUNT(scd.SiteID)
			FROM 
				@SiteComputedData scd 
			WHERE
				(
					(
						DATEPART(YEAR, scd.MaxRecorded) = DATEPART(YEAR, GETDATE())
							AND
						DATEPART(MONTH, scd.MaxRecorded) = DATEPART(MONTH, DATEADD(MONTH, -1, GETDATE()))
					)
						OR
					scd.MaxRecorded IS NULL
			)) [Sites that were Checked]
	) main

	UNION

	-- Start the main select
	SELECT
		[category] =		'Sites Checked',
		[Colour] =			'#808080',
		[Share] =			main.[Sites that were Checked],
		[TotalItems] =		@TotalSites
	FROM
	(
		SELECT
			(SELECT
				COUNT(scd.SiteID)
			FROM 
				@SiteComputedData scd 
			WHERE
				(
					(
						DATEPART(YEAR, scd.MaxRecorded) = DATEPART(YEAR, GETDATE())
							AND
						DATEPART(MONTH, scd.MaxRecorded) = DATEPART(MONTH, DATEADD(MONTH, -1, GETDATE()))
					)
						OR
					scd.MaxRecorded IS NULL
			)) [Sites that were Checked]
	) main
END
ELSE
BEGIN

	DECLARE @Sites TABLE (SiteID INT, Address VARCHAR(MAX), Postcode VARCHAR(MAX), Telephone VARCHAR(MAX), Contact VARCHAR(MAX), UPRN VARCHAR(MAX), Checked INT)
	INSERT INTO @Sites
	SELECT
		s.SiteID,
		s.Address,
		s.Postcode,
		s.Telephone,
		s.Contact,
		s.UPRN,
		CASE
			WHEN scd.MaxRecorded IS NULL
			THEN 1
			ELSE
				CASE
					WHEN DATEPART(YEAR, scd.MaxRecorded) = DATEPART(YEAR, GETDATE()) AND DATEPART(MONTH, scd.MaxRecorded) = DATEPART(MONTH, DATEADD(MONTH, -1, GETDATE()))
					THEN 1
					ELSE 0
				END
		END [Checked]
	FROM
		@SiteComputedData scd
		INNER JOIN Site s WITH (NOLOCK) ON scd.SiteID = s.SiteID
	ORDER BY
		Checked ASC

	IF @SitesCheckedClick = 1
		BEGIN
			SELECT * FROM @Sites WHERE Checked = 1
		END
	ELSE
		BEGIN
			SELECT * FROM @Sites WHERE Checked = 0
		END
	END

END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'QualityControlSampleList_2') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[QualityControlSampleList_2] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[QualityControlSampleList_2]    Script Date: 27/03/2019 11:46:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER PROCEDURE [dbo].[QualityControlSampleList_2]
    @startdate [datetime] =NULL,
    @enddate [datetime] =NULL,
    @clientid [int] =NULL,
    @ProjectId int =NULL,
    @siteid int =NULL,
    @employeeid int= 0,
    @mode int = 1,
    @forceUpdateCounts bit = 1
AS
BEGIN
set transaction ISOLATION level READ uncommitted 

SET NOCOUNT ON 
--update QCOutnstandingCountByDay for some bizare reason!
DECLARE @internalstartdate [datetime],@internalenddate [datetime]

DECLARE @maxpoints int
SET @maxpoints = (SELECT Max(i__MaxDailyPoints) FROM Config)

DECLARE @ceilingpercentage decimal(5, 3)
SET @ceilingpercentage = (SELECT Max(i__QcCeilingPercentage) FROM Config)

SET @internalstartdate = @startdate
SET @internalenddate = @enddate

IF @employeeid IS NULL
BEGIN
	set @employeeid = 0
END

IF @internalstartdate IS NULL 
BEGIN
    set @internalstartdate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 00:00:00' as datetime)
END 

IF @internalenddate IS NULL 
BEGIN
    set @internalenddate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 23:59:59' as datetime)
END 

if (CONVERT(VARCHAR(8),@internalenddate,108) = '00:00:00')
begin 
    set @internalenddate = cast(CONVERT(VARCHAR(11),@internalenddate,106) + ' 23:59:59' as datetime)
END 

If @mode = 3 BEGIN
	Select
		rs.theDay  [_day],
		rs.Total [c]	
	FROM
		QCOutstandingCountByDay rs
	Where 
		rs.theDay = @internalstartdate
END


If @mode < 3 BEGIN

DECLARE @SampleTable TABLE (SessionRef VARCHAR(50),SampleID INT, OrderIdentifier INT, TimeIdentifier INT,CreatedDate DATE,CreatedDateTime DATETIME, sampleTestCollectionID INT, SampleTestID INT,datasaved INT, _name VARCHAR(MAX), EmployeeID INT)
Insert into @SampleTable (SessionRef,SampleID,OrderIdentifier, TimeIdentifier,CreatedDate,CreatedDateTime,sampleTestCollectionID,SampleTestID,datasaved,_name,EmployeeID)
SELECT 
	test_st._sessionRef,
	test_st._sampleID,
	ROW_NUMBER() OVER (Partition By test_st._sampleID,test_st._EmployeeID Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [OrderIdentifier],
	ROW_NUMBER() OVER (Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [TimeIdentifier],
	[test_st].[_testCreatedOn] [_testCreatedOn],
	[test_st].[_testCreatedOn] [_testCreatedOn],
    test_st.[sampleTestCollectionID],
    test_st.[sampleTestID],
    test_st._wasSaved [datasaved],
    [test_st].[_name],
    [test_st]._employeeID
FROM 
    sampletest test_st 
    INNER JOIN Sample s ON test_st._sampleID=s.SampleID
    INNER JOIN SampleTestCollection stc ON test_st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
    LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = test_st.sampleTestCollectionID
		AND
		test_st._SessionRef = stcs.sessionref
WHERE
    ((test_st.[_name] ='AnalysisTest') OR (test_st.[_name] ='AnalysisQC'))
    AND (test_st.[_testCancelledOn] IS NULL)
    AND [test_st].[_wasSaved] = 1
    AND ([test_st].[_testCreatedOn] BETWEEN @internalstartdate AND @internalenddate) 
    AND (test_st._employeeID = @employeeid OR @employeeid = 0)
Order By
	test_st._sampleID

DECLARE @SampleRowNumber TABLE (SampleID INT, RowNumber INT)
Insert into @SampleRowNumber (SampleID, RowNumber)
Select
	st.SampleID, ROW_NUMBER() OVER (PARTITION BY MAX(st.CreatedDate) ORDER BY MAX(st.CreatedDateTime), MAX(st.SampleTestID)) [rownumber]
FROM 
	@SampleTable st
GROUP BY
	st.SampleID

DECLARE @OriginalTest TABLE (SampleTestID INT,SampleID INT, EmployeeID INT, CreatedDate DATE, Analysed DATETIME)
Insert into @OriginalTest (SampleTestID,SampleID,EmployeeID,CreatedDate,Analysed)
Select main.SampleTestID,main.SampleID, main.EmployeeID, main.CreatedDate, main.Analysed
FROM
(Select
	_ori.SampleTestID,ROW_NUMBER() OVER (PARTITION BY st.SampleID ORDER BY _ori._testCreatedOn DESC) [OrderIdentifier],st.SampleID, _ori._employeeID [EmployeeID], _ori._testCreatedOn [CreatedDate], stcs.sample_dateanalysed [Analysed]
FROM
	@SampleTable st 
	LEFT OUTER JOIN SampleTest _ori ON st.SampleID=_ori._sampleID 
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
Where
	_ori._testCreatedOn <= st.CreatedDateTime
		AND
	_ori._name = 'AnalysisTest' --AND 
) main
Where
	main.OrderIdentifier=1

DECLARE @SampleAllResult TABLE (SampleID INT, _testCreatedOn DATE, RowNumber INT,sampleTestCollectionSessionID INT)
Insert into @SampleAllResult (SampleID, RowNumber,sampleTestCollectionSessionID)
Select
	srn.SampleID, srn.RowNumber [rownumber],MAX(stcs.sampleTestCollectionSessionID)
FROM
	@SampleRowNumber srn
	INNER JOIN @SampleTable st ON srn.SampleID=st.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
		AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
Group By
	srn.SampleID,srn.RowNumber

DECLARE @QCSample TABLE (SampleTestID INT,SampleID INT, EmployeeID INT,sampleTestCollectionSessionID INT, Analysed DATETIME)
Insert into @QCSample (SampleTestID,SampleID,EmployeeID,sampleTestCollectionSessionID,Analysed)
Select 
	main.SampleTestID, main.SampleID, main.EmployeeID, main.sampleTestCollectionSessionID, main.Analysed
FROM
(Select
	st.SampleTestID,st.SampleID, st.EmployeeID,stcs.sampleTestCollectionSessionID, stcs.sample_dateanalysed [Analysed],
	ROW_NUMBER() OVER (Partition By st.SampleID Order By st.CreatedDateTime DESC) [OrderIdentifier]
FROM
	@SampleTable st
	INNER JOIN SampleTestCollection stc ON st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
	INNER JOIN SampleTestCollectionSession stcs ON 
		stcs.sampleTestCollectionID = st.sampleTestCollectionID
			AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
		--	AND 
		--stcs.sessionref = st.SessionRef
Where
	st._name = 'AnalysisQC'
) main
Where main.OrderIdentifier=1

DECLARE @FutureSamples TABLE (SampleID INT, EmployeeID INT, _name VARCHAR(MAX), TestCreatedOn DATETIME)
Insert into @FutureSamples
Select main._SampleID, main._EmployeeID, main._Name, main._TestCreatedOn
FROM
(
Select
	test_st._sampleID, test_st._employeeID, test_st._name, test_st._testCreatedOn
FROM
	sampletest test_st
	INNER JOIN @SampleTable st ON st.SampleID=test_st._SampleID
Where
	test_st._testCancelledOn IS NULL
		AND
	test_st._testCreatedOn > cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
) main


DECLARE @FutureQCSample TABLE (SampleID INT, EmployeeID INT, TestCreatedOn VARCHAR(MAX))
Insert into @FutureQCSample (SampleID,EmployeeID, TestCreatedOn)
Select main.SampleID, main.EmployeeID, main.TestCreatedOn
FROM
(Select
	st.SampleID, st.EmployeeID, fs.TestCreatedOn, ROW_NUMBER() OVER (Partition By st.SampleID Order By fs.TestCreatedOn DESC) [OrderIdentifier] --NEED TO MAKE THIS STUFF
FROM
	@SampleTable st
	INNER JOIN @FutureSamples fs ON st.SampleID=fs.SampleID AND fs._name='AnalysisQC'
Where
	st._name = 'AnalysisTest'
) main
Where
	main.OrderIdentifier=1

--DECLARE A TABLE VALUE SO WE CAN TALLY UP POINTS
DECLARE @ResultSet TABLE (EmployeeID INT,[otSampleTestID] INT,[OriginalAnalystEmployeeID] INT,[qcEmployeeID] INT,[stSampleTestID] INT,[qcSampleTestID] INT,[Test No] INT,[SampleID] INT,[analysed] INT,[OriginalAnalystName] VARCHAR(MAX),[qc] INT,[datasaved] BIT,[qcdInFuture] INT,[sampleTestCollectionSessionID] INT,[sampleref] VARCHAR(MAX),[totalsofar] INT,[rownumber] INT,[OverMaxPoints] INT,[Points] INT, [Star] BIT,[sampleClassificationDetails] VARCHAR(MAX),[sampleresultdetails] VARCHAR(MAX),[loggedSampleClassificationExtendedID] INT,[loggedSampleClassificationID] INT,[loggedSampleResultID] INT,[testCreatedOn] DATE,[JobID] INT,[jobno] VARCHAR(MAX),[FullName] VARCHAR(MAX),[Approved] INT,[allowcheck] INT,[futuredates_string] VARCHAR(MAX),[CreatedDate] DATE,[AnalysedToday] INT,[qcdToday] INT,[otCreatedDate] DATE)
Insert into @ResultSet (EmployeeID,[OriginalAnalystEmployeeID],[qcEmployeeID],[otSampleTestID],[stSampleTestID],[qcSampleTestID],[Test No],[SampleID],[analysed],[OriginalAnalystName],[qc],[datasaved],[qcdInFuture],[sampleTestCollectionSessionID],[sampleref],[totalsofar],[rownumber],[OverMaxPoints],[Points],[Star],[sampleClassificationDetails],[sampleresultdetails],[loggedSampleClassificationExtendedID],[loggedSampleClassificationID],[loggedSampleResultID],[testCreatedOn],[JobID],[jobno],[FullName],[Approved],[allowcheck],[futuredates_string],[CreatedDate],[AnalysedToday],[qcdToday],[otCreatedDate])
Select 
	e.EmployeeID,
	OriginalAnalyst.EmployeeID [OriginalAnalystEmployeeID],
	qc.EmployeeID [qcEmployeeID],
	ot.SampleTestID [otSampleTestID],
	st.SampleTestID [stSampleTestID],
	CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END [qcSampleTestID],
	ROW_NUMBER() OVER (Partition By e.FullName Order by s.DateAnalysed) [Test No],
	st.SampleID,
	CASE WHEN (((IsNull(ot.EmployeeID,0) = st.EmployeeID) AND st.CreatedDate = ot.CreatedDate) OR (ot.EmployeeID = qc.EmployeeID)) THEN 1 ELSE 0 END [analysed],
	OriginalAnalyst.FullName [OriginalAnalystName],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 1 ELSE 0 END [qc],
	CASE WHEN st.SampleTestID=IsNull(qc.SampleTestID,st.SampleTestID) AND IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND (stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef) THEN 1 ELSE 0 END [datasaved], -- NO LONGER USED?
	CASE WHEN fqc.EmployeeID IS NULL THEN 0 ELSE 1 END [qcdInFuture],
	stcs.sampleTestCollectionSessionID,
	s.SampleRef [sampleref],
	NULL [totalsofar],
	sar.RowNumber [rownumber],
	--SUM(sar.RowNumber) OVER(PARTITION BY e.FullName ORDER BY s.DateAnalysed ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)  -- ONLY 2012 :/
	NULL as [OverMaxPoints],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) AND ot.CreatedDate=st.CreatedDate THEN scePoints.Points * 2 ELSE scePoints.Points END [Points],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) THEN 1 ELSE 0 END [Star],
	sce.SampleClassification [sampleClassificationDetails],
	sr.SampleResult [sampleresultDetails],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationExtendedID END [loggedSampleClassificationExtendedID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationID END [loggedSampleClassificationID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleResultID END [loggedSampleResultID],
	dbo.formatteamsdate(st.CreatedDate,1) [testCreatedOn],
	j.JobID [JobID],
	dbo.FormatTeamsReference('J',j.JobNo) [jobno],
	e.FullName,
	case when (not j.SampleResultEmployeeID IS NULL AND not j.SampleContentEmployeeID IS NULL) then 1 else 0 end [Approved],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 0 ELSE 1 END [allowcheck],
	IsNull(fqc.TestCreatedOn,'') [futuredates_string],
	st.CreatedDate [CreatedDate],
	CASE WHEN ot.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [AnalysedToday],
	CASE WHEN qc.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [qcdToday],
	ot.CreatedDate [otCreatedDate]
FROM 
	@SampleTable st
	LEFT OUTER JOIN @OriginalTest ot ON st.SampleID = ot.SampleID
	LEFT OUTER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = ot.EmployeeID
	
	LEFT OUTER JOIN @SampleAllResult sar ON st.SampleID=sar.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.SampleTestCollectionSessionID=sar.SampleTestCollectionSessionID
	
	LEFT OUTER JOIN @QCSample qc ON st.SampleID=qc.SampleID-- AND qc.EmployeeID=st.EmployeeID
	
	
	LEFT OUTER JOIN @FutureQCSample fqc ON fqc.SampleID=st.SampleID
		AND fqc.TestCreatedOn > cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
	
	INNER JOIN Employee e ON st.EmployeeID = e.EmployeeID
	INNER JOIN Sample s ON s.SampleID = st.SampleID
	
	
	--INNER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = s.EmployeeID
	INNER JOIN Room rm ON rm.RoomID = s.RoomID
	INNER JOIN Register r ON rm.RegisterID=r.RegisterID
	INNER JOIN JobEmployee je ON r.JobEmployeeID = je.JobEmployeeID
	INNER JOIN Job j ON je.JobID = j.JobID
	
	LEFT OUTER JOIN SampleClassificationExtended sce ON sce.SampleClassificationExtendedID = s.SampleClassificationExtendedID
	LEFT OUTER JOIN SampleResult sr ON sr.SampleResultID = s.SampleResultID
	
	LEFT OUTER JOIN SampleClassificationExtendedPoints scePoints  ON scePoints.SampleClassificationExtendedPointsID=s.SampleClassificationExtendedPointsID
	
Where 
	OrderIdentifier = 1
		AND
	(
		CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) THEN 
			CASE WHEN ot.EmployeeID=qc.EmployeeID THEN CASE WHEN st.EmployeeID = qc.EmployeeID THEN 1 ELSE 0 END ELSE 1 END
		ELSE 
			1
		END = 1
	)
		AND
	(st.EmployeeID = @employeeid OR @employeeid = 0)

/*
	Select 
		checked.SampleID
	FROM
		@ResultSet rs
		OUTER APPLY
		(
			Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
			FROM
			(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
				UNION
			Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
			Where
				rs.SampleID = main.SampleID AND rs.qc=0
				AND
				(
					(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
				)
			Group By EmployeeID, SampleID
		) checked
	Where rs.EmployeeID=8 AND checked.SampleID IS NOT NULL
*/	

	If @mode = 0 BEGIN
		DECLARE @Mode0Table TABLE ([_day] DATETIME,[c] INT,[qcd] INT,[qcdone] INT,[points] INT,[EmployeeID] INT,[FullName] VARCHAR(MAX),[QCCountNeededMethod1] INT, [QCCountNeededMethod1_Outstanding] INT, [QCCountNeededMethod2] INT, [QCCountNeededMethod2_Outstanding] INT, [checked_count] INT, [samplecount] INT, [ac] INT)
		Insert into @Mode0Table
		Select 
			main._day,
			SUM(main.c) [c],
			SUM(main.qcd) [qcd],
			SUM(main.qcdone) [qcdone],
			SUM(main.points) [points],
			main.EmployeeID [EmployeeID],
			main.FullName [FullName],
			--MIN(main.MaxPoints),
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod1],
			CASE WHEN  CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END > 0 THEN
				CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) ElSE 0 END - SUM(main.checked_count)
			ELSE
				0
			END [QCCountNeededMethod1_Outstanding],
			--SUM(main.QCCountNeededMethod1_Outstanding - main.checked_count) [QCCountNeededMethod1_Outstanding],
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod2],
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding - main.checked_count > 0 THEN main.QCCountNeededMethod2_Outstanding - main.checked_count ELSE 0 END) [QCCountNeededMethod2_Outstanding],
			IsNull(SUM(main.checked_count),0) [checked_count],
			IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) [samplecount],
			ISNULL(SUM(main.ac),0) [ac]
			--*/
		FROM
		(
			Select
				a.allEmployees,
				a._day,
				CASE WHEN ISNULL(inner_main.c,qconly.c) > 0 THEN ISNULL(inner_main.c,qconly.c) ELSE 0 END [c],
				CASE WHEN qconly.qcd IS NOT NULL THEN IsNull(inner_main.qcd,qconly.qcdone) ELSE qconly.qcdone END [qcd],
				ISNULL(inner_main.qcdone,0) [qcdone],
				ISNULL(inner_main.points,0) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				inner_main.MaxPoints,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				--ISNULL(CASE WHEN IsNull(inner_main.qcd,qconly.qcd) > 0 THEN checked.[count] END,0)
				inner_main.checked [checked_count],
				inner_main.samplecount [samplecount],
				inner_main.ac+qconly.ac [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					SUM(rs.Analysed) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					MIN(CASE WHEN rs.OverMaxPoints = 1 THEN rs.totalsofar ELSE 99999 END) [MaxPoints],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					SUM(CASE WHEN rs.OriginalAnalystEmployeeID <> rs.qcEmployeeID THEN 1 ELSE 0 END) [checked_count],
					CEILING(COUNT(
						CASE WHEN rs.totalsofar > @maxpoints Then
							rs.SampleID
						End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac],
					--SUM(CASE WHEN (checked.EmployeeID != rs.EmployeeID AND checked.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND checked.EmployeeID = rs.EmployeeID) Then 1 ELSE 0 END) [checked]
					COUNT(checked.SampleID) [checked]
				FROM
					(
						Select 
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[OriginalAnalystName],rs.Analysed,rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],
							CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],
							rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
					) rs
					OUTER APPLY
					(
						Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
						FROM
						(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
							UNION
						Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
						Where
							rs.SampleID = main.SampleID AND rs.qc=0
							AND
							(
								(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) --OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
									OR 
								((rs.AnalysedToday = 1 OR rs.qcdInFuture = 1) AND main.EmployeeID = rs.EmployeeID)
							)
							--AND
							--main.EmployeeID = rs.EmployeeID
						Group By EmployeeID, SampleID
					) checked
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.qc=0
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					0 [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		GROUP BY
			main.[_day],main.EmployeeID,main.FullName
		Order By
			main.EmployeeID
		
		If @forceUpdateCounts = 1 AND @employeeid = 0 BEGIN
			DECLARE @QCOutstandingCountByDayID INT = (Select top 1 QCOutstandingCountByDayID FROM QCOutstandingCountByDay Where theDay=@internalstartdate)
			IF(@QCOutstandingCountByDayID = 0) BEGIN
				Insert into QCOutstandingCountByDay (theDay,Total) Select m0t._day,SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day
			END
			IF(@QCOutstandingCountByDayID > 0) BEGIN
				DECLARE @CurrentTotal INT = (Select Total FROM QCOutstandingCountByDay Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID)
				If ((Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) != @CurrentTotal) BEGIN
					Update QCOutstandingCountByDay Set Total = (Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID
				END
			END		
		END	
		
		Select * FROM @Mode0Table m0t Where (m0t.EmployeeID = @employeeid OR @employeeid=0) Order by m0t.EmployeeID
	END
	
	If @mode = 1 BEGIN
		Select 
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],
			--rs.[sampleTestCollectionSessionID],
			--rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID,
			rs.[sampleref],
			CAST(SUM(rs2.[Points]) as varchar) + CASE WHEN rs.[Star] = 1 THEN '*' ELSE '' END [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
			CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
				RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
			ELSE
				CONVERT(varchar(11), rs.[testCreatedOn], 106)
			END [testCreatedOn]
			,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
		FROM 
			@ResultSet rs
			INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
		GROUP BY
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleTestCollectionSessionID],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
			--,rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID
		Order By
			--rs.rownumber,
			rs.FullName
			, rs.rownumber
	END

	If @mode = 2 BEGIN
			Select
				main._day,SUM(main.QCCountNeededMethod1),SUM(main.QCCountNeededMethod2)
			FROM
			(
			Select
					CAST(rs.CreatedDate as DATETIME) [_day],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber AND rs.CreatedDate=rs2.CreatedDate
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.CreatedDate,qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.CreatedDate,qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.CreatedDate=qcd.CreatedDate
				Group By
					rs.CreatedDate,rs.EmployeeID
			) main
		GROUP BY
			main._day
	END
	
	
	If @mode = 3 BEGIN
		Select 
			main._day,
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding > 0 THEN main.QCCountNeededMethod2_Outstanding ELSE 0 END) [c]
		FROM
		(
			Select
				a._day,
				CASE WHEN inner_main.c > 0 THEN inner_main.c ELSE 0 END [c],
				IsNull(inner_main.qcd,qconly.qcd) [qcd],
				ISNULL(inner_main.qcdone,qconly.qcdone) [qcdone],
				ISNULL(inner_main.points,qconly.points) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				ISNULL(inner_main.checked_count,qconly.checked_count) [checked_count],
				ISNULL(inner_main.samplecount,qconly.samplecount) [samplecount],
				ISNULL(inner_main.ac,qconly.ac) [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		Group By
			main._day
	END
	
	END

SET NOCOUNT OFF

END

GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'QualityControlSampleList_2') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[QualityControlSampleList_2] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[QualityControlSampleList_2]    Script Date: 28/03/2019 14:26:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[QualityControlSampleList_2]
    @startdate [datetime] =NULL,
    @enddate [datetime] =NULL,
    @clientid [int] =NULL,
    @ProjectId int =NULL,
    @siteid int =NULL,
    @employeeid int= 0,
    @mode int = 1,
    @forceUpdateCounts bit = 1
AS
BEGIN
set transaction ISOLATION level READ uncommitted 

SET NOCOUNT ON 
--update QCOutnstandingCountByDay for some bizare reason!
DECLARE @internalstartdate [datetime],@internalenddate [datetime]

DECLARE @maxpoints int
SET @maxpoints = (SELECT Max(i__MaxDailyPoints) FROM Config)

DECLARE @ceilingpercentage decimal(5, 3)
SET @ceilingpercentage = (SELECT Max(i__QcCeilingPercentage) FROM Config)

SET @internalstartdate = @startdate
SET @internalenddate = @enddate

IF @employeeid IS NULL
BEGIN
	set @employeeid = 0
END

IF @internalstartdate IS NULL 
BEGIN
    set @internalstartdate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 00:00:00' as datetime)
END 

IF @internalenddate IS NULL 
BEGIN
    set @internalenddate = cast(CONVERT(VARCHAR(11),GETDATE(),106) + ' 23:59:59' as datetime)
END 

if (CONVERT(VARCHAR(8),@internalenddate,108) = '00:00:00')
begin 
    set @internalenddate = cast(CONVERT(VARCHAR(11),@internalenddate,106) + ' 23:59:59' as datetime)
END 

If @mode = 3 BEGIN
	Select
		rs.theDay  [_day],
		rs.Total [c]	
	FROM
		QCOutstandingCountByDay rs
	Where 
		rs.theDay = @internalstartdate
END


If @mode < 3 BEGIN

DECLARE @SampleTable TABLE (SessionRef VARCHAR(50),SampleID INT, OrderIdentifier INT, TimeIdentifier INT,CreatedDate DATE,CreatedDateTime DATETIME, sampleTestCollectionID INT, SampleTestID INT,datasaved INT, _name VARCHAR(MAX), EmployeeID INT)
Insert into @SampleTable (SessionRef,SampleID,OrderIdentifier, TimeIdentifier,CreatedDate,CreatedDateTime,sampleTestCollectionID,SampleTestID,datasaved,_name,EmployeeID)
SELECT 
	test_st._sessionRef,
	test_st._sampleID,
	ROW_NUMBER() OVER (Partition By test_st._sampleID,test_st._EmployeeID Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [OrderIdentifier],
	ROW_NUMBER() OVER (Order By [test_st].[_testCreatedOn] DESC, [test_st].SampleTestID DESC) [TimeIdentifier],
	[test_st].[_testCreatedOn] [_testCreatedOn],
	[test_st].[_testCreatedOn] [_testCreatedOn],
    test_st.[sampleTestCollectionID],
    test_st.[sampleTestID],
    test_st._wasSaved [datasaved],
    [test_st].[_name],
    [test_st]._employeeID
FROM 
    sampletest test_st 
    INNER JOIN Sample s ON test_st._sampleID=s.SampleID
    INNER JOIN SampleTestCollection stc ON test_st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
    LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = test_st.sampleTestCollectionID
		AND
		test_st._SessionRef = stcs.sessionref
WHERE
    ((test_st.[_name] ='AnalysisTest') OR (test_st.[_name] ='AnalysisQC'))
    AND (test_st.[_testCancelledOn] IS NULL)
    AND [test_st].[_wasSaved] = 1
    AND ([test_st].[_testCreatedOn] BETWEEN @internalstartdate AND @internalenddate) 
    AND (test_st._employeeID = @employeeid OR @employeeid = 0)
Order By
	test_st._sampleID

DECLARE @SampleRowNumber TABLE (SampleID INT, RowNumber INT)
Insert into @SampleRowNumber (SampleID, RowNumber)
Select
	st.SampleID, ROW_NUMBER() OVER (PARTITION BY MAX(st.CreatedDate) ORDER BY MAX(st.CreatedDateTime), MAX(st.SampleTestID)) [rownumber]
FROM 
	@SampleTable st
GROUP BY
	st.SampleID

DECLARE @OriginalTest TABLE (SampleTestID INT,SampleID INT, EmployeeID INT, CreatedDate DATE, Analysed DATETIME)
Insert into @OriginalTest (SampleTestID,SampleID,EmployeeID,CreatedDate,Analysed)
Select main.SampleTestID,main.SampleID, main.EmployeeID, main.CreatedDate, main.Analysed
FROM
(Select
	_ori.SampleTestID,ROW_NUMBER() OVER (PARTITION BY st.SampleID ORDER BY _ori._testCreatedOn DESC) [OrderIdentifier],st.SampleID, _ori._employeeID [EmployeeID], _ori._testCreatedOn [CreatedDate], stcs.sample_dateanalysed [Analysed]
FROM
	@SampleTable st 
	LEFT OUTER JOIN SampleTest _ori ON st.SampleID=_ori._sampleID 
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
Where
	_ori._testCreatedOn <= st.CreatedDateTime
		AND
	_ori._name = 'AnalysisTest' --AND 
) main
Where
	main.OrderIdentifier=1

DECLARE @SampleAllResult TABLE (SampleID INT, _testCreatedOn DATE, RowNumber INT,sampleTestCollectionSessionID INT)
Insert into @SampleAllResult (SampleID, RowNumber,sampleTestCollectionSessionID)
Select
	srn.SampleID, srn.RowNumber [rownumber],MAX(stcs.sampleTestCollectionSessionID)
FROM
	@SampleRowNumber srn
	INNER JOIN @SampleTable st ON srn.SampleID=st.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.sampleTestCollectionID = st.sampleTestCollectionID
		AND
		st.SessionRef = stcs.sessionref
		AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
Group By
	srn.SampleID,srn.RowNumber

DECLARE @QCSample TABLE (SampleTestID INT,SampleID INT, EmployeeID INT,sampleTestCollectionSessionID INT, Analysed DATETIME)
Insert into @QCSample (SampleTestID,SampleID,EmployeeID,sampleTestCollectionSessionID,Analysed)
Select 
	main.SampleTestID, main.SampleID, main.EmployeeID, main.sampleTestCollectionSessionID, main.Analysed
FROM
(Select
	st.SampleTestID,st.SampleID, st.EmployeeID,stcs.sampleTestCollectionSessionID, stcs.sample_dateanalysed [Analysed],
	ROW_NUMBER() OVER (Partition By st.SampleID Order By st.CreatedDateTime DESC) [OrderIdentifier]
FROM
	@SampleTable st
	INNER JOIN SampleTestCollection stc ON st.sampleTestCollectionID = stc.sampleTestCollectionID AND stc.deleted IS NULL
	INNER JOIN SampleTestCollectionSession stcs ON 
		stcs.sampleTestCollectionID = st.sampleTestCollectionID
			AND
		stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
		--	AND 
		--stcs.sessionref = st.SessionRef
Where
	st._name = 'AnalysisQC'
) main
Where main.OrderIdentifier=1

DECLARE @FutureSamples TABLE (SampleID INT, EmployeeID INT, _name VARCHAR(MAX), TestCreatedOn DATETIME)
Insert into @FutureSamples
Select main._SampleID, main._EmployeeID, main._Name, main._TestCreatedOn
FROM
(
Select
	test_st._sampleID, test_st._employeeID, test_st._name, test_st._testCreatedOn
FROM
	sampletest test_st
	INNER JOIN @SampleTable st ON st.SampleID=test_st._SampleID
Where
	test_st._testCancelledOn IS NULL
) main


DECLARE @FutureQCSample TABLE (SampleID INT, EmployeeID INT, TestCreatedOn VARCHAR(MAX))
Insert into @FutureQCSample (SampleID,EmployeeID, TestCreatedOn)
Select main.SampleID, main.EmployeeID, main.TestCreatedOn
FROM
(Select
	st.SampleID, st.EmployeeID, fs.TestCreatedOn, ROW_NUMBER() OVER (Partition By st.SampleID Order By fs.TestCreatedOn DESC) [OrderIdentifier] --NEED TO MAKE THIS STUFF
FROM
	@SampleTable st
	INNER JOIN @FutureSamples fs ON st.SampleID=fs.SampleID AND fs._name='AnalysisQC'
Where
	st._name = 'AnalysisTest'
) main
Where
	main.OrderIdentifier=1

--DECLARE A TABLE VALUE SO WE CAN TALLY UP POINTS
DECLARE @ResultSet TABLE (EmployeeID INT,[otSampleTestID] INT,[OriginalAnalystEmployeeID] INT,[qcEmployeeID] INT,[stSampleTestID] INT,[qcSampleTestID] INT,[Test No] INT,[SampleID] INT,[analysed] INT,[OriginalAnalystName] VARCHAR(MAX),[qc] INT,[datasaved] BIT,[qcdInFuture] INT,[sampleTestCollectionSessionID] INT,[sampleref] VARCHAR(MAX),[totalsofar] INT,[rownumber] INT,[OverMaxPoints] INT,[Points] INT, [Star] BIT,[sampleClassificationDetails] VARCHAR(MAX),[sampleresultdetails] VARCHAR(MAX),[loggedSampleClassificationExtendedID] INT,[loggedSampleClassificationID] INT,[loggedSampleResultID] INT,[testCreatedOn] DATE,[JobID] INT,[jobno] VARCHAR(MAX),[FullName] VARCHAR(MAX),[Approved] INT,[allowcheck] INT,[futuredates_string] VARCHAR(MAX),[CreatedDate] DATE,[AnalysedToday] INT,[qcdToday] INT,[otCreatedDate] DATE)
Insert into @ResultSet (EmployeeID,[OriginalAnalystEmployeeID],[qcEmployeeID],[otSampleTestID],[stSampleTestID],[qcSampleTestID],[Test No],[SampleID],[analysed],[OriginalAnalystName],[qc],[datasaved],[qcdInFuture],[sampleTestCollectionSessionID],[sampleref],[totalsofar],[rownumber],[OverMaxPoints],[Points],[Star],[sampleClassificationDetails],[sampleresultdetails],[loggedSampleClassificationExtendedID],[loggedSampleClassificationID],[loggedSampleResultID],[testCreatedOn],[JobID],[jobno],[FullName],[Approved],[allowcheck],[futuredates_string],[CreatedDate],[AnalysedToday],[qcdToday],[otCreatedDate])
Select 
	e.EmployeeID,
	OriginalAnalyst.EmployeeID [OriginalAnalystEmployeeID],
	qc.EmployeeID [qcEmployeeID],
	ot.SampleTestID [otSampleTestID],
	st.SampleTestID [stSampleTestID],
	CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END [qcSampleTestID],
	ROW_NUMBER() OVER (Partition By e.FullName Order by s.DateAnalysed) [Test No],
	st.SampleID,
	CASE WHEN (((IsNull(ot.EmployeeID,0) = st.EmployeeID) AND st.CreatedDate = ot.CreatedDate) OR (ot.EmployeeID = qc.EmployeeID)) THEN 1 ELSE 0 END [analysed],
	OriginalAnalyst.FullName [OriginalAnalystName],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 1 ELSE 0 END [qc],
	CASE WHEN st.SampleTestID=IsNull(qc.SampleTestID,st.SampleTestID) AND IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND (stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef) THEN 1 ELSE 0 END [datasaved], -- NO LONGER USED?
	CASE WHEN fqc.EmployeeID IS NULL THEN 0 ELSE 1 END [qcdInFuture],
	stcs.sampleTestCollectionSessionID,
	s.SampleRef [sampleref],
	NULL [totalsofar],
	sar.RowNumber [rownumber],
	--SUM(sar.RowNumber) OVER(PARTITION BY e.FullName ORDER BY s.DateAnalysed ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)  -- ONLY 2012 :/
	NULL as [OverMaxPoints],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) AND ot.CreatedDate=st.CreatedDate THEN scePoints.Points * 2 ELSE scePoints.Points END [Points],
	CASE WHEN OriginalAnalyst.EmployeeID = IsNull(qc.EmployeeID,-1) THEN 1 ELSE 0 END [Star],
	sce.SampleClassification [sampleClassificationDetails],
	sr.SampleResult [sampleresultDetails],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationExtendedID END [loggedSampleClassificationExtendedID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleClassificationID END [loggedSampleClassificationID],
	CASE WHEN IsNull(qc.EmployeeID,st.EmployeeID)=st.EmployeeID AND stcs.sample_dateanalysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) AND stcs.sessionref=st.SessionRef THEN stcs.Sample_SampleResultID END [loggedSampleResultID],
	dbo.formatteamsdate(st.CreatedDate,1) [testCreatedOn],
	j.JobID [JobID],
	dbo.FormatTeamsReference('J',j.JobNo) [jobno],
	e.FullName,
	case when (not j.SampleResultEmployeeID IS NULL AND not j.SampleContentEmployeeID IS NULL) then 1 else 0 end [Approved],
	CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) AND st._name = 'AnalysisQC' THEN 0 ELSE 1 END [allowcheck],
	IsNull(fqc.TestCreatedOn,'') [futuredates_string],
	st.CreatedDate [CreatedDate],
	CASE WHEN ot.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [AnalysedToday],
	CASE WHEN qc.Analysed BETWEEN cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 00:00:00' AS datetime) AND cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime) THEN 1 ELSE 0 END [qcdToday],
	ot.CreatedDate [otCreatedDate]
FROM 
	@SampleTable st
	LEFT OUTER JOIN @OriginalTest ot ON st.SampleID = ot.SampleID
	LEFT OUTER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = ot.EmployeeID
	
	LEFT OUTER JOIN @SampleAllResult sar ON st.SampleID=sar.SampleID
	LEFT OUTER JOIN SampleTestCollectionSession stcs ON stcs.SampleTestCollectionSessionID=sar.SampleTestCollectionSessionID
	
	LEFT OUTER JOIN @QCSample qc ON st.SampleID=qc.SampleID-- AND qc.EmployeeID=st.EmployeeID
	
	
	LEFT OUTER JOIN @FutureQCSample fqc ON fqc.SampleID=st.SampleID
		AND fqc.TestCreatedOn > cast(CONVERT(varchar(11),st.CreatedDate,106) + ' 23:59:59' AS datetime)
	
	INNER JOIN Employee e ON st.EmployeeID = e.EmployeeID
	INNER JOIN Sample s ON s.SampleID = st.SampleID
	
	
	--INNER JOIN Employee OriginalAnalyst ON OriginalAnalyst.EmployeeID = s.EmployeeID
	INNER JOIN Room rm ON rm.RoomID = s.RoomID
	INNER JOIN Register r ON rm.RegisterID=r.RegisterID
	INNER JOIN JobEmployee je ON r.JobEmployeeID = je.JobEmployeeID
	INNER JOIN Job j ON je.JobID = j.JobID
	
	LEFT OUTER JOIN SampleClassificationExtended sce ON sce.SampleClassificationExtendedID = s.SampleClassificationExtendedID
	LEFT OUTER JOIN SampleResult sr ON sr.SampleResultID = s.SampleResultID
	
	LEFT OUTER JOIN SampleClassificationExtendedPoints scePoints  ON scePoints.SampleClassificationExtendedPointsID=s.SampleClassificationExtendedPointsID
	
Where 
	OrderIdentifier = 1
		AND
	(
		CASE WHEN ot.SampleTestID <> COALESCE(CASE WHEN st.EmployeeID = qc.EmployeeID THEN qc.SampleTestID END,st.SampleTestID,ot.SampleTestID) THEN 
			CASE WHEN ot.EmployeeID=qc.EmployeeID THEN CASE WHEN st.EmployeeID = qc.EmployeeID THEN 1 ELSE 0 END ELSE 1 END
		ELSE 
			1
		END = 1
	)
		AND
	(st.EmployeeID = @employeeid OR @employeeid = 0)

/*
	Select 
		checked.SampleID
	FROM
		@ResultSet rs
		OUTER APPLY
		(
			Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
			FROM
			(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
				UNION
			Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
			Where
				rs.SampleID = main.SampleID AND rs.qc=0
				AND
				(
					(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
				)
			Group By EmployeeID, SampleID
		) checked
	Where rs.EmployeeID=8 AND checked.SampleID IS NOT NULL
*/	

	If @mode = 0 BEGIN
		DECLARE @Mode0Table TABLE ([_day] DATETIME,[c] INT,[qcd] INT,[qcdone] INT,[points] INT,[EmployeeID] INT,[FullName] VARCHAR(MAX),[QCCountNeededMethod1] INT, [QCCountNeededMethod1_Outstanding] INT, [QCCountNeededMethod2] INT, [QCCountNeededMethod2_Outstanding] INT, [checked_count] INT, [samplecount] INT, [ac] INT)
		Insert into @Mode0Table
		Select 
			main._day,
			SUM(main.c) [c],
			SUM(main.qcd) [qcd],
			SUM(main.qcdone) [qcdone],
			SUM(main.points) [points],
			main.EmployeeID [EmployeeID],
			main.FullName [FullName],
			--MIN(main.MaxPoints),
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod1],
			CASE WHEN  CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) Else 0 END > 0 THEN
				CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING((SUM(main.Points) - CASE WHEN MIN(main.MaxPoints) = @maxpoints+1 THEN @maxpoints+1 ELSE @maxpoints END) * @ceilingpercentage),0) ElSE 0 END - SUM(main.checked_count)
			ELSE
				0
			END [QCCountNeededMethod1_Outstanding],
			--SUM(main.QCCountNeededMethod1_Outstanding - main.checked_count) [QCCountNeededMethod1_Outstanding],
			CASE WHEN SUM(main.Points) > @maxpoints THEN IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) Else 0 END [QCCountNeededMethod2],
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding - main.checked_count > 0 THEN main.QCCountNeededMethod2_Outstanding - main.checked_count ELSE 0 END) [QCCountNeededMethod2_Outstanding],
			IsNull(SUM(main.checked_count),0) [checked_count],
			IsNull(CEILING(SUM(main.samplecount) * @ceilingpercentage),0) [samplecount],
			ISNULL(SUM(main.ac),0) [ac]
			--*/
		FROM
		(
			Select
				a.allEmployees,
				a._day,
				CASE WHEN ISNULL(inner_main.c,qconly.c) > 0 THEN ISNULL(inner_main.c,qconly.c) ELSE 0 END [c],
				CASE WHEN qconly.qcd IS NOT NULL THEN IsNull(inner_main.qcd,qconly.qcdone) ELSE qconly.qcdone END [qcd],
				ISNULL(inner_main.qcdone,0) [qcdone],
				ISNULL(inner_main.points,0) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				inner_main.MaxPoints,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				--ISNULL(CASE WHEN IsNull(inner_main.qcd,qconly.qcd) > 0 THEN checked.[count] END,0)
				inner_main.checked [checked_count],
				inner_main.samplecount [samplecount],
				inner_main.ac+qconly.ac [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					SUM(rs.Analysed) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					MIN(CASE WHEN rs.OverMaxPoints = 1 THEN rs.totalsofar ELSE 99999 END) [MaxPoints],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					SUM(CASE WHEN rs.OriginalAnalystEmployeeID <> rs.qcEmployeeID THEN 1 ELSE 0 END) [checked_count],
					CEILING(COUNT(
						CASE WHEN rs.totalsofar > @maxpoints Then
							rs.SampleID
						End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac],
					--SUM(CASE WHEN (checked.EmployeeID != rs.EmployeeID AND checked.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND checked.EmployeeID = rs.EmployeeID) Then 1 ELSE 0 END) [checked]
					COUNT(checked.SampleID) [checked]
				FROM
					(
						Select 
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[OriginalAnalystName],rs.Analysed,rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],
							CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],
							rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.OriginalAnalystEmployeeID,rs.qcEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate, rs.[qcdToday], rs.AnalysedToday
					) rs
					OUTER APPLY
					(
						Select EmployeeID, SampleID, MAX(qcdToday) [qcdToday]
						FROM
						(Select EmployeeID,SampleID, 1 [qcdToday] FROM @QCSample
							UNION
						Select EmployeeID,SampleID, 0 [qcdToday] FROM @FutureQCSample) main
						Where
							rs.SampleID = main.SampleID AND rs.qc=0
							AND
							(
								(main.EmployeeID != rs.EmployeeID AND main.qcdToday=1) OR (rs.AnalysedToday = 1 AND rs.qcdInFuture = 1 AND main.EmployeeID = rs.EmployeeID)
							)
						Group By EmployeeID, SampleID
					) checked
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.qc=0
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					0 [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End)) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		GROUP BY
			main.[_day],main.EmployeeID,main.FullName
		Order By
			main.EmployeeID
		
		If @forceUpdateCounts = 1 AND @employeeid = 0 BEGIN
			DECLARE @QCOutstandingCountByDayID INT = (Select top 1 QCOutstandingCountByDayID FROM QCOutstandingCountByDay Where theDay=@internalstartdate)
			IF(@QCOutstandingCountByDayID = 0) BEGIN
				Insert into QCOutstandingCountByDay (theDay,Total) Select m0t._day,SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day
			END
			IF(@QCOutstandingCountByDayID > 0) BEGIN
				DECLARE @CurrentTotal INT = (Select Total FROM QCOutstandingCountByDay Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID)
				If ((Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) != @CurrentTotal) BEGIN
					Update QCOutstandingCountByDay Set Total = (Select SUM(m0t.QCCountNeededMethod2_Outstanding) FROM @Mode0Table m0t GROUP BY m0t._day) Where QCOutstandingCountByDayID=@QCOutstandingCountByDayID
				END
			END		
		END	
		
		Select * FROM @Mode0Table m0t Where (m0t.EmployeeID = @employeeid OR @employeeid=0) Order by m0t.EmployeeID
	END
	
	If @mode = 1 BEGIN
		Select 
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],
			--rs.[sampleTestCollectionSessionID],
			--rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID,
			rs.[sampleref],
			CAST(SUM(rs2.[Points]) as varchar) + CASE WHEN rs.[Star] = 1 THEN '*' ELSE '' END [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
			CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
				RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
			ELSE
				CONVERT(varchar(11), rs.[testCreatedOn], 106)
			END [testCreatedOn]
			,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
		FROM 
			@ResultSet rs
			INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
		GROUP BY
			rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleTestCollectionSessionID],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string]
			--,rs.otSampleTestID,
			--rs.stSampleTestID,
			--rs.qcSampleTestID
		Order By
			--rs.rownumber,
			rs.FullName
			, rs.rownumber
	END

	If @mode = 2 BEGIN
			Select
				main._day,SUM(main.QCCountNeededMethod1),SUM(main.QCCountNeededMethod2)
			FROM
			(
			Select
					CAST(rs.CreatedDate as DATETIME) [_day],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber AND rs.CreatedDate=rs2.CreatedDate
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.CreatedDate,qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 --OR qc.qcdInFuture = 1
						GROUP BY
							qc.CreatedDate,qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID AND rs.CreatedDate=qcd.CreatedDate
				Group By
					rs.CreatedDate,rs.EmployeeID
			) main
		GROUP BY
			main._day
	END
	
	
	If @mode = 3 BEGIN
		Select 
			main._day,
			SUM(CASE WHEN main.QCCountNeededMethod2_Outstanding > 0 THEN main.QCCountNeededMethod2_Outstanding ELSE 0 END) [c]
		FROM
		(
			Select
				a._day,
				CASE WHEN inner_main.c > 0 THEN inner_main.c ELSE 0 END [c],
				IsNull(inner_main.qcd,qconly.qcd) [qcd],
				ISNULL(inner_main.qcdone,qconly.qcdone) [qcdone],
				ISNULL(inner_main.points,qconly.points) [points],
				a.allEmployees [EmployeeID],
				e.FullName,
				ISNULL(inner_main.QCCountNeededMethod1,qconly.QCCountNeededMethod1) [QCCountNeededMethod1],
				CASE WHEN inner_main.QCCountNeededMethod1_Outstanding > 0 THEN inner_main.QCCountNeededMethod1_Outstanding ELSE 0 END [QCCountNeededMethod1_Outstanding],
				ISNULL(inner_main.QCCountNeededMethod2,qconly.QCCountNeededMethod2) [QCCountNeededMethod2],
				CASE WHEN inner_main.QCCountNeededMethod2_Outstanding > 0 THEN inner_main.QCCountNeededMethod2_Outstanding ELSE 0 END [QCCountNeededMethod2_Outstanding],
				ISNULL(inner_main.checked_count,qconly.checked_count) [checked_count],
				ISNULL(inner_main.samplecount,qconly.samplecount) [samplecount],
				ISNULL(inner_main.ac,qconly.ac) [ac]
			FROM
			(
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],EmployeeID [allEmployees] FROM @ResultSet
					UNION
				Select DISTINCT CAST(CreatedDate as DATETIME) [_day],OriginalAnalystEmployeeID [allEmployees] FROM @ResultSet
			) a
			INNER JOIN Employee e ON e.EmployeeID = a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					ISNULL(qcd.qcd,0) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.EmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],SUM(rs2.[Points]) [totalsofar],rs.[rownumber],CASE WHEN SUM(rs2.[Points])  > @maxpoints THEN 1 ELSE 0 END [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
							INNER JOIN @ResultSet rs2 ON rs.EmployeeID=rs2.EmployeeID AND rs.rownumber >= rs2.rownumber
						GROUP BY
							rs.EmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[FullName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.OriginalAnalystEmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.OriginalAnalystEmployeeID
					) qcd ON rs.EmployeeID=qcd.OriginalAnalystEmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.EmployeeID,qcd.qcd,qcd.self_qcd
			) inner_main ON inner_main.EmployeeID=a.allEmployees
			LEFT OUTER JOIN 
			(
				Select
					ISNULL(COUNT(rs.SampleID) - SUM(rs.[qc]),0) [c],
					COUNT(rs.SampleID) [qcd],
					SUM(rs.[qc]) [qcdone],
					SUM(rs.Points) [points],
					rs.OriginalAnalystEmployeeID [EmployeeID],
					rs.FullName [FullName],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage)
					ELSE
						0
					END [QCCountNeededMethod1],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN
						IsNull(CEILING((SUM(rs.Points) - @maxpoints) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0),0)
					Else
						0
					END [QCCountNeededMethod1_Outstanding],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) ELSE 0 END [QCCountNeededMethod2],
					CASE WHEN SUM(rs.Points) > @maxpoints THEN CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then rs.SampleID End) * @ceilingpercentage) - ISNULL(qcd.self_qcd,0) ELSE 0 END [QCCountNeededMethod2_Outstanding],
					ISNULL(qcd.self_qcd,0) [checked_count],
					CEILING(COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) * @ceilingpercentage) [samplecount],
					COUNT(CASE WHEN rs.totalsofar > @maxpoints Then
						rs.SampleID
					End) [ac]
				FROM
					(
						Select 
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName] [FullName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[Points] [Points],0 [totalsofar],rs.[rownumber],0 [OverMaxPoints],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],
							CASE WHEN DAY(rs.[testCreatedOn]) < 10 THEN
								RIGHT(CONVERT(varchar(11), rs.[testCreatedOn], 106),LEN(CONVERT(varchar(11), rs.[testCreatedOn], 106))-1)
							ELSE
								CONVERT(varchar(11), rs.[testCreatedOn], 106)
							END [testCreatedOn]
							,rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string], rs.CreatedDate
						FROM 
							@ResultSet rs
						GROUP BY
							rs.OriginalAnalystEmployeeID,rs.[Test No],rs.[SampleID],rs.[analysed],rs.[OriginalAnalystName],rs.[qc],rs.[datasaved],rs.[qcdInFuture],rs.[sampleref],rs.[totalsofar],rs.[rownumber],rs.[OverMaxPoints],rs.[Points],rs.[Star],rs.[sampleClassificationDetails],rs.[sampleresultdetails],rs.[loggedSampleClassificationExtendedID],rs.[loggedSampleClassificationID],rs.[loggedSampleResultID],rs.[testCreatedOn],rs.[JobID],rs.[jobno],rs.[OriginalAnalystName],rs.[Approved],rs.[allowcheck],rs.[futuredates_string],rs.CreatedDate
					) rs
					LEFT OUTER JOIN 
					(
						Select 
							qc.EmployeeID, COUNT(qc.SampleID) [qcd], SUM(CASE WHEN qc.OriginalAnalystEmployeeID = qc.EmployeeID THEN 1 ELSE 0 END) [self_qcd]
						FROM
							@ResultSet qc
						Where
							qc.qc = 1 OR qc.qcdInFuture = 1
						GROUP BY
							qc.EmployeeID
					) qcd ON rs.OriginalAnalystEmployeeID=qcd.EmployeeID
				Group By
					rs.CreatedDate,rs.FullName,rs.OriginalAnalystEmployeeID,qcd.qcd,qcd.self_qcd
			) qconly  ON qconly.EmployeeID=a.allEmployees
		) main
		Group By
			main._day
	END
	
	END

SET NOCOUNT OFF

END

GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_Projects') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_Projects] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_Projects]    Script Date: 02/04/2019 15:05:02 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO












ALTER PROCEDURE [dbo].[Paged_Projects]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
	@ProjectGroupID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of project name, client name, address, postcode etc.)
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@HideCompleted INT = 1,
	@HideSubProjects INT = 0,
	@ProjectManagerID INT = 0,
	@ProjectType INT = 0, -- 0=ALL, 1=Legionella, 2=Surveying

	-- Parameters for ordering, we might need to discuss these.
	-- Because the data is hireachical it should order the project groups by the relevant column and then the sub projects
	-- I believe the values are: 0=NOT SET, 1=ASC, 2=DESC
    @OrderByProjectName INT = 0,
	@OrderBySubProjectName INT = 0,
    @OrderByClient INT = 0,
    @OrderByTotalSites INT = 0,
    --@OrderBySitesRequired INT = 0,
    --@OrderBySitesBooked INT = 0,
    --@OrderByJobsCompleted INT = 0,
    --@OrderByOutstandingJobs INT = 0,
	--@OrderByCompletionDate INT = 0,
	@OrderByStart INT = 0,
	@OrderByEnd INT = 0,
	@OrderByProjectManager INT = 0,
	@OrderByIsActive INT = 0
    
/*************************************************************************************************
** Overview: Get the data for the combine Projects tab.  Replaces TEAMS_Management_GetProjects SP.
**************************************************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Set default variable values if not passed in.
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByProjectName = 0 AND @OrderByClient = 0 AND @OrderByTotalSites = 0 AND @OrderByStart = 0 AND @OrderByEnd = 0 AND 
		@OrderByProjectManager = 0 AND @OrderByIsActive = 0
    BEGIN
        SET @OrderByProjectName = 1
		SET @OrderBySubProjectName = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get just the minimum ammount of data for speed, filtering etc.
    DECLARE @ProjectData TABLE (IndexID INT IDENTITY(1,1), ProjectGroupId INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT) -- TODO: Add the rest of the required columns
    
    INSERT INTO @ProjectData (ProjectGroupId, ProjectID, AppointmentStart, AppointmentEnd, SiteCount)
    SELECT
		pg.ProjectGroupId, pg.ProjectID, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount
    FROM
        (
            SELECT
				pg.ProjectGroupId,
				pg.ProjectGroup,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END [SubProject],
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END [ProjectID],
				c.Client,
				NULL [AppointmentStart],--MIN(a.StartTime)
				NULL [AppointmentEnd],--MAX(a.EndTime) 
				COUNT(DISTINCT si.SiteID) [SiteCount],
				e.FullName [ProjectManager]
            FROM
				ProjectGroup pg WITH (NOLOCK)
				INNER JOIN Project p WITH (NOLOCK) ON pg.ProjectGroupId=p.ProjectGroupId
				LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
                INNER JOIN Client c WITH (NOLOCK) ON pg.ClientId = c.ClientID
				LEFT OUTER JOIN ProjectSite ps  WITH (NOLOCK) ON ps.ProjectID=p.ProjectID
				LEFT OUTER JOIN Site si  WITH (NOLOCK) ON si.SiteID=ps.SiteID
				--LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
            WHERE
				pg.DateDeleted IS NULL
					AND
				p.Deleted IS NULL
					AND
				--a.AppointmentTypeID IN (1,3,9) 
					--AND 
				--a.DateDeclined IS NULL
					--AND
                (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @ProjectGroupID = 0 THEN 1 ELSE CASE WHEN pg.ProjectGroupID=@ProjectGroupID THEN 1 ELSE 0 END END = 1)
                    AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
				    AND
				(CASE WHEN @HideCompleted = 0 THEN 1 ELSE CASE WHEN pg.DateCompleted IS NULL THEN 1 ELSE 0 END END = 1)
					AND 
				(CASE WHEN @ProjectManagerID = 0 THEN 1 ELSE CASE WHEN pg.EmployeeId = @ProjectManagerID THEN 1 ELSE 0 END END = 1)
					AND
				(
					CASE WHEN @ProjectType = 0 THEN 1 ELSE
					CASE WHEN 
						(
							(@ProjectType = 1 AND p.LegionellaTypeID IS NOT NULL)
								OR
							(@ProjectType = 2 AND p.LegionellaTypeID IS NULL)
						) THEN 1 ELSE 0 END
					END = 1
				)
				    AND
				(
				  CASE WHEN LEN(@Filter) = 0 THEN 1 ELSE 
					CASE WHEN
					  (
							si.Address Like '%' + @Filter + '%'
								Or 
							si.Postcode Like '%' + @Filter + '%'
								Or 
							si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
								Or 
							si.UPRN = @Filter
					  ) THEN 1 ELSE 0 END
				 END = 1
				)
					AND
				(c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL))
            GROUP BY
                pg.ProjectGroupId,
				pg.ProjectGroup,
				e.FullName,
				c.Client,
				CASE WHEN @HideSubProjects = 0 THEN p.GroupName ELSE NULL END,
				CASE WHEN @HideSubProjects = 0 THEN p.ProjectID ELSE NULL END
        ) pg
    GROUP BY
        pg.ProjectGroupId, pg.ProjectGroup, pg.SubProject, pg.ProjectID, pg.Client, pg.AppointmentStart, pg.AppointmentEnd, pg.SiteCount, pg.ProjectManager
    ORDER BY
        CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroup ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroup ELSE NULL END DESC,
		CASE WHEN @OrderByProjectName = 1 THEN pg.ProjectGroupID ELSE NULL END ASC, CASE WHEN @OrderByProjectName = 2 THEN pg.ProjectGroupID ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.SubProject ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.SubProject ELSE NULL END DESC,
		CASE WHEN @OrderBySubProjectName = 1 THEN pg.ProjectID ELSE NULL END ASC, CASE WHEN @OrderBySubProjectName = 2 THEN pg.ProjectID ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN pg.Client ELSE NULL END ASC, CASE WHEN @OrderByClient = 2 THEN pg.Client ELSE NULL END DESC,
		CASE WHEN @OrderByTotalSites = 1 THEN pg.[SiteCount] ELSE NULL END ASC, CASE WHEN @OrderByTotalSites = 2 THEN pg.[SiteCount] ELSE NULL END DESC,
		--CASE WHEN @OrderByStart = 1 THEN pg.AppointmentStart ELSE NULL END ASC, CASE WHEN @OrderByStart = 2 THEN pg.AppointmentStart ELSE NULL END DESC,
		--CASE WHEN @OrderByEnd = 1 THEN pg.AppointmentEnd ELSE NULL END ASC, CASE WHEN @OrderByEnd = 2 THEN pg.AppointmentEnd ELSE NULL END DESC,
		CASE WHEN @OrderByProjectManager = 1 THEN pg.ProjectManager ELSE NULL END ASC, CASE WHEN @OrderByProjectManager = 2 THEN pg.ProjectManager ELSE NULL END DESC--,
		--CASE WHEN @OrderByIsActive = 1 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END ASC, CASE WHEN @OrderByIsActive = 2 THEN CASE WHEN MIN(pg.AppointmentStart) < GETDATE() AND MAX(pg.AppointmentEnd) > GETDATE() THEN 1 ELSE 0 END ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @ProjectData)
    
	DECLARE @PagedList TABLE (Row_Num INT, Row_total INT, [Page] INT, [Pages] INT, ProjectGroupID INT, ProjectID INT, AppointmentStart DATETIME, AppointmentEnd DATETIME, SiteCount INT)
	DECLARE @MainData TABLE (IndexID INT IDENTITY(1,1), Row_Num INT, Row_Total INT, [Page] INT, [Pages] INT, ClientID INT, Client VARCHAR(MAX), ProjectID INT, SubProjectName VARCHAR(MAX), SiteCount INT, SitesRequiredCount VARCHAR(MAX), SitesBookedCount INT, SitesCompletedCount INT, OutstandingJobsCount VARCHAR(MAX), DueDate VARCHAR(MAX), ProjectGroupID INT, ProjectGroup VARCHAR(MAX), PGSiteCount INT, PGSitesRequiredCount VARCHAR(MAX), PGSitesBookedCount INT, PGSitesCompletedCount INT, PGOutstandingJobsCount VARCHAR(MAX), Starts DATETIME, Ends DATETIME, ProjectManager VARCHAR(MAX), IsActive BIT, LegionellaTypeID INT, IsLegionella INT)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @ProjectData
           ) a
    )   
    
    INSERT INTO @PagedList (Row_Num,Row_total,Page,Pages,ProjectGroupID,ProjectID,AppointmentStart,AppointmentEnd,SiteCount)
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
		pag.ProjectGroupId,
		pag.ProjectID,
		pag.AppointmentStart,
		pag.AppointmentEnd,
		pag.SiteCount
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN ProjectGroup pg WITH (NOLOCK) ON pag.ProjectGroupId = pg.ProjectGroupId
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

	If @HideSubProjects = 0 BEGIN
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount,SitesBookedCount, SitesCompletedCount, OutstandingJobsCount, DueDate, ProjectGroupID, ProjectGroup, PGSiteCount, PGSitesRequiredCount, PGSitesBookedCount, PGSitesCompletedCount, PGOutstandingJobsCount, Starts, Ends, ProjectManager, IsActive, LegionellaTypeID, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,

			-- Project Data
			p.ProjectID,
			p.GroupName [SubProjectName],
			pl.SiteCount,
			CAST(ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND ISNULL(p.PrjGrpMaximumNumberOfSites, pl.SiteCount) > 0 THEN CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(pl.SiteCount AS FLOAT)) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			NULL [SitesBookedCount],
			NULL [SitesCompletedCount],
			NULL [OutstandingJobsCount],
			CONVERT(VARCHAR, p.DueDate, 104) [DueDate],

			-- Project Group Data
			pg.ProjectGroupID,
			pg.ProjectGroup,
			NULL [PGSiteCount],
			NULL [PGSitesRequiredCount],
			NULL [PGSitesBookedCount],
			NULL [PGSitesCompletedCount],
			NULL [PGOutstandingJobsCount],
			NULL [Starts],
			NULL [Ends],
			e.FullName [ProjectManager],
			NULL [IsActive],
			ISNULL(p.LegionellaTypeID, 0) [LegionellaTypeID],
			CASE WHEN ISNULL(p.LegionellaTypeID, 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN Project p ON p.ProjectID=pl.ProjectID
			INNER JOIN Client c ON c.ClientID=p.ClientID
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=p.ProjectGroupId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		ORDER BY
			ProjectGroup, p.GroupName
			
		INSERT INTO @MainData (Row_Num,Row_Total,Page,Pages,ClientID, Client, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsActive, IsLegionella)
		SELECT 
			MIN(md.Row_Num),
			MIN(md.Row_Total),
			MIN(md.Page),
			MIN(md.Pages),
			md.ClientID, Client, ProjectGroupID, ProjectGroup, MIN(a.StartTime) [Starts], MAX(a.EndTime) [Ends], ProjectManager, CASE WHEN MIN(a.StartTime) < GETDATE() AND  MAX(a.EndTime) > GETDATE() THEN 1 ELSE 0 END [IsActive], 
			MAX(md.IsLegionella) [IsLegionella]
		FROM 
			@MainData md
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=md.ProjectID
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			md.ClientID, Client, ProjectGroupID, ProjectGroup, ProjectManager
	-- Main select
	END
	ELSE BEGIN
		-- Insert the header rows
		INSERT INTO @MainData (Row_Num, Row_Total, [Page], [Pages], ClientID, Client, ProjectID, SubProjectName, SiteCount, SitesRequiredCount, ProjectGroupID, ProjectGroup, Starts, Ends, ProjectManager, IsLegionella)
		SELECT
			pl.Row_Num,
			@TotalRowNumber [Row_Total],
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			0,
			pg.ProjectGroup [SubProjectName],
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')' [SitesRequiredCount],
			pg.ProjectGroupID,
			pg.ProjectGroup,
			MIN(a.StartTime) [Starts], 
			MAX(a.EndTime) [Ends],
			e.FullName [ProjectManager],
			CASE WHEN ISNULL(MAX(p.LegionellaTypeID), 0) > 0 THEN 1 ELSE 0 END [IsLegionella]
		FROM
			@PagedList pl
			INNER JOIN ProjectGroup pg ON pg.ProjectGroupID=pl.ProjectGroupId
			LEFT OUTER JOIN Project p ON pg.ProjectGroupID=p.ProjectGroupID
			LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.ProjectID=p.ProjectID
			INNER JOIN Client c ON c.ClientID=pg.ClientId
			LEFT OUTER JOIN Employee e WITH (NOLOCK) ON e.EmployeeID=pg.EmployeeId
		--WHERE
			--a.DateDeclined IS NULL
		GROUP BY
			pl.Row_Num,
			pl.Page,
			pl.Pages,
			c.ClientID,
			c.Client,
			pg.ProjectGroup,
			pl.SiteCount,
			CAST(pl.SiteCount AS VARCHAR(MAX)) + ' (' + CASE WHEN pl.SiteCount > 0 AND pl.SiteCount > 0 THEN CAST(LEFT(((CAST(pl.SiteCount AS FLOAT) / CAST(pl.SiteCount AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' ELSE 'N/A' END + ')',
			pg.ProjectGroupID,
			pg.ProjectGroup,
			e.FullName
		ORDER BY
			ProjectGroup
	END

	-- Main select	
	SELECT
		*
	FROM
	(
		SELECT
			ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID ASC) [Identifier],
			md.Row_Num,
			md.Row_Total [Row_Total],
			md.Page,
			md.Pages,
			md.ClientID,
			md.Client,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN 1
				ELSE 0
			END [IsProjectGroup],
			md.ProjectGroupID [ProjectGroupID],
			ISNULL(md.ProjectID, 0) [ProjectID],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectGroup
				ELSE md.SubProjectName
			END [Name],

			--ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END [Sites],
			--SiteCount.SiteCount [Sites],
			CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END [Sites],

			--CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) as varchar)
			--+ ' (' + 
			--		CASE WHEN ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END) > 0 THEN 
			--			CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) / CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
			--		ELSE 'N/A' END + ')' [SitesRequired],
			CAST(ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) as varchar)
			+ ' (' + 
					CASE WHEN CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END > 0 AND ISNULL(NULLIF(p.PrjGrpMaximumNumberOfSites, 0), CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END) > 0 THEN 
						CAST(LEFT(((ISNULL(CAST(p.PrjGrpMaximumNumberOfSites AS FLOAT), CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) / CAST(CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN ProjectGroupSiteCount.SiteCount ELSE ProjectSiteCount.SiteCount END AS FLOAT)) * 100), 3) AS VARCHAR(MAX)) + '%' 
					ELSE 'N/A' END + ')' [SitesRequired],

			SiteStatus.BookedCount [SitesBooked],
			SiteStatus.CompletedCount [SitesCompleted],
			[OutstandingJobs] =		CASE 
										WHEN SiteStatus.BookedCount - SiteStatus.CompletedCount < 0 THEN '0'
										ELSE CONVERT(VARCHAR(MAX), SiteStatus.BookedCount - SiteStatus.CompletedCount)
									END + ' of ' + CONVERT(VARCHAR(MAX), SiteStatus.BookedCount),
			--[OutstandingJobs] =	CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END - SiteStatus.CompletedCount as varchar) + ' of ' + CAST(ROW_NUMBER() OVER (Partition BY md.ProjectGroupID,md.ProjectID Order by ps.ProjectSiteID DESC) - CASE WHEN ps.ProjectSiteID IS NULL THEN 1 ELSE 0 END as varchar),

			md.DueDate,
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Starts
				ELSE null
			END [Starts],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.Ends
				ELSE null
			END [Ends],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.ProjectManager
				ELSE null
			END [ProjectManager],
			CASE
				WHEN NULLIF(md.ProjectID,0) IS NULL
				THEN md.IsActive
				ELSE null
			END [IsActive],
			CASE
				WHEN md.ProjectID IS NOT NULL
				THEN ISNULL(md.LegionellaTypeID, 0)
				ELSE 0
			END [LegionellaTypeID],
			CAST(IsLegionella as BIT) [IsLegionella]
		FROM
			@MainData md
			INNER JOIN Project p ON md.ProjectGroupID=p.ProjectGroupId AND CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
			LEFT OUTER JOIN ProjectSite ps ON p.ProjectID=ps.ProjectID 
			OUTER APPLY
			(
				SELECT
					COUNT(DISTINCT a.SiteID) [BookedCount],
					COUNT(DISTINCT j.JobID) [CompletedCount]
				FROM
					Appointment a
					INNER JOIN Project p ON a.ProjectID=p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
					LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Approved IS NOT NULL
					INNER JOIN Site s ON a.SiteID = s.SiteID
				WHERE
					p.Deleted IS NULL
						AND
					md.ProjectGroupID=p.ProjectGroupId 
						AND 
					CASE WHEN NULLIF(md.ProjectID,0) IS NULL THEN 1 ELSE CASE WHEN p.ProjectID=md.ProjectID THEN 1 ELSE 0 END END = 1
						AND
					a.DateDeclined IS NULL
						AND
					s.Deleted IS NULL
			) SiteStatus
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
					INNER JOIN Project p2 ON ps.ProjectID = p2.ProjectID
				WHERE
					p2.ProjectGroupId = p.ProjectGroupId
						--AND
					--s.Deleted IS NULL
			) ProjectGroupSiteCount
			OUTER APPLY
			(
				SELECT
					COUNT(*) [SiteCount]
				FROM
					Site s
					INNER JOIN ProjectSite ps ON s.SiteID = ps.SiteID
				WHERE
					ps.ProjectID = p.ProjectID
						--AND
					--s.Deleted IS NULL
			) ProjectSiteCount
			
		WHERE
			(CASE
				WHEN @HideSubProjects = 1
				THEN
					CASE
						WHEN NULLIF(md.ProjectID,0) IS NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END) = 1
	) main
	WHERE
		main.Identifier = 1
	ORDER BY
		main.Row_Num,
		main.ProjectID
	
    SET NOCOUNT OFF;
END


GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='s__EmailBodyFont') < 1
BEGIN
  ALTER TABLE Config
      ADD s__EmailBodyFont VARCHAR(50) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ExportType') AND name='ExportTypeInformationID') < 1
BEGIN
	ALTER TABLE [dbo].[ExportType]
	ADD [ExportTypeInformationID] [int] NULL;
END
GO

USE [TEAMS]
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='util_InvalidDate'))
	BEGIN
		CREATE TABLE [dbo].[util_InvalidDate] (
		[util_InvalidDateID] [int] IDENTITY (1, 1) NOT NULL,
		[Table] [varchar] (MAX) NOT NULL,
		[Field] [varchar] (MAX) NOT NULL,
		[ID] [int] NULL,
		[DateCreated] [datetime] NOT NULL DEFAULT(GETDATE()),
		[DateFixed] [datetime] NULL
		CONSTRAINT [PK_util_InvalidDate]
		PRIMARY KEY CLUSTERED
		(
			[util_InvalidDateID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 


GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'util_InvalidDateFind') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[util_InvalidDateFind] AS BEGIN SET NOCOUNT ON; END')
END

GO

/****** Object:  StoredProcedure [dbo].[util_InvalidDateFind]    Script Date: 05/07/2019 12:25:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER PROC [dbo].[util_InvalidDateFind]

As
Begin
	SET NOCOUNT ON;
	DECLARE @sql nvarchar (max), @Table nvarchar(max), @1900Date nvarchar(max) = '1900-01-01 00:00:00.000', @DateCol nvarchar(max), @TableIdentity nvarchar(max)

	DECLARE DateFields CURSOR FOR
	SELECT
		  t.name,
		  c.name,
		  pri.name
	FROM
		  sys.tables t 
		  INNER JOIN sys.columns c ON t.object_id=c.object_id
		  LEFT OUTER JOIN sys.columns pri ON t.object_id=pri.object_id AND pri.is_identity = 1
	WHERE
		  c.system_type_id IN (40,42,58,61)

	OPEN DateFields
	FETCH NEXT FROM DateFields INTO @Table, @DateCol, @TableIdentity

	WHILE @@FETCH_STATUS= 0 BEGIN
		SET @sql ='SELECT ''' + @Table + ''', ''' + @DateCol + ''', ' + CASE WHEN @TableIdentity IS NULL THEN 'NULL' ELSE 't.' + CAST(@TableIdentity as varchar(MAX)) END + ' FROM ' + @Table + ' t LEFT OUTER JOIN util_InvalidDate uid ON uid.ID=' + CASE WHEN @TableIdentity IS NULL THEN 'NULL' ELSE 't.' + CAST(@TableIdentity as varchar(MAX)) END + ' AND uid.[Table]=''' + @Table + ''' AND uid.[Field]=''' + @DateCol + ''' WHERE t.' + @DateCol + ' = ''' + @1900Date + ''' AND uid.util_InvalidDateID IS NULL'
	
		INSERT INTO util_InvalidDate ([Table],[Field],[ID])
		EXEC sp_executesql @sql 

		FETCH NEXT FROM DateFields INTO @Table, @DateCol, @TableIdentity
	
	END

	CLOSE DateFields
	DEALLOCATE DateFields
	
/*##################### REGISTER START FIX #####################*/
		
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Register' AND Field='RegisterStart') > 0 BEGIN
		UPDATE Register
				SET RegisterStart=u.FixedDate
		FROM
			Register
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Register.RegisterID=uid.ID AND uid.[Table]='Register' AND uid.Field='RegisterStart'
			OUTER APPLY
			(
				SELECT 
					CASE WHEN fp.FloorplanID IS NULL THEN
						ISNULL(iat.DateCreated,j.Created)
					ELSE
						ISNULL(je.ActualStart,je.ScheduledStart)
					END [FixedDate]
				FROM 
					  Job j
					  INNER JOIN JobEmployee je ON je.JobID = j.JobID
					  INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
					  LEFT OUTER JOIN IntranetAuditTrail iat ON iat.DataTable='Job' AND iat.DataID=j.JobID AND iat.Message='Created job number'
					  LEFT JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
				WHERE 
					  r.RegisterID=Register.RegisterID
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Register
				INNER JOIN util_InvalidDate uid ON Register.RegisterID=uid.ID AND uid.[Table]='Register' AND uid.Field='RegisterStart'
			WHERE
				Register.RegisterStart!='1900/01/01 00:00:00'
				
		END
		
/*##################### REGISTER START FIX END #####################*/
		
/*##################### REGISTER FINISH FIX #####################*/
		
		IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Register' AND Field='RegisterFinish') > 0 BEGIN
			UPDATE Register
				SET RegisterFinish=u.FixedDate
			FROM
				Register
				INNER JOIN 
				(
					SELECT
						uid.[Table],uid.Field,uid.ID
					FROM
						util_InvalidDate uid
					WHERE
						uid.DateFixed IS NULL
				) uid ON Register.RegisterID=uid.ID AND uid.[Table]='Register' AND uid.Field='RegisterFinish'
				OUTER APPLY
				(
					SELECT 
						CASE WHEN fp.FloorplanID IS NULL THEN
							ISNULL(iat.DateCreated,j.Created)
						ELSE
							ISNULL(je.ActualFinish,je.ScheduledFinish)
						END [FixedDate]
					FROM 
						  Job j
						  INNER JOIN JobEmployee je ON je.JobID = j.JobID
						  INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
						  LEFT OUTER JOIN IntranetAuditTrail iat ON iat.DataTable='Job' AND iat.DataID=j.JobID AND iat.Message='Created job number'
						  LEFT JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
					WHERE 
						  r.RegisterID=Register.RegisterID
				) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Register
				INNER JOIN util_InvalidDate uid ON Register.RegisterID=uid.ID AND uid.[Table]='Register' AND uid.Field='RegisterFinish'
			WHERE
				Register.RegisterFinish!='1900/01/01 00:00:00'
				
		END	
		
/*##################### REGISTER FINISH FIX END #####################*/

/*##################### JOB CREATED FIX START #####################*/
IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Job' AND Field='Created') > 0 BEGIN
		UPDATE Job
				SET Created=u.FixedDate
		FROM
			Job
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Job.JobID=uid.ID AND uid.[Table]='Job' AND uid.Field='Created'
			OUTER APPLY
			(
				SELECT 
					iat.datecreated [FixedDate]
				FROM 
					  Job j
					  LEFT OUTER JOIN IntranetAuditTrail iat ON iat.DataTable='Job' AND iat.DataID=j.JobID AND iat.Message='Created job number'
				WHERE 
					  j.JobID=Job.JobID
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Job
				INNER JOIN util_InvalidDate uid ON Job.JOBID=uid.ID AND uid.[Table]='Job' AND uid.Field='Created'
			WHERE
				Job.Created!='1900/01/01 00:00:00'
	END
/*##################### JOB CREATED FIX END #####################*/

/*##################### JobEmployeeAppointment ENDTIME FIX START #####################*/
IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='JobEmployeeAppointment' AND Field='EndTime') > 0 BEGIN
		UPDATE JobEmployeeAppointment
				SET EndTime=u.FixedDate
		FROM
			JobEmployeeAppointment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON JobEmployeeAppointment.JobEmployeeAppointmentID=uid.ID AND uid.[Table]='JobEmployeeAppointment' AND uid.Field='EndTime'
			OUTER APPLY
			(
				SELECT 
					ISNULL(je.ActualFinish,je.ScheduledFinish) [FixedDate]
				FROM 
					  JobEmployeeAppointment jea
					  INNER JOIN Jobemployee je on je.jobemployeeid = jea.jobemployeeid
				WHERE 
					  jea.JobEmployeeAppointmentID=JobEmployeeAppointment.JobEmployeeAppointmentID
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				JobEmployeeAppointment
				INNER JOIN util_InvalidDate uid ON JobEmployeeAppointment.JobEmployeeAppointmentID=uid.ID AND uid.[Table]='JobEmployeeAppointment' AND uid.Field='EndTime'
			WHERE
				JobEmployeeAppointment.EndTime !='1900/01/01 00:00:00'
	END
/*##################### JobEmployeeAppointment ENDTIME FIX END #####################*/

/*##################### APPOINTMENT StartTime FIX START FOR DECLINED APPOINTMENTS #####################*/
IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Appointment' AND Field='StartTime') > 0 BEGIN
		UPDATE Appointment
				SET StartTime='1900/01/01 00:01:00'
		FROM
			Appointment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='StartTime'
			WHERE
				appointment.DateDeclined IS NOT NULL 
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Appointment
				INNER JOIN util_InvalidDate uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='StartTime'
			WHERE
				Appointment.StartTime !='1900/01/01 00:00:00'
	END
/*##################### APPOINTMENT StartTime FIX START FOR DECLINED APPOINTMENTS END #####################*/
	
/*##################### APPOINTMENT EndTime FIX START FOR DECLINED APPOINTMENTS START #####################*/
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Appointment' AND Field='EndTime') > 0 BEGIN
		UPDATE Appointment
				SET EndTime='1900/01/01 00:01:00'
		FROM
			Appointment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='EndTime'
		WHERE
			appointment.DateDeclined IS NOT NULL 

						
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Appointment
				INNER JOIN util_InvalidDate uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='EndTime'
			WHERE
				Appointment.EndTime !='1900/01/01 00:00:00'
	END
/*##################### APPOINTMENT EndTime FIX START FOR DECLINED APPOINTMENTS END #####################*/

/*##################### APPOINTMENT StartTime FIX START FOR NON-DECLINED APPOINTMENTS END #####################*/	
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Appointment' AND Field='StartTime') > 0 BEGIN
		UPDATE Appointment
				SET StartTime=u.FixedDate
		FROM
			Appointment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='StartTime'
			OUTER APPLY
			(
				SELECT 
					cast(CONVERT(VARCHAR(11),app.EndTime,106) + ' 00:00:00' as datetime) [FixedDate]
				FROM 
					  Appointment app 
				WHERE 
					app.AppointmentID=Appointment.AppointmentID
						and 
					app.EndTime != '1900/01/01 00:00:00'
						and
					app.DateDeclined IS NULL
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Appointment
				INNER JOIN util_InvalidDate uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='StartTime'
			WHERE
				Appointment.StartTime!='1900/01/01 00:00:00'
	END
/*##################### APPOINTMENT StartTime FIX START FOR NON-DECLINED APPOINTMENTS END #####################*/	

/*##################### APPOINTMENT EndTime FIX END FOR NON-DECLINED APPOINTMENTS START #####################*/		
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Appointment' AND Field='EndTime') > 0 BEGIN
		UPDATE Appointment
				SET EndTime=u.FixedDate
		FROM
			Appointment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='EndTime'
			OUTER APPLY
			(
				SELECT 
					cast(CONVERT(VARCHAR(11),app.StartTime,106) + ' 23:59:59' as datetime) [FixedDate]
				FROM 
					  Appointment app 
				WHERE 
					app.AppointmentID=Appointment.AppointmentID
					  		and 
					app.StartTime != '1900/01/01 00:00:00'
						and
					app.DateDeclined IS NULL
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Appointment
				INNER JOIN util_InvalidDate uid ON Appointment.AppointmentID=uid.ID AND uid.[Table]='Appointment' AND uid.Field='EndTime'
			WHERE
				Appointment.StartTime!='1900/01/01 00:00:00'
	END
/*##################### APPOINTMENT EndTime FIX END FOR NON-DECLINED APPOINTMENTS END #####################*/		
	
/*##################### JOBEMPLOYEE ACTUALSTART FIX #####################*/
		
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='JobEmployee' AND Field='ActualStart') > 0 BEGIN
		UPDATE JobEmployee
				SET ActualStart=ISNULL(JobEmployee.ScheduledStart,GETDATE())
		FROM
			JobEmployee
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON JobEmployee.JobEmployeeID=uid.ID AND uid.[Table]='JobEmployee' AND uid.Field='ActualStart'
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				JobEmployee
				INNER JOIN util_InvalidDate uid ON JobEmployee.JobEmployeeID=uid.ID AND uid.[Table]='JobEmployee' AND uid.Field='ActualStart'
			WHERE
				JobEmployee.ActualStart!='1900/01/01 00:00:00'
	END
		
/*##################### JOBEMPLOYEE ACTUALSTART FIX END #####################*/
		
/*##################### JOBEMPLOYEE ACTUALFINISH FIX #####################*/
		
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='JobEmployee' AND Field='ActualFinish') > 0 BEGIN
		UPDATE JobEmployee
				SET ActualFinish=ISNULL(JobEmployee.ScheduledFinish,GETDATE())
		FROM
			JobEmployee
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON JobEmployee.JobEmployeeID=uid.ID AND uid.[Table]='JobEmployee' AND uid.Field='ActualFinish'
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				JobEmployee
				INNER JOIN util_InvalidDate uid ON JobEmployee.JobEmployeeID=uid.ID AND uid.[Table]='JobEmployee' AND uid.Field='ActualFinish'
			WHERE
				JobEmployee.ActualFinish!='1900/01/01 00:00:00'
	END	
		
/*##################### JOBEMPLOYEE ACTUALFINISH FIX END #####################*/

/*##################### EQUIPMENT DatePurchased FIX START #####################*/
		
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Equipment' AND Field='DatePurchased') > 0 BEGIN
		UPDATE Equipment
				SET DatePurchased='1900/01/01 00:00:01'
		FROM
			Equipment
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Equipment.EquipmentID=uid.ID AND uid.[Table]='Equipment' AND uid.Field='DatePurchased'
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Equipment
				INNER JOIN util_InvalidDate uid ON Equipment.EquipmentID=uid.ID AND uid.[Table]='Equipment' AND uid.Field='DatePurchased'
			WHERE
				Equipment.DatePurchased!='1900/01/01 00:00:00'
	END	
		
/*##################### EQUIPMENT DatePurchased FIX END #####################*/

/*##################### SAMPLE DateCheckedIn FIX START #####################*/
	IF (Select COUNT(*) FROM util_InvalidDate WHERE DateFixed IS NULL AND [Table]='Sample' AND Field='DateCheckedIn') > 0 BEGIN
		UPDATE Sample
				SET DateCheckedIn=u.FixedDate
		FROM
			Sample
			INNER JOIN 
			(
				SELECT
					uid.[Table],uid.Field,uid.ID
				FROM
					util_InvalidDate uid
				WHERE
					uid.DateFixed IS NULL
			) uid ON Sample.SampleID=uid.ID AND uid.[Table]='Sample' AND uid.Field='DateCheckedIn'
			OUTER APPLY
			(
				SELECT 
					 ISNULL(iat.datecreated, s.DateCreated) [FixedDate]
				FROM 
					Sample s 
					LEFT OUTER JOIN IntranetAuditTrail iat ON iat.DataTable = 'Sample' AND iat.DataID = s.SampleID AND iat.Message = 'Sample modified via Add/Edit sample screen'
				WHERE 
				  s.SampleID=Sample.SampleID
					and
				s.sampleref like '%{%'
			) u
			WHERE
				u.FixedDate IS NOT NULL
			
			UPDATE 
				uid 
				SET DateFixed=GETDATE()
			FROM
				Sample
				INNER JOIN util_InvalidDate uid ON Sample.SampleID=uid.ID AND uid.[Table]='Sample' AND uid.Field='DateCheckedIn'
			WHERE
				Sample.DateCreated !='1900/01/01 00:00:00'
				
		END
/*##################### SAMPLE DateCheckedIn FIX END #####################*/

	SET NOCOUNT OFF;
End

GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TabText = 'Project Tools') = 0
BEGIN
	INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], IsMvcTab, IsHidden, UsesMvcSubSubTabs) VALUES ((SELECT TeamsV2TabID FROM TeamsV2Tab WHERE TabText = 'Maintenance'), 'Project Tools', 9, 1, 0, 1)
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubSubTab WHERE TabText = 'Move Sub-Project') = 0
BEGIN
	INSERT INTO TeamsV2SubSubTab (TeamsV2SubTabID, TabText, [Order], IsMvcTab, IsHidden) VALUES ((SELECT TeamsV2SubTabID FROM TeamsV2SubTab WHERE TabText = 'Project Tools'), 'Move Sub-Project', 1, 1, 0)
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SupportDocument'))
	BEGIN
		CREATE TABLE [dbo].[SupportDocument](
			[SupportDocumentId] [int] IDENTITY(1,1) NOT NULL,
			[SupportTicketId] [int] NULL,
			[EmployeeId] [int] NULL,
			[FileName] [nvarchar](100) NOT NULL,
			[Uploaded] [datetime] NOT NULL CONSTRAINT [DF_SupportDocument_Uploaded]  DEFAULT (getdate()),
			[SupportTicketGuid] [uniqueidentifier] NOT NULL,
		 CONSTRAINT [PK_SupportDocument] PRIMARY KEY CLUSTERED 
		(
			[SupportDocumentId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
		) ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SupportTicket'))
	BEGIN
		CREATE TABLE [dbo].[SupportTicket](
			[SupportTicketId] [int] IDENTITY(1,1) NOT NULL,
			[Guid] [uniqueidentifier] NULL,
			[ToAddress] [varchar](5000) NULL,
			[CcAddress] [varchar](5000) NULL,
			[Subject] [varchar](500) NULL,
			[Company] [varchar](200) NULL,
			[EmployeeFullName] [varchar](200) NULL,
			[EmployeeEmail] [varchar](200) NULL,
			[Section] [varchar](100) NULL,
			[TabName] [varchar](100) NULL,
			[Client] [varchar](500) NULL,
			[Project] [varchar](500) NULL,
			[Site] [varchar](500) NULL,
			[Body] [varchar](5000) NULL,
			[TabletSystemReference] [varchar](10) NULL,
			[ItemNo] [varchar](20) NULL,
			[JsonData] [varchar](max) NULL,
			[DateCreated] [datetime] NOT NULL,
			[DateCompleted] [datetime] NULL,
		PRIMARY KEY CLUSTERED 
		(
			[SupportTicketId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_AirMonitoring') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_AirMonitoring] AS BEGIN SET NOCOUNT ON; END')
END
GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[Paged_AirMonitoring]    Script Date: 08/05/2019 15:33:42 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ======================================================
-- Author:		Lonny
-- Create date:	26/08/2016
-- Description:	Paged SP to replace inline SQL in Classic
-- ======================================================

ALTER PROCEDURE [dbo].[Paged_AirMonitoring]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filters
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@JobID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL,
	@BranchId INT = 0,
	@EmployeeId INT = 0,
	@AirTestTypeId INT = 0,
	@SurveyStatus INT = 0,
	@Accessibility INT = 0, -- (0=all, 1=accessible, 2=not accessible)
	@Approval INT = 0 -- (0=all, 1=approved, 2=unapproved)
	,@DiaryAirTestType int = 0

AS
BEGIN
	SET NOCOUNT ON;

	Set @FilterStartDate = ISNULL(@FilterStartDate,'1900-01-01 00:00:00') -- DATEADD(year,-1,GETDATE())
	Set @FilterEndDate = ISNULL(@FilterEndDate,'2099-12-31 23:59:59') -- DATEADD(month,3,GETDATE())

	SELECT TOP 1 @DiaryAirTestType = AirTestTypeID FROM AirTestType WHERE Description LIKE '%Diary%' AND AIrTestTypeID > 200

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1
      
	DECLARE @IdList TABLE (JobID INT, AirTestID INT, AirTestStart DATETIME, SiteArrival DATETIME, Created DATETIME)
      
	Insert into @IdList (JobID, AirTestID, AirTestStart, SiteArrival, Created)
	Select  
		j.jobID,
		at.AirTestID,
		at.AirTestStart,
		at.SiteArrival,
		j.Created
	From
		Job j
		Inner Join (Select JobId From Quote q Inner Join Appointment a On a.QuoteId = q.QuoteId And a.DateDeclined Is Null Where q.Rejected Is Null Group By q.JobId) a On a.JobId = j.JobId
		Inner Join JobEmployee je ON j.JobID = je.JobID
		Inner Join Employee e ON je.EmployeeID = e.EmployeeID
		Inner Join AirTest at ON je.JobEmployeeID = at.JobEmployeeID
		Inner Join AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
		Inner Join Client c ON j.ClientID = c.ClientID
		Left Outer Join Project p ON j.ProjectID = p.ProjectID
		Inner Join Site s ON j.SiteID = s.SiteID
		Left Outer Join NoAccess na On na.JobId = j.JobId And na.Created > at.AirTestFinish AND na.Deleted IS NULL
	Where 
		(
			(Select COUNT(*) FROM AirTestResult Where AirTestID=at.AirTestID)
				+
			(Select COUNT(*) FROM AirTestPDF Where AirtestID=at.AirtestID)
				+
			(select COUNT(*) FROM AirTest Where AirTestID=at.AirTestID AND (AirTestTypeID=100 OR at.AirTestTypeID = @DiaryAirTestType))
		) > 0 
			And
		att.AirTestTypeID <> 7 
			And
		att.AirTestTypeID IS NOT NULL 
			And
		j.Cancelled IS NULL
			And
		(
			LEN(@Filter) = 0
				OR
			(
				s.Address Like '%' + @Filter + '%'
					Or 
				s.Postcode Like '%' + @Filter + '%'
					Or 
				s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
					Or 
				s.UPRN = @Filter
			)
		)
			And
		(@ProjectID=0 OR j.ProjectID=@ProjectID)
			And
		(@SiteID=0 OR j.SiteID=@SiteID)
			And
		(@ClientID=0 OR j.ClientID=@ClientID)
			And
		(@BranchId=0 OR j.BranchOfficeID=@BranchId)
			And
		(@EmployeeId=0 OR je.EmployeeID=@EmployeeId)
			And
		(@AirTestTypeId=0 OR att.AirTestTypeID=@AirTestTypeId)
			And
		(
			(@Accessibility=0) -- Everything
				OR 
            (@Accessibility = 1 AND na.NoAccessId Is Null) -- Accessible
                Or
            (@Accessibility = 2 AND na.NoAccessId Is Not Null)-- Not accessible
		)
			And
		(
			(@Approval=0) -- Everything
				OR 
            (@Approval = 1 AND at.OfficeApproved = 1) -- Approved
                Or
            (@Approval = 2 AND at.OfficeApproved = 0)-- Unapproved
		)
			And
		(
			CASE WHEN @JobID > 0 THEN
				CASE WHEN j.JobID = @JobID THEN 1 ELSE 0 END
			ELSE
				CASE WHEN
					(
						ISNULL(at.SiteArrival,j.Created) BETWEEN @FilterStartDate AND @FilterEndDate
					)
				THEN 1 ELSE 0 END
			END = 1
		)
            And
        (
            (@SurveyStatus = 0) -- Everything
                Or
            (@SurveyStatus = 1 AND (at.Status IS NULL OR at.Status = '')) -- Status Empty
                Or
            (@SurveyStatus = 2 AND at.Status IS NOT NULL AND at.Status <> '') -- Status Not Empty
        )
			AND
		j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
	GROUP BY 
		j.jobID,
		at.AirTestID,
		at.AirTestStart,
		at.SiteArrival,
		j.Created
      
	DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @IdList)
		            
	;With Paging As 
	( 
		Select 
			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
			END As Pages, 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				((Row_Number() Over(Order By a.SiteArrival DESC)-1) / @PerPage)+1
			END As Page, 

			Row_Number() Over(Order By a.SiteArrival DESC) as Row_Num, 

			*
		From 
			(
				Select * FROM @IdList
			) a
	)
	
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.Row_Num,
		main.JobID,
		j.JobNo, 
		j.Created, 
		j.LastNoteCreated, 
		at.AirTestNo, 
		at.OfficeApproved, 
		at.SystemName, 
		at.AirTestID, 
		at.LocationEnclosure, 
		dbo.Ellipsis(at.LocationEnclosure,12) as LocationEnclosureShort, 
		main.SiteArrival, 
		att.AirTestTypeID, 
		att.Description, 
		c.Client, 
		s.Address + ', ' + s.Postcode [Address], 
		s.UPRN, 
		at.Status, 
		j.SiteID, 
		(
			RIGHT('0' + CONVERT(VARCHAR, DATEPART(DAY, at.AirTestStart)), 2) 
				+ 
			RIGHT('0' + CONVERT(VARCHAR, DATEPART(MONTH, at.AirTestStart)), 2) 
				+ 
			CONVERT(VARCHAR, DATEPART(YEAR, at.AirTestStart))
		) 'AirTestDate', 
		CONVERT(BIT, 1) 'PrimaryAirTest', 
		e.Fullname,
		ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
		(Select Top 1 FileName FROM PDF pf WHERE pf.DateDeleted IS NULL And Not FileName Like '%ra%' And FileName Like '%\_' + CAST(at.AirTestID AS VARCHAR) + ' (%' ESCAPE '\' And pf.JobId=main.JobId ORDER BY pf.FileName DESC) AS [FileName],
		(Select Top 1 FileName FROM PDF pf WHERE pf.DateDeleted IS NULL And FileName Like '%ra%' And FileName Like '%\_' + CAST(at.AirTestID AS VARCHAR) + ' (%' ESCAPE '\' And pf.JobId=main.JobId ORDER BY pf.FileName DESC) AS [RiskFileName],
		(
			Select Top 1 
				FileName 
			FROM 
				PDF pf 
			WHERE 
				JobId IS NULL AND 
				QuoteId IS NULL AND 
				InvoiceId IS NULL AND 
				[FileName] LIKE 'Combi%' AND 
				[FileName] LIKE 
					'%_' + 
					RIGHT('0' + CONVERT(VARCHAR, DATEPART(DAY, at.AirTestStart)), 2) + 
					RIGHT('0' + CONVERT(VARCHAR, DATEPART(MONTH, at.AirTestStart)), 2) + 
					CONVERT(VARCHAR, DATEPART(YEAR, at.AirTestStart)) + 
					'_%' AND 
				[FileName] LIKE '%site' + CAST(s.SiteID AS VARCHAR) AND 
				pf.DateDeleted IS NULL 
			ORDER BY 
				pf.PDFId DESC
		) AS [CombiFileName],
		j.ClientOrderNo
    From 
		Paging main
		INNER JOIN Job j On main.JobID = j.JobId
		Inner Join JobEmployee je ON j.JobID = je.JobID
		Inner Join Employee e ON je.EmployeeID = e.EmployeeID
		Inner Join AirTest at ON je.JobEmployeeID = at.JobEmployeeID AND main.AirTestID = at.AirTestID
		Inner Join AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
        LEFT OUTER Join Client c On j.ClientID = c.ClientID 
        LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
        LEFT OUTER Join Site s On j.SiteID = s.SiteID
	Where 
        (
			main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.Row_Num
      
    SET NOCOUNT OFF;
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetViewQuoteItems') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetViewQuoteItems] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[GetViewQuoteItems]    Script Date: 09/05/2019 10:13:41 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





-- =============================================
-- Author:		Daniel W
-- Create date: 05/12/2017
-- Description:	Stored procedure for the new 'View Quote Items' screen in 'Quote History'
-- =============================================
ALTER PROCEDURE [dbo].[GetViewQuoteItems]
	-- Add the parameters for the stored procedure here
	@QuoteID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	DECLARE 
		@QuoteVisitID int = ISNULL((SELECT qv.QuoteVisitID FROM Quote q INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID = qe.QuoteID INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qe.QuoteEmployeeID = qv.QuoteEmployeeID WHERE q.QuoteID = @QuoteID), 0),
		@ClientID int = ISNULL((SELECT q.ClientID FROM Quote q WHERE q.QuoteID = @QuoteID), 0),
		@QuoteVisitTypeID int = ISNULL((SELECT qv.QuoteVisitTypeID FROM Quote q INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID = qe.QuoteID INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qe.QuoteEmployeeID = qv.QuoteEmployeeID WHERE q.QuoteID = @QuoteID), 0)
		
	-- Table for final select
	DECLARE @FinalQuoteVisitItems TABLE (IndexID INT IDENTITY(1,1), ItemType VARCHAR(MAX), ItemId INT, Description VARCHAR(MAX), Cost MONEY, Qty DECIMAL(12, 2), Total DECIMAL(28, 6), locked INT, Markup DECIMAL(10, 6), PercentageLocked INT, TotalPrice DECIMAL(35, 10), OverallTotal DECIMAL(28, 6), OverallTotalPrice DECIMAL(35, 10), QuoteVisitSection VARCHAR(MAX), QuoteVisitSectionNo INT)

	IF (@QuoteVisitID > 0)
	BEGIN
		INSERT INTO @FinalQuoteVisitItems (ItemType, ItemId, Description, Cost, Qty, Total, locked, Markup, PercentageLocked, TotalPrice, OverallTotal, OverallTotalPrice, QuoteVisitSection, QuoteVisitSectionNo)
		SELECT 
			qvis.ItemType,
			qvis.ItemId,
			qvis.Description,
			qvis.Cost,
			ISNULL(qvis.Qty, 0),
			ISNULL(qvis.Total, 0),
			qvis.locked,
			(qvis.Markup - 1) * 100 Markup,
			qvis.PercentageLocked,
			ISNULL(qvis.TotalPrice, 0),
			Overall.OverallTotal,
			Overall.OverallTotalPrice,
			ISNULL(qvis.QuoteVisitSection, 'Site') [QuoteVisitSection],
			ISNULL(qvis.QuoteVisitSectionNo, 0) [QuoteVisitSectionNo]
		FROM 
			QuoteVisitItems qvis
			OUTER APPLY
			(
				SELECT
					ISNULL(SUM(qvis2.Total), 0) OverallTotal,
					ISNULL(SUM(qvis2.TotalPrice), 0) OverallTotalPrice
				FROM
					QuoteVisitItems qvis2
				WHERE
					qvis2.QuoteVisitID = qvis.QuoteVisitID
			) Overall
		WHERE 
			qvis.QuoteVisitID = @QuoteVisitID 
		ORDER BY
			qvis.QuoteVisitSectionNo, 
			qvis.SortOrder, 
			qvis.ItemType, 
			qvis.ItemSortOrder, 
			qvis.Description

		-- This is only needed if this going to be used as a replacement for the 'Modify Quote Items' screen.
		IF ((SELECT COUNT(*) FROM QuoteVisitItems qvis WHERE qvis.QuoteVisitID = @QuoteVisitID) = 0)
		BEGIN

			-- Temp table to store the default quote visit items before inserting them into the database.
			DECLARE @DefaultQuoteVisitItems TABLE (RowID INT IDENTITY(1,1), ClientQuoteVisitTabEntryID INT, QuoteVisitTabEntryID INT, QuoteVisitTypeID INT, QuoteVisitTab VARCHAR(50), Description VARCHAR(MAX), Value MONEY, ValueField VARCHAR(15), QuoteVisitSection BIT, Locked BIT, DefaultPercentageMarkup DECIMAL(6, 4), PercentageLocked BIT, DirectCost BIT, SortOrder INT, SplitOnInvoice BIT)
			INSERT INTO @DefaultQuoteVisitItems
			SELECT
				qvtec.QuoteVisitTabEntryID ClientQuoteVisitTabEntryID,
				qvte.QuoteVisitTabEntryID,
				qvte.QuoteVisitTypeID,
				qvte.QuoteVisitTab,
				qvte.Description,
				COALESCE(qvtec.Value, qvte.Value) Value,
				COALESCE(qvtec.ValueField, qvte.ValueField) ValueField,
				qvte.QuoteVisitSection,
				qvte.Locked,
				COALESCE(qvtec.DefaultPercentageMarkup, qvte.DefaultPercentageMarkup, 1) DefaultPercentageMarkup,
				COALESCE(qvtec.PercentageLocked, qvte.PercentageLocked) PercentageLocked,
				qvte.DirectCost,
				qvte.SortOrder,
				qvte.SplitOnInvoice
			FROM
				QuoteVisitTabEntry qvte
				LEFT JOIN QuoteVisitTabEntryClient qvtec WITH (NOLOCK) ON qvte.QuoteVisitTabEntryID = qvtec.QuoteVisitTabEntryID AND qvte.ValueField = qvtec.ValueField AND qvtec.clientid = @ClientID
			WHERE
				qvte.Site = 1
					AND
				qvte.QuoteVisitTypeID = @QuoteVisitTypeID
					AND
				qvte.Deleted IS NULL

			--SELECT * FROM @DefaultQuoteVisitItems
			INSERT INTO @FinalQuoteVisitItems (ItemType, ItemId, Description, Cost, Qty, Total, locked, Markup, PercentageLocked, TotalPrice, OverallTotal, OverallTotalPrice, QuoteVisitSection, QuoteVisitSectionNo)
			SELECT
				dqvi.QuoteVisitTab [ItemType],
				dqvi.QuoteVisitTabEntryID [ItemId],
				dqvi.Description,
				dqvi.Value [Cost],
				0 [Qty],
				0 [Total],
				CAST(dqvi.Locked as INT) [locked],
				dqvi.DefaultPercentageMarkup [Markup],
				CAST(dqvi.PercentageLocked as INT),
				0 [TotalPrice],
				0 [OveralTotal],
				0 [OveralTotalPrice],
				'Site' [QuoteVisitSection],
				0 [QuoteVisitSectionNo]
			FROM
				@DefaultQuoteVisitItems dqvi

			--Insert the default quote visit items into the database.
			DECLARE
				@Counter INT = 1, @MaxID INT = (SELECT COUNT(*) FROM @DefaultQuoteVisitItems)

			WHILE (@Counter <= @MaxID)
			BEGIN
				DECLARE
					@SQL VARCHAR(MAX) = (
						SELECT
							'INSERT INTO QuoteVisit' + dqvi.QuoteVisitTab + ' (QuoteVisitID, Description, ' + dqvi.ValueField + ', Locked, Markup, PercentageLocked, SortOrder, SplitOnInvoice) VALUES (' + CAST(@QuoteVisitID AS VARCHAR(MAX)) + ', ''' + dqvi.Description + ''', ' + CAST(dqvi.Value AS VARCHAR(MAX)) + ', ' + CAST(dqvi.Locked AS VARCHAR(1)) + ', ' + CAST(dqvi.DefaultPercentageMarkup AS VARCHAR(MAX)) + ', ' + CAST(dqvi.PercentageLocked AS VARCHAR(1)) + ', ' + CAST(dqvi.SortOrder AS VARCHAR(MAX)) + ', ' + CAST(dqvi.SplitOnInvoice AS VARCHAR(1)) + ')'
						FROM
							@DefaultQuoteVisitItems dqvi
						WHERE
							dqvi.RowID = @Counter
					)

					--SELECT @SQL
					EXEC (@SQL)

					-- Increment the counter to move to the next row
					SET @Counter = @Counter + 1
			END

		END

		SELECT * FROM @FinalQuoteVisitItems
	END
	ELSE
	BEGIN
		SELECT 
			'QuoteItem' ItemType,
			qi.QuoteItemID ItemID,
			qi.Description,
			qi.Price Cost,
			qi.Qty,
			qi.Price * qi.Qty Total,
			0 Locked,
			null Markup,
			0 PercentageLocked,
			null TotalPrice,
			Overall.OverallTotal,
			null OverallTotalPrice,
			'Site' [QuoteVisitSection],
			0 [QuoteVisitSectionNo]
		FROM
			QuoteItem qi
			OUTER APPLY
			(
				SELECT
					ISNULL(SUM(qi2.Price * qi2.Qty), 0) OverallTotal
				FROM
					QuoteItem qi2
				WHERE
					qi2.QuoteID = qi.QuoteID
			) Overall
		WHERE
			qi.QuoteID = @QuoteID
	END
END
GO

IF NOT EXISTS (SELECT [TeamsV2SectionID] FROM [dbo].[TeamsV2Section] WITH (NOLOCK) WHERE [SectionName] = 'Portfolio')
BEGIN
    INSERT INTO [dbo].[TeamsV2Section] ([SectionName], [DateDeleted], [WebPage])
    SELECT 'Portfolio', NULL, 'about:blank'
END
GO

IF NOT EXISTS(SELECT * FROM [dbo].[TeamsV2Tab] WITH (NOLOCK) WHERE [TeamsV2SectionID] = (SELECT [TeamsV2SectionID] FROM [dbo].[TeamsV2Section] WITH (NOLOCK) WHERE [SectionName] = 'Portfolio'))
BEGIN    
    DECLARE
        @SectionID [int] = (SELECT [TeamsV2SectionID] FROM [dbo].[TeamsV2Section] WITH (NOLOCK) WHERE [SectionName] = 'Portfolio')
    
    INSERT INTO [dbo].[TeamsV2Tab] ([TeamsV2SectionID], [TabText], [Order], [DateDeleted], [IsMvcTab], [UsesMvcSubTabs], [EnableMvcGrid])
    VALUES
        (@SectionID, 'Overview', 1, GETDATE(), 1, NULL, NULL),
        (@SectionID, 'My Sites', 2, GETDATE(), 1, 1, NULL),
        (@SectionID, 'My Risks', 3, GETDATE(), 1, 1, NULL),
        (@SectionID, 'Job Summary', 4, GETDATE(), 1, NULL, 1)
END
ELSE
BEGIN
	IF NOT EXISTS(SELECT * FROM [dbo].[TeamsV2Tab] WITH (NOLOCK) WHERE TabText = 'Job Summary')
	BEGIN
		DECLARE
			@TeamsSectionID [int] = (SELECT [TeamsV2SectionID] FROM [dbo].[TeamsV2Section] WITH (NOLOCK) WHERE [SectionName] = 'Portfolio')
			
		INSERT INTO [dbo].[TeamsV2Tab] ([TeamsV2SectionID], [TabText], [Order], [DateDeleted], [IsMvcTab], [UsesMvcSubTabs], [EnableMvcGrid])
		SELECT @TeamsSectionID, 'Job Summary', 4, GETDATE(), 1, NULL, 1
	END
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'AuditTrail')
BEGIN
    EXEC('CREATE VIEW[dbo].[AuditTrail] AS SELECT 1 GO')
END
GO

ALTER View [dbo].[AuditTrail]
As
SELECT
	*
FROM
(Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	sj.JobNo as ItemNo,
	sj.ClientID as ClientId,
	sj.SiteId as SiteId,
	sj.ProjectId as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
From
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER JOIN OrgInstruction o on o.orgInstructionID=iat.DataID and iat.Datatable = 'orgInstruction'
	LEFT OUTER JOIN Job sj ON o.JobID=sj.JobID 
	LEFT JOIN Client c ON sj.ClientID = c.ClientID

UNION
-------------EMPLOYEE 
Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	NULL [Client],
	1 as ItemNo,
	1 as ClientId,
	1 as SiteId,
	1 as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER Join Employee em On iat.DataTable = 'Employee' And em.EmployeeID = iat.EmployeeID
	
UNION
----------

Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	j.JobNo as ItemNo,
	j.ClientId as ClientId,
	j.SiteId as SiteId,
	j.ProjectId as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER Join Job j On iat.DataTable = 'Job' And j.JobId = iat.DataID
	INNER JOIN Client c ON j.ClientID = c.ClientID
	
UNION

Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	q.QuoteNo as ItemNo,
	q.ClientId as ClientId,
	q.SiteId as SiteId,
	q.ProjectId as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER Join Quote q On iat.DataTable = 'Quote' And q.QuoteID= iat.DataID
	INNER JOIN Client c ON q.ClientID = c.ClientID
	
UNION
Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	ISNULL(j.JobNo,q.QuoteNo) as ItemNo,
	ISNULL(j.ClientId,q.ClientID) as ClientId,
	ISNULL(j.SiteId,q.SiteID) as SiteId,
	ISNULL(j.ProjectId,q.ProjectID) as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER Join Appointment a On iat.DataTable = 'Appointment' And a.AppointmentID = iat.DataID
	INNER JOIN Client c ON a.ClientID = c.ClientID
	LEFT OUTER Join Quote q on q.QuoteID = a.QuoteID
	LEFT OUTER Join Job j On j.JobID = q.JobID
	
UNION
Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	aamj.JobNo as ItemNo,
	aamj.ClientId as ClientId,
	aamj.SiteId as SiteId,
	aamj.ProjectId as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER join AppointmentAirMonitoring aam On iat.DataTable = 'AppointmentAirMonitoring' And iat.DataId = aam.AppointmentAirMonitoringId
	Left Outer Join Appointment aama On aam.AppointmentId = aama.AppointmentId
	Left Outer Join Quote aamq On aama.QuoteId = aamq.QuoteId
	Left Outer Join Job aamj On aamq.JobId = aamj.JobId
	LEFT JOIN Client c ON aamj.ClientID = c.ClientID

UNION

Select
	iat.Category,
	e.FullName as Employee,
	iat.Message,
	iat.DataTable,
	c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
	rij.JobNo as ItemNo,
	rij.ClientId as ClientId,
	rij.SiteId as SiteId,
	rij.ProjectId as ProjectId,
	iat.DataScript,
	iat.DataIPAddress,
	iat.DateCreated
FROM
	IntranetAuditTrail iat
	Inner Join Employee e On e.EmployeeID = iat.EmployeeID
	INNER Join ReportInformation ri On iat.DataTable = 'ReportInformation' And iat.DataId = ri.ReportInformationId
	Left Outer Join Register r On r.ReportInformationID = ri.ReportInformationID
	Left Outer Join JobEmployee je On je.JobEmployeeID = r.JobEmployeeID
	Left Outer Join Job rij On rij.JobID = je.JobID
	LEFT JOIN Client c ON rij.ClientID = c.ClientID
) a

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='LegionellaType') AND name='Cost') < 1
BEGIN
  ALTER TABLE LegionellaType
      ADD Cost MONEY NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ClientCost') AND name='LegionellaTypeID') < 1
BEGIN
  ALTER TABLE ClientCost
      ADD LegionellaTypeID INT NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'insertUpdateCost') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[insertUpdateCost] AS BEGIN SET NOCOUNT ON; END')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[insertUpdateCost]    Script Date: 13/05/2019 17:20:51 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[insertUpdateCost]
    @ClientID int,
    @costID varchar(50),
    @value money
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @ClientCostID INT
    DECLARE @SurveyTypePropertyTypeCostID INT, @SurveyTypeID INT, @PropertyTypeID INT

    -- Set the ClientID to NULL if generic.
    IF @ClientID IS NULL OR @ClientID <= 0
    BEGIN
        SET @ClientID = NULL
    END

    -- If we are managing SurveyTypePropertyTypeCost records, hit this piece of code instead.
    IF @costID LIKE 'ST_PT_%'
    BEGIN
        SELECT
            @SurveyTypeID = (SELECT CAST(LTRIM(RTRIM(s)) AS INT) FROM dbo.SplitString(@costID, '_') WHERE zeroBasedOccurance = 2),
            @PropertyTypeID = (SELECT CAST(LTRIM(RTRIM(s)) AS INT) FROM dbo.SplitString(@costID, '_') WHERE zeroBasedOccurance = 3)

        SELECT @SurveyTypePropertyTypeCostID = sutptc.SurveyTypePropertyTypeCostID
        FROM SurveyTypePropertyTypeCost sutptc WITH (NOLOCK)
        WHERE sutptc.SurveyTypeID = @SurveyTypeID AND sutptc.PropertyTypeId = @PropertyTypeID AND ISNULL(sutptc.ClientID, -1) = ISNULL(@ClientID, -1)

        IF @SurveyTypePropertyTypeCostID IS NOT NULL
        BEGIN
            UPDATE SurveyTypePropertyTypeCost
            SET Cost = @Value
            WHERE SurveyTypePropertyTypeCostID = @SurveyTypePropertyTypeCostID
        END
        ELSE
        BEGIN
            INSERT INTO SurveyTypePropertyTypeCost (SurveyTypeID, PropertyTypeID, Cost, ClientID)
            VALUES (@SurveyTypeID, @PropertyTypeID, @value, @ClientID)

            SELECT @SurveyTypePropertyTypeCostID = SCOPE_IDENTITY()
        END

        SELECT @SurveyTypePropertyTypeCostID [SurveyTypePropertyTypeCostID]
    END

    IF @ClientID IS NULL AND @costID NOT LIKE 'ST_PT_%'
    begin
        IF @costID LIKE 'ST%'
        begin
            update SurveyType set Cost = @value where 'ST' + convert(varchar,SurveyTypeID) = @costID
        end
		ELSE IF @costID LIKE 'LT%'
        begin
            update LegionellaType set Cost = @value where 'LT' + convert(varchar,LegionellaTypeID) = @costID
        end
        ELSE
        BEGIN
            update Cost set Value = @value where costID = CONVERT(int,@costID)
        end
    end
    ELSE IF @costID NOT LIKE 'ST_PT_%'
    begin
        declare @match int

        if @costID like 'ST%'
        begin
            select @match = ClientCostID from ClientCost where 'ST' + convert(varchar,surveyTypeID) = @costID and clientID = @ClientID

            if not @match is null begin
                select @ClientCostID = @match
                update ClientCost set Value = @value where ClientCostID = @match and clientID = @ClientID
            end 
            else
            begin
                insert into ClientCost (ClientID, CostID, SurveyTypeID, Value)
                select
                    @ClientID,
                    null,
                    convert(int,substring(@costID,3,100)),
                    @value

                select @ClientCostID = SCOPE_IDENTITY()
            end
        end
		else if @costID like 'LT%'
        begin
            select @match = ClientCostID from ClientCost where 'LT' + convert(varchar,LegionellaTypeID) = @costID and clientID = @ClientID

            if not @match is null begin
                select @ClientCostID = @match
                update ClientCost set Value = @value where ClientCostID = @match and clientID = @ClientID
            end 
            else
            begin
                insert into ClientCost (ClientID, CostID, LegionellaTypeID, Value)
                select
                    @ClientID,
                    null,
                    convert(int,substring(@costID,3,100)),
                    @value

                select @ClientCostID = SCOPE_IDENTITY()
            end
        end
        else
        BEGIN
            select @match = ClientCostID from ClientCost where costID = convert(int,@costID) and clientID = @ClientID

            if not @match is null begin
                select @ClientCostID = @match
                update ClientCost set Value = @value where ClientCostID = @match and clientID = @ClientID
            end
            else
            begin
                insert into ClientCost (ClientID, CostID, SurveyTypeID, Value)
                select 
                    @ClientID,
                    convert(int,@costID),
                    null,
                    @value

                select @ClientCostID = SCOPE_IDENTITY()
            END
        end

        SELECT @ClientCostID [ClientCostID]
    end

END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'GetCosts')
BEGIN
    EXEC('CREATE VIEW[dbo].[GetCosts] AS SELECT 1 GO')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  View [dbo].[GetCosts]    Script Date: 13/05/2019 11:27:40 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[GetCosts]
AS
    SELECT
        Clients.ClientID [ClientId],
        c.Cost [Description],
        CONVERT(VARCHAR, c.CostID) [CostID],
        ISNULL(cc.Value, c.Value) [Value]
    FROM
        Cost c WITH (NOLOCK)
        CROSS JOIN
        (
            SELECT 0 [ClientID]
                UNION
            SELECT ClientID FROM Client WITH (NOLOCK) WHERE Deleted IS NULL
        ) Clients
        LEFT JOIN ClientCost cc WITH (NOLOCK) ON c.CostID = cc.CostID AND cc.ClientID = Clients.ClientID
    WHERE
        c.[Default] = 0

    UNION

    SELECT
        Clients.ClientID [ClientId],
        sut.Description [Description],
        'ST' + CONVERT(VARCHAR, sut.SurveyTypeID) [CostID],
        COALESCE(cc.Value, sut.Cost, dc.Value) [Value]
    FROM
        SurveyType sut WITH (NOLOCK)
        CROSS JOIN
        (
            SELECT 0 [ClientID]
                UNION
            SELECT ClientID FROM Client WITH (NOLOCK) WHERE Deleted IS NULL
        ) Clients
        LEFT JOIN ClientCost cc WITH (NOLOCK) ON sut.SurveyTypeID = cc.SurveyTypeID AND cc.ClientID = Clients.ClientID
        LEFT JOIN Cost dc WITH (NOLOCK) ON dc.[Default] = 1
    WHERE
        sut.Deleted IS NULL

    UNION

    SELECT
        Clients.ClientID [ClientId],
        sut.Description + ' - ' + pt.PropertyType [Description],
        'ST_PT_' + CAST(sut.SurveyTypeID AS VARCHAR(50)) + '_' + CAST(pt.PropertyTypeID AS VARCHAR(50)) [CostID],
        COALESCE(sutptc.Cost, cc.Value, sut.Cost, pt.DefaultCost, dc.Value) [Value]
    FROM
        SurveyType sut WITH (NOLOCK)
        CROSS JOIN
        (
            SELECT 0 [ClientID]
                UNION
            SELECT ClientID FROM Client WITH (NOLOCK) WHERE Deleted IS NULL
        ) Clients
        CROSS JOIN PropertyType pt WITH (NOLOCK)
        LEFT JOIN SurveyTypePropertyTypeCost sutptc WITH (NOLOCK) ON pt.PropertyTypeID = sutptc.PropertyTypeID AND sut.SurveyTypeID = sutptc.SurveyTypeID AND Clients.ClientID = ISNULL(sutptc.ClientID, 0)
        LEFT JOIN ClientCost cc WITH (NOLOCK) ON sut.SurveyTypeID = cc.SurveyTypeID AND cc.ClientID = Clients.ClientID
        LEFT JOIN Cost dc WITH (NOLOCK) ON dc.[Default] = 1
    WHERE
        sut.Deleted IS NULL

	UNION

    SELECT
        Clients.ClientID [ClientId],
        lt.Description [Description],
        'LT' + CONVERT(VARCHAR, lt.LegionellaTypeID) [CostID],
        COALESCE(cc.Value, lt.Cost, dc.Value) [Value]
    FROM
        LegionellaType lt WITH (NOLOCK)
        CROSS JOIN
        (
            SELECT 0 [ClientID]
                UNION
            SELECT ClientID FROM Client WITH (NOLOCK) WHERE Deleted IS NULL
        ) Clients
        LEFT JOIN ClientCost cc WITH (NOLOCK) ON lt.LegionellaTypeID = cc.LegionellaTypeID AND cc.ClientID = Clients.ClientID
        LEFT JOIN Cost dc WITH (NOLOCK) ON dc.[Default] = 1
    WHERE
        lt.Deleted IS NULL

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'TF' AND name = 'fn_getCost')
BEGIN
    EXEC('CREATE FUNCTION [dbo].[fn_getCost]() RETURNS @cost table (costID varchar(50),cost varchar(300),value money,defaultValue money) BEGIN RETURN END;')
END
GO

/*    ==Scripting Parameters==

    Source Server Version : SQL Server 2008 (10.0.1600)
    Source Database Engine Edition : Microsoft SQL Server Standard Edition
    Source Database Engine Type : Standalone SQL Server

    Target Server Version : SQL Server 2008
    Target Database Engine Edition : Microsoft SQL Server Standard Edition
    Target Database Engine Type : Standalone SQL Server
*/

USE [TEAMS]
GO

/****** Object:  UserDefinedFunction [dbo].[fn_getCost]    Script Date: 13/05/2019 16:58:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER FUNCTION [dbo].[fn_getCost]
(
    @ClientID int,
    @CostID varchar(50)
)
RETURNS 
@cost table
(
    costID varchar(50),
    cost varchar(300),
    value money,
    defaultValue money
)
AS
BEGIN

    DECLARE @SurveyTypePropertyTypeCostID INT, @SurveyTypeID INT, @PropertyTypeID INT

    -- Set the ClientID to NULL if generic.
    IF @ClientID IS NULL OR @ClientID <= 0
    BEGIN
        SET @ClientID = NULL
    END

    -- If we are managing SurveyTypePropertyTypeCost records, hit this piece of code instead.
    IF @costID LIKE 'ST_PT_%'
    BEGIN
        SELECT
            @SurveyTypeID = (SELECT CAST(LTRIM(RTRIM(s)) AS INT) FROM dbo.SplitString(@costID, '_') WHERE zeroBasedOccurance = 2),
            @PropertyTypeID = (SELECT CAST(LTRIM(RTRIM(s)) AS INT) FROM dbo.SplitString(@costID, '_') WHERE zeroBasedOccurance = 3)

        SELECT @SurveyTypePropertyTypeCostID = sutptc.SurveyTypePropertyTypeCostID
        FROM SurveyTypePropertyTypeCost sutptc WITH (NOLOCK)
        WHERE sutptc.SurveyTypeID = @SurveyTypeID AND sutptc.PropertyTypeId = @PropertyTypeID AND ISNULL(sutptc.ClientID, -1) = ISNULL(@ClientID, -1)

        INSERT INTO @Cost (costID, cost, value, defaultValue)
        SELECT
            'ST_PT_' + CAST(sut.SurveyTypeID AS VARCHAR(50)) + '_' + CAST(pt.PropertyTypeID AS VARCHAR(50)) [CostID],
            sut.Description + ' - ' + pt.PropertyType [Description],
            COALESCE(sutptc.Cost, cc.Value, sut.Cost, pt.DefaultCost, dc.Value) [Value],
            COALESCE(sut.Cost, pt.DefaultCost, dc.Value) [DefaultValue]
        FROM
            SurveyType sut WITH (NOLOCK)
            CROSS JOIN
            (
                SELECT 0 [ClientID]
                    UNION
                SELECT ClientID FROM Client WITH (NOLOCK) WHERE Deleted IS NULL
            ) Clients
            CROSS JOIN PropertyType pt WITH (NOLOCK)
            LEFT JOIN SurveyTypePropertyTypeCost sutptc WITH (NOLOCK) ON pt.PropertyTypeID = sutptc.PropertyTypeID AND sut.SurveyTypeID = sutptc.SurveyTypeID AND Clients.ClientID = ISNULL(sutptc.ClientID, 0)
            LEFT JOIN ClientCost cc WITH (NOLOCK) ON sut.SurveyTypeID = cc.SurveyTypeID AND cc.ClientID = Clients.ClientID
            LEFT JOIN Cost dc WITH (NOLOCK) ON dc.[Default] = 1
        WHERE
            sut.Deleted IS NULL
                AND
            (
                sutptc.SurveyTypePropertyTypeCostID = @SurveyTypePropertyTypeCostID
                    OR
                (
                    @SurveyTypePropertyTypeCostID IS NULL
                        AND
                    sut.SurveyTypeID = @SurveyTypeID
                        AND
                    pt.PropertyTypeID = @PropertyTypeID
                        AND
                    ISNULL(NULLIF(Clients.ClientID, 0), -1) = ISNULL(@ClientID, -1)
                )
            )
    END

    IF @ClientID IS NULL AND @costID NOT LIKE 'ST_PT_%' AND @CostID LIKE 'ST%'
    BEGIN
        INSERT INTO @Cost (costID, cost, value, defaultValue)
        select
            convert(varchar(50),CostID),
            Cost,
            Value,
            Value
        from
            Cost
        where
            convert(varchar(50),CostID) = @CostId
                and
            [Default] = 0

        INSERT INTO @Cost (costID, cost, value, defaultValue)
        Select
            'ST' + convert(varchar(50),SurveyTypeID),   -- ST denotes it is a survey type
            [Description],
            IsNull(Cost, (Select Value From Cost Where [Default] = 1)),
            IsNull(Cost, (Select Value From Cost Where [Default] = 1))
        From
            SurveyType
        Where
            'ST' + convert(varchar(50),SurveyTypeID) = @CostID
                and
            Deleted is NULL
    end
    ELSE IF @costID NOT LIKE 'ST_PT_%' AND @CostID LIKE 'ST%'
    begin
        INSERT INTO @Cost (costID, cost, value, defaultValue)
        select
            cc.CostID,
            c.Cost,
            isnull(cc.Value,c.Value) Value,
            c.Value defaultValue
        from
            Cost c
            left outer join 
            (
                select * from ClientCost where clientID = @ClientID
            ) cc on cc.costid = c.costid
        where 
            convert(varchar(50),c.CostID) = @CostId
                and
            c.[Default] = 0

        INSERT INTO @Cost (costID, cost, value, defaultValue)
        Select
            'ST' + convert(varchar(50),st.SurveyTypeID),   -- ST denotes it is a survey type
            st.[Description],
            IsNull(cc.Value,IsNull(st.Cost, (Select Value From Cost Where [Default] = 1))),
            IsNull(st.Cost, (Select Value From Cost Where [Default] = 1))
        From
            SurveyType st
            left outer join 
            (
                select * from ClientCost where clientID = @ClientID
            ) cc on cc.surveytypeid = st.surveytypeid
        Where
            'ST' + convert(varchar(50),st.SurveyTypeID) = @CostID
                and
            st.Deleted is NULL
    end

	-- Legionella Type support
	IF @ClientID IS NULL AND @costID LIKE 'LT%'
    BEGIN
        INSERT INTO @Cost (costID, cost, value, defaultValue)
        select
            convert(varchar(50),CostID),
            Cost,
            Value,
            Value
        from
            Cost
        where
            convert(varchar(50),CostID) = @CostId
                and
            [Default] = 0

        INSERT INTO @Cost (costID, cost, value, defaultValue)
        Select
            'LT' + convert(varchar(50),LegionellaTypeID),   -- LT denotes it is a legionella type
            [Description],
            IsNull(Cost, (Select Value From Cost Where [Default] = 1)),
            IsNull(Cost, (Select Value From Cost Where [Default] = 1))
        From
            LegionellaType
        Where
            'LT' + convert(varchar(50),LegionellaTypeID) = @CostID
                and
            Deleted is NULL
    end
    ELSE IF @costID LIKE 'LT%'
    begin
        INSERT INTO @Cost (costID, cost, value, defaultValue)
        select
            cc.CostID,
            c.Cost,
            isnull(cc.Value,c.Value) Value,
            c.Value defaultValue
        from
            Cost c
            left outer join 
            (
                select * from ClientCost where clientID = @ClientID
            ) cc on cc.costid = c.costid
        where 
            convert(varchar(50),c.CostID) = @CostId
                and
            c.[Default] = 0

        INSERT INTO @Cost (costID, cost, value, defaultValue)
        Select
            'LT' + convert(varchar(50),lt.LegionellaTypeID),   -- LT denotes it is a legionella type
            lt.[Description],
            IsNull(cc.Value,IsNull(lt.Cost, (Select Value From Cost Where [Default] = 1))),
            IsNull(lt.Cost, (Select Value From Cost Where [Default] = 1))
        From
            LegionellaType lt
            left outer join 
            (
                select * from ClientCost where clientID = @ClientID
            ) cc on cc.legionellatypeid = lt.legionellatypeid
        Where
            'LT' + convert(varchar(50),lt.LegionellaTypeID) = @CostID
                and
            lt.Deleted is NULL
    end
	ELSE
	BEGIN
		insert into @cost
        select
            cc.CostID,
            c.Cost,
            isnull(cc.Value,c.Value) Value,
            c.Value defaultValue
        from
            Cost c
            left outer join 
            (
                select * from ClientCost where clientID = @ClientID
            ) cc on cc.costid = c.costid
        where 
            convert(varchar(50),c.CostID) = @CostId
                and
            c.[Default] = 0
	END

    RETURN
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Employee') AND name='LegionellaApprover') < 1
BEGIN
	ALTER TABLE [dbo].[Employee]
	ADD [LegionellaApprover] [bit] NOT NULL
	CONSTRAINT [DF_Employee_LegionellaApprover]
	DEFAULT (0);
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ExportType') AND name='ExportSectionTypeID') < 1
BEGIN
  ALTER TABLE ExportType
      ADD ExportSectionTypeID INT NOT NULL
	  CONSTRAINT defaultExportSectionTypeID DEFAULT 1
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ExportSectionType'))
BEGIN
	CREATE TABLE [dbo].[ExportSectionType](
		[ExportSectionTypeID] [int] IDENTITY(1,1) NOT NULL,
		[Description] [varchar](max) NULL
	)
END
GO

IF (SELECT COUNT(*) FROM ExportSectionType WHERE ExportSectionTypeID = 1) < 1
BEGIN
	SET IDENTITY_INSERT ExportSectionType ON
	INSERT INTO ExportSectionType (ExportSectionTypeID, Description) VALUES (1, 'Completed Surveys')
	SET IDENTITY_INSERT ExportSectionType OFF
END
GO

IF (SELECT COUNT(*) FROM ExportSectionType WHERE ExportSectionTypeID = 2) < 1
BEGIN
	SET IDENTITY_INSERT ExportSectionType ON
	INSERT INTO ExportSectionType (ExportSectionTypeID, Description) VALUES (2, 'Legionella - Completed Jobs')
	SET IDENTITY_INSERT ExportSectionType OFF
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__UseV2ApproveReport') < 1
BEGIN
  ALTER TABLE [dbo].[Config]
	ADD [b__UseV2ApproveReport] [bit] NOT NULL
	CONSTRAINT [DF_Config_b__UseV2ApproveReport]
	DEFAULT (0);
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubSubTab WHERE TabText = 'Site Data Repair') = 0
BEGIN
	INSERT INTO TeamsV2SubSubTab (TeamsV2SubTabID, TabText, [Order], IsMvcTab, IsHidden)
	SELECT (SELECT TeamsV2SubTabID FROM TeamsV2SubTab WHERE TabText = 'Job Tools'), 'Site Data Repair', 11, 1, 0
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GUID_CreateGUID_ByJob') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GUID_CreateGUID_ByJob] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



      /*    ###########################################################################################################
            09/01/2016 - Changed to include the register ID in the intial part of the GUID to deal with the speed 
            issues that were coming from imported data where the datetimes are identical for lots and lots of records.
            ###########################################################################################################    */   



ALTER PROCEDURE [dbo].[GUID_CreateGUID_ByJob] 
      @JobID INT,
	  @DisablePopulateProcedures INT = 0,
      @Return INT output
AS
BEGIN


      SET NOCOUNT ON;

      /*    #######################################
            Get each register, floorplan, room and sample for a job.
            #######################################    */   
      DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobID)
      DECLARE @SiteID INT =   (Select SiteID FROM Job Where JobID=@JobID)
            
      DECLARE @JobSummary TABLE 
                  (
                        JobID INT,RegisterID INT, RegisterGUID VARCHAR(MAX),RegisterCreated DATETIME,
                        FloorplanID INT, FloorplanGUID VARCHAR(MAX),FloorplanCreated DATETIME,
                        RoomID INT, RoomGUID VARCHAR(MAX),RoomCreated DATETIME,
                        SampleID INT, SampleGUID VARCHAR(MAX),SampleCreated DATETIME
                  )
      
      ;with cte_IDList (JobID,RegisterID,FloorplanID,RoomID,SampleID)
      as
      (
            SELECT 
                  j.JobID,r.RegisterID,fp.FloorplanID,rm.RoomID,s.SampleID
            FROM Job j
                  INNER JOIN JobEmployee je ON je.JobID = j.JobID
                  INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
                  --INNER JOIN Survey su ON su.SurveyID = r.SurveyID
                  INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
                  INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
                  INNER JOIN Sample s ON s.RoomID = rm.RoomID
            WHERE j.JobID = @JobID AND (r.GUID IS NULL OR fp.GUID IS NULL OR rm.GUID IS NULL OR s.GUID IS NULL)
      )
      
      Insert into @JobSummary (RegisterID,FloorplanID,RoomID,SampleID) Select ids.RegisterID,ids.FloorplanID,ids.RoomID,ids.SampleID FROM cte_IDList ids
      
	  /*    #######################################
            Creating a UNIQUE GUID based on time and ID of the table level - not possible to get duplicate without a manual update, so no need to test.
            #######################################    */
      
      --    REGISTER GUIDS#########################
	  Update @JobSummary 
		Set 
			RegisterGUID
				=
			'SCMG-' + CAST(r.RegisterID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Register'
            CROSS JOIN Config c
      --    END REGISTER GUIDS#########################
      
      --    FLOORPLAN GUIDS#########################
      Update @JobSummary 
		Set 
			FloorplanGUID
				=
			'SCMG-' + CAST(fp.FloorplanID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=js.FloorplanID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Floorplan'
            CROSS JOIN Config c
      --    END FLOORPLAN GUIDS#########################
      
      --    ROOM GUIDS#########################
	  Update @JobSummary 
		Set 
			RoomGUID
				=
			'SCMG-' + CAST(rm.RoomID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID=js.RoomID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Room'
            CROSS JOIN Config c
	  --    END ROOM GUIDS#########################
      
      --    SAMPLE GUIDS#########################
	  Update @JobSummary 
		Set 
			SampleGUID
				=
			'SCMG-' + CAST(s.SampleID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Sample s WITH (NOLOCK) ON s.SampleID=js.SampleID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Sample'
            CROSS JOIN Config c
      --    END SAMPLE GUIDS#########################
      
      /*    #######################################
            Update each record updating the GUID with a where clause to make sure the GUID does not exist, keeping a track of the total number of updated rows. This needs to match the record count of those that need updating.
            #######################################    */   
      
      DECLARE @registerUpdated INT = (Select COUNT(DISTINCT RegisterID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @floorplanUpdated INT = (Select COUNT(DISTINCT FloorplanID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @roomUpdated INT = (Select COUNT(DISTINCT RoomID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @sampleUpdated INT = (Select COUNT(DISTINCT SampleID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @UpdatesComplete BIT = 1
      
      IF (Select COUNT(*) FROM @JobSummary)=0 BEGIN 
            Set @Return = 2 
            Set @UpdatesComplete = 0
      END
      
      IF @UpdatesComplete = 1
      BEGIN
            BEGIN TRANSACTION
                  
                  --#### UPDATE ACTUAL TABLE RECORDS ####         
                  UPDATE Register Set GUIDVersion=1,GUID=u.Guid FROM Register INNER JOIN (Select RegisterID,RegisterGUID [Guid] FROM @JobSummary Where RegisterGUID IS NOT NULL GROUP BY RegisterID,RegisterGUID) u ON u.RegisterID=Register.RegisterID
                  IF @@ROWCOUNT <> @registerUpdated BEGIN Set @UpdatesComplete = 5 END
                  
                  UPDATE Floorplan Set GUIDVersion=1,GUID=u.Guid FROM Floorplan INNER JOIN (Select FloorplanID,FloorplanGUID [Guid] FROM @JobSummary Where FloorplanGUID IS NOT NULL GROUP BY FloorplanID,FloorplanGUID) u ON u.FloorplanID=Floorplan.FloorplanID
                  IF @@ROWCOUNT <> @floorplanUpdated BEGIN Set @UpdatesComplete = 6 END
                  
                  UPDATE Room Set GUIDVersion=1,GUID=u.Guid FROM Room INNER JOIN (Select RoomID,RoomGUID [Guid] FROM @JobSummary Where RoomGUID IS NOT NULL GROUP BY RoomID,RoomGUID) u ON u.RoomID=Room.RoomID
                  IF @@ROWCOUNT <> @roomUpdated BEGIN Set @UpdatesComplete = 7 END
                  
                  UPDATE Sample Set GUIDVersion=1,GUID=u.Guid FROM Sample INNER JOIN (Select SampleID,SampleGUID [Guid] FROM @JobSummary Where SampleGUID IS NOT NULL GROUP BY SampleID,SampleGUID) u ON u.SampleID=Sample.SampleID
                  IF @@ROWCOUNT <> @sampleUpdated BEGIN Set @UpdatesComplete = 8 END
            
            IF @UpdatesComplete = 1
                  BEGIN
                        COMMIT TRANSACTION
                        IF (Select COUNT(*) FROM Job Where Approved IS NOT NULL AND JobID=@JobID) > 0 AND @DisablePopulateProcedures = 0 BEGIN
                              Exec PopulateGuidSamples @ClientId, @SiteId 
                              Exec CreateSiteSampleResultsOverviewSorting @ClientId, @SiteId
                        END
                        Set @Return = 1
                  END
            ELSE
                  BEGIN
                        ROLLBACK TRANSACTION
                        Set @Return = 0
            END
      END
      
      RETURN @Return
      
      SET NOCOUNT OFF;

END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__JobLogsShowSiteDocuments') < 1
BEGIN
	ALTER TABLE [dbo].[Config]
		ADD [b__JobLogsShowSiteDocuments] [bit] NOT NULL
		CONSTRAINT [DF_Config_b__JobLogsShowSiteDocuments]
		DEFAULT (1);
END
GO

ALTER PROCEDURE [dbo].[JobLogNoteIdList]
       @EnquiryId INT = NULL
       , @JobId INT = NULL
       , @SiteId INT = NULL
       , @QuoteId INT = NULL
       , @AirTestId INT = NULL
       , @InvoiceId INT = NULL
       , @RemovalId INT = NULL,
	   @ProjectGroupId INT = NULL
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

       -- tidy input variables
       SELECT @EnquiryId = ISNULL(@EnquiryId, 0)
       SELECT @JobId = ISNULL(@JobId, 0)
       SELECT @SiteId = ISNULL(@SiteId, 0)
	   SELECT @ProjectGroupId = ISNULL(@ProjectGroupId, 0)
       SELECT @QuoteId = ISNULL(@QuoteId, 0)
       SELECT @AirTestId = ISNULL(@AirTestId, 0)
       SELECT @InvoiceId = ISNULL(@InvoiceId, 0)
       SELECT @RemovalId = ISNULL(@RemovalId, 0)

	DECLARE
		@ShowSiteDocuments BIT = (SELECT TOP 1 b__JobLogsShowSiteDocuments FROM Config)
       
       /**************************************************************************************************************************************
       -- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
       --   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
       **************************************************************************************************************************************/
       DECLARE @DynamicSQL NVARCHAR(MAX)

       IF @InvoiceId > 0 BEGIN

              SELECT @DynamicSQL = '
              SELECT DISTINCT
                     0 AS EnquiryId
                     , 0 AS JobId
                     , 0 AS JobProjectId
                     , 0 AS SiteId
                     , 0 AS QuoteId
                     , 0 AS QuoteProjectId
                     , 0 AS ParentQuoteId
                     , IsNull(i.InvoiceId, 0) as InvoiceId
                     , 0 AS RemovalId
              FROM
                     InvoiceItem i
              WHERE 
                     1=1 
                     AND i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000)) + ' 
              UNION SELECT
                     0 AS EnquiryId
                     , 0 AS JobId
                     , 0 AS JobProjectId
                     , 0 AS SiteId
                     , 0 AS QuoteId
                     , 0 AS QuoteProjectId
                     , 0 AS ParentQuoteId
                     , i.InvoiceId 
                     , 0 AS RemovalId
              FROM
                     Invoice i
                     LEFT OUTER JOIN ProFormaItem p On i.InvoiceID = p.InvoiceID
                     LEFT OUTER JOIN CreditItem c On i.InvoiceID = c.InvoiceID
              WHERE 
                     i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000))   

       END ELSE BEGIN

              IF ( @EnquiryId > 0 OR @QuoteId > 0 OR @JobId > 0 OR @AirTestId > 0 OR @RemovalID > 0 OR @InvoiceId > 0 ) AND @SiteId = 0 BEGIN

                     SELECT @DynamicSQL = '
                     SELECT DISTINCT
                IsNull(e.EnquiryId, 0) AS EnquiryId
                           , IsNull(j.JobID, 0) AS JobId
                           , IsNull(j.ProjectID, 0) As JobProjectId
                           , CASE WHEN 1 = ' + CONVERT(VARCHAR(MAX),@ShowSiteDocuments) + ' THEN IsNull(j.SiteID, 0) ELSE 0 END AS SiteId
                , IsNull(q.QuoteID, 0) AS QuoteId
                           , IsNull(q.ProjectID, 0) As QuoteProjectId
                , IsNull(q.ParentId, 0) AS ParentQuoteId
                , 0 AS InvoiceId
                , IsNull(r.RemovalId, 0) AS RemovalId
            FROM
                Enquiry e
                FULL OUTER JOIN Quote q ON q.QuoteId = e.QuoteId
                FULL OUTER JOIN InvoiceItem i ON q.InvoiceItemId = i.InvoiceItemId
                FULL OUTER JOIN Job j ON j.JobId = q.JobId
                OUTER APPLY (SELECT r.RemovalID FROM JobEmployee je INNER JOIN Removal r ON je.JobEmployeeID = r.JobEmployeeID WHERE je.JobID=j.JobID) r
            WHERE
                           1=1'

                     IF @RemovalId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND r.RemovalId = ' + CAST(@RemovalId AS nvarchar(4000))
                     END

                     IF @EnquiryId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND e.EnquiryId = ' + CAST(@EnquiryId AS nvarchar(4000))
                     END

                     IF @QuoteId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND q.QuoteId = ' + CAST(@QuoteId AS nvarchar(4000))
                     END

                     IF @JobId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL + ' AND j.JobId = ' + CAST(@JobId AS nvarchar(4000))
                     END

                     IF @InvoiceId > 0 BEGIN
                           SELECT @DynamicSQL = @DynamicSQL 
                                  + ' AND i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000)) + ' 
                                  UNION SELECT 
                                         0 AS EnquiryId
                                         , 0 AS JobId
                                         , 0 AS JobProjectId
                                         , 0 AS SiteId
                                         , 0 AS QuoteId
                                         , 0 AS QuoteProjectId
                                         , 0 AS ParentQuoteId
                                         , i.InvoiceId
                                         , 0 AS RemovalId
                                  FROM
                                         Invoice i
                                         LEFT OUTER JOIN ProFormaItem p On i.InvoiceID = p.InvoiceID
                                         LEFT OUTER JOIN CreditItem c On i.InvoiceID = c.InvoiceID
                                  WHERE
                                         i.InvoiceId = ' + CAST(@InvoiceId AS nvarchar(4000))
                     END
              END

              IF @SiteId > 0 BEGIN
                     SELECT @DynamicSQL = '
                     SELECT 
                           0 AS EnquiryId
                           , 0 AS JobId
                           , 0 AS JobProjectId
                           , IsNull(SiteID, 0) AS SiteId
                           , 0 AS ProjectId
                           , 0 AS QuoteId
                           , 0 AS QuoteProjectId
                           , 0 AS ParentQuoteId
                           , 0 AS InvoiceId 
                           , 0 AS RemovalId
                     FROM
                           Site
                     WHERE
                           SiteId = ' + CAST(@SiteId AS nvarchar(4000))
              END

			  IF @ProjectGroupId > 0 BEGIN
                     SELECT @DynamicSQL = '
                     SELECT 
                           0 AS EnquiryId
                           , 0 AS JobId
                           , 0 AS JobProjectId
                           , 0 AS SiteId
                           , ISNULL(ProjectGroupID, 0) AS ProjectId
                           , 0 AS QuoteId
                           , 0 AS QuoteProjectId
                           , 0 AS ParentQuoteId
                           , 0 AS InvoiceId 
                           , 0 AS RemovalId
                     FROM
                           ProjectGroup
                     WHERE
                           ProjectGroupID = ' + CAST(@ProjectGroupId AS nvarchar(4000))
              END
       END

       -- execute the SQL
       EXECUTE sp_executesql @DynamicSQL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'EmployeeRoles')
BEGIN
    EXEC('CREATE VIEW[dbo].[EmployeeRoles] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[EmployeeRoles]
As
Select * From
(
	Select 0 as RoleId, 'No Roles' AS [Role],     FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Administrator = 0 And Manager = 0 And Approver = 0 And AirTester = 0 And BulkAnalyst = 0 And Trainer = 0 And BulkSampler = 0	
	Union
	Select 1 as RoleId, 'TEAMS Admin' as [Role],  FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Administrator = 1 	
	Union																																	  
	Select 2 as RoleId, 'Manager' as [Role],      FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Manager = 1	
	Union																																	  
	Select 3 as RoleId, 'Approver' as [Role],     FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Approver = 1	
	Union																																	  
	Select 4 as RoleId, 'Surveyor' as [Role],     FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Surveyor = 1	
	Union																																	  
	Select 5 as RoleId, 'Air Tester' as [Role],   FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where AirTester = 1	
	Union																																	  
	Select 6 as RoleId, 'Bulk Analyst' as [Role], FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where BulkAnalyst = 1	
	Union																																	  
	Select 7 as RoleId, 'Trainer' as [Role],      FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where Trainer = 1	
	Union																																	  
	Select 8 as RoleId, 'Bulk Sampler' as [Role], FullName, EmployeeID, Username, Position, b.BranchOfficeId, BranchOffice, SortOrder, Deleted, [Enabled] From Employee e Left Outer Join BranchOffice b On e.BranchOfficeId = b.BranchOfficeId Where BulkSampler = 1

) as a

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Currency') AND name='InvoiceVatCodeId') < 1
BEGIN
  	ALTER TABLE [dbo].[Currency]
	ADD [InvoiceVatCodeId] [int] NULL;
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='MobileLoadExecution'))
	BEGIN
		CREATE TABLE [dbo].[MobileLoadExecution] (
		[MobileLoadExecutionID] [int] IDENTITY (1, 1) NOT NULL,
		[ExecBlock] [varchar] (MAX) NOT NULL,
		[Failed] DATETIME NULL,
		[Completed] DATETIME NULL,
		[Created] DATETIME DEFAULT(GETDATE()) NOT NULL,
		[Deleted] DATETIME NULL,
		[DeviceGUID] [uniqueidentifier] NOT NULL,
		[App] [varchar] (MAX) NOT NULL,
		[TargetVersion] [varchar] (MAX) NULL,
		[Platform] [varchar] (MAX) NOT NULL,
		CONSTRAINT [PK_MobileLoadExecution]
		PRIMARY KEY CLUSTERED
		(
			[MobileLoadExecutionID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];
	END 

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'mobile_v2_LoadExecution') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[mobile_v2_LoadExecution] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROC [dbo].[mobile_v2_LoadExecution]
(
	@SystemName nvarchar(MAX),
    @EmployeeID INT,
	@DeviceGuid uniqueidentifier,
	@App VARCHAR(50),
	@Version VARCHAR(50),
	@Platform VARCHAR(50)
)
AS
BEGIN
	
	SET NOCOUNT ON;	
	
	SELECT
		[MobileLoadExecutionID],
		[ExecBlock],
		[Failed],
		[Completed],
		[Created],
		[DeviceGUID],
		[App],
		[TargetVersion],
		[Platform]
	FROM
		MobileLoadExecution
	WHERE
		DeviceGUID=@DeviceGuid
			AND
		[App]=@App
			AND
		[Platform]=@Platform
			AND
		[Deleted] IS NULL AND Completed IS NULL AND Failed IS NULL
			AND
		CASE WHEN [TargetVersion] IS NOT NULL THEN CASE WHEN [TargetVersion]=@Version THEN 1 ELSE 0 END ELSE 1 END = 1

	SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'mobile_v2_LoadExecutionResult') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[mobile_v2_LoadExecutionResult] AS BEGIN SET NOCOUNT ON; END')
End
GO

ALTER PROC [dbo].[mobile_v2_LoadExecutionResult]
(
	@SystemName nvarchar(MAX),
    @EmployeeID INT,
	@DeviceGuid uniqueidentifier,
	@App VARCHAR(50),
	@Version VARCHAR(50),
	@Platform VARCHAR(50),
	@Completed INT = NULL,
	@Failed INT = NULL,
	@MobileLoadExecutionID INT
)
AS
BEGIN
	
	SET NOCOUNT ON;	
	
	Update
		MobileLoadExecution
	SET
		Completed=CASE WHEN @Completed = 1 THEN GETDATE() ELSE NULL END, Failed=CASE WHEN @Failed = 1 THEN GETDATE() ELSE NULL END
	WHERE
		MobileLoadExecutionID = @MobileLoadExecutionID

	SET NOCOUNT OFF;
END

GO

IF (SELECT IsMvcTab FROM TeamsV2Tab WHERE TabText = 'Staff') = 0 Or (SELECT UsesMvcSubTabs FROM TeamsV2Tab WHERE TabText = 'Staff') = 0
BEGIN
	UPDATE TeamsV2Tab SET IsMvcTab = 1, UsesMvcSubTabs = 1 WHERE TeamsV2TabId = (SELECT TeamsV2TabId FROM TeamsV2Tab WHERE TabText = 'Staff')
																	AND
																 TeamsV2SectionID = (SELECT TeamsV2SectionID FROM TeamsV2Section WHERE SectionName = 'Management')
END
GO

IF (SELECT COUNT(*) FROM TeamsV2SubTab WHERE TeamsV2TabId = (SELECT TeamsV2TabId FROM TeamsV2Tab WHERE TabText = 'Staff')) = 0
BEGIN
	
	DECLARE
		@TabId INT = (SELECT TeamsV2TabId FROM TeamsV2Tab WHERE TabText = 'Staff')
	
	INSERT INTO TeamsV2SubTab (TeamsV2TabID, TabText, [Order], DateDeleted, IsMvcTab)
	VALUES
	(@TabId, 'Staff', 1, NULL, NULL),
	(@TabId, 'Training', 2, NULL, 1),
	(@TabId, 'Authorisations', 3, GETDATE(), 1)
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='TrainingCategory'))
	BEGIN
		CREATE TABLE [dbo].[TrainingCategory](
			[TrainingCategoryID] [int] IDENTITY(1,1) NOT NULL,
			[Description] [varchar](max) NULL,
			[Deleted] [datetime] NULL,
			[Frequency] [int] NULL,
		CONSTRAINT [PK_TrainingCategory] PRIMARY KEY CLUSTERED 
		(
			[TrainingCategoryID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='TrainingEntry'))
	BEGIN
		CREATE TABLE [dbo].[TrainingEntry](
			[TrainingEntryID] [int] IDENTITY(1,1) NOT NULL,
			[EmployeeID] [int] NULL,
			[TrainingCategoryID] [int] NULL,
			[Performed] [datetime] NULL,
			[File] [varchar](max) NULL,
			[Notes] [varchar](max) NULL,
		CONSTRAINT [PK_TrainingEntry] PRIMARY KEY CLUSTERED 
		(
			[TrainingEntryID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLatestEmployeeTrainingRecords') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLatestEmployeeTrainingRecords] AS BEGIN SET NOCOUNT ON; END')
End
GO

ALTER PROCEDURE [dbo].[GetLatestEmployeeTrainingRecords]
	-- Add the parameters for the stored procedure here
	@EmployeeID INT = 0,
	@TrainingCategoryID INT = 0,
	@BranchOfficeID INT = 0,
	@RefresherDue BIT = 0,
	@SelectedMonthYearDue VARCHAR(20) = '',
	@AllRecords BIT = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	-- We have selected a specific month and year
	DECLARE
		@SelectedMonthDue VARCHAR(15) = '',
		@SelectedYearDue VARCHAR(5) = ''

	SET @SelectedMonthDue = (SELECT s FROM dbo.SplitString(@SelectedMonthYearDue, ' ') WHERE zeroBasedOccurance = 0)
	SET @SelectedYearDue = (SELECT s FROM dbo.SplitString(@SelectedMonthYearDue, ' ') WHERE zeroBasedOccurance = 1)

	-- Create a temp table of Training Category IDs
	DECLARE @CategoryIDs TABLE (IndexID INT IDENTITY(1,1), TraingCategoryID INT)
	INSERT INTO @CategoryIDs (TraingCategoryID)

	SELECT
		tc.TrainingCategoryID
	FROM
		TrainingCategory tc
	WHERE
		tc.Deleted IS NULL

	-- Create a temp table of all employees and all training categories
	DECLARE @CategoryEmployee TABLE (IndexID INT IDENTITY(1,1), TrainingCategoryID INT, EmployeeID INT)

	-- Loop through the @CategoryIDs table to insert a row into the @CategoryEmployee table for each employee and each training category
	DECLARE @CurrentTCID INT = 0
	WHILE (SELECT COUNT(*) FROM @CategoryIDs) > 0
	BEGIN

		SET @CurrentTCID = (SELECT TOP 1 TraingCategoryID FROM @CategoryIDs)

		INSERT INTO @CategoryEmployee (TrainingCategoryID, EmployeeID)

		SELECT
			@CurrentTCID,
			e.EmployeeID
		FROM
			Employee e
		WHERE
			e.Deleted IS NULL

		DELETE FROM @CategoryIDs WHERE TraingCategoryID = @CurrentTCID

	END

	-- Final select
	SELECT DISTINCT
		CASE
			WHEN @AllRecords = 1
			THEN TrainingEntryRecord2.TrainingEntryID
			ELSE TrainingEntryRecord.TrainingEntryID
		END [TrainingEntryId],
		tc.Description,
		tc.TrainingCategoryID,
		e.FullName,
		e.EmployeeID,
		e.Enabled [EmployeeEnabled],
		CASE
			WHEN @AllRecords = 1
			THEN TrainingEntryRecord2.Performed
			ELSE TrainingEntryRecord.Performed
		END [Performed],
		CASE
			WHEN @AllRecords = 1
			THEN 
				CASE
					WHEN tc.Frequency > 0 AND TrainingEntryRecord2.Performed IS NOT NULL
					THEN TrainingEntryRecord2.Due
					ELSE NULL
				END
			ELSE 
				CASE
					WHEN tc.Frequency > 0 AND TrainingEntryRecord.Performed IS NOT NULL
					THEN TrainingEntryRecord.Due
					ELSE NULL
				END
		END [Due],
		CASE
			WHEN @AllRecords = 1
			THEN TrainingEntryRecord2.[File]
			ELSE TrainingEntryRecord.[File]
		END [File],
		CASE
			WHEN @AllRecords = 1
			THEN TrainingEntryRecord2.Notes
			ELSE TrainingEntryRecord.Notes
		END [Notes]
	FROM
		@CategoryEmployee ce
		INNER JOIN TrainingCategory tc ON ce.TrainingCategoryID = tc.TrainingCategoryID
		INNER JOIN Employee e ON ce.EmployeeID = e.EmployeeID
		OUTER APPLY
		(
			SELECT TOP 1
				te1.TrainingEntryID, te1.Performed, te1.[File], DATEADD(MONTH, tc.Frequency, te1.Performed) [Due], te1.Notes
			FROM
				TrainingEntry te1
			WHERE
				te1.TrainingCategoryID = tc.TrainingCategoryID
					AND
				te1.EmployeeID = e.EmployeeID
			ORDER BY
				te1.Performed DESC
		) TrainingEntryRecord

		OUTER APPLY
		(
			SELECT
				te1.TrainingEntryID, te1.Performed, te1.[File], DATEADD(MONTH, tc.Frequency, te1.Performed) [Due], te1.Notes
			FROM
				TrainingEntry te1
			WHERE
				te1.TrainingCategoryID = tc.TrainingCategoryID
					AND
				te1.EmployeeID = e.EmployeeID
		) TrainingEntryRecord2
	WHERE
		(
			CASE
				WHEN @TrainingCategoryID > 0
				THEN
					CASE
						WHEN tc.TrainingCategoryID = @TrainingCategoryID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @EmployeeID > 0
				THEN
					CASE
						WHEN e.EmployeeID = @EmployeeID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @BranchOfficeID > 0
				THEN
					CASE
						WHEN e.BranchOfficeID = @BranchOfficeID
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN @RefresherDue = 1
				THEN
					CASE
						WHEN TrainingEntryRecord.Due IS NOT NULL
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
			AND
		(
			CASE
				WHEN LEN(@SelectedMonthYearDue) > 0
				THEN
					CASE
						WHEN DATENAME(MONTH, TrainingEntryRecord.Due) = @SelectedMonthDue AND DATENAME(YEAR, TrainingEntryRecord.Due) = @SelectedYearDue
						THEN 1
						ELSE 0
					END
				ELSE 1
			END
		) = 1
	ORDER BY
		e.FullName
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_GuidedDataStateSummary') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_GuidedDataStateSummary] AS BEGIN SET NOCOUNT ON; END')
End

GO

IF NOT EXISTS (SELECT CustomReportID FROM CustomReport WHERE Report = 'Turnover Report' AND SubTabName = 'TEAMS')
BEGIN
	INSERT INTO CustomReport (Report, ProcedureName, Notes, DateCreated, SubTabName, ManagerOnly)
	SELECT 'Turnover Report', 'TEAMS_Report_Turnover', 'This report will give you a sum of all work, grouped by Quote Type.', GetDATE(), 'TEAMS', 1

	INSERT INTO CustomReportParameter (CustomReportID, Name, DataType, Required)
	SELECT (SELECT SCOPE_IDENTITY()), 'StartMonth', 'month', 1
	
END
ELSE
BEGIN
	UPDATE CustomReport SET ManagerOnly = 1 WHERE CustomReportID IN (SELECT CustomReportID FROM CustomReport WHERE Report = 'Turnover Report' AND SubTabName = 'TEAMS')
END	
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingSampleReports') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingSampleReports] AS BEGIN SET NOCOUNT ON; END')
END
GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Paged_OutstandingSampleReports]    Script Date: 02/09/2019 09:36:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Paged_OutstandingSampleReports]
	-- Paging
    @PerPage INT = 100,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @GlobalFilter VARCHAR(MAX) = NULL,
    @JobID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    @LaboratoryID INT = 0,
    @SurveyTypeID INT = 0,
    @EmployeeID INT = 0,

	-- Order bys
    @OrderByJobNo INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderBySamplesDueDate INT = 0,
    @OrderByResultsAndSamples INT = 0,
    @OrderByResultsVerified INT = 0
/**********************************************************************
** Overview: Get the data for the Outstanding Sample Reports tab. Replaces the OutstandingSampleReports view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
	DECLARE @UseDefaultOrdering INT = 0

    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @GlobalFilter = NULLIF(LTRIM(RTRIM(@GlobalFilter)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByJobNo = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByClientOrderNo = 0 AND @OrderBySamplesDueDate = 0 AND @OrderByResultsAndSamples = 0 AND @OrderByResultsVerified = 0
    BEGIN
        SET @UseDefaultOrdering = 1
    END

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Set variables for logic.
    DECLARE @b__SampleDueDatesIncludeHolidays BIT, @b__showAllSamplesRegardlessOfBranch BIT, @b__OutstandingSampleReportsSwitchLabsNotManager BIT, @RequiredBranchOfficeID INT, @LabBranchOfficeID INT, @EmployeeIsManager BIT
    SELECT
        @b__SampleDueDatesIncludeHolidays = cfg.b__SampleDueDatesIncludeHolidays,
        @b__showAllSamplesRegardlessOfBranch = cfg.b__showAllSamplesRegardlessOfBranch,
        @b__OutstandingSampleReportsSwitchLabsNotManager = cfg.b__OutstandingSampleReportsSwitchLabsNotManager,
        @RequiredBranchOfficeID = COALESCE(e.BranchOfficeID, (SELECT BranchOfficeID FROM BranchOffice WITH (NOLOCK) WHERE [Default] = 1), -1),
        @LabBranchOfficeID = (SELECT BranchOfficeID FROM Laboratory WITH (NOLOCK) WHERE LaboratoryID = @LaboratoryID),
        @EmployeeIsManager = ISNULL(e.Manager, 0)
    FROM
        Config cfg WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT Manager, BranchOfficeID FROM Employee WITH (NOLOCK) WHERE EmployeeID = @EmployeeID
        ) e
    
    -- Get a list of required LaboratoryIDs for logic.
    DECLARE @RequiredLaboratoryIDs TABLE (LaboratoryID INT)
    INSERT INTO @RequiredLaboratoryIDs
    SELECT LaboratoryID FROM Laboratory WITH (NOLOCK) WHERE BranchOfficeID = @RequiredBranchOfficeID OR ServerCode IS NOT NULL
    
    
    -- Get all the Outstanding Sample Reports data - just the minimum ammount of data for speed.
	DECLARE @OutstandingSampleReportJobs TABLE (JobID INT, Created DATETIME, QuoteTypeID INT, ClientFull VARCHAR(MAX),[SiteAddress] VARCHAR(MAX), IsSurvey BIT, SurveyTypeID INT, SamplesDueDate DATETIME, SampleReportsDueInDays INT, AppDueDate DATETIME, [ProjectDueDate] DATETIME, [CalculatedDueDate] DATETIME)
	INSERT INTO @OutstandingSampleReportJobs (JobID, Created, QuoteTypeID, ClientFull, [SiteAddress], IsSurvey, SurveyTypeID, SamplesDueDate, SampleReportsDueInDays, AppDueDate, [ProjectDueDate], [CalculatedDueDate])
	SELECT
		b.JobID, b.Created, b.QuoteTypeID, b.ClientFull, b.[SiteAddress], b.IsSurvey, b.SurveyTypeID, b.SamplesDueDate, b.SampleReportsDueInDays, b.AppDueDate, b.[ProjectDueDate], b.CalculatedDueDate
	FROM
	(
		SELECT
			a.JobID, a.Created, a.QuoteTypeID, a.ClientFull, a.[SiteAddress], a.IsSurvey, a.SurveyTypeID, a.SamplesDueDate, a.SampleReportsDueInDays, a.AppDueDate, a.[ProjectDueDate], 
			ISNULL(
				a.SamplesDueDate, -- Use if present, as it's the main driver for the date.
				CASE WHEN ISNULL(a.QuoteTypeID,6) != 6 THEN -- For non-Sample jobs.
					CASE WHEN a.AppDueDate IS NOT NULL THEN
						dbo.fn_AddWorkingDays(CAST(ISNULL(a.SampleReportsDueInDays, 0) AS INT), a.RegisterFinish)
					END
				END
			) [CalculatedDueDate]
		FROM
		(
			SELECT
				j.JobID, j.Created,
				q.QuoteTypeID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [ClientFull],
				si.[Address] [SiteAddress],
				CASE WHEN a.AppointmentID IS NULL THEN 0 ELSE 1 END [IsSurvey],
				asu.SurveyTypeID,
				asu.SamplesDueDate,
				p.SampleReportsDueInDays,
				asu.DueDate [AppDueDate],
				p.DueDate [ProjectDueDate],
				r.RegisterFinish,
				ROW_NUMBER() OVER (PARTITION BY j.JobID Order By asu.DueDate ASC, r.RegisterFinish DESC) [Identifier]
			FROM
				Job j 
				INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = j.JobID
				INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
				INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
				LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
				LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
				LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.AppointmentTypeID != 8
				LEFT JOIN AppointmentSurvey asu WITH (NOLOCK) ON a.AppointmentID = asu.AppointmentID
			WHERE
				a.DateDeclined IS NULL
					AND
				j.Approved IS NULL
					AND
				(
                    CASE WHEN j.SampleResultEmployeeID IS NULL THEN
						1
					ELSE
						CASE WHEN j.SampleContentEmployeeID IS NULL THEN
							1
						ELSE
							0
						END
                    END = 1
				)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
				 AND
				(
					CASE WHEN @GlobalFilter IS NULL THEN
						1
					ELSE
						CASE WHEN
							j.ClientOrderNo LIKE '%' + @GlobalFilter + '%'
								OR
							si.Address Like '%' + @GlobalFilter + '%'
								Or
							si.Postcode Like '%' + @GlobalFilter + '%'
								Or
							si.Address + ', ' + si.Postcode Like '%' + @GlobalFilter + '%'
								Or 
							si.UPRN = @GlobalFilter
						THEN 1 ELSE 0 END
					END = 1
				)
					AND
				c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
		) a
		WHERE
			a.Identifier = 1
	) b
	WHERE
		(
			CASE WHEN b.[CalculatedDueDate] IS NULL THEN
				1
			ELSE
				CASE WHEN b.[CalculatedDueDate] BETWEEN @FilterStartDate AND @FilterFinishDate THEN
					1
				ELSE
					0
				END
			END = 1
		)
	    
    DECLARE @OutstandingSampleReportsData TABLE (IndexID INT IDENTITY(1,1), JobID INT, JobNo INT, ClientOrderNo VARCHAR(50), SampleResultEmployeeID INT, BranchOfficeID INT, ClientID INT, Client VARCHAR(210), ProjectID INT, ProjectAndGroup VARCHAR(MAX), SiteID INT, Address VARCHAR(200), IsSurvey BIT, SurveyTypeID INT, AppDueDate DATETIME, InSampleExchange BIT, Interval INT, LaboratoryID INT, ServerCode NVARCHAR(3), SamplesDueDate DATETIME, SamplesWithResultCount INT, CheckedInCount INT, TotalSamplesCount INT, CheckInNotes VARCHAR(MAX))
  
    
    INSERT INTO @OutstandingSampleReportsData
    SELECT
        s.JobID,
        s.JobNo,
        s.ClientOrderNo,
        s.SampleResultEmployeeID,
        s.BranchOfficeID,
        s.ClientID,
        s.Client,
        s.ProjectID,
		s.project,
        s.SiteID,
        s.Address,
        s.IsSurvey,
        s.SurveyTypeID,
        s.AppDueDate,
        s.InSampleExchange,
        s.Interval,
        s.LaboratoryID,
        s.ServerCode,
        s.SamplesDueDate,
        s.SamplesWithResultCount,
        s.CheckedInCount,
        s.TotalSamplesCount,
		s.CheckInNotes
    FROM
        (
            SELECT
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                j.SampleResultEmployeeID,
                j.BranchOfficeID,
                j.ClientID,
                osrj.ClientFull [Client],
                j.ProjectID,
				p.Project + ISNULL(' (' + p.GroupName + ')', '') [project],
                j.SiteID,
                osrj.[SiteAddress] [Address],
                osrj.IsSurvey,
                osrj.SurveyTypeID [SurveyTypeID],
                osrj.AppDueDate,
                CAST(ISNULL(MIN(s.SampleExchangeDateTransfered), 0) AS BIT) [InSampleExchange],
                st.Interval,
                l.LaboratoryID,
                l.ServerCode,
                ISNULL(
                    osrj.SamplesDueDate, -- Use if present, as it's the main driver for the date.
                    CASE WHEN osrj.QuoteTypeID != 6
                        THEN -- For non-Sample jobs.
                            CASE WHEN osrj.ProjectDueDate IS NULL -- Check if there is a Project due date.
                                THEN
                                    CASE WHEN st.Interval IS NULL -- No Project due date.
                                        THEN DATEADD(d, -2, osrj.AppDueDate) -- Take 2 days off the report due date.
                                        ELSE DATEADD(d, st.Interval, j.Created) -- Otherwise use the Job Created date as a basis.
                                    END
                                ELSE dbo.fn_AddWorkingDays(CAST(ISNULL(osrj.SampleReportsDueInDays, 0) AS INT), MAX(rd.LastRegisterFinish)) -- If a Project due date, add working days to the Register Finish.
                            END
                        ELSE -- For Sample jobs. Base off the Sample Turnaround Interval and Job Created.
                            CASE WHEN @b__SampleDueDatesIncludeHolidays = 1
                                THEN dbo.fn_AddWorkingDays(st.Interval, j.Created)
                                ELSE DATEADD(d, st.Interval, j.Created)
                            END
                    END) [SamplesDueDate],
                -- Both of the below cases divide by the number of Appointments to negate the effect of the join to the Appointment table.
                -- As joining to Appointment can sometimes cause duplicate rows, and we need an accurate count of Samples.
                COUNT(s.SampleResultID) [SamplesWithResultCount],
                COUNT(s.LaboratoryID) [CheckedInCount],
                COUNT(s.SampleID) [TotalSamplesCount],
				CASE
					WHEN l.ServerCode IS NOT NULL
					THEN CAST(COUNT(s.LaboratoryId) AS VARCHAR(MAX)) + ' sample(s) checked in to ' + CAST(l.Laboratory AS VARCHAR(MAX))
					ELSE NULL
				END [CheckInNotes]
            FROM
                @OutstandingSampleReportJobs osrj 
                INNER JOIN Job j WITH (NOLOCK) ON j.JobID=osrj.JobID
				LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
                OUTER APPLY
                (
                    SELECT MAX(_r.RegisterFinish) [LastRegisterFinish]
                    FROM
                        JobEmployee _je WITH (NOLOCK)
                        INNER JOIN Register _r WITH (NOLOCK) ON _je.JobEmployeeID = _r.JobEmployeeID
                    WHERE
                        _je.JobID = osrj.JobID
                ) rd -- Register Details
                INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = osrj.JobID
                INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
                INNER JOIN Room rm WITH (NOLOCK) ON rm.RegisterID = r.RegisterID
                INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
                LEFT JOIN SampleTurnaround st WITH (NOLOCK) ON s.SampleTurnaroundID = st.SampleTurnaroundID
                LEFT JOIN Laboratory l WITH (NOLOCK) ON s.LaboratoryID = l.LaboratoryID AND l.DateDeleted IS NULL
                
                
            WHERE -- NOTE: Parts of this WHERE clause are repeated in the main SELECT below.
                NULLIF(s.SampleRef, '') IS NOT NULL -- No Visuals.
                    AND
                s.AsSample = 0 -- No As Samples (these are not a physical Sample).
                    AND
                s.SampleRef NOT LIKE '%*%' -- No Samples that have been re-inspected (these were analysed before).
                    AND
                s.SampleRef NOT LIKE '%{%' -- Ignore Samples that were surveyed prior to TEAMS.
                    AND
                ( -- Not analysed/approved.
                    j.SampleResultEmployeeID IS NULL
	                    OR
                    j.SampleContentEmployeeID IS NULL
                )
            GROUP BY
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                j.SampleResultEmployeeID,
                j.BranchOfficeID,
                j.Created,
                j.ClientID,
                osrj.SurveyTypeID,
                osrj.IsSurvey,
                osrj.ClientFull,
                osrj.SamplesDueDate,
                osrj.AppDueDate,
                j.ProjectID,
				p.Project,
				p.GroupName,
                osrj.ProjectDueDate,
                osrj.SampleReportsDueInDays,
                j.SiteID,
                osrj.[SiteAddress],
                osrj.QuoteTypeID,
                l.LaboratoryID,
                l.ServerCode,
                st.Interval,
				l.Laboratory
        ) s
    WHERE
        (
            (
                s.SamplesDueDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (
                    CASE WHEN @b__showAllSamplesRegardlessOfBranch = 1 THEN 
						1
                    ELSE
						CASE WHEN
							( -- Employee is not a manager but show all for branch
								(@EmployeeIsManager = 0 AND @b__OutstandingSampleReportsSwitchLabsNotManager = 0)
									AND
								( -- Checked in to the required lab
									s.LaboratoryID IN (SELECT LaboratoryID FROM @RequiredLaboratoryIDs)
										OR
									( -- Not checked in but original job is for required labs branch
										s.LaboratoryID IS NULL
											AND
										s.BranchOfficeID = @RequiredBranchOfficeID
									)
								)
							)
								OR
							( -- Employee is a manager.
								(@EmployeeIsManager = 1 OR @b__OutstandingSampleReportsSwitchLabsNotManager = 1)
									AND
								(
									(  -- A lab filter wanted.
										@LaboratoryID > 0
											AND
										( -- Checked in to the required lab
											s.LaboratoryID = @LaboratoryID
												OR
											(s.LaboratoryID IS NULL AND s.BranchOfficeID = @LabBranchOfficeID)
										)
									)
										OR -- Show all labs checked in or not
									(
										@LaboratoryID = -1
											AND
										(s.LaboratoryId > 100)
									)
										OR
									@LaboratoryID = 0
								)
							)
						THEN 1 ELSE 0 END
                    END = 1
                )
            )
                OR
            @JobID > 0
        )
            AND
        (
            CASE WHEN @SurveyTypeID = 0 THEN 
				1 -- Everything
			ELSE
				CASE WHEN 
					(@SurveyTypeID = -2 AND s.IsSurvey = 1) -- Just Surveys
						OR
					(@SurveyTypeID = -1 AND s.IsSurvey = 0) -- Just Bulk Sample Reports
						OR
					(s.SurveyTypeID = @SurveyTypeID) -- A specific Survey Type
				THEN 1 ELSE 0 END
            END = 1
        )
			AND
		CASE
			WHEN s.LaboratoryId IS NULL THEN 1
			WHEN @LaboratoryID = -2 AND s.LaboratoryId > 100 THEN 1
			WHEN @LaboratoryID = s.LaboratoryId THEN 1
			WHEN @LaboratoryID = 0 OR @LaboratoryID	= -1 THEN 1
			ELSE 0
		END = 1
    ORDER BY
		CASE WHEN @UseDefaultOrdering = 1 THEN CASE WHEN IsNull(SampleResultEmployeeID,0) = 0 THEN 0 ELSE 1 END ELSE NULL END,
		CASE WHEN @UseDefaultOrdering = 1 THEN SamplesDueDate ELSE NULL END,
		CASE WHEN @UseDefaultOrdering = 1 THEN jobid ELSE NULL END,
        CASE WHEN @OrderByJobNo = 1 THEN CAST(s.JobNo AS INT) ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN CAST(s.JobNo AS INT) ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN s.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN s.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN s.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN s.Address ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN s.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN s.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderBySamplesDueDate = 1 THEN s.SamplesDueDate ELSE NULL END ASC,
        CASE WHEN @OrderBySamplesDueDate = 2 THEN s.SamplesDueDate ELSE NULL END DESC,
        CASE WHEN @OrderByResultsAndSamples = 1 THEN s.TotalSamplesCount ELSE NULL END ASC,
        CASE WHEN @OrderByResultsAndSamples = 2 THEN s.TotalSamplesCount ELSE NULL END DESC,
        CASE WHEN @OrderByResultsAndSamples = 1 THEN s.SamplesWithResultCount ELSE NULL END ASC,
        CASE WHEN @OrderByResultsAndSamples = 2 THEN s.SamplesWithResultCount ELSE NULL END DESC,
        CASE WHEN @OrderByResultsVerified = 1 THEN CASE WHEN ISNULL(s.SampleResultEmployeeID, -1) > 1 THEN 1 ELSE 0 END ELSE NULL END ASC,
        CASE WHEN @OrderByResultsVerified = 2 THEN CASE WHEN ISNULL(s.SampleResultEmployeeID, -1) > 1 THEN 1 ELSE 0 END ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @OutstandingSampleReportsData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((a.IndexID - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @OutstandingSampleReportsData
           ) a
    )    
    
    -- Start the main SELECT
    SELECT
        pag.IndexID [Row_Num],
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        pag.JobID,
        pag.JobNo,
        pag.ClientOrderNo,
        pag.SampleResultEmployeeID,
        j.Created,
        CAST(CASE WHEN j.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.BranchOfficeID,
        j.LastNoteCreated,
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN j.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN j.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        STUFF((
            SELECT DISTINCT ', ' + e.FullName
            FROM
                JobEmployee je WITH (NOLOCK)
                INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
            WHERE
                je.JobID = pag.JobID
        FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [Surveyors],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.JobID = pag.JobID
                    AND
                _pf.DateDeleted IS NULL
                    AND
                _pf.FileName LIKE '%bsr%'
            ORDER BY
                _pf.FileName DESC
        ) [FileName],
        (
            SELECT TOP 1 _pf.FileName
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.JobID = pag.JobID
                    AND
                _pf.DateDeleted IS NULL
                    AND
                _pf.FileName LIKE '%bsr%'
                    AND
                _pf.Uploaded = 1
            ORDER BY
                _pf.FileName DESC
        ) [UploadedFileName],
        (SELECT TOP 1 _ct.TemplateID FROM ClientTemplate _ct WITH (NOLOCK) WHERE _ct.ClientID = pag.ClientID AND _ct.TemplateTypeID = 14 ORDER BY _ct.Version DESC) [ClientTemplateID],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
		ISNULL(pag.ProjectAndGroup,'') [ProjectAndGroup],
        pag.SiteID,
        pag.Address,
        si.Postcode,
        si.UPRN,
        pag.IsSurvey,
        pag.SurveyTypeID,
        pag.AppDueDate [SurveyDueDate],
        pag.InSampleExchange,
        pag.Interval,
        pag.LaboratoryID,
        CAST(CASE WHEN pag.ServerCode IS NOT NULL THEN 1 ELSE 0 END AS BIT) [SampleExchangeLab],
        pag.SamplesDueDate,
        pag.SamplesWithResultCount,
        pag.CheckedInCount,
        pag.TotalSamplesCount,
		pag.CheckInNotes
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
        LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
    WHERE -- NOTE: Parts of this WHERE clause are repeated in the table variable INSERT above.
        (
            (pag.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
                OR
            (@PerPage = 0 AND @CurrentPage = 0)
        )
    GROUP BY
        pag.IndexID,
        pag.Page,
        pag.Pages,
        pag.JobID,
        pag.JobNo,
        pag.ClientOrderNo,
        pag.SampleResultEmployeeID,
        pag.AppDueDate,
        j.Created,
        pag.BranchOfficeID,
        j.LastNoteCreated,
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
		pag.ProjectAndGroup,
        pag.SiteID,
        pag.Address,
        si.Postcode,
        si.UPRN,
        pag.IsSurvey,
        pag.SurveyTypeID,
        pag.InSampleExchange,
        pag.Interval,
        pag.LaboratoryID,
        pag.ServerCode,
        pag.SamplesDueDate,
        pag.SamplesWithResultCount,
        pag.CheckedInCount,
        pag.TotalSamplesCount,
		pag.CheckInNotes
    ORDER BY
        pag.IndexID
    
    
    SET NOCOUNT OFF;
END

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'AirMonitoringReportResultsByRow') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[AirMonitoringReportResultsByRow] AS BEGIN SET NOCOUNT ON; END')
End
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[AirMonitoringReportResultsByRow]
      @AirTestID INT
AS
BEGIN

--    DECLARE @AirTestID INT = 8750

SET NOCOUNT ON

      DECLARE @AirTestTypeID INT = (Select AirTestTypeID FROM AirTest Where AirTestID=@AirTestID)  
      
-- Get all inspection data up front to reduce table scans on the element table
      DECLARE @at_Inspection TABLE (AirTestID INT, InspectionID INT, InspectionlabelID INT, InspectionChoiceID INT, InspectionInt INT, InspectionText VARCHAR(MAX))

      INSERT INTO @at_Inspection (AirTestID, InspectionID, InspectionlabelID, InspectionChoiceID, InspectionInt, InspectionText)
      SELECT
            i.AirTestID, i.InspectionID, i.InspectionlabelID, i.InspectionChoiceID, i.InspectionInt, i.InspectionText
      FROM Inspection i WHERE AirTestID = @AirTestID

-- Get all equipment data up front to reduce table scans on the element table
      DECLARE @at_EquipmentUsed TABLE (AirTestID INT, EquipmentCategoryID INT, RefNo VARCHAR(MAX), EquipmentUsedID INT, CalibrationInt INT, CalibrationText VARCHAR(MAX), CalibrationInformationDescription VARCHAR(MAX), EquipmentDescription VARCHAR(MAX), CalibrationDueDate DATETIME, IntervalCheck VARCHAR(MAX))

      INSERT INTO @at_EquipmentUsed (AirTestID, EquipmentCategoryID, RefNo, EquipmentUsedID, CalibrationInt, CalibrationText, CalibrationInformationDescription, EquipmentDescription, CalibrationDueDate, IntervalCheck)
      SELECT
            eu.AirTestID, ec.EquipmentCategoryID, e.RefNo, eu.EquipmentUsedID, ci.CalibrationInt, ci.CalibrationText, cit.Description, e.Description,
            CASE e.IntervalCheck WHEN 0 THEN DATEADD(year,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 1 THEN DATEADD(month,6,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 2 THEN DATEADD(month,3,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 3 THEN DATEADD(month,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 4 THEN DATEADD(day,1,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 5 THEN DATEADD(year,100,GETDATE()) WHEN 6 THEN DATEADD(year,2,ISNULL(cali.CalibrationDate,e.DatePurchased)) WHEN 7 THEN DATEADD(year,5,ISNULL(cali.CalibrationDate,e.DatePurchased)) ELSE e.DatePurchased END [CalibrationDueDate],
            eic.Description
      FROM  
            AirTest at
            INNER JOIN EquipmentUsed eu ON at.AirTestID = eu.AirTestID
            INNER JOIN Equipment e ON eu.EquipmentID = e.EquipmentID
            INNER JOIN EquipmentCategory ec ON ec.EquipmentCategoryID = e.EquipmentCategoryID
            LEFT OUTER JOIN EquipmentIntervalCheck eic ON eic.IntervalCheckID = e.IntervalCheck
            --LEFT OUTER JOIN Calibration cali ON cali.CalibrationID = eu.CalibrationID AND cali.NotInUse IS NULL AND cali.DateDeleted IS NULL
            OUTER APPLY
            (
                  Select top 1 c.CalibrationID, c.CalibrationDate FROM Calibration c Where c.EquipmentID = e.EquipmentID AND c.CalibrationDate<ISNULL(at.AirTestFinish,GETDATE()) AND c.NotInUse IS NULL AND c.DateDeleted IS NULL Order by c.CalibrationDate DESC
            ) cali
            LEFT OUTER JOIN CalibrationInformation ci ON ci.CalibrationID = cali.CalibrationID
            LEFT OUTER JOIN CalibrationInformationType cit ON cit.CalibrationInformationTypeID = ci.CalibrationInformationTypeID
      WHERE eu.AirTestID = @AirTestID
            

-- Get all element data up front to reduce table scans on the element table
      DECLARE @ElementData TABLE (ElementID INT, AirTestID INT, AirSampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT)

      INSERT INTO @ElementData (ElementID, AirTestID, AirSampleID, ElementTypeID, ElementText, ElementIntID)
      SELECT
            u.ElementID, u.AirTestID, u.AirSampleID, u.ElementTypeID, u.ElementText, u.ElementIntID
      FROM
            (Select e.ElementID, e.AirTestID, e.AirSampleID, e.ElementTypeID, e.ElementText, e.ElementIntID FROM Element e WITH (NOLOCK) Where e.AirTestID=@AirTestID UNION Select e.ElementID, e.AirTestID, e.AirSampleID, e.ElementTypeID, e.ElementText, e.ElementIntID FROM AirSample airs INNER JOIN Element e WITH (NOLOCK) ON e.AirSampleID = airs.AirSampleID Where airs.AirTestID=@AirTestID) u
           
      DECLARE @PlanVolume VARCHAR(MAX) = (Select ElementText FROM @ElementData Where AirTestID=@AirTestID AND ElementTypeID=131)
      IF LEN(@PlanVolume) > 0 BEGIN
    IF @PlanVolume LIKE '%<%' OR @PlanVolume LIKE '%>%' BEGIN
      SET @PlanVolume = REPLACE(REPLACE(@PlanVolume,'<',''),'>','')
      SET @PlanVolume = CAST((CAST(@PlanVolume as DECIMAL(10,2))-0.01) as varchar)
    END
      END
      DECLARE @PlanArea VARCHAR(MAX) = (Select ElementText FROM @ElementData Where AirTestID=@AirTestID AND ElementTypeID=130)
      IF LEN(@PlanArea) > 0 BEGIN
    IF @PlanArea LIKE '%<%' OR @PlanArea LIKE '%>%' BEGIN
      SET @PlanArea = REPLACE(REPLACE(@PlanArea,'<',''),'>','')
      SET @PlanArea = CAST((CAST(@PlanArea as DECIMAL(10,2))-0.01) as varchar)
    END
      END

      If LEN(IsNull(@PlanVolume,'')) = 0 AND LEN(IsNull(@PlanArea,'')) = 0 AND (Select COUNT(*) FROM MobileConfig Where MobileConfigTypeID IN (94,95)) > 0 BEGIN
-- Now check for the dcu area or volume
    SET @PlanArea = (SELECT ISNULL(CAST(CAST((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigInt=i.InspectionLabelID AND mc.MobileConfigTypeID=94 WHERE a.AirTestID=@AirTestID)  as DECIMAL(10,2)) - CASE WHEN IsNull((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigText=i.InspectionLabelID AND mc.MobileConfigTypeID=94 WHERE a.AirTestID=@AirTestID),'')='<' THEN 0.01 ELSE 0.00 END as VARCHAR),''))
    SET @PlanVolume = (SELECT ISNULL(CAST(CAST((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigInt=i.InspectionLabelID AND mc.MobileConfigTypeID=95 WHERE a.AirTestID=@AirTestID)  as DECIMAL(10,2)) - CASE WHEN IsNull((SELECT i.InspectionText FROM Inspection i INNER JOIN AirTest a ON i.AirTestID=a.AirTestID INNER JOIN MobileConfig mc ON mc.MobileConfigText=i.InspectionLabelID AND mc.MobileConfigTypeID=95 WHERE a.AirTestID=@AirTestID),'')='<' THEN 0.01 ELSE 0.00 END as VARCHAR),''))
      END
      
      DECLARE @EstimatedMeasurementsRequired VARCHAR(MAX) = 
      IsNull(CAST((
      Select
        CASE WHEN LEN(@PlanVolume) > 0 THEN
          --Volume as the basis
          Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 10.00 THEN 
            '1'
          ELSE
            Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 150.00 THEN 
              '2'
            ELSE
              Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 300.00 THEN 
                '3'
              ELSE
                Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 600.00 THEN 
                  '4'
                ELSE
                  Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 1500.00 THEN 
                    '6'
                  ELSE
                    Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 3000.00 THEN 
                      '9'
                    ELSE
                      Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 15000.00 THEN 
                        '16'
                      ELSE
                        Case WHEN CAST(@PlanVolume as DECIMAL(10,2)) <= 30000.00 THEN 
                          '20'
                        END
                      END
                    END
                  END
                END
              END
            END
          END
        ELSE
          CASE WHEN LEN(@PlanArea) > 0 THEN
            Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 50.00 THEN 
              '2'
            ELSE
              Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 100.00 THEN 
                '3'
              ELSE
                Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 200.00 THEN 
                  '4'
                ELSE
                  Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 500.00 THEN 
                    '6'
                  ELSE
                    Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 1000.00 THEN 
                      '9'
                    ELSE
                      Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 5000.00 THEN 
                        '16'
                      ELSE
                        Case WHEN CAST(@PlanArea as DECIMAL(10,2)) <= 10000.00 THEN 
                          '20'
                        END
                      END
                    END
                  END
                END
              END
            END
          END
        END
      ) as varchar(MAX)),'N/A')
      
-- Get all Air Sample data up front
      DECLARE @AirSampleData TABLE (RowNo INT, PhotoID INT,AirSampleID INT, AirTestID INT, SampleRef VARCHAR(MAX), PumpNo INT, AirSampleItemNo INT, Location VARCHAR(MAX), SubSampleItemNo INT,FieldBlank INT,SPStart VARCHAR(MAX), SPFinish VARCHAR(MAX), MinsRunning INT, FRStart VARCHAR(MAX), FRFinish VARCHAR(MAX), FlowRate DECIMAL(8,4), Volume DECIMAL(12,4), DirtySlide VARCHAR(MAX), Graticule VARCHAR(MAX), Fibres VARCHAR(MAX), RRMeasurement VARCHAR(MAX), ReportedResult VARCHAR(MAX), AirSampleTestType VARCHAR(MAX), ePumpNo VARCHAR(MAX), FilterHead VARCHAR(MAX), AirSampleTemp VARCHAR(MAX), AirSampleDurationOfBrushingStart VARCHAR(MAX), AirSampleDurationOfBrushingFinish VARCHAR(MAX), FRIntermediate VARCHAR(MAX), SPIntermediate VARCHAR(MAX), OverrideVolume BIT, OverrideLoQCalculation INT, OverrideLoQText VARCHAR(25))

      INSERT INTO @AirSampleData 
            (
                  RowNo,PhotoID,AirSampleID, AirTestID, SampleRef, PumpNo, AirSampleItemNo, Location, SubSampleItemNo,FieldBlank,
                  SPStart, SPFinish, MinsRunning, FRStart, FRFinish, FlowRate, Volume,
                  DirtySlide, Graticule, Fibres, RRMeasurement, ReportedResult, AirSampleTestType, ePumpNo, 
                  FilterHead, AirSampleTemp, AirSampleDurationOfBrushingStart, AirSampleDurationOfBrushingFinish, FRIntermediate, SPIntermediate,
                  OverrideVolume, OverrideLoQCalculation, OverrideLoQText
            )
      SELECT
            ROW_NUMBER() OVER (Order By airs.AirSampleItemNo, airs.SubSampleItemNo), p.PhotoID, 
           airs.AirSampleID, airs.AirTestID, airs.SampleRef, null, airs.AirSampleItemNo, airs.Location, airs.SubSampleItemNo, airs.FieldBlank,
            as_e101.ElementText, as_e102.ElementText, aiS_SPFR.MinsRunning, as_e103.ElementText, as_e104.ElementText, aiS_SPFR.FlowRate, aiS_Volume.Volume,
            as_e109.ElementText, as_e108.ElementText, as_e105.ElementText, as_e106.ElementText, as_e107.ElementText, as_e121.ElementText, as_e135.ElementText, 
            as_e136.ElementText, as_e110.ElementText, as_e137.ElementText, as_e138.ElementText, as_e100.ElementText, as_e99.ElementText,
            CASE WHEN  as_e103.ElementText = '0.0' OR as_e103.ElementText = '0'  OR as_e104.ElementText = '0.0' OR as_e104.ElementText = '0'  THEN
				1
			ELSE
				0
			END,
			CASE WHEN as_e122.ElementText = '1' THEN 1 ELSE 0 END,
			NULLIF(as_e123.ElementText,'')
      FROM
            AirSample airs
            LEFT OUTER JOIN Photo p ON p.PhotoID=airs.PhotoID AND p.PhotoData IS NOT NULL
            LEFT OUTER JOIN @ElementData as_e99 ON as_e99.AirSampleID=airs.AirSampleID AND as_e99.ElementTypeID = 99
            LEFT OUTER JOIN @ElementData as_e100 ON as_e100.AirSampleID=airs.AirSampleID AND as_e100.ElementTypeID = 100
            LEFT OUTER JOIN @ElementData as_e101 ON as_e101.AirSampleID=airs.AirSampleID AND as_e101.ElementTypeID = 101
            LEFT OUTER JOIN @ElementData as_e102 ON as_e102.AirSampleID=airs.AirSampleID AND as_e102.ElementTypeID = 102
            LEFT OUTER JOIN @ElementData as_e103 ON as_e103.AirSampleID=airs.AirSampleID AND as_e103.ElementTypeID = 103
            LEFT OUTER JOIN @ElementData as_e104 ON as_e104.AirSampleID=airs.AirSampleID AND as_e104.ElementTypeID = 104
            LEFT OUTER JOIN @ElementData as_e105 ON as_e105.AirSampleID=airs.AirSampleID AND as_e105.ElementTypeID = 105
            LEFT OUTER JOIN @ElementData as_e106 ON as_e106.AirSampleID=airs.AirSampleID AND as_e106.ElementTypeID = 106
            LEFT OUTER JOIN @ElementData as_e107 ON as_e107.AirSampleID=airs.AirSampleID AND as_e107.ElementTypeID = 107
            LEFT OUTER JOIN @ElementData as_e108 ON as_e108.AirSampleID=airs.AirSampleID AND as_e108.ElementTypeID = 108
            LEFT OUTER JOIN @ElementData as_e109 ON as_e109.AirSampleID=airs.AirSampleID AND as_e109.ElementTypeID = 109
            LEFT OUTER JOIN @ElementData as_e110 ON as_e110.AirSampleID=airs.AirSampleID AND as_e110.ElementTypeID = 110
            LEFT OUTER JOIN @ElementData as_e121 ON as_e121.AirSampleID=airs.AirSampleID AND as_e121.ElementTypeID = 121
			LEFT OUTER JOIN @ElementData as_e122 ON as_e122.AirSampleID=airs.AirSampleID AND as_e122.ElementTypeID = 122
			LEFT OUTER JOIN @ElementData as_e123 ON as_e123.AirSampleID=airs.AirSampleID AND as_e123.ElementTypeID = 123
            
            LEFT OUTER JOIN @ElementData as_e135 ON as_e135.AirSampleID=airs.AirSampleID AND as_e135.ElementTypeID = 135
            LEFT OUTER JOIN @ElementData as_e136 ON as_e136.AirSampleID=airs.AirSampleID AND as_e136.ElementTypeID = 136
            LEFT OUTER JOIN @ElementData as_e137 ON as_e137.AirSampleID=airs.AirSampleID AND as_e137.ElementTypeID = 137
            LEFT OUTER JOIN @ElementData as_e138 ON as_e138.AirSampleID=airs.AirSampleID AND as_e138.ElementTypeID = 138
            OUTER APPLY
            (
                  Select
                        Convert(decimal(8,4), (Convert(decimal(12,2), Convert(varchar, as_e103.ElementText)) + Convert(decimal(12,2), Convert(varchar, as_e104.ElementText))) / 2) [FlowRate],
                        Case When DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) > 0 Then DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) Else DateDiff(minute, Convert(datetime, Convert(varchar, as_e101.ElementText)), Convert(datetime, Convert(varchar, as_e102.ElementText))) + 1440 End [MinsRunning]
            ) aiS_SPFR
            OUTER APPLY
            (
                  Select convert(decimal(12,2),aiS_SPFR.MinsRunning) * convert(decimal(12,3),aiS_SPFR.FlowRate) [Volume]
            ) aiS_Volume
      Where 
    airs.AirTestID = @AirTestID

SELECT


-- Air Sample Photo bits
    airs.RowNo,
    CASE WHEN airs.RowNo % 2 = 0 THEN
    '#FFFFFF'
    ELSE
    '#D9D9D9'
    END [RowColour],
  airs.RowNo % 2 [OddRow],
CASE WHEN airs.RowNo % 2 = 1 THEN
'<td class="BorderL BorderT BorderB Bold Font6" rowspan=2 style="width:140">'
+
CASE WHEN airs.PhotoID IS NOT NULL THEN 
  '[AIRSAMPLEPHOTOIMGTAG:' + CAST(airs.PhotoID as VARCHAR) + ']'
Else '&nbsp;' END
+
'</td>'
+
'<td class="BorderL BorderT BorderB BorderR Bold Font6" rowspan=2 style="width:140">' +
CASE WHEN (Select PhotoID FROM @AirSampleData Where RowNo=airs.RowNo+1) IS NOT NULL THEN 
  '[AIRSAMPLEPHOTOIMGTAG:' + CAST((Select PhotoID FROM @AirSampleData Where RowNo=airs.RowNo+1) as VARCHAR) + ']'
Else '&nbsp;' END + '</td>'
END [AIRSAMPLEPHOTODOUBLEROW],
-- Bits just for the headerFooterSQL first
      Case at.AirTestTypeID When 2 Then 'RESULTS3' ELSE 'RESULTS' END [AIRMONRESULTREPLACE],
      Case at.AirTestTypeID When 2 Then 'STAGE 3 - ' Else '' End [STAGE3],    
      Case at.AirTestTypeID When 2 Then 'inherit' Else 'none' End [IncludeDurationOfBrushing],
      att.[Description] [AirTestType],
      DateDiff(Minute, at.AirTestStart, at.AirTestFinish) [AirTestDuration],    
      CASE WHEN euVehicle.RefNo IS NULL THEN
      IsNull(e116.ElementText, '&nbsp;') 
    ELSE
      'Mobile Lab'
    END [ANALYSISLOCATIONORMOBILELAB],
      CASE WHEN euVehicle.RefNo IS NULL THEN
      'N/A'
    ELSE
      IsNull(e116.ElementText, '&nbsp;') 
    END [ANALYSISLOCATIONONLYVEHICLE],
      IsNull(e116.ElementText, '&nbsp;') [AnalysisLocation],    
      IsNull(e113.ElementText, '&nbsp;') [SitePressure],
      IsNull(e112.ElementText, '&nbsp;') [SiteTemp],   
      Case Convert(varchar, e113.ElementText) When 'N/A' Then '' Else 'mb' End [SitePressuremb], 
      Case Convert(varchar, e112.ElementText) When 'N/A' Then '' When '' Then '' Else ' K' End [SiteTempK],   
      Case Convert(varchar, e112.ElementText) When 'N/A' Then '' When '' Then '' Else '<sup>o</sup>C' End [SiteTempC],   
      IsNull(e117.ElementText, '&nbsp;') [ExposedFilter],
      IsNull(eu.TallyCounter, '&nbsp;') [TallyCounter],
      IsNull(eu.AdditionalTallyCounter, '&nbsp;') [AdditionalTallyCounter],
      IsNull(eu.FlowmeterHi, '&nbsp;') [FlowmeterReference], 
      IsNull(e114.ElementText, '&nbsp;') [Flowmeter], 
      IsNull(eu.FlowmeterHi, '&nbsp;') [FlowmeterHi],  
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterHiTemperature],
      IsNull(Convert(varchar,eu.FlowmeterHiTemperature), 'N/A') [FlowmeterHiTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterHiTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterHiPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterHiPressure],
      IsNull(eu.FlowmeterMed, '&nbsp;') [FlowmeterMed],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterMedTemperature],
      IsNull(Convert(varchar,eu.FlowmeterMedTemperature), 'N/A') [FlowmeterMedTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterMedTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterMedPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterMedPressure],
      IsNull(eu.FlowmeterLow, '&nbsp;') [FlowmeterLow],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' End [FlowmeterLowTemperature],
      IsNull(Convert(varchar,eu.FlowmeterLowTemperature), 'N/A') [FlowmeterLowTemperatureNo],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + ' K', 'N/A') ELSE 'N/A' End [FlowmeterLowTemperatureK],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then IsNull(Convert(varchar,eu.FlowmeterLowPressure) + 'mb', 'N/A') ELSE 'N/A' End [FlowmeterLowPressure],
      CASE WHEN eu.FlowmeterHi IS NOT NULL OR eu.FlowmeterMed IS NOT NULL OR eu.FlowmeterLow IS NOT NULL THEN
            LEFT(ISNULL(eu.FlowmeterHi + '/','') + ISNULL(eu.FlowmeterMed + '/','') + ISNULL(eu.FlowmeterLow + '/',''),LEN(ISNULL(eu.FlowmeterHi + '/','') + ISNULL(eu.FlowmeterMed + '/','') + ISNULL(eu.FlowmeterLow + '/',''))-1)
      ELSE 'N/A' END [FlowmeterAll],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN eu.FlowmeterHi ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN eu.FlowmeterMed ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN eu.FlowmeterLow ELSE 'N/A' END END  END 
      --ELSE 'N/A' End 
      [FlowmeterCoalesce],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + '<sup>o</sup>C', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + '<sup>o</sup>C', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + '<sup>o</sup>C', 'N/A') ELSE 'N/A' END END END 
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperature],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature), 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature), 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature), 'N/A') ELSE 'N/A' END END  END  
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperatureNo],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiTemperature) + ' K', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedTemperature) + ' K', 'N/A') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowTemperature) + ' K', 'N/A') ELSE 'N/A' END END END 
      --Else 'N/A' End 
      [FlowmeterCoalesceTemperatureK],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiPressure) + 'mb', 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedPressure) + 'mb', 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowPressure) + 'mb', 'N/A')  ELSE 'N/A' END END END 
      --ELSE 'N/A' End 
      [FlowmeterCoalescePressure],
      CASE WHEN NOT eu.FlowmeterHi IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterHiPressure), 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterMedPressure), 'N/A')  ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN IsNull(Convert(varchar,eu.FlowmeterLowPressure), 'N/A')  ELSE 'N/A' END END END 
      --ELSE 'N/A' End 
      [FlowmeterCoalescePressureNo],
      IsNull(eu.ThermometerReference, '&nbsp;') [ThermometerReference],
        IsNull(eu.BarometerReference, '&nbsp;') [BarometerReference],
      IsNull(eu.TimerReference, '&nbsp;') [TimerReference],
      IsNull(eu.MicrometerReference, '&nbsp;') [MicrometerReference],
      IsNull(CAST(eu.MicrometerResult as varchar), '&nbsp;') [MicrometerResult],
      IsNull(e118.ElementText, '&nbsp;') [WaltonBeckett],
      IsNull(e115.ElementText, '&nbsp;') [SlidesStored],
      IsNull(e119.ElementText, '&nbsp;') [FifthLine],
      IsNull(eu.MicroscopeReference, '&nbsp;') [MicroscopeReference],
      IsNull(CAST(eu.MicroscopeResult as varchar), '&nbsp;') [MicroscopeResult],
      IsNull(eu.TestSlideReference, '&nbsp;') [TestSlideReference],
      IsNull(CAST(eu.TestSlideResult as varchar), '&nbsp;') [TestSlideResult],
      IsNull(eu.SlideBox, '&nbsp;') [SlideBox],
      IsNull(eu.FilterBox, '&nbsp;') [FilterBox],
      IsNull(CAST(eu.FilterBoxResult as varchar), '&nbsp;') [FilterBoxResult],
      ISNULL(cast(Convert(Date, eu.FilterBoxChecked) as varchar), '&nbsp;') [FilterBoxChecked],     
      IsNull(eu.PhaseTelescope, '&nbsp;') [PhaseTelescope],
      IsNull(CAST(eu.PhaseTelescopeResult as varchar), '&nbsp;') [PhaseTelescopeResult], 
      ISNULL(cast(Convert(Date, eu.PhaseTelescopeChecked) as varchar), '&nbsp;') [PhaseTelescopeChecked], 
      (Select STUFF((Select DISTINCT ',' + ' ' + subEU.EquipmentDescription FROM @at_EquipmentUsed subEU Where AirTestID=at.AirTestID FOR XML PATH ('')) , 1, 1, '')) [EQUIPMENTDESCRIPTIONGROUP],
      insp.FibreAnalyst [FibreAnalyst], 
      IsNull(emp.FullName,'&nbsp;') [Staff],
      e131.ElementText [EnclosureVolume],
      (Select SUM(CONVERT(decimal(12,2),convert(varchar,e111.ElementText))) From @ElementData e111 Where e111.ElementTypeID = 111 AND e111.ElementText<>'N/A' And e111.AirTestID =  at.AirTestID) [DurationOfBrushingTotal],

-- Bits for the rowSQL
      Case When airs.SubSampleItemNo IS NOT NULL Then  Convert(varchar,airs.AirSampleItemNo) + '.' + Convert(varchar,airs.SubSampleItemNo)  Else  IsNull(CAST(airs.AirSampleItemNo as varchar),'') End [AirSampleItemNo],
      IsNull(Convert(varchar(MAX),airs.Location), 'N/A') [Location],
      CASE WHEN airs.FieldBlank > 0 OR PooledSamples.Count IS NULL THEN 'Field Blank' ELSE '&nbsp;' END [FieldBlank],
      CASE WHEN airs.FieldBlank > 0 THEN 'FB' ELSE IsNull(airs.AirSampleTestType,'&nbsp;') END [FieldBlankOrTestType],
      IsNull(Convert(varchar(100),airs.SampleRef), 'N/A') [SampleRef],
      IsNull(Convert(varchar(100),airs.ePumpNo), 'N/A') [PumpNo],
      IsNull(Convert(varchar(100),airs.FilterHead), 'N/A') [FilterHead],
      IsNull(Convert(varchar(100),airs.AirSampleTemp), 'N/A') [Temp],
      IsNull(Convert(varchar(100),e113.ElementText), 'N/A') [Pressure],
      Case When airs.AirSampleDurationOfBrushingStart IS NULL AND airs.AirSampleDurationOfBrushingFinish IS NULL THEN 
            Case WHEN NULLIF(airs.FieldBlank,0) IS NULL THEN 
                  IsNull(Convert(varchar(100),e111.ElementText), 'N/A') 
            ELSE 
                  'N/A' 
            END
      ELSE 
            Convert(varchar(100),airs.AirSampleDurationOfBrushingStart) + '&nbsp;&nbsp;' + Convert(varchar(100),airs.AirSampleDurationOfBrushingFinish) 
      END [DurationOfBrushing],
      Case When NULLIF(airs.SubSampleItemNo,1) IS NULL Then 'inherit' Else 'none' END      [DurationOfBrushingDisplay],
      CASE WHEN NULLIF(PooledSamples.OverrideLoQText,'') IS NOT NULL THEN PooledSamples.OverrideLoQText ELSE CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.01' ELSE CONVERT(varchar,CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) END END [DetectionLimit],
      CASE WHEN NULLIF(PooledSamples.OverrideLoQText,'') IS NOT NULL THEN PooledSamples.OverrideLoQText ELSE CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.01' ELSE CONVERT(varchar,CONVERT(DECIMAL(12,2), PooledSamples.QuantificationLevel)) END END [DetectionLimit2D],
      CASE WHEN NULLIF(PooledSamples.OverrideLoQText,'') IS NOT NULL THEN PooledSamples.OverrideLoQText ELSE CASE WHEN PooledSamples.QuantificationLevel = 0.01 THEN '0.010' ELSE CASE WHEN CONVERT(varchar,CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) = '0.000' THEN 'N/A' ELSE CONVERT(varchar, CONVERT(DECIMAL(12,3), PooledSamples.QuantificationLevel)) END END END [DetectionLimit3DOverride],
      Isnull(Convert(varchar(100),airs.SPStart), 'N/A') [SPStart],
      Isnull(Convert(varchar(100),airs.SPFinish), 'N/A') [SPFinish],
      Isnull(airs.SPIntermediate, 'N/A') [SPIntermediate],
      IsNull(CAST(airs.MinsRunning as varchar),'N/A') [MinsRunning],
      Isnull(convert(varchar,convert(decimal(12,1),round(convert(varchar,airs.FRStart),1))), 'N/A') [FRStart],
      Isnull(convert(varchar,convert(decimal(12,1),round(convert(varchar,airs.FRFinish),1))), 'N/A') [FRFinish],
      Isnull(convert(varchar,convert(decimal(12,2),round(convert(varchar,airs.FRStart),2))), 'N/A') [FRStart2D],
      Isnull(convert(varchar,convert(decimal(12,2),round(convert(varchar,airs.FRFinish),2))), 'N/A') [FRFinish2D],
      IsNull(airs.FRIntermediate, 'N/A') [FRIntermediate],
      Isnull(convert(varchar,(Convert(decimal(12,1),Round(airs.FlowRate, 2)))), 'N/A') [FlowRate],
      Isnull(convert(varchar,(Convert(decimal(12,2),Round(airs.FlowRate, 2)))), 'N/A') [FlowRate2D],
      CASE WHEN (airs.FRStart = airs.FRFinish) OR PooledSamples.[Count] IS NULL OR airs.FieldBlank > 0 THEN '-' ELSE Isnull(convert(varchar,(Convert(decimal(12,1),Round(airs.Flowrate, 2)))), 'N/A') END [FlowRateOnlyDiff],
      CASE WHEN (airs.FRStart = airs.FRFinish) OR PooledSamples.[Count] IS NULL OR airs.FieldBlank > 0 THEN '-' ELSE Isnull(convert(varchar,(Convert(decimal(12,2),Round(airs.Flowrate, 2)))), 'N/A') END [FlowRateOnlyDiff2D],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
    convert(varchar,CAST(airs.Volume as DECIMAL(10,0)))
    END, 'N/A') [Volume],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
        convert(varchar,CAST(PooledSamples.PooledVolume as DECIMAL(10,0)))
      END, 'N/A') [PooledVolume],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
    convert(varchar,CAST(airs.Volume as DECIMAL(10,1)))
    END, 'N/A') [Volume1DP],
      IsNull(CASE WHEN airs.OverrideVolume = 0 THEN
        convert(varchar,CAST(PooledSamples.PooledVolume as DECIMAL(10,1)))
      END, 'N/A') [PooledVolume1DP],
      IsNull(airs.DirtySlide, '&nbsp;') [DirtySlide],
      Case WHEN NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide IS NOT Null THEN Case When NULLIF(airs.SubSampleItemNo,1) IS NULL Then 'inherit' Else 'none' End ELSE 'none' END [DirtySlideDisplay],
      Case When airs.DirtySlide Is Null Then 'inherit' Else 'none' End [GraticuleDisplay],
      Case When airs.DirtySlide Is Null Then 'inherit' Else 'none' End [FibresDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' End Else 'none' End [ConcentrationDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' END Else 'none' End [ReportedResultDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then Case When NULLIF(airs.SubSampleItemNo,1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' END Else 'none' End [DetectionLimitDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [FieldBlankDisplay],
      Case When NULLIF(NULLIF(airs.FieldBlank,0),1) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [PassedFieldBlankDisplay],
    Case When NULLIF(NULLIF(airs.FieldBlank,0),2) IS NULL AND PooledSamples.Count IS NOT NULL Then 'none' Else 'inherit' End [FailedFieldBlankDisplay],
      Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 'inherit' Else 'none' End [InvertFieldBlankDisplay],
      PooledSamples.[Count] * att.AirMonitoringRowAdjustment 'ROWSDEPENDANCY',
    Case When airs.SubSampleItemNo IS NULL AND PooledSamples.Count IS NOT NULL Then 2 ELSE 1 END 'COLPOOLEDDEPENDANCY',
    Case When airs.SubSampleItemNo = 1 AND PooledSamples.Count IS NOT NULL Then 'block' ELSE 'none' END 'COLPOOLEDDEPENDANCYDISPLAY',
      IsNull(airs.Graticule, '&nbsp;') [Graticule],
      Isnull(airs.Fibres, '&nbsp;') [Fibres],
      Isnull(convert(varchar,CAST(PooledSamples.PooledFibres as float)), '&nbsp;') [PooledFibres],
      Isnull(CASE WHEN ISNUMERIC(airs.Fibres)=1 AND airs.Fibres NOT LIKE '%.%' THEN airs.Fibres + '.0' ELSE airs.Fibres END, '&nbsp;') [Fibres1D],
      Isnull(CASE WHEN ISNUMERIC(convert(varchar,CAST(PooledSamples.PooledFibres as float)))=1 AND airs.Fibres NOT LIKE '%.%' THEN convert(varchar,CAST(PooledSamples.PooledFibres as float)) + '.0' ELSE convert(varchar,CAST(PooledSamples.PooledFibres as float)) END, '&nbsp;') [PooledFibres1D],
      Isnull(convert(varchar,LEFT(cast(PooledSamples.ResultConcentration as varchar),6)), 'N/A') [Concentration],
      Isnull(CASE WHEN NULLIF(PooledSamples.ResultConcentration,'N/A') IS NOT NULL THEN CAST(CAST(ROUND(PooledSamples.ResultConcentration,3) as DECIMAL(12,3)) as varchar) END, 'N/A') [Concentration3DP],
      IsNull(airs.RRMeasurement, '&nbsp;') [RRMeasurement],
      IsNull(airs.ReportedResult, '&nbsp;') [ReportedResult],
      CASE WHEN eu.FullFaceEquipmentUsedID IS NOT NULL AND eu.HalfMaskEquipmentUsedID IS NOT NULL THEN 'Half Mask and Full Face' WHEN eu.FullFaceEquipmentUsedID IS NOT NULL THEN 'Full Face' WHEN eu.HalfMaskEquipmentUsedID IS NOT NULL THEN 'Half Mask' ELSE '&nbsp;' END [RespiratorType],
      ISNULL(eu.AcetoneVaporiser, '&nbsp;') [AcetoneVaporiser],
      ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') [FlowMeterCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') [FlowMeterHiCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterMedCalibration) as varchar), '&nbsp;') [FlowMeterMedCalibration],
      ISNULL(cast(Convert(Date, eu.FlowmeterLowCalibration) as varchar), '&nbsp;') [FlowMeterLowCalibration],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
            CASE WHEN NOT eu.FlowmeterHi IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterHiCalibration) as varchar), '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterMedCalibration) as varchar), '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN ISNULL(cast(Convert(Date, eu.FlowmeterLowCalibration) as varchar), '&nbsp;') ELSE 'N/A' END END  END 
      --ELSE 'N/A' End 
      [FlowmeterCoalesceCalibration],
      ISNULL(eu.FlowMeterHiInterval, '&nbsp;') [FlowMeterInterval],
      ISNULL(eu.FlowMeterHiInterval, '&nbsp;') [FlowMeterHiInterval],
      ISNULL(eu.FlowMeterLowInterval, '&nbsp;') [FlowMeterMedInterval],
      ISNULL(eu.FlowMeterMedInterval, '&nbsp;') [FlowMeterLowInterval],
      --Case When NULLIF(airs.FieldBlank,0) IS NULL AND PooledSamples.Count IS NOT NULL Then 
    CASE WHEN NOT eu.FlowmeterHi IS NULL THEN ISNULL(eu.FlowMeterHiInterval, '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterMed IS NULL THEN ISNULL(eu.FlowMeterMedInterval, '&nbsp;') ELSE CASE WHEN NOT eu.FlowmeterLow IS NULL THEN ISNULL(eu.FlowMeterLowInterval, '&nbsp;') ELSE '&nbsp;' END END  END 
    --ELSE '&nbsp;' End 
    [FlowMeterCoalesceInterval],
      ISNULL(eu.MicrometerInterval, '&nbsp;') [MicrometerInterval],
      ISNULL(cast(Convert(Date, eu.ThermometerCalibration) as varchar), '&nbsp;') [ThermometerCalibration],
      ISNULL(cast(Convert(Date, TimerCalibration) as varchar), '&nbsp;') [TimerCalibration],
      ISNULL(cast(Convert(Date, eu.AcetoneVaporiserCalibration) as varchar), '&nbsp;') [AcetoneVaporiserCalibration],   
      ISNULL(cast(Convert(Date, eu.MicroscopeCalibration) as varchar), '&nbsp;') [MicroscopeCalibration],
    ISNULL(cast(Convert(Date, eu.MicrometerCalibration) as varchar), '&nbsp;') [MicrometerCalibration],
    ISNULL(cast(Convert(Date, eu.TestSlideCalibration) as varchar), '&nbsp;') [TestSlideCalibration],
    ISNULL(cast(Convert(Date, eu.TallyCounterCalibration) as varchar), '&nbsp;') [TallyCounterCalibration],
    ISNULL(cast(Convert(Date, eu.AdditionalTallyCounterCalibration) as varchar), '&nbsp;') [AdditionalTallyCounterCalibration],
    IsNull(airs.AirSampleTestType,'&nbsp;') [TestType],
    at.SystemName + RIGHT('00' + CONVERT(VARCHAR, at.AirTestNo), 2) [AirTestRef],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'YES' ELSE 'NO' END [wereFieldBlanksTaken],
    CASE WHEN AirSampleCount.FieldBlankFailedCount > 0 THEN 'YES' ELSE 'NO' END [wereFieldBlanksCounted],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'inherit' ELSE 'none' END [DisplayIfFieldBlanksTaken],
    CASE WHEN AirSampleCount.FieldBlankFailedCount+AirSampleCount.FieldBlankPassedCount > 0 THEN 'none' ELSE 'inherit' END [DisplayIfNoFieldBlanksTaken],
    Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then
    CASE WHEN Convert(decimal(12,2),airs.ReportedResult) <= Convert(decimal(12,2),0.01) AND IsNull(airs.RRMeasurement, '&nbsp;') = '<' Then
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=0),'#000000')
    Else
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=1),'#000000')
    End
    End [ResultColor001],
    Case When NULLIF(airs.FieldBlank,0) IS NULL AND DirtySlide Is Null Then
    CASE WHEN Convert(decimal(12,2),airs.ReportedResult) <= CONVERT(DECIMAL(12,2), PooledSamples.QuantificationLevel) AND IsNull(airs.RRMeasurement, '&nbsp;') = '<' Then
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=0),'#000000')
    Else
      IsNull((Select top 1 MobileConfigText FROM MobileConfig Where MobileConfigTypeID = 80 AND MobileConfigInt=1),'#000000')
    End
    End [ResultColorDetectionLimit],
    @EstimatedMeasurementsRequired [EstimatedMeasurementsRequired],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s1r.PassedStage1 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE1PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s1r.PassedStage1 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE1FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s2r.PassedStage2 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE2PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s2r.PassedStage2 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE2FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s3r.PassedStage3 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE3PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s3r.PassedStage3 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE3FAILED],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s4r.PassedStage4 = 1 THEN
      'Inherit'
    ELSE
      'None'
    END
    END [SHOWIFSTAGE4PASS],
    CASE WHEN at.AirTestTypeID = 2 THEN
    CASE WHEN s4r.PassedStage4 = 1 THEN
      'None'
    ELSE
      'Inherit'
    END
    END [SHOWIFSTAGE4FAILED]
FROM
      AirTest at
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage1]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=2
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s1r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage2]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=3
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s2r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage3]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=4
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s3r
      
      OUTER APPLY
      (
      Select 
        CAST(1 as bit) [PassedStage4]
      FROM 
        AirTestResult atr 
        LEFT OUTER JOIN MobileConfig mc ON atr.Result = mc.MobileConfigText AND MobileConfigTypeID=6
      Where 
        atr.ResultTypeID=5
          AND
        atr.Result=ISNULL(mc.MobileConfigText,'SATISFACTORY')
          AND
        atr.AirTestID=at.AirTestID 
      ) s4r
      
      
      
      INNER JOIN AirTestType att ON at.AirTestTypeID = att.AirTestTypeID
      INNER JOIN JobEmployee je ON at.JobEmployeeID=je.JobEmployeeID
      INNER JOIN Employee emp ON emp.EmployeeID=je.EmployeeID
      LEFT OUTER JOIN @AirSampleData airs ON airs.AirTestID = at.AirTestID
      
      LEFT OUTER JOIN @ElementData e111 ON e111.AirTestID=at.AirTestID AND e111.ElementTypeID = 111
      LEFT OUTER JOIN @ElementData e112 ON e112.AirTestID=at.AirTestID AND e112.ElementTypeID = 112
      LEFT OUTER JOIN @ElementData e113 ON e113.AirTestID=at.AirTestID AND e113.ElementTypeID = 113
      LEFT OUTER JOIN @ElementData e114 ON e114.AirTestID=at.AirTestID AND e114.ElementTypeID = 114
      LEFT OUTER JOIN @ElementData e115 ON e115.AirTestID=at.AirTestID AND e115.ElementTypeID = 115
      LEFT OUTER JOIN @ElementData e116 ON e116.AirTestID=at.AirTestID AND e116.ElementTypeID = 116
      LEFT OUTER JOIN 
      (
      Select DISTINCT RefNo FROM @at_EquipmentUsed Where EquipmentCategoryID=16
      ) euVehicle ON euVehicle.RefNo=e116.ElementText
      LEFT OUTER JOIN @ElementData e117 ON e117.AirTestID=at.AirTestID AND e117.ElementTypeID = 117
      LEFT OUTER JOIN @ElementData e118 ON e118.AirTestID=at.AirTestID AND e118.ElementTypeID = 118
      LEFT OUTER JOIN @ElementData e119 ON e119.AirTestID=at.AirTestID AND e119.ElementTypeID = 119
      LEFT OUTER JOIN @ElementData e131 ON e131.AirTestID=at.AirTestID AND e131.ElementTypeID = 131
      
      LEFT OUTER JOIN 
      (
            Select @AirTestID [AirTestID],
            (Select top 1 eu1.RefNo FROM @at_EquipmentUsed eu1 Where eu1.AirTestID=@AirTestID AND eu1.EquipmentCategoryID=1 Order by eu1.EquipmentUsedID ASC) [AcetoneVaporiser],
            (Select top 1 eu1.CalibrationDueDate FROM @at_EquipmentUsed eu1 Where eu1.AirTestID=@AirTestID AND eu1.EquipmentCategoryID=1 Order by eu1.EquipmentUsedID ASC) [AcetoneVaporiserCalibration],
            (Select top 1 eu2.RefNo FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 Order by eu2.EquipmentUsedID ASC) [MicroscopeReference],
            (Select top 1 eu2.CalibrationText FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 AND eu2.CalibrationInformationDescription = 'Result' Order by eu2.EquipmentUsedID ASC) [MicroscopeResult],
            (Select top 1 eu2.CalibrationDueDate FROM @at_EquipmentUsed eu2 Where eu2.AirTestID=@AirTestID AND eu2.EquipmentCategoryID=2 Order by eu2.EquipmentUsedID ASC) [MicroscopeCalibration],
            (Select top 1 eu3.RefNo FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerReference], 
            (Select top 1 eu3.CalibrationDueDate FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerCalibration],
            (Select top 1 eu3.IntervalCheck FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 Order by eu3.EquipmentUsedID ASC) [MicrometerInterval],
            (Select top 1 eu3.CalibrationText FROM @at_EquipmentUsed eu3 Where eu3.AirTestID=@AirTestID AND eu3.EquipmentCategoryID=3 AND eu3.CalibrationInformationDescription = 'Result' Order by eu3.EquipmentUsedID ASC) [MicrometerResult],
            (Select top 1 eu4.RefNo FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 Order by eu4.EquipmentUsedID ASC) [TestSlideReference], 
            (Select top 1 eu4.CalibrationText FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 AND eu4.CalibrationInformationDescription = 'Result' Order by eu4.EquipmentUsedID ASC) [TestSlideResult],
            (Select top 1 eu4.CalibrationDueDate FROM @at_EquipmentUsed eu4 Where eu4.AirTestID=@AirTestID AND eu4.EquipmentCategoryID=4 Order by eu4.EquipmentUsedID ASC) [TestSlideCalibration],
            --ORDERED THIS WAY SINCE THEY ARE ALL FLOWMETER STUFF (HI/MED/LOW)
            (Select top 1 eu5.RefNo FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHi],
            (Select top 1 eu5.CalibrationInt FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 AND eu5.CalibrationInformationDescription = 'Temperature' Order by eu5.EquipmentUsedID ASC) [FlowmeterHiTemperature],
            (Select top 1 eu5.CalibrationInt FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 AND eu5.CalibrationInformationDescription = 'Pressure' Order by eu5.EquipmentUsedID ASC) [FlowmeterHiPressure],
            (Select top 1 eu5.CalibrationDueDate FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHiCalibration],
            (Select top 1 eu5.IntervalCheck FROM @at_EquipmentUsed eu5 Where eu5.AirTestID=@AirTestID AND eu5.EquipmentCategoryID=5 Order by eu5.EquipmentUsedID ASC) [FlowmeterHiInterval],
            (Select top 1 eu20.RefNo FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMed],
            (Select top 1 eu20.CalibrationInt FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 AND eu20.CalibrationInformationDescription = 'Temperature' Order by eu20.EquipmentUsedID ASC) [FlowmeterMedTemperature],
            (Select top 1 eu20.CalibrationInt FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 AND eu20.CalibrationInformationDescription = 'Pressure' Order by eu20.EquipmentUsedID ASC) [FlowmeterMedPressure],
            (Select top 1 eu20.CalibrationDueDate FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMedCalibration],
            (Select top 1 eu20.IntervalCheck FROM @at_EquipmentUsed eu20 Where eu20.AirTestID=@AirTestID AND eu20.EquipmentCategoryID=20 Order by eu20.EquipmentUsedID ASC) [FlowmeterMedInterval],
            (Select top 1 eu21.RefNo FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLow],
            (Select top 1 eu21.CalibrationInt FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 AND eu21.CalibrationInformationDescription = 'Temperature' Order by eu21.EquipmentUsedID ASC) [FlowmeterLowTemperature],
            (Select top 1 eu21.CalibrationInt FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 AND eu21.CalibrationInformationDescription = 'Pressure' Order by eu21.EquipmentUsedID ASC) [FlowmeterLowPressure],
            (Select top 1 eu21.CalibrationDueDate FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLowCalibration],
            (Select top 1 eu21.IntervalCheck FROM @at_EquipmentUsed eu21 Where eu21.AirTestID=@AirTestID AND eu21.EquipmentCategoryID=21 Order by eu21.EquipmentUsedID ASC) [FlowmeterLowInterval],
            ------------------------------------------------------------------
            (Select top 1 eu6.RefNo FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID ASC) [TallyCounter], 
            (Select top 1 eu6.CalibrationDueDate FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID ASC) [TallyCounterCalibration],
            (Select top 1 eu6.RefNo FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID DESC) [AdditionalTallyCounter],
            (Select top 1 eu6.CalibrationDueDate FROM @at_EquipmentUsed eu6 Where eu6.AirTestID=@AirTestID AND eu6.EquipmentCategoryID=6 Order by eu6.EquipmentUsedID DESC) [AdditionalTallyCounterCalibration],
            (Select top 1 eu7.RefNo FROM @at_EquipmentUsed eu7 Where eu7.AirTestID=@AirTestID AND eu7.EquipmentCategoryID=7 Order by eu7.EquipmentUsedID ASC) [ThermometerReference], 
            (Select top 1 eu7.CalibrationDueDate FROM @at_EquipmentUsed eu7 Where eu7.AirTestID=@AirTestID AND eu7.EquipmentCategoryID=7 Order by eu7.EquipmentUsedID ASC) [ThermometerCalibration],
            (Select top 1 eu8.EquipmentUsedID FROM @at_EquipmentUsed eu8 Where eu8.AirTestID=@AirTestID AND eu8.EquipmentCategoryID=8 Order by eu8.EquipmentUsedID ASC) [FullFaceEquipmentUsedID], 
            (Select top 1 eu9.EquipmentUsedID FROM @at_EquipmentUsed eu9 Where eu9.AirTestID=@AirTestID AND eu9.EquipmentCategoryID=9 Order by eu9.EquipmentUsedID ASC) [HalfMaskEquipmentUsedID], 
            (Select top 1 eu11.RefNo FROM @at_EquipmentUsed eu11 Where eu11.AirTestID=@AirTestID AND eu11.EquipmentCategoryID=11 Order by eu11.EquipmentUsedID ASC) [SlideBox],
            (Select top 1 eu12.RefNo FROM @at_EquipmentUsed eu12 Where eu12.AirTestID=@AirTestID AND eu12.EquipmentCategoryID=12 Order by eu12.EquipmentUsedID ASC) [TimerReference], 
            (Select top 1 eu12.CalibrationDueDate FROM @at_EquipmentUsed eu12 Where eu12.AirTestID=@AirTestID AND eu12.EquipmentCategoryID=12 Order by eu12.EquipmentUsedID ASC) [TimerCalibration],
            (Select top 1 eu13.RefNo FROM @at_EquipmentUsed eu13 Where eu13.AirTestID=@AirTestID AND eu13.EquipmentCategoryID=13 Order by eu13.EquipmentUsedID ASC) [BarometerReference],
            
            
            (Select top 1 eu17.RefNo FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 Order by eu17.EquipmentUsedID ASC) [FilterBox],
            (Select top 1 eu17.CalibrationText FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 AND eu17.CalibrationInformationDescription = 'Result' Order by eu17.EquipmentUsedID ASC) [FilterBoxResult],
            (Select top 1 eu17.CalibrationDueDate FROM @at_EquipmentUsed eu17 Where eu17.AirTestID=@AirTestID AND eu17.EquipmentCategoryID=17 Order by eu17.EquipmentUsedID ASC) [FilterBoxChecked],
            
            (Select top 1 eu62.RefNo FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 Order by eu62.EquipmentUsedID ASC) [PhaseTelescope],
            (Select top 1 eu62.CalibrationText FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 AND eu62.CalibrationInformationDescription = 'Result' Order by eu62.EquipmentUsedID ASC) [PhaseTelescopeResult],
            (Select top 1 eu62.CalibrationDueDate FROM @at_EquipmentUsed eu62 Where eu62.AirTestID=@AirTestID AND eu62.EquipmentCategoryID=62 Order by eu62.EquipmentUsedID ASC) [PhaseTelescopeChecked]
            
      ) EU ON eu.AirTestID=at.AirTestID
      
      LEFT OUTER JOIN
      (
            Select @AirTestID [AirTestID],
            (select IsNull(e.FullName,'&nbsp;') from @at_Inspection i LEFT OUTER JOIN Employee e on i.InspectionInt = e.EmployeeID where i.AirTestID = @AirTestID and i.InspectionLabelID = 6) [FibreAnalyst]
      
      ) INSP ON INSP.AirTestID=at.AirTestID
      
      CROSS JOIN
      (
            Select
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=0) [ActualAirSampleCount],
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=1) [FieldBlankFailedCount],
                  (Select COUNT(*) FROM @AirSampleData asd Where asd.FieldBlank=2) [FieldBlankPassedCount]
      ) AirSampleCount
      
      OUTER APPLY
      (
            Select
				tmp.Count,
				tmp.PooledVolume,
				tmp.PooledFibres,
				CASE WHEN tmp.QuantificationLevel < 0.01 AND tmp.PooledVolume > 480 AND tmp.[OverrideLoQCalculation] = 0 THEN 
					0.01 
				ELSE 
					tmp.QuantificationLevel 
				END [QuantificationLevel],
				[OverrideLoQText],
				tmp.ResultConcentration
            FROM
				(Select 
					MAX(pairs.OverrideLoQCalculation) [OverrideLoQCalculation],
					MAX(pairs.OverrideLoQText) [OverrideLoQText],
					COUNT(*) [Count], SUM(IsNull(pairs.Volume,0)) [PooledVolume], SUM(IsNull(Convert(decimal(12,3),pairs.Fibres),0)) [PooledFibres],
					  CASE WHEN CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) = Convert(decimal(12,3),0) OR AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)) = Convert(decimal(12,3),0) THEN
							0
					  ELSE
							(
								  Convert(decimal(12,3),96000)
								  / 
								  (Convert(decimal(12,3),CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT)) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)))
							) * Convert(decimal(12,3),0.01)
					  END [QuantificationLevel],
					  CASE WHEN ((IsNull(Convert(decimal(12,3),e118.ElementText),0) * IsNull(Convert(decimal(12,3),e118.ElementText),0)) * CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0))) > 0 THEN
							CAST(
								  (1000 * SUM(IsNull(Convert(decimal(12,3),pairs.Fibres),0)) * (IsNull(Convert(decimal(12,3),e117.ElementText),0) * (IsNull(Convert(decimal(12,3),e117.ElementText),0))))
										/
								  ((IsNull(Convert(decimal(12,3),e118.ElementText),0) * IsNull(Convert(decimal(12,3),e118.ElementText),0)) * CAST(ROUND(SUM(IsNull(pairs.Volume,0)),0) as INT) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(pairs.Graticule,0))),0)))
							 AS varchar)
					  ELSE 'N/A' END [ResultConcentration]
					FROM 
						@AirSampleData pairs
					Where 
						pairs.AirSampleItemNo=airs.AirSampleItemNo
				Group By pairs.AirSampleItemNo
			   ) tmp
      ) PooledSamples
WHERE
      at.AirTestID = @AirTestID
ORDER BY
      airs.RowNo

SET NOCOUNT OFF
End
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'AirMonitoringQuantificationLevel') < 1 BEGIN
	EXEC('CREATE FUNCTION [dbo].[AirMonitoringQuantificationLevel] ( @AirSampleID int ) RETURNS decimal(12,3) BEGIN RETURN 0.00 END;')
End
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER FUNCTION [dbo].[AirMonitoringQuantificationLevel] ( @AirSampleID int )
RETURNS decimal (12,3)
WITH EXECUTE AS CALLER
AS
BEGIN

      -- Declare reusable vars
      Declare @AirTestID int
      Declare @AirSampleItemNo int
      Declare @AirTestTypeID int
      Declare @TotalVolume int
      Declare @Graticule decimal(12,3)
      Declare @QuantificationLevel decimal(12,3)
      Declare @A decimal(12,10)
      Declare @B decimal(16,10)
	  Declare @OverrideLoQCalculation int
      
      -- Retrieve any associated pooled air samples (same AirSampleItemNo on one AirTestID) into temp table
      Select @AirTestID = AirTestID From AirSample Where AirSampleID = @AirSampleID
      Select @AirSampleItemNo = AirSampleItemNo From AirSample Where AirSampleID = @AirSampleID
      Select @AirTestTypeID = AirTestTypeID From AirTest Where AirTestID = @AirTestID
      Declare @PooledAirSamples table (AirSampleID int, MinsRunning decimal(12,3), FlowRate decimal(12,3), Volume int)
      
      Insert Into
            @PooledAirSamples(AirSampleID, MinsRunning, FlowRate, Volume)
      Select
            AirSampleID,
            dbo.AirMonitoringResultMinsRunning (AirSampleID),
            dbo.AirMonitoringResultFlowRate (AirSampleID),
            -- VOLUME = MINSRUNNING * FLOWRATE (ROUNDED TO 0 DECIMAL PLACES)
            --convert(int, convert(decimal(12,0),dbo.AirMonitoringResultMinsRunning(AirSampleID)) * convert(decimal(12,3),dbo.AirMonitoringResultFlowRate(AirSampleID)))
            convert(decimal(12,2),dbo.AirMonitoringResultMinsRunning(AirSampleID)) * convert(decimal(12,3),dbo.AirMonitoringResultFlowRate(AirSampleID))
      From
            AirSample
      Where
            AirTestID = @AirTestID
                  And
            AirSampleItemNo = @AirSampleItemNo

      -- Get total of all volumes for pooled samples
      Select @TotalVolume = SUM(Volume) FROM @PooledAirSamples
      
      -- Get the average (mean) graticule for all samples
      Select @Graticule = AVG(IsNull(Convert(decimal(12,3), Convert(varchar, Graticule)), 0)) FROM AirMonitoringReportResults WHERE AirSampleID in (Select AirSampleID From @PooledAirSamples)
      
      -- Calculate the concentration
      If @TotalVolume = 0 OR @Graticule = 0 Begin
            return 0
      END
      Else
            Select @QuantificationLevel =
                  CASE WHEN CAST(ROUND(SUM(IsNull(ps.Volume,0)),0) as INT) = Convert(decimal(12,3),0) OR AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(@Graticule,0))),0)) = Convert(decimal(12,3),0) THEN
                0
          ELSE
                (
                      Convert(decimal(12,3),96000)
                      / 
                      (Convert(decimal(12,3),CAST(ROUND(SUM(IsNull(ps.Volume,0)),0) as INT)) * AVG(IsNull(Convert(decimal(12,3),Convert(varchar, IsNull(@Graticule,0))),0)))
                ) * Convert(decimal(12,3),0.01)
          END
      FROM @PooledAirSamples ps

	  SELECT
			@OverrideLoQCalculation = MAX(ISNULL(e122.ElementText,0))
	  FROM 
			@PooledAirSamples ps
			INNER JOIN Element e122 ON e122.AirSampleID=ps.AirSampleID AND e122.ElementTypeID=122

		            
      If @QuantificationLevel < 0.01 AND @OverrideLoQCalculation = 0
      BEGIN
            Select @QuantificationLevel = 0.01
      END
            
            return @QuantificationLevel
      
END

GO
USE [TEAMS]
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 1,'Mains water supply','Mains water supply','MCW',1,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=1)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 2,'Cold Water Storage Tank','CWST','CWST ',3,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=2)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 3,'Hot Water Storage Vessel','Hot Water Storage Vessel','HWSV',4,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=3)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 4,'Low Storage Water Heater','Low Storage Water Heater','LSWH',7,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=4)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 5,'Instantaneous water heaters','Instantaneous water heaters','IWH',7,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=5)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 6,'Showers','Showers','SH',9,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=6)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 7,'TMV','TMV','TMV',10,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=7)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 8,'Deadlegs','Deadlegs','DL',10,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=8)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 9,'Water Softeners','Water Softeners','OWS',35,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=9)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 10,'Other system','Other system','',11,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=10)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 11,'Fire Control Systems','Fire Control Systems','OFCA',19,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=11)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 12,'Cooling Tower','Cooling Tower','CT',2,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=12)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 13,'Plate Heater Exchanger','Plate Heater Exchanger','PHE',5,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=13)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 14,'Combination Water Heater','Combination Water Heater','CWH',6,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=14)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 15,'Water Heaters','Water Heaters','WH',8,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=15)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 16,'Air Handling Units','Air Handling Units','OAHU',12,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=16)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 17,'Pressurisation Unit','Pressurisation Unit','OPU',13,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=17)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 18,'Feed and Expansion Tanks','Feed and Expansion Tanks','OFE',14,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=18)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 19,'Safety Shower and Emergency Eyewash Systems','Safety Shower & Emergency Eyewash Systems','OSSS',15,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=19)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 20,'Scrubber Systems','Scrubber Systems','OAS',16,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=20)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 21,'Water Features','Water Features','OWF',17,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=21)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 22,'Lathes Machine Tool Systems','Lathes / Machine Tool Systems','OMT',18,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=22)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 23,'SPA Baths','SPA Baths','OSPA',20,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=23)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 24,'Dental Chairs','Dental Chairs','ODC',21,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=24)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 25,'Chilled Drinking Water','Chilled Drinking Water','OCW',22,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=25)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 26,'Air Conditioning Systems Single Zone','Air Conditioning Systems - Single Zone','OACS',23,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=26)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 27,'External Internal Utility Water Taps','External / Internal Utility Water Taps','OEUT',24,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=27)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 28,'Spray Taps','Spray Taps','OST',32,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=28)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 29,'Exposed Pipe Work','Exposed Pipe Work','OEP',26,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=29)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 30,'Spray Pressure Washers','Spray Pressure Washers','OSPW',27,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=30)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 31,'Flexible Hose Connectors','Flexible Hose Connectors','OFH',28,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=31)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 32,'Expansion Pressure Vessels Pump Accumulators','Expansion / Pressure Vessels / Pump Accumulators','OPV',29,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=32)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 33,'Strainers','Strainers','OSR',30,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=33)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 34,'Portable Air Conditioning Systems','Portable Air Conditioning Systems','OPAC',31,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=34)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 35,'Scale on Taps','Scale on Taps','OSOT',31,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=35)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 36,'Grey Water','Grey Water','OGW',33,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=36)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 37,'Filters','Filters','OFIL',34,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=37)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 38,'Vehicle Wash','Vehicle Wash','OVW',36,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=38)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 39,'Chlorine Dioxide Unit','Chlorine Dioxide Unit','OCD',37,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=39)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 40,'Swimming Pools','Swimming Pools','OSP',38,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=40)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 41,'Incubators','Incubators','OINC',39,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=41)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 42,'RO Unit','RO Unit','ORO',40,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=42)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 43,'Non WRAS Approved Materials','Non WRAS Approved Materials','NWAM',41,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=43)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 44,'Process Production Water','Process Production Water','OPPW',42,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=44)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 45,'Humidification Equipment','Humidification Equipment','OHE',43,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=45)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 46,'UV Light','UV Light','OUV',44,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=46)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 47,'Mothballing','Mothballing','OMB',45,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=47)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 48,'Quick Fill Loops','Quick Fill Loops','OQFL',46,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=48)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 49,'Tanning Spray Booths','Tanning Spray Booths','OTSP',47,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=49)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 50,'Cyclone Style Hand Dryer','Cyclone Style Hand Dryer','OCHD',48,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=50)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 51,'Water Purification for Dental Chairs','Water Purification for Dental Chairs','OWP',49,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=51)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 52,'RPZ Valves','RPZ Valves','ORPX',50,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=52)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 53,'Washing Machines / Dishwashers','Washing Machines / Dishwashers','WASH',53,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=53)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 54,'Infrequently used outlet','Infrequently used outlet','IUO',10,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=54)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 55,'Deadend','Deadend','DE',10,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=55)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 56,'Whirlpool baths','Whirlpool baths','WPB',56,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=56)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 57,'Vending machines','Vending machines','VEND',57,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=57)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 58,'Misting machines','Misting machines','MM',58,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=58)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 59,'Drinking Water Dispensers Ice Machines Vending','Drinking Water Dispensers / Ice Machines / Vending','DWD',100,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=59)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 60,'Cleaning Equipment','Cleaning Equipment','CE',101,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=60)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 61,'Irrigation Systems','Irrigation Systems','IS',102,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=61)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 62,'Steam Generators','Steam Generators','SG',103,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=62)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 63,'Vehicle Wash Bottles','Vehicle Wash Bottles','VWB',104,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=63)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 64,'Secondary Dosing','Secondary Dosing','SD',105,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=64)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 65,'Kitchen Equipment','Kitchen Equipment','KE',106,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=65)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 66,'Fume Cupboards','Fume Cupboards','FC',107,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=66)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 67,'DeIonised Distilled Water Units','De-Ionised / Distilled Water Units','DWU',108,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=67)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 68,'High Storage Water Heater','High Storage Water Heater','HSWH',7,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=68)=0
INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,DefaultAssetCode,SortOrder,Deleted) SELECT 69,'Thermostatic Mixer Tap','Thermostatic Mixer Tap','TMVT',10,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=69)=0


GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'GetNextSampleRef') < 1 BEGIN
	EXEC('CREATE Function [dbo].[GetNextSampleRef] () RETURNS VARCHAR(max) AS BEGIN RETURN '''' END')
End

GO

ALTER Function [dbo].[GetNextSampleRef]
(
)
RETURNS VARCHAR(MAX)
As
BEGIN

	DECLARE @NextSampleRef VARCHAR(MAX) = ''
	SELECT @NextSampleRef = 
		(
			SELECT TOP 1 'BS' + CASE
									WHEN LEN(CONVERT(VARCHAR(MAX), _s.SamplerefNo + 1)) < 6 THEN RIGHT('000000' + CAST(_s.SampleRefNo + 1 AS VARCHAR), 6)
									ELSE CONVERT(VARCHAR(MAX), _s.SamplerefNo + 1)
								END   [nv]
			FROM (
				SELECT s.SampleRef, CAST(s.SampleRefNo AS INT) [SampleRefNo]
				FROM (
						Select s.SampleRef [SampleRef], REPLACE(s.SampleRef,'BS','') [SampleRefNo] 
						FROM Sample s 
						WHERE LEFT(s.SampleRef,2) = 'BS'
						) s
				WHERE LTRIM(RTRIM(s.SampleRefNo)) NOT LIKE '%[^0-9]%'
				) _s
			ORDER BY _s.SampleRefNo DESC
		)

	RETURN @NextSampleRef
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='util_UpdateGuidedDataStatePriority'))
BEGIN
	CREATE TABLE [dbo].[util_UpdateGuidedDataStatePriority](
		[util_UpdateGuidedDataStatePriorityID] [int] IDENTITY(1,1) NOT NULL,
		[ClientID] [int] NOT NULL,
		[Order] [int] NOT NULL,
	CONSTRAINT [PK_util_UpdateGuidedDataStatePriorityID] PRIMARY KEY CLUSTERED 
	(
		[util_UpdateGuidedDataStatePriorityID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END 
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Site') AND name='DateCreated') < 1
BEGIN
  ALTER TABLE [Site]
      ADD [DateCreated] DATETIME DEFAULT(GETDATE()) NOT NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='EnterpriseExternalSite') AND name='DateCreated') < 1
BEGIN
  ALTER TABLE [EnterpriseExternalSite]
      ADD [DateCreated] DATETIME DEFAULT(GETDATE()) NOT NULL
END
GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'DeleteImport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[DeleteImport] AS BEGIN SET NOCOUNT ON; END')
End


GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[DeleteImport] 
	@ImportID INT
AS
BEGIN

	DELETE FROM [Site] WHERE ImportID = @ImportID
	DELETE FROM Employee WHERE ImportID = @ImportID
	DELETE FROM Job WHERE ImportID = @ImportID
	DELETE FROM Quote WHERE ImportID = @ImportID
	DELETE FROM QuoteSurvey WHERE ImportID = @ImportID
	DELETE FROM Appointment WHERE ImportID = @ImportID
	DELETE FROM AppointmentSurvey WHERE ImportID = @ImportID
	DELETE FROM JobEmployee WHERE ImportID = @ImportID
	DELETE FROM Register WHERE ImportID = @ImportID
	DELETE FROM Survey WHERE ImportID = @ImportID
	DELETE FROM Room WHERE ImportID = @ImportID
	DELETE FROM [Sample] WHERE ImportID = @ImportID
	DELETE FROM Element WHERE ImportID = @ImportID
	DELETE FROM PDF WHERE ImportID = @ImportID
	DELETE FROM Photo WHERE ImportID = @ImportID
	DELETE FROM Floorplan WHERE ImportID = @ImportID
	DELETE FROM ImportData WHERE ImportID = @ImportID

	UPDATE Import SET DateDeleted = GETDATE() WHERE ImportID = @ImportID
	
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSurveyDataValidationChecks') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[EnterpriseSurveyDataValidationChecks] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[EnterpriseSurveyDataValidationChecks]
		@JobID INT

AS
BEGIN
    SET NOCOUNT ON;

	INSERT INTO #Issues
	SELECT
		'Enterprise has gone bad' [IssueDescription],
		0 [Required]

    SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'SurveyDataValidationChecks') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[SurveyDataValidationChecks] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[SurveyDataValidationChecks]
	@JobID INT

AS
BEGIN
    SET NOCOUNT ON;

	CREATE TABLE #Issues (IssueDescription VARCHAR(MAX), [Required] BIT)	
	--INSERT INTO #Issues (IssueDescription, [Required])
	--SELECT 'No photo on sample', 1
	
	--EXEC EnterpriseSurveyDataValidationChecks @JobID = @JobID

	SELECT
		IssueDescription, [Required]
	FROM
		#Issues

	--DROP TABLE #Issues

    SET NOCOUNT OFF;
END
GO


IF (not EXISTS (SELECT * FROM [TEAMS_IVF].INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='IVF_Import'))
	BEGIN
CREATE TABLE [TEAMS_IVF].[dbo].[IVF_Import](
	[IVF_ImportID] [int] IDENTITY(1,1) NOT NULL,
	[IVF_ImportGroupID] [int] NOT NULL,
	[ClientID] [int] NOT NULL,
	[SurveyTypeID] [int] NOT NULL,
	[ImportFolder] [varchar](max) NOT NULL,
	[ValidationPassed] [datetime] NULL,
	[ValidationFailed] [datetime] NULL,
	[ValidationNotes] [varchar](max) NULL,
	[DateCreated] [datetime] DEFAULT (getdate()) NOT NULL,
	[DateDeleted] [datetime] NULL,
	[Import] [bit] DEFAULT (0) NOT NULL,
	[DateImported] [datetime] NULL,
	[TeamsEnterpriseID] [int] NULL,
	[IVF_ImportStatusTypeID] [int] DEFAULT (0) NOT NULL,
	[OriginalJobNumber] [varchar](max) NULL,
	[JobApproved] [datetime] NULL,
 CONSTRAINT [PK_IVF_Import] PRIMARY KEY CLUSTERED 
(
	[IVF_ImportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END

GO
SET NOCOUNT ON;
IF (Select COUNT(*) FROM  TEAMS.sys.tables Where name='IVF_ImportStatusType') < 1 BEGIN
		CREATE TABLE TEAMS.[dbo].[IVF_ImportStatusType](
			[IVF_ImportStatusTypeID] [int] NOT NULL,
			[Description] [varchar](max) NOT NULL,
		CONSTRAINT [PK_IVF_ImportStatusType] PRIMARY KEY CLUSTERED 
		(
			[IVF_ImportStatusTypeID] ASC
		)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
		) ON [PRIMARY]
END
GO
IF (Select COUNT(*) FROM  TEAMS.sys.tables Where name='IVF_ImportStatusType') > 0 BEGIN
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 1,'Importing' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=1)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 2,'Failed Validation'  WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=2)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 3,'Imported' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=3)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 4,'Rejected' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=4)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 5,'Rejected (Un-approved by consultancy)' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=5)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 6,'Failed (Un-approved by consultancy)' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=6)=0
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 7,'Pre-EnterpriseExchange' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=7)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 8,'Exporting' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=8)=0;
	INSERT INTO TEAMS.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 9,'Deleted' WHERE (SELECT COUNT(*) FROM TEAMS.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=9)=0;
END
GO
IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='EnterpriseDataTransfer') AND name='IVF_ImportStatusTypeID') < 1
BEGIN
    ALTER TABLE TEAMS.[dbo].EnterpriseDataTransfer
        ADD [IVF_ImportStatusTypeID] INT NOT NULL DEFAULT (0)
END
GO
IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='EnterpriseDataTransfer') AND name='IVF_ImportID') < 1
BEGIN
    ALTER TABLE TEAMS.[dbo].EnterpriseDataTransfer
        ADD [IVF_ImportID] INT NULL
END
GO
IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='EnterpriseExternalSite') AND name='LastUpdated') < 1
BEGIN
    ALTER TABLE TEAMS.[dbo].EnterpriseExternalSite
        ADD [LastUpdated] DATETIME NULL
END
GO
IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM  TEAMS_IVF.sys.tables Where name=''IVF_ImportStatusType'') < 1 BEGIN
			CREATE TABLE TEAMS_IVF.[dbo].[IVF_ImportStatusType](
				[IVF_ImportStatusTypeID] [int] NOT NULL,
				[Description] [varchar](max) NOT NULL,
			CONSTRAINT [PK_IVF_ImportStatusType] PRIMARY KEY CLUSTERED 
			(
				[IVF_ImportStatusTypeID] ASC
			)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
			) ON [PRIMARY]
	END'
	EXECUTE sp_executesql @sql
END
GO
IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM  TEAMS_IVF.sys.tables Where name=''IVF_ImportStatusType'') > 0 BEGIN
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 1,''Importing'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=1)=0;
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 2,''Failed Validation''  WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=2)=0;
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 3,''Imported'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=3)=0;
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 4,''Rejected'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=4)=0;
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 5,''Rejected (Un-approved by consultancy)'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=5)=0;
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 6,''Failed (Un-approved by consultancy)'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=6)=0
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 7,''Pre-EnterpriseExchange'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=7)=0
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 8,''Exporting'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=8)=0
	INSERT INTO TEAMS_IVF.dbo.IVF_ImportStatusType ([IVF_ImportStatusTypeID],[Description]) SELECT 9,''Deleted'' WHERE (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_ImportStatusType WHERE IVF_ImportStatusTypeID=9)=0
END'
	EXECUTE sp_executesql @sql
END
GO
IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name=''IVF_Import'') AND name=''IVF_ImportStatusTypeID'') < 1 BEGIN
  ALTER TABLE TEAMS_IVF.dbo.IVF_Import
      ADD IVF_ImportStatusTypeID INT DEFAULT(0) NOT NULL
END'
	EXECUTE sp_executesql @sql
END
GO
SET NOCOUNT OFF;
GO
IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name=''IVF_Import'') AND name=''TeamsEnterpriseID'') < 1 BEGIN
  ALTER TABLE TEAMS_IVF.dbo.IVF_Import
      ADD TeamsEnterpriseID INT NULL
END'
	EXECUTE sp_executesql @sql
END
GO

SET NOCOUNT OFF;
GO

IF (not EXISTS (SELECT * FROM [TEAMS_IVF].INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='IVF_Import'))
	BEGIN
CREATE TABLE [TEAMS_IVF].[dbo].[IVF_Import](
	[IVF_ImportID] [int] IDENTITY(1,1) NOT NULL,
	[IVF_ImportGroupID] [int] NOT NULL,
	[ClientID] [int] NOT NULL,
	[SurveyTypeID] [int] NOT NULL,
	[ImportFolder] [varchar](max) NOT NULL,
	[ValidationPassed] [datetime] NULL,
	[ValidationFailed] [datetime] NULL,
	[ValidationNotes] [varchar](max) NULL,
	[DateCreated] [datetime] DEFAULT (getdate()) NOT NULL,
	[DateDeleted] [datetime] NULL,
	[Import] [bit] DEFAULT (0) NOT NULL,
	[DateImported] [datetime] NULL,
	[TeamsEnterpriseID] [int] NULL,
	[IVF_ImportStatusTypeID] [int] DEFAULT (0) NOT NULL,
	[OriginalJobNumber] [varchar](max) NULL,
	[JobApproved] [datetime] NULL,
 CONSTRAINT [PK_IVF_Import] PRIMARY KEY CLUSTERED 
(
	[IVF_ImportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseExchangeLog'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseExchangeLog](
			[EnterpriseExchangeLogID] [int] IDENTITY(1,1) NOT NULL,
			[LocalServerCode] [varchar](max) NOT NULL,
			[EnterpriseServerCode] [varchar](max) NULL,
			[ConsultancyServerCode] [varchar](max) NULL,
			[LastResponse] [varchar](max) NULL,
			[LastProcessRun] [datetime] NULL,
			[LastUpdate] [datetime] DEFAULT (GETDATE()) NOT NULL,
		 CONSTRAINT [PK_EnterpriseExchangeLog_EnterpriseExchangeLogID] PRIMARY KEY CLUSTERED 
		(
			[EnterpriseExchangeLogID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
COMMIT TRANSACTION
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='EnterpriseExchangeLog') AND name='ConsultancyServerCode') < 1
BEGIN
  ALTER TABLE EnterpriseExchangeLog
      ADD ConsultancyServerCode [varchar](max) NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='s__EmailBodyFontSize') < 1
BEGIN
  ALTER TABLE [dbo].[Config]
	ADD [s__EmailBodyFontSize] [varchar] (50) NULL;
END
GO

UPDATE TeamsV2SubTab set EnableMvcGrid = 1  where TabText = 'Work In Progress'
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetFirstRegisterRunDetails') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetFirstRegisterRunDetails] AS BEGIN SET NOCOUNT ON; END')
End
GO

ALTER PROC [dbo].[GetFirstRegisterRunDetails]
	@RegisterID INT
AS
BEGIN
	SET NOCOUNT ON 

	-- Get all element data up fron to reduce table scans on the element table
	CREATE TABLE #ElementData (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX))

	INSERT INTO #ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription)
	SELECT
		e.ElementID,
		e.SampleID,
		e.ElementTypeID,
		e.ElementText,
		e.ElementIntID,
		e.ElementIntMeaningID,
		e.ElementIntMeaningExtendedID,
		e.ElementIntMeaningSubOptionID,
		COALESCE(eimso.[Description], eime.[Description], eim.ShortDescription, eim.[Description])
	FROM
		Register r WITH(nolock)
		INNER JOIN Floorplan f WITH(nolock) ON r.RegisterID = f.RegisterID
		INNER JOIN Room rm WITH(nolock) ON rm.FloorplanID = f.FloorplanID
		INNER JOIN [Sample] s WITH(nolock) ON s.RoomID = rm.RoomID
		INNER JOIN Element e WITH(nolock) ON e.SampleID = s.SampleID
		LEFT JOIN ElementIntMeaning eim WITH(nolock) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
		LEFT JOIN ElementIntMeaningExtended eime WITH(nolock) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
		LEFT JOIN ElementIntMeaningSubOption eimso WITH(nolock) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID
	WHERE
		r.RegisterID = @RegisterID
	
	-- Get the data
	SELECT
		ISNULL(r.BuildingDesignation, '&nbsp;') 'Building',
		ISNULL(dbo.FloorName(f.FloorNumber), '&nbsp;') 'Floor',
        ISNULL(COALESCE([rm].[RoomCode],CAST([rm].[Number] AS varchar(10))),'&nbsp;') 'RoomNo',
		ISNULL(rm.[Description], '&nbsp;') 'Room',
		ISNULL(rm.Notes, '&nbsp;') 'RoomNotes',
		ISNULL(CONVERT(VARCHAR, s.RegisterItemNo), '&nbsp;') 'RegisterItemNo',
		ISNULL(p.PhotoNo, '&nbsp;') 'PhotoNo',
		ISNULL(s.SampleRef, '&nbsp;') 'SampleRef',
		ISNULL(CASE WHEN s.SampleRef IS NOT NULL THEN CASE s.AsSample WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END ELSE NULL END, '&nbsp;') 'AsSample',
		ISNULL(ISNULL(e2.ElementText, 'There were no items/samples taken in this room.'), '&nbsp;') 'Description',
		ISNULL(e26.ElementText, '&nbsp;') 'PreQuantityUnit',
		ISNULL(e3.ElementText, '&nbsp;') 'Quantity',
		ISNULL(e4.ElementText, '&nbsp;') 'QuantityUnit',
		ISNULL('(' + CONVERT(VARCHAR, e5.ElementIntID) + ') ' + e5.ElementIntMeaningDescription, '&nbsp;') 'IdentificationLevel',
		ISNULL('(' + CONVERT(VARCHAR, e6.ElementIntID) + ') ' + e6.ElementIntMeaningDescription, '&nbsp;') 'ProductDescription',
		ISNULL('(' + CONVERT(VARCHAR, e7.ElementIntID) + ') ' + e7.ElementIntMeaningDescription, '&nbsp;') 'ProductType',
		ISNULL('(' + CONVERT(VARCHAR, e8.ElementIntID) + ') ' + e8.ElementIntMeaningDescription, '&nbsp;') 'AsbestosType',
		ISNULL('(' + CONVERT(VARCHAR, e9.ElementIntID) + ') ' + e9.ElementIntMeaningDescription, '&nbsp;') 'DamageDetoriation',
		ISNULL('(' + CONVERT(VARCHAR, e10.ElementIntID) + ') ' + e10.ElementIntMeaningDescription, '&nbsp;') 'SurfaceTreatment',
		ISNULL('(' + CONVERT(VARCHAR, e11.ElementIntID) + ') ' + e11.ElementIntMeaningDescription, '&nbsp;') 'OccupantActivity',
		ISNULL('(' + CONVERT(VARCHAR, e12.ElementIntID) + ') ' + e12.ElementIntMeaningDescription, '&nbsp;') 'OccupantLocation',
		ISNULL('(' + CONVERT(VARCHAR, e13.ElementIntID) + ') ' + e13.ElementIntMeaningDescription, '&nbsp;') 'Accessibility',
		ISNULL('(' + CONVERT(VARCHAR, e14.ElementIntID) + ') ' + e14.ElementIntMeaningDescription, '&nbsp;') 'QuantityScore',
		ISNULL('(' + CONVERT(VARCHAR, e15.ElementIntID) + ') ' + e15.ElementIntMeaningDescription, '&nbsp;') 'NoOfOccupants',
		ISNULL('(' + CONVERT(VARCHAR, e16.ElementIntID) + ') ' + e16.ElementIntMeaningDescription, '&nbsp;') 'FrequencyOfUse',
		ISNULL('(' + CONVERT(VARCHAR, e17.ElementIntID) + ') ' + e17.ElementIntMeaningDescription, '&nbsp;') 'AverageTime',
		ISNULL('(' + CONVERT(VARCHAR, e18.ElementIntID) + ') ' + e18.ElementIntMeaningDescription, '&nbsp;') 'TypeOfMaintenance',
		ISNULL('(' + CONVERT(VARCHAR, e19.ElementIntID) + ') ' + e19.ElementIntMeaningDescription, '&nbsp;') 'FrequencyOfMaintenance',
		ISNULL(e20.ElementIntMeaningDescription, '&nbsp;') 'RecommendedAction',
		ISNULL(e23.ElementIntMeaningDescription, '&nbsp;') 'ManagementActions',
		ISNULL(e24.ElementIntMeaningDescription, '&nbsp;') 'ManagementTimescale',
		ISNULL(e25.ElementIntMeaningDescription, '&nbsp;') 'ManagementNextReview'
	FROM
		Register r
		INNER JOIN Floorplan f ON r.RegisterID = f.RegisterID
		INNER JOIN Room rm ON rm.FloorplanID = f.FloorplanID
		LEFT JOIN [Sample] s ON s.RoomID = rm.RoomID
		LEFT JOIN Photo p ON p.PhotoID = s.PhotoID
		LEFT JOIN #ElementData e2 ON e2.SampleID = s.SampleID AND e2.ElementTypeID = 2
		LEFT JOIN #ElementData e3 ON e3.SampleID = s.SampleID AND e3.ElementTypeID = 3
		LEFT JOIN #ElementData e4 ON e4.SampleID = s.SampleID AND e4.ElementTypeID = 4
		LEFT JOIN #ElementData e5 ON e5.SampleID = s.SampleID AND e5.ElementTypeID = 5
		LEFT JOIN #ElementData e6 ON e6.SampleID = s.SampleID AND e6.ElementTypeID = 6
		LEFT JOIN #ElementData e7 ON e7.SampleID = s.SampleID AND e7.ElementTypeID = 7
		LEFT JOIN #ElementData e8 ON e8.SampleID = s.SampleID AND e8.ElementTypeID = 8
		LEFT JOIN #ElementData e9 ON e9.SampleID = s.SampleID AND e9.ElementTypeID = 9
		LEFT JOIN #ElementData e10 ON e10.SampleID = s.SampleID AND e10.ElementTypeID = 10
		LEFT JOIN #ElementData e11 ON e11.SampleID = s.SampleID AND e11.ElementTypeID = 11
		LEFT JOIN #ElementData e12 ON e12.SampleID = s.SampleID AND e12.ElementTypeID = 12
		LEFT JOIN #ElementData e13 ON e13.SampleID = s.SampleID AND e13.ElementTypeID = 13
		LEFT JOIN #ElementData e14 ON e14.SampleID = s.SampleID AND e14.ElementTypeID = 14
		LEFT JOIN #ElementData e15 ON e15.SampleID = s.SampleID AND e15.ElementTypeID = 15
		LEFT JOIN #ElementData e16 ON e16.SampleID = s.SampleID AND e16.ElementTypeID = 16
		LEFT JOIN #ElementData e17 ON e17.SampleID = s.SampleID AND e17.ElementTypeID = 17
		LEFT JOIN #ElementData e18 ON e18.SampleID = s.SampleID AND e18.ElementTypeID = 18
		LEFT JOIN #ElementData e19 ON e19.SampleID = s.SampleID AND e19.ElementTypeID = 19
		LEFT JOIN #ElementData e20 ON e20.SampleID = s.SampleID AND e20.ElementTypeID = 20
		LEFT JOIN #ElementData e21 ON e21.SampleID = s.SampleID AND e21.ElementTypeID = 21
		LEFT JOIN #ElementData e22 ON e22.SampleID = s.SampleID AND e22.ElementTypeID = 22
		LEFT JOIN #ElementData e23 ON e23.SampleID = s.SampleID AND e23.ElementTypeID = 23
		LEFT JOIN #ElementData e24 ON e24.SampleID = s.SampleID AND e24.ElementTypeID = 24
		LEFT JOIN #ElementData e25 ON e25.SampleID = s.SampleID AND e25.ElementTypeID = 25
		LEFT JOIN #ElementData e26 ON e26.SampleID = s.SampleID AND e26.ElementTypeID = 26
	WHERE
		r.RegisterID = @RegisterID
	ORDER BY
		s.RegisterItemNo

	DROP TABLE #ElementData
	
	SET NOCOUNT OFF
END
GO

UPDATE Config SET b__UseV2ApproveReport=0
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='SurveyEnterpriseEnabled') < 1
BEGIN
  ALTER TABLE Client
      ADD SurveyEnterpriseEnabled BIT DEFAULT(0) NOT NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='AirTestEnterpriseEnabled') < 1
BEGIN
  ALTER TABLE Client
      ADD AirTestEnterpriseEnabled BIT DEFAULT(0) NOT NULL
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='RemovalContractor') < 1
BEGIN
	ALTER TABLE [dbo].[Client]
	ADD [RemovalContractor] [bit] NOT NULL
	CONSTRAINT [DF_Client_RemovalContractor]
	DEFAULT (0);
END
GO

IF (SELECT COUNT(DISTINCT ClientID) FROM Client c INNER JOIN AppointmentAirMonitoring aam ON c.ClientID = aam.RemovalContractorID WHERE c.RemovalContractor = 0) > 0
BEGIN
	UPDATE Client SET RemovalContractor = 1 WHERE ClientID IN (SELECT DISTINCT ClientID FROM Client c INNER JOIN AppointmentAirMonitoring aam ON c.ClientID = aam.RemovalContractorID WHERE c.RemovalContractor = 0) 
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaFloorplans') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaFloorplans] AS BEGIN SET NOCOUNT ON; END')
End
GO

ALTER PROCEDURE [dbo].[GetLegionellaFloorplans]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @DefaultTemplatePageLayout VARCHAR(100),
    @LegionellaID INT = 0,
    @FloorplanID INT = 0,
    @FloorplanAdditionalID INT = 0
/**********************************************************************
** Overview: Get Legionella Floorplans.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@DefaultTemplatePageLayout VARCHAR(100) = 'tpl_LegionellaFloorplansA4Landscape_tpl',
        --@LegionellaID INT = 0,
        --@FloorplanID INT = 0,
        --@FloorplanAdditionalID INT = 0
    -- END DEBUG
    
    -- Set IDs lower down the tree if IDs higher up the tree are set.
    IF @FloorplanAdditionalID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(f.LegionellaID, @LegionellaID)
        FROM
            FloorplanAdditional fa WITH (NOLOCK)
            INNER JOIN Floorplan f WITH (NOLOCK) ON fa.FloorplanID = f.FloorplanID
        WHERE fa.FloorplanAdditionalID = @FloorplanAdditionalID
    END
    IF @FloorplanID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM Floorplan WITH (NOLOCK)
        WHERE FloorplanID = @FloorplanID
    END
    
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)    
    
    DECLARE @FloorplanData TABLE (LegionellaID INT, FloorplanID INT, FloorNumber INT, HasFloorplanData INT, FloorplanDataContentType VARCHAR(200), HasAutocadData INT, AutocadDataContentType VARCHAR(200), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    INSERT INTO @FloorplanData (LegionellaID, FloorplanID, FloorNumber, HasFloorplanData, FloorplanDataContentType, HasAutocadData, AutocadDataContentType, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
		main.LegionellaID,
		main.FloorplanID,
		main.FloorNumber,
		main.HasFloorplanData,
		main.FloorplanDataContentType,
		main.HasAutocadData,
		main.AutocadDataContentType,
		main.DescriptionOverride,
		main.ShortDescriptionOverride,
		main.TemplatePageLayout_SearchString,
		main.CanvasSize
     FROM
        (
			SELECT
                l.LegionellaID,
                f.FloorplanID,
                f.FloorNumber,
                CASE WHEN f.FloorplanDataContentType IS NOT NULL THEN 1 ELSE 0 END [HasFloorplanData],
                f.FloorplanDataContentType,
                CASE WHEN f.AutocadDataContentType IS NOT NULL THEN 1 ELSE 0 END [HasAutocadData],
                f.AutocadDataContentType,
                f.DescriptionOverride,
                f.ShortDescriptionOverride,
                f.TemplatePageLayout_SearchString,
                f.CanvasSize
			FROM
                @LegionellaData l
                INNER JOIN Floorplan f WITH (NOLOCK) ON l.LegionellaID = f.LegionellaID
			WHERE
                ISNULL(f.ExcludeFromReport, 0) = 0
                                AND
                (f.FloorplanID = @FloorplanID OR @FloorplanID = 0)
		) main
    WHERE
         main.HasAutocadData = 1 
			OR 
		main.HasFloorplanData = 1
    
    DECLARE @FloorplanAdditionalData TABLE (LegionellaID INT, FloorplanAdditionalID INT, FloorplanID INT, FloorNumber INT, HasFloorplanData INT, FloorplanDataContentType VARCHAR(200), HasAutocadData INT, AutocadDataContentType VARCHAR(200), Description VARCHAR(MAX), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    INSERT INTO @FloorplanAdditionalData (LegionellaID, FloorplanAdditionalID, FloorplanID, FloorNumber, HasFloorplanData, FloorplanDataContentType, HasAutocadData, AutocadDataContentType, Description, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
		main.LegionellaID,
		main.FloorplanAdditionalID,
		main.FloorplanID,
		main.FloorNumber,
		main.HasFloorplanData,
		main.FloorplanDataContentType,
		main.HasAutocadData,
		main.AutocadDataContentType,
		main.Description,
		main.DescriptionOverride,
		main.ShortDescriptionOverride,
		main.TemplatePageLayout_SearchString,
		main.CanvasSize
	FROM
		(
			SELECT
				l.LegionellaID,
				fa.FloorplanAdditionalID,
				fa.FloorplanID,
				f.FloorNumber,
				CASE WHEN fa.FloorplanDataContentType IS NOT NULL THEN 1 ELSE 0 END [HasFloorplanData],
				fa.FloorplanDataContentType,
				CASE WHEN fa.AutocadDataContentType IS NOT NULL THEN 1 ELSE 0 END [HasAutocadData],
				fa.AutocadDataContentType,
				fa.Description,
				f.DescriptionOverride,
				f.ShortDescriptionOverride,
				f.TemplatePageLayout_SearchString,
				f.CanvasSize
			FROM
				@LegionellaData l
				INNER JOIN Floorplan f WITH (NOLOCK) ON l.LegionellaID = f.LegionellaID
				INNER JOIN FloorplanAdditional fa WITH (NOLOCK) ON f.FloorplanID = fa.FloorplanID
			WHERE
				ISNULL(fa.ExcludeFromReport, 0) = 0
								AND
				(fa.FloorplanAdditionalID = @FloorplanAdditionalID OR @FloorplanAdditionalID = 0)
		) main
    WHERE
		main.HasAutocadData = 1 
			OR 
		main.HasFloorplanData = 1
    
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), Additional BIT, FloorplanID INT, FloorplanRecordID INT, FloorplanAdditionalRecordID INT, DescriptionOverride VARCHAR(MAX), FloorplanSource VARCHAR(1000))    
    INSERT INTO @MainData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, Additional, FloorplanID, FloorplanRecordID, FloorplanAdditionalRecordID, DescriptionOverride, FloorplanSource)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        f.Additional,
        f.FloorplanID,
        f.FloorplanRecordID,
        f.FloorplanAdditionalRecordID,
        f.DescriptionOverride,
        f.FloorplanSource
    FROM
        @LegionellaData l
        LEFT JOIN Photo lp WITH (NOLOCK) ON l.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        INNER JOIN (
            SELECT
                0 [Additional],
				f.LegionellaID,
                f.FloorplanID [FloorplanID],
                f.FloorplanID [FloorplanRecordID],
                NULL [FloorplanAdditionalRecordID],
                f.DescriptionOverride,
                CASE WHEN f.HASAutocadData > 0
                THEN
					CASE WHEN f.AutocadDataContentType != 'application/pdf' -- Use the office Floorplan image or PDF
						THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(100)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                    ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(100)) + ']'
                    END
				ELSE
                    CASE WHEN f.FloorplanDataContentType != 'application/pdf' -- Use the mobile unit Floorplan image or PDF
						THEN '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(100)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use the site Floorplan image
					ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(100)) + ']'
                    END
                END [FloorplanSource]
            FROM
                @FloorplanData f
            
            UNION ALL -- Join together the queries. ALL means that duplicates can appear.

            SELECT
                1 [Additional],
				fa.LegionellaID,
                fa.FloorplanAdditionalID [FloorplanID],
                fa.FloorplanID [FloorplanRecordID],
                fa.FloorplanAdditionalID [FloorplanAdditionalRecordID],
                ISNULL(fa.Description, fa.DescriptionOverride) [DescriptionOverride],
                CASE WHEN fa.HasAutocadData  > 0
				THEN
					CASE WHEN fa.AutocadDataContentType != 'application/pdf' -- Use the office Floorplan image or PDF
						THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
					ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + ']'
                    END
				ELSE
                    CASE WHEN fa.FloorplanDataContentType != 'application/pdf' -- Use the mobile unit Floorplan image or PDF
						THEN '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use the site Floorplan image
					ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(100)) + ']'
					END
                END [FloorplanSource]
            FROM
                @FloorplanAdditionalData fa
        ) f ON l.LegionellaID = f.LegionellaID
    ORDER BY
        l.LegionellaStart,
        f.Additional    
    
    -- Start the main SELECT
    SELECT
        m.RowID,
        (SELECT COUNT(*) FROM @MainData) [TotalRows],
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaPhotoNo,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.LegionellaPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [LegionellaPhoto],
        m.Additional,
        m.FloorplanID,
        m.FloorplanRecordID,
        m.FloorplanAdditionalRecordID,
        m.DescriptionOverride,
        m.FloorplanSource,
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionella],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaEnd] 
    FROM
        @MainData m
    
    
    SET NOCOUNT OFF;
END

GO

IF NOT EXISTS (select TeamsV2SubTabID FROM TeamsV2SubTab WHERE TeamsV2TabID = (SELECT TeamsV2TabId FROM TeamsV2Tab WHERE TabText = 'System Preferences') AND TabText = 'Portal')
BEGIN
	INSERT INTO TeamsV2SubTab (Teamsv2TabID, TabText, [Order], IsMvcTab)
	SELECT (SELECT TeamsV2TabId FROM TeamsV2Tab WHERE TabText = 'System Preferences'), 'Portal', 7, 1
END
GO

IF NOT EXISTS(select 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE upper(TABLE_NAME) = 'Sitelog' AND upper(COLUMN_NAME) = 'LegionellaID')
BEGIN
	ALTER TABLE Sitelog
		ADD LegionellaID INT
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ReinspectionDateConfigExclusion'))
BEGIN
	CREATE TABLE [dbo].[ReinspectionDateConfigExclusion] (
		[ReinspectionDateConfigExclusionID] [int] IDENTITY (1, 1) NOT NULL,
		[SurveyTypeID] [int] NOT NULL,
	CONSTRAINT [PK_ReinspectionDateConfigExclusion]
		PRIMARY KEY CLUSTERED
		(
			[ReinspectionDateConfigExclusionID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY];
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ReinspectionDateConfig'))
BEGIN
	CREATE TABLE [dbo].[ReinspectionDateConfig] (
		[ReinspectionDateConfigID] [int] IDENTITY (1, 1) NOT NULL,
		[ElementIntMeaningID] [int] NOT NULL,
		[PropertyTypeID] [int] NULL,
		[ClientID] [int] NULL,
		CONSTRAINT [PK_ReinspectionDateConfig]
		PRIMARY KEY CLUSTERED
		(
			[ReinspectionDateConfigID] ASC
		)
		WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
		ON [PRIMARY]
		) ON [PRIMARY];
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'DuplicateSamplesForJob') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[DuplicateSamplesForJob] AS BEGIN SET NOCOUNT ON; END')
END

GO

ALTER PROCEDURE [dbo].[DuplicateSamplesForJob]
	@JobID INT
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	SET NOCOUNT ON;

SELECT
	COUNT(*) [Duplicates]
FROM
	(
		SELECT
			s.SampleID, s.SampleRef
		FROM
			Job j
			INNER JOIN JobEmployee je ON j.JobID = je.JobID
			INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
			INNER JOIN Room rm ON r.RegisterID = rm.RegisterID
			INNER JOIN Sample s ON rm.RoomID = s.RoomID
		WHERE
			j.JobID = @JobID
				AND
			s.SampleRef NOT LIKE '%*%' 
				AND 
			s.SampleRef NOT LIKE '%{%' 
				AND 
			s.AsSample = 0
	) a
	INNER JOIN Sample s2 ON a.SampleRef = s2.SampleRef AND a.SampleID != s2.SampleID AND s2.AsSample = 0
	INNER JOIN Room rm ON s2.RoomId = rm.RoomId
	INNER JOIN Register r ON rm.RegisterId = r.RegisterID
	INNER JOIN JobEmployee je ON r.JobEmployeeID = je.JobEmployeeID
	INNER JOIN Job j ON je.JobID = j.JobID

	SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name=''IVF_Import'') AND name=''OriginalJobNumber'') < 1 BEGIN
  ALTER TABLE TEAMS_IVF.dbo.IVF_Import
      ADD OriginalJobNumber VARCHAR(MAX) NULL
END'
	EXECUTE sp_executesql @sql
END
GO
SET NOCOUNT OFF;
GO

IF (SELECT COUNT(*) FROM sys.databases WHERE name = 'TEAMS_IVF') > 0 BEGIN
	DECLARE @sql NVARCHAR(MAX) = 'IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name=''IVF_Import'') AND name=''JobApproved'') < 1 BEGIN
  ALTER TABLE TEAMS_IVF.dbo.IVF_Import
      ADD JobApproved DATETIME NULL
END'
	EXECUTE sp_executesql @sql
END
GO
SET NOCOUNT OFF;
GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'UnapproveReport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[UnapproveReport] AS BEGIN SET NOCOUNT ON; END')
End

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[UnapproveReport]
    @JobNo INT,
    @JobID INT = NULL,
    @DeletePDFs BIT = 1
AS
BEGIN
    SET NOCOUNT ON;

    -- Declare variables for logic.
    DECLARE
        @ClientID INT,
        @SiteID INT

    -- Validate the parameters and set variables.
    IF NULLIF(@JobID, 0) IS NULL AND NULLIF(@JobNo, 0) IS NULL
    BEGIN
        RAISERROR('A JobID or JobNo is required.', 11, 1)
        RETURN;
    END
    IF NULLIF(@JobID, 0) IS NOT NULL AND NULLIF(@JobNo, 0) IS NOT NULL
    BEGIN
        RAISERROR('A JobID or JobNo is required, not both.', 11, 1)
        RETURN;
    END
    IF @JobID > 0
    BEGIN
        SELECT
            @ClientID = j.ClientID,
            @SiteID = j.SiteID
        FROM
            Job j WITH (NOLOCK)
        WHERE
            j.JobID = @JobID

        IF NULLIF(@ClientID, 0) IS NULL
        BEGIN
            RAISERROR('A job could not be found using the requested JobID.', 11, 1)
            RETURN;
        END
    END
    IF @JobNo > 0
    BEGIN
        SELECT
            @JobID = j.JobID,
            @ClientID = j.ClientID,
            @SiteID = j.SiteID
        FROM
            Job j WITH (NOLOCK)
        WHERE
            j.JobNo = @JobNo

        IF NULLIF(@JobID, 0) IS NULL
        BEGIN
            RAISERROR('A job could not be found using the requested job number.', 11, 1)
            RETURN;
        END
    END

	DECLARE @enterpriseUnapprovalJob INT = (SELECT COUNT(*) FROM EnterpriseDataTransfer WHERE JobID=@JobID)
	IF @enterpriseUnapprovalJob > 0 BEGIN
		
		If (SELECT COUNT(*) FROM EnterpriseDataTransfer WHERE JobID=@JobID AND IVF_ImportStatusTypeID IN (2,4)) = 0 BEGIN
			RAISERROR('The enterprise job is not in a state ready to be un-approved.', 11, 1)
			RETURN;
		END
		ELSE BEGIN
			IF (SELECT COUNT(*) FROM (SELECT ClientID,SiteID,JobID,Approved FROM Job WHERE JobID=@JobID) cj INNER JOIN Job j ON cj.SiteID=j.SiteID AND cj.ClientID=j.ClientID AND cj.JobID!=j.JobID AND cj.Approved < j.Approved INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register reg ON reg.JobEmployeeID = je.JobEmployeeID AND reg.DateApproved IS NOT NULL INNER JOIN Quote q ON q.JobID = j.JobID INNER JOIN Appointment a ON a.QuoteID = q.QuoteID INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID WHERE j.Approved IS NOT NULL AND j.Cancelled is null AND a.DateDeclined is null) > 0 BEGIN
				RAISERROR('The enterprise job is not in a state ready to be un-approved (not the latest job for client and site).', 11, 1)
				RETURN;
			END
		END
	END
	
    -- Validation complete and variables now set. Continue the main logic.

    -- Unapprove the register.
    UPDATE Register SET EmployeeID = NULL, DateApproved = NULL WHERE JobEmployeeID IN (SELECT JobEmployeeID FROM JobEmployee WITH (NOLOCK) WHERE JobID = @JobID)

    -- Unapprove the legionella test.
    UPDATE Legionella SET EmployeeID = NULL, DateApproved = NULL WHERE JobEmployeeID IN (SELECT JobEmployeeID FROM JobEmployee WITH (NOLOCK) WHERE JobID = @JobID)

    -- Unapprove the job.
    UPDATE Job SET Approved = NULL, SampleContentEmployeeID = NULL WHERE JobID = @JobID

    -- Logic to delete PDFs (if applicable).
    IF @DeletePDFs = 1
    BEGIN
        -- Delete the most recent survey PDF (in case there is more than one)
        UPDATE PDF SET DateDeleted = GETDATE() WHERE PDFId = (SELECT TOP 1 PDFId FROM PDF WITH (NOLOCK) WHERE JobID = @JobID AND Uploaded = 0 AND FileName NOT LIKE '%bsr%' AND FileName NOT LIKE '%ra%' AND FileName NOT LIKE '%asb5%' ORDER BY PDFId DESC)

        -- Delete the most recent bulk PDF (in case there is more than one)  
        UPDATE PDF SET DateDeleted = GETDATE() WHERE PDFId = (SELECT TOP 1 PDFId FROM PDF WITH (NOLOCK) WHERE JobID = @JobID AND Uploaded = 0 AND FileName LIKE '%bsr%' ORDER BY PDFId DESC)
    END

    -- Delete and reset the SampleComputedData.
    DELETE FROM SampleComputedData WHERE JobID = @JobID

    EXEC PopulateGuidSamples @ClientID = @ClientID, @SiteID = @SiteID
    EXEC CreateSiteSampleResultsOverviewSorting @ClientID = @ClientID, @SiteID = @SiteID

	IF @enterpriseUnapprovalJob > 0 BEGIN
		UPDATE EnterpriseDataTransfer
			SET IVF_ImportStatusTypeID =  CASE WHEN IVF_ImportStatusTypeID = 4 THEN 5 ELSE 6 END
		WHERE
			JobID=@JobID
				AND 
			IVF_ImportStatusTypeID IN (2,4)
	END

    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END

GO


If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Enterprise_RejectJob') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Enterprise_RejectJob] AS BEGIN SET NOCOUNT ON; END')
End


GO
/****** Object:  StoredProcedure [dbo].[Enterprise_RejectJob]    Script Date: 12/11/2019 09:09:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[Enterprise_RejectJob]
	  @IVF_ImportID INT

AS
BEGIN      
    SET NOCOUNT ON

	If (SELECT COUNT(*) FROM TEAMS_IVF.dbo.IVF_Import ivf_i WHERE IVF_ImportID=@IVF_ImportID AND IVF_ImportStatusTypeID IN (3)) = 0 BEGIN
		RAISERROR('The inbound job is not in a state ready to be rejected.', 16, 2)
		RETURN;
	END

	DECLARE @Internal_ImportID INT = (SELECT ISNULL((SELECT i.ImportID FROM Import i INNER JOIN TEAMS_IVF.dbo.IVF_Import ivf_i ON ivf_i.IVF_ImportID=i.IVF_ImportID WHERE ivf_i.IVF_ImportID=@IVF_ImportID),-1))
	DECLARE @JobID INT = (SELECT ISNULL((SELECT j.JobID FROM Job j WHERE j.ImportID=@Internal_ImportID),-1))

	IF @Internal_ImportID < 0 OR @JobID < 0
	BEGIN
		RAISERROR('No job found for this import.', 16, 2)
		RETURN;
	END
	ELSE BEGIN
		IF (SELECT COUNT(*) FROM (SELECT ClientID,SiteID,JobID,Approved FROM Job WHERE JobID=@JobID) cj INNER JOIN Job j ON cj.SiteID=j.SiteID AND cj.ClientID=j.ClientID AND cj.JobID!=j.JobID AND cj.Approved < j.Approved INNER JOIN JobEmployee je ON je.JobID = j.JobID INNER JOIN Register reg ON reg.JobEmployeeID = je.JobEmployeeID AND reg.DateApproved IS NOT NULL INNER JOIN Quote q ON q.JobID = j.JobID INNER JOIN Appointment a ON a.QuoteID = q.QuoteID INNER JOIN AppointmentSurvey asu ON asu.AppointmentID = a.AppointmentID WHERE j.Approved IS NOT NULL AND j.Cancelled is null AND a.DateDeclined is null) > 0 BEGIN
			RAISERROR('The imported job is not in a state ready to be rejected (not the latest job for client and site).', 16, 2)
			RETURN;
		END
	END

	DECLARE @ClientID INT = (Select ClientID FROM Job WHERE JobID=@JobID)
	DECLARE @SiteID INT = (Select SiteID FROM Job WHERE JobID=@JobID)
	EXEC DeleteImport @ImportID=@Internal_ImportID
	DELETE FROM SampleComputedData WHERE JobID = @JobID    
	EXEC PopulateGuidSamples @ClientID = @ClientID, @SiteID = @SiteID
    EXEC CreateSiteSampleResultsOverviewSorting @ClientID = @ClientID, @SiteID = @SiteID
	UPDATE TEAMS_IVF.dbo.IVF_Import SET IVF_ImportStatusTypeID=4 WHERE IVF_ImportID=@IVF_ImportID

    SET NOCOUNT OFF
      
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_GetJobSummaryForServer') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_GetJobSummaryForServer] AS BEGIN SET NOCOUNT ON; END')
END

GO

USE [TEAMS]
GO

/****** Object:  StoredProcedure [dbo].[Portfolio_GetJobSummaryForServer]    Script Date: 12/11/2019 14:33:43 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/* =====================================================================================================

			PLEASE READ THIS BEFORE MODIFYING THE Portfolio_GetJobSummaryForServer SP!
			==========================================================================

I've had to enclose the alter of this SP in an IF statement so that it does not get run on 
SQN Consulting as it errors (see Joe if you want to know why!).

You can't do an ALTER PROCEDURE BEGIN END block inside an IF BEGIN END block so I've used dynamic SQL!

												Nice!

If you need to change the ALTER statement you will need to modify it so that all single quotes (') are
doubled up with two single quotes ('').

									Thank you for you time, Paul!

===================================================================================================== */

IF (SELECT COUNT(*) FROM Config WHERE s__companyname='SQN Consulting') = 0 AND 
	(SELECT COUNT(*) FROM Config WHERE s__companyname='FM Project Consultants') = 0 AND
	(SELECT COUNT(*) FROM Config WHERE s__companyname='Thames Laboratories') = 0 BEGIN

	EXEC('
		ALTER PROCEDURE [dbo].[Portfolio_GetJobSummaryForServer]
			@PerPage INT = 30,
			@CurrentPage INT = 1,
			@ClientId INT = 0,
			@SiteId INT = 0,
			@StartDate DATETIME,
			@FinishDate DATETIME,
			@StatusTypeId VARCHAR(MAX) = '''',
			@StatusTypeIds VARCHAR(MAX) = ''''
		AS
		BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
			SET NOCOUNT ON;
    
			DECLARE @IdList TABLE (IVF_ImportID INT, IVF_ImportGroupID INT, Approved DATETIME)
			INSERT INTO @IdList (IVF_ImportID,IVF_ImportGroupID, Approved)
			SELECT
				a.IVF_ImportID,a.IVF_ImportGroupID, a.Approved
			FROM
				(
				SELECT
					imp.IVF_ImportID,
					imp.IVF_ImportGroupID,
					j.Approved,
					ROW_NUMBER() OVER (Partition By imp.IVF_ImportID Order by j.Approved DESC) [Identifier]
				FROM
					[TEAMS_IVF].dbo.IVF_Import imp
					INNER JOIN [TEAMS_IVF].dbo.IVF_ImportStatusType ist ON imp.IVF_ImportStatusTypeID=ist.IVF_ImportStatusTypeID
					LEFT OUTER JOIN Import i ON imp.IVF_ImportID=i.IVF_ImportID
					LEFT JOIN Job j ON i.ImportID = j.ImportID
				WHERE
					imp.JobApproved BETWEEN @StartDate AND @FinishDate
						AND
					CASE WHEN LEN(@StatusTypeIds) > 0 THEN CASE WHEN imp.IVF_ImportStatusTypeID IN (SELECT item FROM dbo.SplitStrings_Moden(@StatusTypeIds,'','')) THEN 1 ELSE 0 END ELSE 1 END = 1
						AND
					CASE WHEN @ClientID > 0 THEN CASE WHEN imp.ClientID=@ClientID THEN 1 ELSE 0 END ELSE 1 END = 1
						AND
					CASE WHEN @SiteId > 0 THEN CASE WHEN j.SiteID=@SiteId THEN 1 ELSE 0 END ELSE 1 END = 1
				GROUP BY
					imp.IVF_ImportID,
					imp.IVF_ImportGroupID,
					j.Approved
				) a
			WHERE
				a.[Identifier] = 1

			DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @IdList)

			;With Paging As 
			( 
				Select 
					CASE WHEN @PerPage = 0 THEN
						1
					ELSE
						Cast(Ceiling(Count(*) Over (Partition By '''') * 1.00 / @PerPage) as int)
					END As Pages, 

					CASE WHEN @PerPage = 0 THEN
						1
					ELSE
						((Row_Number() Over(Order By a.Approved DESC)-1) / @PerPage)+1
					END As Page, 

					Row_Number() Over(Order By a.Approved DESC) as Row_Num, 

					*
				From 
					(
						Select * FROM @IdList
					) a
			)

			SELECT		
				[Page] =				main.Page,
				[TotalRows] =			@TotalRowNumber,
				[Pages] =				main.Pages,
				[JobId] =				j.JobID,
				[JobNo] =				j.JobNo,
				[OriginalJobNo] =		imp.OriginalJobNumber,
				[ImportStatusTypeID] =	imp.IVF_ImportStatusTypeID,
				[ImportStatusType] =	ist.Description,
				[Approved] =			main.Approved,
				[IVF_ImportID] =		imp.IVF_ImportID,
				[Address] =				CASE WHEN si.SiteID IS NOT NULL THEN si.Address ELSE imps.[Site Address] END,
				[Postcode] =			CASE WHEN si.SiteID IS NOT NULL THEN si.Postcode ELSE imps.[Site Postcode] END,
				[UPRN] =				CASE WHEN si.SiteID IS NOT NULL THEN si.UPRN ELSE imps.[Site UPRN] END,
				[TEAMSUPRN] =			CASE WHEN si.SiteID IS NOT NULL THEN si.TEAMSUPRN ELSE imps.[TEAMSUPRN] END
			FROM
				Paging main
				INNER JOIN [TEAMS_IVF].dbo.IVF_Import imp ON main.IVF_ImportID=imp.IVF_ImportID
				INNER JOIN [TEAMS_IVF].dbo.IVF_ImportStatusType ist ON imp.IVF_ImportStatusTypeID=ist.IVF_ImportStatusTypeID
				LEFT OUTER JOIN Import i ON imp.IVF_ImportID=i.IVF_ImportID
				LEFT JOIN Job j ON i.ImportID = j.ImportID
				LEFT JOIN Site si ON j.SiteID = si.SiteID
				OUTER APPLY
				(
					SELECT
						d.[Site Address], d.[Site Postcode], d.[Site UPRN], d.TEAMSUPRN
					FROM
						[TEAMS_IVF].dbo.IVF_Data d
					WHERE
						d.IVF_ImportID=imp.IVF_ImportID
					GROUP BY
						d.[Site Address], d.[Site Postcode], d.[Site UPRN], d.TEAMSUPRN
				) imps
			Where 
				(
					main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
				) 
					Or 
				(
					@PerPage=0 
						And 
					@CurrentPage=0
				)
			Order By
				main.Row_Num


			SET NOCOUNT OFF;
		END'
	 )
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_GetJobSummaryForConsultancy') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_GetJobSummaryForConsultancy] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Portfolio_GetJobSummaryForConsultancy]
	@PerPage INT = 30,
    @CurrentPage INT = 1,
	@ClientId INT = 0,
	@SiteId INT = 0,
    @StartDate DATETIME,
	@FinishDate DATETIME,
	@StatusTypeId INT = 0,
	@StatusTypeIds VARCHAR(MAX) = ''
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
	DECLARE @s__ServerCode VARCHAR(3) = (SELECT s__ServerCode FROM Config)
	
	DECLARE @IdList TABLE (JobID INT, EnterpriseDataTransfer INT, Approved DATETIME)
	INSERT INTO @IdList (JobID,EnterpriseDataTransfer, Approved)
	SELECT
		a.JobID,a.EnterpriseDataTransferID, a.Approved
	FROM
		(
		SELECT
			j.JobID,
			j.Approved,
			edf.EnterpriseDataTransferID,
			ROW_NUMBER() OVER (Partition By j.JobID Order by edf.EnterpriseDataTransferID DESC) [Identifier]
		FROM
			EnterpriseDataTransfer edf
			INNER JOIN Job j ON edf.JobID = j.JobId
			INNER JOIN IVF_ImportStatusType ist ON edf.IVF_ImportStatusTypeID=ist.IVF_ImportStatusTypeID
		WHERE
			j.Approved BETWEEN @StartDate AND @FinishDate
				AND
			CASE WHEN LEN(@StatusTypeIds) > 0 THEN CASE WHEN edf.IVF_ImportStatusTypeID IN (SELECT item FROM dbo.SplitStrings_Moden(@StatusTypeIds,',')) THEN 1 ELSE 0 END ELSE 1 END = 1
				AND
			CASE WHEN @ClientID > 0 THEN CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END ELSE 1 END = 1
				AND
			CASE WHEN @SiteId > 0 THEN CASE WHEN j.SiteID=@SiteId THEN 1 ELSE 0 END ELSE 1 END = 1
		GROUP BY
			j.JobId,
			j.Approved,
			edf.EnterpriseDataTransferID
		) a
	WHERE
		a.[Identifier] = 1

	DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @IdList)

	;With Paging As 
	( 
		Select 
			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
			END As Pages, 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
				((Row_Number() Over(Order By a.Approved DESC)-1) / @PerPage)+1
			END As Page, 

			Row_Number() Over(Order By a.Approved DESC) as Row_Num, 

			*
		From 
			(
				Select * FROM @IdList
			) a
	)

	SELECT
		[Row_Total] =			@TotalRowNumber,
		[Pages] =				main.Pages,
		[Page] =				main.Page,
		[Row_Num] =				main.Row_Num,
		[JobId] =				j.JobID,
		[JobNo] =				j.JobNo,
		[OriginalJobNo] =		@s__ServerCode + '-' + dbo.FormatTeamsReference('J',j.JobNo),
		[ImportStatusTypeID] =	edf.IVF_ImportStatusTypeID,
		[ImportStatusType] =	ist.Description + CASE WHEN edf.DateFailed IS NOT NULL AND edf.ValidationFailedResult IS NOT NULL THEN ' ' + edf.ValidationFailedResult ELSE '' END,
		[Approved] =			main.Approved
	FROM
		Paging main
		INNER JOIN EnterpriseDataTransfer edf ON main.EnterpriseDataTransfer=edf.EnterpriseDataTransferID
		INNER JOIN Job j ON main.JobID=j.JobID
		INNER JOIN IVF_ImportStatusType ist ON edf.IVF_ImportStatusTypeID=ist.IVF_ImportStatusTypeID
	Where 
        (
			main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.Row_Num
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Export_ProjectJobSheet') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Export_ProjectJobSheet] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Export_ProjectJobSheet]
    @ClientID INT = NULL,
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteID INT = NULL,
    @Status VARCHAR(24) = '',
    @Other VARCHAR(MAX) = '',
    @Address VARCHAR(200) = '',
    @PhoneCalls INT = NULL,
    @Letters INT = NULL,
    @NoAccessAttempts INT = NULL
/**********************************************************************
** Overview: As Paged_projectJobSheet but for exporting, so :-
**   a) removed paging code, i.e. returns all matches
**   b) phone calls and letters one column each (via dynamic SQL)
** 
** PLEASE NOTE: The Change Log has now been removed as this has been added to SQL SVN instead.
** Please use the latest version from SVN before making changes. Commit the changes when done.
**********************************************************************/

AS
BEGIN
	SET ANSI_WARNINGS OFF
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;
    
    
	-- tidy input variables
	SELECT @ClientID = NULLIF(@ClientID, 0)
	SELECT @ProjectGroupID = NULLIF(@ProjectGroupID, 0)
	SELECT @ProjectID = NULLIF(@ProjectID, 0)
	SELECT @SiteID = NULLIF(@SiteID, 0)
	SELECT @Status = NULLIF(@Status, '')
	SELECT @Other = NULLIF(@Other, '')
	SELECT @Address = NULLIF(@Address, '')
	SELECT @PhoneCalls = NULLIF(@PhoneCalls, 0)
	SELECT @Letters = NULLIF(@Letters, 0)
	SELECT @NoAccessAttempts = NULLIF(@NoAccessAttempts, 0)
	
	-- ensure we have at least 1 filter ID (don't want to kill the server!)
	IF (@ClientID IS NULL) AND (@ProjectGroupID IS NULL) AND (@ProjectID IS NULL) AND (@SiteID IS NULL) BEGIN
		RAISERROR('No ID values passed to GetProjectJobSheet', 16, 1)
		RETURN
	END
	
	-- get ProjectIDs into a table to join to, based on @ProjectGroupID AND @ProjectID inputs
	CREATE TABLE #ProjectIDs (ProjectID INT)
	IF @ProjectID IS NOT NULL BEGIN
	
		INSERT
			#ProjectIDs
		SELECT
			@ProjectID
			
	END ELSE BEGIN
		
		INSERT
			#ProjectIDs
		SELECT
			ProjectID
		FROM
			Project
		WHERE
			ProjectGroupId = @ProjectGroupID
		
	END
	
	-- change #ProjectIDs into a comma separated string of IDs 
	DECLARE @ProjectIDsString VARCHAR(MAX)
	SELECT @ProjectIDsString = STUFF 
	((
		SELECT ',' + CONVERT(VARCHAR(20), ProjectID)
		FROM #ProjectIDs
		FOR XML PATH('')
	), 1, 1, '')
	
	-- select from existing ProjectJobSheet view into a temp table
	CREATE TABLE #JobSheetData (
		JobSheetDataID INT IDENTITY (1,1) NOT NULL
		, AppointmentID INT NULL
		, JobId INT NULL
		, SurveyTypeId INT NULL
		, ClientId INT NULL
		, ProjectId INT NULL
		, SiteId INT NULL
		, SurveyCompleted INT NULL
		, SurveyStillDue INT NULL
		, Approved INT NULL
		, SurveyOnTime INT NULL
		, SurveyOverTime INT NULL
		, Unscheduled INT NULL
		, SurveyCompletedRaw NVARCHAR(40) NULL
		, DueDateRaw NVARCHAR(40) NULL
		, ApprovedRaw NVARCHAR(40) NULL
		, SortOrder INT NOT NULL
		, Samples INT NULL
		, SampleResults INT NULL
		, [Status] VARCHAR(24)
		, Other VARCHAR(MAX)
		, [Address] VARCHAR(200)
		, PhoneCalls INT
		, Letters INT,
		NoAccessAttempts INT,
		JobNo VARCHAR(MAX),
		GroupName VARCHAR(MAX),
		UPRN VARCHAR(MAX),
		Postcode VARCHAR(MAX),
		Contact VARCHAR(MAX),
		Telephone VARCHAR(MAX),
		QuoteDate VARCHAR(50),
		ClientOrderNo VARCHAR(MAX),
		SurveyType VARCHAR(MAX),
		Surveyor VARCHAR(MAX),
		DueDate VARCHAR(50),
		SurveyStart VARCHAR(50),
		AnalysisCompleted VARCHAR(50),
		ApprovedBy VARCHAR(MAX),
		LastNoAccessDate DATETIME,
		LastJobEmployeeDate DATETIME,
		StatusDate VARCHAR(50)
	)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)
	SELECT @DynamicSQL = 'INSERT
		#JobSheetData
	SELECT
		pjs.AppointmentID
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyCompleted
		, CASE WHEN ISNULL(sft.Status, pjs.[Status]) = ''Unscheduled'' OR SortOrder = 3 THEN 0 ELSE 1 END AS SurveyStillDue
		, CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS Approved
		, CASE WHEN DueDate > SurveyCompleted AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOnTime
		, CASE WHEN DueDate < SurveyCompleted AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOverTime
		, CASE WHEN ISNULL(sft.Status, pjs.[Status]) = ''Unscheduled'' AND SortOrder <> 3 THEN 1 ELSE 0 END AS Unscheduled
		, SurveyCompleted
		, DueDate
		, Approved
		, SortOrder
		, Samples
		, SampleResults
		, CASE 
			WHEN SurveyCompleted IS NOT NULL THEN pjs.Status
			ELSE ISNULL(sft.Status, pjs.[Status])
		END [Status]
		, pjs.Other
		, pjs.[Address]
		, PhoneCalls
		, Letters,
		pjs.NoAccessAttempts,
		pjs.JobNo,
		pjs.GroupName,
		pjs.UPRN,
		pjs.Postcode,
		pjs.Contact,
		pjs.Telephone,
		pjs.QuoteDate,
		pjs.ClientOrderNo,
		pjs.SurveyType,
		pjs.Surveyor,
		pjs.DueDate,
		pjs.SurveyStart,
		pjs.AnalysisCompleted,
		pjs.ApprovedBy,
		pjs.LastNoAccessdate,
		pjs.LastJobEmployeeDate,
		pjs.StatusDate
	FROM
		ProjectJobSheet pjs
		LEFT JOIN Site si ON pjs.SiteID = si.SiteID
		LEFT JOIN StatusFilterType sft ON si.StatusFilterTypeID = sft.StatusFilterTypeID
	WHERE
		pjs.ProjectID IN (' + @ProjectIDsString + ') '

	-- add default order by
	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY SortOrder, JobNo, Address'

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- ClientID filter (not applied to view above as extra view filters slow performance)
	IF @ClientID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE ClientID <> @ClientID
	END
	
	-- SiteID filter (not applied to view above as extra view filters slow performance)
	IF @SiteID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE SiteID <> @SiteID
	END
	
	-- @PhoneCalls filter (not applied to view above as extra view filters slow performance)
	IF @PhoneCalls IS NOT NULL BEGIN
		
		IF @PhoneCalls > 3 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls < 4
		END

		IF @PhoneCalls < 4 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls <> @PhoneCalls
		END
	END

	-- @Letters filter (not applied to view above as extra view filters slow performance)
	IF @Letters IS NOT NULL BEGIN

		IF @Letters > 3 BEGIN
			DELETE FROM #JobSheetData WHERE Letters < 4
		END

		IF @Letters < 4 BEGIN
			DELETE FROM #JobSheetData WHERE Letters <> @Letters
		END
	END
	
	-- @NoAccessAttempts filter (not applied to view above as extra view filters slow performance)
	IF @NoAccessAttempts IS NOT NULL BEGIN

		IF @NoAccessAttempts > 3 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts < 4
		END

		IF @NoAccessAttempts < 4 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts <> @NoAccessAttempts
		END
	END

	-- work out max number of phone calls and letters columns required
	DECLARE @PhoneCallsColumnCount INT
	DECLARE @LettersColumnCount INT
	SELECT
		@PhoneCallsColumnCount = MAX(main.PhoneCalls)
		, @LettersColumnCount = MAX(main.Letters)
	FROM 
		#JobSheetData main	
    WHERE 
		( (main.[Status] = @Status) OR (@Status IS NULL) )
		AND ( (main.Other = @Other) OR (@Other IS NULL) )
		AND ( (main.[Address] = @Address) OR (@Address IS NULL) )
		
	--select @PhoneCallsColumnCount, @LettersColumnCount
	
	-- return raw data to front end - main fields
	SELECT @DynamicSQL = 'SELECT  
		main.JobNo AS [Job No.]
		, main.GroupName AS [Group Name]
		, main.UPRN
		, main.[Address]
		, main.Postcode AS [PostCode]
		, main.Other
		, main.Contact + '' '' + main.Telephone AS Contact
		, '''' AS Notes
		, main.[Status]
		, main.QuoteDate [Order Received]
		, main.PhoneCalls [Phone Calls Made]'
		
	-- draw a phone call column up to @PhoneCallsColumnCount
	DECLARE @PhoneCallsColumnCount_Loop INT
	SET @PhoneCallsColumnCount_Loop = 1
	WHILE (@PhoneCallsColumnCount_Loop <= @PhoneCallsColumnCount)
	BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ', ISNULL(
												(SELECT x.Text FROM (
												  SELECT
												     ROW_NUMBER() OVER (ORDER BY sc.DateCreated ASC) AS RowNumber
												     , sc.ContactText + '' (Created '' + CONVERT(VARCHAR(10), sc.DateCreated, 103) + '')'' AS Text
											      FROM
												     SiteContact sc
											      WHERE
											         sc.ContactTypeID = 1
											         AND sc.DateDeleted IS NULL
											         AND sc.SiteID = main.SiteID
											         AND ProjectID = main.ProjectID
											     ) x
											     WHERE x.RowNumber = ' + CONVERT(VARCHAR(20), @PhoneCallsColumnCount_Loop) + ' )
											   , '''') AS [Phone Call #' + CONVERT(VARCHAR(20), @PhoneCallsColumnCount_Loop) + ']'
		SET @PhoneCallsColumnCount_Loop = @PhoneCallsColumnCount_Loop + 1
	END

	SELECT @DynamicSQL = @DynamicSQL + ', main.Letters [Letters Sent]'
	
	-- draw a letter column up to @PhoneCallsColumnCount
	DECLARE @LettersColumnCount_Loop INT
	SET @LettersColumnCount_Loop = 1
	WHILE (@LettersColumnCount_Loop <= @LettersColumnCount)
	BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ', ISNULL(
												(SELECT x.Text FROM (
												  SELECT
												     ROW_NUMBER() OVER (ORDER BY sc.DateCreated ASC) AS RowNumber
												     , sc.ContactText + '' (Created '' + CONVERT(VARCHAR(10), sc.DateCreated, 103) + '')'' AS Text
											      FROM
												     SiteContact sc
											      WHERE
											         sc.ContactTypeID = 2
											         AND sc.DateDeleted IS NULL
											         AND sc.SiteID = main.SiteID
											         AND ProjectID = main.ProjectID
											     ) x
											     WHERE x.RowNumber = ' + CONVERT(VARCHAR(20), @LettersColumnCount_Loop) + ' )
											   , '''') AS [Letter #' + CONVERT(VARCHAR(20), @LettersColumnCount_Loop) + ']'
		SET @LettersColumnCount_Loop = @LettersColumnCount_Loop + 1
	END

	-- continue with main fields
	SELECT @DynamicSQL = @DynamicSQL + ', main.NoAccessAttempts AS [No Access]
		, main.StatusDate AS [Status Changed]
		, main.ClientOrderNo AS [Client Order No.]
		, main.SurveyType AS [Survey Type]
		, main.Surveyor
		, main.DueDate AS [Due Date]
		, main.SurveyStart AS [Survey Start]
		, main.SurveyCompletedRaw AS [Survey Completed]
		, main.AnalysisCompleted AS [Analysis Completed]
		, main.ApprovedRaw [Approved]
		, main.ApprovedBy AS [Approved By]
		, main.LastNoAccessDate
		, main.LastJobEmployeeDate
    FROM 
		#JobSheetData main	
		--INNER JOIN ProjectJobSheet pjs 
		--	ON ISNULL(main.AppointmentID, 0) = ISNULL(pjs.AppointmentID, 0)
		--	AND ISNULL(main.JobID, 0) = ISNULL(pjs.JobID, 0)
		--	AND ISNULL(main.SurveyTypeID, 0) = ISNULL(pjs.SurveyTypeID, 0)
		--	AND ISNULL(main.ClientID, 0) = ISNULL(pjs.ClientID, 0)
		--	AND ISNULL(main.ProjectID, 0) = ISNULL(pjs.ProjectID, 0)
		--	AND ISNULL(main.SiteID, 0) = ISNULL(pjs.SiteID, 0)
		--LEFT JOIN Appointment pjspa ON pjs.AppointmentID = pjspa.AppointmentID
    WHERE
		1 = 1'
	
	-- add proc filters to dynamic SQL
	IF @Status IS NOT NULL BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' AND main.[Status] = ''' + @Status + ''''  -- status filter
	END
	IF @Other IS NOT NULL BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' AND main.Other = ''' + @Other + ''''  -- other filter
	END
	IF @Address IS NOT NULL BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' AND main.[Address] = ''' + @Address + ''''  -- address filter
	END

	-- add ORDER BY to dynamic SQL
	--SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY pjs.SortOrder'
		
	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- drop temp tables
	DROP TABLE #ProjectIDs
	DROP TABLE #JobSheetData
    
    SET ANSI_WARNINGS ON;
    SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='b__UseNewEditRegister') < 1
BEGIN
	ALTER TABLE [dbo].[Config]
	ADD [b__UseNewEditRegister] [bit] NOT NULL
	CONSTRAINT [DF_Config_UseNewEditRegister]
	DEFAULT (0);
END
GO

IF (SELECT COUNT(*) FROM Config WHERE b__UseNewEditRegister = 1) = 0
BEGIN
	UPDATE Config SET b__UseNewEditRegister = 1 WHERE ConfigId = 1
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Surveying_v2.4.2.12')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Surveying_v2.4.2.12] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[EnterpriseSiteData_Surveying_v2.4.2.12]
(
      @ClientID INT,
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
      @IncludePhotoNoColumn BIT = 0,
      @ExcludeBinaryData BIT = 0,
      @JobReinspectionStructureID INT = 0,
      @FilterToJobID INT = 0,
	  @IncludeTableResponse VARCHAR(MAX) = 'Register,Floorplan,Room,Sample,Element,BuildingComponent,JobLink'
)
AS
BEGIN
	SET NOCOUNT ON;
                   
	If @RequestingServerCode != (SELECT s__ServerCode FROM Config) BEGIN
		SET @FilterToJobID = 0
	END

	IF @FilterToJobID > 0 BEGIN
	SET @JobReinspectionStructureID = (SELECT ISNULL((SELECT TOP 1 JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID=@FilterToJobID AND NoDataRequired=0),0))
		IF @JobReinspectionStructureID = 0 BEGIN
			SET @FilterToJobID = 0
		END
	END

    DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
                
    DECLARE @IDList TABLE (JobID INT, JobNo VARCHAR(MAX), UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
    Insert into @IDList (JobID,JobNo,UseRoomCode,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
    SELECT 
		j.JobID, TEAMS.dbo.FormatTeamsReference('J',j.JobNo),
		CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
		r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
		fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
		rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
		s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
    FROM 
        (
			SELECT 
				j.JobID, j.JobNo, j.SiteID
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
				INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
			WHERE
				j.SiteID = @SiteID
					AND
				j.ClientID = @ClientID
					AND
				a.DateDeclined IS NULL
					AND
				j.Approved IS NOT NULL
        ) j
        INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID AND r.DateRemoved IS NULL
        LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID AND fp.DateRemoved IS NULL
        LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID AND rm.DateRemoved IS NULL
        LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID AND s.DateRemoved IS NULL
        LEFT OUTER JOIN Element e2 WITH (NOLOCK) ON s.SampleID = e2.SampleID AND e2.ElementTypeID = 2
        LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON 
            (
                CASE WHEN s.SampleID IS NOT NULL AND jrsd.SampleID IS NOT NULL THEN
                    CASE WHEN jrsd.SampleID=s.SampleID THEN 1 ELSE 0 END
                ELSE
                    CASE WHEN rm.RoomID IS NOT NULL AND jrsd.RoomID IS NOT NULL THEN
		                CASE WHEN jrsd.RoomID=rm.RoomID THEN 1 ELSE 0 END
                    ELSE
                        CASE WHEN fp.FloorplanID IS NOT NULL AND jrsd.FloorplanID IS NOT NULL THEN
                            CASE WHEN jrsd.FloorplanID=fp.FloorplanID THEN 1 ELSE 0 END
                        ELSE
                            CASE WHEN jrsd.RegisterID=r.RegisterID THEN 1 ELSE 0 END
                        END
                    END
                END = 1
            )
                AND 
			jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
    WHERE 
        CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
            AND
        (CASE WHEN s.SampleID IS NOT NULL AND e2.ElementID IS NULL THEN 0 ELSE 1 END=1)

	IF @IncludeTableResponse LIKE '%Register%' BEGIN
		SELECT
			main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.ContentType,
			r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode,
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
							MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
						FROM
							@IDList idl
						GROUP BY
							RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RegisterID=_r.RegisterID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_r.Identifier = 1
				GROUP BY
					_r.RegisterID, BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode, CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
		WHERE
			r.[GUID] IS NOT NULL AND r.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Floorplan%' BEGIN
		SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
			main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
			CASE WHEN fp.FloorNumber = -200 THEN -2 ELSE fp.FloorNumber END [FloorNumber], 
			CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END END [FloorplanData],
			CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType],
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(      
				Select
					'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
							id.FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
						FROM
							@IDList id											
						GROUP BY
							id.FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
					) _f
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.FloorplanID=_f.FloorplanID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_f.Identifier = 1
									AND
					CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
				GROUP BY
					_f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
		WHERE
			fp.[GUID] IS NOT NULL AND fp.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Room%' BEGIN    
		SELECT
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
			rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included],
			rm.RoomGroupID [ServerRoomGroupID], rm.ParentGroupID [ServerParentGroupID], NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
							RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
						FROM
							@IDList id
						GROUP BY
							RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
					) _rm
				WHERE
					_rm.Identifier = 1
			) main
			INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
			LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RoomID=rm.RoomID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
		WHERE
			CASE WHEN @FilterToJobID > 0 THEN 
				CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 
			END = 1
				AND
			rm.[GUID] IS NOT NULL AND rm.[GUIDVersion] IS NOT NULL
		GROUP BY
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode, rm.RoomGroupID, rm.ParentGroupID,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
    END
	 
    DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT, Included INT, AssociatedJobNoList VARCHAR(MAX))
       
    INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion,Included,AssociatedJobNoList)
    SELECT
		main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included,  NULL [AssociatedJobNoList]
    FROM
        (      
			Select
				'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion,
				CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
			FROM
				(
					SELECT
						ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
					FROM
						@IDList id
					GROUP BY
						SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
				) _s
				LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.SampleID=_s.SampleID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
			WHERE
				_s.Identifier = 1
					AND
				CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
        ) main
        INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
        INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID AND gs.ClientID=@ClientID
    WHERE
        s.[GUID] IS NOT NULL AND s.[GUIDVersion] IS NOT NULL
    GROUP BY
        main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included

	CREATE TABLE #PhotoDataFromStore  (PhotoID INT, PhotoData IMAGE, TEAMS_StoreID INT, DataTaken INT)
	INSERT INTO #PhotoDataFromStore  (PhotoID,TEAMS_StoreID,DataTaken)
	SELECT
		p.PhotoID, p.TEAMS_StoreID, 0
	FROM
		@GuidSamples main
		INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
		INNER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
	WHERE
		p.TEAMS_StoreID IS NOT NULL
			AND
		@ExcludeBinaryData = 0
	GROUP BY 
		p.PhotoID, p.TEAMS_StoreID
	
	IF (SELECT COUNT(*) FROM #PhotoDataFromStore) > 0 BEGIN
		DECLARE @curTEAMS_StoreID INT=0
		DECLARE storeData CURSOR FOR
		SELECT 
			pdfsCur.TEAMS_StoreID
		FROM 
			#PhotoDataFromStore  pdfsCur 
		GROUP BY
			pdfsCur.TEAMS_StoreID
		
		OPEN storeData
		FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		WHILE @@FETCH_STATUS = 0 BEGIN
			DECLARE @DynamicSQL NVARCHAR(MAX) = 'SELECT p.PhotoID,p.PhotoData,pdfs.TEAMS_StoreID,1 FROM TEAMS_Store' + CAST(@curTEAMS_StoreID as varchar(MAX)) + '.dbo.Photo p INNER JOIN #PhotoDataFromStore pdfs ON p.PhotoID=pdfs.PhotoID WHERE pdfs.TEAMS_StoreID=' + CAST(@curTEAMS_StoreID as varchar(MAX))
			INSERT INTO #PhotoDataFromStore (PhotoID,PhotoData,TEAMS_StoreID,DataTaken)
			EXEC sp_executesql @DynamicSQL
			FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		END
		CLOSE storeData
		DEALLOCATE storeData
	END

	IF @IncludeTableResponse LIKE '%Sample%' BEGIN
		SELECT
			main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
			s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN pdfs.PhotoID IS NOT NULL THEN ISNULL(pdfs.PhotoData,p.PhotoData) ELSE p.PhotoData END END [PhotoData], 
			p.PhotoNo, REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample,  
			s.SampleResultID, s.SampleClassificationID, 
			sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
			s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included, main.AssociatedJobNoList [AssociatedJobNoList]
		FROM
			@GuidSamples main
			INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
			LEFT OUTER JOIN #PhotoDataFromStore pdfs ON s.PhotoID=pdfs.PhotoID AND pdfs.DataTaken = 1
			LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
			LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
	END

	IF @IncludeTableResponse LIKE '%Element%' BEGIN
		SELECT
			main.TableName,
			main.SampleID,
			main.RegisterID,
			main.ElementTypeID,
			main.ElementText
		FROM
		(
			SELECT
				'Element' [TableName],
				e.SampleID, 
				NULL [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,eim.Description)
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				@GuidSamples main
				INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
			WHERE
				e.ElementTypeID NOT IN (32)
			UNION
			SELECT
				'Element' [TableName],
				NULL [SampleID], 
				e.RegisterID [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,ISNULL(eim.ShortDescription,eim.Description))
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				(
					Select
							_r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
					FROM
					(
							SELECT
									ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
									MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
							FROM
									@IDList
							GROUP BY
									RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					WHERE
							_r.Identifier = 1
				) main
				INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
				INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
			WHERE
				CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
					1 
				ELSE
					CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
				END = 1
		) main
	END
   
   IF @IncludeTableResponse LIKE '%BuildingComponent%' BEGIN
		SELECT
			main.TableName,
			main.RoomID,
			main.ItemNo,
			main.[Description],
			main.[Position],
			main.[Comments]
		FROM
			(
				SELECT
					'BuildingComponent' [TableName],
					main.RoomID,
					bc.ItemNo,
					bc.[Description],
					bc.[Position],
					bc.[Comments]
				FROM
					(
						Select
							'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
						FROM
							(
								SELECT
									ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
									RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
								FROM
									@IDList
								GROUP BY
									RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
							) _rm
						WHERE
							_rm.Identifier = 1
					) main
					INNER JOIN BuildingComponent bc WITH (NOLOCK) ON main.RoomID=bc.RoomID
			) main
    END

	IF @IncludeTableResponse LIKE '%JobLink%' BEGIN
		SELECT
			'Ignore' [TableName], 
			id.JobNo, 
			id.SampleID, 
			id.ItemGUID,
			id.ItemGUIDVersion 
			--id.*
		FROM 
			@IDList id
		WHERE
			id.SampleID IS NOT NULL
				AND
			id.ItemGUID IS NOT NULL
		GROUP BY
			id.JobNo,
			id.SampleId,
			id.ItemGUID,
			id.ItemGUIDVersion
	END
	SET NOCOUNT OFF;

END
GO

IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name='IVF_Import') AND name='ConsultancyServerCode') < 1 BEGIN
	ALTER TABLE TEAMS_IVF.dbo.IVF_Import
		ADD ConsultancyServerCode VARCHAR(10) NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_Report_MobileUnitSummary') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_Report_MobileUnitSummary] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMS_Report_MobileUnitSummary]

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;   
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

----THIS IS FOR KERRY---
DECLARE @MobileUnit TABLE(SystemName VARCHAR(MAX), Category VARCHAR(MAX))
INSERT INTO @MobileUnit (SystemName, Category)
SELECT
	DISTINCT
	mat.SystemName,
	mat.Category
FROM
	MobileAuditTrail mat

SELECT 
	[SystemName] =			mu.SystemName,
	[LastUsed] =			dbo.cleandate(LastUsedDetails.Date) ,
	[Employee] =			ISNULL(LastUsedDetails.Employee, '') ,
	[UserBranch] =			ISNULL(LastUsedDetails.Branch, '') ,
	[LicenceKey] =			mulk.LicenceKey ,
	[SoftwareVersion] =		CASE
								WHEN Category = 1 THEN 'Mobile V1'
								WHEN Category = 3 THEN 'Mobile V2 AirTesting'
								WHEN Category = 4 THEN 'Mobile V2 Surveying'
								WHEN Category = 5 THEN 'Mobile V2 Legionella'
								ELSE
									CASE
										WHEN LastUsedDetails.DataScript = 'DataTransferService.cs' THEN 'Mobile V1'
										ELSE 'Mobile V2'
									END
							END + ' (' + LastUsedDetails.Version + ')',
							LastUsedDetails.date
FROM
	@MobileUnit mu
	LEFT JOIN Equipment eq ON eq.RefNo = mu.SystemName AND eq.EquipmentCategoryID = 19
	LEFT JOIN MobileUnitLicenceKey mulk	ON eq.MobileUnitLicenceKeyID = mulk.MobileUnitLicenceKeyID
	OUTER APPLY
	(
		SELECT
			TOP 1
			mat.DataQueryString [Version],
			mat.DateCreated [Date],
			e.FullName [Employee],
			bo.BranchOffice [Branch],
			mat.DataScript [DataScript]
		FROM
			MobileAuditTrail mat
			LEFT JOIN Employee e ON mat.EmployeeID = e.EmployeeID
			LEFT JOIN BranchOffice bo ON e.BranchOfficeID = bo.BranchOfficeID
		WHERE
			mat.SystemName = mu.SystemName
				AND
			mat.Category = mu.Category
		ORDER BY
			mat.DateCreated DESC
	) LastUsedDetails
WHERE
	LastUsedDetails.Version != '0.0.0.0' 
		AND
	mu.SystemName != ''
	   AND
	LastUsedDetails.Date BETWEEN (SELECT(GETDATE() - 60)) AND getdate() 
ORDER BY
	mu.SystemName

	SET NOEXEC OFF; 
	SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM CustomReport WHERE Report = 'TEAMS Licenses') = 0
BEGIN
	DECLARE
		@ReportName VARCHAR(100) = 'TEAMS Licenses',
		@StoredProcedure VARCHAR(100) = 'TEAMS_Report_MobileUnitSummary',
		@SubTabName VARCHAR(50) = 'TEAMS'

	INSERT INTO CustomReport (Report, ProcedureName, Notes, DateCreated, SubTabName, ManagerOnly, Transpose, ShowParametersInCSV, CopyRenameFile)
	VALUES (@ReportName, CASE WHEN LEN(@StoredProcedure) > 0 THEN @StoredProcedure ELSE '' END, '', GETDATE(), CASE WHEN LEN(@SubTabName) > 0 THEN @SubTabName ELSE NULL END, 1, 0, 0, 0)
END
GO

IF (Select COUNT(*) FROM TEAMS_IVF.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS_IVF.sys.tables Where name='IVF_Data') AND name='Room Code') < 1 BEGIN
	ALTER TABLE TEAMS_IVF.dbo.IVF_Data
		ADD [Room Code] VARCHAR(MAX) NULL
END
GO

IF (Select COUNT(*) FROM TEAMS.sys.[all_columns] Where object_id IN (Select object_id FROM TEAMS.sys.tables Where name='ImportData') AND name='Room Code') < 1 BEGIN
	ALTER TABLE TEAMS.dbo.ImportData
		ADD [Room Code] VARCHAR(MAX) NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'dgLegionellaNew')
BEGIN
    EXEC('CREATE VIEW[dbo].[dgLegionellaNew] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[dgLegionellaNew] AS 	
SELECT
	main.JobID,
	main.TypeID,
	main.Type,
	main.JobNo,
	main.Start,
	main.Finish,
	main.MonitoringSchedule,
	main.Due,
	main.ClientID,
	main.Client,
	main.SiteID,
	main.Site,
	main.Report,
	main.Photos,
	main.Plans,
	main.Documents,
	main.DateApproved,
	main.HasNotes,
	main.NotesInLastHour,
	main.NewGrid,
	main.Status,
	org.State [OrgState],
	main.PDF,
	main.EmployeeID,
	main.FullName,
	main.ProjectID,
	main.Identifier,
	main.LegionellaID,
	main.NoAccessID,
	main.naCreated,
	main.NoAccess
FROM
	(
		Select
			j.JobID,
			lt.LegionellaTypeID [TypeID],
			lt.Description [Type],
			'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
			MIN(l.LegionellaStart) [Start],
			MAX(l.LegionellaFinish) [Finish],
			MAX(l.MonitoringSchedule) [MonitoringSchedule],
			MAX(al.DueDate) [Due],
			c.ClientID,
			c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
			s.SiteID,
			s.Address [Site],
			CAST(CASE WHEN leginfo.ReportInformationID IS NULL THEN 0 ELSE 1 END as bit) [Report],
			CAST(CASE WHEN p.PhotoID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Photos],
			CAST(CASE WHEN fp.FloorplanID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Plans],
			CAST(CASE WHEN MIN(lsd.LegionellaSupportingDocumentId) IS NOT NULL THEN 1 ELSE 0 END as BIT) [Documents],
			l.DateApproved,
			0 [HasNotes],
			0 [NotesInLastHour],
			1 [NewGrid],
			j.Status [Status],
			--org.State [OrgState],
			CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT) [PDF],
			je.EmployeeID [EmployeeID],
			e.FullName [FullName],
			j.ProjectID,
			ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY MAX(l.LegionellaFinish) DESC) [Identifier],
			l.legionellaID,
			na.NoAccessID,
			na.Created [naCreated],
			CAST(CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN lt.LegionellaTypeID IS NOT NULL AND l.LegionellaID IS NOT NULL THEN l.LegionellaFinish END,na.Created) THEN 1 ELSE 0 END as BIT) [NoAccess]
		FROM
			Job j WITH (NOLOCK)
			INNER JOIN Client c WITH (NOLOCK) ON j.ClientID=c.ClientID
			INNER JOIN Site s WITH (NOLOCK) ON j.SiteID=s.SiteID
			INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
			INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID
			INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID = a.AppointmentID
			INNER JOIN LegionellaType lt WITH (NOLOCK) ON lt.LegionellaTypeID = al.LegionellaTypeID
			LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
			LEFT JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
			LEFT JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
			LEFT JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
			OUTER APPLY
			(
				SELECT TOP 1
					l.ReportInformationID
				FROM
					Job _j
					INNER JOIN JobEmployee je ON j.JobID = je.JobID
					INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
				WHERE
					_j.JobID = j.JobId
				ORDER BY
					l.ReportInformationID
			) legInfo
			LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.LegionellaID=l.LegionellaID AND (fp.AutocadDataContentType IS NOT NULL OR fp.FloorplanDataContentType IS NOT NULL)
			LEFT OUTER JOIN LegionellaSupportingDocument lsd WITH (NOLOCK) ON lsd.LegionellaID=l.LegionellaID
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON p.PhotoID=l.PhotoID
			LEFT OUTER JOIN PDF pf WITH (NOLOCK) ON pf.JobId=j.JobID AND pf.DateDeleted IS NULL
		Where
			a.DateDeclined IS NULL
		GROUP BY
			j.JobID,
			lt.LegionellaTypeID,
			lt.Description,
			j.JobNo,
			c.ClientID,
			c.Client,
			c.BranchName,
			s.SiteID,
			s.Address,
			l.DateApproved,
			j.Status,
			je.EmployeeID,
			e.FullName,
			CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT),
			fp.FloorplanID,
			p.PhotoID,
			leginfo.ReportInformationID,
			j.ProjectID,
			l.LegionellaID,
			na.NoAccessID,
			na.Created,
			CAST(CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN lt.LegionellaTypeID IS NOT NULL AND l.LegionellaID IS NOT NULL THEN l.LegionellaFinish END,na.Created) THEN 1 ELSE 0 END as BIT)
	 ) main
	 LEFT JOIN OfflineReportGeneration org WITH (NOLOCK) ON org.JobID = main.JobID AND org.Completed IS NULL
WHERE
	main.Identifier = 1

GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Client') AND name='ApprovalEmailLegionella') < 1
BEGIN
	ALTER TABLE [dbo].[Client]
	ADD
	[ApprovalEmailLegionella] [bit] NULL,
	[ApprovalEmailLegionella_AttachFile] [bit] NULL,
	[ApprovalEmailLegionella_USE_MainContact] [bit] NULL,
	[ApprovalEmailLegionella_AdditionalContactInfoID] [int] NULL
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'setDueDatesFromSubProjectOwner') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[setDueDatesFromSubProjectOwner] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[setDueDatesFromSubProjectOwner] 
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    BEGIN TRAN

	DECLARE @JobList TABLE (JobID INT, AppointmentTypeID INT, AppointmentSpecificID INT, ProjectGroupID INT, SiteWorkSurveysDueInDays INT, WorkFinished DATETIME, Due DATETIME, UncompletedCount INT, SampleReportsDueInDays DATETIME)
	INSERT INTO @JobList
    SELECT 
        j.JobID,
		app.AppointmentTypeID,
        appSurv.AppointmentSurveyID,
        prj.ProjectGroupId,
        prj.SiteWorkSurveysDueInDays,       
        overAllRegDetails.finishDate ,
        dbo.fn_AddWorkingDays(cast(ISNULL(prj.SiteWorkSurveysDueInDays,0) AS int),overAllRegDetails.finishDate),
        overAllRegDetails.uncompletedCount,
        CASE WHEN prj.SampleReportsDueInDays IS NOT NULL then
			dbo.fn_AddWorkingDays(cast(ISNULL(prj.SampleReportsDueInDays,0) AS int),overAllRegDetails.finishDate) 
		ELSE
			NULL
		END
    FROM 
        Job j
        INNER JOIN Project prj ON j.ProjectID = prj.ProjectID
        INNER JOIN ProjectGroup prjGrp ON prj.ProjectGroupId = prjGrp.ProjectGroupId
		        
        INNER JOIN JobEmployee je ON j.JobID = je.JobID
        INNER JOIN register reg ON je.JobEmployeeID = reg.JobEmployeeID
        inner JOIN Survey surv ON reg.SurveyID = surv.SurveyID
        inner JOIN SurveyType survt ON surv.SurveyTypeID = survt.SurveyTypeID
        INNER JOIN Quote q ON j.JobID = q.JobID
        inner JOIN Appointment app ON q.QuoteID = app.QuoteID
        inner JOIN AppointmentSurvey appSurv ON app.AppointmentID = appSurv.AppointmentID
        OUTER APPLY 
        (
            SELECT
                [finishDate] =			MAX(subreg.RegisterFinish),
                [uncompletedCount] =	SUM(
											CASE WHEN subreg.RegisterFinish IS NULL THEN 
												1   
											ELSE
												0
											END 
										)
            FROM 
                dbo.Job subj
                INNER JOIN dbo.JobEmployee subje ON subj.JobID = subje.JobID
                INNER JOIN register subreg ON subje.JobEmployeeID  = subreg.JobEmployeeID    --this also makes sure that it is a survey
            WHERE 
                subj.JobID = j.JobID
					AND 
				subreg.RegisterFinish IS NOT NULL
            GROUP BY
                subj.JobID
        )overAllRegDetails
    WHERE
        app.AppointmentID IS NOT NULL 
			AND 
		app.DateDeclined IS NULL
			AND 
		app.DateConfirmed IS NOT NULL
			AND 
		appSurv.DueDate IS NULL
			AND 
		overAllRegDetails.finishDate IS NOT NULL 
			AND 
		overAllRegDetails.uncompletedCount = 0

	-- Include legionella jobs
	INSERT INTO @JobList
	SELECT	
		j.JobID,
		app.AppointmentTypeID,
        appLeg.AppointmentLegionellaID,
        prj.ProjectGroupId,
        prj.SiteWorkSurveysDueInDays,       
        leg.finishDate [registerFinished],
        dbo.fn_AddWorkingDays(cast(ISNULL(prj.SiteWorkSurveysDueInDays,0) AS int), leg.finishDate) SurveyDueIn,
        leg.uncompletedCount,
        NULL
    FROM 
        Job j
        INNER JOIN Project prj ON j.ProjectID = prj.ProjectID
        INNER JOIN ProjectGroup prjGrp ON prj.ProjectGroupId = prjGrp.ProjectGroupId
		        
        INNER JOIN JobEmployee je ON j.JobID = je.JobID
        INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
        INNER JOIN Quote q ON j.JobID = q.JobID
        inner JOIN Appointment app ON q.QuoteID = app.QuoteID
        inner JOIN AppointmentLegionella appLeg ON app.AppointmentID = appLeg.AppointmentID
		OUTER APPLY 
        (
            SELECT
                [finishDate] =			MAX(subleg.LegionellaFinish),
                [uncompletedCount] =	SUM(
											CASE WHEN subLeg.LegionellaFinish IS NULL THEN 
												1   
											ELSE
												0
											END 
										)
            FROM 
                dbo.Job subj
                INNER JOIN dbo.JobEmployee subje ON subj.JobID = subje.JobID
                INNER JOIN legionella subleg ON subje.JobEmployeeID  = subleg.JobEmployeeID
            WHERE 
                subj.JobID = j.JobID
					AND 
				subleg.LegionellaFinish IS NOT NULL
            GROUP BY
                subj.JobID
        )leg
	WHERE
        app.AppointmentID IS NOT NULL 
			AND 
		app.DateDeclined IS NULL
			AND 
		app.DateConfirmed IS NOT NULL
			AND 
		appLeg.DueDate IS NULL
			AND 
		leg.finishDate IS NOT NULL 
			AND 
		leg.uncompletedCount = 0
	
	-- Survey Update
    UPDATE apps SET DueDate = lkup.Due, SamplesDueDate = lkup.SampleReportsDueInDays FROM 
	(
		SELECT DISTINCT AppointmentSpecificID, WorkFinished, Due, SampleReportsDueInDays FROM @JobList j WHERE j.AppointmentTypeID = 1
	) lkup 
	INNER JOIN appointmentsurvey apps ON lkup.AppointmentSpecificID = apps.[AppointmentSurveyID]

	-- Legionella Update
	UPDATE apps SET DueDate = lkup.Due FROM 
	(
		SELECT DISTINCT AppointmentSpecificID, WorkFinished, Due FROM @JobList j WHERE j.AppointmentTypeID = 9
	) lkup 
	INNER JOIN AppointmentLegionella apps ON lkup.AppointmentSpecificID = apps.AppointmentLegionellaID
    
COMMIT TRAN
    
END

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'getClientDDLBForApprovalEmail') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[getClientDDLBForApprovalEmail] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROCEDURE [dbo].[getClientDDLBForApprovalEmail](@clientid [int],@mode char(2))
AS
BEGIN 
    SET NOCOUNT ON 
    --debug
        --DECLARE
        --    @clientid [int]=561,
        --    @mode char(2)= 'L' --one of 'J,AT,L,BS,I'
    --debug
    
    DECLARE @groupType [int] = (SELECT [AdditionalContactTypeID] FROM [dbo].[AdditionalContactType] ct WHERE [ct].[ContactTypeDescription] = 'Contact Group')

    SELECT  
        [l].[contactType],
        [l].[description],
        l.selected
    FROM
    (
        SELECT
            0                           [sortOrder],
            'default'                   [contactType],
            NULL                        [contact],
            'Send emails to the contact assigned to the ' + CASE WHEN @mode='I' THEN 'Invoice' ELSE 'Job' END      [description],
            CASE 
                WHEN @clientid=0 THEN 
                    1
                WHEN @clientid>0 and exists(
                    SELECT 
                        'x'
                    FROM
                        [dbo].[Client] cl
                    WHERE
                        (cl.[ClientID] = @clientid) AND 
                        isnull(ApprovalEmailSurvey_USE_MainContact,0) = 0 AND
                        isnull(ApprovalEMailAirTest_USE_MainContact,0) = 0 AND
						isnull(ApprovalEmailLegionella_USE_MainContact,0) = 0 AND
                        isnull(ApprovalEmailBulk_USE_MainContact,0) = 0 and                
                        ISNULL(InvoiceCompleteEmail_USE_MainContact,0) = 0 AND
                        
                        (ApprovalEmailSurvey_AdditionalContactInfoID IS NULL) and
                        (ApprovalEMailAirTest_AdditionalContactInfoID IS NULL) and
			            (ApprovalEmailLegionella_AdditionalContactInfoID IS NULL) and
                        (ApprovalEmailBulk_AdditionalContactInfoID IS NULL) and
                        (InvoiceCompleteEmail_AdditionalContactInfoID IS NULL)
                ) THEN 
                    1
                ELSE
                    0         
            END [SELECTED]

        UNION
    
        SELECT
            1 [sortOrder],
            'client_' + CAST(clientid AS varchar) [contactType],
            [cl].[MainContact] [contact],
            'Send emails to ' + [cl].[Email] + '  ' + ISNULL('(' + [cl].[MainContact] + ')','') description,
            CASE WHEN (isnull(cl.ApprovalEmailSurvey_USE_MainContact,0)=1 AND @mode ='J')
                      OR (isnull(cl.ApprovalEMailAirTest_USE_MainContact,0)=1 AND @mode = 'AT')
                      OR (isnull(cl.ApprovalEmailLegionella_USE_MainContact,0)=1 AND @mode = 'L')
                      OR (isnull(cl.ApprovalEmailBulk_USE_MainContact,0)=1 AND @mode ='BS')
                      OR (isnull(cl.InvoiceCompleteEmail_USE_MainContact,0)=1 AND @mode = 'I')
            THEN
                1
            ELSE
                0         
            END [SELECTED]
        FROM
            [dbo].[Client] cl
        WHERE 
            [cl].[ClientID] = @clientid AND rtrim(ltrim(ISNULL(cl.email,'')))!=''
    
        UNION
    
        SELECT
            CASE WHEN [aci].[AdditionalContactTypeID] =1 THEN
                2
            ELSE
                CASE WHEN [aci].[AdditionalContactTypeID] =@groupType THEN
                    3
                ELSE
                    99
                END 
            END                      [sortOrder],
            CASE WHEN [aci].[AdditionalContactTypeID] =1 THEN
                'Contact_'
            ELSE
                CASE WHEN [aci].[AdditionalContactTypeID] =@groupType THEN
                    'ContactGroup_'
                ELSE
                    '_'
                END 
            END + CAST([aci].[AdditionalContactInfoID] AS varchar) [contactType],
            [aci].[Contact]         [contact],
            'Send emails to ' + 
            CASE WHEN [aci].[AdditionalContactTypeID] =1 THEN
                ISNULL([aci].[Email],'')  + ISNULL('(' + [aci].contact + ')','') 
            ELSE
                CASE WHEN [aci].[AdditionalContactTypeID] =@groupType THEN
                    ISNULL([aci].[Contact],'')
                ELSE
                    ''
                END 
            END description,

            CASE WHEN   (cl.ApprovalEmailSurvey_AdditionalContactInfoID = [aci].[AdditionalContactInfoID] AND @mode ='J')
                        OR (cl.ApprovalEMailAirTest_AdditionalContactInfoID = [aci].[AdditionalContactInfoID] AND @mode = 'AT')
					    OR (cl.ApprovalEMailLegionella_AdditionalContactInfoID = [aci].[AdditionalContactInfoID] AND @mode = 'L')
                        OR (cl.ApprovalEmailBulk_AdditionalContactInfoID    = [aci].[AdditionalContactInfoID] AND @mode ='BS')
                        OR (cl.InvoiceCompleteEmail_AdditionalContactInfoID = [aci].[AdditionalContactInfoID] AND @mode = 'I')
            THEN 
                1
            ELSE
                0
            END [SELECTED]
        FROM 
            client cl
            INNER JOIN [dbo].[AdditionalContactInfo] aci ON cl.clientid = [aci].[LinkID]
        WHERE
            cl.clientid = @clientid
            AND 
            ([aci].[AdditionalContactTypeID] =1 OR [aci].[AdditionalContactTypeID] = @groupType)
            AND 
            [aci].[Deleted] IS NULL
            AND [aci].[b_isTemp]=0
            AND ((
                    (rtrim(ltrim(ISNULL(aci.email,'')))!='' AND [aci].[AdditionalContactTypeID] =1) 
                )
                OR
                (
                    [aci].[AdditionalContactTypeID] = @groupType
                ))
                
   ) l (sortorder,contactType,contact,description,selected)
   ORDER BY 
       [l].[sortOrder],
       [l].contact
       
    SET NOCOUNT OFF
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='orgInstruction') AND name='disableOrgInstructionEmail') < 1
BEGIN
  ALTER TABLE orgInstruction
      ADD disableOrgInstructionEmail INT NULL
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ConfigTeamsSetup'))
BEGIN
	CREATE TABLE [dbo].[ConfigTeamsSetup](
		[ConfigTeamsSetupId] [int] IDENTITY(1,1) NOT NULL,
		[SmallBusinessEdition] [bit] NULL,
		[NewZealand] [bit] NULL,
		 CONSTRAINT [PK_ConfigTeamsSetup] PRIMARY KEY CLUSTERED 
		(
			[ConfigTeamsSetupId] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END 
GO

IF (SELECT COUNT(*) FROM ConfigTeamsSetup) < 1 
BEGIN
	INSERT INTO ConfigTeamsSetup (SmallBusinessEdition,NewZealand) VALUES (null,null)
END

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'orgInstructionScheduleByJob') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[orgInstructionScheduleByJob] AS BEGIN SET NOCOUNT ON; END')
End

GO

/****** Object:  StoredProcedure [dbo].[orgInstructionScheduleByJob]    Script Date: 16/01/2020 10:31:12 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER Proc [dbo].[orgInstructionScheduleByJob]
	@JobID int				,
	@orgInstructionID int	,
	@orgPriorityID int		,
	@orgStateID int			
As
Begin
	Set NoCount On;


	DECLARE @Company VARCHAR(MAX) = (Select top 1 s__CompanyName + ISNULL(' ' + s__BranchName,'') FROM Config)
	IF @orgInstructionID IS NOT NULL
	BEGIN
		-- Only get the jobID once it gets approved
		SET @JobID = (SELECT COALESCE((SELECT JobID FROM orgInstruction o WHERE o.orgInstructionID = @orgInstructionID AND o.orgStateID = 10 AND ISNULL(o.GenerationType, '') <> 'bulk sample report'), 0))
		IF @JobID > 0
		BEGIN
			DECLARE @EmailSendEnabled BIT = (SELECT	
												CASE WHEN l.legionellaID IS NOT NULL
													 THEN ISNULL(c.ApprovalEmailLegionella, 0)
													 ELSE ISNULL(c.ApprovalEmailSurvey, 0)
												END
											 FROM 
												Job j 
												INNER JOIN Client c ON j.ClientID = c.ClientID
												LEFT JOIN jobemployee je on je.jobid = j.jobid
												LEFT JOIN register r on r.jobemployeeid = je.JobEmployeeID
												LEFT JOIN legionella l on l.JobEmployeeID = je.JobEmployeeID 
											 WHERE j.JobID = @JobID
											  GROUP BY 
												CASE WHEN l.legionellaID IS NOT NULL
													 THEN ISNULL(c.ApprovalEmailLegionella, 0)
													 ELSE ISNULL(c.ApprovalEmailSurvey, 0)
												END
											 )

			IF @EmailSendEnabled = 1
			BEGIN

				IF (SELECT COUNT(*) FROM Job j inner join jobemployee je on j.jobid = je.jobid
					inner join register r on je.JobEmployeeID = r.JobEmployeeID where j.JobID = @JobID AND NULLIF(r.Status, '') IS NOT NULL) = 0
				BEGIN
					UPDATE r SET Status = 'Email alert triggered' FROM
						Job j
						inner join jobemployee je on j.jobid = je.jobid
						inner join register r on je.JobEmployeeID = r.JobEmployeeID
					where
						j.jobid = @JobID
				END

				IF (SELECT COUNT(*) FROM Job j INNER JOIN jobemployee je INNER JOIN legionella l ON l.jobemployeeid = je.jobemployeeid ON j.jobid = je.jobid
					WHERE j.JobID = @JobID AND l.legionellaid IS NOT NULL AND NULLIF(j.Status, '') IS NOT NULL) = 0
				BEGIN
					UPDATE j SET Status = 'Email alert triggered' FROM Job j WHERE j.jobid = @JobID
				END
			END
		END		
	END

	Set NoCount Off;
End

GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'PatTestDueDate') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[PatTestDueDate] AS BEGIN SET NOCOUNT ON; END')
End

GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- PatTestDueDate full function
ALTER FUNCTION [dbo].[PatTestDueDate] (@EquipmentID int)
RETURNS datetime
WITH EXECUTE AS CALLER
AS
BEGIN

	DECLARE @DueDate	DATETIME
	DECLARE @PatCheck	INT
	DECLARE @StartDate	DATETIME
      
	SELECT @PatCheck = PatCheck FROM Equipment WHERE EquipmentID = @EquipmentID
      
	IF EXISTS (SELECT 1 FROM PatTest WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL)
	BEGIN
		SELECT @StartDate = MAX(PatTestDate) FROM PatTest WHERE EquipmentID = @EquipmentID AND DateDeleted IS NULL AND NotInUse IS NULL

		SELECT @DueDate = CASE @PatCheck
			WHEN 0 THEN DATEADD(year,1,@StartDate)
			WHEN 1 THEN DATEADD(month,6,@StartDate)
			WHEN 2 THEN DATEADD(month,3,@StartDate)
			WHEN 3 THEN DATEADD(month,1,@StartDate)
			WHEN 4 THEN DATEADD(day,1,@StartDate)
			WHEN 5 THEN DATEADD(year,100,GETDATE())  -- really loads in the future!!
			WHEN 6 THEN DATEADD(year,2,@StartDate)
			WHEN 7 THEN DATEADD(year,5,@StartDate)
			WHEN 8 THEN DATEADD(year,3,@StartDate)
			WHEN 9 THEN DATEADD(YEAR,10,@StartDate)
			-- shouldn't ever hit the else!  but if we do just return the start date for safety
			ELSE @StartDate END
	END
	ELSE BEGIN
		SELECT @DueDate = null
	END

	RETURN @DueDate
END

GO

IF (SELECT COUNT(*) FROM QuoteVisitType WHERE Description = 'Legionella risk assessment') > 0
BEGIN
	UPDATE QuoteVisitType Set Description = 'Legionella' WHERE Description = 'Legionella risk assessment'
END
GO

IF (select COUNT(*) from appointment a inner join appointmentlegionella al on a.appointmentid = al.AppointmentID left join appointmentlegionellatype alt on al.AppointmentLegionellaID = alt.AppointmentLegionellaID where alt.AppointmentLegionellaTypeID is null AND al.LegionellaTypeID != 2) > 0
BEGIN
	INSERT INTO AppointmentLegionellaType (AppointmentLegionellaID, LegionellaTypeID)
	SELECT
		al.AppointmentLegionellaID, al.LegionellaTypeID
	FROM
		appointment a
		INNER JOIN appointmentlegionella al ON a.appointmentid = al.AppointmentID
		LEFT JOIN appointmentlegionellatype alt ON al.AppointmentLegionellaID = alt.AppointmentLegionellaID
	WHERE
		alt.AppointmentLegionellaTypeID is null
			AND
		al.LegionellaTypeID != 2
END

USE [TEAMS]
GO
If (SELECT COUNT(*) FROM TEAMS.sys.objects WHERE type = 'IF' AND name = 'SplitStrings_Moden') < 1 BEGIN
	EXEC('
		CREATE FUNCTION [dbo].[SplitStrings_Moden]
	(
	   @List NVARCHAR(MAX),
	   @Delimiter NVARCHAR(255)
	)
	RETURNS TABLE
	WITH SCHEMABINDING AS
	RETURN
	  WITH E1(N)        AS ( SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 
							 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 
							 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1),
		   E2(N)        AS (SELECT 1 FROM E1 a, E1 b),
		   E4(N)        AS (SELECT 1 FROM E2 a, E2 b),
		   E42(N)       AS (SELECT 1 FROM E4 a, E2 b),
		   cteTally(N)  AS (SELECT 0 UNION ALL SELECT TOP (DATALENGTH(ISNULL(@List,1))) 
							 ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) FROM E42),
		   cteStart(N1) AS (SELECT t.N+1 FROM cteTally t
							 WHERE (SUBSTRING(@List,t.N,1) = @Delimiter OR t.N = 0))
	  SELECT Item = SUBSTRING(@List, s.N1, ISNULL(NULLIF(CHARINDEX(@Delimiter,@List,s.N1),0)-s.N1,8000))
		FROM cteStart s;
	')
End
GO

USE [TEAMS_IVF]
GO
	If (SELECT COUNT(*) FROM TEAMS_IVF.sys.objects WHERE type = 'IF' AND name = 'SplitStrings_Moden') < 1 BEGIN
	EXEC('
		CREATE FUNCTION [dbo].[SplitStrings_Moden]
	(
	   @List NVARCHAR(MAX),
	   @Delimiter NVARCHAR(255)
	)
	RETURNS TABLE
	WITH SCHEMABINDING AS
	RETURN
	  WITH E1(N)        AS ( SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 
							 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 
							 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1),
		   E2(N)        AS (SELECT 1 FROM E1 a, E1 b),
		   E4(N)        AS (SELECT 1 FROM E2 a, E2 b),
		   E42(N)       AS (SELECT 1 FROM E4 a, E2 b),
		   cteTally(N)  AS (SELECT 0 UNION ALL SELECT TOP (DATALENGTH(ISNULL(@List,1))) 
							 ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) FROM E42),
		   cteStart(N1) AS (SELECT t.N+1 FROM cteTally t
							 WHERE (SUBSTRING(@List,t.N,1) = @Delimiter OR t.N = 0))
	  SELECT Item = SUBSTRING(@List, s.N1, ISNULL(NULLIF(CHARINDEX(@Delimiter,@List,s.N1),0)-s.N1,8000))
		FROM cteStart s;
	')
	End
GO
USE [TEAMS]
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_LegionellaSubProjectMonitoring') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_LegionellaSubProjectMonitoring] AS BEGIN SET NOCOUNT ON; END')
END

GO

ALTER PROCEDURE [dbo].[TEAMS_LegionellaSubProjectMonitoring]
	@StartTime DATETIME,
	@EndTime DATETIME,
	@SubProjectID INT,
	@LegionellaTypeID INT = 0,
	@ProjectGroupID INT = 0
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SET NOCOUNT ON;

IF @SubProjectID > 0
BEGIN
	SELECT
		j.AppointmentID,
		j.JobNo,
		si.Address,
		j.Created,
		j.[Work Complete] IsComplete
	FROM
		Site si
		INNER JOIN ProjectSite ps ON si.SiteID = ps.SiteID
		OUTER APPLY
		(
			SELECT
				a.AppointmentID,
				_j.JobNo,
				_j.JobID,
				MIN(a.StartTime) [Created],
				CASE
					WHEN je.JobEmployeeID IS NOT NULL THEN 1
					ELSE 0
				END [Work Complete]				
			FROM
				Job _j
				LEFT JOIN JobEmployee je ON _j.JobID = je.JobID
				LEFT JOIN Quote q ON _j.JobID = q.JobID
				LEFT JOIN Appointment a ON q.QuoteId = a.QuoteID AND a.DateDeclined IS NULL
				LEFT JOIN AppointmentLegionella al ON a.AppointmentID = al.AppointmentID
				LEFT JOIN AppointmentLegionellaType alt ON al.AppointmentLegionellaID = alt.AppointmentLegionellaID
			WHERE
				_j.SiteID = si.SiteID
					AND
				a.StartTime BETWEEN @StartTime AND DATEADD(DAY, 1, @EndTime)
					AND
				_j.ProjectID = @SubProjectID
					AND
				(alt.LegionellaTypeID = @LegionellaTypeID OR @LegionellaTypeID = 0)
			GROUP BY
				a.AppointmentID,
				_j.JobNo,
				_j.JobID,
				je.JobEmployeeID
		) j
	WHERE
		ps.ProjectID = @SubProjectID
END
ELSE
BEGIN
	SELECT
		j.AppointmentID,
		j.JobNo,
		si.Address,
		j.Created,
		j.[Work Complete] IsComplete
	FROM
		Site si
		INNER JOIN ProjectSite ps ON si.SiteID = ps.SiteID
		INNER JOIN Project p ON ps.ProjectID = p.ProjectID
		INNER JOIN ProjectGroup pg ON p.ProjectGroupId = pg.ProjectGroupId
		OUTER APPLY
		(
			SELECT
				a.AppointmentID,
				_j.JobNo,
				_j.JobID,
				MIN(a.StartTime) [Created],
				CASE
					WHEN je.JobEmployeeID IS NOT NULL THEN 1
					ELSE 0
				END [Work Complete]				
			FROM
				Job _j
				INNER JOIN Project p ON _j.ProjectID = p.ProjectID
				INNER JOIN ProjectGroup pg ON p.ProjectGroupId = pg.ProjectGroupId
				LEFT JOIN JobEmployee je ON _j.JobID = je.JobID
				LEFT JOIN Quote q ON _j.JobID = q.JobID
				LEFT JOIN Appointment a ON q.QuoteId = a.QuoteID AND a.DateDeclined IS NULL
				LEFT JOIN AppointmentLegionella al ON a.AppointmentID = al.AppointmentID
				LEFT JOIN AppointmentLegionellaType alt ON al.AppointmentLegionellaID = alt.AppointmentLegionellaID
			WHERE
				_j.SiteID = si.SiteID
					AND
				a.StartTime BETWEEN @StartTime AND DATEADD(DAY, 1, @EndTime)
					AND
				pg.ProjectGroupId = @ProjectGroupID
					AND
				(alt.LegionellaTypeID = @LegionellaTypeID OR @LegionellaTypeID = 0)
			GROUP BY
				a.AppointmentID,
				_j.JobNo,
				_j.JobID,
				je.JobEmployeeID
		) j
	WHERE
		pg.ProjectGroupId = @ProjectGroupID
END

	
	SET NOCOUNT OFF;
END

GO

IF (Select COUNT(*) FROM sys.columns c INNER JOIN sys.tables t ON c.object_id=t.object_id Where c.name='ReviewItemsChart' AND t.name='PortalUser') = 0
BEGIN
    ALTER TABLE [dbo].[PortalUser]
    ADD [ReviewItemsChart] [bit] NOT NULL
    CONSTRAINT [DF_PortalUser_ReviewItemsChart]
    DEFAULT (0);
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Surveying_v2.4.2.58')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Surveying_v2.4.2.58] AS BEGIN SET NOCOUNT ON; END')
END
GO


ALTER PROC [dbo].[EnterpriseSiteData_Surveying_v2.4.2.58]
(
      @ClientID INT,
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
      @IncludePhotoNoColumn BIT = 0,
      @ExcludeBinaryData BIT = 0,
      @JobReinspectionStructureID INT = 0,
      @FilterToJobID INT = 0,
	  @IncludeTableResponse VARCHAR(MAX) = 'Register,Floorplan,Room,Sample,Element,BuildingComponent,JobLink'
)
AS
BEGIN
	SET NOCOUNT ON;
                   
	If @RequestingServerCode != (SELECT s__ServerCode FROM Config) BEGIN
		SET @FilterToJobID = 0
	END

	IF @FilterToJobID > 0 BEGIN
	SET @JobReinspectionStructureID = (SELECT ISNULL((SELECT TOP 1 JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID=@FilterToJobID AND NoDataRequired=0),0))
		IF @JobReinspectionStructureID = 0 BEGIN
			SET @FilterToJobID = 0
		END
	END

    DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
                
    DECLARE @IDList TABLE (JobID INT, JobNo VARCHAR(MAX), UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
    Insert into @IDList (JobID,JobNo,UseRoomCode,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
    SELECT 
		j.JobID, TEAMS.dbo.FormatTeamsReference('J',j.JobNo),
		CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
		r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
		fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
		rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
		s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
    FROM 
        (
			SELECT 
				j.JobID, j.JobNo, j.SiteID
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
				INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
			WHERE
				j.SiteID = @SiteID
					AND
				j.ClientID = @ClientID
					AND
				a.DateDeclined IS NULL
					AND
				j.Approved IS NOT NULL
        ) j
        INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
        LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
        LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
        LEFT OUTER JOIN Element e2 WITH (NOLOCK) ON s.SampleID = e2.SampleID AND e2.ElementTypeID = 2
        LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON 
            (
                CASE WHEN s.SampleID IS NOT NULL AND jrsd.SampleID IS NOT NULL THEN
                    CASE WHEN jrsd.SampleID=s.SampleID THEN 1 ELSE 0 END
                ELSE
                    CASE WHEN rm.RoomID IS NOT NULL AND jrsd.RoomID IS NOT NULL THEN
		                CASE WHEN jrsd.RoomID=rm.RoomID THEN 1 ELSE 0 END
                    ELSE
                        CASE WHEN fp.FloorplanID IS NOT NULL AND jrsd.FloorplanID IS NOT NULL THEN
                            CASE WHEN jrsd.FloorplanID=fp.FloorplanID THEN 1 ELSE 0 END
                        ELSE
                            CASE WHEN jrsd.RegisterID=r.RegisterID THEN 1 ELSE 0 END
                        END
                    END
                END = 1
            )
                AND 
			jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
    WHERE 
        CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
            AND
        (CASE WHEN s.SampleID IS NOT NULL AND e2.ElementID IS NULL THEN 0 ELSE 1 END=1)

	IF @IncludeTableResponse LIKE '%Register%' BEGIN
		SELECT
			main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.ContentType,
			r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode,
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
							MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
						FROM
							@IDList idl
						GROUP BY
							RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RegisterID=_r.RegisterID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_r.Identifier = 1
				GROUP BY
					_r.RegisterID, BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode, CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
		WHERE
			r.[GUID] IS NOT NULL AND r.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Floorplan%' BEGIN
		SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
			main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
			CASE WHEN fp.FloorNumber = -200 THEN -2 ELSE fp.FloorNumber END [FloorNumber], 
			CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END END [FloorplanData],
			CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType],
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(      
				Select
					'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
							id.FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
						FROM
							@IDList id											
						GROUP BY
							id.FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
					) _f
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.FloorplanID=_f.FloorplanID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_f.Identifier = 1
									AND
					CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
				GROUP BY
					_f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
		WHERE
			fp.[GUID] IS NOT NULL AND fp.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Room%' BEGIN    
		SELECT
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
			rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included],
			rm.RoomGroupID [ServerRoomGroupID], rm.ParentGroupID [ServerParentGroupID], NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
							RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
						FROM
							@IDList id
						GROUP BY
							RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
					) _rm
				WHERE
					_rm.Identifier = 1
			) main
			INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
			LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RoomID=rm.RoomID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
		WHERE
			CASE WHEN @FilterToJobID > 0 THEN 
				CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 
			END = 1
				AND
			rm.[GUID] IS NOT NULL AND rm.[GUIDVersion] IS NOT NULL
		GROUP BY
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode, rm.RoomGroupID, rm.ParentGroupID,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
    END
	 
    DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT, Included INT, AssociatedJobNoList VARCHAR(MAX))
       
    INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion,Included,AssociatedJobNoList)
    SELECT
		main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included,  NULL [AssociatedJobNoList]
    FROM
        (      
			Select
				'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion,
				CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
			FROM
				(
					SELECT
						ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
					FROM
						@IDList id
					GROUP BY
						SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
				) _s
				LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.SampleID=_s.SampleID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
			WHERE
				_s.Identifier = 1
					AND
				CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
        ) main
        INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
        INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID AND gs.ClientID=@ClientID
    WHERE
        s.[GUID] IS NOT NULL AND s.[GUIDVersion] IS NOT NULL
    GROUP BY
        main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included

	CREATE TABLE #PhotoDataFromStore  (PhotoID INT, PhotoData IMAGE, TEAMS_StoreID INT, DataTaken INT)
	INSERT INTO #PhotoDataFromStore  (PhotoID,TEAMS_StoreID,DataTaken)
	SELECT
		p.PhotoID, p.TEAMS_StoreID, 0
	FROM
		@GuidSamples main
		INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
		INNER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
	WHERE
		p.TEAMS_StoreID IS NOT NULL
	GROUP BY 
		p.PhotoID, p.TEAMS_StoreID
	
	IF (SELECT COUNT(*) FROM #PhotoDataFromStore ) > 0 BEGIN
		DECLARE @curTEAMS_StoreID INT=0
		DECLARE storeData CURSOR FOR
		SELECT 
			pdfsCur.TEAMS_StoreID
		FROM 
			#PhotoDataFromStore  pdfsCur 
		GROUP BY
			pdfsCur.TEAMS_StoreID
		
		OPEN storeData
		FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		WHILE @@FETCH_STATUS = 0 BEGIN
			DECLARE @DynamicSQL NVARCHAR(MAX) = 'SELECT p.PhotoID,p.PhotoData,pdfs.TEAMS_StoreID,1 FROM TEAMS_Store' + CAST(@curTEAMS_StoreID as varchar(MAX)) + '.dbo.Photo p INNER JOIN #PhotoDataFromStore pdfs ON p.PhotoID=pdfs.PhotoID WHERE pdfs.TEAMS_StoreID=' + CAST(@curTEAMS_StoreID as varchar(MAX))
			INSERT INTO #PhotoDataFromStore (PhotoID,PhotoData,TEAMS_StoreID,DataTaken)
			EXEC sp_executesql @DynamicSQL
			FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		END
		CLOSE storeData
		DEALLOCATE storeData
	END

	IF @IncludeTableResponse LIKE '%Sample%' BEGIN
		SELECT
			main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
			s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN pdfs.PhotoID IS NOT NULL THEN ISNULL(pdfs.PhotoData,p.PhotoData) ELSE p.PhotoData END END [PhotoData], 
			p.PhotoNo, REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample,  
			s.SampleResultID, s.SampleClassificationID, 
			sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
			s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included, main.AssociatedJobNoList [AssociatedJobNoList]
		FROM
			@GuidSamples main
			INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
			LEFT OUTER JOIN #PhotoDataFromStore pdfs ON s.PhotoID=pdfs.PhotoID AND pdfs.DataTaken = 1
			LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
			LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
	END

	IF @IncludeTableResponse LIKE '%Element%' BEGIN
		SELECT
			main.TableName,
			main.SampleID,
			main.RegisterID,
			main.ElementTypeID,
			main.ElementText
		FROM
		(
			SELECT
				'Element' [TableName],
				e.SampleID, 
				NULL [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,ISNULL(eim.ShortDescription,eim.Description))
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(ISNULL(eime.Description,eimso.Description),eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				@GuidSamples main
				INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
				LEFT OUTER JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID=e.ElementIntMeaningSubOptionID
			WHERE
				e.ElementTypeID NOT IN (32)
			UNION
			SELECT
				'Element' [TableName],
				NULL [SampleID], 
				e.RegisterID [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,ISNULL(eim.ShortDescription,eim.Description))
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				(
					Select
							_r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
					FROM
					(
							SELECT
									ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
									MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
							FROM
									@IDList
							GROUP BY
									RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					WHERE
							_r.Identifier = 1
				) main
				INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
				INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
			WHERE
				CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
					1 
				ELSE
					CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
				END = 1
		) main
	END
   
   IF @IncludeTableResponse LIKE '%BuildingComponent%' BEGIN
		SELECT
			main.TableName,
			main.RoomID,
			main.ItemNo,
			main.[Description],
			main.[Position],
			main.[Comments]
		FROM
			(
				SELECT
					'BuildingComponent' [TableName],
					main.RoomID,
					bc.ItemNo,
					bc.[Description],
					bc.[Position],
					bc.[Comments]
				FROM
					(
						Select
							'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
						FROM
							(
								SELECT
									ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
									RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
								FROM
									@IDList
								GROUP BY
									RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
							) _rm
						WHERE
							_rm.Identifier = 1
					) main
					INNER JOIN BuildingComponent bc WITH (NOLOCK) ON main.RoomID=bc.RoomID
			) main
    END

	IF @IncludeTableResponse LIKE '%JobLink%' BEGIN
		SELECT
			'Ignore' [TableName], 
			id.JobNo, 
			id.SampleID, 
			id.ItemGUID,
			id.ItemGUIDVersion 
			--id.*
		FROM 
			@IDList id
		WHERE
			id.SampleID IS NOT NULL
				AND
			id.ItemGUID IS NOT NULL
		GROUP BY
			id.JobNo,
			id.SampleId,
			id.ItemGUID,
			id.ItemGUIDVersion
	END
	SET NOCOUNT OFF;

END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='GuidedDataState'))
	BEGIN
		CREATE TABLE [dbo].[GuidedDataState](
			[GuidedDataStateID] [int] IDENTITY(1,1) NOT NULL,
			[SiteID] [int] NOT NULL,
			[ClientID] [int] NOT NULL,
			[DateChecked] [datetime] NOT NULL,
		 CONSTRAINT [PK_GuidedDataStateID] PRIMARY KEY CLUSTERED 
		(
			[GuidedDataStateID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END


IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='GuidedDataStateEntry'))
	BEGIN
		CREATE TABLE [dbo].[GuidedDataStateEntry](
			[GuidedDataStateEntryID] [int] IDENTITY(1,1) NOT NULL,
			[GuidedDataStateID] [int] NOT NULL,
			[GuidedDataStateTypeID] [int] NOT NULL,
			[ErrorCount] [int] NOT NULL,
		 CONSTRAINT [PK_GuidedDataStateEntry] PRIMARY KEY CLUSTERED 
		(
			[GuidedDataStateEntryID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='GuidedDataStateType'))
	BEGIN
		CREATE TABLE [dbo].[GuidedDataStateType](
			[GuidedDataStateTypeID] [int] NOT NULL,
			[Description] [varchar](max) NOT NULL,
			[Note] [varchar](max) NOT NULL,
			[Severity] [int] NOT NULL,
			[SeverityDescription] [varchar](max) NOT NULL,
			[SeverityLegend] [varchar](max) NOT NULL,
		 CONSTRAINT [PK_GuidedDataStateType] PRIMARY KEY CLUSTERED 
		(
			[GuidedDataStateTypeID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END 
	
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	1,'No issues found','The current checks resulted in no issues.',0,'None','' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=1)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	2,'As Sample missing referenced physical sample','The parent sample could not be found on the system.',5,'Critical - Contact TEAMS Support','Unable to fix the data or book a re-inspection.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=2)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	3,'As Sample referenced physical sample not included','The parent sample has been disconnected from the client/site.',1,'Low','The booking process is likely to fix any issues.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=3)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	4,'Item marked as Strongly Presumed with no Sample Ref','Strongly presumemed items are AsSamples and as such require a SampleRef.',1,'Low','The booking process is likely to fix any issues.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=4)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	5,'Duplicate Physical Sample','Multiple, identical physical samples identified.',4,'Critical','Unable to book a re-inspection. Duplicates need to be merged before proceeding.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=5)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	6,'Duplicate Register Item No','Multiple, identical RegisterItemNo found.',3,'High','Appointments can be booked but data transfer to an Enterprise client could fail.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=6)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	7,'Duplicate Room Number on the same floor','Multiple, identical room numbers found.',2,'Medium','Appointments can be booked and duplicates fixed prior to the next approval.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=7)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	8,'Multiple buildings with same designation','Multiple, identical buildings found.',2,'Medium','Appointments can be booked and duplicates fixed prior to the next approval.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=8)=0
INSERT INTO GuidedDataStateType (GuidedDataStateTypeID,Description,Note,Severity,SeverityDescription,SeverityLegend) SELECT	9,'Multiple floors with the same floor number','Multiple floors with the same floor number on the same building.',2,'Medium','Appointments can be booked and duplicates fixed prior to the next approval.' WHERE (SELECT COUNT(*) FROM GuidedDataStateType WHERE GuidedDataStateTypeID=9)=0


IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='util_UpdateGuidedDataStatePriority'))
	BEGIN
		CREATE TABLE [dbo].[util_UpdateGuidedDataStatePriority](
			[util_UpdateGuidedDataStatePriorityID] [int] IDENTITY(1,1) NOT NULL,
			[ClientID] [int] NOT NULL,
			[Order] [INT] NOT NULL,
		 CONSTRAINT [PK_util_UpdateGuidedDataStatePriorityID] PRIMARY KEY CLUSTERED 
		(
			[util_UpdateGuidedDataStatePriorityID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification] 
		(
			[EnterpriseSiteData_ModificationID] [int] IDENTITY (1, 1) NOT NULL,
			[ClientID] [int] NOT NULL,
			[SiteID] [int] NOT NULL,
			[EmployeeID] [int] NOT NULL,
			[DateCreated] [datetime] DEFAULT(GETDATE()) NOT NULL,
			[DateCompleted] [datetime] NULL,
			[DateDiscarded] [datetime] NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_ModificationID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_Register'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_Register] 
		(
			[EnterpriseSiteData_Modification_RegisterID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[RegisterID] [int] NOT NULL,
			[BuildingGUID] [VARCHAR] (MAX) NOT NULL,
			[BuildingGUIDVersion] [int] NOT NULL,
			[PhotoID]  [int] NULL,
			[PhotoData] [image]  NULL,
			[ContentType] [varchar] (MAX)  NULL,
			[RegisterStart] [datetime] NOT NULL,
			[RegisterFinish] [datetime] NOT NULL,
			[BuildingDesignation] [VARCHAR] (MAX) NULL,
			[Notes] [VARCHAR] (MAX) NULL,
			[SystemName] [VARCHAR] (MAX) NULL,
			[UseRoomCode] [BIT] DEFAULT(0) NOT NULL,
			[Included] [INT] DEFAULT(0) NOT NULL,
			[AssociatedJobNoList] [varchar] (max) NULL,
			[NewBuildingGUID] [VARCHAR] (MAX) NULL,
			[MergedWithID] [INT] NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_Register]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_RegisterID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_Floorplan'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_Floorplan] 
		(
			[EnterpriseSiteData_Modification_FloorplanID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[ParentGUID] [VARCHAR] (MAX) NOT NULL,
			[FloorplanID] [int] NOT NULL,
			[FloorGUID] [VARCHAR] (MAX) NOT NULL,
			[FloorGUIDVersion] [int] NOT NULL,
			[FloorNumber] [INT] NOT NULL,
			[FloorplanData] [image]  NULL,
			[ContentType] [varchar] (MAX)  NULL,
			[Included] [INT] DEFAULT(0) NOT NULL,
			[AssociatedJobNoList] [varchar] (max) NULL,
			[NewFloorGUID] [VARCHAR] (MAX) NULL,
			[MergedWithID] [INT] NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_Floorplan]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_FloorplanID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_Room'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_Room] 
		(
			[EnterpriseSiteData_Modification_RoomID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[ParentGUID] [VARCHAR] (MAX) NOT NULL,
			[RoomID] [int] NOT NULL,
			[RoomGUID] [VARCHAR] (MAX) NOT NULL,
			[RoomGUIDVersion] [int] NOT NULL,
			[Number] [int] NOT NULL,
			[Description] [VARCHAR] (MAX) NULL,
			[Notes] [VARCHAR] (MAX) NULL,
			[RandD] [BIT] DEFAULT(0) NOT NULL,
			[Inaccesible] [BIT] DEFAULT(0) NOT NULL,
			[RoomCode] [VARCHAR] (MAX) NULL,
			[Included] [INT] DEFAULT(0) NOT NULL,
			[ServerRoomGroupID] [INT] NULL,
			[ServerParentGroupID] [INT] NULL,
			[AssociatedJobNoList] [varchar] (max) NULL,
			[NewRoomGUID] [VARCHAR] (MAX) NULL,
			[MergedWithID] [INT] NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_Room]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_RoomID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_Sample'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_Sample] 
		(
			[EnterpriseSiteData_Modification_SampleID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[ParentGUID] [VARCHAR] (MAX) NOT NULL,
			[SampleID] [int] NOT NULL,
			[ItemGUID] [VARCHAR] (MAX) NOT NULL,
			[ItemGUIDVersion] [int] NOT NULL,
			[RegisterItemNo] [int] NOT NULL,
			[PhotoID] [int] NULL,
			[PhotoData] [image]  NULL,
			[PhotoNo] [int] NULL,
			[SampleRef] [VARCHAR] (MAX) NULL,
			[AsSample] [BIT] DEFAULT(0) NOT NULL,
			[SampleResultID] [int] DEFAULT(0) NULL,
			[SampleClassificationID] [int] DEFAULT(0) NULL,
			[SampleClassificationExtended] [VARCHAR] (MAX) NULL,
			[Notes] [VARCHAR] (MAX) NULL,
			[EmployeeID] [INT] DEFAULT(0) NOT NULL,
			[Included] [INT] DEFAULT(0) NOT NULL,
			[AssociatedJobNoList] [varchar] (max) NULL,
			[NewItemGUID] [VARCHAR] (MAX) NULL,
			[MergedWithID] [INT] NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_Sample]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_SampleID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
		TEXTIMAGE_ON [PRIMARY];
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_Element'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_Element] 
		(
			[EnterpriseSiteData_Modification_ElementID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[SampleID] [int] NULL,
			[RegisterID] [int] NULL,
			[ElementTypeID] [int] NOT NULL,
			[ElementText] [VARCHAR] (MAX) NOT NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_Element]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_ElementID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_JobLink'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_JobLink] 
		(
			[EnterpriseSiteData_Modification_JobLinkID] [int] IDENTITY (1, 1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int]  NOT NULL,
			[TableName] [VARCHAR] (MAX) NOT NULL,
			[SampleID] [int] NULL,
			[ItemGUID] [VARCHAR] (MAX) NOT NULL,
			[ItemGUIDVersion] [int] NOT NULL,
			CONSTRAINT [PK_EnterpriseSiteData_Modification_JobLink]
			PRIMARY KEY CLUSTERED
			(
				[EnterpriseSiteData_Modification_JobLinkID] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
		) ON [PRIMARY]
	END 

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteData_Modification_AuditTrail'))
	BEGIN
		CREATE TABLE [dbo].[EnterpriseSiteData_Modification_AuditTrail](
			[EnterpriseSiteData_Modification_AuditTrailID] [int] IDENTITY(1,1) NOT NULL,
			[EnterpriseSiteData_ModificationID] [int] NULL,
			[ApprovedDate] [datetime] NOT NULL,
			[RegisterID] [int] NOT NULL,
			[BuildingGUID] [varchar](max) NOT NULL,
			[BuildingGUIDVersion] [int] NOT NULL,
			[FloorplanID] [int] NULL,
			[FloorGUID] [varchar](max) NULL,
			[FloorGuidVersion] [int] NULL,
			[RoomID] [int] NULL,
			[RoomGUID] [varchar](max) NULL,
			[RoomGUIDVersion] [int] NULL,
			[SampleID] [int] NULL,
			[ItemGUID] [varchar](max) NULL,
			[ItemGUIDVersion] [int] NULL,
			[DateCreated] [datetime] DEFAULT (getdate()) NOT NULL,
		 CONSTRAINT [PK_EnterpriseSiteData_Modification_AuditTrail] PRIMARY KEY CLUSTERED 
		(
			[EnterpriseSiteData_Modification_AuditTrailID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'util_UpdateGuidedDataState')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[util_UpdateGuidedDataState] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[util_UpdateGuidedDataState] 
      @ClientID INT,
	  @SiteID INT
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE @GuidedDataStateID INT = (SELECT ISNULL((SELECT GuidedDataStateID FROM GuidedDataState WHERE SiteID=@SiteID AND ClientID=@ClientID),0))

	IF @GuidedDataStateID = 0 BEGIN
		INSERT INTO GuidedDataState(SiteID,ClientID,DateChecked) SELECT @SiteID,@ClientID,GETDATE() WHERE (SELECT COUNT(*) FROM GuidedDataState WHERE SiteID=@SiteID AND SiteID=@ClientID)=0
		SET @GuidedDataStateID = (SELECT GuidedDataStateID FROM GuidedDataState WHERE SiteID=@SiteID AND ClientID=@ClientID)
	END

	DELETE FROM GuidedDataStateEntry WHERE GuidedDataStateID = @GuidedDataStateID

	DECLARE @RequestingServerCode VARCHAR(MAX) = (Select s__ServerCode FROM Config)
	DECLARE @TmpCounter INT = 0

	
	DECLARE @EnterpriseSiteData_Register TABLE ([TableName] varchar(max),[RegisterID] [int],[BuildingGUID] varchar(max),[BuildingGUIDVersion] [int],[PhotoID] [int],[PhotoData] [image],[ContentType] [varchar](max),[RegisterStart] DATETIME,[RegisterFinish] DATETIME,[BuildingDesignation] varchar(max),[Notes] varchar(max),[SystemName] [varchar](max),[UseRoomCode] [int],[Included] [int],[AssociatedJobNoList] varchar(max))
	DECLARE @EnterpriseSiteData_Floorplan TABLE ([TableName] varchar(max),[ParentGUID] varchar(max),[FloorplanID] [int],[FloorGUID] varchar(max),[FloorGUIDVersion] [int],[FloorNumber] [int],[FloorplanData] [image],[ContentType] [varchar](max),[Included] [int],[AssociatedJobNoList] varchar(max))
	DECLARE @EnterpriseSiteData_Room TABLE ([TableName] [varchar](max) NOT NULL,[ParentGUID] [varchar](max) NOT NULL,[RoomID] [int] NOT NULL,[RoomGUID] [varchar](max) NOT NULL,[RoomGUIDVersion] [int] NOT NULL,[Number] [int] NOT NULL,[Description] [varchar](max) NULL,[Notes] [varchar](max) NULL,[RandD] [bit] NOT NULL,[Inaccesible] [bit] NOT NULL,[RoomCode] [varchar](max) NULL,[Included] [int] NOT NULL,[ServerRoomGroupID] [int] NULL,[ServerParentGroupID] [int] NULL,[AssociatedJobNoList] [varchar](max) NULL)
	DECLARE @EnterpriseSiteData_Sample TABLE ([TableName] varchar(max),[ParentGUID] varchar(max),[SampleID] [int],[ItemGUID] varchar(max),[ItemGUIDVersion] [int],[RegisterItemNo] [int],[PhotoID] [int],[PhotoData] [image],[PhotoNo] [varchar](max),[SampleRef] varchar(max),[AsSample] [BIT],[SampleResultID] [int],[SampleClassificationID] [int],[SampleClassificationExtended] varchar(max),[Notes] varchar(max),[DateAnalysed] DATETIME,[EmployeeID] [int],[Included] [int],[AssociatedJobNoList] varchar(max))
	
	INSERT INTO @EnterpriseSiteData_Register ([TableName],[RegisterID],[BuildingGUID],[BuildingGUIDVersion],[PhotoID],[PhotoData],[ContentType],[RegisterStart],[RegisterFinish],[BuildingDesignation],[Notes],[SystemName],[UseRoomCode],[Included],[AssociatedJobNoList])
	EXEC [EnterpriseSiteData_Surveying_v2.4.2.12] @ClientID, @SiteID,@RequestingServerCode,@IncludeTableResponse='Register',@ExcludeBinaryData=1
	INSERT INTO @EnterpriseSiteData_Floorplan ([TableName],[ParentGUID],[FloorplanID],[FloorGUID],[FloorGUIDVersion],[FloorNumber],[FloorplanData],[ContentType],[Included],[AssociatedJobNoList])
	EXEC [EnterpriseSiteData_Surveying_v2.4.2.12] @ClientID, @SiteID,@RequestingServerCode,@IncludeTableResponse='Floorplan',@ExcludeBinaryData=1
	INSERT INTO @EnterpriseSiteData_Room ([TableName],[ParentGUID],[RoomID],[RoomGUID],[RoomGUIDVersion],[Number],[Description],[Notes],[RandD],[Inaccesible],[RoomCode],[Included],[ServerRoomGroupID],[ServerParentGroupID],[AssociatedJobNoList])
	EXEC [EnterpriseSiteData_Surveying_v2.4.2.12] @ClientID, @SiteID,@RequestingServerCode,@IncludeTableResponse='Room',@ExcludeBinaryData=1
	INSERT INTO @EnterpriseSiteData_Sample ([TableName],[ParentGUID],[SampleID],[ItemGUID],[ItemGUIDVersion],[RegisterItemNo],[PhotoID],[PhotoData],[PhotoNo],[SampleRef],[AsSample],[SampleResultID],[SampleClassificationID],[SampleClassificationExtended],[Notes],[DateAnalysed],[EmployeeID],[Included],[AssociatedJobNoList])
	EXEC [EnterpriseSiteData_Surveying_v2.4.2.12] @ClientID, @SiteID,@RequestingServerCode,@IncludeTableResponse='Sample',@ExcludeBinaryData=1
	

	DECLARE @GuidedDataStateEntry TABLE (GuidededDataStateTypeID INT,ErrorCount INT)

	SET @TmpCounter = (SELECT COUNT(*) FROM @EnterpriseSiteData_Sample esd_s LEFT OUTER JOIN @EnterpriseSiteData_Sample esd_s_main ON REPLACE(esd_s.SampleRef,'*','')=REPLACE(esd_s_main.SampleRef,'*','') AND esd_s_main.AsSample=0 WHERE esd_s_main.SampleID IS NULL AND esd_s.AsSample=1)
	IF (@TmpCounter > 0) BEGIN
		--All missing assumed to be critical, unless they are found on the system
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,2,@TmpCounter
		SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT main.SampleRef FROM (SELECT REPLACE(esd_s.SampleRef,'*','') [SampleRef] FROM @EnterpriseSiteData_Sample esd_s LEFT OUTER JOIN @EnterpriseSiteData_Sample esd_s_main ON REPLACE(esd_s.SampleRef,'*','')=REPLACE(esd_s_main.SampleRef,'*','') AND esd_s_main.AsSample=0 WHERE esd_s_main.SampleID IS NULL AND esd_s.AsSample=1) main INNER JOIN Sample s WITH (NOLOCK) ON main.SampleRef = REPLACE(s.SampleRef,'*','') AND s.AsSample=0 INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID=CASE WHEN s.RoomID < 0 THEN -s.RoomID ELSE s.RoomID END INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=CASE WHEN rm.FloorplanID < 0 THEN -rm.FloorplanID ELSE rm.FloorplanID END INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=CASE WHEN fp.RegisterID < 0 THEN -fp.RegisterID ELSE fp.RegisterID END INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobEmployeeID=CASE WHEN r.JobEmployeeID < 0 THEN -r.JobEmployeeID ELSE r.JobEmployeeID END GROUP BY main.SampleRef) main
		)
		IF (@TmpCounter > 0) BEGIN
			UPDATE GuidedDataStateEntry SET ErrorCount=ErrorCount-@TmpCounter WHERE GuidedDataStateTypeID=2 AND GuidedDataStateID=@GuidedDataStateID
			INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,3,@TmpCounter
		END
	END

	IF (SELECT MAX(MobileConfigInt) FROM MobileConfig WHERE MobileConfigTypeID=123) = 0 BEGIN
		SET @TmpCounter = (SELECT COUNT(*) FROM @EnterpriseSiteData_Sample esd_s INNER JOIN Element e5 ON esd_s.SampleID=e5.SampleID AND e5.ElementTypeID=5 AND e5.ElementIntID=2 WHERE esd_s.SampleRef IS NULL)
		IF (@TmpCounter > 0) BEGIN
			INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,4,@TmpCounter
		END
	END

	SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT main.SampleRef FROM (SELECT REPLACE(esd_s.SampleRef,'*','') [SampleRef] FROM @EnterpriseSiteData_Sample esd_s WHERE esd_s.SampleRef IS NOT NULL AND AsSample=0) main GROUP BY main.SampleRef HAVING COUNT(*)>1) total)
	IF (@TmpCounter > 0) BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,5,@TmpCounter
	END

	SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT esd_s.RegisterItemNo FROM @EnterpriseSiteData_Sample esd_s GROUP BY esd_s.RegisterItemNo HAVING COUNT(*)>1) total)
	IF (@TmpCounter > 0) BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,6,@TmpCounter
	END
	
	SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT ISNULL(NULLIF(esd_rm.RoomCode,''),esd_rm.Number) [RoomNumberCode], esd_fp.FloorNumber, esd_r.BuildingDesignation FROM @EnterpriseSiteData_Room esd_rm INNER JOIN @EnterpriseSiteData_Floorplan esd_fp ON esd_rm.ParentGUID=esd_fp.FLoorGUID INNER JOIN @EnterpriseSiteData_Register esd_r ON esd_fp.ParentGUID=esd_r.BuildingGUID GROUP BY ISNULL(NULLIF(esd_rm.RoomCode,''),esd_rm.Number), esd_fp.FloorNumber, esd_r.BuildingDesignation HAVING COUNT(*)>1) total)
	IF (@TmpCounter > 0) BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,7,@TmpCounter
	END

	SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT esd_r.BuildingDesignation FROM @EnterpriseSiteData_Register esd_r GROUP BY esd_r.BuildingDesignation HAVING COUNT(*)>1) total)
	IF (@TmpCounter > 0) BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,8,@TmpCounter
	END

	SET @TmpCounter = (SELECT COUNT(*) FROM (SELECT esd_fp.FloorNumber, esd_r.BuildingDesignation FROM @EnterpriseSiteData_Floorplan esd_fp INNER JOIN @EnterpriseSiteData_Register esd_r ON esd_fp.ParentGUID=esd_r.BuildingGUID GROUP BY esd_fp.FloorNumber, esd_r.BuildingDesignation HAVING COUNT(*)>1) total)
	IF (@TmpCounter > 0) BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,9,@TmpCounter
	END
	
	IF (SELECT COUNT(*) FROM GuidedDataStateEntry WHERE GuidedDataStateID=@GuidedDataStateID) = 0 BEGIN
		INSERT INTO GuidedDataStateEntry(GuidedDataStateID,GuidedDataStateTypeID,ErrorCount) SELECT @GuidedDataStateID,1,0
	END

	UPDATE GuidedDataState SET DateChecked=GETDATE() WHERE GuidedDataStateID=@GuidedDataStateID

	SET NOCOUNT OFF;
	
END

GO


IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'util_UpdateGuidedDataStateSchedule')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[util_UpdateGuidedDataStateSchedule] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[util_UpdateGuidedDataStateSchedule] 
      
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE @RunningCount INT = (SELECT COUNT(*) FROM sys.dm_exec_connections as qs CROSS APPLY sys.dm_exec_sql_text(qs.most_recent_sql_handle) st  WHERE object_name(st.objectid) = 'util_UpdateGuidedDataStateSchedule')

	IF @RunningCount < 2 BEGIN

		DECLARE @MaxPriority INT = (SELECT ISNULL((SELECT MAX([Order]) FROM util_UpdateGuidedDataStatePriority),0)+1)

		DECLARE @ClientSiteExec TABLE (Row_Num INT,ClientID INT, SiteID INT)
		INSERT INTO @ClientSiteExec (Row_Num,ClientID,SiteID)
		SELECT
			TOP 5
			ROW_NUMBER() OVER (Order by gds.DateChecked ASC,ISNULL(util_ugdsp.[Order],@MaxPriority), cs.SubOrdering) [Row_Num],
			cs.ClientID,
			cs.SiteID
		FROM
			(
				Select 
					j.ClientID, j.SiteID,ROW_NUMBER() OVER (ORDER BY c.Client,si.Address) [SubOrdering]
				FROM
					Job j WITH (NOLOCK)
					INNER JOIN Site si WITH(NOLOCK) ON j.SiteID=si.SiteID
					INNER JOIN Client c WITH(NOLOCK) ON j.ClientID=c.ClientID
					INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
					INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
					INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
					INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
					INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
				WHERE
					j.Approved IS NOT NULL
						AND
					a.DateDeclined IS NULL
				GROUP BY
					j.ClientID, j.SiteID,c.Client,si.Address
			) cs
			LEFT OUTER JOIN GuidedDataState gds ON gds.ClientID=cs.ClientID AND gds.SiteID=cs.SiteID
			LEFT OUTER JOIN util_UpdateGuidedDataStatePriority util_ugdsp ON cs.ClientID=util_ugdsp.ClientID
		ORDER BY
			gds.DateChecked ASC,ISNULL(util_ugdsp.[Order],@MaxPriority), cs.SubOrdering

		DECLARE 
			@ClientID_1 INT = 0, @SiteID_1 INT = 0,
			@ClientID_2 INT = 0, @SiteID_2 INT = 0,
			@ClientID_3 INT = 0, @SiteID_3 INT = 0,
			@ClientID_4 INT = 0, @SiteID_4 INT = 0,
			@ClientID_5 INT = 0, @SiteID_5 INT = 0


		SELECT @ClientID_1=ClientID,@SiteID_1=SiteID FROM @ClientSiteExec cse_1 WHERE cse_1.Row_Num=1
		SELECT @ClientID_2=ClientID,@SiteID_2=SiteID FROM @ClientSiteExec cse_2 WHERE cse_2.Row_Num=2
		SELECT @ClientID_3=ClientID,@SiteID_3=SiteID FROM @ClientSiteExec cse_3 WHERE cse_3.Row_Num=3
		SELECT @ClientID_4=ClientID,@SiteID_4=SiteID FROM @ClientSiteExec cse_4 WHERE cse_4.Row_Num=4
		SELECT @ClientID_5=ClientID,@SiteID_5=SiteID FROM @ClientSiteExec cse_5 WHERE cse_5.Row_Num=5


		IF @ClientID_1 > 0 AND @SiteID_1 > 0 BEGIN EXEC util_UpdateGuidedDataState @ClientID_1,@SiteID_1 END
		IF @ClientID_2 > 0 AND @SiteID_2 > 0 BEGIN EXEC util_UpdateGuidedDataState @ClientID_2,@SiteID_2 END
		IF @ClientID_3 > 0 AND @SiteID_3 > 0 BEGIN EXEC util_UpdateGuidedDataState @ClientID_3,@SiteID_3 END
		IF @ClientID_4 > 0 AND @SiteID_4 > 0 BEGIN EXEC util_UpdateGuidedDataState @ClientID_4,@SiteID_4 END
		IF @ClientID_1 > 0 AND @SiteID_5 > 0 BEGIN EXEC util_UpdateGuidedDataState @ClientID_5,@SiteID_5 END

	END

	SET NOCOUNT OFF;

END


GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Modification_Accepted')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Modification_Accepted] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[EnterpriseSiteData_Modification_Accepted] 
      @EnterpriseSiteData_ModificationID INT
AS
BEGIN

    SET NOCOUNT ON;
	
	DECLARE @ClientID INT, @SiteID INT
	SELECT
		@ClientID=esd_m.ClientID,@SiteID=esd_m.SiteID
	FROM
		enterpriseSiteData_Modification esd_m WHERE enterpriseSiteData_ModificationID=@EnterpriseSiteData_ModificationID

	DECLARE @ClientSiteAllData Table (EnterpriseSiteData_ModificationID INT,ApprovedDate DATETIME,RegisterID INT,BuildingGUID VARCHAR(MAX),BuildingGUIDVersion INT,FloorplanID INT,FloorGUID VARCHAR(MAX),FloorGuidVersion INT,RoomID INT,RoomGUID VARCHAR(MAX),RoomGUIDVersion INT,SampleID INT,ItemGUID VARCHAR(MAX),ItemGUIDVersion INT)
	INSERT INTO @ClientSiteAllData (EnterpriseSiteData_ModificationID,ApprovedDate,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID,FloorGuidVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
	SELECT 
		@enterpriseSiteData_ModificationID,j.Approved,r.RegisterID,r.GUID,r.GUIDVErsion,fp.FloorplanID,fp.GUID,fp.GUIDVersion,rm.RoomID,rm.GUID,rm.GUIDVersion,s.SampleID,s.GUID,s.GUIDVersion
	FROM Job j
		INNER JOIN JobEmployee je ON je.JobID = j.JobID
		INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
		INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
		LEFT OUTER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
		LEFT OUTER JOIN Sample s ON s.RoomID = rm.RoomID
		INNER JOIN Quote q ON j.JobID=q.JobID
		INNER JOIN Appointment a ON q.QuoteID=a.QuoteID
	WHERE 
		j.Approved IS NOT NULL AND j.ClientID=@ClientID AND j.SiteID=@SiteID AND a.DateDeclined IS NULL
	GROUP BY
		j.Approved,r.RegisterID,r.GUID,r.GUIDVErsion,fp.FloorplanID,fp.GUID,fp.GUIDVersion,rm.RoomID,rm.GUID,rm.GUIDVersion,s.SampleID,s.GUID,s.GUIDVersion

	BEGIN TRAN
		INSERT INTO EnterpriseSiteData_Modification_AuditTrail (EnterpriseSiteData_ModificationID,ApprovedDate,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID,FloorGuidVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
		SELECT 
			EnterpriseSiteData_ModificationID,ApprovedDate,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID,FloorGuidVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion
		FROM
			@ClientSiteAllData

		UPDATE
			r
			SET GUID=u.NewBuildingGUID, GUIDVersion=u.NewGUIDVersion
		FROM
			Register r 
			INNER JOIN
			(
				SELECT
					csad.RegisterID,
					ISNULL(esd_m_r.NewBuildingGUID,esd_m_r.BuildingGUID) [NewBuildingGUID],
					ROW_NUMBER() OVER (Partition By ISNULL(esd_m_r.NewBuildingGUID,esd_m_r.BuildingGUID) ORDER BY csad.ApprovedDate) [NewGUIDVersion]
				FROM
					(
						SELECT
							esd_m_r.RegisterID,esd_m_r.BuildingGUID,esd_m_r.NewBuildingGUID
						FROM	
							EnterpriseSiteData_Modification_Register esd_m_r
						WHERE
							esd_m_r.EnterpriseSiteData_ModificationID=@enterpriseSiteData_ModificationID
						GROUP BY
							esd_m_r.RegisterID,esd_m_r.BuildingGUID,esd_m_r.NewBuildingGUID
					) esd_m_r
					INNER JOIN 
					(
						SELECT
							csad.RegisterID,csad.BuildingGUID,csad.ApprovedDate
						FROM
							@ClientSiteAllData csad
						GROUP BY
							csad.RegisterID,csad.BuildingGUID,csad.ApprovedDate
					) csad ON esd_m_r.BuildingGUID = csad.BuildingGUID
					INNER JOIN Register r ON csad.RegisterID=r.RegisterID
			) u ON r.RegisterID=u.RegisterID

		UPDATE
			fp
			SET GUID=u.NewFloorGUID, GUIDVersion=u.NewGUIDVersion
		FROM
			Floorplan fp
			INNER JOIN
			(
				SELECT
					csad.FloorplanID,
					ISNULL(esd_m_fp.NewFloorGUID,esd_m_fp.FloorGUID) [NewFloorGUID],
					ROW_NUMBER() OVER (Partition By ISNULL(esd_m_fp.NewFloorGUID,esd_m_fp.FloorGUID) ORDER BY csad.ApprovedDate) [NewGUIDVersion]
				FROM
					(
						SELECT
							esd_m_fp.FloorplanID,esd_m_fp.FloorGUID,esd_m_fp.NewFloorGUID
						FROM	
							EnterpriseSiteData_Modification_Floorplan esd_m_fp
						WHERE
							esd_m_fp.EnterpriseSiteData_ModificationID=@enterpriseSiteData_ModificationID
						GROUP BY
							esd_m_fp.FloorplanID,esd_m_fp.FloorGUID,esd_m_fp.NewFloorGUID
					) esd_m_fp
					INNER JOIN 
					(
						SELECT
							csad.FloorplanID,csad.FloorGUID,csad.ApprovedDate
						FROM
							@ClientSiteAllData csad
						GROUP BY
							csad.FloorplanID,csad.FloorGUID,csad.ApprovedDate
					) csad ON esd_m_fp.FloorGUID = csad.FloorGUID
					INNER JOIN Floorplan fp ON csad.FloorplanID=fp.FloorplanID
			) u ON fp.FloorplanID=u.FloorplanID

		UPDATE
			rm
			SET GUID=u.NewRoomGUID, GUIDVersion=u.NewGUIDVersion
		FROM
			Room rm
			INNER JOIN
			(
				SELECT
					csad.RoomID,
					ISNULL(esd_m_rm.NewRoomGUID,esd_m_rm.RoomGUID) [NewRoomGUID],
					ROW_NUMBER() OVER (Partition By ISNULL(esd_m_rm.NewRoomGUID,esd_m_rm.RoomGUID) ORDER BY csad.ApprovedDate) [NewGUIDVersion]
				FROM
					(
						SELECT
							esd_m_rm.RoomID,esd_m_rm.RoomGUID,esd_m_rm.NewRoomGUID
						FROM	
							EnterpriseSiteData_Modification_Room esd_m_rm
						WHERE
							esd_m_rm.EnterpriseSiteData_ModificationID=@enterpriseSiteData_ModificationID
						GROUP BY
							esd_m_rm.RoomID,esd_m_rm.RoomGUID,esd_m_rm.NewRoomGUID
					) esd_m_rm
					INNER JOIN 
					(
						SELECT
							csad.RoomID,csad.RoomGUID,csad.ApprovedDate
						FROM
							@ClientSiteAllData csad
						GROUP BY
							csad.RoomID,csad.RoomGUID,csad.ApprovedDate
					) csad ON esd_m_rm.RoomGUID = csad.RoomGUID
					INNER JOIN Room rm ON csad.RoomID=rm.RoomID
			) u ON rm.RoomID=u.RoomID

		UPDATE
			s
			SET GUID=u.NewRoomGUID, GUIDVersion=u.NewGUIDVersion
		FROM
			Sample s
			INNER JOIN
			(
				SELECT
					csad.SampleID,
					ISNULL(esd_m_s.NewItemGUID,esd_m_s.ItemGUID) [NewRoomGUID],
					ROW_NUMBER() OVER (Partition By ISNULL(esd_m_s.NewItemGUID,esd_m_s.ItemGUID) ORDER BY csad.ApprovedDate) [NewGUIDVersion]
				FROM
					(
						SELECT
							esd_m_s.SampleID,esd_m_s.ItemGUID,esd_m_s.NewItemGUID
						FROM	
							EnterpriseSiteData_Modification_Sample esd_m_s
						WHERE
							esd_m_s.EnterpriseSiteData_ModificationID=@enterpriseSiteData_ModificationID
						GROUP BY
							esd_m_s.SampleID,esd_m_s.ItemGUID,esd_m_s.NewItemGUID
					) esd_m_s
					INNER JOIN 
					(
						SELECT
							csad.SampleID,csad.ItemGUID,csad.ApprovedDate
						FROM
							@ClientSiteAllData csad
						GROUP BY
							csad.SampleID,csad.ItemGUID,csad.ApprovedDate
					) csad ON esd_m_s.ItemGUID = csad.ItemGUID
					INNER JOIN Sample s ON csad.SampleID=s.SampleID
			) u ON s.SampleID=u.SampleID

		EXEC PopulateGuidSamples @ClientID,@SiteID
		EXEC CreateSiteSampleResultsOverviewSorting @ClientID,@SiteID
		UPDATE EnterpriseSiteData_Modification SET DateCompleted=GETDATE() WHERE EnterpriseSiteData_ModificationID=@enterpriseSiteData_ModificationID
	
	COMMIT TRAN
	  

    SET NOCOUNT OFF;

END


GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Modification_Rejected')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Modification_Rejected] AS BEGIN SET NOCOUNT ON; END')
END
GO

/****** Object:  StoredProcedure [dbo].[EnterpriseSiteData_Modification_Rejected]    Script Date: 17/06/2019 13:36:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[EnterpriseSiteData_Modification_Rejected] 
      @EnterpriseSiteData_ModificationID INT
AS
BEGIN

      SET NOCOUNT ON;

	  UPDATE EnterpriseSiteData_Modification SET DateDiscarded=GETDATE() WHERE EnterpriseSiteData_ModificationID=@EnterpriseSiteData_ModificationID
	  

      SET NOCOUNT OFF;

END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_GuidedDataStateSummary')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_GuidedDataStateSummary] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[Paged_GuidedDataStateSummary]
(
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filters
	@ClientID INT = 0,
	@SiteID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@GuidedDataStateTypeID INT = -1,
	@MinSeverity INT = 0,
	@MaxSeverity INT = 5
)
AS
BEGIN
	SET NOCOUNT ON;
    
	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1

	DECLARE @GuidedDataStateSummary TABLE (IndexID INT IDENTITY(1,1), ClientID INT, SiteID INT, DateChecked DATETIME)
	INSERT INTO @GuidedDataStateSummary (ClientID,SiteID,DateChecked)
	SELECT
		main.ClientID,main.SiteID,main.DateChecked
	FROM
		(
			SELECT
				cs.ClientID,cs.SiteID,gds.DateChecked,MAX(gdst.Severity) [HighestServerity], cs.[SubOrdering]
			FROM
				(
					Select 
						j.ClientID, j.SiteID,ROW_NUMBER() OVER (ORDER BY c.Client,si.Address) [SubOrdering]
					FROM
						Job j WITH (NOLOCK)
						INNER JOIN Site si WITH(NOLOCK) ON j.SiteID=si.SiteID
						INNER JOIN Client c WITH(NOLOCK) ON j.ClientID=c.ClientID
						INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
						INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
						INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
						INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
						INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
					WHERE
						j.Approved IS NOT NULL
							AND
						a.DateDeclined IS NULL
							AND
						(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
							AND
						(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
							AND
						j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
					GROUP BY
						j.ClientID, j.SiteID,c.Client,si.Address
				) cs
				LEFT OUTER JOIN GuidedDataState gds ON gds.ClientID=cs.ClientID AND gds.SiteID=cs.SiteID
				LEFT OUTER JOIN GuidedDataStateEntry gdse ON gds.GuidedDataStateID=gdse.GuidedDataStateID
				LEFT OUTER JOIN GuidedDataStateType gdst ON gdst.GuidedDataStateTypeID=gdse.GuidedDataStateTypeID
			WHERE
				ISNULL(gdst.Severity,0) BETWEEN @MinSeverity AND @MaxSeverity
					AND
				(CASE WHEN @GuidedDataStateTypeID < 0 THEN 1 ELSE CASE WHEN ISNULL(gdst.GuidedDataStateTypeID,0)=@GuidedDataStateTypeID THEN 1 ELSE 0 END END = 1)
			GROUP BY
				cs.ClientID,cs.SiteID,gds.DateChecked, cs.[SubOrdering]
		) main
	ORDER BY
		main.HighestServerity DESC, main.SubOrdering

	-- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @GuidedDataStateSummary)
    
	DECLARE @Paging TABLE (Row_Num INT, [Page] INT, [Pages] INT, ClientID INT, SiteID INT, DateChecked DATETIME)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @GuidedDataStateSummary
           ) a
    )

	INSERT INTO @Paging (Row_Num, [Page], [Pages], ClientID, SiteID, DateChecked)
	SELECT 
		Row_Num, [Page], [Pages], ClientID, SiteID, DateChecked
	FROM
		Paging
	Where 
        (
            Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )

	SELECT
		@TotalRowNumber [TotalRows],
		main.Pages,
		main.Page,
		main.ClientID,
		main.SiteID,
		main.Client,
		main.SiteAddress,
		main.EmployeeID,
		main.ModificationBy,
		gdst.SeverityDescription [Status],
		main.StatusDetailed
	FROM
		(
			SELECT
				pag.Pages,
				pag.Page,
				pag.Row_Num,
				c.ClientID,
				si.SiteID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
				si.Address [SiteAddress],
				esd_m.EmployeeID [EmployeeID],
				emp.FullName [ModificationBy],
				MAX(gdst.Severity) [Severity],
				STUFF((SELECT ',' + CASE WHEN MAX(gdst.Severity) > 0 THEN '(' + CAST(sub_gdse.ErrorCount as varchar(MAX)) + ') ' ELSE '' END + sub_gdst.Description FROM GuidedDataStateEntry sub_gdse WITH(NOLOCK) INNER JOIN GuidedDataStateType sub_gdst WITH (NOLOCK) ON sub_gdst.GuidedDataStateTypeID=sub_gdse.GuidedDataStateTypeID WHERE sub_gdse.GuidedDataStateID=gds.GuidedDataStateID FOR XML PATH ('')), 1, 1, '') [StatusDetailed]
			FROM
				@Paging pag
				INNER JOIN Client c WITH (NOLOCK) ON pag.ClientID = c.ClientID
				INNER JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
				LEFT OUTER JOIN EnterpriseSiteData_Modification esd_m WITH (NOLOCK) ON pag.ClientID=esd_m.ClientID AND pag.SiteID=esd_m.SiteID AND esd_m.DateCompleted IS NULL AND esd_m.DateDiscarded IS NULL
				LEFT OUTER JOIN Employee emp WITH (NOLOCK) ON esd_m.EmployeeID=emp.EmployeeID
				LEFT OUTER JOIN GuidedDataState gds WITH (NOLOCK) ON gds.ClientID=pag.ClientID AND gds.SiteID=pag.SiteID
				LEFT OUTER JOIN GuidedDataStateEntry gdse WITH (NOLOCK) ON gds.GuidedDataStateID=gdse.GuidedDataStateID
				LEFT OUTER JOIN GuidedDataStateType gdst WITH (NOLOCK) ON gdst.GuidedDataStateTypeID=gdse.GuidedDataStateTypeID
			GROUP BY
				pag.Pages,
				pag.Page,
				pag.Row_Num,
				gds.GuidedDataStateID,
				c.ClientID,
				si.SiteID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName,'') + ')',''),
				si.Address,
				esd_m.EmployeeID,
				emp.FullName
		) main
		LEFT OUTER JOIN GuidedDataStateType gdst WITH (NOLOCK) ON gdst.Severity=main.Severity
	ORDER BY
		main.Row_Num

	SET NOCOUNT OFF;

END

GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'EnterpriseSiteData_Surveying_v2.4.2.12')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[EnterpriseSiteData_Surveying_v2.4.2.12] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[EnterpriseSiteData_Surveying_v2.4.2.12]
(
      @ClientID INT,
      @SiteID INT,
      @RequestingServerCode VARCHAR(MAX),
      @IncludePhotoNoColumn BIT = 0,
      @ExcludeBinaryData BIT = 0,
      @JobReinspectionStructureID INT = 0,
      @FilterToJobID INT = 0,
	  @IncludeTableResponse VARCHAR(MAX) = 'Register,Floorplan,Room,Sample,Element,BuildingComponent,JobLink'
)
AS
BEGIN
	SET NOCOUNT ON;
                   
	If @RequestingServerCode != (SELECT s__ServerCode FROM Config) BEGIN
		SET @FilterToJobID = 0
	END

	IF @FilterToJobID > 0 BEGIN
	SET @JobReinspectionStructureID = (SELECT ISNULL((SELECT TOP 1 JobReinspectionStructureID FROM JobReinspectionStructure WHERE JobID=@FilterToJobID AND NoDataRequired=0),0))
		IF @JobReinspectionStructureID = 0 BEGIN
			SET @FilterToJobID = 0
		END
	END

    DECLARE @LocalServerCode VARCHAR(MAX) = (SELECT s__ServerCode FROM Config)
                
    DECLARE @IDList TABLE (JobID INT, JobNo VARCHAR(MAX), UseRoomCode INT, RegisterID INT, BuildingGUID VARCHAR(MAX), BuildingGUIDVersion INT, FloorplanID INT, FloorGUID VARCHAR(MAX), FloorGUIDVersion INT, RoomID INT, RoomGUID VARCHAR(MAX), RoomGUIDVersion INT, SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT)
    Insert into @IDList (JobID,JobNo,UseRoomCode,RegisterID,BuildingGUID,BuildingGUIDVersion,FloorplanID,FloorGUID, FloorGUIDVersion,RoomID,RoomGUID,RoomGUIDVersion,SampleID,ItemGUID,ItemGUIDVersion)
    SELECT 
		j.JobID, TEAMS.dbo.FormatTeamsReference('J',j.JobNo),
		CASE WHEN NULLIF(rm.RoomCode,'') IS NOT NULL THEN 1 ELSE 0 END,
		r.RegisterID,r.GUID [BuildingGUID],r.GUIDVersion [BuildingGUIDVersion],
		fp.FloorplanID,fp.GUID [FloorGUID],fp.GUIDVersion [FloorGUIDVersion],
		rm.RoomID,rm.GUID [RoomGUID],rm.GUIDVersion [RoomGUIDVersion],
		s.SampleID,s.GUID [ItemGUID],s.GUIDVersion [ItemGUIDVersion]
    FROM 
        (
			SELECT 
				j.JobID, j.JobNo, j.SiteID
			FROM
				Job j WITH (NOLOCK)
				INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
				INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID=a.QuoteID
			WHERE
				j.SiteID = @SiteID
					AND
				j.ClientID = @ClientID
					AND
				a.DateDeclined IS NULL
					AND
				j.Approved IS NOT NULL
        ) j
        INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.RegisterID = r.RegisterID
        LEFT OUTER JOIN Room rm WITH (NOLOCK) ON fp.FloorplanID = rm.FloorplanID
        LEFT OUTER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
        LEFT OUTER JOIN Element e2 WITH (NOLOCK) ON s.SampleID = e2.SampleID AND e2.ElementTypeID = 2
        LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON 
            (
                CASE WHEN s.SampleID IS NOT NULL THEN
                    CASE WHEN jrsd.SampleID=s.SampleID THEN 1 ELSE 0 END
                ELSE
                    CASE WHEN rm.RoomID IS NOT NULL THEN
		                CASE WHEN jrsd.RoomID=rm.RoomID THEN 1 ELSE 0 END
                    ELSE
                        CASE WHEN fp.FloorplanID IS NOT NULL THEN
                            CASE WHEN jrsd.FloorplanID=fp.FloorplanID THEN 1 ELSE 0 END
                        ELSE
                            CASE WHEN jrsd.RegisterID=r.RegisterID THEN 1 ELSE 0 END
                        END
                    END
                END = 1
            )
                AND 
			jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
    WHERE 
        CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
            AND
        (CASE WHEN s.SampleID IS NOT NULL AND e2.ElementID IS NULL THEN 0 ELSE 1 END=1)

	IF @IncludeTableResponse LIKE '%Register%' BEGIN
		SELECT
			main.TableName, main.RegisterID, main.BuildingGUID, main.BuildingGUIDVersion, p.PhotoID, CASE WHEN @ExcludeBinaryData=0 THEN p.PhotoData END [PhotoData], p.ContentType,
			r.RegisterStart, r.RegisterFinish, r.BuildingDesignation, r.Notes, r.SystemName, main.UseRoomCode,
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Register' [TableName], _r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
							MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
						FROM
							@IDList idl
						GROUP BY
							RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RegisterID=_r.RegisterID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_r.Identifier = 1
				GROUP BY
					_r.RegisterID, BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode, CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON r.PhotoID=p.PhotoID
		WHERE
			r.[GUID] IS NOT NULL AND r.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Floorplan%' BEGIN
		SELECT --may need to fix this for the store system! / MobileConfigTypeID 76?
			main.TableName, main.ParentGUID, main.FloorplanID, main.FloorGUID, main.FloorGUIDVersion,
			CASE WHEN fp.FloorNumber = -200 THEN -2 ELSE fp.FloorNumber END [FloorNumber], 
			CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadData ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanData END END END [FloorplanData],
			CASE WHEN (fp.AutocadData IS NOT NULL AND fp.AutocadDataContentType NOT LIKE '%pdf%') THEN fp.AutocadDataContentType ELSE CASE WHEN fp.FloorplanData IS NOT NULL THEN fp.FloorplanDataContentType END END [ContentType],
			main.Included, NULL [AssociatedJobNoList]
		FROM
			(      
				Select
					'Floorplan' [TableName], _f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,
					CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY FloorGUID Order by FloorGUIDVersion DESC) [Identifier],
							id.FloorplanID,BuildingGUID [ParentGUID],FloorGUID,FloorGUIDVersion
						FROM
							@IDList id											
						GROUP BY
							id.FloorplanID,BuildingGUID,FloorGUID,FloorGUIDVersion
					) _f
					LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.FloorplanID=_f.FloorplanID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
				WHERE
					_f.Identifier = 1
									AND
					CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
				GROUP BY
					_f.FloorplanID,ParentGUID,FloorGUID,FloorGUIDVersion,CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
			) main
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=main.FloorplanID
		WHERE
			fp.[GUID] IS NOT NULL AND fp.[GUIDVersion] IS NOT NULL
	END

	IF @IncludeTableResponse LIKE '%Room%' BEGIN    
		SELECT
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,
			rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included],
			rm.RoomGroupID [ServerRoomGroupID], rm.ParentGroupID [ServerParentGroupID], NULL [AssociatedJobNoList]
		FROM
			(
				Select
					'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
				FROM
					(
						SELECT
							ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
							RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
						FROM
							@IDList id
						GROUP BY
							RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
					) _rm
				WHERE
					_rm.Identifier = 1
			) main
			INNER JOIN Room rm WITH (NOLOCK) ON main.RoomID=rm.RoomID
			LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.RoomID=rm.RoomID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
		WHERE
			CASE WHEN @FilterToJobID > 0 THEN 
				CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 
			END = 1
				AND
			rm.[GUID] IS NOT NULL AND rm.[GUIDVersion] IS NOT NULL
		GROUP BY
			main.TableName, main.ParentGUID, main.RoomID, main.RoomGUID, main.RoomGUIDVersion,rm.Number,rm.[Description], rm.Notes, rm.RandD, rm.Inaccessible, rm.RoomCode, rm.RoomGroupID, rm.ParentGroupID,
			CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END
    END
	 
    DECLARE @GuidSamples TABLE (TableName VARCHAR(MAX), ParentGUID VARCHAR(MAX), SampleID INT, ItemGUID VARCHAR(MAX), ItemGUIDVersion INT, Included INT, AssociatedJobNoList VARCHAR(MAX))
       
    INSERT INTO @GuidSamples (TableName,ParentGUID,SampleID,ItemGUID,ItemGUIDVersion,Included,AssociatedJobNoList)
    SELECT
		main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included,  NULL [AssociatedJobNoList]
    FROM
        (      
			Select
				'Sample' [TableName], _s.SampleID,ParentGUID,ItemGUID,ItemGUIDVersion,
				CASE WHEN jrsd.JobReinspectionStructureID IS NOT NULL THEN 1 ELSE 0 END [Included]
			FROM
				(
					SELECT
						ROW_NUMBER() OVER (Partition BY ItemGUID Order by ItemGUIDVersion DESC) [Identifier],SampleID,RoomGUID [ParentGUID],ItemGUID,ItemGUIDVersion
					FROM
						@IDList id
					GROUP BY
						SampleID,RoomGUID,ItemGUID,ItemGUIDVersion
				) _s
				LEFT OUTER JOIN JobReinspectionStructureData jrsd WITH (NOLOCK) ON jrsd.SampleID=_s.SampleID AND jrsd.JobReinspectionStructureID=@JobReinspectionStructureID
			WHERE
				_s.Identifier = 1
					AND
				CASE WHEN @FilterToJobID > 0 THEN CASE WHEN jrsd.JobReinspectionStructureDataID IS NOT NULL THEN 1 ELSE 0 END ELSE 1 END = 1
        ) main
        INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
        INNER JOIN GuidSamples gs WITH (NOLOCK) ON gs.SampleId=s.SampleID AND gs.SiteId=@SiteID AND gs.ClientID=@ClientID
    WHERE
        s.[GUID] IS NOT NULL AND s.[GUIDVersion] IS NOT NULL
    GROUP BY
        main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion, main.Included

	CREATE TABLE #PhotoDataFromStore  (PhotoID INT, PhotoData IMAGE, TEAMS_StoreID INT, DataTaken INT)
	INSERT INTO #PhotoDataFromStore  (PhotoID,TEAMS_StoreID,DataTaken)
	SELECT
		p.PhotoID, p.TEAMS_StoreID, 0
	FROM
		@GuidSamples main
		INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
		INNER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
	WHERE
		p.TEAMS_StoreID IS NOT NULL
	
	IF (SELECT COUNT(*) FROM #PhotoDataFromStore ) > 0 BEGIN
		DECLARE @curTEAMS_StoreID INT=0
		DECLARE storeData CURSOR FOR
		SELECT 
			pdfsCur.TEAMS_StoreID
		FROM 
			#PhotoDataFromStore  pdfsCur 
		GROUP BY
			pdfsCur.TEAMS_StoreID
		
		OPEN storeData
		FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		WHILE @@FETCH_STATUS = 0 BEGIN
			DECLARE @DynamicSQL NVARCHAR(MAX) = 'SELECT p.PhotoID,p.PhotoData,pdfs.TEAMS_StoreID,1 FROM TEAMS_Store' + CAST(@curTEAMS_StoreID as varchar(MAX)) + '.dbo.Photo p INNER JOIN #PhotoDataFromStore pdfs ON p.PhotoID=pdfs.PhotoID WHERE pdfs.TEAMS_StoreID=' + CAST(@curTEAMS_StoreID as varchar(MAX))
			INSERT INTO #PhotoDataFromStore (PhotoID,PhotoData,TEAMS_StoreID,DataTaken)
			EXEC sp_executesql @DynamicSQL
			FETCH NEXT FROM storeData INTO @curTEAMS_StoreID
		END
		CLOSE storeData
		DEALLOCATE storeData
	END

	IF @IncludeTableResponse LIKE '%Sample%' BEGIN
		SELECT
			main.TableName, main.ParentGUID, main.SampleID, main.ItemGUID, main.ItemGUIDVersion,
			s.RegisterItemNo,p.PhotoID,CASE WHEN @ExcludeBinaryData=0 THEN CASE WHEN pdfs.PhotoID IS NOT NULL THEN ISNULL(pdfs.PhotoData,p.PhotoData) ELSE p.PhotoData END END [PhotoData], 
			p.PhotoNo, REPLACE(REPLACE(REPLACE(s.SampleRef,'****','*'),'***','*'),'**','*') [SampleRef], s.AsSample,  
			s.SampleResultID, s.SampleClassificationID, 
			sce.SampleClassification + ' (' + CAST(sc.Value as varchar) + ')' [SampleClassificationExtended], --Need the string for comparison
			s.Notes, s.DateAnalysed, CASE WHEN s.EmployeeID IS NOT NULL THEN 0 END [Employee], main.Included, main.AssociatedJobNoList [AssociatedJobNoList]
		FROM
			@GuidSamples main
			INNER JOIN Sample s WITH (NOLOCK) ON main.SampleID=s.SampleID AND s.Archived=0
			LEFT OUTER JOIN Photo p WITH (NOLOCK) ON s.PhotoID=p.PhotoID
			LEFT OUTER JOIN #PhotoDataFromStore pdfs ON s.PhotoID=pdfs.PhotoID AND pdfs.DataTaken = 1
			LEFT OUTER JOIN SampleClassification sc WITH (NOLOCK) ON sc.SampleClassificationID=s.SampleClassificationID
			LEFT OUTER JOIN SampleClassificationExtended sce WITH (NOLOCK) ON sce.SampleClassificationExtendedID=s.SampleClassificationExtendedID
	END

	IF @IncludeTableResponse LIKE '%Element%' BEGIN
		SELECT
			main.TableName,
			main.SampleID,
			main.RegisterID,
			main.ElementTypeID,
			main.ElementText
		FROM
		(
			SELECT
				'Element' [TableName],
				e.SampleID, 
				NULL [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,eim.Description)
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				@GuidSamples main
				INNER JOIN Element e WITH (NOLOCK) ON main.SampleID=e.SampleID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
			WHERE
				e.ElementTypeID NOT IN (32)
			UNION
			SELECT
				'Element' [TableName],
				NULL [SampleID], 
				e.RegisterID [RegisterID],
				e.ElementTypeID,
				CASE WHEN e.ElementText IS NOT NULL THEN
					e.ElementText
				ELSE
					CASE WHEN e.ElementTypeID = 20 THEN
							ISNULL(eime.Description,ISNULL(eim.ShortDescription,eim.Description))
					ELSE
							CASE WHEN e.ElementTypeID = 32 THEN
									CAST(e.ElementIntID as varchar)
							ELSE
									ISNULL(eime.Description,eim.Description) + ' (' + CAST(eim.ElementIntValue as varchar) + ')'
							END
					END
				END [ElementText]
			FROM
				(
					Select
							_r.RegisterID, NULL [ParentGUID],BuildingGUID,BuildingGUIDVersion, _r.UseRoomCode
					FROM
					(
							SELECT
									ROW_NUMBER() OVER (Partition BY BuildingGUID Order by BuildingGUIDVersion DESC) [Identifier],
									MAX(UseRoomCode) [UseRoomCode], RegisterID,BuildingGUID,BuildingGUIDVersion
							FROM
									@IDList
							GROUP BY
									RegisterID,BuildingGUID,BuildingGUIDVersion
					) _r
					WHERE
							_r.Identifier = 1
				) main
				INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID = main.RegisterID
				INNER JOIN Element e WITH (NOLOCK) ON e.RegisterID=r.RegisterID
				LEFT OUTER JOIN ElementIntMeaning eim WITH (NOLOCK) ON e.ElementIntMeaningID=eim.ElementIntMeaningID
				LEFT OUTER JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID=e.ElementIntMeaningExtendedID
			WHERE
				CASE WHEN e.ElementTypeID IN (140,141,142) THEN 
					1 
				ELSE
					CASE WHEN @RequestingServerCode = @LocalServerCode THEN 1 ELSE 0 END 
				END = 1
		) main
	END
   
   IF @IncludeTableResponse LIKE '%BuildingComponent%' BEGIN
		SELECT
			main.TableName,
			main.RoomID,
			main.ItemNo,
			main.[Description],
			main.[Position],
			main.[Comments]
		FROM
			(
				SELECT
					'BuildingComponent' [TableName],
					main.RoomID,
					bc.ItemNo,
					bc.[Description],
					bc.[Position],
					bc.[Comments]
				FROM
					(
						Select
							'Room' [TableName], _rm.RoomID,ParentGUID,RoomGUID,RoomGUIDVersion
						FROM
							(
								SELECT
									ROW_NUMBER() OVER (Partition BY RoomGUID Order by RoomGUIDVersion DESC) [Identifier],
									RoomID,FloorGUID [ParentGUID],RoomGUID,RoomGUIDVersion
								FROM
									@IDList
								GROUP BY
									RoomID,FloorGUID,RoomGUID,RoomGUIDVersion
							) _rm
						WHERE
							_rm.Identifier = 1
					) main
					INNER JOIN BuildingComponent bc WITH (NOLOCK) ON main.RoomID=bc.RoomID
			) main
    END

	IF @IncludeTableResponse LIKE '%JobLink%' BEGIN
		SELECT
			'Ignore' [TableName], 
			id.JobNo, 
			id.SampleID, 
			id.ItemGUID,
			id.ItemGUIDVersion 
			--id.*
		FROM 
			@IDList id
		WHERE
			id.SampleID IS NOT NULL
				AND
			id.ItemGUID IS NOT NULL
		GROUP BY
			id.JobNo,
			id.SampleId,
			id.ItemGUID,
			id.ItemGUIDVersion
	END
	SET NOCOUNT OFF;

END
GO

USE [TEAMS]
GO
/****** Object:  StoredProcedure [dbo].[GUID_CreateGUID_ByJob]    Script Date: 24/06/2019 12:08:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



      /*    ###########################################################################################################
            09/01/2016 - Changed to include the register ID in the intial part of the GUID to deal with the speed 
            issues that were coming from imported data where the datetimes are identical for lots and lots of records.
            ###########################################################################################################    */   



ALTER PROCEDURE [dbo].[GUID_CreateGUID_ByJob] 
      @JobID INT,
	  @DisablePopulateProcedures INT = 0,
      @Return INT output
AS
BEGIN


      SET NOCOUNT ON;

      /*    #######################################
            Get each register, floorplan, room and sample for a job.
            #######################################    */   
      DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobID)
      DECLARE @SiteID INT =   (Select SiteID FROM Job Where JobID=@JobID)
            
      DECLARE @JobSummary TABLE 
                  (
                        JobID INT,RegisterID INT, RegisterGUID VARCHAR(MAX),RegisterCreated DATETIME,
                        FloorplanID INT, FloorplanGUID VARCHAR(MAX),FloorplanCreated DATETIME,
                        RoomID INT, RoomGUID VARCHAR(MAX),RoomCreated DATETIME,
                        SampleID INT, SampleGUID VARCHAR(MAX),SampleCreated DATETIME
                  )
      
      ;with cte_IDList (JobID,RegisterID,FloorplanID,RoomID,SampleID)
      as
      (
            SELECT 
                  j.JobID,r.RegisterID,fp.FloorplanID,rm.RoomID,s.SampleID
            FROM Job j
                  INNER JOIN JobEmployee je ON je.JobID = j.JobID
                  INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
                  --INNER JOIN Survey su ON su.SurveyID = r.SurveyID
                  INNER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
                  INNER JOIN Room rm ON fp.FloorplanID = rm.FloorplanID
                  INNER JOIN Sample s ON s.RoomID = rm.RoomID
            WHERE j.JobID = @JobID AND (r.GUID IS NULL OR fp.GUID IS NULL OR rm.GUID IS NULL OR s.GUID IS NULL)
      )
      
      Insert into @JobSummary (RegisterID,FloorplanID,RoomID,SampleID) Select ids.RegisterID,ids.FloorplanID,ids.RoomID,ids.SampleID FROM cte_IDList ids
      
	  /*    #######################################
            Creating a UNIQUE GUID based on time and ID of the table level - not possible to get duplicate without a manual update, so no need to test.
            #######################################    */
      
      --    REGISTER GUIDS#########################
	  Update @JobSummary 
		Set 
			RegisterGUID
				=
			'SCMG-' + CAST(r.RegisterID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Register'
            CROSS JOIN Config c
      --    END REGISTER GUIDS#########################
      
      --    FLOORPLAN GUIDS#########################
      Update @JobSummary 
		Set 
			FloorplanGUID
				=
			'SCMG-' + CAST(fp.FloorplanID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=js.FloorplanID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Floorplan'
            CROSS JOIN Config c
      --    END FLOORPLAN GUIDS#########################
      
      --    ROOM GUIDS#########################
	  Update @JobSummary 
		Set 
			RoomGUID
				=
			'SCMG-' + CAST(rm.RoomID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID=js.RoomID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Room'
            CROSS JOIN Config c
	  --    END ROOM GUIDS#########################
      
      --    SAMPLE GUIDS#########################
	  Update @JobSummary 
		Set 
			SampleGUID
				=
			'SCMG-' + CAST(s.SampleID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Sample s WITH (NOLOCK) ON s.SampleID=js.SampleID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Sample'
            CROSS JOIN Config c
      --    END SAMPLE GUIDS#########################
      
      /*    #######################################
            Update each record updating the GUID with a where clause to make sure the GUID does not exist, keeping a track of the total number of updated rows. This needs to match the record count of those that need updating.
            #######################################    */   
      
      DECLARE @registerUpdated INT = (Select COUNT(DISTINCT RegisterID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @floorplanUpdated INT = (Select COUNT(DISTINCT FloorplanID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @roomUpdated INT = (Select COUNT(DISTINCT RoomID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @sampleUpdated INT = (Select COUNT(DISTINCT SampleID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @UpdatesComplete BIT = 1
      
      IF (Select COUNT(*) FROM @JobSummary)=0 BEGIN 
            Set @Return = 2 
            Set @UpdatesComplete = 0
      END
      
      IF @UpdatesComplete = 1
      BEGIN
            BEGIN TRANSACTION
                  
                  --#### UPDATE ACTUAL TABLE RECORDS ####         
                  UPDATE Register Set GUIDVersion=1,GUID=u.Guid FROM Register INNER JOIN (Select RegisterID,RegisterGUID [Guid] FROM @JobSummary Where RegisterGUID IS NOT NULL GROUP BY RegisterID,RegisterGUID) u ON u.RegisterID=Register.RegisterID
                  IF @@ROWCOUNT <> @registerUpdated BEGIN Set @UpdatesComplete = 5 END
                  
                  UPDATE Floorplan Set GUIDVersion=1,GUID=u.Guid FROM Floorplan INNER JOIN (Select FloorplanID,FloorplanGUID [Guid] FROM @JobSummary Where FloorplanGUID IS NOT NULL GROUP BY FloorplanID,FloorplanGUID) u ON u.FloorplanID=Floorplan.FloorplanID
                  IF @@ROWCOUNT <> @floorplanUpdated BEGIN Set @UpdatesComplete = 6 END
                  
                  UPDATE Room Set GUIDVersion=1,GUID=u.Guid FROM Room INNER JOIN (Select RoomID,RoomGUID [Guid] FROM @JobSummary Where RoomGUID IS NOT NULL GROUP BY RoomID,RoomGUID) u ON u.RoomID=Room.RoomID
                  IF @@ROWCOUNT <> @roomUpdated BEGIN Set @UpdatesComplete = 7 END
                  
                  UPDATE Sample Set GUIDVersion=1,GUID=u.Guid FROM Sample INNER JOIN (Select SampleID,SampleGUID [Guid] FROM @JobSummary Where SampleGUID IS NOT NULL GROUP BY SampleID,SampleGUID) u ON u.SampleID=Sample.SampleID
                  IF @@ROWCOUNT <> @sampleUpdated BEGIN Set @UpdatesComplete = 8 END
            
            IF @UpdatesComplete = 1
                  BEGIN
                        COMMIT TRANSACTION
                        IF (Select COUNT(*) FROM Job Where Approved IS NOT NULL AND JobID=@JobID) > 0 AND @DisablePopulateProcedures = 0 BEGIN
                              Exec PopulateGuidSamples @ClientId, @SiteId 
                              Exec CreateSiteSampleResultsOverviewSorting @ClientId, @SiteId
                        END
                        Set @Return = 1
                  END
            ELSE
                  BEGIN
                        ROLLBACK TRANSACTION
                        Set @Return = 0
            END
      END
      
      RETURN @Return
      
      SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'ProjectJobSheet')
BEGIN
    EXEC('CREATE VIEW[dbo].[ProjectJobSheet] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[ProjectJobSheet]
AS

  Select
        0 as SortOrder,
        Min(a.AppointmentId) as AppointmentId,
        Case
			WHEN MAX(na.Created) > MAX(a.StartTime) THEN 'No Access'
			When Max(reg.DateApproved) IS NOT Null Then 'Approved'
			When j.Approved IS NULL AND sc.SupplementaryChangeId IS NOT NULL THEN 'Site Work Complete*'
			When reg.Samples > 0 And reg.Samples = reg.SampleResults Then 'Sample Analysis Complete'
			When reg.Registers >= 1 Then 'Site Work Complete'
			When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
			When j.Approved IS NULL AND sc.SupplementaryChangeId IS NOT NULL THEN 'Site Work Complete*'
		Else
            'Work Scheduled'
        End [Status],
        dbo.FormatTeamsDate(Case
              When Not reg.DateApproved Is Null Then
                              reg.DateApproved
              When reg.Samples > 0 And reg.Samples = reg.SampleResults Then
                    reg.AnalysisComplete
              When reg.Registers >= 1 Then
                    reg.RegisterFinish
              Else
                    Min(Cast(a.DateCreated as date))
        End, 1) [StatusDate],
        dbo.FormatTeamsReference('J', j.JobNo) as JobNo,
        s.[Address],
        s.Postcode,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        j.JobId,
        reg.SurveyTypeId,
        Min(Cast(a.StartTime as date)) as AppointmentDate,
        reg.SiteWorkComplete as DateSiteWorkComplete,
        reg.AnalysisComplete,
        Count(Distinct(j.JobId)) as TotalJobs,
        Count(Distinct(j.JobId)) - reg.Registers as WorkScheduled,
        reg.Registers as SiteWorkComplete,
        reg.Samples,
        reg.SampleResults,
        bsr.FileName as FileName,
        a.ClientOrderNo,
        dbo.FormatTeamsDate(Cast(Min(a.DateCreated) as date), 1) as DateReceived,
        dbo.FormatTeamsDate(Cast(Min(q.Created) as date), 1) as QuoteDate,
        s.uprn,
        reg.SurveyType,
        Surveyors.Surveyor,
        dbo.FormatTeamsDate(Min(Cast(a.StartTime as date)), 1) as SurveyStart,
        dbo.FormatTeamsDate(reg.RegisterFinish, 1) as SurveyCompleted,
        ISNULL(dbo.FormatTeamsDate(iat.AnalysisCompleted, 1), '') as AnalysisCompleted,
        dbo.FormatTeamsDate(Max(Cast(j.Approved as date)),1) as Approved,
        Approver.FullName as ApprovedBy,
        dbo.FormatTeamsDate(Min(Cast(aps.DueDate as date)), 1) DueDate,
        COUNT(na.NoAccessID) + COUNT(na2.NoAccessID) AS NoAccessAttempts,
        pc.PhoneCalls,
        l.Letters,
        [p].[GroupName],
        a.ClientId,
        a.ProjectId,
        a.SiteId,
        s.Other,
        MAX(na.Created) [LastNoAccessDate],
        MAX(reg.JobEmployeeCreated) [LastJobEmployeeDate],
        q.QuoteId,
		dbo.CleanDate(ii.ItemDate) [InvoiceDate]
  From
        Appointment a WITH (NOLOCK)
        Inner Join AppointmentSurvey as aps WITH (NOLOCK) On a.AppointmentID = aps.AppointmentID
        Inner Join [Site] s WITH (NOLOCK) On a.SiteId = s.SiteId --and s.Deleted Is Null
        Inner Join Project p WITH (NOLOCK) On p.ProjectId = a.ProjectId
        Inner Join Quote q WITH (NOLOCK) On q.QuoteId = a.QuoteId
		LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
		
        Inner Join Job j WITH (NOLOCK) On q.JobId = j.JobId And j.Cancelled Is Null
        LEFT JOIN SupplementaryChanges sc WITH (NOLOCK) ON j.JobID = sc.JobId
        Outer Apply
        (
                  Select
                        je.JobId,
                        MAX(je.Created) [JobEmployeeCreated],
                        Count(Distinct(reg.RegisterId)) as Registers,
                        st.SurveyTypeId,
                        st.Description as SurveyType,
                        Max(Cast(reg.RegisterFinish as Date)) as RegisterFinish,
                        Max(reg.DateApproved) as DateApproved,
                        Count(s.SampleId) as Samples,
                        Count(s.SampleResultId) as SampleResults,
                        Max(Cast(s.DateAnalysed as date)) as AnalysisComplete,
                        Max(Cast(Survey.SurveyFinish as Date)) as SiteWorkComplete
                  From
                        JobEmployee je WITH (NOLOCK)
                        Inner Join Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
                        Left Outer Join Floorplan f WITH (NOLOCK) On f.RegisterId = reg.RegisterId
                        Left Outer Join Room r WITH (NOLOCK) On f.FloorplanId = r. FloorplanId
                        Left Outer Join Samples s WITH (NOLOCK) On s.RoomId = r.RoomId And Not SampleRef Is Null And AsSample = 0
                        Left Outer Join Survey WITH (NOLOCK) On reg.SurveyId = Survey.SurveyId
                        Left Outer Join SurveyType st WITH (NOLOCK) On Survey.SurveyTypeId = st.SurveyTypeId
                  Where
                        je.JobId = j.JobId
                  Group By
                        je.JobId,
                        st.SurveyTypeId,
                        st.Description
        ) reg
        Left Outer Join Employee as Approver WITH (NOLOCK) On j.SampleContentEmployeeId = Approver.EmployeeId
        Outer Apply
        (
              Select Top 1
                    e.FullName as Surveyor
              From
                    JobEmployee je2 WITH (NOLOCK)
                    Inner Join Employee e WITH (NOLOCK) On je2.EmployeeId = e.EmployeeId
              Where
                    je2.MainEmployee = 1
                          And
                    je2.JobId = j.JobId
              Order By
                    ActualStart
        ) as Surveyors
        Outer Apply
        (
              Select
                    Max(iat.DateCreated) as AnalysisCompleted
              From
                    IntranetAuditTrail iat WITH (NOLOCK)
              Where
                    iat.DataId = j.JobID and
                    iat.DataTable = 'Job' and 
                    iat.[Message] = 'Verified sample results'
        ) iat
        Outer Apply
        (
              Select Top 1 FileName From PDF WITH (NOLOCK) Where DateDeleted Is Null and FileName Like '%bsr%' and JobId = j.JobId Order By FileName DESC
        ) bsr
        LEFT JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID AND na.Deleted IS NULL
        LEFT JOIN NoAccess na2 WITH (NOLOCK) ON na2.SiteID = s.SiteID AND na2.Deleted IS NULL
        Outer Apply
        (
              Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) pc
        Outer Apply
        (
              Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) l
              OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone


  Where
        a.AppointmentId = (Select Min(AppointmentId) From Appointment WITH (NOLOCK) Where QuoteId = q.QuoteId And DateDeclined Is Null)
        and a.DateDeclined Is Null
  Group By
        j.JobId,
        j.JobNo,
        s.SiteId,
        s.[Address],
        s.Postcode,
        j.Approved,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        a.ClientOrderNo,
        s.uprn,
        Surveyors.Surveyor,
        Approver.FullName,
        [p].[GroupName],
        a.ClientId,
        a.ProjectId,
        a.SiteId,
        reg.SurveyTypeId,
        reg.SurveyType,
        reg.AnalysisComplete,
        reg.Samples,
        reg.SampleResults,
        reg.Registers,
        reg.DateApproved,
        reg.RegisterFinish,
        reg.SiteWorkComplete,
        bsr.FileName,
        iat.AnalysisCompleted,
        s.Other,
        pc.PhoneCalls,
        l.Letters,
        q.QuoteId,
        workdone.ManuallyMarkWorkDone,
        sc.SupplementaryChangeId,
		ii.ItemDate

Union

Select
    1 as SortOrder,
    Null as AppointmentId, 
    'Unscheduled' as [Status],
    Null as [StatusDate],
    Null as JobNo,
    s.[Address],
    s.Postcode,
    s.Contact,
    s.Telephone,
    s.SiteEmail,
    Null as JobId,
    Null as SurveyTypeId,
    Null as AppointmentDate,
    Null as DateSiteWorkComplete,
    Null as AnalysisComplete,
    Null as TotalJobs,
    Null as WorkScheduled,
    Null as SiteWorkComplete,
    Null as Samples,
    Null as SampleResults,
    Null as FileName,
    Null as ClientOrderNo,
    Null as DateReceived,
    Case
        When Not Max(q.Created) Is Null AND s.Deleted IS NULL Then
            dbo.FormatTeamsDate(Cast(Min(q.Created) as date), 1)
        Else
            null
    End [QuoteDate],
    s.UPRN,
    Null as SurveyType,
    Null as Surveyor,
    Null as SurveyStart,
    Null as SurveyCompleted,
    Null as AnalysisCompleted,
    Null as Approved,
    Null as ApprovedBy,
    Null as DueDate,
    0 as NoAccessAttempts,
    pc.PhoneCalls,
    l.Letters,
    p.GroupName,
    c.ClientId,
    ps.ProjectId,
    s.SiteId,
    s.Other,
    Null [LastNoAccessDate],
    Null [LastJobEmployeeDate],
    Case
        When Not Max(q.QuoteID) Is Null AND s.Deleted IS NULL Then
            q.QuoteID
        Else
            null
    End [QuoteID],
	dbo.CleanDate(ii.ItemDate) [InvoiceDate]
From
    [Site] s WITH (NOLOCK)
    Inner Join ClientSite c WITH (NOLOCK) On s.SiteId = c.SiteId AND c.ClientID > 0
    Inner join ProjectSite ps WITH (NOLOCK) On s.SiteId = ps.SiteId
    Inner Join Project p WITH (NOLOCK) On ps.ProjectId = p.ProjectId AND p.ClientID = c.ClientID
    Left Outer Join Appointment a WITH (NOLOCK) On ps.ProjectId = a.ProjectId And s.SiteId = a.SiteId AND a.AppointmentTypeID IN (1,3,9)
    left outer join Appointment dc WITH (NOLOCK) On dc.DateDeclined IS NULL AND dc.ProjectID = p.ProjectID AND dc.SiteID = s.SiteID AND dc.AppointmentTypeID IN (1,3,9)
	outer apply
	(
		SELECT TOP 1
			*
		FROM
			Quote _q WITH (NOLOCK)
		WHERE
			_q.SiteID = ps.SiteID 
				AND 
			_q.ProjectID = ps.ProjectID
				AND
			_q.Rejected IS NULL
	) q
    --left outer join Quote q WITH (NOLOCK) on q.SiteID = ps.SiteID AND q.ProjectID = ps.ProjectID AND q.Rejected IS NULL
	left join InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
    Outer Apply
    (
        Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
    ) pc
    Outer Apply
    (
        Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
    ) l
Where
    s.deleted Is NULL
		AND
	(
		(
			(a.AppointmentId Is NULL)
			or
			(a.AppointmentID is not null and dc.AppointmentID is null)
		)
			--OR
		--s.Deleted IS NOT NULL
	)
Group BY 
    s.[Address],
    s.Postcode,
    s.Contact,
    s.Telephone,
    s.SiteEmail,
    s.UPRN,
    p.GroupName,
    c.ClientId,
    ps.ProjectId,
    s.SiteId,
    s.Other,
    pc.PhoneCalls,
    l.Letters,
    q.QuoteID,
    q.Created,
	ii.ItemDate,
	s.Deleted

union
--AIR TESTS
  Select
        3 as SortOrder,
        a.AppointmentId as AppointmentId,
        CASE
            WHEN atDetails.[firstId] IS NULL THEN 'Airtest Scheduled'
            WHEN atDetails.[airtestFinish] IS NULL THEN 'Approved'
            WHEN atDetails.[airtestFinish] IS NOT NULL THEN 'Site Work Complete'
                     When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
        End [Status],
        null [StatusDate],
        dbo.FormatTeamsReference('J', j.JobNo)  /*+  ISNULL(' - ' + jobAtt.string ,'')*/ AS JobNo,
        s.[Address],
        s.Postcode,
        s.Contact,
        s.Telephone,
        s.SiteEmail,
        j.JobId,
        [a].[AppointmentID],
        Cast(a.StartTime as date) AS AppointmentDate,
        atDetails.[airtestFinish] DateSiteWorkComplete,
        null AnalysisComplete,
        0 TotalJobs,
        0 WorkScheduled,
        0 SiteWorkComplete,
        0 Samples,
        0 SampleResults,
        null FileName,
        a.ClientOrderNo,
        dbo.FormatTeamsDate(Cast(a.DateCreated as date), 1) AS DateReceived,
        dbo.FormatTeamsDate(Cast(q.Created as date), 1) AS QuoteDate,
        s.uprn,
        AirtestTypesList.[string],
        jobAirTEmpl.[string] Surveyor,
        dbo.FormatTeamsDate(CAST(atDetails.[airtestStart] as date), 1) AS SurveyStart,
        dbo.FormatTeamsDate(CAST(atDetails.[airtestFinish] as date) , 1) AS SurveyCompleted,
        null AnalysisCompleted,
        dbo.FormatTeamsDate(Cast(j.Approved as date),1) as Approved,
        NULL ApprovedBy,
        null DueDate,
        na.NoAccessAttempts,
        pc.PhoneCalls,
        l.Letters,
        [p].[GroupName],
        j.ClientId,
        j.ProjectId,
        j.SiteId,
        s.Other,
        lna.Created [LastNoAccessDate],
        lje.Created [LastJobEmployeeDate],
        q.QuoteId,
		dbo.CleanDate(ii.ItemDate) [InvoiceDate]
  FROM
        [dbo].[Job] j WITH (NOLOCK)
        Inner Join [Site] s WITH (NOLOCK) On j.SiteId = s.SiteId and s.Deleted Is Null
        INNER JOIN project p WITH (NOLOCK) ON j.[ProjectID] = [p].[ProjectID]
		LEFT OUTER JOIN [dbo].[Quote] q WITH (NOLOCK) ON j.[JobID] = [q].[JobID] AND j.[Cancelled] IS NULL
		LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
        /*all the airtest types that have been done and passed back concatenate*/
        OUTER APPLY
        (
            select
            STUFF(
                    (
                        SELECT DISTINCT
                            ',' + ISNULL([att].[Description],'') [text()]
                        FROM
                            [dbo].[JobEmployee] je WITH (NOLOCK)
                            LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                            LEFT OUTER JOIN [dbo].[AirTest] at WITH (NOLOCK) ON [at].[JobEmployeeID] = [je].[JobEmployeeID]
                            LEFT OUTER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [at].[AirTestTypeID]
                        WHERE 
                            je.[JobID] = [j].[JobID]
                        FOR XML PATH('')
                     ),
                    1,
                    1,
                    ''
            )
        )jobAtt(string)
        /*all the airtest surveyor that have been passed back concatenate*/
        OUTER APPLY
        (
            select
            STUFF(
                    (
                        SELECT DISTINCT
                            ',' + ISNULL([emp].[FullName],'') [text()]
                        FROM
                            [dbo].[JobEmployee] je WITH (NOLOCK)
                            LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                        WHERE 
                            je.[JobID] = [j].[JobID]
                        FOR XML PATH('')
                     ),
                    1,
                    1,
                    ''
            )
        )jobAirTEmpl(string)
        /*all the airtest details concatenate*/
        OUTER apply(
            SELECT
                MIN([at].[AirTestID]),
                MIN([at].[AirTestStart]),
                MAX([at].[AirTestFinish])
            FROM
                [dbo].[JobEmployee] je WITH (NOLOCK)
                LEFT OUTER JOIN [dbo].[Employee] emp WITH (NOLOCK) ON je.[EmployeeID] = [emp].[EmployeeID]
                LEFT OUTER JOIN [dbo].[AirTest] at WITH (NOLOCK) ON [at].[JobEmployeeID] = [je].[JobEmployeeID]
                LEFT OUTER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [at].[AirTestTypeID]
            WHERE 
                je.[JobID] = [j].[JobID]
        )atDetails(firstId,airtestStart,airtestFinish)
        
        
        
        /*get first appointment record for quote*/
        outer apply
        (
            SELECT TOP 1
                _a.[AppointmentID],
                _a.[StartTime],
                _a.[ProjectID]
            FROM
                [dbo].[Appointment] _a WITH (NOLOCK)
                INNER JOIN Quote _q WITH (NOLOCK) ON _q.QuoteID = _a.QuoteID
            WHERE
                _q.JobID = j.JobID
                AND _a.DateDeclined Is NULL
            ORDER BY 
                _a.[StartTime]
        )firstapp(id,startTime,projectId)
        LEFT OUTER JOIN Appointment a WITH (NOLOCK) ON a.[AppointmentID]= [firstapp].[id]
        LEFT OUTER JOIN [dbo].[AppointmentAirMonitoring] as aps WITH (NOLOCK) On a.AppointmentID = aps.AppointmentID
        
        /*all the airtest types that were asked for IN THE APPOINTMENT*/
        OUTER APPLY
        (
            SELECT
                STUFF(
                        (
                            SELECT
                                ','+ ISNULL([att].[Description],'') [text()]
                            FROM
                                [dbo].[AppointmentAirMonitoringType] amt WITH (NOLOCK)
                                INNER JOIN [dbo].[AirTestType] att WITH (NOLOCK) ON [att].[AirTestTypeID] = [amt].[AirTestTypeID]
                            WHERE 
                                [amt].[AppointmentAirMonitoringID] =[aps].[AppointmentAirMonitoringID]
                            FOR XML PATH('')
                        ),
                        1,
                        1,
                        ''
                )
        )AirtestTypesList(string)
        Outer Apply
        (
              Select Count(*) as NoAccessAttempts From NoAccess WITH (NOLOCK) Where JobId = j.jobid Or SiteId = s.SiteId
        ) na
        Outer Apply
        (
              Select Count(*) as PhoneCalls From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 1 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) pc
        Outer Apply
        (
              Select Count(*) as Letters From SiteContact WITH (NOLOCK) Where SiteID = s.SiteID AND ContactTypeID = 2 AND Datedeleted IS NULL AND ProjectID = p.ProjectID
        ) l
        Outer Apply
        (
            Select top 1 lna.Created From NoAccess lna WITH (NOLOCK) Where lna.jobid = j.jobid order by lna.Created desc
        ) lna
        Outer Apply
        (
            Select top 1 lje.Created From jobemployee lje WITH (NOLOCK) Where lje.jobid = j.jobid order by lje.Created desc
        ) lje
              OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone
    WHERE [q].[QuoteTypeID] =5

UNION -- Legionella

SELECT
    4 [SortOrder],
    a.AppointmentID [AppointmentId],
    CASE
        WHEN l.DateApproved IS NOT NULL THEN 'Approved'
        WHEN l.Registers >= 1 THEN 'Site Work Complete'
              When workdone.ManuallyMarkWorkDone = 1 THEN 'Marked as Complete'
        ELSE 'Work Scheduled'
    END [Status],
    dbo.FormatTeamsDate(
        CASE
            WHEN l.DateApproved IS NOT NULL THEN l.DateApproved
            WHEN l.Registers >= 1 THEN l.LegionellaFinish
            ELSE CAST(a.DateCreated AS DATE)
        END, 1) [StatusDate],
    dbo.FormatTeamsReference('J', j.JobNo) [JobNo],
    si.Address,
    si.Postcode,
    si.Contact,
    si.Telephone,
    si.SiteEmail,
    j.JobID,
    legt.LegionellaTypeID [SurveyTypeId],
    CAST(a.StartTime AS DATE) [AppointmentDate],
    l.LegionellaFinish [DateSiteWorkComplete],
    NULL [AnalysisComplete],
    1 [TotalJobs],
    1 - l.Registers [WorkScheduled],
    l.Registers [SiteWorkComplete],
    NULL [Samples],
    NULL [SampleResults],
    NULL [FileName],
    a.ClientOrderNo,
    dbo.FormatTeamsDate(CAST(MIN(a.DateCreated) AS DATE), 1) [DateReceived],
    dbo.FormatTeamsDate(CAST(MIN(q.Created) AS DATE), 1) [QuoteDate],
    si.UPRN [uprn],
    legt.Description [SurveyType],
    sur.Surveyor,
    dbo.FormatTeamsDate(CAST(MIN(a.StartTime) AS DATE), 1) [SurveyStart],
    dbo.FormatTeamsDate(l.LegionellaFinish, 1) [SurveyCompleted],
    NULL [AnalysisCompleted],
    dbo.FormatTeamsDate(CAST(MAX(j.Approved) AS DATE), 1) [Approved],
    l.ApprovedBy,
    dbo.FormatTeamsDate(CAST(MIN(al.DueDate) AS DATE), 1) [DueDate],
    COUNT(na.NoAccessID) + COUNT(nasi.NoAccessID) [NoAccessAttempts],
    pc.PhoneCalls,
    le.Letters,
    p.GroupName,
    a.ClientID [ClientId],
    a.ProjectID [ProjectId],
    a.SiteID [SiteId],
    si.Other,
    MAX(na.Created) [LastNoAccessDate],
    MAX(l.JobEmployeeCreated) [LastJobEmployeeDate],
    q.QuoteID [QuoteId],
	dbo.CleanDate(ii.ItemDate) [InvoiceDate]
FROM
    Appointment a WITH (NOLOCK)
    INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON a.AppointmentID = al.AppointmentID
    INNER JOIN LegionellaType legt WITH (NOLOCK) ON al.LegionellaTypeID = legt.LegionellaTypeID
    INNER JOIN Project p WITH (NOLOCK) ON a.ProjectID = p.ProjectID AND p.Deleted IS NULL
    INNER JOIN Site si WITH (NOLOCK) ON a.SiteID = si.SiteID AND si.Deleted IS NULL
    INNER JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID AND q.Rejected IS NULL
	LEFT JOIN InvoiceItem ii WITH (NOLOCK) ON q.InvoiceItemID = ii.InvoiceItemID
	INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID AND j.Cancelled IS NULL
    OUTER APPLY
    (
        SELECT
            je.JobID,
            MAX(je.Created) [JobEmployeeCreated],
            COUNT(DISTINCT(l.LegionellaID)) [Registers],
            MAX(l.DateApproved) [DateApproved],
            MAX(CAST(l.LegionellaFinish AS DATE)) [LegionellaFinish],
            MAX(ae.FullName) [ApprovedBy]
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
            LEFT JOIN Employee ae WITH (NOLOCK) ON l.EmployeeID = ae.EmployeeID
        WHERE
            je.JobId = j.JobId
        GROUP BY
            je.JobID
    ) l
    OUTER APPLY
    (
        SELECT TOP 1
            e.FullName [Surveyor]
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
        WHERE
            je.JobID = j.JobID
                AND
            je.MainEmployee = 1
        ORDER BY
            je.ActualStart
    ) sur -- Surveyors
    LEFT JOIN NoAccess na WITH (NOLOCK) ON j.JobID = na.JobID
    LEFT JOIN NoAccess nasi WITH (NOLOCK) ON si.SiteID = nasi.SiteID
    OUTER APPLY
    (
        SELECT COUNT(*) [PhoneCalls] FROM SiteContact WITH (NOLOCK) WHERE ProjectID = p.ProjectID AND SiteID = si.SiteID AND DateDeleted IS NULL AND ContactTypeID = 1
    ) pc -- Phone Calls
    OUTER APPLY
    (
        SELECT COUNT(*) [Letters] FROM SiteContact WITH (NOLOCK) WHERE ProjectID = p.ProjectID AND SiteID = si.SiteID AND DateDeleted IS NULL AND ContactTypeID = 2
    ) le -- Letters
       OUTER APPLY
                     (
                           SELECT TOP 1
                                  a.ManuallyMarkWorkDone
                           FROM
                                  Appointment _a
                           WHERE  
                                  a.AppointmentID = _a.AppointmentID
                                         AND
                                  _a.ManuallyMarkWorkDone = 1
                     ) WorkDone
WHERE
    a.AppointmentID = (SELECT MIN(AppointmentID) FROM Appointment WITH (NOLOCK) WHERE QuoteID = q.QuoteID AND DateDeclined IS NULL)
GROUP BY
    q.QuoteID,
    a.AppointmentID,
    a.ClientID,
    a.ProjectID,
    a.SiteID,
    a.StartTime,
    a.ClientOrderNo,
    a.DateCreated,
    legt.LegionellaTypeID,
    legt.Description,
    p.Project,
    p.GroupName,
    si.SiteID,
    si.Address,
    si.Postcode,
    si.UPRN,
    si.Contact,
    si.Telephone,
    si.SiteEmail,
    si.Other,
    j.JobID,
    j.JobNo,
    j.Approved,
    l.JobEmployeeCreated,
    l.Registers,
    l.DateApproved,
    l.LegionellaFinish,
    l.ApprovedBy,
    sur.Surveyor,
    pc.PhoneCalls,
    le.Letters,
    workdone.ManuallyMarkWorkDone,
	ii.ItemDate

GO


IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ConfigTeamsSetup') AND name='HostedByUs') >= 1
BEGIN
  ALTER TABLE ConfigTeamsSetup DROP COLUMN HostedByUs
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Employee') AND name='DataMatching') >= 1
BEGIN
	ALTER TABLE Employee DROP CONSTRAINT DF_Employee_DataMatching
	ALTER TABLE Employee DROP COLUMN DataMatching;
END

GO
ALTER PROC [dbo].[Paged_GuidedDataStateSummary]
(
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filters
	@ClientID INT = 0,
	@SiteID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@GuidedDataStateTypeID INT = -1,
	@MinSeverity INT = 0,
	@MaxSeverity INT = 5,
	@Severity INT = -1
)
AS
BEGIN
	SET NOCOUNT ON;
    
	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1

	DECLARE @GuidedDataStateSummary TABLE (IndexID INT IDENTITY(1,1), ClientID INT, SiteID INT, DateChecked DATETIME)
	INSERT INTO @GuidedDataStateSummary (ClientID,SiteID,DateChecked)
	SELECT
		main.ClientID,main.SiteID,main.DateChecked
	FROM
		(
			SELECT
				cs.ClientID,cs.SiteID,gds.DateChecked,MAX(gdst.Severity) [HighestServerity], cs.[SubOrdering]
			FROM
				(
					Select 
						j.ClientID, j.SiteID,ROW_NUMBER() OVER (ORDER BY c.Client,si.Address) [SubOrdering]
					FROM
						Job j WITH (NOLOCK)
						INNER JOIN Site si WITH(NOLOCK) ON j.SiteID=si.SiteID
						INNER JOIN Client c WITH(NOLOCK) ON j.ClientID=c.ClientID
						INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
						INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
						INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
						INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = j.JobID
						INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
					WHERE
						j.Approved IS NOT NULL
							AND
						a.DateDeclined IS NULL
							AND
						(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
							AND
						(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
							AND
						j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
					GROUP BY
						j.ClientID, j.SiteID,c.Client,si.Address
				) cs
				LEFT OUTER JOIN GuidedDataState gds ON gds.ClientID=cs.ClientID AND gds.SiteID=cs.SiteID
				LEFT OUTER JOIN GuidedDataStateEntry gdse ON gds.GuidedDataStateID=gdse.GuidedDataStateID
				LEFT OUTER JOIN GuidedDataStateType gdst ON gdst.GuidedDataStateTypeID=gdse.GuidedDataStateTypeID
			WHERE
				ISNULL(gdst.Severity,0) BETWEEN @MinSeverity AND @MaxSeverity
					AND
				(CASE WHEN @GuidedDataStateTypeID < 0 THEN 1 ELSE CASE WHEN ISNULL(gdst.GuidedDataStateTypeID,0)=@GuidedDataStateTypeID THEN 1 ELSE 0 END END = 1)
			GROUP BY
				cs.ClientID,cs.SiteID,gds.DateChecked, cs.[SubOrdering]
		) main
	ORDER BY
		main.HighestServerity DESC, main.SubOrdering

	-- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @GuidedDataStateSummary)
    
	DECLARE @Paging TABLE (Row_Num INT, [Page] INT, [Pages] INT, ClientID INT, SiteID INT, DateChecked DATETIME)

    -- Use a CTE to setup paging.
    ;WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @GuidedDataStateSummary
           ) a
    )

	INSERT INTO @Paging (Row_Num, [Page], [Pages], ClientID, SiteID, DateChecked)
	SELECT 
		Row_Num, [Page], [Pages], ClientID, SiteID, DateChecked
	FROM
		Paging
	Where 
        (
            Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )

	SELECT
		@TotalRowNumber [TotalRows],
		main.Pages,
		main.Page,
		main.ClientID,
		main.SiteID,
		main.Client,
		main.SiteAddress,
		main.EmployeeID,
		main.ModificationBy,
		gdst.SeverityDescription [Status],
		main.StatusDetailed
	FROM
		(
			SELECT
				pag.Pages,
				pag.Page,
				pag.Row_Num,
				c.ClientID,
				si.SiteID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
				si.Address [SiteAddress],
				esd_m.EmployeeID [EmployeeID],
				emp.FullName [ModificationBy],
				MAX(gdst.Severity) [Severity],
				STUFF((SELECT ',' + CASE WHEN MAX(gdst.Severity) > 0 THEN '(' + CAST(sub_gdse.ErrorCount as varchar(MAX)) + ') ' ELSE '' END + sub_gdst.Description FROM GuidedDataStateEntry sub_gdse WITH(NOLOCK) INNER JOIN GuidedDataStateType sub_gdst WITH (NOLOCK) ON sub_gdst.GuidedDataStateTypeID=sub_gdse.GuidedDataStateTypeID WHERE sub_gdse.GuidedDataStateID=gds.GuidedDataStateID FOR XML PATH ('')), 1, 1, '') [StatusDetailed]
			FROM
				@Paging pag
				INNER JOIN Client c WITH (NOLOCK) ON pag.ClientID = c.ClientID
				INNER JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
				LEFT OUTER JOIN EnterpriseSiteData_Modification esd_m WITH (NOLOCK) ON pag.ClientID=esd_m.ClientID AND pag.SiteID=esd_m.SiteID AND esd_m.DateCompleted IS NULL AND esd_m.DateDiscarded IS NULL
				LEFT OUTER JOIN Employee emp WITH (NOLOCK) ON esd_m.EmployeeID=emp.EmployeeID
				LEFT OUTER JOIN GuidedDataState gds WITH (NOLOCK) ON gds.ClientID=pag.ClientID AND gds.SiteID=pag.SiteID
				LEFT OUTER JOIN GuidedDataStateEntry gdse WITH (NOLOCK) ON gds.GuidedDataStateID=gdse.GuidedDataStateID
				LEFT OUTER JOIN GuidedDataStateType gdst WITH (NOLOCK) ON gdst.GuidedDataStateTypeID=gdse.GuidedDataStateTypeID
			GROUP BY
				pag.Pages,
				pag.Page,
				pag.Row_Num,
				gds.GuidedDataStateID,
				c.ClientID,
				si.SiteID,
				c.Client + ISNULL(' (' + NULLIF(c.BranchName,'') + ')',''),
				si.Address,
				esd_m.EmployeeID,
				emp.FullName
		) main
		LEFT OUTER JOIN GuidedDataStateType gdst WITH (NOLOCK) ON gdst.Severity=main.Severity
	ORDER BY
		main.Row_Num

	SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'Documents')
BEGIN
    EXEC('CREATE VIEW[dbo].[Documents] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[Documents]
As

-- Enquiry Documents
Select
      d.EnquiryDocumentId as DocumentId,
      'Enquiry' as DocumentType,
      d.EnquiryId as DocumentTypeId,
      dbo.FormatTeamsReference('E', n.EnquiryNo) as DocumentTypeRef,
      d.FileName,
      Right(FileName, PatIndex('%.%', Reverse(FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      EnquiryDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join Enquiry n On n.EnquiryId = d.EnquiryId
Where
      d.Deleted Is Null
            AND
      FileName LIKE '%.%'

Union

-- Quote Documents.
Select
      d.QuoteDocumentId as DocumentId,
      'Quote' as DocumentType,
      d.QuoteId as DocumentTypeId,
      dbo.FormatTeamsReference('Q', q.QuoteNo) as DocumentTypeRef,
      d.FileName,
      Right(FileName, PatIndex('%.%', Reverse(FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      QuoteDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join Quote q On q.QuoteId = d.QuoteId
Where
      d.Deleted Is Null
            AND
      FileName LIKE '%.%'
      
Union

-- Job Documents.
Select
      d.JobDocumentId as DocumentId,
      'Job' as DocumentType,
      d.JobId as DocumentTypeId,
      dbo.FormatTeamsReference('J', j.JobNo) as DocumentTypeRef,
      d.FileName,
      Right(FileName, PatIndex('%.%', Reverse(FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      JobDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join Job j On j.JobId = d.JobId
Where
      d.Deleted Is Null
            AND
      FileName LIKE '%.%'

union

-- Invoice Documents.
Select
      d.InvoiceDocumentId as DocumentId,
      'Invoice' as DocumentType,
      d.InvoiceID as DocumentTypeId,
      dbo.FormatTeamsReference('I', i.InvoiceID) as DocumentTypeRef,
      d.FileName,
      Right(FileName, PatIndex('%.%', Reverse(FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      InvoiceDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join invoice i On i.invoiceid = d.invoiceid
Where
      d.Deleted Is Null
            AND
      FileName LIKE '%.%'

union

-- All Site Documents Types.
Select
      d.SiteDocumentId as DocumentId,
      ISNULL(sdt.Description, 'Site') as DocumentType,
      d.SiteID as DocumentTypeId,
      'Site' as DocumentTypeRef,
      d.FileName,
      Right(d.FileName, PatIndex('%.%', Reverse(d.FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      SiteDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join Site s On s.siteid = d.siteid
	  LEFT JOIN SiteDocumentType sdt on sdt.SiteDocumentTypeID = d.SiteDocumentTypeID
Where
      d.Deleted Is Null
            AND
      d.FileName LIKE '%.%'

union

-- Project Documents.
Select
      d.ProjectDocumentId as DocumentId,
      'Project' as DocumentType,
      d.ProjectId as DocumentTypeId,
      'Project' as DocumentTypeRef,
      d.FileName,
      Right(FileName, PatIndex('%.%', Reverse(FileName)) - 1) as Extension,
      d.Uploaded,
      d.EmployeeId,
      e.FullName as Employee
From
      ProjectDocument d
      Inner Join Employee e On e.EmployeeId = d.EmployeeId
      Inner Join ProjectGroup p On p.ProjectGroupId = d.ProjectId
Where
      d.Deleted Is Null
            AND
      FileName LIKE '%.%'
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='EnterpriseExternalSite') AND name='EnterpriseSiteAuthorised') < 1
BEGIN
	ALTER TABLE [dbo].[EnterpriseExternalSite]
		ADD [EnterpriseSiteAuthorised] [bit] NOT NULL
		CONSTRAINT [DF_EnterpriseExternalSite_EnterpriseSiteAuthorised]
		DEFAULT (0);
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseConsultancyList')) BEGIN
		
		CREATE TABLE [dbo].[EnterpriseConsultancyList](
			[EnterpriseConsultancyListID] [int] IDENTITY(1,1) NOT NULL,
			[ConsultancyName] [varchar](max) NOT NULL,
			[ConsultancyServerCode] [varchar](10) NOT NULL,
			[DateCreated] [datetime] NOT NULL,
			[DateDeleted] [datetime] NULL DEFAULT (getdate()),
			CONSTRAINT [PK_EnterpriseConsultancyList] PRIMARY KEY CLUSTERED ([EnterpriseConsultancyListID] ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY],
	 
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];
	
	END 
COMMIT TRANSACTION
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteAccessAuthorisation')) BEGIN
		
		CREATE TABLE [dbo].[EnterpriseSiteAccessAuthorisation](
			[EnterpriseSiteAccessAuthorisationID] [int] IDENTITY(1,1) NOT NULL,
			[SiteID] [int] NOT NULL,
			[ConsultancyServerCode] [varchar](10) NOT NULL,
			[EmployeeCreated] [int] NOT NULL,
			[DateCreated] [datetime] NOT NULL,
			[EmployeeLastUpdated] [int] NULL,
			[LastUpdated] [datetime] NULL,
			[DateDeleted] [datetime] NULL  DEFAULT (getdate()),
		 CONSTRAINT [PK_EnterpriseSiteAccessAuthorisation] PRIMARY KEY CLUSTERED 
		(
			[EnterpriseSiteAccessAuthorisationID] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY];

	END 
COMMIT TRANSACTION
GO

INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,Description,TabName,SortOrder,Deleted,DefaultAssetCode) Select 71,'Gas Fired Water Heater','Gas Fired Water Heater',99,GETDATE(),'GFWH' WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=71)=0
GO

IF (select c.max_length from sys.tables t inner join sys.columns c on t.object_id = c.object_id where t.name = 'project' AND c.name = 'GroupName') < 100
BEGIN
	ALTER TABLE Project
	ALTER COLUMN GroupName VARCHAR(100)
END
GO

IF NOT EXISTS(SELECT c.column_id FROM sys.tables t inner join sys.columns c on t.object_id = c.object_id where t.name = 'LegionellaOutlet' AND c.name = 'DateRemoved')
BEGIN
	ALTER TABLE LegionellaOutlet
	ADD [DateRemoved] [datetime] NULL;
END
GO

IF NOT EXISTS(SELECT c.column_id FROM sys.tables t inner join sys.columns c on t.object_id = c.object_id where t.name = 'LegionellaLocation' AND c.name = 'DateRemoved')
BEGIN
	ALTER TABLE LegionellaLocation
	ADD [DateRemoved] [datetime] NULL;
END
GO

IF NOT EXISTS(SELECT c.column_id FROM sys.tables t inner join sys.columns c on t.object_id = c.object_id where t.name = 'LegionellaAsset' AND c.name = 'DateRemoved')
BEGIN
	ALTER TABLE LegionellaAsset
	ADD [DateRemoved] [datetime] NULL;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'PopulateLegionellaOutletComputedData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[PopulateLegionellaOutletComputedData] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER Proc [dbo].[PopulateLegionellaOutletComputedData]
    @JobID INT
As
Begin
    Set NoCount On;
	Set Transaction Isolation Level Read Uncommitted;


	DECLARE @SiteID INT = (Select SiteID FROM Job Where JobID=@JobId)
	DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobId)

	--Clear out the data for the given job
	DELETE LegionellaOutletComputedData Where SiteID = @SiteID

	--Get historic temp data per outlet associated with the job
	DECLARE @LegionellaOutlet TABLE (PerformedByEmployeeID INT,LegionellaOutletID INT, LegionellaLocationID INT, [GUID] VARCHAR(MAX), GUIDVersion INT, LegionellaFinish DATETIME, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	Insert into @LegionellaOutlet (PerformedByEmployeeID,LegionellaOutletID,LegionellaLocationID,[GUID],GUIDVersion,LegionellaFinish,Cold,Hot,[Mixed],Mains, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		ISNULL(lo.FlushedCold, 0) [FlushedCold],
		ISNULL(lo.FlushedHot, 0) [FlushedHot],
		ISNULL(lo.FlushedMixed, 0) [FlushedMixed],
		ISNULL(lo.FlushedMains, 0) [FlushedMains],
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains
	FROM
		Job j WITH (NOLOCK)
		INNER JOIN Quote q WITH (NOLOCK) ON q.JobID=j.JobID
		INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL
		INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
		INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
		INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON ll.LegionellaID=l.LegionellaID-- AND ll.Deleted IS NULL
		INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON lo.LegionellaLocationID=ll.LegionellaLocationID-- AND lo.Deleted IS NULL
	Where
		j.SiteID=@SiteID
			AND
		j.ClientID=@ClientID
			AND
		(
			j.Approved IS NOT NULL
				OR
			j.JobID = @JobID
		)
	Group By
		je.EmployeeID,lo.LegionellaOutletID,lo.LegionellaLocationID,lo.[GUID],lo.GUIDVersion,l.LegionellaFinish,lo.Cold,lo.Hot,lo.[Mixed],lo.Mains,
		lo.FlushedCold,
		lo.FlushedHot,
		lo.FlushedMixed,
		lo.FlushedMains,
		lo.LowUseCold,
		lo.LowUseHot,
		lo.LowUseMixed,
		lo.LowUseMains

	DECLARE @LegionellaOutletComputedData TABLE (JobID INT, OriginalOutletID INT,LegionellaOutletID INT, LegionellaLocationID INT, Cold DECIMAL(10,2), Hot DECIMAL(10,2), [Mixed] DECIMAL(10,2), Mains DECIMAL(10,2), PerformedByEmployeeID INT, PerformedByPortalUserID INT, PerformedByThirdParty VARCHAR(MAX), Comments VARCHAR(MAX), Recorded DATETIME, FlushedCold BIT NOT NULL, FlushedHot BIT NOT NULL, FlushedMixed BIT NOT NULL, FlushedMains BIT NOT NULL, LowUseCold BIT NOT NULL, LowUseHot BIT NOT NULL, LowUseMixed BIT NOT NULL, LowUseMains BIT NOT NULL)
	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		main.JobID, main.LegionellaOutletID [OriginalOutletID],main.CurrentOutletID [LegionellaOutletID], main.CurrentLocationID [LegionellaLocationID],main.Cold,main.Hot,main.[Mixed],main.Mains,main.PerformedByEmployeeID,main.PerformedByPortalUserID,main.PerformedByThirdParty,main.Comments,main.Recorded, main.FlushedCold, main.FlushedHot, main.FlushedMixed, main.FlushedMains, main.LowUseCold, main.LowUseHot, main.LowUseMixed, main.LowUseMains
	FROM
		(
			Select
				@JobID [JobID], 
				lo.LegionellaOutletID [CurrentOutletID],
				lo.LegionellaLocationID [CurrentLocationID],
				ROW_NUMBER() OVER (Partition By loMax.GUID,loMax.LegionellaFinish Order by lo.LegionellaFinish DESC) [Identifier],
				loMax.LegionellaOutletID,
				loMax.[GUID],
				loMax.Cold,
				loMax.Hot,
				loMax.Mixed,
				loMax.Mains,
				loMax.PerformedByEmployeeID,
				NULL [PerformedByPortalUserID],
				NULL [PerformedByThirdParty],
				NULL [Comments],
				loMax.LegionellaFinish [Recorded],
				loMax.FlushedCold,
				loMax.FlushedHot,
				loMax.FlushedMixed,
				loMax.FlushedMains,
				loMax.LowUseCold,
				loMax.LowUseHot,
				loMax.LowUseMixed,
				loMax.LowUseMains
			FROM 
				@LegionellaOutlet lo
				INNER JOIN @LegionellaOutlet loMax ON lo.GUID=loMax.GUID				
		) main
		INNER JOIN LegionellaLocation _ll ON main.CurrentLocationID = _ll.LegionellaLocationID
		INNER JOIN LegionellaOutlet _lo ON main.CurrentOutletID = _lo.LegionellaOutletID		
	Where		
		main.Identifier = 1
			AND
		( _lo.Deleted IS NULL OR _lo.DateRemoved IS NULL )
			AND
		( _ll.Deleted IS NULL OR _ll.DateRemoved IS NULL )

	INSERT INTO @LegionellaOutletComputedData (JobID,OriginalOutletID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,[Mixed],Mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	SELECT
		locd.JobID,locd.OriginalOutletID,locd.LegionellaOutletID,locd.LegionellaLocationID,lopd.Cold,lopd.Hot,lopd.[Mixed],lopd.Mains,NULL [PerformedByEmployeeID],lopd.PerformedByPortalUserID,lopd.PerformedByThirdParty,lopd.Comments,lopd.Recorded, lopd.FlushedCold, lopd.FlushedHot, lopd.FlushedMixed, lopd.FlushedMains, lopd.LowUseCold, lopd.LowUseHot, lopd.LowUseMixed, lopd.LowUseMains
	FROM
		@LegionellaOutletComputedData locd
		INNER JOIN LegionellaOutletPortalData lopd ON locd.OriginalOutletID = lopd.LegionellaOutletID

	Insert into LegionellaOutletComputedData (ClientID,SiteID,JobID,LegionellaOutletID,LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains)
	Select
		@ClientID,@SiteID,JobID,LegionellaOutletID,locd.LegionellaLocationID,Cold,Hot,Mixed,mains,PerformedByEmployeeID,PerformedByPortalUserID,PerformedByThirdParty,Comments,Recorded, FlushedCold, FlushedHot, FlushedMixed, FlushedMains, LowUseCold, LowUseHot, LowUseMixed, LowUseMains
	FROM
		@LegionellaOutletComputedData locd

    Set NoCount Off;
End
GO

IF (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'EnterpriseSiteAccessAuthorisation' AND COLUMN_NAME = 'DateDeleted' AND COLUMN_DEFAULT='(getdate())') > 0
BEGIN
	DECLARE @DropConstraint NVARCHAR(MAX) = N'ALTER TABLE EnterpriseSiteAccessAuthorisation DROP CONSTRAINT [' + (Select dc.name FROM  sys.tables t INNER JOIN sys.Columns c ON t.object_id=c.object_id INNER JOIN sys.default_constraints dc ON dc.object_id=c.default_object_id WHERE t.name='EnterpriseSiteAccessAuthorisation' AND c.name = 'DateDeleted' AND dc.type_desc='DEFAULT_CONSTRAINT' AND dc.definition='(getdate())') + ']'
	EXEC(@DropConstraint)
END
GO

IF (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='EnterpriseSiteAccessAuthorisation')) BEGIN
	UPDATE EnterpriseSiteAccessAuthorisation SET DateDeleted=NULL WHERE DateCreated=DateDeleted
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'ClientPhotos')
BEGIN
    EXEC('CREATE VIEW[dbo].[ClientPhotos] AS SELECT 1 GO')
END
GO

ALTER VIEW [dbo].[ClientPhotos]
AS

Select j.ClientId, PhotoId, j.SiteID From NoAccess na Inner Join Job j On na.JobId = j.JobId Where Not PhotoId Is Null
Union All
Select j.ClientId, PhotoId, j.SiteID From Register r Inner Join JobEmployee je On r.JobEmployeeId = je.JobEmployeeId Inner Join Job j On je.JobId = j.JobId Where Not PhotoId Is Null
Union All
Select j.ClientId, PhotoId, j.SiteID From Removal r Inner Join JobEmployee je On r.RemovalJobEmployeeID = je.JobEmployeeId Inner Join Job j On je.JobId = j.JobId Where Not PhotoId Is Null
Union All
Select j.ClientId, p.PhotoId, j.SiteID From RemovalPhoto p Inner Join Removal r On r.RemovalId = p.RemovalId Inner Join JobEmployee je On r.RemovalJobEmployeeID = je.JobEmployeeId Inner Join Job j On je.JobId = j.JobId Where Not p.PhotoId Is Null
Union All
Select j.ClientId, s.PhotoId, j.SiteID From Sample s Inner Join Room r On s.RoomId = r.RoomId Inner Join Register reg On r.RegisterId = reg.RegisterId Inner Join JobEmployee je On reg.JobEmployeeId = je.JobEmployeeId Inner Join Job j On je.JobId = j.JobId Where Not s.PhotoId Is Null
Union All
Select j.ClientId, PhotoId, j.SiteID From SiteLog s Inner Join Job j On s.JobId = j.JobId Where Not PhotoId Is Null

UNION ALL

-- All Legionella Photos
SELECT
    j.ClientId,
    p.PhotoId,
    j.SiteID
FROM
    Job j WITH (NOLOCK)
    INNER JOIN (
        SELECT je.JobID, l.LegionellaID, p.PhotoID
        FROM
            JobEmployee je WITH (NOLOCK)
            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
            INNER JOIN (
                -- 1. Legionella Photos
                SELECT l.LegionellaID, l.PhotoID
                FROM
                    Legionella l WITH (NOLOCK)
                
                UNION ALL
                
                -- 2. LegionellaAsset Photos
                SELECT la.LegionellaID, la.PhotoID
                FROM
                    LegionellaAsset la WITH (NOLOCK)
				WHERE
					la.DateRemoved IS NULL

				UNION ALL

				-- 2.a Question Photos
				SELECT la.LegionellaID, p.PhotoID
                FROM
                    LegionellaAsset la WITH (NOLOCK)
					INNER JOIN LegionellaAssetOutletDataCollection laodc WITH (NOLOCK) ON la.LegionellaAssetID = laodc.LegionellaAssetID
					INNER JOIN PhotoCollection pc WITH (NOLOCK) ON laodc.LegionellaAssetOutletDataCollectionID = pc.LegionellaAssetOutletDataCollectionID
					INNER JOIN Photo p WITH (NOLOCK) ON pc.PhotoID = p.PhotoID
				WHERE
					la.DateRemoved IS NULL
                
                UNION ALL
                
                -- 3. LegionellaOutlet Photos
                SELECT ll.LegionellaID, lo.PhotoID
                FROM
                    LegionellaLocation ll WITH (NOLOCK)
                    INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
				WHERE
					ll.DateRemoved IS NULL
						AND
					lo.DateRemoved IS NULL
                
                UNION ALL
                
                -- 4. Task Photos
                SELECT lt.LegionellaID, ltp.PhotoID
                FROM
                    (
                        -- 4.a. Legionella Task Photos
                        SELECT
                            lt.LegionellaID,
                            lt.LegionellaTaskID
                        FROM
                            LegionellaTask lt WITH (NOLOCK)
                        
                        UNION ALL
                        
                        -- 4.b. LegionellaAsset Task Photos
                        SELECT
                            la.LegionellaID,
                            lt.LegionellaTaskID
                        FROM
                            LegionellaAsset la WITH (NOLOCK)
                            INNER JOIN LegionellaTask lt WITH (NOLOCK) ON la.LegionellaAssetID = lt.LegionellaAssetID
						WHERE
							la.DateRemoved IS NULL
                        
                        UNION ALL
                        
                        -- 4.c. LegionellaLocation Task Photos
                        SELECT
                            ll.LegionellaID,
                            lt.LegionellaTaskID
                        FROM
                            LegionellaLocation ll WITH (NOLOCK)
                            INNER JOIN LegionellaTask lt WITH (NOLOCK) ON ll.LegionellaLocationID = lt.LegionellaLocationID
						WHERE
							ll.DateRemoved IS NULL
                        
                        UNION ALL
                        
                        -- 4.d. LegionellaOutlet Task Photos
                        SELECT
                            ll.LegionellaID,
                            lt.LegionellaTaskID
                        FROM
                            LegionellaLocation ll WITH (NOLOCK)
                            INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
                            INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lo.LegionellaOutletID = lt.LegionellaOutletID
						WHERE
							ll.DateRemoved IS NULL
								AND
							lo.DateRemoved IS NULL
                    ) lt
                    INNER JOIN LegionellaTaskPhoto ltp WITH (NOLOCK) ON lt.LegionellaTaskID = ltp.LegionellaTaskID
            ) p ON l.LegionellaID = p.LegionellaID AND p.PhotoID IS NOT NULL
    ) p ON j.JobID = p.JobID

UNION ALL
-- Sample Photo Collection Photos
Select j.ClientId, pc.PhotoId, j.SiteID From PhotoCollection pc Inner Join Sample s On pc.SampleID = s.SampleID Inner Join Room r On s.RoomId = r.RoomId Inner Join Register reg On r.RegisterId = reg.RegisterId Inner Join JobEmployee je On reg.JobEmployeeId = je.JobEmployeeId Inner Join Job j On je.JobId = j.JobId Where Not pc.PhotoId Is Null

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetAppointments') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetAppointments] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetAppointments]
    @PortalUserID INT,
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @StartDate DATETIME = NULL,
    @EndDate DATETIME = NULL,
    @ClientOrderNo VARCHAR(50) = '',
    @UPRN VARCHAR(50) = '',
    @AddressSearchString VARCHAR(200) = '',
    @EmployeeID INT = NULL
/**********************************************************************
** Overview: Get a filtered collection of Appointments for the Portal.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @EndDate = ISNULL(@EndDate, @StartDate),
        @ClientOrderNo = NULLIF(LTRIM(RTRIM(@ClientOrderNo)), ''),
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @AddressSearchString = NULLIF(LTRIM(RTRIM(@AddressSearchString)), ''),
        @EmployeeID = NULLIF(@EmployeeID, 0)

    -- Cast DATETIME to DATE. Set the EndDate to midnight.
    SELECT
        @StartDate = CAST(@StartDate AS DATE),
        @EndDate = CAST(CAST(CAST(@EndDate AS DATE) AS VARCHAR(10)) + ' 23:59:59.997' AS DATETIME)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Sites up front to reduce table scans on the Site table and only get the ones needed.
    DECLARE @SiteIdData TABLE (SiteID INT PRIMARY KEY)
    IF @SiteIDs IS NOT NULL
    BEGIN
        INSERT INTO @SiteIdData (SiteID)
        SELECT LTRIM(RTRIM(s)) [SiteID]
        FROM dbo.SplitString(@SiteIDs, ',')
        WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
        GROUP BY s
    END


    -- Start the main SELECT.
    SELECT
        a.AppointmentID,
        a.AppointmentTypeID,
        a.DateConfirmed,
        a.ClientID,
        a.ProjectID,
        a.SiteID,
        a.StartTime,
        a.EndTime,
        a.DateCreated,
        CAST(a.Notes AS VARCHAR(MAX)) [Notes],
        si.Address,
        j.JobNo,
        CASE WHEN j.Approved IS NOT NULL THEN j.SiteID ELSE NULL END [JobSiteID],
        COALESCE(sut.Description, lt.Description, at.AppointmentType) [AppointmentType],
        lt.LegionellaAssetCategoryID,
        CASE WHEN j.Approved IS NOT NULL THEN la.LegionellaAssetID ELSE NULL END [LegionellaAssetID]
    FROM
        Appointment a WITH (NOLOCK)
        INNER JOIN AppointmentType at WITH (NOLOCK) ON a.AppointmentTypeID = at.AppointmentTypeID
        LEFT JOIN AppointmentSurvey asu WITH (NOLOCK) ON a.AppointmentID = asu.AppointmentID
        LEFT JOIN SurveyType sut WITH (NOLOCK) ON asu.SurveyTypeID = sut.SurveyTypeID
        LEFT JOIN AppointmentLegionella al WITH (NOLOCK) ON a.AppointmentID = al.AppointmentID
        LEFT JOIN LegionellaType lt WITH (NOLOCK) ON al.LegionellaTypeID = lt.LegionellaTypeID
        INNER JOIN Client c WITH (NOLOCK) ON a.ClientID = c.ClientID
        INNER JOIN @ClientIdData cid ON c.ClientID = cid.ClientID
        LEFT JOIN AppointmentEmployee ae WITH (NOLOCK) ON a.AppointmentID = ae.AppointmentID
        LEFT JOIN Employee e WITH (NOLOCK) ON ae.EmployeeID = e.EmployeeID
        LEFT JOIN Project p WITH (NOLOCK) ON a.ProjectID = p.ProjectID
        LEFT JOIN Site si WITH (NOLOCK) ON a.SiteID = si.SiteID
        LEFT JOIN Quote q WITH (NOLOCK) ON a.QuoteID = q.QuoteID
        LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
        OUTER APPLY
        (
            SELECT TOP 1
                la.LegionellaAssetID
            FROM
                JobEmployee je WITH (NOLOCK)
                INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID AND l.DateApproved IS NOT NULL
            WHERE
                je.JobID = j.JobID
                    AND
                la.LegionellaAssetCategoryID = lt.LegionellaAssetCategoryID
                    AND
                la.Deleted IS NULL
					AND
				la.DateRemoved IS NULL
            ORDER BY
                l.LegionellaStart,
                la.SortOrder
        ) la
    WHERE
        si.Deleted IS NULL
            AND
        a.DateDeclined IS NULL
            AND
        a.ProjectAppointmentID IS NULL
            AND
        (
            DATEADD(dd, 0, DATEDIFF(dd, 0, a.StartTime)) BETWEEN @StartDate AND @EndDate
                OR
            DATEADD(dd, 0, DATEDIFF(dd, 0, a.EndTime)) BETWEEN @StartDate AND @EndDate
        )
            AND
        (@ProjectGroupID IS NULL OR p.ProjectGroupID = @ProjectGroupID)
            AND
        (@ProjectID IS NULL OR p.ProjectID = @ProjectID)
            AND
        (
            @SiteIDs IS NULL
                OR
            (
                @SiteIDs IS NOT NULL
                    AND
                si.SiteID IN (SELECT SiteID FROM @SiteIdData)
            )
        )
            AND
        (
            @ClientOrderNo IS NULL
                OR
            (
                @ClientOrderNo IS NOT NULL
                    AND
                (a.ClientOrderNo LIKE '%' + @ClientOrderNo + '%' OR j.ClientOrderNo LIKE '%' + @ClientOrderNo + '%')
            )
        )
            AND
        (@UPRN IS NULL OR (@UPRN IS NOT NULL AND si.UPRN = @UPRN))
            AND
        (
            @AddressSearchString IS NULL
                OR
            (
                @AddressSearchString IS NOT NULL
                    AND
                (
                    si.Address LIKE '%' + @AddressSearchString + '%'
                        OR
                    si.PostCode LIKE '%' + @AddressSearchString + '%'
                        OR
                    si.Address + ', ' + ISNULL(si.Postcode, '') LIKE '%' + @AddressSearchString + '%'
                        OR
                    si.UPRN = @AddressSearchString
                        OR
                    j.ClientOrderNo = @AddressSearchString
                )
            )
        )
            AND
        (@EmployeeID IS NULL OR ae.EmployeeID = @EmployeeID)
    GROUP BY
        a.AppointmentID,
        a.AppointmentTypeID,
        a.DateConfirmed,
        a.ClientID,
        a.ProjectID,
        a.SiteID,
        a.StartTime,
        a.EndTime,
        a.DateCreated,
        CAST(a.Notes AS VARCHAR(MAX)),
        si.Address,
        j.JobNo,
        j.Approved,
        j.SiteID,
        at.AppointmentType,
        sut.Description,
        lt.Description,
        lt.LegionellaAssetCategoryID,
        la.LegionellaAssetID


    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaAssetAndOutletQuestions') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaAssetAndOutletQuestions] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaAssetAndOutletQuestions]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @IncludeLegionella BIT,
    @IncludeAssets BIT,
    @IncludeLocations BIT,
    @IncludeOutlets BIT,
    @IncludeQuestionsNotAnswered BIT,
    @LegionellaID INT = 0,
    @LegionellaAssetID INT = 0,
    @LegionellaLocationID INT = 0,
    @LegionellaOutletID INT = 0,
    @LegionellaQuestionID INT = 0,
    @LegionellaSectionID INT = 0,
    @QuestionSubTabTitle VARCHAR(MAX) = NULL,
    @QuestionGroupTitle VARCHAR(MAX) = NULL,
    @ForcePageBreaks BIT = 0, -- This forces it to start a new page for each Asset/Outlet
    @ReplaceVariable VARCHAR(100) = NULL -- Used for getting the max rows per page of a row template, so it can break early if need be
/**********************************************************************
** Overview: Get Legionella, Asset, Location and Outlet dynamic questions and answers. It also gets Task data for the questions that trigger a risk.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@IncludeLegionella BIT = 0,
        --@IncludeAssets BIT = 0,
        --@IncludeLocations BIT = 0,
        --@IncludeOutlets BIT = 1,
        --@IncludeQuestionsNotAnswered BIT = 1,
        --@LegionellaID INT = 0,
        --@LegionellaAssetID INT = 0,
        --@LegionellaLocationID INT = 0,
        --@LegionellaOutletID INT = 0,
        --@LegionellaQuestionID INT = 0,
        --@LegionellaSectionID INT = 0,
        --@QuestionSubTabTitle VARCHAR(MAX) = NULL,
        --@QuestionGroupTitle VARCHAR(MAX) = NULL,
        --@ForcePageBreaks BIT = 0,
        --@ReplaceVariable VARCHAR(100) = 'LEGIONELLAASSETQUESTIONS'
    -- END DEBUG
    
    -- Set IDs lower down the tree if IDs higher up the tree are set.
    IF @LegionellaAssetID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaAsset WITH (NOLOCK)
        WHERE LegionellaAssetID = @LegionellaAssetID AND DateRemoved IS NULL
    END
    IF @LegionellaOutletID > 0 AND @LegionellaLocationID = 0
    BEGIN
        SELECT @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID)
        FROM LegionellaOutlet WITH (NOLOCK)
        WHERE LegionellaOutletID = @LegionellaOutletID AND DateRemoved IS NULL
    END
    IF @LegionellaLocationID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaLocation WITH (NOLOCK)
        WHERE LegionellaLocationID = @LegionellaLocationID AND DateRemoved IS NULL
    END

    -- Set variables used for logic.
    DECLARE @MaxRowsPerPage INT, @MaxRowsPerPageAdditionalPagesOverride INT
    SELECT
        @MaxRowsPerPage = COALESCE(rtmro.MaxRowsPerPage, rt.MaxRowsPerPage, 0),
        @MaxRowsPerPageAdditionalPagesOverride = COALESCE(rtmro.MaxRowsPerPageAdditionalPagesOverride, NULLIF(rt.MaxRowsPerPageAdditionalPagesOverride, 0), rtmro.MaxRowsPerPage, rt.MaxRowsPerPage, 0)
    FROM
        RowTemplate rt WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT
                rtmro.MaxRowsPerPage,
                rtmro.MaxRowsPerPageAdditionalPagesOverride
            FROM
                RowTemplateMaxRowsOverride rtmro WITH (NOLOCK)
            WHERE
                rtmro.ReplaceVariable = @ReplaceVariable
                    AND
                rtmro.JobID = @JobID
        ) rtmro
    WHERE
        rt.ReplaceVariable = @ReplaceVariable
    
    
    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)
    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)
    
    
    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)
    
    IF @IncludeAssets = 1
    BEGIN
        
        INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            la.LegionellaAssetID,
            la.PhotoID [AssetPhotoID],
            la.SystemRef [AssetSystemRef],
            la.Location [AssetLocation],
            la.SortOrder [AssetSortOrder],
            lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
            lrr.Description [AssetRiskRating],
            lrr.RiskColour [AssetRiskColour],
            lrr.SortOrder [AssetRiskRatingSortOrder],
            lac.LegionellaAssetCategoryID,
            lac.Description [AssetCategory],
            lac.SortOrder [AssetCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
            LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        WHERE
            la.Deleted IS NULL
                AND
			la.DateRemoved IS NULL
				AND
            (la.LegionellaAssetID = @LegionellaAssetID OR @LegionellaAssetID = 0)
        
    END
    
    
    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    IF @IncludeLocations = 1 OR @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            ll.LegionellaLocationID,
            ll.Location,
            ll.SortOrder [LocationSortOrder]

        FROM
            @LegionellaData l
            INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
        WHERE
            ll.Deleted IS NULL
                AND
			ll.DateRemoved IS NULL
				AND
            (ll.LegionellaLocationID = @LegionellaLocationID OR @LegionellaLocationID = 0)

    END
    
    
    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)
    
    IF @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            lo.LegionellaOutletID,
            lo.PhotoID [OutletPhotoID],
            lo.SystemRef [OutletSystemRef],
            ll.LegionellaLocationID,
            ll.Location,
            ll.LocationSortOrder,
            lo.Cold [OutletCold],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletColdTriggered],
            lo.Hot [OutletHot],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletHotTriggered],
            lo.Mixed [OutletMixed],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMixedTriggered],
            lo.Mains [OutletMains],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMainsTriggered],
            lo.SentinelCold [OutletSentinelCold],
            lo.SentinelHot [OutletSentinelHot],
            lo.SentinelMixed [OutletSentinelMixed],
            lo.SentinelMains [OutletSentinelMains],
            lo.SortOrder [OutletSortOrder],
            lo.FlushedCold [OutletFlushedCold],
            lo.FlushedHot [OutletFlushedHot],
            lo.FlushedMixed [OutletFlushedMixed],
            lo.FlushedMains [OutletFlushedMains],
            lo.LowUseCold [OutletLowUseCold],
            lo.LowUseHot [OutletLowUseHot],
            lo.LowUseMixed [OutletLowUseMixed],
            lo.LowUseMains [OutletLowUseMains],
            sca.OutletSourceColdAssetID,
            sca.OutletSourceColdAssetSystemRef,
            sca.OutletSourceColdAssetLocation,
            sca.OutletSourceColdAssetCategory,
            sha.OutletSourceHotAssetID,
            sha.OutletSourceHotAssetSystemRef,
            sha.OutletSourceHotAssetLocation,
            sha.OutletSourceHotAssetCategory,
            sma.OutletSourceMixedAssetID,
            sma.OutletSourceMixedAssetSystemRef,
            sma.OutletSourceMixedAssetLocation,
            sma.OutletSourceMixedAssetCategory,
            smna.OutletSourceMainsAssetID,
            smna.OutletSourceMainsAssetSystemRef,
            smna.OutletSourceMainsAssetLocation,
            smna.OutletSourceMainsAssetCategory,
            loc.LegionellaOutletCategoryID,
            loc.Description [OutletCategory],
            loc.SortOrder [OutletCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
            INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
            LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceColdAssetID],
                    _la.SystemRef [OutletSourceColdAssetSystemRef],
                    _la.Location [OutletSourceColdAssetLocation],
                    _lac.Description [OutletSourceColdAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceCold
            ) sca -- Source Cold Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceHotAssetID],
                    _la.SystemRef [OutletSourceHotAssetSystemRef],
                    _la.Location [OutletSourceHotAssetLocation],
                    _lac.Description [OutletSourceHotAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceHot
            ) sha -- Source Hot Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMixedAssetID],
                    _la.SystemRef [OutletSourceMixedAssetSystemRef],
                    _la.Location [OutletSourceMixedAssetLocation],
                    _lac.Description [OutletSourceMixedAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMixed
            ) sma -- Source Mixed Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMainsAssetID],
                    _la.SystemRef [OutletSourceMainsAssetSystemRef],
                    _la.Location [OutletSourceMainsAssetLocation],
                    _lac.Description [OutletSourceMainsAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMains
            ) smna -- Source Mains Asset
        WHERE
            lo.Deleted IS NULL
                AND
			lo.DateRemoved IS NULL
				AND
            (lo.LegionellaOutletID = @LegionellaOutletID OR @LegionellaOutletID = 0)
        
    END
    
    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold BIT, OutletSentinelHot BIT, OutletSentinelMixed BIT, OutletSentinelMains BIT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaAssetOutletQuestionID INT, QuestionSubTabTitle VARCHAR(MAX), QuestionGroupTitle VARCHAR(MAX), Question VARCHAR(MAX), EntryType VARCHAR(MAX), NullReplace VARCHAR(MAX), ReplaceVariable VARCHAR(MAX), LegionellaAssetOutletQuestionSortOrder INT, QuestionRowIDForAssetOutlet INT, LegionellaAssetOutletDataCollectionID INT, DataCollectionText VARCHAR(MAX), DataCollectionInt INT, AnswerText VARCHAR(MAX), LegionellaTaskID INT, LegionellaTaskNo INT, TaskRiskDescription VARCHAR(MAX), TaskAction VARCHAR(MAX), TaskSortOrder INT, LegionellaRiskCategoryID INT, RiskCategory VARCHAR(MAX), RiskCategorySortOrder INT, LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(MAX), FrequencyCategoryDateAddModifier VARCHAR(20), FrequencyCategoryDateAddValue INT, FrequencyCategoryDateCalc DATETIME, FrequencyCategorySortOrder INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, LegionellaPriorityRatingID INT, PriorityRating VARCHAR(MAX), ShortPriorityRating VARCHAR(20), PriorityColour VARCHAR(15), PriorityRatingSortOrder INT, LegionellaTaskAutoInsertTypeID INT, TaskAutoInsertType VARCHAR(MAX), LegionellaTaskEventID INT, EventPerformedByEmployeeID INT, EventPerformedByPortalUserID INT, EventPerformedByThirdParty VARCHAR(MAX), EventPerformedBy VARCHAR(MAX), EventComments VARCHAR(MAX), EventRecorded DATETIME, EventCreated DATETIME, IsFirstItemWithQuestions BIT)
    
    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaAssetOutletQuestionID, QuestionSubTabTitle, QuestionGroupTitle, Question, EntryType, NullReplace, ReplaceVariable, LegionellaAssetOutletQuestionSortOrder, QuestionRowIDForAssetOutlet, LegionellaAssetOutletDataCollectionID, DataCollectionText, DataCollectionInt, AnswerText, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated, IsFirstItemWithQuestions)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        laoq.LegionellaAssetOutletQuestionID,
        laoq.SubTabTitle [QuestionSubTabTitle],
        laoq.GroupTitle [QuestionGroupTitle],
        dbo.HtmlEncode(laoq.Description) [Question],
        laoq.EntryType,
        laoq.NullReplace,
        laoq.ReplaceVariable,
        laoq.SortOrder [LegionellaAssetOutletQuestionSortOrder],
        -- When updating ROW_NUMBER() logic, make sure you update the ORDER BY below.
        ROW_NUMBER() OVER(PARTITION BY lao.LegionellaAssetOutletID, lao.LegionellaLocationID, lao.LegionellaID, lao.RowType ORDER BY laoq.SortOrder) [QuestionRowIDForAssetOutlet],
        laodc.LegionellaAssetOutletDataCollectionID,
        laodc.DataText [DataCollectionText],
        laodc.DataInt [DataCollectionInt],
        COALESCE(NULLIF(dbo.HtmlEncode(laodc.DataText), ''), CAST(laodc.DataInt AS VARCHAR(MAX)), laoq.NullReplace) [AnswerText],
        lt.LegionellaTaskID,
        lt.LegionellaTaskNo,
        lt.TaskRiskDescription,
        lt.TaskAction,
        lt.TaskSortOrder,
        lt.LegionellaRiskCategoryID,
        lt.RiskCategory,
        lt.RiskCategorySortOrder,
        lt.LegionellaFrequencyCategoryID,
        lt.FrequencyCategory,
        lt.FrequencyCategoryDateAddModifier,
        lt.FrequencyCategoryDateAddValue,
        lt.FrequencyCategoryDateCalc,
        lt.FrequencyCategorySortOrder,
        lt.LegionellaRiskRatingID,
        lt.RiskRating,
        lt.RiskColour,
        lt.RiskRatingSortOrder,
        lt.LegionellaPriorityRatingID,
        lt.PriorityRating,
        lt.ShortPriorityRating,
        lt.PriorityColour,
        lt.PriorityRatingSortOrder,
        lt.LegionellaTaskAutoInsertTypeID,
        lt.TaskAutoInsertType,
        lt.LegionellaTaskEventID,
        lt.EventPerformedByEmployeeID,
        lt.EventPerformedByPortalUserID,
        lt.EventPerformedByThirdParty,
        lt.EventPerformedBy,
        lt.EventComments,
        lt.EventRecorded,
        lt.EventCreated,
        NULL [IsFirstItemWithQuestions]
        
    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
            WHERE @IncludeLegionella = 1
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
            WHERE @IncludeAssets = 1
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
            WHERE @IncludeLocations = 1
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
            WHERE @IncludeOutlets = 1
        ) lao
        INNER JOIN LegionellaAssetOutletQuestion laoq WITH (NOLOCK) ON
            CASE lao.RowType -- Join based on the main UNION
                WHEN 1 THEN 1
                WHEN 3 THEN 1
                ELSE lao.LegionellaAssetOutletCategoryID
            END =
            CASE lao.RowType -- Join based on this live table
                WHEN 1 THEN 1 -- Legionella questions handled below
                WHEN 2 THEN laoq.LegionellaAssetCategoryID
                WHEN 3 THEN 1 -- Location questions handled below
                WHEN 4 THEN laoq.LegionellaOutletCategoryID
            END
        LEFT JOIN LegionellaAssetOutletDataCollection laodc WITH (NOLOCK) ON laoq.LegionellaAssetOutletQuestionID = laodc.LegionellaAssetOutletQuestionID AND
            CASE lao.RowType -- Join based on the main UNION
                WHEN 1 THEN lao.LegionellaID
                WHEN 3 THEN lao.LegionellaLocationID
                ELSE lao.LegionellaAssetOutletID
            END =
            CASE lao.RowType -- Join based on this live table
                WHEN 1 THEN laodc.LegionellaID
                WHEN 2 THEN laodc.LegionellaAssetID
                WHEN 3 THEN laodc.LegionellaLocationID
                WHEN 4 THEN laodc.LegionellaOutletID
            END
        OUTER APPLY
        (
            SELECT TOP 1
                lt.LegionellaTaskID,
                lt.LegionellaTaskNo,
                lt.RiskDescription [TaskRiskDescription],
                lt.Action [TaskAction],
                lt.SortOrder [TaskSortOrder],
                lrc.LegionellaRiskCategoryID,
                lrc.Description [RiskCategory],
                lrc.SortOrder [RiskCategorySortOrder],
                lfc.LegionellaFrequencyCategoryID,
                lfc.Description [FrequencyCategory],
                lfc.DateAddModifier [FrequencyCategoryDateAddModifier],
                lfc.DateAddValue [FrequencyCategoryDateAddValue],
                dbo.fn_DateAddFromStringPart(lfc.DateAddModifier, lfc.DateAddValue, lao.MonitoringSchedule) [FrequencyCategoryDateCalc],
                lfc.SortOrder [FrequencyCategorySortOrder],
                lrr.LegionellaRiskRatingID,
                lrr.Description [RiskRating],
                lrr.RiskColour,
                lrr.SortOrder [RiskRatingSortOrder],
                lpr.LegionellaPriorityRatingID,
                lpr.Description [PriorityRating],
                lpr.ShortDescription [ShortPriorityRating],
                lpr.PriorityColour,
                lpr.SortOrder [PriorityRatingSortOrder],
                ltait.LegionellaTaskAutoInsertTypeID,
                ltait.Description [TaskAutoInsertType],
                lte.LegionellaTaskEventID,
                lte.PerformedByEmployeeID [EventPerformedByEmployeeID],
                lte.PerformedByPortalUserID [EventPerformedByPortalUserID],
                lte.PerformedByThirdParty [EventPerformedByThirdParty],
                COALESCE(e.FullName, pu.FullName, lte.PerformedByThirdParty) [EventPerformedBy],
                lte.Comments [EventComments],
                lte.Recorded [EventRecorded],
                lte.Created [EventCreated]
            FROM
                LegionellaAssetOutletTaskQuestionTrigger laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask lt WITH (NOLOCK) ON laotqt.LegionellaTaskAutoInsertID = lt.LegionellaTaskAutoInsertID
                LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lt.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
                LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
                LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
                LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
                LEFT JOIN LegionellaTaskAutoInsertType ltait WITH (NOLOCK) ON lt.LegionellaTaskAutoInsertTypeID = ltait.LegionellaTaskAutoInsertTypeID
                OUTER APPLY
                (
                    SELECT TOP 1
                        lte.LegionellaTaskEventID,
                        lte.PerformedByEmployeeID,
                        lte.PerformedByPortalUserID,
                        lte.PerformedByThirdParty,
                        lte.Comments,
                        lte.Recorded,
                        lte.Created
                    FROM
                        LegionellaTaskEvent lte WITH (NOLOCK)
                    WHERE
                        lte.LegionellaTaskID = lt.LegionellaTaskID
                            AND
                        lte.Deleted IS NULL
                    ORDER BY
                        lte.Created
                ) lte -- Legionella Task Event
                LEFT JOIN Employee e WITH (NOLOCK) ON lte.PerformedByEmployeeID = e.EmployeeID
                LEFT JOIN PortalUser pu WITH (NOLOCK) ON lte.PerformedByPortalUserID = pu.PortalUserID
            WHERE
                laotqt.Deleted IS NULL
                    AND
                lt.Deleted IS NULL
                    AND
                laotqt.LegionellaAssetOutletQuestionID = laodc.LegionellaAssetOutletQuestionID
                    AND
                CASE lao.RowType -- Join based on the live table
                    WHEN 1 THEN lt.LegionellaID
                    WHEN 2 THEN lt.LegionellaAssetID
                    WHEN 3 THEN lt.LegionellaLocationID
                    WHEN 4 THEN lt.LegionellaOutletID
                END =
                CASE lao.RowType -- Join based on the main UNION
                    WHEN 1 THEN lao.LegionellaID
                    WHEN 3 THEN lao.LegionellaLocationID
                    ELSE lao.LegionellaAssetOutletID
                END
            ORDER BY
                lt.SortOrder
        ) lt -- Legionella Task (for the questions that trigger a risk)
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
        
    WHERE
        laoq.Deleted IS NULL
            AND
        laodc.Deleted IS NULL
            AND
        (laoq.LegionellaAssetOutletQuestionID = @LegionellaQuestionID OR @LegionellaQuestionID = 0)
            AND
        (ISNULL(laoq.SubTabTitle, '') = ISNULL(@QuestionSubTabTitle, '') OR @QuestionSubTabTitle IS NULL)
            AND
        (ISNULL(laoq.GroupTitle, '') = ISNULL(@QuestionGroupTitle, '') OR @QuestionGroupTitle IS NULL)
            AND
        (
            lao.RowType IN (2, 4) -- Automatically show Asset and Outlet questions.
                OR
            (
                lao.RowType = 1 -- If something from the Legionella record and a question, decide whether to show or hide the Question.
                    AND
                (
                    (laoq.LegionellaSectionID = @LegionellaSectionID)
                        OR
                    (@LegionellaSectionID = 0)
                        OR
                    (@LegionellaSectionID = -1 AND laoq.LegionellaSectionID IS NOT NULL)
                )
            )
                OR
            (
                lao.RowType = 3 -- Filter Locations to only show location questions.
                    AND
                laoq.LegionellaSectionID = 4
            )
        )
            AND -- Decide whether or not to show the question if it was not answered.
        (@IncludeQuestionsNotAnswered = 1 OR (@IncludeQuestionsNotAnswered = 0 AND laodc.LegionellaAssetOutletDataCollectionID IS NOT NULL))
        
    ORDER BY -- When updating the ORDER BY, make sure you update ROW_NUMBER() logic above.
        lao.LegionellaStart,
        lao.RowType,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        laoq.SortOrder
    
    
    -- Update the table variable to say if its the first Item (either a Legionella/Asset/Location/Outlet) on the job with questions.
    UPDATE @MainData
    SET IsFirstItemWithQuestions =
        CASE WHEN m.RowType = (SELECT TOP 1 RowType FROM @MainData ORDER BY RowID) -- See if the current row is the same type as the first row.
            THEN
                CASE WHEN -- If the current row and the first are the same, do a CASE to compare the IDs. If they match, then it is the first of its type in the report.
                    CASE m.RowType
                        WHEN 1 THEN (SELECT TOP 1 LegionellaID FROM @MainData ORDER BY RowID)
                        WHEN 3 THEN (SELECT TOP 1 LegionellaLocationID FROM @MainData ORDER BY RowID)
                        ELSE (SELECT TOP 1 LegionellaAssetOutletID FROM @MainData ORDER BY RowID)
                    END =
                    CASE m.RowType
                        WHEN 1 THEN m.LegionellaID
                        WHEN 3 THEN m.LegionellaLocationID
                        ELSE m.LegionellaAssetOutletID
                    END
                    THEN 1
                    ELSE 0
                END
            ELSE 0
        END
    FROM @MainData m
    
    
    -- Start the main SELECT
    SELECT
        -- Main data from the table variable
        m.RowID,
        m.RowType,
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaPhotoNo,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.LegionellaPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [LegionellaPhoto],
        m.AssetOutletPhotoNo,
        m.LegionellaAssetOutletID,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.AssetOutletPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [AssetOutletPhoto],
        m.AssetOutletSystemRef,
        m.AssetOutletLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.AssetOutletSystemRef, '') + ', ', '') + ISNULL(m.AssetOutletLocation, '')
        END [SiteOrAssetOutletDetails],
        m.AssetRiskRating,
        m.AssetRiskColour,
        m.AssetRiskRatingSortOrder,
        m.AssetRiskRatingSortOrder - 1 [AssetRiskRatingNo],
        m.OutletCold,
        m.OutletHot,
        m.OutletMixed,
        m.OutletMains,
        m.OutletSentinelCold,
        m.OutletSentinelHot,
        m.OutletSentinelMixed,
        m.OutletSentinelMains,
        m.OutletFlushedCold,
        m.OutletFlushedHot,
        m.OutletFlushedMixed,
        m.OutletFlushedMains,
        m.OutletLowUseCold,
        m.OutletLowUseHot,
        m.OutletLowUseMixed,
        m.OutletLowUseMains,
        m.OutletSourceColdAssetSystemRef,
        m.OutletSourceColdAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceColdAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceColdAssetLocation, '')
        END [OutletSourceColdAssetDetails],
        m.OutletSourceColdAssetCategory,
        m.OutletSourceHotAssetSystemRef,
        m.OutletSourceHotAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceHotAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceHotAssetLocation, '')
        END [OutletSourceHotAssetDetails],
        m.OutletSourceHotAssetCategory,
        m.OutletSourceMixedAssetSystemRef,
        m.OutletSourceMixedAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMixedAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMixedAssetLocation, '')
        END [OutletSourceMixedAssetDetails],
        m.OutletSourceMixedAssetCategory,
        m.OutletSourceMainsAssetSystemRef,
        m.OutletSourceMainsAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMainsAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMainsAssetLocation, '')
        END [OutletSourceMainsAssetDetails],
        m.OutletSourceMainsAssetCategory,
        m.AssetOutletCategory,
        m.LegionellaAssetOutletQuestionID,
        m.QuestionSubTabTitle,
        m.QuestionGroupTitle,
        m.Question,
        m.QuestionRowIDForAssetOutlet,
        m.AnswerText,
        CASE WHEN m.LegionellaTaskID > 0 THEN 'Yes' ELSE 'No' END [AnswerIsTriggered],
        m.LegionellaTaskID,
        m.LegionellaTaskNo,
        dbo.HtmlEncode(m.TaskRiskDescription) [TaskRiskDescription],
        dbo.HtmlEncode(m.TaskAction) [TaskAction],
        m.RiskCategory,
        m.RiskCategorySortOrder,
        m.RiskCategorySortOrder - 1 [RiskCategoryNo],
        m.FrequencyCategory,
        dbo.FormatDateCustom(m.FrequencyCategoryDateCalc, @CustomDateFormat) [FrequencyCategoryDateCalc],
        m.FrequencyCategorySortOrder,
        m.FrequencyCategorySortOrder - 1 [FrequencyCategoryNo],
        m.RiskRating,
        m.RiskColour,
        m.RiskRatingSortOrder,
        m.RiskRatingSortOrder - 1 [RiskRatingNo],
        m.PriorityRating,
        m.ShortPriorityRating,
        m.PriorityColour,
        m.PriorityRatingSortOrder,
        m.PriorityRatingSortOrder - 1 [PriorityRatingNo],
        m.TaskAutoInsertType,
        m.EventPerformedBy,
        m.EventComments,
        dbo.FormatDateCustom(m.EventRecorded, @CustomDateFormat) [EventRecorded],
        dbo.FormatDateCustom(m.EventCreated, @CustomDateFormat) [EventCreated],
        
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionella],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaEnd],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1)) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewAssetOrOutletTitle],
        CASE WHEN m.RowType = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaData],
        CASE WHEN m.RowType = 2 THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetData],
        CASE WHEN m.RowType = 3 THEN 'display: inherit' ELSE 'display: none' END [DisplayLocationData],
        CASE WHEN m.RowType = 4 THEN 'display: inherit' ELSE 'display: none' END [DisplayOutletData],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletLocation],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletLocation],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END ELSE '#000000' END [TextColourAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.AssetRiskColour IS NOT NULL THEN m.AssetRiskColour ELSE '#FFFFFF' END ELSE '#FFFFFF' END [AssetRiskColourOrDefault],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMains],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletCategory],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletCategory],
        CASE WHEN m.EntryType = 'Title' THEN 'display: inherit' ELSE 'display: none' END [DisplayEntryTypeTitle],
        CASE WHEN m.EntryType = 'Title' THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEntryTypeTitle],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '2' ELSE '1' END [ColspanQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '1' ELSE '2' END [InvertColspanQuestionComments],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitleStart],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitleFinish],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '') AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleStart],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '') AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleFinish],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionGroupTitle],
        CASE WHEN COALESCE(NULLIF(m.DataCollectionText, ''), CAST(m.DataCollectionInt AS VARCHAR(MAX)), m.NullReplace) IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAnswerText],
        CASE WHEN COALESCE(NULLIF(m.DataCollectionText, ''), CAST(m.DataCollectionInt AS VARCHAR(MAX)), m.NullReplace) IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAnswerText],
        CASE WHEN m.Question LIKE '%Capacity%' AND ISNUMERIC(COALESCE(NULLIF(m.DataCollectionText, ''), CAST(m.DataCollectionInt AS VARCHAR(MAX)), 'N/A')) = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionIfCapacity],
        CASE WHEN (m.Question LIKE '%Temperature%' OR m.Question LIKE '%Thermostat%') AND ISNUMERIC(COALESCE(NULLIF(m.DataCollectionText, ''), CAST(m.DataCollectionInt AS VARCHAR(MAX)), 'N/A')) = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionIfTemperature],
        CASE WHEN m.LegionellaTaskID > 0 THEN 'display: inherit' ELSE 'display: none' END [DisplayAnswerIsTriggered],
        CASE WHEN m.LegionellaTaskID > 0 THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAnswerIsTriggered],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskCategory],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategory],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategoryDateCalc],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategoryDateCalc],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourRiskRating],
        CASE WHEN m.RiskColour IS NOT NULL THEN m.RiskColour ELSE '#FFFFFF' END [RiskColourOrDefault],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourPriorityRating],
        CASE WHEN m.PriorityColour IS NOT NULL THEN m.PriorityColour ELSE '#FFFFFF' END [PriorityColourOrDefault],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayTaskAutoInsertType],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayTaskAutoInsertType],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventComments],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventComments],
        
        -- Display/hide variables that are more specific to this SPROC and take into account different parameters
        CASE WHEN (m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1))) OR (@ForcePageBreaks = 1 AND m.QuestionRowIDForAssetOutlet = CASE WHEN m.IsFirstItemWithQuestions = 1 THEN @MaxRowsPerPage ELSE @MaxRowsPerPageAdditionalPagesOverride END)
            THEN 'Leg_BorderFull'
            ELSE 'Leg_BorderHalf'
        END [BorderCssClass],
        CASE WHEN @ForcePageBreaks = 1 AND m.RowID > 1 -- This case does an exact comparison on the number rather than if it's a multiple of this number. Therefore adjust in future? maybe like PJL_GetBulkSampleCertificate.sql.
            THEN
                CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1)) OR (m.QuestionRowIDForAssetOutlet = CASE WHEN m.IsFirstItemWithQuestions = 1 THEN @MaxRowsPerPage ELSE @MaxRowsPerPageAdditionalPagesOverride END)
                    THEN 1
                    ELSE 0
                END
            ELSE 0
        END [RowTemplatePageBreak],
        CASE WHEN @ForcePageBreaks = 1 AND (m.QuestionRowIDForAssetOutlet = CASE WHEN m.IsFirstItemWithQuestions = 1 THEN @MaxRowsPerPage ELSE @MaxRowsPerPageAdditionalPagesOverride END) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewAssetOrOutletTitleContinued],
        CASE WHEN @ForcePageBreaks = 1 AND (m.QuestionRowIDForAssetOutlet = CASE WHEN m.IsFirstItemWithQuestions = 1 THEN @MaxRowsPerPage ELSE @MaxRowsPerPageAdditionalPagesOverride END) THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayNewAssetOrOutletTitleContinued]
        
    FROM
        @MainData m
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaAssetAndOutletTasks') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaAssetAndOutletTasks] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaAssetAndOutletTasks]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @IncludeLegionella BIT,
    @IncludeAssets BIT,
    @IncludeLocations BIT,
    @IncludeOutlets BIT,
    @LegionellaID INT = 0,
    @LegionellaAssetID INT = 0,
    @LegionellaLocationID INT = 0,
    @LegionellaOutletID INT = 0,
    @LegionellaTaskID INT = 0,
    @LegionellaSectionID INT = 0,
    @LegionellaTaskAutoInsertTypeID INT = 0, -- Pass this in to filter results down to a LegionellaTaskAutoInsertTypeID. Useful for chained row templates (HBE).
    @IncludeScheduleTasks BIT = 0, -- Pass this in to allow tasks from LegionellaTask that is from the schedule (can be used in conjunction with @LegionellaTaskAutoInsertTypeID)
    @ForcePageBreaks BIT = 0, -- This forces it to start a new page for each Asset/Outlet (unless the ORDER BY is different, then it can do it for Frequency Category, etc.)
    @OrderByFrequency BIT = 0, -- Added for Riverside, this orders it by Frequency Category
    @OrderByGroupTitleAndCategoryAndPriority BIT = 0, -- Added for HBE, this orders it by the Group Titles, Asset/Outlet Categories and Priority Rating
    @OrderByRisk BIT = 0, -- Added for Eton, this order it by Risk Rating
    @OrderByPriority BIT = 0, -- Order by Priority
    @ReplaceVariable VARCHAR(100) = NULL -- Used for getting the max rows per page of a row template, so it can break early if need be
/**********************************************************************
** Overview: Get Legionella, Asset, Location and Outlet Tasks (also known as Risks).
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@IncludeLegionella BIT = 0,
        --@IncludeAssets BIT = 0,
        --@IncludeLocations BIT = 0,
        --@IncludeOutlets BIT = 1,
        --@LegionellaID INT = 0,
        --@LegionellaAssetID INT = 0,
        --@LegionellaLocationID INT = 0,
        --@LegionellaOutletID INT = 0,
        --@LegionellaTaskID INT = 0,
        --@LegionellaSectionID INT = 0,
        --@LegionellaTaskAutoInsertTypeID INT = 0,
        --@IncludeScheduleTasks BIT = 0,
        --@ForcePageBreaks BIT = 0,
        --@OrderByFrequency BIT = 0,
        --@OrderByGroupTitleAndCategoryAndPriority BIT = 0,
        --@OrderByRisk BIT = 0,
        --@OrderByPriority BIT = 0,
        --@ReplaceVariable VARCHAR(100) = 'LEGIONELLATASKS'
    -- END DEBUG
    
    -- Set IDs lower down the tree if IDs higher up the tree are set.
    IF (@LegionellaTaskID > 0 AND @LegionellaID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaAssetID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaLocationID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaOutletID = 0)
    BEGIN
        SELECT
            @LegionellaID = ISNULL(LegionellaID, @LegionellaID),
            @LegionellaAssetID = ISNULL(LegionellaAssetID, @LegionellaAssetID),
            @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID),
            @LegionellaOutletID = ISNULL(LegionellaOutletID, @LegionellaOutletID)
        FROM LegionellaTask WITH (NOLOCK)
        WHERE LegionellaTaskID = @LegionellaTaskID
    END
    IF @LegionellaAssetID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaAsset WITH (NOLOCK)
        WHERE LegionellaAssetID = @LegionellaAssetID AND DateRemoved IS NULL
    END
    IF @LegionellaOutletID > 0 AND @LegionellaLocationID = 0
    BEGIN
        SELECT @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID)
        FROM LegionellaOutlet WITH (NOLOCK)
        WHERE LegionellaOutletID = @LegionellaOutletID AND DateRemoved IS NULL
    END
    IF @LegionellaLocationID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaLocation WITH (NOLOCK)
        WHERE LegionellaLocationID = @LegionellaLocationID AND DateRemoved IS NULL
    END
    
    -- Set variables used for logic.
    DECLARE @MaxRowsPerPage INT, @MaxRowsPerPageAdditionalPagesOverride INT
    SELECT
        @MaxRowsPerPage = COALESCE(rtmro.MaxRowsPerPage, rt.MaxRowsPerPage, 0),
        @MaxRowsPerPageAdditionalPagesOverride = COALESCE(rtmro.MaxRowsPerPageAdditionalPagesOverride, NULLIF(rt.MaxRowsPerPageAdditionalPagesOverride, 0), rtmro.MaxRowsPerPage, rt.MaxRowsPerPage, 0)
    FROM
        RowTemplate rt WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT
                rtmro.MaxRowsPerPage,
                rtmro.MaxRowsPerPageAdditionalPagesOverride
            FROM
                RowTemplateMaxRowsOverride rtmro WITH (NOLOCK)
            WHERE
                rtmro.ReplaceVariable = @ReplaceVariable
                    AND
                rtmro.JobID = @JobID
        ) rtmro
    WHERE
        rt.ReplaceVariable = @ReplaceVariable
    
    
    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)
    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)
    
    
    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)
    
    IF @IncludeAssets = 1
    BEGIN
        
        INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            la.LegionellaAssetID,
            la.PhotoID [AssetPhotoID],
            la.SystemRef [AssetSystemRef],
            la.Location [AssetLocation],
            la.SortOrder [AssetSortOrder],
            lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
            lrr.Description [AssetRiskRating],
            lrr.RiskColour [AssetRiskColour],
            lrr.SortOrder [AssetRiskRatingSortOrder],
            lac.LegionellaAssetCategoryID,
            lac.Description [AssetCategory],
            lac.SortOrder [AssetCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
            LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        WHERE
            la.Deleted IS NULL
                AND
			 la.DateRemoved IS NULL
				AND
            (la.LegionellaAssetID = @LegionellaAssetID OR @LegionellaAssetID = 0)
        
    END
    
    
    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    IF @IncludeLocations = 1 OR @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            ll.LegionellaLocationID,
            ll.Location,
            ll.SortOrder [LocationSortOrder]

        FROM
            @LegionellaData l
            INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
        WHERE
            ll.Deleted IS NULL
                AND
			ll.DateRemoved IS NULL
				AND
            (ll.LegionellaLocationID = @LegionellaLocationID OR @LegionellaLocationID = 0)

    END
    
    
    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)
    
    IF @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            lo.LegionellaOutletID,
            lo.PhotoID [OutletPhotoID],
            lo.SystemRef [OutletSystemRef],
            ll.LegionellaLocationID,
            ll.Location,
            ll.LocationSortOrder,
            lo.Cold [OutletCold],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletColdTriggered],
            lo.Hot [OutletHot],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletHotTriggered],
            lo.Mixed [OutletMixed],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMixedTriggered],
            lo.Mains [OutletMains],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMainsTriggered],
            lo.SentinelCold [OutletSentinelCold],
            lo.SentinelHot [OutletSentinelHot],
            lo.SentinelMixed [OutletSentinelMixed],
            lo.SentinelMains [OutletSentinelMains],
            lo.SortOrder [OutletSortOrder],
            lo.FlushedCold [OutletFlushedCold],
            lo.FlushedHot [OutletFlushedHot],
            lo.FlushedMixed [OutletFlushedMixed],
            lo.FlushedMains [OutletFlushedMains],
            lo.LowUseCold [OutletLowUseCold],
            lo.LowUseHot [OutletLowUseHot],
            lo.LowUseMixed [OutletLowUseMixed],
            lo.LowUseMains [OutletLowUseMains],
            sca.OutletSourceColdAssetID,
            sca.OutletSourceColdAssetSystemRef,
            sca.OutletSourceColdAssetLocation,
            sca.OutletSourceColdAssetCategory,
            sha.OutletSourceHotAssetID,
            sha.OutletSourceHotAssetSystemRef,
            sha.OutletSourceHotAssetLocation,
            sha.OutletSourceHotAssetCategory,
            sma.OutletSourceMixedAssetID,
            sma.OutletSourceMixedAssetSystemRef,
            sma.OutletSourceMixedAssetLocation,
            sma.OutletSourceMixedAssetCategory,
            smna.OutletSourceMainsAssetID,
            smna.OutletSourceMainsAssetSystemRef,
            smna.OutletSourceMainsAssetLocation,
            smna.OutletSourceMainsAssetCategory,
            loc.LegionellaOutletCategoryID,
            loc.Description [OutletCategory],
            loc.SortOrder [OutletCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
            INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
            LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceColdAssetID],
                    _la.SystemRef [OutletSourceColdAssetSystemRef],
                    _la.Location [OutletSourceColdAssetLocation],
                    _lac.Description [OutletSourceColdAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceCold
            ) sca -- Source Cold Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceHotAssetID],
                    _la.SystemRef [OutletSourceHotAssetSystemRef],
                    _la.Location [OutletSourceHotAssetLocation],
                    _lac.Description [OutletSourceHotAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceHot
            ) sha -- Source Hot Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMixedAssetID],
                    _la.SystemRef [OutletSourceMixedAssetSystemRef],
                    _la.Location [OutletSourceMixedAssetLocation],
                    _lac.Description [OutletSourceMixedAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMixed
            ) sma -- Source Mixed Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMainsAssetID],
                    _la.SystemRef [OutletSourceMainsAssetSystemRef],
                    _la.Location [OutletSourceMainsAssetLocation],
                    _lac.Description [OutletSourceMainsAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMains
            ) smna -- Source Mains Asset
        WHERE
            lo.Deleted IS NULL
                AND
			lo.DateRemoved IS NULL
				AND
            (lo.LegionellaOutletID = @LegionellaOutletID OR @LegionellaOutletID = 0)
        
    END
    
    
    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold BIT, OutletSentinelHot BIT, OutletSentinelMixed BIT, OutletSentinelMains BIT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaTaskID INT, LegionellaTaskNo INT, TaskRiskDescription VARCHAR(MAX), TaskAction VARCHAR(MAX), TaskSortOrder INT, RowIDForTask INT, LegionellaRiskCategoryID INT, RiskCategory VARCHAR(MAX), RiskCategorySortOrder INT, LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(MAX), FrequencyCategoryDateAddModifier VARCHAR(20), FrequencyCategoryDateAddValue INT, FrequencyCategoryDateCalc DATETIME, FrequencyCategorySortOrder INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, LegionellaPriorityRatingID INT, PriorityRating VARCHAR(MAX), ShortPriorityRating VARCHAR(20), PriorityColour VARCHAR(15), PriorityRatingSortOrder INT, LegionellaTaskAutoInsertTypeID INT, TaskAutoInsertType VARCHAR(MAX), LegionellaTaskEventID INT, EventPerformedByEmployeeID INT, EventPerformedByPortalUserID INT, EventPerformedByThirdParty VARCHAR(MAX), EventPerformedBy VARCHAR(MAX), EventComments VARCHAR(MAX), EventRecorded DATETIME, EventCreated DATETIME, LegionellaAssetOutletQuestionID INT, QuestionSubTabTitle VARCHAR(MAX), QuestionGroupTitle VARCHAR(MAX), Question VARCHAR(MAX), EntryType VARCHAR(MAX), NullReplace VARCHAR(MAX), ReplaceVariable VARCHAR(MAX), LegionellaAssetOutletQuestionSortOrder INT)
    
    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, RowIDForTask, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated, LegionellaAssetOutletQuestionID, QuestionSubTabTitle, QuestionGroupTitle, Question, EntryType, NullReplace, ReplaceVariable, LegionellaAssetOutletQuestionSortOrder)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        lt.LegionellaTaskID,
        lt.LegionellaTaskNo,
        lt.RiskDescription [TaskRiskDescription],
        lt.Action [TaskAction],
        lt.SortOrder [TaskSortOrder],
        ROW_NUMBER() OVER(PARTITION BY lfc.SortOrder ORDER BY lao.LegionellaStart, lao.LocationSortOrder, lao.AssetOutletSortOrder, lt.SortOrder) [RowIDForTask],
        lrc.LegionellaRiskCategoryID,
        lrc.Description [RiskCategory],
        lrc.SortOrder [RiskCategorySortOrder],
        lfc.LegionellaFrequencyCategoryID,
        lfc.Description [FrequencyCategory],
        lfc.DateAddModifier [FrequencyCategoryDateAddModifier],
        lfc.DateAddValue [FrequencyCategoryDateAddValue],
        dbo.fn_DateAddFromStringPart(lfc.DateAddModifier, lfc.DateAddValue, lao.MonitoringSchedule) [FrequencyCategoryDateCalc],
        lfc.SortOrder [FrequencyCategorySortOrder],
        lrr.LegionellaRiskRatingID,
        lrr.Description [RiskRating],
        lrr.RiskColour,
        lrr.SortOrder [RiskRatingSortOrder],
        lpr.LegionellaPriorityRatingID,
        lpr.Description [PriorityRating],
        lpr.ShortDescription [ShortPriorityRating],
        lpr.PriorityColour,
        lpr.SortOrder [PriorityRatingSortOrder],
        ltait.LegionellaTaskAutoInsertTypeID,
        ltait.Description [TaskAutoInsertType],
        lte.LegionellaTaskEventID,
        lte.PerformedByEmployeeID [EventPerformedByEmployeeID],
        lte.PerformedByPortalUserID [EventPerformedByPortalUserID],
        lte.PerformedByThirdParty [EventPerformedByThirdParty],
        COALESCE(e.FullName, pu.FullName, lte.PerformedByThirdParty) [EventPerformedBy],
        lte.Comments [EventComments],
        lte.Recorded [EventRecorded],
        lte.Created [EventCreated],
        laoq.LegionellaAssetOutletQuestionID,
        laoq.QuestionSubTabTitle,
        laoq.QuestionGroupTitle,
        laoq.Question,
        laoq.EntryType,
        laoq.NullReplace,
        laoq.ReplaceVariable,
        laoq.LegionellaAssetOutletQuestionSortOrder
        
    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
            WHERE @IncludeLegionella = 1
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
            WHERE @IncludeAssets = 1
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
            WHERE @IncludeLocations = 1
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
            WHERE @IncludeOutlets = 1
        ) lao
        INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
            CASE lao.RowType -- Join based on the main UNION
                WHEN 1 THEN lao.LegionellaID
                WHEN 3 THEN lao.LegionellaLocationID
                ELSE lao.LegionellaAssetOutletID
            END =
            CASE lao.RowType -- Join based on this live table
                WHEN 1 THEN lt.LegionellaID
                WHEN 2 THEN lt.LegionellaAssetID
                WHEN 3 THEN lt.LegionellaLocationID
                WHEN 4 THEN lt.LegionellaOutletID
            END
        LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lt.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
        LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
        LEFT JOIN LegionellaTaskAutoInsertType ltait WITH (NOLOCK) ON lt.LegionellaTaskAutoInsertTypeID = ltait.LegionellaTaskAutoInsertTypeID
        OUTER APPLY
        (
            SELECT TOP 1
                lte.LegionellaTaskEventID,
                lte.PerformedByEmployeeID,
                lte.PerformedByPortalUserID,
                lte.PerformedByThirdParty,
                lte.Comments,
                lte.Recorded,
                lte.Created
            FROM
                LegionellaTaskEvent lte WITH (NOLOCK)
            WHERE
                lte.LegionellaTaskID = lt.LegionellaTaskID
                    AND
                lte.Deleted IS NULL
            ORDER BY
                lte.Created
        ) lte -- Legionella Task Event
        LEFT JOIN Employee e WITH (NOLOCK) ON lte.PerformedByEmployeeID = e.EmployeeID
        LEFT JOIN PortalUser pu WITH (NOLOCK) ON lte.PerformedByPortalUserID = pu.PortalUserID
        OUTER APPLY
        (
            SELECT TOP 1
                laoq.LegionellaAssetOutletQuestionID,
                laoq.SubTabTitle [QuestionSubTabTitle],
                laoq.GroupTitle [QuestionGroupTitle],
                dbo.HtmlEncode(laoq.Description) [Question],
                laoq.EntryType,
                laoq.NullReplace,
                laoq.ReplaceVariable,
                laoq.SortOrder [LegionellaAssetOutletQuestionSortOrder]
            FROM
                LegionellaAssetOutletTaskQuestionTrigger laotqt WITH (NOLOCK)
                INNER JOIN LegionellaAssetOutletQuestion laoq WITH (NOLOCK) ON laotqt.LegionellaAssetOutletQuestionID = laoq.LegionellaAssetOutletQuestionID
            WHERE
                laotqt.LegionellaTaskAutoInsertID = lt.LegionellaTaskAutoInsertID
        ) laoq -- Legionella Asset Outlet Question (get question info that triggered the risks being displayed)
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
        
    WHERE
        lt.Deleted IS NULL
            AND
        (lt.LegionellaTaskID = @LegionellaTaskID OR @LegionellaTaskID = 0)
            AND
        (
            lao.RowType <> 1
                OR
            (
                lao.RowType = 1 -- If something from the Legionella record and a Task, decide whether to show or hide the Task.
                    AND
                (
                    (lt.LegionellaSectionID IS NULL AND @IncludeScheduleTasks = 1)
                        OR
                    (lt.LegionellaSectionID = @LegionellaSectionID)
                        OR
                    (@LegionellaSectionID = 0)
                        OR
                    (@LegionellaSectionID = -1 AND lt.LegionellaSectionID IS NOT NULL)
                )
            )
        )
            AND
        (ltait.LegionellaTaskAutoInsertTypeID = @LegionellaTaskAutoInsertTypeID OR @LegionellaTaskAutoInsertTypeID = 0)
            AND
        (@OrderByPriority = 0 OR (@OrderByPriority = 1 AND lpr.LegionellaPriorityRatingID IS NOT NULL))
        
    ORDER BY
        CASE WHEN @OrderByPriority = 1
            THEN lpr.SortOrder
            ELSE NULL
        END DESC,
        CASE WHEN @OrderByFrequency = 1
            THEN lfc.SortOrder
            ELSE lao.LegionellaStart
        END,
        CASE WHEN @OrderByFrequency = 1
            THEN lao.LegionellaStart
            ELSE NULL
        END,
        CASE WHEN @OrderByRisk = 1
            THEN lrr.SortOrder 
            ELSE lao.LegionellaStart
        END DESC,
        CASE WHEN @OrderByRisk = 1
            THEN lao.LegionellaStart
            ELSE NULL
        END,
        lao.RowType,
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 AND lao.RowType = 1
            THEN laoq.QuestionGroupTitle
            ELSE NULL
        END,
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 AND lao.RowType = 1
            THEN laoq.QuestionSubTabTitle
            ELSE NULL
        END,
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1
            THEN lao.AssetOutletCategorySortOrder
            ELSE lao.LocationSortOrder
        END,
        lao.AssetOutletSortOrder,
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1
            THEN lpr.SortOrder
            ELSE NULL
        END,
        lt.SortOrder
    
    
    -- Start the main SELECT
    SELECT
        -- Main data from the table variable
        m.RowID,
        m.RowType,
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaPhotoNo,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.LegionellaPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [LegionellaPhoto],
        m.AssetOutletPhotoNo,
        m.LegionellaAssetOutletID,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.AssetOutletPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [AssetOutletPhoto],
        m.AssetOutletSystemRef,
        m.AssetOutletLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 3 THEN ISNULL(m.AssetOutletLocation, '')
            ELSE ISNULL(NULLIF(m.AssetOutletSystemRef, '') + ', ', '') + ISNULL(m.AssetOutletLocation, '')
        END [SiteOrAssetOutletDetails],
        m.AssetRiskRating,
        m.AssetRiskColour,
        m.AssetRiskRatingSortOrder,
        m.AssetRiskRatingSortOrder - 1 [AssetRiskRatingNo],
        m.OutletCold,
        m.OutletHot,
        m.OutletMixed,
        m.OutletMains,
        m.OutletSentinelCold,
        m.OutletSentinelHot,
        m.OutletSentinelMixed,
        m.OutletSentinelMains,
        m.OutletFlushedCold,
        m.OutletFlushedHot,
        m.OutletFlushedMixed,
        m.OutletFlushedMains,
        m.OutletLowUseCold,
        m.OutletLowUseHot,
        m.OutletLowUseMixed,
        m.OutletLowUseMains,
        m.OutletSourceColdAssetSystemRef,
        m.OutletSourceColdAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceColdAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceColdAssetLocation, '')
        END [OutletSourceColdAssetDetails],
        m.OutletSourceColdAssetCategory,
        m.OutletSourceHotAssetSystemRef,
        m.OutletSourceHotAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceHotAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceHotAssetLocation, '')
        END [OutletSourceHotAssetDetails],
        m.OutletSourceHotAssetCategory,
        m.OutletSourceMixedAssetSystemRef,
        m.OutletSourceMixedAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMixedAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMixedAssetLocation, '')
        END [OutletSourceMixedAssetDetails],
        m.OutletSourceMixedAssetCategory,
        m.OutletSourceMainsAssetSystemRef,
        m.OutletSourceMainsAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMainsAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMainsAssetLocation, '')
        END [OutletSourceMainsAssetDetails],
        m.OutletSourceMainsAssetCategory,
        m.AssetOutletCategory,
        m.LegionellaTaskID,
        m.LegionellaTaskNo,
        dbo.HtmlEncode(m.TaskRiskDescription) [TaskRiskDescription],
        dbo.HtmlEncode(m.TaskAction) [TaskAction],
        m.RiskCategory,
        m.RiskCategorySortOrder,
        m.RiskCategorySortOrder - 1 [RiskCategoryNo],
        m.FrequencyCategory,
        dbo.FormatDateCustom(m.FrequencyCategoryDateCalc, @CustomDateFormat) [FrequencyCategoryDateCalc],
        m.FrequencyCategorySortOrder,
        m.FrequencyCategorySortOrder - 1 [FrequencyCategoryNo],
        m.RiskRating,
        m.RiskColour,
        m.RiskRatingSortOrder,
        m.RiskRatingSortOrder - 1 [RiskRatingNo],
        m.PriorityRating,
        m.ShortPriorityRating,
        m.PriorityColour,
        m.PriorityRatingSortOrder,
        m.PriorityRatingSortOrder - 1 [PriorityRatingNo],
        m.TaskAutoInsertType,
        m.EventPerformedBy,
        m.EventComments,
        dbo.FormatDateCustom(m.EventRecorded, @CustomDateFormat) [EventRecorded],
        dbo.FormatDateCustom(m.EventCreated, @CustomDateFormat) [EventCreated],
        m.LegionellaAssetOutletQuestionID,
        m.QuestionSubTabTitle,
        m.QuestionGroupTitle,
        m.Question,
        
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionella],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaEnd],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1)) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewAssetOrOutletTitle],
        CASE WHEN m.RowType = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaData],
        CASE WHEN m.RowType = 2 THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetData],
        CASE WHEN m.RowType = 3 THEN 'display: inherit' ELSE 'display: none' END [DisplayLocationData],
        CASE WHEN m.RowType = 4 THEN 'display: inherit' ELSE 'display: none' END [DisplayOutletData],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletLocation],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletLocation],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END ELSE '#000000' END [TextColourAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.AssetRiskColour IS NOT NULL THEN m.AssetRiskColour ELSE '#FFFFFF' END ELSE '#FFFFFF' END [AssetRiskColourOrDefault],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMains],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletCategory],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletCategory],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskCategory],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategory],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategoryDateCalc],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategoryDateCalc],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourRiskRating],
        CASE WHEN m.RiskColour IS NOT NULL THEN m.RiskColour ELSE '#FFFFFF' END [RiskColourOrDefault],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourPriorityRating],
        CASE WHEN m.PriorityColour IS NOT NULL THEN m.PriorityColour ELSE '#FFFFFF' END [PriorityColourOrDefault],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayTaskAutoInsertType],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayTaskAutoInsertType],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventComments],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventComments],
        CASE WHEN m.EntryType = 'Title' THEN 'display: inherit' ELSE 'display: none' END [DisplayEntryTypeTitle],
        CASE WHEN m.EntryType = 'Title' THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEntryTypeTitle],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '2' ELSE '1' END [ColspanQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '1' ELSE '2' END [InvertColspanQuestionComments],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitleStart],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitleFinish],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '') AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleStart],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE RowType = m.RowType AND LegionellaID = m.LegionellaID AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1) AND ISNULL(QuestionSubTabTitle, '') = ISNULL(m.QuestionSubTabTitle, '') AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, '')) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleFinish],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionGroupTitle],
        
        -- Display/hide variables that are more specific to this SPROC and take into account different parameters
        CASE
            WHEN @OrderByFrequency = 1 THEN
                CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaFrequencyCategoryID, -1) = ISNULL(m.LegionellaFrequencyCategoryID, -1))
                    THEN 'Leg_BorderFull'
                    ELSE 'Leg_BorderHalf'
                END
            WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 THEN
                CASE WHEN ((m.RowType = 1 AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, ''))) OR (m.RowType IN (2, 4) AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND LegionellaAssetOutletCategoryID = m.LegionellaAssetOutletCategoryID AND LegionellaAssetOutletID = m.LegionellaAssetOutletID))) OR ((m.RowType = 1 AND m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, ''))) OR (m.RowType IN (2, 4) AND m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND LegionellaAssetOutletCategoryID = m.LegionellaAssetOutletCategoryID AND LegionellaAssetOutletID = m.LegionellaAssetOutletID)))
                    THEN 'Leg_BorderFull'
                    ELSE 'Leg_BorderHalf'
                END
            WHEN @OrderByRisk = 1 THEN
                CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaRiskCategoryID, -1) = ISNULL(m.LegionellaRiskCategoryID, -1))
                    THEN 'Leg_BorderFull'
                    ELSE 'Leg_BorderHalf'
                END
            ELSE
                CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1))
                    THEN 'Leg_BorderFull'
                    ELSE 'Leg_BorderHalf'
                END
        END [BorderCssClass],
        CASE WHEN @ForcePageBreaks = 1 AND m.RowID > 1
            THEN
                CASE
                    WHEN @OrderByFrequency = 1 AND @ReplaceVariable IS NOT NULL THEN
                        CASE WHEN m.RowID % @MaxRowsPerPage = 0
                            THEN 1
                            ELSE 0
                        END
                    WHEN @OrderByFrequency = 1 THEN
                        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaFrequencyCategoryID, -1) = ISNULL(m.LegionellaFrequencyCategoryID, -1))
                            THEN 1
                            ELSE 0
                        END
                    WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 THEN
                        CASE WHEN ((m.RowType = 1 AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, ''))) OR (m.RowType IN (2, 4) AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND LegionellaAssetOutletCategoryID = m.LegionellaAssetOutletCategoryID AND LegionellaAssetOutletID = m.LegionellaAssetOutletID)))
                            THEN 1
                            ELSE 0
                        END
                    WHEN @OrderByRisk = 1 THEN
                        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaRiskCategoryID, -1) = ISNULL(m.LegionellaRiskCategoryID, -1))
                            THEN 1
                            ELSE 0
                        END
                    ELSE
                        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1))
                            THEN 1
                            ELSE 0
                        END
                END
            ELSE 0
        END [RowTemplatePageBreak],
        CASE WHEN @OrderByFrequency = 1 AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaFrequencyCategoryID, -1) = ISNULL(m.LegionellaFrequencyCategoryID, -1)) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewFrequencyCategory],
        CASE WHEN @OrderByFrequency = 1 AND m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE ISNULL(LegionellaFrequencyCategoryID, -1) = ISNULL(m.LegionellaFrequencyCategoryID, -1)) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewFrequencyCategoryEnd],
        CASE WHEN @OrderByFrequency = 1 AND @ReplaceVariable IS NOT NULL AND (m.RowID % @MaxRowsPerPage = 0 OR m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE ISNULL(LegionellaFrequencyCategoryID, -1) = ISNULL(m.LegionellaFrequencyCategoryID, -1))) THEN 'display: inherit' ELSE 'display: none' END [DisplayTableNewFrequencyCategory],
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 AND ((m.RowType = 1 AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, ''))) OR (m.RowType IN (2, 4) AND m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND LegionellaAssetOutletCategoryID = m.LegionellaAssetOutletCategoryID AND LegionellaAssetOutletID = m.LegionellaAssetOutletID))) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleOrAssetOutletCategory],
        CASE WHEN @OrderByGroupTitleAndCategoryAndPriority = 1 AND m.RowID <> (SELECT MAX(RowID) FROM @MainData) AND ((m.RowType = 1 AND m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(QuestionGroupTitle, '') = ISNULL(m.QuestionGroupTitle, ''))) OR (m.RowType IN (2, 4) AND m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND LegionellaAssetOutletCategoryID = m.LegionellaAssetOutletCategoryID AND LegionellaAssetOutletID = m.LegionellaAssetOutletID))) THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitleOrAssetOutletCategoryEnd]
        
    FROM
        @MainData m
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaAssetsAndOutlets') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaAssetsAndOutlets] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaAssetsAndOutlets]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @IncludeLegionella BIT,
    @IncludeAssets BIT,
    @IncludeLocations BIT,
    @IncludeOutlets BIT,
    @IncludeSamples INT = 0,
    @LegionellaID INT = 0,
    @LegionellaAssetID INT = 0,
    @LegionellaLocationID INT = 0,
    @LegionellaOutletID INT = 0,
    @LegionellaSampleID INT = 0,
    @GenerateReportDefaultSql BIT = 0
/**********************************************************************
** Overview: Get Legionella, Asset, Location and Outlet data. Also executed via Generate Report for replace variables.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@IncludeLegionella BIT = 0,
        --@IncludeAssets BIT = 0,
        --@IncludeLocations BIT = 0,
        --@IncludeOutlets BIT = 1,
        --@IncludeSamples INT = 0,
        --@LegionellaID INT = 0,
        --@LegionellaAssetID INT = 0,
        --@LegionellaLocationID INT = 0,
        --@LegionellaOutletID INT = 0,
        --@LegionellaSampleID INT = 0,
        --@GenerateReportDefaultSql BIT = 0
    -- END DEBUG
    
    -- Set IDs lower down the tree if IDs higher up the tree are set.
    IF @LegionellaAssetID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaAsset WITH (NOLOCK)
        WHERE LegionellaAssetID = @LegionellaAssetID AND DateRemoved IS NULL
    END
    IF @LegionellaSampleID > 0 AND @LegionellaOutletID = 0
    BEGIN
        SELECT @LegionellaOutletID = ISNULL(LegionellaOutletID, @LegionellaOutletID)
        FROM LegionellaSample WITH (NOLOCK)
        WHERE LegionellaSampleID = @LegionellaSampleID
    END
    IF @LegionellaOutletID > 0 AND @LegionellaLocationID = 0
    BEGIN
        SELECT @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID)
        FROM LegionellaOutlet WITH (NOLOCK)
        WHERE LegionellaOutletID = @LegionellaOutletID AND DateRemoved IS NULL
    END
    IF @LegionellaLocationID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaLocation WITH (NOLOCK)
        WHERE LegionellaLocationID = @LegionellaLocationID AND DateRemoved IS NULL
    END
    
    -- Get data repeated for every row in variables.
    DECLARE @JobNo VARCHAR(100), @AppointmentID INT, @AppointmentClientOrderNo VARCHAR(50)
    SELECT TOP 1
        @JobNo = dbo.FormatTeamsReference('J', j.JobNo),
        @AppointmentID = a.AppointmentID,
        @AppointmentClientOrderNo = a.ClientOrderNo
    FROM
        Job j WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
    WHERE
        j.JobID = @JobID
    
    
    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)
    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)
    
    
    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetTemp DECIMAL(10, 2), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)
    
    IF @IncludeAssets = 1
    BEGIN
        
        INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            la.LegionellaAssetID,
            la.PhotoID [AssetPhotoID],
            la.SystemRef [AssetSystemRef],
            la.Location [AssetLocation],
            la.SortOrder [AssetSortOrder],
            lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
            lrr.Description [AssetRiskRating],
            lrr.RiskColour [AssetRiskColour],
            lrr.SortOrder [AssetRiskRatingSortOrder],
            lac.LegionellaAssetCategoryID,
            lac.Description [AssetCategory],
            lac.SortOrder [AssetCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
            LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        WHERE
            la.Deleted IS NULL
                AND
			la.DateRemoved IS NULL
				AND
            (la.LegionellaAssetID = @LegionellaAssetID OR @LegionellaAssetID = 0)
        
    END
    
    
    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    IF @IncludeLocations = 1 OR @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            ll.LegionellaLocationID,
            ll.Location,
            ll.SortOrder [LocationSortOrder]

        FROM
            @LegionellaData l
            INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
        WHERE
            ll.Deleted IS NULL
                AND
			ll.DateRemoved IS NULL
				AND
            (ll.LegionellaLocationID = @LegionellaLocationID OR @LegionellaLocationID = 0)

    END
    
    
    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)
    
    IF @IncludeOutlets = 1
    BEGIN
        
        INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            lo.LegionellaOutletID,
            lo.PhotoID [OutletPhotoID],
            lo.SystemRef [OutletSystemRef],
            ll.LegionellaLocationID,
            ll.Location,
            ll.LocationSortOrder,
            lo.Cold [OutletCold],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletColdTriggered],
            lo.Hot [OutletHot],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletHotTriggered],
            lo.Mixed [OutletMixed],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMixedTriggered],
            lo.Mains [OutletMains],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMainsTriggered],
            lo.SentinelCold [OutletSentinelCold],
            lo.SentinelHot [OutletSentinelHot],
            lo.SentinelMixed [OutletSentinelMixed],
            lo.SentinelMains [OutletSentinelMains],
            lo.SortOrder [OutletSortOrder],
            lo.FlushedCold [OutletFlushedCold],
            lo.FlushedHot [OutletFlushedHot],
            lo.FlushedMixed [OutletFlushedMixed],
            lo.FlushedMains [OutletFlushedMains],
            lo.LowUseCold [OutletLowUseCold],
            lo.LowUseHot [OutletLowUseHot],
            lo.LowUseMixed [OutletLowUseMixed],
            lo.LowUseMains [OutletLowUseMains],
            sca.OutletSourceColdAssetID,
            sca.OutletSourceColdAssetSystemRef,
            sca.OutletSourceColdAssetLocation,
            sca.OutletSourceColdAssetCategory,
            sha.OutletSourceHotAssetID,
            sha.OutletSourceHotAssetSystemRef,
            sha.OutletSourceHotAssetLocation,
            sha.OutletSourceHotAssetCategory,
            sma.OutletSourceMixedAssetID,
            sma.OutletSourceMixedAssetSystemRef,
            sma.OutletSourceMixedAssetLocation,
            sma.OutletSourceMixedAssetCategory,
            smna.OutletSourceMainsAssetID,
            smna.OutletSourceMainsAssetSystemRef,
            smna.OutletSourceMainsAssetLocation,
            smna.OutletSourceMainsAssetCategory,
            loc.LegionellaOutletCategoryID,
            loc.Description [OutletCategory],
            loc.SortOrder [OutletCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
            INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
            LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceColdAssetID],
                    _la.SystemRef [OutletSourceColdAssetSystemRef],
                    _la.Location [OutletSourceColdAssetLocation],
                    _lac.Description [OutletSourceColdAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceCold
            ) sca -- Source Cold Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceHotAssetID],
                    _la.SystemRef [OutletSourceHotAssetSystemRef],
                    _la.Location [OutletSourceHotAssetLocation],
                    _lac.Description [OutletSourceHotAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceHot
            ) sha -- Source Hot Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMixedAssetID],
                    _la.SystemRef [OutletSourceMixedAssetSystemRef],
                    _la.Location [OutletSourceMixedAssetLocation],
                    _lac.Description [OutletSourceMixedAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMixed
            ) sma -- Source Mixed Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMainsAssetID],
                    _la.SystemRef [OutletSourceMainsAssetSystemRef],
                    _la.Location [OutletSourceMainsAssetLocation],
                    _lac.Description [OutletSourceMainsAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMains
            ) smna -- Source Mains Asset
        WHERE
            lo.Deleted IS NULL
                AND
			lo.DateRemoved IS NULL
				AND
            (lo.LegionellaOutletID = @LegionellaOutletID OR @LegionellaOutletID = 0)
        
    END
    
    
    -- Get Legionella Sample data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaSampleData TABLE (JobEmployeeID INT, LegionellaID INT, LegionellaOutletID INT, LegionellaSampleID INT, SampleRefCold VARCHAR(MAX), SampleRefHot VARCHAR(MAX), SampleRefMixed VARCHAR(MAX), SampleRefMains VARCHAR(MAX), LegionellaSampleTypeIDCold INT, SampleTypeCold VARCHAR(MAX), LegionellaSampleTypeIDHot INT, SampleTypeHot VARCHAR(MAX), LegionellaSampleTypeIDMixed INT, SampleTypeMixed VARCHAR(MAX), LegionellaSampleTypeIDMains INT, SampleTypeMains VARCHAR(MAX))
    
    IF @IncludeSamples > 0
    BEGIN
        
        INSERT INTO @LegionellaSampleData (JobEmployeeID, LegionellaID, LegionellaOutletID, LegionellaSampleID, SampleRefCold, SampleRefHot, SampleRefMixed, SampleRefMains, LegionellaSampleTypeIDCold, SampleTypeCold, LegionellaSampleTypeIDHot, SampleTypeHot, LegionellaSampleTypeIDMixed, SampleTypeMixed, LegionellaSampleTypeIDMains, SampleTypeMains)
        SELECT
            lo.JobEmployeeID,
            lo.LegionellaID,
            lo.LegionellaOutletID,
            ls.LegionellaSampleID,
            ls.SampleRefCold,
            ls.SampleRefHot,
            ls.SampleRefMixed,
            ls.SampleRefMains,
            lstc.LegionellaSampleTypeID [LegionellaSampleTypeIDCold],
            lstc.Description [SampleTypeCold],
            lsth.LegionellaSampleTypeID [LegionellaSampleTypeIDHot],
            lsth.Description [SampleTypeHot],
            lstm.LegionellaSampleTypeID [LegionellaSampleTypeIDMixed],
            lstm.Description [SampleTypeMixed],
            lstma.LegionellaSampleTypeID [LegionellaSampleTypeIDMains],
            lstma.Description [SampleTypeMains]
            
        FROM
            @LegionellaOutletData lo
            INNER JOIN LegionellaSample ls WITH (NOLOCK) ON lo.LegionellaOutletID = ls.LegionellaOutletID
            LEFT JOIN LegionellaSampleType lstc WITH (NOLOCK) ON ls.LegionellaSampleTypeIDCold = lstc.LegionellaSampleTypeID
            LEFT JOIN LegionellaSampleType lsth WITH (NOLOCK) ON ls.LegionellaSampleTypeIDHot = lsth.LegionellaSampleTypeID
            LEFT JOIN LegionellaSampleType lstm WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMixed = lstm.LegionellaSampleTypeID
            LEFT JOIN LegionellaSampleType lstma WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMains = lstma.LegionellaSampleTypeID
        WHERE
            (ls.LegionellaSampleID = @LegionellaSampleID OR @LegionellaSampleID = 0)
        
    END
    
    
    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaSampleID INT, SampleRefCold VARCHAR(MAX), SampleRefHot VARCHAR(MAX), SampleRefMixed VARCHAR(MAX), SampleRefMains VARCHAR(MAX), LegionellaSampleTypeIDCold INT, SampleTypeCold VARCHAR(MAX), LegionellaSampleTypeIDHot INT, SampleTypeHot VARCHAR(MAX), LegionellaSampleTypeIDMixed INT, SampleTypeMixed VARCHAR(MAX), LegionellaSampleTypeIDMains INT, SampleTypeMains VARCHAR(MAX))
    
    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaSampleID, SampleRefCold, SampleRefHot, SampleRefMixed, SampleRefMains, LegionellaSampleTypeIDCold, SampleTypeCold, LegionellaSampleTypeIDHot, SampleTypeHot, LegionellaSampleTypeIDMixed, SampleTypeMixed, LegionellaSampleTypeIDMains, SampleTypeMains)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        ls.LegionellaSampleID,
        ls.SampleRefCold,
        ls.SampleRefHot,
        ls.SampleRefMixed,
        ls.SampleRefMains,
        ls.LegionellaSampleTypeIDCold,
        ls.SampleTypeCold,
        ls.LegionellaSampleTypeIDHot,
        ls.SampleTypeHot,
        ls.LegionellaSampleTypeIDMixed,
        ls.SampleTypeMixed,
        ls.LegionellaSampleTypeIDMains,
        ls.SampleTypeMains
        
    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
            WHERE @IncludeLegionella = 1
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
            WHERE @IncludeAssets = 1
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
            WHERE @IncludeLocations = 1
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
            WHERE @IncludeOutlets = 1
        ) lao
        LEFT JOIN @LegionellaSampleData ls ON lao.LegionellaAssetOutletID = ls.LegionellaOutletID AND lao.RowType = 4
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
        
    WHERE
        (
            -- If executed from generate report and it is the Default SQL, make sure the top legionella record has data for the basic variables.
            @GenerateReportDefaultSql = 0
                OR
            (
                @GenerateReportDefaultSql = 1
                    AND
                lao.ScopeOfWork IS NOT NULL
            )
        )
            AND
        ( -- Decide whether or not to show Samples.
            @IncludeSamples IN (0, 1) -- Only show rows with or without Sample data.
                OR
            (
                @IncludeSamples = 2 -- Only show rows with Sample data.
                    AND
                ls.LegionellaSampleID IS NOT NULL
            )
                OR
            (
                @IncludeSamples = 3 -- Only show rows without Sample data.
                    AND
                ls.LegionellaSampleID IS NULL
            )
        )
        
    ORDER BY
        lao.LegionellaStart,
        lao.RowType,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder
    
    
    -- Start the main SELECT
    SELECT
        -- Main data from the table variable
        m.RowID,
        m.RowType,
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaPhotoNo,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.LegionellaPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [LegionellaPhoto],
        m.AssetOutletPhotoNo,
        m.LegionellaAssetOutletID,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.AssetOutletPhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [AssetOutletPhoto],
        m.AssetOutletSystemRef,
        m.AssetOutletLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 3 THEN ISNULL(m.AssetOutletLocation, '')
            ELSE ISNULL(NULLIF(m.AssetOutletSystemRef, '') + ', ', '') + ISNULL(m.AssetOutletLocation, '')
        END [SiteOrAssetOutletDetails],
        m.AssetRiskRating,
        m.AssetRiskColour,
        m.AssetRiskRatingSortOrder,
        m.AssetRiskRatingSortOrder - 1 [AssetRiskRatingNo],
        m.OutletCold,
        m.OutletHot,
        m.OutletMixed,
        m.OutletMains,
        m.OutletSentinelCold,
        m.OutletSentinelHot,
        m.OutletSentinelMixed,
        m.OutletSentinelMains,
        m.OutletFlushedCold,
        m.OutletFlushedHot,
        m.OutletFlushedMixed,
        m.OutletFlushedMains,
        m.OutletLowUseCold,
        m.OutletLowUseHot,
        m.OutletLowUseMixed,
        m.OutletLowUseMains,
        m.OutletSourceColdAssetSystemRef,
        m.OutletSourceColdAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceColdAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceColdAssetLocation, '')
        END [OutletSourceColdAssetDetails],
        m.OutletSourceColdAssetCategory,
        m.OutletSourceHotAssetSystemRef,
        m.OutletSourceHotAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceHotAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceHotAssetLocation, '')
        END [OutletSourceHotAssetDetails],
        m.OutletSourceHotAssetCategory,
        m.OutletSourceMixedAssetSystemRef,
        m.OutletSourceMixedAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMixedAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMixedAssetLocation, '')
        END [OutletSourceMixedAssetDetails],
        m.OutletSourceMixedAssetCategory,
        m.OutletSourceMainsAssetSystemRef,
        m.OutletSourceMainsAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMainsAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMainsAssetLocation, '')
        END [OutletSourceMainsAssetDetails],
        m.OutletSourceMainsAssetCategory,
        m.AssetOutletCategory,
        m.LegionellaSampleID,
        m.SampleRefCold,
        m.SampleRefHot,
        m.SampleRefMixed,
        m.SampleRefMains,
        m.LegionellaSampleTypeIDCold,
        m.SampleTypeCold,
        m.LegionellaSampleTypeIDHot,
        m.SampleTypeHot,
        m.LegionellaSampleTypeIDMixed,
        m.SampleTypeMixed,
        m.LegionellaSampleTypeIDMains,
        m.SampleTypeMains,
        
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionella],
        CASE WHEN m.RowID = (SELECT MAX(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID) THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaEnd],
        CASE WHEN m.RowID = (SELECT MIN(RowID) FROM @MainData WHERE LegionellaID = m.LegionellaID AND RowType = m.RowType AND ISNULL(LegionellaLocationID, -1) = ISNULL(m.LegionellaLocationID, -1) AND ISNULL(LegionellaAssetOutletID, -1) = ISNULL(m.LegionellaAssetOutletID, -1)) THEN 'display: inherit' ELSE 'display: none' END [DisplayNewAssetOrOutletTitle],
        CASE WHEN m.RowType = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaData],
        CASE WHEN m.RowType = 2 THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetData],
        CASE WHEN m.RowType = 3 THEN 'display: inherit' ELSE 'display: none' END [DisplayLocationData],
        CASE WHEN m.RowType = 4 THEN 'display: inherit' ELSE 'display: none' END [DisplayOutletData],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletLocation],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletLocation],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END ELSE '#000000' END [TextColourAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.AssetRiskColour IS NOT NULL THEN m.AssetRiskColour ELSE '#FFFFFF' END ELSE '#FFFFFF' END [AssetRiskColourOrDefault],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMains],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletCategory],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletCategory],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.LegionellaSampleID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayLegionellaSample],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.LegionellaSampleID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayLegionellaSample],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefCold, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayLegionellaSampleRefCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefCold, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayLegionellaSampleRefCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefHot, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayLegionellaSampleRefHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefHot, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayLegionellaSampleRefHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefMixed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayLegionellaSampleRefMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefMixed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayLegionellaSampleRefMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefMains, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayLegionellaSampleRefMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN NULLIF(m.SampleRefMains, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayLegionellaSampleRefMains],

        -- Additional data required by Generate Report / SBE templates, that we would not normally display
        @JobNo [JobNo],
        @AppointmentID [AppointmentID],
        @AppointmentClientOrderNo [AppointmentClientOrderNo],
        m.JobEmployeeID,
        m.LegionellaID,
        m.LegionellaStart [LegionellaStartDateTime],
        m.LegionellaFinish [LegionellaFinishDateTime],
        m.MonitoringSchedule [MonitoringScheduleDateTime]

    FROM
        @MainData m
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaHeaderFooterData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaHeaderFooterData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaHeaderFooterData]
    @JobID INT
/**********************************************************************
** Overview: Get Legionella Header and Footer data. Used via Generate Report for replace variables. The main SELECT gets COUNTs/STUFFed data, and the second gets category data.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM DEV FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- DEBUG
        --DECLARE @JobID INT = 11402
    -- END DEBUG


    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)

    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID


    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)

    INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        la.LegionellaAssetID,
        la.PhotoID [AssetPhotoID],
        la.SystemRef [AssetSystemRef],
        la.Location [AssetLocation],
        la.SortOrder [AssetSortOrder],
        lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
        lrr.Description [AssetRiskRating],
        lrr.RiskColour [AssetRiskColour],
        lrr.SortOrder [AssetRiskRatingSortOrder],
        lac.LegionellaAssetCategoryID,
        lac.Description [AssetCategory],
        lac.SortOrder [AssetCategorySortOrder]
    FROM
        @LegionellaData l
        INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
        INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
    WHERE
        la.Deleted IS NULL
			AND
		la.DateRemoved IS NULL


    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        ll.LegionellaLocationID,
        ll.Location,
        ll.SortOrder [LocationSortOrder]
    FROM
        @LegionellaData l
        INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
    WHERE
        ll.Deleted IS NULL
			AND
		ll.DateRemoved IS NULL


    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)

    INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
    SELECT
        l.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        l.GeneralDescriptionOfSite,
        l.ScopeOfWork,
        l.AreasNotAccessed,
        l.LegionellaNotes,
        l.LegionellaPhotoID,
        lo.LegionellaOutletID,
        lo.PhotoID [OutletPhotoID],
        lo.SystemRef [OutletSystemRef],
        ll.LegionellaLocationID,
        ll.Location,
        ll.LocationSortOrder,
        lo.Cold [OutletCold],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletColdTriggered],
        lo.Hot [OutletHot],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletHotTriggered],
        lo.Mixed [OutletMixed],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletMixedTriggered],
        lo.Mains [OutletMains],
        CASE WHEN EXISTS(
            SELECT 1
            FROM
                LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
            WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
        ) THEN 1 ELSE 0 END [OutletMainsTriggered],
        lo.SentinelCold [OutletSentinelCold],
        lo.SentinelHot [OutletSentinelHot],
        lo.SentinelMixed [OutletSentinelMixed],
        lo.SentinelMains [OutletSentinelMains],
        lo.SortOrder [OutletSortOrder],
        lo.FlushedCold [OutletFlushedCold],
        lo.FlushedHot [OutletFlushedHot],
        lo.FlushedMixed [OutletFlushedMixed],
        lo.FlushedMains [OutletFlushedMains],
        lo.LowUseCold [OutletLowUseCold],
        lo.LowUseHot [OutletLowUseHot],
        lo.LowUseMixed [OutletLowUseMixed],
        lo.LowUseMains [OutletLowUseMains],
        sca.OutletSourceColdAssetID,
        sca.OutletSourceColdAssetSystemRef,
        sca.OutletSourceColdAssetLocation,
        sca.OutletSourceColdAssetCategory,
        sha.OutletSourceHotAssetID,
        sha.OutletSourceHotAssetSystemRef,
        sha.OutletSourceHotAssetLocation,
        sha.OutletSourceHotAssetCategory,
        sma.OutletSourceMixedAssetID,
        sma.OutletSourceMixedAssetSystemRef,
        sma.OutletSourceMixedAssetLocation,
        sma.OutletSourceMixedAssetCategory,
        smna.OutletSourceMainsAssetID,
        smna.OutletSourceMainsAssetSystemRef,
        smna.OutletSourceMainsAssetLocation,
        smna.OutletSourceMainsAssetCategory,
        loc.LegionellaOutletCategoryID,
        loc.Description [OutletCategory],
        loc.SortOrder [OutletCategorySortOrder]
    FROM
        @LegionellaData l
        INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
        INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
        LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceColdAssetID],
                _la.SystemRef [OutletSourceColdAssetSystemRef],
                _la.Location [OutletSourceColdAssetLocation],
                _lac.Description [OutletSourceColdAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceCold
        ) sca -- Source Cold Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceHotAssetID],
                _la.SystemRef [OutletSourceHotAssetSystemRef],
                _la.Location [OutletSourceHotAssetLocation],
                _lac.Description [OutletSourceHotAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceHot
        ) sha -- Source Hot Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceMixedAssetID],
                _la.SystemRef [OutletSourceMixedAssetSystemRef],
                _la.Location [OutletSourceMixedAssetLocation],
                _lac.Description [OutletSourceMixedAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceMixed
        ) sma -- Source Mixed Asset
        OUTER APPLY
        (
            SELECT
                _la.LegionellaAssetID [OutletSourceMainsAssetID],
                _la.SystemRef [OutletSourceMainsAssetSystemRef],
                _la.Location [OutletSourceMainsAssetLocation],
                _lac.Description [OutletSourceMainsAssetCategory]
            FROM
                LegionellaAsset _la WITH (NOLOCK)
                INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
            WHERE
                _la.LegionellaAssetID = lo.SourceMains
        ) smna -- Source Mains Asset
    WHERE
        lo.Deleted IS NULL
			AND
		lo.DateRemoved IS NULL

    -- Get Legionella Sample data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaSampleData TABLE (JobEmployeeID INT, LegionellaID INT, LegionellaOutletID INT, LegionellaSampleID INT, SampleRefCold VARCHAR(MAX), SampleRefHot VARCHAR(MAX), SampleRefMixed VARCHAR(MAX), SampleRefMains VARCHAR(MAX), LegionellaSampleTypeIDCold INT, SampleTypeCold VARCHAR(MAX), LegionellaSampleTypeIDHot INT, SampleTypeHot VARCHAR(MAX), LegionellaSampleTypeIDMixed INT, SampleTypeMixed VARCHAR(MAX), LegionellaSampleTypeIDMains INT, SampleTypeMains VARCHAR(MAX))

    INSERT INTO @LegionellaSampleData (JobEmployeeID, LegionellaID, LegionellaOutletID, LegionellaSampleID, SampleRefCold, SampleRefHot, SampleRefMixed, SampleRefMains, LegionellaSampleTypeIDCold, SampleTypeCold, LegionellaSampleTypeIDHot, SampleTypeHot, LegionellaSampleTypeIDMixed, SampleTypeMixed, LegionellaSampleTypeIDMains, SampleTypeMains)
    SELECT
        lo.JobEmployeeID,
        lo.LegionellaID,
        lo.LegionellaOutletID,
        ls.LegionellaSampleID,
        ls.SampleRefCold,
        ls.SampleRefHot,
        ls.SampleRefMixed,
        ls.SampleRefMains,
        lstc.LegionellaSampleTypeID [LegionellaSampleTypeIDCold],
        lstc.Description [SampleTypeCold],
        lsth.LegionellaSampleTypeID [LegionellaSampleTypeIDHot],
        lsth.Description [SampleTypeHot],
        lstm.LegionellaSampleTypeID [LegionellaSampleTypeIDMixed],
        lstm.Description [SampleTypeMixed],
        lstma.LegionellaSampleTypeID [LegionellaSampleTypeIDMains],
        lstma.Description [SampleTypeMains]
    FROM
        @LegionellaOutletData lo
        INNER JOIN LegionellaSample ls WITH (NOLOCK) ON lo.LegionellaOutletID = ls.LegionellaOutletID
        LEFT JOIN LegionellaSampleType lstc WITH (NOLOCK) ON ls.LegionellaSampleTypeIDCold = lstc.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lsth WITH (NOLOCK) ON ls.LegionellaSampleTypeIDHot = lsth.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lstm WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMixed = lstm.LegionellaSampleTypeID
        LEFT JOIN LegionellaSampleType lstma WITH (NOLOCK) ON ls.LegionellaSampleTypeIDMains = lstma.LegionellaSampleTypeID

    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaTaskID INT, LegionellaTaskNo INT, TaskRiskDescription VARCHAR(MAX), TaskAction VARCHAR(MAX), TaskSortOrder INT, LegionellaRiskCategoryID INT, RiskCategory VARCHAR(MAX), RiskCategorySortOrder INT, LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(MAX), FrequencyCategoryDateAddModifier VARCHAR(20), FrequencyCategoryDateAddValue INT, FrequencyCategoryDateCalc DATETIME, FrequencyCategorySortOrder INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, LegionellaPriorityRatingID INT, PriorityRating VARCHAR(MAX), ShortPriorityRating VARCHAR(20), PriorityColour VARCHAR(15), PriorityRatingSortOrder INT, LegionellaTaskAutoInsertTypeID INT, TaskAutoInsertType VARCHAR(MAX), LegionellaTaskEventID INT, EventPerformedByEmployeeID INT, EventPerformedByPortalUserID INT, EventPerformedByThirdParty VARCHAR(MAX), EventPerformedBy VARCHAR(MAX), EventComments VARCHAR(MAX), EventRecorded DATETIME, EventCreated DATETIME)

    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        lt.LegionellaTaskID,
        lt.LegionellaTaskNo,
        lt.RiskDescription [TaskRiskDescription],
        lt.Action [TaskAction],
        lt.SortOrder [TaskSortOrder],
        lrc.LegionellaRiskCategoryID,
        lrc.Description [RiskCategory],
        lrc.SortOrder [RiskCategorySortOrder],
        lfc.LegionellaFrequencyCategoryID,
        lfc.Description [FrequencyCategory],
        lfc.DateAddModifier [FrequencyCategoryDateAddModifier],
        lfc.DateAddValue [FrequencyCategoryDateAddValue],
        dbo.fn_DateAddFromStringPart(lfc.DateAddModifier, lfc.DateAddValue, lao.MonitoringSchedule) [FrequencyCategoryDateCalc],
        lfc.SortOrder [FrequencyCategorySortOrder],
        lrr.LegionellaRiskRatingID,
        lrr.Description [RiskRating],
        lrr.RiskColour,
        lrr.SortOrder [RiskRatingSortOrder],
        lpr.LegionellaPriorityRatingID,
        lpr.Description [PriorityRating],
        lpr.ShortDescription [ShortPriorityRating],
        lpr.PriorityColour,
        lpr.SortOrder [PriorityRatingSortOrder],
        ltait.LegionellaTaskAutoInsertTypeID,
        ltait.Description [TaskAutoInsertType],
        lte.LegionellaTaskEventID,
        lte.PerformedByEmployeeID [EventPerformedByEmployeeID],
        lte.PerformedByPortalUserID [EventPerformedByPortalUserID],
        lte.PerformedByThirdParty [EventPerformedByThirdParty],
        COALESCE(e.FullName, pu.FullName, lte.PerformedByThirdParty) [EventPerformedBy],
        lte.Comments [EventComments],
        lte.Recorded [EventRecorded],
        lte.Created [EventCreated]

    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
        ) lao
        LEFT JOIN LegionellaTask lt WITH (NOLOCK) ON
            CASE lao.RowType -- Join based on the main UNION
                WHEN 1 THEN lao.LegionellaID
                WHEN 3 THEN lao.LegionellaLocationID
                ELSE lao.LegionellaAssetOutletID
            END =
            CASE lao.RowType -- Join based on this live table
                WHEN 1 THEN lt.LegionellaID
                WHEN 2 THEN lt.LegionellaAssetID
                WHEN 3 THEN lt.LegionellaLocationID
                WHEN 4 THEN lt.LegionellaOutletID
            END
        LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lt.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
        LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
        LEFT JOIN LegionellaTaskAutoInsertType ltait WITH (NOLOCK) ON lt.LegionellaTaskAutoInsertTypeID = ltait.LegionellaTaskAutoInsertTypeID
        OUTER APPLY
        (
            SELECT TOP 1
                lte.LegionellaTaskEventID,
                lte.PerformedByEmployeeID,
                lte.PerformedByPortalUserID,
                lte.PerformedByThirdParty,
                lte.Comments,
                lte.Recorded,
                lte.Created
            FROM
                LegionellaTaskEvent lte WITH (NOLOCK)
            WHERE
                lte.LegionellaTaskID = lt.LegionellaTaskID
                    AND
                lte.Deleted IS NULL
            ORDER BY
                lte.Created
        ) lte -- Legionella Task Event
        LEFT JOIN Employee e WITH (NOLOCK) ON lte.PerformedByEmployeeID = e.EmployeeID
        LEFT JOIN PortalUser pu WITH (NOLOCK) ON lte.PerformedByPortalUserID = pu.PortalUserID
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
    WHERE
        lt.Deleted IS NULL
    ORDER BY
        lao.LegionellaStart,
        lao.RowType,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lt.SortOrder


    -- Get Legionella Risk data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaRiskData TABLE (LegionellaID INT, LegionellaLegRiskCategoryID INT, LegRiskCategory VARCHAR(MAX), LegRiskCategorySortOrder INT, LegionellaLegRiskRatingID INT, LegRiskRating VARCHAR(MAX), LegRiskColour VARCHAR(15), LegRiskRatingSortOrder INT)

    INSERT INTO @LegionellaRiskData (LegionellaID, LegionellaLegRiskCategoryID, LegRiskCategory, LegRiskCategorySortOrder, LegionellaLegRiskRatingID, LegRiskRating, LegRiskColour, LegRiskRatingSortOrder)
    SELECT
        lrcor.LegionellaID,
        lrc.LegionellaRiskCategoryID [LegionellaLegRiskCategoryID],
        lrc.Description [LegRiskCategory],
        lrc.SortOrder [LegRiskCategorySortOrder],
        lrr.LegionellaRiskRatingID [LegionellaLegRiskRatingID],
        lrr.Description [LegRiskRating],
        lrr.RiskColour [LegRiskColour],
        lrr.SortOrder [LegRiskRatingSortOrder]
    FROM
        LegionellaRiskCategoryOverallRisk lrcor WITH (NOLOCK)
        LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lrcor.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
        LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lrcor.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
    WHERE
        lrcor.LegionellaID IN (SELECT DISTINCT LegionellaID FROM @LegionellaData)


    -- Start the main SELECT. Get all the main counts / bits of data.
    SELECT
        (SELECT COUNT(*) FROM @LegionellaData) [NumberOfLegionellas],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 0) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringSchedule],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 1) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringSchedule_dd/MM/yyyy],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 2) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleFull],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT dbo.FormatDateCustom(MonitoringSchedule, 3) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleFullExt],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT CAST(DAY(MonitoringSchedule) AS VARCHAR(2)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleDay],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT RIGHT('0' + CAST(MONTH(MonitoringSchedule) AS VARCHAR(2)), 2) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonth],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT DATENAME(MM, MonitoringSchedule) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonthName],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT UPPER(DATENAME(MM, MonitoringSchedule)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleMonthNameCaps],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT CAST(YEAR(MonitoringSchedule) AS VARCHAR(4)) FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllMonitoringScheduleYear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT BuildingDesignation FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllBuildingDesignation],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT GeneralDescriptionOfSite FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllGeneralDescriptionOfSite],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT ScopeOfWork FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllScopeOfWorks],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AreasNotAccessed FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllAreasNotAccessed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegionellaNotes FROM @LegionellaData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegionellaNotes],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegRiskCategory FROM @LegionellaRiskData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegRiskCategory],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT LegRiskRating FROM @LegionellaRiskData) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AllLegRiskRating],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskCategoryWhereRiskCategory1],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskRatingWhereRiskCategory1],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 1) [LegionellaRiskColourWhereRiskCategory1],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskCategoryWhereRiskCategory2],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskRatingWhereRiskCategory2],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 2) [LegionellaRiskColourWhereRiskCategory2],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskCategoryWhereRiskCategory3],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskRatingWhereRiskCategory3],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 3) [LegionellaRiskColourWhereRiskCategory3],
        (SELECT TOP 1 LegRiskCategory FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskCategoryWhereRiskCategory4],
        (SELECT TOP 1 LegRiskRating FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskRatingWhereRiskCategory4],
        (SELECT TOP 1 LegRiskColour FROM @LegionellaRiskData WHERE LegionellaLegRiskCategoryID = 4) [LegionellaRiskColourWhereRiskCategory4],
        (SELECT COUNT(*) FROM @LegionellaAssetData) [NumberOfAssets],
        STUFF((SELECT DISTINCT ', ' + AssetSystemRef FROM @LegionellaAssetData ORDER BY ', ' + AssetSystemRef FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AssetSystemRefs],
        STUFF((SELECT DISTINCT ', ' + AssetLocation FROM @LegionellaAssetData ORDER BY ', ' + AssetLocation FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [AssetLocations],
        (SELECT COUNT(*) FROM @LegionellaLocationData) [NumberOfLocations],
        STUFF((SELECT DISTINCT ', ' + Location FROM @LegionellaLocationData ORDER BY ', ' + Location FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [LegionellaLocations],
        (SELECT COUNT(*) FROM @LegionellaOutletData) [NumberOfOutlets],
        STUFF((SELECT DISTINCT ', ' + OutletSystemRef FROM @LegionellaOutletData ORDER BY ', ' + OutletSystemRef FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefs],
        STUFF((SELECT DISTINCT ', ' + Location FROM @LegionellaOutletData ORDER BY ', ' + Location FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocations],
        (SELECT COUNT(*) FROM @LegionellaAssetData WHERE LegionellaAssetRiskRatingID IS NOT NULL) [NumberOfAssetsWithRiskRating],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletCold IS NOT NULL) [NumberOfOutletsWithCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) [NumberOfOutletsWithColdTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithColdTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletColdTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithColdTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) [NumberOfOutletsWithColdNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithColdNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletColdTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithColdNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHot IS NOT NULL) [NumberOfOutletsWithHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) [NumberOfOutletsWithHotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithHotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletHotTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithHotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) [NumberOfOutletsWithHotNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithHotNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletHotTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithHotNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixed IS NOT NULL) [NumberOfOutletsWithMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) [NumberOfOutletsWithMixedTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMixedTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMixedTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMixedTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) [NumberOfOutletsWithMixedNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMixedNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMixedTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMixedNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMains IS NOT NULL) [NumberOfOutletsWithMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) [NumberOfOutletsWithMainsTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMainsTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMainsTriggered = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMainsTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) [NumberOfOutletsWithMainsNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithMainsNotTriggered],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletMainsTriggered = 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithMainsNotTriggered],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) [NumberOfOutletsWithSentinelCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) [NumberOfOutletsWithSentinelHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) [NumberOfOutletsWithSentinelMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) [NumberOfOutletsWithSentinelMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains > 0) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) [NumberOfOutletsWithSentinelColdNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelColdNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelColdNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) [NumberOfOutletsWithSentinelHotNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHotNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHotNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) [NumberOfOutletsWithSentinelMixedNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixedNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixedNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) [NumberOfOutletsWithSentinelMainsNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMainsNear],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMainsNear],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) [NumberOfOutletsWithSentinelColdFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelColdFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelCold = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelColdFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) [NumberOfOutletsWithSentinelHotFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelHotFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelHot = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelHotFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) [NumberOfOutletsWithSentinelMixedFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMixedFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMixed = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMixedFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) [NumberOfOutletsWithSentinelMainsFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithSentinelMainsFar],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletSentinelMains = 2) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithSentinelMainsFar],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) [NumberOfOutletsWithFlushedCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) [NumberOfOutletsWithFlushedHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) [NumberOfOutletsWithFlushedMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) [NumberOfOutletsWithFlushedMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithFlushedMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletFlushedMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithFlushedMains],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) [NumberOfOutletsWithLowUseCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseCold],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseCold = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseCold],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) [NumberOfOutletsWithLowUseHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseHot],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseHot = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseHot],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) [NumberOfOutletsWithLowUseMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseMixed],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseMixed = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseMixed],
        (SELECT COUNT(*) FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) [NumberOfOutletsWithLowUseMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT OutletSystemRef FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletSystemRefsWithLowUseMains],
        STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT Location FROM @LegionellaOutletData WHERE OutletLowUseMains = 1) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') [OutletLocationsWithLowUseMains],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL) [NumberOfTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL) [NumberOfNonTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 1) [NumberOfLegionellaTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 1) [NumberOfNonLegionellaTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 2) [NumberOfAssetTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 2) [NumberOfNonAssetTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 3) [NumberOfLocationTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 3) [NumberOfNonLocationTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND RowType = 4) [NumberOfOutletTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NULL AND RowType = 4) [NumberOfNonOutletTasks],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID IS NULL) [NumberOfTasksWithoutRiskCategory],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 1) [NumberOfTasksWithRiskCategory1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 2) [NumberOfTasksWithRiskCategory2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 3) [NumberOfTasksWithRiskCategory3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 4) [NumberOfTasksWithRiskCategory4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskCategoryID = 5) [NumberOfTasksWithRiskCategory5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID IS NULL) [NumberOfTasksWithoutFrequencyCategory],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 1) [NumberOfTasksWithFrequencyCategory1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 2) [NumberOfTasksWithFrequencyCategory2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 3) [NumberOfTasksWithFrequencyCategory3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 4) [NumberOfTasksWithFrequencyCategory4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaFrequencyCategoryID = 5) [NumberOfTasksWithFrequencyCategory5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID IS NULL) [NumberOfTasksWithoutRiskRating],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 1) [NumberOfTasksWithRiskRating1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 2) [NumberOfTasksWithRiskRating2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 3) [NumberOfTasksWithRiskRating3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 4) [NumberOfTasksWithRiskRating4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaRiskRatingID = 5) [NumberOfTasksWithRiskRating5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID IS NULL) [NumberOfTasksWithoutPriorityRating],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 1) [NumberOfTasksWithPriorityRating1],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 2) [NumberOfTasksWithPriorityRating2],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 3) [NumberOfTasksWithPriorityRating3],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 4) [NumberOfTasksWithPriorityRating4],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskID IS NOT NULL AND LegionellaPriorityRatingID = 5) [NumberOfTasksWithPriorityRating5],
        (SELECT COUNT(*) FROM @MainData WHERE LegionellaTaskEventID IS NOT NULL) [NumberOfTasksWithEvents],
        (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedCold = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedHot = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedMixed = 1) + (SELECT COUNT(*) FROM @MainData WHERE OutletFlushedMains = 1) [TotalNumberFlushed],
        (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDCold IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDHot IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDMixed IS NOT NULL) + (SELECT COUNT(*) FROM @LegionellaSampleData WHERE LegionellaSampleTypeIDMains IS NOT NULL) [TotalSamplesTaken]


    -- Start the next SELECT. Get counts for each category.
    SELECT
        lac.LegionellaAssetCategoryID,
        lac.Description,
        'ASSETCATEGORY' + UPPER(REPLACE(lac.Description, ' ', '')) [CategoryReplaceVar],
        lac.SortOrder,
        CASE WHEN de.DoesExist = 1
            THEN (SELECT COUNT(*) FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID)
            ELSE 0
        END [CategoryCount],
        CASE WHEN de.DoesExist = 1
            THEN STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AssetSystemRef FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')
            ELSE NULL
        END [CategorySystemRefs],
        CASE WHEN de.DoesExist = 1
            THEN STUFF((SELECT DISTINCT ', ' + a.a FROM (SELECT AssetLocation FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) a(a) WHERE NULLIF(a.a, '') IS NOT NULL ORDER BY ', ' + a.a FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')
            ELSE NULL
        END [CategoryLocations]
    FROM
        LegionellaAssetCategory lac WITH (NOLOCK)
        OUTER APPLY
        (
            SELECT CASE WHEN EXISTS(SELECT 1 FROM @LegionellaAssetData WHERE LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID) THEN 1 ELSE 0 END [DoesExist]
        ) de -- Data Exists
    WHERE
        lac.Deleted IS NULL
    ORDER BY
        lac.SortOrder


    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaPhotos') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaPhotos] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaPhotos]
    @JobID INT,
    @CustomDateFormat SMALLINT,
    @IncludeNullPhotos BIT,
    @IncludeLegionella BIT,
    @IncludeSectionTasks BIT,
    @IncludeAssets BIT,
    @IncludeAssetTasks BIT,
    @IncludeLocationTasks BIT,
    @IncludeOutlets BIT,
    @IncludeOutletTasks BIT,
    @LegionellaID INT = 0,
    @LegionellaAssetID INT = 0,
    @LegionellaLocationID INT = 0,
    @LegionellaOutletID INT = 0,
    @LegionellaTaskID INT = 0,
    @LegionellaSectionID INT = 0
/**********************************************************************
** Overview: Get Legionella, Asset, Location and Outlet photos, as well as the Task photos for each of these. Set the above parameters to control which of these to display.
**
** PLEASE NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
** WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES, AND COMMIT INTO SVN.
** MAKE SURE YOU ALSO CONSIDER ADJUSTING OTHER GENERIC TEMPLATE LEGIONELLA SPROCS, IF MODIFYING DATA IN THE TABLE VARIABLES THAT ARE SHARED WITH ALL OF THESE (E.G. @LegionellaData, @LegionellaAssetData, etc.).
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- DEBUG
        --DECLARE @JobID INT = 11402,
        --@CustomDateFormat SMALLINT = 0,
        --@IncludeNullPhotos BIT = 1,
        --@IncludeLegionella BIT = 0,
        --@IncludeSectionTasks BIT = 0,
        --@IncludeAssets BIT = 0,
        --@IncludeAssetTasks BIT = 0,
        --@IncludeLocationTasks BIT = 0,
        --@IncludeOutlets BIT = 1,
        --@IncludeOutletTasks BIT = 0,
        --@LegionellaID INT = 0,
        --@LegionellaAssetID INT = 0,
        --@LegionellaLocationID INT = 0,
        --@LegionellaOutletID INT = 0,
        --@LegionellaTaskID INT = 0,
        --@LegionellaSectionID INT = 0
    -- END DEBUG
    
    IF (@LegionellaTaskID > 0 AND @LegionellaID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaAssetID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaLocationID = 0) OR (@LegionellaTaskID > 0 AND @LegionellaOutletID = 0)
    BEGIN
        SELECT
            @LegionellaID = ISNULL(LegionellaID, @LegionellaID),
            @LegionellaAssetID = ISNULL(LegionellaAssetID, @LegionellaAssetID),
            @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID),
            @LegionellaOutletID = ISNULL(LegionellaOutletID, @LegionellaOutletID)
        FROM LegionellaTask WITH (NOLOCK)
        WHERE LegionellaTaskID = @LegionellaTaskID
    END
    IF @LegionellaAssetID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaAsset WITH (NOLOCK)
        WHERE LegionellaAssetID = @LegionellaAssetID AND DateRemoved IS NULL
    END
    IF @LegionellaOutletID > 0 AND @LegionellaLocationID = 0
    BEGIN
        SELECT @LegionellaLocationID = ISNULL(LegionellaLocationID, @LegionellaLocationID)
        FROM LegionellaOutlet WITH (NOLOCK)
        WHERE LegionellaOutletID = @LegionellaOutletID AND DateRemoved IS NULL
    END
    IF @LegionellaLocationID > 0 AND @LegionellaID = 0
    BEGIN
        SELECT @LegionellaID = ISNULL(LegionellaID, @LegionellaID)
        FROM LegionellaLocation WITH (NOLOCK)
        WHERE LegionellaLocationID = @LegionellaLocationID AND DateRemoved IS NULL
    END
    
    
    -- Get Legionella data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT)
    
    INSERT INTO @LegionellaData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID)
    SELECT
        je.JobEmployeeID,
        l.LegionellaID,
        l.BuildingDesignation,
        l.LegionellaStart,
        l.LegionellaFinish,
        l.MonitoringSchedule,
        dbo.HtmlEncode(l.GeneralDescriptionOfSite) [GeneralDescriptionOfSite],
        dbo.HtmlEncode(l.ScopeOfWork) [ScopeOfWork],
        dbo.HtmlEncode(l.AreasNotAccessed) [AreasNotAccessed],
        dbo.HtmlEncode(l.Notes) [LegionellaNotes],
        l.PhotoID [LegionellaPhotoID]
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
    WHERE
        je.JobID = @JobID
            AND
        (l.LegionellaID = @LegionellaID OR @LegionellaID = 0)
    
    
    -- Get Legionella Asset data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaAssetData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaAssetID INT, AssetPhotoID INT, AssetSystemRef VARCHAR(MAX), AssetLocation VARCHAR(MAX), AssetSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, LegionellaAssetCategoryID INT, AssetCategory VARCHAR(MAX), AssetCategorySortOrder INT)
    
    IF @IncludeAssets = 1 OR @IncludeAssetTasks = 1
    BEGIN
        
        INSERT INTO @LegionellaAssetData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaAssetID, AssetPhotoID, AssetSystemRef, AssetLocation, AssetSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, LegionellaAssetCategoryID, AssetCategory, AssetCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            la.LegionellaAssetID,
            la.PhotoID [AssetPhotoID],
            la.SystemRef [AssetSystemRef],
            la.Location [AssetLocation],
            la.SortOrder [AssetSortOrder],
            lrr.LegionellaRiskRatingID [LegionellaAssetRiskRatingID],
            lrr.Description [AssetRiskRating],
            lrr.RiskColour [AssetRiskColour],
            lrr.SortOrder [AssetRiskRatingSortOrder],
            lac.LegionellaAssetCategoryID,
            lac.Description [AssetCategory],
            lac.SortOrder [AssetCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            INNER JOIN LegionellaAssetCategory lac WITH (NOLOCK) ON la.LegionellaAssetCategoryID = lac.LegionellaAssetCategoryID
            LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON la.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
        WHERE
            la.Deleted IS NULL
                AND
			la.DateRemoved IS NULL
				AND
            (la.LegionellaAssetID = @LegionellaAssetID OR @LegionellaAssetID = 0)
        
    END
    
    
    -- Get Legionella Location data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaLocationData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT)

    IF @IncludeLocationTasks = 1 OR @IncludeOutlets = 1 OR @IncludeOutletTasks = 1
    BEGIN
        
        INSERT INTO @LegionellaLocationData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaLocationID, Location, LocationSortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            ll.LegionellaLocationID,
            ll.Location,
            ll.SortOrder [LocationSortOrder]

        FROM
            @LegionellaData l
            INNER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
        WHERE
            ll.Deleted IS NULL
                AND
			ll.DateRemoved IS NULL
				AND
            (ll.LegionellaLocationID = @LegionellaLocationID OR @LegionellaLocationID = 0)

    END
    
    
    -- Get Legionella Outlet data up front to reduce the main SELECT table scans.
    DECLARE @LegionellaOutletData TABLE (JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaOutletID INT, OutletPhotoID INT, OutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, Location VARCHAR(MAX), LocationSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletSortOrder INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaOutletCategoryID INT, OutletCategory VARCHAR(MAX), OutletCategorySortOrder INT)
    
    IF @IncludeOutlets = 1 OR @IncludeOutletTasks = 1
    BEGIN
        
        INSERT INTO @LegionellaOutletData (JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaOutletID, OutletPhotoID, OutletSystemRef, LegionellaLocationID, Location, LocationSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletSortOrder, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaOutletCategoryID, OutletCategory, OutletCategorySortOrder)
        SELECT
            l.JobEmployeeID,
            l.LegionellaID,
            l.BuildingDesignation,
            l.LegionellaStart,
            l.LegionellaFinish,
            l.MonitoringSchedule,
            l.GeneralDescriptionOfSite,
            l.ScopeOfWork,
            l.AreasNotAccessed,
            l.LegionellaNotes,
            l.LegionellaPhotoID,
            lo.LegionellaOutletID,
            lo.PhotoID [OutletPhotoID],
            lo.SystemRef [OutletSystemRef],
            ll.LegionellaLocationID,
            ll.Location,
            ll.LocationSortOrder,
            lo.Cold [OutletCold],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 1 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletColdTriggered],
            lo.Hot [OutletHot],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 2 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletHotTriggered],
            lo.Mixed [OutletMixed],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 3 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMixedTriggered],
            lo.Mains [OutletMains],
            CASE WHEN EXISTS(
                SELECT 1
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger _laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaTask _lt WITH (NOLOCK) ON _laotqt.LegionellaTaskAutoInsertID = _lt.LegionellaTaskAutoInsertID AND _lt.LegionellaOutletID = lo.LegionellaOutletID
                WHERE _laotqt.LegionellaOutletEntryID = 4 AND _laotqt.Deleted IS NULL AND _lt.Deleted IS NULL
            ) THEN 1 ELSE 0 END [OutletMainsTriggered],
            lo.SentinelCold [OutletSentinelCold],
            lo.SentinelHot [OutletSentinelHot],
            lo.SentinelMixed [OutletSentinelMixed],
            lo.SentinelMains [OutletSentinelMains],
            lo.SortOrder [OutletSortOrder],
            lo.FlushedCold [OutletFlushedCold],
            lo.FlushedHot [OutletFlushedHot],
            lo.FlushedMixed [OutletFlushedMixed],
            lo.FlushedMains [OutletFlushedMains],
            lo.LowUseCold [OutletLowUseCold],
            lo.LowUseHot [OutletLowUseHot],
            lo.LowUseMixed [OutletLowUseMixed],
            lo.LowUseMains [OutletLowUseMains],
            sca.OutletSourceColdAssetID,
            sca.OutletSourceColdAssetSystemRef,
            sca.OutletSourceColdAssetLocation,
            sca.OutletSourceColdAssetCategory,
            sha.OutletSourceHotAssetID,
            sha.OutletSourceHotAssetSystemRef,
            sha.OutletSourceHotAssetLocation,
            sha.OutletSourceHotAssetCategory,
            sma.OutletSourceMixedAssetID,
            sma.OutletSourceMixedAssetSystemRef,
            sma.OutletSourceMixedAssetLocation,
            sma.OutletSourceMixedAssetCategory,
            smna.OutletSourceMainsAssetID,
            smna.OutletSourceMainsAssetSystemRef,
            smna.OutletSourceMainsAssetLocation,
            smna.OutletSourceMainsAssetCategory,
            loc.LegionellaOutletCategoryID,
            loc.Description [OutletCategory],
            loc.SortOrder [OutletCategorySortOrder]
            
        FROM
            @LegionellaData l
            INNER JOIN @LegionellaLocationData ll ON l.LegionellaID = ll.LegionellaID
            INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
            LEFT JOIN LegionellaOutletCategory loc WITH (NOLOCK) ON lo.LegionellaOutletCategoryID = loc.LegionellaOutletCategoryID
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceColdAssetID],
                    _la.SystemRef [OutletSourceColdAssetSystemRef],
                    _la.Location [OutletSourceColdAssetLocation],
                    _lac.Description [OutletSourceColdAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceCold
            ) sca -- Source Cold Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceHotAssetID],
                    _la.SystemRef [OutletSourceHotAssetSystemRef],
                    _la.Location [OutletSourceHotAssetLocation],
                    _lac.Description [OutletSourceHotAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceHot
            ) sha -- Source Hot Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMixedAssetID],
                    _la.SystemRef [OutletSourceMixedAssetSystemRef],
                    _la.Location [OutletSourceMixedAssetLocation],
                    _lac.Description [OutletSourceMixedAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMixed
            ) sma -- Source Mixed Asset
            OUTER APPLY
            (
                SELECT
                    _la.LegionellaAssetID [OutletSourceMainsAssetID],
                    _la.SystemRef [OutletSourceMainsAssetSystemRef],
                    _la.Location [OutletSourceMainsAssetLocation],
                    _lac.Description [OutletSourceMainsAssetCategory]
                FROM
                    LegionellaAsset _la WITH (NOLOCK)
                    INNER JOIN LegionellaAssetCategory _lac WITH (NOLOCK) ON _la.LegionellaAssetCategoryID = _lac.LegionellaAssetCategoryID
                WHERE
                    _la.LegionellaAssetID = lo.SourceMains
            ) smna -- Source Mains Asset
        WHERE
            lo.Deleted IS NULL
                AND
			lo.DateRemoved IS NULL
				AND
            (lo.LegionellaOutletID = @LegionellaOutletID OR @LegionellaOutletID = 0)
        
    END
    
    
    -- Get the main data.
    DECLARE @MainData TABLE (RowID INT IDENTITY(1,1), RowType INT, JobEmployeeID INT, LegionellaID INT, BuildingDesignation VARCHAR(MAX), LegionellaStart DATETIME, LegionellaFinish DATETIME, MonitoringSchedule DATETIME, GeneralDescriptionOfSite VARCHAR(MAX), ScopeOfWork VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), LegionellaNotes VARCHAR(MAX), LegionellaPhotoID INT, LegionellaPhotoNo VARCHAR(50), LegionellaAssetOutletID INT, AssetOutletPhotoID INT, AssetOutletPhotoNo VARCHAR(50), AssetOutletSystemRef VARCHAR(MAX), LegionellaLocationID INT, AssetOutletLocation VARCHAR(MAX), LocationSortOrder INT, AssetOutletSortOrder INT, LegionellaAssetRiskRatingID INT, AssetRiskRating VARCHAR(MAX), AssetRiskColour VARCHAR(15), AssetRiskRatingSortOrder INT, OutletCold DECIMAL(10, 2), OutletColdTriggered BIT, OutletHot DECIMAL(10, 2), OutletHotTriggered BIT, OutletMixed DECIMAL(10, 2), OutletMixedTriggered BIT, OutletMains DECIMAL(10, 2), OutletMainsTriggered BIT, OutletSentinelCold INT, OutletSentinelHot INT, OutletSentinelMixed INT, OutletSentinelMains INT, OutletFlushedCold BIT, OutletFlushedHot BIT, OutletFlushedMixed BIT, OutletFlushedMains BIT, OutletLowUseCold BIT, OutletLowUseHot BIT, OutletLowUseMixed BIT, OutletLowUseMains BIT, OutletSourceColdAssetID INT, OutletSourceColdAssetSystemRef VARCHAR(MAX), OutletSourceColdAssetLocation VARCHAR(MAX), OutletSourceColdAssetCategory VARCHAR(MAX), OutletSourceHotAssetID INT, OutletSourceHotAssetSystemRef VARCHAR(MAX), OutletSourceHotAssetLocation VARCHAR(MAX), OutletSourceHotAssetCategory VARCHAR(MAX), OutletSourceMixedAssetID INT, OutletSourceMixedAssetSystemRef VARCHAR(MAX), OutletSourceMixedAssetLocation VARCHAR(MAX), OutletSourceMixedAssetCategory VARCHAR(MAX), OutletSourceMainsAssetID INT, OutletSourceMainsAssetSystemRef VARCHAR(MAX), OutletSourceMainsAssetLocation VARCHAR(MAX), OutletSourceMainsAssetCategory VARCHAR(MAX), LegionellaAssetOutletCategoryID INT, AssetOutletCategory VARCHAR(MAX), AssetOutletCategorySortOrder INT, LegionellaTaskID INT, LegionellaTaskNo INT, TaskRiskDescription VARCHAR(MAX), TaskAction VARCHAR(MAX), TaskSortOrder INT, LegionellaRiskCategoryID INT, RiskCategory VARCHAR(MAX), RiskCategorySortOrder INT, LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(MAX), FrequencyCategoryDateAddModifier VARCHAR(20), FrequencyCategoryDateAddValue INT, FrequencyCategoryDateCalc DATETIME, FrequencyCategorySortOrder INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, LegionellaPriorityRatingID INT, PriorityRating VARCHAR(MAX), ShortPriorityRating VARCHAR(20), PriorityColour VARCHAR(15), PriorityRatingSortOrder INT, LegionellaTaskAutoInsertTypeID INT, TaskAutoInsertType VARCHAR(MAX), LegionellaTaskEventID INT, EventPerformedByEmployeeID INT, EventPerformedByPortalUserID INT, EventPerformedByThirdParty VARCHAR(MAX), EventPerformedBy VARCHAR(MAX), EventComments VARCHAR(MAX), EventRecorded DATETIME, EventCreated DATETIME, LegionellaAssetOutletQuestionID INT, QuestionSubTabTitle VARCHAR(MAX), QuestionGroupTitle VARCHAR(MAX), Question VARCHAR(MAX), EntryType VARCHAR(MAX), NullReplace VARCHAR(MAX), ReplaceVariable VARCHAR(MAX), LegionellaAssetOutletQuestionSortOrder INT, TaskPhotoID INT, TaskPhotoNo VARCHAR(50))
    
    INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated, LegionellaAssetOutletQuestionID, QuestionSubTabTitle, QuestionGroupTitle, Question, EntryType, NullReplace, ReplaceVariable, LegionellaAssetOutletQuestionSortOrder, TaskPhotoID, TaskPhotoNo)
    SELECT
        lao.RowType,
        lao.JobEmployeeID,
        lao.LegionellaID,
        lao.BuildingDesignation,
        lao.LegionellaStart,
        lao.LegionellaFinish,
        lao.MonitoringSchedule,
        lao.GeneralDescriptionOfSite,
        lao.ScopeOfWork,
        lao.AreasNotAccessed,
        lao.LegionellaNotes,
        lp.PhotoID [LegionellaPhotoID],
        lp.PhotoNo [LegionellaPhotoNo],
        lao.LegionellaAssetOutletID,
        aop.PhotoID [AssetOutletPhotoID],
        aop.PhotoNo [AssetOutletPhotoNo],
        lao.AssetOutletSystemRef,
        lao.LegionellaLocationID,
        lao.AssetOutletLocation,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder,
        lao.LegionellaAssetRiskRatingID,
        lao.AssetRiskRating,
        lao.AssetRiskColour,
        lao.AssetRiskRatingSortOrder,
        lao.OutletCold,
        lao.OutletColdTriggered,
        lao.OutletHot,
        lao.OutletHotTriggered,
        lao.OutletMixed,
        lao.OutletMixedTriggered,
        lao.OutletMains,
        lao.OutletMainsTriggered,
        lao.OutletSentinelCold,
        lao.OutletSentinelHot,
        lao.OutletSentinelMixed,
        lao.OutletSentinelMains,
        lao.OutletFlushedCold,
        lao.OutletFlushedHot,
        lao.OutletFlushedMixed,
        lao.OutletFlushedMains,
        lao.OutletLowUseCold,
        lao.OutletLowUseHot,
        lao.OutletLowUseMixed,
        lao.OutletLowUseMains,
        lao.OutletSourceColdAssetID,
        lao.OutletSourceColdAssetSystemRef,
        lao.OutletSourceColdAssetLocation,
        lao.OutletSourceColdAssetCategory,
        lao.OutletSourceHotAssetID,
        lao.OutletSourceHotAssetSystemRef,
        lao.OutletSourceHotAssetLocation,
        lao.OutletSourceHotAssetCategory,
        lao.OutletSourceMixedAssetID,
        lao.OutletSourceMixedAssetSystemRef,
        lao.OutletSourceMixedAssetLocation,
        lao.OutletSourceMixedAssetCategory,
        lao.OutletSourceMainsAssetID,
        lao.OutletSourceMainsAssetSystemRef,
        lao.OutletSourceMainsAssetLocation,
        lao.OutletSourceMainsAssetCategory,
        lao.LegionellaAssetOutletCategoryID,
        lao.AssetOutletCategory,
        lao.AssetOutletCategorySortOrder,
        NULL [LegionellaTaskID],
        NULL [LegionellaTaskNo],
        NULL [TaskRiskDescription],
        NULL [TaskAction],
        NULL [TaskSortOrder],
        NULL [LegionellaRiskCategoryID],
        NULL [RiskCategory],
        NULL [RiskCategorySortOrder],
        NULL [LegionellaFrequencyCategoryID],
        NULL [FrequencyCategory],
        NULL [FrequencyCategoryDateAddModifier],
        NULL [FrequencyCategoryDateAddValue],
        NULL [FrequencyCategoryDateCalc],
        NULL [FrequencyCategorySortOrder],
        NULL [LegionellaRiskRatingID],
        NULL [RiskRating],
        NULL [RiskColour],
        NULL [RiskRatingSortOrder],
        NULL [LegionellaPriorityRatingID],
        NULL [PriorityRating],
        NULL [ShortPriorityRating],
        NULL [PriorityColour],
        NULL [PriorityRatingSortOrder],
        NULL [LegionellaTaskAutoInsertTypeID],
        NULL [TaskAutoInsertType],
        NULL [LegionellaTaskEventID],
        NULL [EventPerformedByEmployeeID],
        NULL [EventPerformedByPortalUserID],
        NULL [EventPerformedByThirdParty],
        NULL [EventPerformedBy],
        NULL [EventComments],
        NULL [EventRecorded],
        NULL [EventCreated],
        NULL [LegionellaAssetOutletQuestionID],
        NULL [QuestionSubTabTitle],
        NULL [QuestionGroupTitle],
        NULL [Question],
        NULL [EntryType],
        NULL [NullReplace],
        NULL [ReplaceVariable],
        NULL [LegionellaAssetOutletQuestionSortOrder],
        NULL [TaskPhotoID],
        NULL [TaskPhotoNo]
        
    FROM
        (
            SELECT
                1 [RowType],
                l.JobEmployeeID,
                l.LegionellaID,
                l.BuildingDesignation,
                l.LegionellaStart,
                l.LegionellaFinish,
                l.MonitoringSchedule,
                l.GeneralDescriptionOfSite,
                l.ScopeOfWork,
                l.AreasNotAccessed,
                l.LegionellaNotes,
                l.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                NULL [AssetOutletLocation],
                NULL [LocationSortOrder],
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaData l
            WHERE @IncludeLegionella = 1 OR @IncludeSectionTasks = 1
                UNION ALL
            SELECT
                2 [RowType],
                la.JobEmployeeID,
                la.LegionellaID,
                la.BuildingDesignation,
                la.LegionellaStart,
                la.LegionellaFinish,
                la.MonitoringSchedule,
                la.GeneralDescriptionOfSite,
                la.ScopeOfWork,
                la.AreasNotAccessed,
                la.LegionellaNotes,
                la.LegionellaPhotoID,
                la.LegionellaAssetID [LegionellaAssetOutletID],
                la.AssetPhotoID [AssetOutletPhotoID],
                la.AssetSystemRef [AssetOutletSystemRef],
                NULL [LegionellaLocationID],
                la.AssetLocation [AssetOutletLocation],
                NULL [LocationSortOrder],
                la.AssetSortOrder [AssetOutletSortOrder],
                la.LegionellaAssetRiskRatingID,
                la.AssetRiskRating,
                la.AssetRiskColour,
                la.AssetRiskRatingSortOrder,
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                la.LegionellaAssetCategoryID [LegionellaAssetOutletCategoryID],
                la.AssetCategory [AssetOutletCategory],
                la.AssetCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaAssetData la
            WHERE @IncludeAssets = 1 OR @IncludeAssetTasks = 1
                UNION ALL
            SELECT
                3 [RowType],
                ll.JobEmployeeID,
                ll.LegionellaID,
                ll.BuildingDesignation,
                ll.LegionellaStart,
                ll.LegionellaFinish,
                ll.MonitoringSchedule,
                ll.GeneralDescriptionOfSite,
                ll.ScopeOfWork,
                ll.AreasNotAccessed,
                ll.LegionellaNotes,
                ll.LegionellaPhotoID,
                NULL [LegionellaAssetOutletID],
                NULL [AssetOutletPhotoID],
                NULL [AssetOutletSystemRef],
                ll.LegionellaLocationID,
                ll.Location [AssetOutletLocation],
                ll.LocationSortOrder,
                NULL [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                NULL [OutletCold],
                NULL [OutletColdTriggered],
                NULL [OutletHot],
                NULL [OutletHotTriggered],
                NULL [OutletMixed],
                NULL [OutletMixedTriggered],
                NULL [OutletMains],
                NULL [OutletMainsTriggered],
                NULL [OutletSentinelCold],
                NULL [OutletSentinelHot],
                NULL [OutletSentinelMixed],
                NULL [OutletSentinelMains],
                NULL [OutletFlushedCold],
                NULL [OutletFlushedHot],
                NULL [OutletFlushedMixed],
                NULL [OutletFlushedMains],
                NULL [OutletLowUseCold],
                NULL [OutletLowUseHot],
                NULL [OutletLowUseMixed],
                NULL [OutletLowUseMains],
                NULL [OutletSourceColdAssetID],
                NULL [OutletSourceColdAssetSystemRef],
                NULL [OutletSourceColdAssetLocation],
                NULL [OutletSourceColdAssetCategory],
                NULL [OutletSourceHotAssetID],
                NULL [OutletSourceHotAssetSystemRef],
                NULL [OutletSourceHotAssetLocation],
                NULL [OutletSourceHotAssetCategory],
                NULL [OutletSourceMixedAssetID],
                NULL [OutletSourceMixedAssetSystemRef],
                NULL [OutletSourceMixedAssetLocation],
                NULL [OutletSourceMixedAssetCategory],
                NULL [OutletSourceMainsAssetID],
                NULL [OutletSourceMainsAssetSystemRef],
                NULL [OutletSourceMainsAssetLocation],
                NULL [OutletSourceMainsAssetCategory],
                NULL [LegionellaAssetOutletCategoryID],
                NULL [AssetOutletCategory],
                NULL [AssetOutletCategorySortOrder]
            FROM @LegionellaLocationData ll
            WHERE @IncludeLocationTasks = 1
                UNION ALL
            SELECT
                4 [RowType],
                lo.JobEmployeeID,
                lo.LegionellaID,
                lo.BuildingDesignation,
                lo.LegionellaStart,
                lo.LegionellaFinish,
                lo.MonitoringSchedule,
                lo.GeneralDescriptionOfSite,
                lo.ScopeOfWork,
                lo.AreasNotAccessed,
                lo.LegionellaNotes,
                lo.LegionellaPhotoID,
                lo.LegionellaOutletID [LegionellaAssetOutletID],
                lo.OutletPhotoID [AssetOutletPhotoID],
                lo.OutletSystemRef [AssetOutletSystemRef],
                lo.LegionellaLocationID,
                lo.Location [AssetOutletLocation],
                lo.LocationSortOrder,
                lo.OutletSortOrder [AssetOutletSortOrder],
                NULL [LegionellaAssetRiskRatingID],
                NULL [AssetRiskRating],
                NULL [AssetRiskColour],
                NULL [AssetRiskRatingSortOrder],
                lo.OutletCold,
                lo.OutletColdTriggered,
                lo.OutletHot,
                lo.OutletHotTriggered,
                lo.OutletMixed,
                lo.OutletMixedTriggered,
                lo.OutletMains,
                lo.OutletMainsTriggered,
                lo.OutletSentinelCold,
                lo.OutletSentinelHot,
                lo.OutletSentinelMixed,
                lo.OutletSentinelMains,
                lo.OutletFlushedCold,
                lo.OutletFlushedHot,
                lo.OutletFlushedMixed,
                lo.OutletFlushedMains,
                lo.OutletLowUseCold,
                lo.OutletLowUseHot,
                lo.OutletLowUseMixed,
                lo.OutletLowUseMains,
                lo.OutletSourceColdAssetID,
                lo.OutletSourceColdAssetSystemRef,
                lo.OutletSourceColdAssetLocation,
                lo.OutletSourceColdAssetCategory,
                lo.OutletSourceHotAssetID,
                lo.OutletSourceHotAssetSystemRef,
                lo.OutletSourceHotAssetLocation,
                lo.OutletSourceHotAssetCategory,
                lo.OutletSourceMixedAssetID,
                lo.OutletSourceMixedAssetSystemRef,
                lo.OutletSourceMixedAssetLocation,
                lo.OutletSourceMixedAssetCategory,
                lo.OutletSourceMainsAssetID,
                lo.OutletSourceMainsAssetSystemRef,
                lo.OutletSourceMainsAssetLocation,
                lo.OutletSourceMainsAssetCategory,
                lo.LegionellaOutletCategoryID [LegionellaAssetOutletCategoryID],
                lo.OutletCategory [AssetOutletCategory],
                lo.OutletCategorySortOrder [AssetOutletCategorySortOrder]
            FROM @LegionellaOutletData lo
            WHERE @IncludeOutlets = 1 OR @IncludeOutletTasks = 1
        ) lao
        LEFT JOIN Photo lp WITH (NOLOCK) ON lao.LegionellaPhotoID = lp.PhotoID AND lp.PhotoData IS NOT NULL
        LEFT JOIN Photo aop WITH (NOLOCK) ON lao.AssetOutletPhotoID = aop.PhotoID AND aop.PhotoData IS NOT NULL
        
    ORDER BY
        lao.LegionellaStart,
        lao.RowType,
        lao.LocationSortOrder,
        lao.AssetOutletSortOrder
    
    
    -- Get Task Photos as well if required.
    IF @IncludeSectionTasks = 1 OR @IncludeAssetTasks = 1 OR @IncludeLocationTasks = 1 OR @IncludeOutletTasks = 1
    BEGIN
        INSERT INTO @MainData (RowType, JobEmployeeID, LegionellaID, BuildingDesignation, LegionellaStart, LegionellaFinish, MonitoringSchedule, GeneralDescriptionOfSite, ScopeOfWork, AreasNotAccessed, LegionellaNotes, LegionellaPhotoID, LegionellaPhotoNo, LegionellaAssetOutletID, AssetOutletPhotoID, AssetOutletPhotoNo, AssetOutletSystemRef, LegionellaLocationID, AssetOutletLocation, LocationSortOrder, AssetOutletSortOrder, LegionellaAssetRiskRatingID, AssetRiskRating, AssetRiskColour, AssetRiskRatingSortOrder, OutletCold, OutletColdTriggered, OutletHot, OutletHotTriggered, OutletMixed, OutletMixedTriggered, OutletMains, OutletMainsTriggered, OutletSentinelCold, OutletSentinelHot, OutletSentinelMixed, OutletSentinelMains, OutletFlushedCold, OutletFlushedHot, OutletFlushedMixed, OutletFlushedMains, OutletLowUseCold, OutletLowUseHot, OutletLowUseMixed, OutletLowUseMains, OutletSourceColdAssetID, OutletSourceColdAssetSystemRef, OutletSourceColdAssetLocation, OutletSourceColdAssetCategory, OutletSourceHotAssetID, OutletSourceHotAssetSystemRef, OutletSourceHotAssetLocation, OutletSourceHotAssetCategory, OutletSourceMixedAssetID, OutletSourceMixedAssetSystemRef, OutletSourceMixedAssetLocation, OutletSourceMixedAssetCategory, OutletSourceMainsAssetID, OutletSourceMainsAssetSystemRef, OutletSourceMainsAssetLocation, OutletSourceMainsAssetCategory, LegionellaAssetOutletCategoryID, AssetOutletCategory, AssetOutletCategorySortOrder, LegionellaTaskID, LegionellaTaskNo, TaskRiskDescription, TaskAction, TaskSortOrder, LegionellaRiskCategoryID, RiskCategory, RiskCategorySortOrder, LegionellaFrequencyCategoryID, FrequencyCategory, FrequencyCategoryDateAddModifier, FrequencyCategoryDateAddValue, FrequencyCategoryDateCalc, FrequencyCategorySortOrder, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, LegionellaPriorityRatingID, PriorityRating, ShortPriorityRating, PriorityColour, PriorityRatingSortOrder, LegionellaTaskAutoInsertTypeID, TaskAutoInsertType, LegionellaTaskEventID, EventPerformedByEmployeeID, EventPerformedByPortalUserID, EventPerformedByThirdParty, EventPerformedBy, EventComments, EventRecorded, EventCreated, LegionellaAssetOutletQuestionID, QuestionSubTabTitle, QuestionGroupTitle, Question, EntryType, NullReplace, ReplaceVariable, LegionellaAssetOutletQuestionSortOrder, TaskPhotoID, TaskPhotoNo)
        SELECT
            m.RowType,
            m.JobEmployeeID,
            m.LegionellaID,
            m.BuildingDesignation,
            m.LegionellaStart,
            m.LegionellaFinish,
            m.MonitoringSchedule,
            m.GeneralDescriptionOfSite,
            m.ScopeOfWork,
            m.AreasNotAccessed,
            m.LegionellaNotes,
            m.LegionellaPhotoID,
            m.LegionellaPhotoNo,
            m.LegionellaAssetOutletID,
            m.AssetOutletPhotoID,
            m.AssetOutletPhotoNo,
            m.AssetOutletSystemRef,
            m.LegionellaLocationID,
            m.AssetOutletLocation,
            m.LocationSortOrder,
            m.AssetOutletSortOrder,
            m.LegionellaAssetRiskRatingID,
            m.AssetRiskRating,
            m.AssetRiskColour,
            m.AssetRiskRatingSortOrder,
            m.OutletCold,
            m.OutletColdTriggered,
            m.OutletHot,
            m.OutletHotTriggered,
            m.OutletMixed,
            m.OutletMixedTriggered,
            m.OutletMains,
            m.OutletMainsTriggered,
            m.OutletSentinelCold,
            m.OutletSentinelHot,
            m.OutletSentinelMixed,
            m.OutletSentinelMains,
            m.OutletFlushedCold,
            m.OutletFlushedHot,
            m.OutletFlushedMixed,
            m.OutletFlushedMains,
            m.OutletLowUseCold,
            m.OutletLowUseHot,
            m.OutletLowUseMixed,
            m.OutletLowUseMains,
            m.OutletSourceColdAssetID,
            m.OutletSourceColdAssetSystemRef,
            m.OutletSourceColdAssetLocation,
            m.OutletSourceColdAssetCategory,
            m.OutletSourceHotAssetID,
            m.OutletSourceHotAssetSystemRef,
            m.OutletSourceHotAssetLocation,
            m.OutletSourceHotAssetCategory,
            m.OutletSourceMixedAssetID,
            m.OutletSourceMixedAssetSystemRef,
            m.OutletSourceMixedAssetLocation,
            m.OutletSourceMixedAssetCategory,
            m.OutletSourceMainsAssetID,
            m.OutletSourceMainsAssetSystemRef,
            m.OutletSourceMainsAssetLocation,
            m.OutletSourceMainsAssetCategory,
            m.LegionellaAssetOutletCategoryID,
            m.AssetOutletCategory,
            m.AssetOutletCategorySortOrder,
            lt.LegionellaTaskID,
            lt.LegionellaTaskNo,
            lt.RiskDescription [TaskRiskDescription],
            lt.Action [TaskAction],
            lt.SortOrder [TaskSortOrder],
            lrc.LegionellaRiskCategoryID,
            lrc.Description [RiskCategory],
            lrc.SortOrder [RiskCategorySortOrder],
            lfc.LegionellaFrequencyCategoryID,
            lfc.Description [FrequencyCategory],
            lfc.DateAddModifier [FrequencyCategoryDateAddModifier],
            lfc.DateAddValue [FrequencyCategoryDateAddValue],
            dbo.fn_DateAddFromStringPart(lfc.DateAddModifier, lfc.DateAddValue, m.MonitoringSchedule) [FrequencyCategoryDateCalc],
            lfc.SortOrder [FrequencyCategorySortOrder],
            lrr.LegionellaRiskRatingID,
            lrr.Description [RiskRating],
            lrr.RiskColour,
            lrr.SortOrder [RiskRatingSortOrder],
            lpr.LegionellaPriorityRatingID,
            lpr.Description [PriorityRating],
            lpr.ShortDescription [ShortPriorityRating],
            lpr.PriorityColour,
            lpr.SortOrder [PriorityRatingSortOrder],
            ltait.LegionellaTaskAutoInsertTypeID,
            ltait.Description [TaskAutoInsertType],
            lte.LegionellaTaskEventID,
            lte.PerformedByEmployeeID [EventPerformedByEmployeeID],
            lte.PerformedByPortalUserID [EventPerformedByPortalUserID],
            lte.PerformedByThirdParty [EventPerformedByThirdParty],
            COALESCE(e.FullName, pu.FullName, lte.PerformedByThirdParty) [EventPerformedBy],
            lte.Comments [EventComments],
            lte.Recorded [EventRecorded],
            lte.Created [EventCreated],
            laoq.LegionellaAssetOutletQuestionID,
            laoq.QuestionSubTabTitle,
            laoq.QuestionGroupTitle,
            laoq.Question,
            laoq.EntryType,
            laoq.NullReplace,
            laoq.ReplaceVariable,
            laoq.LegionellaAssetOutletQuestionSortOrder,
            tp.PhotoID [TaskPhotoID],
            tp.PhotoNo [TaskPhotoNo]
            
        FROM
            (
                SELECT * FROM @MainData
                WHERE @IncludeSectionTasks = 1 AND RowType = 1
                
                UNION ALL
                
                SELECT * FROM @MainData
                WHERE @IncludeAssetTasks = 1 AND RowType = 2
                
                UNION ALL
                
                SELECT * FROM @MainData
                WHERE @IncludeLocationTasks = 1 AND RowType = 3
                
                UNION ALL
                
                SELECT * FROM @MainData
                WHERE @IncludeOutletTasks = 1 AND RowType = 4
            ) m
            INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
                CASE m.RowType -- Join based on the main UNION
                    WHEN 1 THEN m.LegionellaID
                    WHEN 3 THEN m.LegionellaLocationID
                    ELSE m.LegionellaAssetOutletID
                END =
                CASE m.RowType -- Join based on this live table
                    WHEN 1 THEN lt.LegionellaID
                    WHEN 2 THEN lt.LegionellaAssetID
                    WHEN 3 THEN lt.LegionellaLocationID
                    WHEN 4 THEN lt.LegionellaOutletID
                END
            LEFT JOIN LegionellaRiskCategory lrc WITH (NOLOCK) ON lt.LegionellaRiskCategoryID = lrc.LegionellaRiskCategoryID
            LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
            LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
            LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
            LEFT JOIN LegionellaTaskAutoInsertType ltait WITH (NOLOCK) ON lt.LegionellaTaskAutoInsertTypeID = ltait.LegionellaTaskAutoInsertTypeID
            OUTER APPLY
            (
                SELECT TOP 1
                    lte.LegionellaTaskEventID,
                    lte.PerformedByEmployeeID,
                    lte.PerformedByPortalUserID,
                    lte.PerformedByThirdParty,
                    lte.Comments,
                    lte.Recorded,
                    lte.Created
                FROM
                    LegionellaTaskEvent lte WITH (NOLOCK)
                WHERE
                    lte.LegionellaTaskID = lt.LegionellaTaskID
                        AND
                    lte.Deleted IS NULL
                ORDER BY
                    lte.Created
            ) lte -- Legionella Task Event
            LEFT JOIN Employee e WITH (NOLOCK) ON lte.PerformedByEmployeeID = e.EmployeeID
            LEFT JOIN PortalUser pu WITH (NOLOCK) ON lte.PerformedByPortalUserID = pu.PortalUserID
            OUTER APPLY
            (
                SELECT TOP 1
                    laoq.LegionellaAssetOutletQuestionID,
                    laoq.SubTabTitle [QuestionSubTabTitle],
                    laoq.GroupTitle [QuestionGroupTitle],
                    dbo.HtmlEncode(laoq.Description) [Question],
                    laoq.EntryType,
                    laoq.NullReplace,
                    laoq.ReplaceVariable,
                    laoq.SortOrder [LegionellaAssetOutletQuestionSortOrder]
                FROM
                    LegionellaAssetOutletTaskQuestionTrigger laotqt WITH (NOLOCK)
                    INNER JOIN LegionellaAssetOutletQuestion laoq WITH (NOLOCK) ON laotqt.LegionellaAssetOutletQuestionID = laoq.LegionellaAssetOutletQuestionID
                WHERE
                    laotqt.LegionellaTaskAutoInsertID = lt.LegionellaTaskAutoInsertID
            ) laoq -- Legionella Asset Outlet Question (get question info that triggered the risks being displayed)
            INNER JOIN LegionellaTaskPhoto ltp WITH (NOLOCK) ON lt.LegionellaTaskID = ltp.LegionellaTaskID
            LEFT JOIN Photo tp WITH (NOLOCK) ON ltp.PhotoID = tp.PhotoID AND tp.PhotoData IS NOT NULL
            
        WHERE
            lt.Deleted IS NULL
                AND
            (lt.LegionellaTaskID = @LegionellaTaskID OR @LegionellaTaskID = 0)
                AND
            (
                m.RowType <> 1
                    OR
                (
                    m.RowType = 1 -- If something from the Legionella record and a Task, decide whether to show or hide the Task.
                        AND
                    (
                        (lt.LegionellaSectionID = @LegionellaSectionID)
                            OR
                        (@LegionellaSectionID = 0)
                            OR
                        (@LegionellaSectionID = -1 AND lt.LegionellaSectionID IS NOT NULL)
                    )
                )
            )
            
        ORDER BY
            m.LegionellaStart,
            m.RowType,
            m.LocationSortOrder,
            m.AssetOutletSortOrder,
            lt.SortOrder,
            tp.PhotoID
        
    END
    
    
    -- Start the main SELECT
    SELECT
        -- Main data from the table variables
        -- NOTE: When adjusting this ROW_NUMBER(), also adjust the main ORDER BY to match.
        ROW_NUMBER() OVER (ORDER BY uifo.UnionIDForOrdering, m.LegionellaStart, m.LocationSortOrder, m.AssetOutletSortOrder, ISNULL(m.TaskSortOrder, -1), m.PhotoID) [RowID],
        m.RowType,
        m.UnionID,
        uifo.UnionIDForOrdering,
        m.BuildingDesignation,
        dbo.FormatDateCustom(m.LegionellaStart, @CustomDateFormat) [LegionellaStart],
        dbo.FormatDateCustom(m.LegionellaFinish, @CustomDateFormat) [LegionellaFinish],
        dbo.FormatDateCustom(m.MonitoringSchedule, @CustomDateFormat) [MonitoringSchedule],
        m.GeneralDescriptionOfSite,
        m.ScopeOfWork,
        m.AreasNotAccessed,
        m.LegionellaNotes,
        m.LegionellaAssetOutletID,
        m.AssetOutletSystemRef,
        m.AssetOutletLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 3 THEN ISNULL(m.AssetOutletLocation, '')
            ELSE ISNULL(NULLIF(m.AssetOutletSystemRef, '') + ', ', '') + ISNULL(m.AssetOutletLocation, '')
        END [SiteOrAssetOutletDetails],
        m.AssetRiskRating,
        m.AssetRiskColour,
        m.AssetRiskRatingSortOrder,
        m.AssetRiskRatingSortOrder - 1 [AssetRiskRatingNo],
        m.OutletCold,
        m.OutletHot,
        m.OutletMixed,
        m.OutletMains,
        m.OutletSentinelCold,
        m.OutletSentinelHot,
        m.OutletSentinelMixed,
        m.OutletSentinelMains,
        m.OutletFlushedCold,
        m.OutletFlushedHot,
        m.OutletFlushedMixed,
        m.OutletFlushedMains,
        m.OutletLowUseCold,
        m.OutletLowUseHot,
        m.OutletLowUseMixed,
        m.OutletLowUseMains,
        m.OutletSourceColdAssetSystemRef,
        m.OutletSourceColdAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceColdAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceColdAssetLocation, '')
        END [OutletSourceColdAssetDetails],
        m.OutletSourceColdAssetCategory,
        m.OutletSourceHotAssetSystemRef,
        m.OutletSourceHotAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceHotAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceHotAssetLocation, '')
        END [OutletSourceHotAssetDetails],
        m.OutletSourceHotAssetCategory,
        m.OutletSourceMixedAssetSystemRef,
        m.OutletSourceMixedAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMixedAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMixedAssetLocation, '')
        END [OutletSourceMixedAssetDetails],
        m.OutletSourceMixedAssetCategory,
        m.OutletSourceMainsAssetSystemRef,
        m.OutletSourceMainsAssetLocation,
        CASE m.RowType
            WHEN 1 THEN 'Site'
            WHEN 2 THEN 'Asset'
            WHEN 3 THEN 'Location'
            ELSE ISNULL(NULLIF(m.OutletSourceMainsAssetSystemRef, '') + ', ', '') + ISNULL(m.OutletSourceMainsAssetLocation, '')
        END [OutletSourceMainsAssetDetails],
        m.OutletSourceMainsAssetCategory,
        m.AssetOutletCategory,
        m.LegionellaTaskID,
        m.LegionellaTaskNo,
        dbo.HtmlEncode(m.TaskRiskDescription) [TaskRiskDescription],
        dbo.HtmlEncode(m.TaskAction) [TaskAction],
        m.RiskCategory,
        m.RiskCategorySortOrder,
        m.RiskCategorySortOrder - 1 [RiskCategoryNo],
        m.FrequencyCategory,
        dbo.FormatDateCustom(m.FrequencyCategoryDateCalc, @CustomDateFormat) [FrequencyCategoryDateCalc],
        m.RiskRating,
        m.RiskColour,
        m.RiskRatingSortOrder - 1 [RiskRatingNo],
        m.PriorityRating,
        m.ShortPriorityRating,
        m.PriorityColour,
        m.PriorityRatingSortOrder - 1 [PriorityRatingNo],
        m.TaskAutoInsertType,
        m.EventPerformedBy,
        m.EventComments,
        dbo.FormatDateCustom(m.EventRecorded, @CustomDateFormat) [EventRecorded],
        dbo.FormatDateCustom(m.EventCreated, @CustomDateFormat) [EventCreated],
        m.LegionellaAssetOutletQuestionID,
        m.QuestionSubTabTitle,
        m.QuestionGroupTitle,
        m.Question,
        ISNULL('<img src="[HOSTNAME]/images/getphoto.asp?id=' + CAST(m.PhotoID AS VARCHAR(100)) + '&[RND]" />', 'No Photographic Evidence Available') [Photo],
        m.PhotoNo,
        
        -- Display/hide variables
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayBuildingDesignation],
        CASE WHEN NULLIF(m.BuildingDesignation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayBuildingDesignation],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayMonitoringSchedule],
        CASE WHEN m.MonitoringSchedule IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayMonitoringSchedule],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.GeneralDescriptionOfSite, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayGeneralDescriptionOfSite],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayScopeOfWork],
        CASE WHEN NULLIF(m.ScopeOfWork, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayScopeOfWork],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.AreasNotAccessed, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAreasNotAccessed],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaNotes],
        CASE WHEN NULLIF(m.LegionellaNotes, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayLegionellaNotes],
        --NULL [DisplayLegionella],
        --NULL [DisplayLegionellaEnd],
        --NULL [DisplayNewAssetOrOutletTitle],
        CASE WHEN m.RowType = 1 THEN 'display: inherit' ELSE 'display: none' END [DisplayLegionellaData],
        CASE WHEN m.RowType = 2 THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetData],
        CASE WHEN m.RowType = 3 THEN 'display: inherit' ELSE 'display: none' END [DisplayLocationData],
        CASE WHEN m.RowType = 4 THEN 'display: inherit' ELSE 'display: none' END [DisplayOutletData],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletSystemRef, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletSystemRef],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletLocation],
        CASE WHEN NULLIF(m.AssetOutletLocation, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletLocation],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.LegionellaAssetRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END ELSE '#000000' END [TextColourAssetRiskRating],
        CASE WHEN m.RowType = 2 THEN CASE WHEN m.AssetRiskColour IS NOT NULL THEN m.AssetRiskColour ELSE '#FFFFFF' END ELSE '#FFFFFF' END [AssetRiskColourOrDefault],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletCold IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletColdTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletColdTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHot IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletHotTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletHotTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixed IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMixedTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMixedTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMains IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletMainsTriggered = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletMainsTriggered],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains > 0 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsNear],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelCold = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelColdFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelHot = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelHotFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMixed = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMixedFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSentinelMains = 2 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSentinelMainsFar],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletFlushedMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletFlushedMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseCold = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseHot = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMixed = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletLowUseMains = 1 THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletLowUseMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceColdAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceCold],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceHotAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceHot],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMixedAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMixed],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END ELSE 'display: none' END [DisplayOutletSourceMains],
        CASE WHEN m.RowType = 4 THEN CASE WHEN m.OutletSourceMainsAssetID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END ELSE 'display: none' END [InvertDisplayOutletSourceMains],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayAssetOutletCategory],
        CASE WHEN m.LegionellaAssetOutletCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayAssetOutletCategory],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskCategory],
        CASE WHEN m.LegionellaRiskCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategory],
        CASE WHEN m.LegionellaFrequencyCategoryID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategory],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayFrequencyCategoryDateCalc],
        CASE WHEN m.FrequencyCategoryDateCalc IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayFrequencyCategoryDateCalc],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayRiskRating],
        CASE WHEN m.LegionellaRiskRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourRiskRating],
        CASE WHEN m.RiskColour IS NOT NULL THEN m.RiskColour ELSE '#FFFFFF' END [RiskColourOrDefault],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayPriorityRating],
        CASE WHEN m.LegionellaPriorityRatingID IN (4, 5) THEN '#FFFFFF' ELSE '#000000' END [TextColourPriorityRating],
        CASE WHEN m.PriorityColour IS NOT NULL THEN m.PriorityColour ELSE '#FFFFFF' END [PriorityColourOrDefault],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayTaskAutoInsertType],
        CASE WHEN m.TaskAutoInsertType IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayTaskAutoInsertType],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventPerformedBy, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventPerformedBy],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayEventComments],
        CASE WHEN NULLIF(m.EventComments, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEventComments],
        CASE WHEN m.EntryType = 'Title' THEN 'display: inherit' ELSE 'display: none' END [DisplayEntryTypeTitle],
        CASE WHEN m.EntryType = 'Title' THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayEntryTypeTitle],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '2' ELSE '1' END [ColspanQuestionComments],
        CASE WHEN m.Question IN ('Additional Information', 'Comments') THEN '1' ELSE '2' END [InvertColspanQuestionComments],
        --NULL [DisplayQuestionSubTabTitleStart],
        --NULL [DisplayQuestionSubTabTitleFinish],
        --NULL [DisplayQuestionGroupTitleStart],
        --NULL [DisplayQuestionGroupTitleFinish],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionSubTabTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionSubTabTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayQuestionGroupTitle],
        CASE WHEN NULLIF(m.QuestionGroupTitle, '') IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayQuestionGroupTitle],
        
        -- Display/hide variables that are more specific to this SPROC and take into account different parameters
        CASE WHEN m.UnionID IN (2, 4, 5, 7) THEN 'display: inherit' ELSE 'display: none' END [DisplayTasks],
        CASE WHEN m.UnionID IN (2, 4, 5, 7) THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayTasks],
        CASE WHEN m.PhotoID IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayPhoto],
        CASE WHEN m.PhotoID IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayPhoto],
        CASE WHEN m.PhotoNo IS NOT NULL THEN 'display: inherit' ELSE 'display: none' END [DisplayPhotoNo],
        CASE WHEN m.PhotoNo IS NOT NULL THEN 'display: none' ELSE 'display: inherit' END [InvertDisplayPhotoNo]
        
    FROM
        (
            -- NOTE: Even though DISTINCT is not specified, it should remove duplicate rows by all the UNIONS and by the way that the PhotoID changes per UNION.
            
            -- Legionella Photos
            SELECT
                1 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                NULL [LegionellaTaskID],
                NULL [LegionellaTaskNo],
                NULL [TaskRiskDescription],
                NULL [TaskAction],
                NULL [TaskSortOrder],
                NULL [LegionellaRiskCategoryID],
                NULL [RiskCategory],
                NULL [RiskCategorySortOrder],
                NULL [LegionellaFrequencyCategoryID],
                NULL [FrequencyCategory],
                NULL [FrequencyCategoryDateAddModifier],
                NULL [FrequencyCategoryDateAddValue],
                NULL [FrequencyCategoryDateCalc],
                NULL [FrequencyCategorySortOrder],
                NULL [LegionellaRiskRatingID],
                NULL [RiskRating],
                NULL [RiskColour],
                NULL [RiskRatingSortOrder],
                NULL [LegionellaPriorityRatingID],
                NULL [PriorityRating],
                NULL [ShortPriorityRating],
                NULL [PriorityColour],
                NULL [PriorityRatingSortOrder],
                NULL [LegionellaTaskAutoInsertTypeID],
                NULL [TaskAutoInsertType],
                NULL [LegionellaTaskEventID],
                NULL [EventPerformedByEmployeeID],
                NULL [EventPerformedByPortalUserID],
                NULL [EventPerformedByThirdParty],
                NULL [EventPerformedBy],
                NULL [EventComments],
                NULL [EventRecorded],
                NULL [EventCreated],
                NULL [LegionellaAssetOutletQuestionID],
                NULL [QuestionSubTabTitle],
                NULL [QuestionGroupTitle],
                NULL [Question],
                NULL [EntryType],
                NULL [NullReplace],
                NULL [ReplaceVariable],
                NULL [LegionellaAssetOutletQuestionSortOrder],
                m.LegionellaPhotoID [PhotoID],
                m.LegionellaPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeLegionella = 1
                    AND
                m.RowType = 1
            
            UNION
            
            -- Legionella Section Task Photos
            SELECT
                2 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                m.LegionellaTaskID,
                m.LegionellaTaskNo,
                m.TaskRiskDescription,
                m.TaskAction,
                m.TaskSortOrder,
                m.LegionellaRiskCategoryID,
                m.RiskCategory,
                m.RiskCategorySortOrder,
                m.LegionellaFrequencyCategoryID,
                m.FrequencyCategory,
                m.FrequencyCategoryDateAddModifier,
                m.FrequencyCategoryDateAddValue,
                m.FrequencyCategoryDateCalc,
                m.FrequencyCategorySortOrder,
                m.LegionellaRiskRatingID,
                m.RiskRating,
                m.RiskColour,
                m.RiskRatingSortOrder,
                m.LegionellaPriorityRatingID,
                m.PriorityRating,
                m.ShortPriorityRating,
                m.PriorityColour,
                m.PriorityRatingSortOrder,
                m.LegionellaTaskAutoInsertTypeID,
                m.TaskAutoInsertType,
                m.LegionellaTaskEventID,
                m.EventPerformedByEmployeeID,
                m.EventPerformedByPortalUserID,
                m.EventPerformedByThirdParty,
                m.EventPerformedBy,
                m.EventComments,
                m.EventRecorded,
                m.EventCreated,
                m.LegionellaAssetOutletQuestionID,
                m.QuestionSubTabTitle,
                m.QuestionGroupTitle,
                m.Question,
                m.EntryType,
                m.NullReplace,
                m.ReplaceVariable,
                m.LegionellaAssetOutletQuestionSortOrder,
                m.TaskPhotoID [PhotoID],
                m.TaskPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeSectionTasks = 1
                    AND
                m.RowType = 1
                    AND
                m.LegionellaTaskID IS NOT NULL
            
            UNION
            
            -- Asset Photos
            SELECT
                3 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                NULL [LegionellaTaskID],
                NULL [LegionellaTaskNo],
                NULL [TaskRiskDescription],
                NULL [TaskAction],
                NULL [TaskSortOrder],
                NULL [LegionellaRiskCategoryID],
                NULL [RiskCategory],
                NULL [RiskCategorySortOrder],
                NULL [LegionellaFrequencyCategoryID],
                NULL [FrequencyCategory],
                NULL [FrequencyCategoryDateAddModifier],
                NULL [FrequencyCategoryDateAddValue],
                NULL [FrequencyCategoryDateCalc],
                NULL [FrequencyCategorySortOrder],
                NULL [LegionellaRiskRatingID],
                NULL [RiskRating],
                NULL [RiskColour],
                NULL [RiskRatingSortOrder],
                NULL [LegionellaPriorityRatingID],
                NULL [PriorityRating],
                NULL [ShortPriorityRating],
                NULL [PriorityColour],
                NULL [PriorityRatingSortOrder],
                NULL [LegionellaTaskAutoInsertTypeID],
                NULL [TaskAutoInsertType],
                NULL [LegionellaTaskEventID],
                NULL [EventPerformedByEmployeeID],
                NULL [EventPerformedByPortalUserID],
                NULL [EventPerformedByThirdParty],
                NULL [EventPerformedBy],
                NULL [EventComments],
                NULL [EventRecorded],
                NULL [EventCreated],
                NULL [LegionellaAssetOutletQuestionID],
                NULL [QuestionSubTabTitle],
                NULL [QuestionGroupTitle],
                NULL [Question],
                NULL [EntryType],
                NULL [NullReplace],
                NULL [ReplaceVariable],
                NULL [LegionellaAssetOutletQuestionSortOrder],
                m.AssetOutletPhotoID [PhotoID],
                m.AssetOutletPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeAssets = 1
                    AND
                m.RowType = 2
            
            UNION
            
            -- Asset Task Photos
            SELECT
                4 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                m.LegionellaTaskID,
                m.LegionellaTaskNo,
                m.TaskRiskDescription,
                m.TaskAction,
                m.TaskSortOrder,
                m.LegionellaRiskCategoryID,
                m.RiskCategory,
                m.RiskCategorySortOrder,
                m.LegionellaFrequencyCategoryID,
                m.FrequencyCategory,
                m.FrequencyCategoryDateAddModifier,
                m.FrequencyCategoryDateAddValue,
                m.FrequencyCategoryDateCalc,
                m.FrequencyCategorySortOrder,
                m.LegionellaRiskRatingID,
                m.RiskRating,
                m.RiskColour,
                m.RiskRatingSortOrder,
                m.LegionellaPriorityRatingID,
                m.PriorityRating,
                m.ShortPriorityRating,
                m.PriorityColour,
                m.PriorityRatingSortOrder,
                m.LegionellaTaskAutoInsertTypeID,
                m.TaskAutoInsertType,
                m.LegionellaTaskEventID,
                m.EventPerformedByEmployeeID,
                m.EventPerformedByPortalUserID,
                m.EventPerformedByThirdParty,
                m.EventPerformedBy,
                m.EventComments,
                m.EventRecorded,
                m.EventCreated,
                m.LegionellaAssetOutletQuestionID,
                m.QuestionSubTabTitle,
                m.QuestionGroupTitle,
                m.Question,
                m.EntryType,
                m.NullReplace,
                m.ReplaceVariable,
                m.LegionellaAssetOutletQuestionSortOrder,
                m.TaskPhotoID [PhotoID],
                m.TaskPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeAssetTasks = 1
                    AND
                m.RowType = 2
                    AND
                m.LegionellaTaskID IS NOT NULL
            
            UNION
            
            -- Legionella Location Task Photos
            SELECT
                5 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                m.LegionellaTaskID,
                m.LegionellaTaskNo,
                m.TaskRiskDescription,
                m.TaskAction,
                m.TaskSortOrder,
                m.LegionellaRiskCategoryID,
                m.RiskCategory,
                m.RiskCategorySortOrder,
                m.LegionellaFrequencyCategoryID,
                m.FrequencyCategory,
                m.FrequencyCategoryDateAddModifier,
                m.FrequencyCategoryDateAddValue,
                m.FrequencyCategoryDateCalc,
                m.FrequencyCategorySortOrder,
                m.LegionellaRiskRatingID,
                m.RiskRating,
                m.RiskColour,
                m.RiskRatingSortOrder,
                m.LegionellaPriorityRatingID,
                m.PriorityRating,
                m.ShortPriorityRating,
                m.PriorityColour,
                m.PriorityRatingSortOrder,
                m.LegionellaTaskAutoInsertTypeID,
                m.TaskAutoInsertType,
                m.LegionellaTaskEventID,
                m.EventPerformedByEmployeeID,
                m.EventPerformedByPortalUserID,
                m.EventPerformedByThirdParty,
                m.EventPerformedBy,
                m.EventComments,
                m.EventRecorded,
                m.EventCreated,
                m.LegionellaAssetOutletQuestionID,
                m.QuestionSubTabTitle,
                m.QuestionGroupTitle,
                m.Question,
                m.EntryType,
                m.NullReplace,
                m.ReplaceVariable,
                m.LegionellaAssetOutletQuestionSortOrder,
                m.TaskPhotoID [PhotoID],
                m.TaskPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeLocationTasks = 1
                    AND
                m.RowType = 3
                    AND
                m.LegionellaTaskID IS NOT NULL
            
            UNION
            
            -- Outlet Photos
            SELECT
                6 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                NULL [LegionellaTaskID],
                NULL [LegionellaTaskNo],
                NULL [TaskRiskDescription],
                NULL [TaskAction],
                NULL [TaskSortOrder],
                NULL [LegionellaRiskCategoryID],
                NULL [RiskCategory],
                NULL [RiskCategorySortOrder],
                NULL [LegionellaFrequencyCategoryID],
                NULL [FrequencyCategory],
                NULL [FrequencyCategoryDateAddModifier],
                NULL [FrequencyCategoryDateAddValue],
                NULL [FrequencyCategoryDateCalc],
                NULL [FrequencyCategorySortOrder],
                NULL [LegionellaRiskRatingID],
                NULL [RiskRating],
                NULL [RiskColour],
                NULL [RiskRatingSortOrder],
                NULL [LegionellaPriorityRatingID],
                NULL [PriorityRating],
                NULL [ShortPriorityRating],
                NULL [PriorityColour],
                NULL [PriorityRatingSortOrder],
                NULL [LegionellaTaskAutoInsertTypeID],
                NULL [TaskAutoInsertType],
                NULL [LegionellaTaskEventID],
                NULL [EventPerformedByEmployeeID],
                NULL [EventPerformedByPortalUserID],
                NULL [EventPerformedByThirdParty],
                NULL [EventPerformedBy],
                NULL [EventComments],
                NULL [EventRecorded],
                NULL [EventCreated],
                NULL [LegionellaAssetOutletQuestionID],
                NULL [QuestionSubTabTitle],
                NULL [QuestionGroupTitle],
                NULL [Question],
                NULL [EntryType],
                NULL [NullReplace],
                NULL [ReplaceVariable],
                NULL [LegionellaAssetOutletQuestionSortOrder],
                m.AssetOutletPhotoID [PhotoID],
                m.AssetOutletPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeOutlets = 1
                    AND
                m.RowType = 4
            
            UNION
            
            -- Outlet Task Photos
            SELECT
                7 [UnionID],
                m.RowType,
                m.LegionellaID,
                m.BuildingDesignation,
                m.LegionellaStart,
                m.LegionellaFinish,
                m.MonitoringSchedule,
                m.GeneralDescriptionOfSite,
                m.ScopeOfWork,
                m.AreasNotAccessed,
                m.LegionellaNotes,
                m.LegionellaAssetOutletID,
                m.AssetOutletSystemRef,
                m.LegionellaLocationID,
                m.AssetOutletLocation,
                m.LocationSortOrder,
                m.AssetOutletSortOrder,
                m.LegionellaAssetRiskRatingID,
                m.AssetRiskRating,
                m.AssetRiskColour,
                m.AssetRiskRatingSortOrder,
                m.OutletCold,
                m.OutletColdTriggered,
                m.OutletHot,
                m.OutletHotTriggered,
                m.OutletMixed,
                m.OutletMixedTriggered,
                m.OutletMains,
                m.OutletMainsTriggered,
                m.OutletSentinelCold,
                m.OutletSentinelHot,
                m.OutletSentinelMixed,
                m.OutletSentinelMains,
                m.OutletFlushedCold,
                m.OutletFlushedHot,
                m.OutletFlushedMixed,
                m.OutletFlushedMains,
                m.OutletLowUseCold,
                m.OutletLowUseHot,
                m.OutletLowUseMixed,
                m.OutletLowUseMains,
                m.OutletSourceColdAssetID,
                m.OutletSourceColdAssetSystemRef,
                m.OutletSourceColdAssetLocation,
                m.OutletSourceColdAssetCategory,
                m.OutletSourceHotAssetID,
                m.OutletSourceHotAssetSystemRef,
                m.OutletSourceHotAssetLocation,
                m.OutletSourceHotAssetCategory,
                m.OutletSourceMixedAssetID,
                m.OutletSourceMixedAssetSystemRef,
                m.OutletSourceMixedAssetLocation,
                m.OutletSourceMixedAssetCategory,
                m.OutletSourceMainsAssetID,
                m.OutletSourceMainsAssetSystemRef,
                m.OutletSourceMainsAssetLocation,
                m.OutletSourceMainsAssetCategory,
                m.LegionellaAssetOutletCategoryID,
                m.AssetOutletCategory,
                m.LegionellaTaskID,
                m.LegionellaTaskNo,
                m.TaskRiskDescription,
                m.TaskAction,
                m.TaskSortOrder,
                m.LegionellaRiskCategoryID,
                m.RiskCategory,
                m.RiskCategorySortOrder,
                m.LegionellaFrequencyCategoryID,
                m.FrequencyCategory,
                m.FrequencyCategoryDateAddModifier,
                m.FrequencyCategoryDateAddValue,
                m.FrequencyCategoryDateCalc,
                m.FrequencyCategorySortOrder,
                m.LegionellaRiskRatingID,
                m.RiskRating,
                m.RiskColour,
                m.RiskRatingSortOrder,
                m.LegionellaPriorityRatingID,
                m.PriorityRating,
                m.ShortPriorityRating,
                m.PriorityColour,
                m.PriorityRatingSortOrder,
                m.LegionellaTaskAutoInsertTypeID,
                m.TaskAutoInsertType,
                m.LegionellaTaskEventID,
                m.EventPerformedByEmployeeID,
                m.EventPerformedByPortalUserID,
                m.EventPerformedByThirdParty,
                m.EventPerformedBy,
                m.EventComments,
                m.EventRecorded,
                m.EventCreated,
                m.LegionellaAssetOutletQuestionID,
                m.QuestionSubTabTitle,
                m.QuestionGroupTitle,
                m.Question,
                m.EntryType,
                m.NullReplace,
                m.ReplaceVariable,
                m.LegionellaAssetOutletQuestionSortOrder,
                m.TaskPhotoID [PhotoID],
                m.TaskPhotoNo [PhotoNo]
            FROM
                @MainData m
            WHERE
                @IncludeOutletTasks = 1
                    AND
                m.RowType = 4
                    AND
                m.LegionellaTaskID IS NOT NULL
        ) m
        OUTER APPLY
        (
            SELECT
                CASE
                    WHEN m.UnionID IN (3, 4) THEN 3 -- Combine Asset and Asset Task Photos
                    WHEN m.UnionID IN (6, 7) THEN 6 -- Combine Outlet and Outlet Task Photos
                    ELSE m.UnionID
                END [UnionIDForOrdering]
        ) uifo -- Union ID For Ordering
    WHERE
        (
            @IncludeNullPhotos = 1 -- Include records without photos.
                OR
            (
                @IncludeNullPhotos = 0 -- Exclude records without photos.
                    AND
                m.PhotoID IS NOT NULL
            )
        )
        
    ORDER BY -- NOTE: When adjusting this ORDER BY, also adjust the ROW_NUMBER() above to match.
        uifo.UnionIDForOrdering,
        m.LegionellaStart,
        m.LocationSortOrder,
        m.AssetOutletSortOrder,
        ISNULL(m.TaskSortOrder, -1),
        m.PhotoID
    
    
    SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'LegionellaMonitoringData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[LegionellaMonitoringData] AS BEGIN SET NOCOUNT ON; END')
End

GO

ALTER PROC [dbo].[LegionellaMonitoringData]
(
      @JobID INT
)
AS
BEGIN
  SET NOCOUNT ON;
  
    DECLARE @SiteID INT = (Select SiteID FROM Job Where JobID=@JobID)
      DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobID)
      --Get @LegionellaTypeID
      --Select * FROM LegionellaType
      DECLARE @RestrictedLegionellaAssetCategoryID INT = (SELECT ISNULL((SELECT TOP 1 lt.LegionellaAssetCategoryID FROM Job j WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID=a.AppointmentID INNER JOIN LegionellaType lt WITH (NOLOCK) ON al.LegionellaTypeID=lt.LegionellaTypeID WHERE j.JobID = @JobID),0))

      --SELECT lt.* FROM Job j WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID=a.AppointmentID INNER JOIN LegionellaType lt WITH (NOLOCK) ON al.LegionellaTypeID=lt.LegionellaTypeID WHERE j.JobID = @JobID

      DECLARE @LegionellaGUIDED TABLE
            (
                  LegionellaID INT, LegionellaGUID VARCHAR(MAX), LegionellaGUIDVersion INT, LegionellaIdentifier INT,
                  LegionellaAssetCategoryID INT,LegionellaAssetID INT, LegionellaAssetGUID VARCHAR(MAX), LegionellaAssetGUIDVersion INT, LegionellaAssetIdentifier INT,
                  LegionellaLocationID INT, LegionellaLocationGUID VARCHAR(MAX), LegionellaLocationGUIDVersion INT, LegionellaLocationIdentifier INT,
                  LegionellaOutletID INT, LegionellaOutletGUID VARCHAR(MAX), LegionellaOutletGUIDVersion INT, LegionellaOutletIdentifier INT
            )
      INSERT INTO @LegionellaGUIDED (LegionellaID, LegionellaGUID, LegionellaGUIDVersion, LegionellaIdentifier, LegionellaAssetCategoryID, LegionellaAssetID, LegionellaAssetGUID, LegionellaAssetGUIDVersion, LegionellaAssetIdentifier, LegionellaLocationID, LegionellaLocationGUID, LegionellaLocationGUIDVersion, LegionellaLocationIdentifier, LegionellaOutletID, LegionellaOutletGUID, LegionellaOutletGUIDVersion, LegionellaOutletIdentifier)
      Select 
            l.LegionellaID,l.GUID [LegionellaGUID],l.GUIDVersion [LegionellaGUIDVersion], ROW_NUMBER() OVER (PARTITION BY l.GUID ORDER BY l.GUIDVersion DESC) [LegionellaIdentifier], 
            la.LegionellaAssetCategoryID, la.LegionellaAssetID, la.GUID [LegionellaAssetGUID], la.GUIDVersion [LegionellaAssetGUIDVersion], ROW_NUMBER() OVER (PARTITION BY la.GUID ORDER BY la.GUIDVersion DESC) [LegionellaAssetIdentifier], 
            ll.LegionellaLocationID, ll.GUID [LegionellaLocationGUID], ll.GUIDVersion [LegionellaLocationGUIDVersion], ROW_NUMBER() OVER (PARTITION BY ll.GUID ORDER BY ll.GUIDVersion DESC) [LegionellaIdentifier], 
            lo.LegionellaOutletID, lo.GUID [LegionellaOutletGUID], lo.GUIDVersion [LegionellaOutletGUIDVersion], ROW_NUMBER() OVER (PARTITION BY lo.GUID ORDER BY lo.GUIDVersion DESC) [LegionellaIdentifier]
      FROM
            Job j WITH (NOLOCK)
          
            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
            INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL
          
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
            INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
          
            LEFT OUTER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            LEFT OUTER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
            LEFT OUTER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
          
      Where
            j.ClientID=@ClientID AND j.SiteID=@SiteID AND j.Approved IS NOT NULL

      DECLARE @Legionella_Data TABLE (LegionellaID INT, LegionellaGUID VARCHAR(MAX), LegionellaGUIDVersion INT)
      Insert into @Legionella_Data (LegionellaID,LegionellaGUID,LegionellaGUIDVersion) Select LegionellaID,LegionellaGUID,LegionellaGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaIdentifier=1
      DECLARE @LegionellaAsset_Data TABLE (LegionellaGUID VARCHAR(MAX), LegionellaAssetID INT, LegionellaAssetGUID VARCHAR(MAX), LegionellaAssetGUIDVersion INT)
      Insert into @LegionellaAsset_data (LegionellaGUID,LegionellaAssetID,LegionellaAssetGUID,LegionellaAssetGUIDVersion) Select lguid.LegionellaGUID,lguid.LegionellaAssetID,lguid.LegionellaAssetGUID,lguid.LegionellaAssetGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaAssetIdentifier=1 AND (@RestrictedLegionellaAssetCategoryID = 0 OR lguid.LegionellaAssetCategoryID = @RestrictedLegionellaAssetCategoryID)
      DECLARE @LegionellaLocation_Data TABLE (LegionellaGUID VARCHAR(MAX), LegionellaLocationID INT, LegionellaLocationGUID VARCHAR(MAX), LegionellaLocationGUIDVersion INT)
      Insert into @LegionellaLocation_Data (LegionellaGUID,LegionellaLocationID,LegionellaLocationGUID,LegionellaLocationGUIDVersion) Select lguid.LegionellaGUID,lguid.LegionellaLocationID,lguid.LegionellaLocationGUID,lguid.LegionellaLocationGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaLocationIdentifier=1 AND @RestrictedLegionellaAssetCategoryID = 0
      DECLARE @LegionellaOutlet_Data TABLE (LegionellaLocationGUID VARCHAR(MAX), LegionellaOutletID INT, LegionellaOutletGUID VARCHAR(MAX), LegionellaOutletGUIDVersion INT)
      Insert into @LegionellaOutlet_Data (LegionellaLocationGUID,LegionellaOutletID,LegionellaOutletGUID,LegionellaOutletGUIDVersion) Select lguid.LegionellaLocationGUID,lguid.LegionellaOutletID, lguid.LegionellaOutletGUID, lguid.LegionellaOutletGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaOutletIdentifier=1 AND @RestrictedLegionellaAssetCategoryID = 0

      DECLARE @ReinspectData TABLE  
      (
            TableName VARCHAR(MAX),TableCategoryID INT,TableID INT,ParentID INT,GUID VARCHAR(50),GUIDVersion INT,BuildingDesignation VARCHAR(MAX),
            GeneralDescriptionOfSite VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), Notes VARCHAR(MAX),
            SystemRef VARCHAR(MAX),Location VARCHAR(MAX),
            SourceCold INT, SourceHot INT,SourceMains INT, SourceMixed INT,
            SentinelCold INT, SentinelHot INT, SentinelMains INT, SentinelMixed INT,
            EnabledCold INT, EnabledHot INT, EnabledMains INT, EnabledMixed INT,
            [LowUseCold] INT, [LowUseHot] INT, [LowUseMains] INT, [LowUseMixed] INT,
            LegionellaTaskAutoInsertID INT,LegionellaTaskAutoInsertTypeID INT, LegionellaTaskNo INT, LegionellaSectionID INT, 
            LegionellaRiskCategoryID INT, RiskDescription VARCHAR(MAX), [Action] VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaRiskRatingID INT, LegionellaPriorityRatingID INT, 
            SortOrder INT, TaskDueDate DATETIME
      )
      Insert into @ReinspectData (TableName,TableCategoryID,TableID,ParentID,GUID,GUIDVersion,BuildingDesignation,GeneralDescriptionOfSite,AreasNotAccessed,Notes,SystemRef,Location,[SourceCold],[SourceHot],[SourceMains],[SourceMixed],[SentinelCold],[SentinelHot],[SentinelMains],[SentinelMixed],[EnabledCold],[EnabledHot],[EnabledMains],[EnabledMixed],[LowUseCold],[LowUseHot],[LowUseMains],[LowUseMixed],LegionellaTaskAutoInsertID,LegionellaTaskAutoInsertTypeID,LegionellaTaskNo,LegionellaSectionID,LegionellaRiskCategoryID,RiskDescription,[Action],LegionellaFrequencyCategoryID,LegionellaRiskRatingID,LegionellaPriorityRatingID,SortOrder,TaskDueDate)
      Select
            main.TableName,
            main.TableCategoryID,
            main.TableID,
            main.ParentID,
            main.GUID,
            main.GuidVersion,
            main.BuildingDesignation,
            main.GeneralDescriptionOfSite,
            main.AreasNotAccessed,
            main.Notes,
            main.SystemRef,
            main.Location,
            main.SourceCold,
            main.SourceHot,
            main.SourceMains,
            main.SourceMixed,
            main.SentinelCold,
            main.SentinelHot,
            main.SentinelMains,
            main.SentinelMixed,
            main.EnabledCold,
            main.EnabledHot,
            main.EnabledMains,
            main.EnabledMixed,
            main.LowUseCold,
            main.LowUseHot,
            main.LowUseMains,
            main.LowUseMixed,
            main.[LegionellaTaskAutoInsertID],
            main.[LegionellaTaskAutoInsertTypeID],
            main.[LegionellaTaskNo],
            main.[LegionellaSectionID], 
            main.[LegionellaRiskCategoryID],
            main.[RiskDescription],
            main.[Action], 
            main.[LegionellaFrequencyCategoryID],
            main.[LegionellaRiskRatingID],
            main.[LegionellaPriorityRatingID],
            main.[SortOrder],
                  main.TaskDueDate [TaskDueDate]
      FROM
            (
                  Select 
                        'Legionella' [TableName],
                        NULL [TableCategoryID],
                        l.LegionellaID [TableID],
                        NULL [ParentID],
                        l.GUID [GUID],
                        l.GUIDVersion [GUIDVersion],
                        l.BuildingDesignation [BuildingDesignation],
                        l.GeneralDescriptionOfSite [GeneralDescriptionOfSite],
                                    l.AreasNotAccessed [AreasNotAccessed],
                                    l.Notes [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        Legionella l WITH (NOLOCK)
                        INNER JOIN @Legionella_Data ld ON l.LegionellaID = ld.LegionellaID
                  UNION
                  Select 
                        'LegionellaAsset' [TableName],
                        la.LegionellaAssetCategoryID [TableCategoryID],
                        la.LegionellaAssetID [TableID],
                        ld.LegionellaID [ParentID],
                        la.GUID [GUID],
                        la.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                                    NULL [AreasNotAccessed],
                                    NULL [Notes],
                        la.SystemRef [SystemRef],
                        la.Location [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                       NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        LegionellaAsset la WITH (NOLOCK)
                        INNER JOIN @LegionellaAsset_Data lad ON la.LegionellaAssetID=lad.LegionellaAssetID
                        INNER JOIN @Legionella_Data ld ON lad.LegionellaGUID=ld.LegionellaGUID
				  WHERE
						la.Deleted IS NULL
							AND
						la.DateRemoved IS NULL
                  UNION
                  Select 
                        'LegionellaLocation' [TableName],
                        NULL [TableCategoryID],
                        ll.LegionellaLocationID [TableID],
                        ld.LegionellaID [ParentID],
                        ll.GUID [GUID],
                        ll.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                                    NULL [AreasNotAccessed],
                                    NULL [Notes],
                        NULL [SystemRef],
                        ll.Location [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                                    NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        LegionellaLocation ll WITH (NOLOCK)
                        INNER JOIN @LegionellaLocation_Data lld ON lld.LegionellaLocationID=ll.LegionellaLocationID
                        INNER JOIN @Legionella_Data ld ON lld.LegionellaGUID=ld.LegionellaGUID
				  WHERE
						ll.Deleted IS NULL
							AND
						ll.DateRemoved IS NULL
                  UNION
                  Select 
                        'LegionellaOutlet' [TableName],
                        lo.LegionellaOutletCategoryID [TableCategoryID],
                        lo.LegionellaOutletID [TableID],
                        lld.LegionellaLocationID [ParentID],
                        lo.GUID [GUID],
                        lo.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                                    NULL [AreasNotAccessed],
                                    NULL [Notes],
                        lo.SystemRef [SystemRef],
                        NULL [Location],
                        lo.SourceCold [SourceCold],
                        lo.SourceHot [SourceHot],
                        lo.SourceMains [SourceMains],
                        lo.SourceMixed [SourceMixed],
                        lo.SentinelCold [SentinelCold],
                        lo.SentinelHot [SentinelHot],
                        lo.SentinelMains [SentinelMains],
                        lo.SentinelMixed [SentinelMixed],
                        lo.EnabledCold [EnabledCold],
                        lo.EnabledHot [EnabledHot],
                        lo.EnabledMains [EnabledMains],
                        lo.EnabledMixed [EnabledMixed],
                        lo.LowUseCold [LowUseCold],
                                    lo.LowUseHot [LowUseHot],
                                    lo.LowUseMains [LowUseMains],
                                    lo.LowUseMixed [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        LegionellaOutlet lo WITH (NOLOCK)
                                    INNER JOIN @LegionellaOutlet_Data lod ON lod.LegionellaOutletID=lo.LegionellaOutletID
                                    INNER JOIN @LegionellaLocation_Data lld ON lld.LegionellaLocationGUID=lod.LegionellaLocationGUID
				  WHERE
						lo.Deleted IS NULL
							AND
						lo.DateRemoved IS NULL
            ) main

Insert into @ReinspectData (TableName,TableCategoryID,TableID,ParentID,GUID,GUIDVersion,BuildingDesignation,GeneralDescriptionOfSite,AreasNotAccessed,Notes,SystemRef,Location,[SourceCold],[SourceHot],[SourceMains],[SourceMixed],[SentinelCold],[SentinelHot],[SentinelMains],[SentinelMixed],[EnabledCold],[EnabledHot],[EnabledMains],[EnabledMixed],[LowUseCold],[LowUseHot],[LowUseMains],[LowUseMixed],LegionellaTaskAutoInsertID,LegionellaTaskAutoInsertTypeID,LegionellaTaskNo,LegionellaSectionID,LegionellaRiskCategoryID,RiskDescription,[Action],LegionellaFrequencyCategoryID,LegionellaRiskRatingID,LegionellaPriorityRatingID,SortOrder,TaskDueDate)
            Select
                  main.TableName,
                  main.TableCategoryID,
                  main.TableID,
                  main.ParentID,
                  main.GUID,
                  main.GuidVersion,
                  main.BuildingDesignation,
                  main.GeneralDescriptionOfSite [GeneralDescriptionOfSite],
                  main.AreasNotAccessed [AreasNotAccessed],
                  main.Notes [Notes],
                  main.SystemRef,
                  main.Location,
                  main.SourceCold,
                  main.SourceHot,
                  main.SourceMains,
                  main.SourceMixed,
                  main.SentinelCold,
                  main.SentinelHot,
                  main.SentinelMains,
                  main.SentinelMixed,
                  main.EnabledCold,
                  main.EnabledHot,
                  main.EnabledMains,
                  main.EnabledMixed,
                  main.LowUseCold,
                  main.LowUseHot,
                  main.LowUseMains,
                  main.LowUseMixed,
                  main.[LegionellaTaskAutoInsertID],
                  main.[LegionellaTaskAutoInsertTypeID],
                  main.[LegionellaTaskNo],
                  main.[LegionellaSectionID], 
                  main.[LegionellaRiskCategoryID],
                  main.[RiskDescription],
                  main.[Action], 
                  main.[LegionellaFrequencyCategoryID],
                  main.[LegionellaRiskRatingID],
                  main.[LegionellaPriorityRatingID],
                  main.[SortOrder],
                  main.TaskDueDate [TaskDueDate]
            FROM
            (
                  --now for the tasks!
                  Select 
                        'LegionellaTask_Outlet' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        lto.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData lto ON lt.LegionellaOutletID=lto.TableID AND lto.TableName='LegionellaOutlet'
                  WHERE
                        lt.Deleted IS NULL
                  UNION
                  Select 
                        'LegionellaTask_Asset' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        lta.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData lta ON lt.LegionellaAssetID=lta.TableID AND lta.TableName='LegionellaAsset'
                  WHERE
                        lt.Deleted IS NULL
                  UNION
                  Select 
                        'LegionellaTask_Location' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        ltll.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData ltll ON lt.LegionellaLocationID=ltll.TableID AND ltll.TableName='LegionellaLocation'
                  WHERE
                        lt.Deleted IS NULL
                  UNION
                  Select 
                        'LegionellaTask_Legionella' [TableName],
                        lt.LegionellaSectionID [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        ltl.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData ltl ON lt.LegionellaID=ltl.TableID AND ltl.TableName='Legionella'
                  WHERE
                        lt.Deleted IS NULL
            ) main

      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaAsset' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaAssetID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaAsset' AND GUID IS NULL)
            UPDATE LegionellaAsset Set GUID=dbo.CreateGUID('000000000000','LegionellaAsset','TS'),GUIDVersion=1 Where LegionellaAssetID=@LegionellaAssetID
            DECLARE @LegionellaAssetGUID VARCHAR(50) = (Select GUID FROM LegionellaAsset Where LegionellaAssetID=@LegionellaAssetID)
            Update @ReinspectData Set GUID=@LegionellaAssetGUID,GUIDVersion=1 Where TableName='LegionellaAsset' AND TableID=@LegionellaAssetID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaLocation' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaLocationID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaLocation' AND GUID IS NULL)
            UPDATE LegionellaLocation Set GUID=dbo.CreateGUID('000000000000','LegionellaLocation','TS'),GUIDVersion=1 Where LegionellaLocationID=@LegionellaLocationID
            DECLARE @LegionellaLocationGUID VARCHAR(50) = (Select GUID FROM LegionellaLocation Where LegionellaLocationID=@LegionellaLocationID)
            Update @ReinspectData Set GUID=@LegionellaLocationGUID,GUIDVersion=1 Where TableName='LegionellaLocation' AND TableID=@LegionellaLocationID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaOutlet' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaOutletID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaOutlet' AND GUID IS NULL)
            UPDATE LegionellaOutlet Set GUID=dbo.CreateGUID('000000000000','LegionellaOutlet','TS'),GUIDVersion=1 Where LegionellaOutletID=@LegionellaOutletID
            DECLARE @LegionellaOutletGUID VARCHAR(50) = (Select GUID FROM LegionellaOutlet Where LegionellaOutletID=@LegionellaOutletID)
            Update @ReinspectData Set GUID=@LegionellaOutletGUID,GUIDVersion=1 Where TableName='LegionellaOutlet' AND TableID=@LegionellaOutletID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName LIKE 'LegionellaTask%' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaTaskID INT = (Select top 1 TableID FROM @ReinspectData Where TableName LIKE 'LegionellaTask%' AND GUID IS NULL)
            UPDATE LegionellaTask Set GUID=dbo.CreateGUID('000000000000','LegionellaTask','TS'),GUIDVersion=1 Where LegionellaTaskID=@LegionellaTaskID
            DECLARE @LegionellaTaskGUID VARCHAR(50) = (Select GUID FROM LegionellaTask Where LegionellaTaskID=@LegionellaTaskID)
            Update @ReinspectData Set GUID=@LegionellaTaskGUID,GUIDVersion=1 Where TableName LIKE 'LegionellaTask%' AND TableID=@LegionellaTaskID
      END

      Select * FROM @ReinspectData-- WHERE [GUID] IS NOT NULL AND [GUIDVersion] IS NOT NULL
  
  SET NOCOUNT OFF;
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'LegionellaMonitoringData_DataCollectionTaskEvent') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[LegionellaMonitoringData_DataCollectionTaskEvent] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROC [dbo].[LegionellaMonitoringData_DataCollectionTaskEvent]
(
      @JobID INT
)
AS
BEGIN
  SET NOCOUNT ON;
  
	 DECLARE @IncludeDataCollectionAndTasks INT = 1

      DECLARE @SiteID INT = (Select SiteID FROM Job Where JobID=@JobID)
      DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobID)
      --Get @LegionellaTypeID
      --Select * FROM LegionellaType
      DECLARE @RestrictedLegionellaAssetCategoryID INT = (SELECT ISNULL((SELECT TOP 1 lt.LegionellaAssetCategoryID FROM Job j WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID=a.AppointmentID INNER JOIN LegionellaType lt WITH (NOLOCK) ON al.LegionellaTypeID=lt.LegionellaTypeID WHERE j.JobID = @JobID),0))

      --SELECT lt.* FROM Job j WITH (NOLOCK) INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID=a.AppointmentID INNER JOIN LegionellaType lt WITH (NOLOCK) ON al.LegionellaTypeID=lt.LegionellaTypeID WHERE j.JobID = @JobID

      DECLARE @LegionellaGUIDED TABLE
            (
                  LegionellaID INT, LegionellaGUID VARCHAR(MAX), LegionellaGUIDVersion INT, LegionellaIdentifier INT,
                  LegionellaAssetCategoryID INT,LegionellaAssetID INT, LegionellaAssetGUID VARCHAR(MAX), LegionellaAssetGUIDVersion INT, LegionellaAssetIdentifier INT,
                  LegionellaLocationID INT, LegionellaLocationGUID VARCHAR(MAX), LegionellaLocationGUIDVersion INT, LegionellaLocationIdentifier INT,
                  LegionellaOutletID INT, LegionellaOutletGUID VARCHAR(MAX), LegionellaOutletGUIDVersion INT, LegionellaOutletIdentifier INT
            )
      INSERT INTO @LegionellaGUIDED (LegionellaID, LegionellaGUID, LegionellaGUIDVersion, LegionellaIdentifier, LegionellaAssetCategoryID, LegionellaAssetID, LegionellaAssetGUID, LegionellaAssetGUIDVersion, LegionellaAssetIdentifier, LegionellaLocationID, LegionellaLocationGUID, LegionellaLocationGUIDVersion, LegionellaLocationIdentifier, LegionellaOutletID, LegionellaOutletGUID, LegionellaOutletGUIDVersion, LegionellaOutletIdentifier)
      Select 
            l.LegionellaID,l.GUID [LegionellaGUID],l.GUIDVersion [LegionellaGUIDVersion], ROW_NUMBER() OVER (PARTITION BY l.GUID ORDER BY l.GUIDVersion DESC) [LegionellaIdentifier], 
            la.LegionellaAssetCategoryID, la.LegionellaAssetID, la.GUID [LegionellaAssetGUID], la.GUIDVersion [LegionellaAssetGUIDVersion], ROW_NUMBER() OVER (PARTITION BY la.GUID ORDER BY la.GUIDVersion DESC) [LegionellaAssetIdentifier], 
            ll.LegionellaLocationID, ll.GUID [LegionellaLocationGUID], ll.GUIDVersion [LegionellaLocationGUIDVersion], ROW_NUMBER() OVER (PARTITION BY ll.GUID ORDER BY ll.GUIDVersion DESC) [LegionellaIdentifier], 
            lo.LegionellaOutletID, lo.GUID [LegionellaOutletGUID], lo.GUIDVersion [LegionellaOutletGUIDVersion], ROW_NUMBER() OVER (PARTITION BY lo.GUID ORDER BY lo.GUIDVersion DESC) [LegionellaIdentifier]
      FROM
            Job j WITH (NOLOCK)
          
            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID=q.JobID
            INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NULL
          
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
            INNER JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID
          
            LEFT OUTER JOIN LegionellaAsset la WITH (NOLOCK) ON l.LegionellaID = la.LegionellaID
            LEFT OUTER JOIN LegionellaLocation ll WITH (NOLOCK) ON l.LegionellaID = ll.LegionellaID
            LEFT OUTER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID
          
      Where
            j.ClientID=@ClientID AND j.SiteID=@SiteID AND j.Approved IS NOT NULL

      DECLARE @Legionella_Data TABLE (LegionellaID INT, LegionellaGUID VARCHAR(MAX), LegionellaGUIDVersion INT)
      Insert into @Legionella_Data (LegionellaID,LegionellaGUID,LegionellaGUIDVersion) Select LegionellaID,LegionellaGUID,LegionellaGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaIdentifier=1
      DECLARE @LegionellaAsset_Data TABLE (LegionellaGUID VARCHAR(MAX), LegionellaAssetID INT, LegionellaAssetGUID VARCHAR(MAX), LegionellaAssetGUIDVersion INT)
      Insert into @LegionellaAsset_data (LegionellaGUID,LegionellaAssetID,LegionellaAssetGUID,LegionellaAssetGUIDVersion) Select lguid.LegionellaGUID,lguid.LegionellaAssetID,lguid.LegionellaAssetGUID,lguid.LegionellaAssetGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaAssetIdentifier=1 AND (@RestrictedLegionellaAssetCategoryID = 0 OR lguid.LegionellaAssetCategoryID = @RestrictedLegionellaAssetCategoryID)
      DECLARE @LegionellaLocation_Data TABLE (LegionellaGUID VARCHAR(MAX), LegionellaLocationID INT, LegionellaLocationGUID VARCHAR(MAX), LegionellaLocationGUIDVersion INT)
      Insert into @LegionellaLocation_Data (LegionellaGUID,LegionellaLocationID,LegionellaLocationGUID,LegionellaLocationGUIDVersion) Select lguid.LegionellaGUID,lguid.LegionellaLocationID,lguid.LegionellaLocationGUID,lguid.LegionellaLocationGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaLocationIdentifier=1 AND @RestrictedLegionellaAssetCategoryID = 0
      DECLARE @LegionellaOutlet_Data TABLE (LegionellaLocationGUID VARCHAR(MAX), LegionellaOutletID INT, LegionellaOutletGUID VARCHAR(MAX), LegionellaOutletGUIDVersion INT)
      Insert into @LegionellaOutlet_Data (LegionellaLocationGUID,LegionellaOutletID,LegionellaOutletGUID,LegionellaOutletGUIDVersion) Select lguid.LegionellaLocationGUID,lguid.LegionellaOutletID, lguid.LegionellaOutletGUID, lguid.LegionellaOutletGUIDVersion FROM @LegionellaGUIDED lguid Where lguid.LegionellaOutletIdentifier=1 AND @RestrictedLegionellaAssetCategoryID = 0

      DECLARE @ReinspectData TABLE  
      (
            TableName VARCHAR(MAX),TableCategoryID INT,TableID INT,ParentID INT,GUID VARCHAR(50),GUIDVersion INT,BuildingDesignation VARCHAR(MAX),
            GeneralDescriptionOfSite VARCHAR(MAX), AreasNotAccessed VARCHAR(MAX), Notes VARCHAR(MAX),
            SystemRef VARCHAR(MAX),Location VARCHAR(MAX),
            SourceCold INT, SourceHot INT,SourceMains INT, SourceMixed INT,
            SentinelCold INT, SentinelHot INT, SentinelMains INT, SentinelMixed INT,
            EnabledCold INT, EnabledHot INT, EnabledMains INT, EnabledMixed INT,
            [LowUseCold] INT, [LowUseHot] INT, [LowUseMains] INT, [LowUseMixed] INT,
            LegionellaTaskAutoInsertID INT,LegionellaTaskAutoInsertTypeID INT, LegionellaTaskNo INT, LegionellaSectionID INT, 
            LegionellaRiskCategoryID INT, RiskDescription VARCHAR(MAX), [Action] VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaRiskRatingID INT, LegionellaPriorityRatingID INT, 
            SortOrder INT, TaskDueDate DATETIME
      )
      Insert into @ReinspectData (TableName,TableCategoryID,TableID,ParentID,GUID,GUIDVersion,BuildingDesignation,GeneralDescriptionOfSite,AreasNotAccessed,Notes,SystemRef,Location,[SourceCold],[SourceHot],[SourceMains],[SourceMixed],[SentinelCold],[SentinelHot],[SentinelMains],[SentinelMixed],[EnabledCold],[EnabledHot],[EnabledMains],[EnabledMixed],[LowUseCold],[LowUseHot],[LowUseMains],[LowUseMixed],LegionellaTaskAutoInsertID,LegionellaTaskAutoInsertTypeID,LegionellaTaskNo,LegionellaSectionID,LegionellaRiskCategoryID,RiskDescription,[Action],LegionellaFrequencyCategoryID,LegionellaRiskRatingID,LegionellaPriorityRatingID,SortOrder,TaskDueDate)
      Select
            main.TableName,
            main.TableCategoryID,
            main.TableID,
            main.ParentID,
            main.GUID,
            main.GuidVersion,
            main.BuildingDesignation,
            main.GeneralDescriptionOfSite,
            main.AreasNotAccessed,
            main.Notes,
            main.SystemRef,
            main.Location,
            main.SourceCold,
            main.SourceHot,
            main.SourceMains,
            main.SourceMixed,
            main.SentinelCold,
            main.SentinelHot,
            main.SentinelMains,
            main.SentinelMixed,
            main.EnabledCold,
            main.EnabledHot,
            main.EnabledMains,
            main.EnabledMixed,
            main.LowUseCold,
            main.LowUseHot,
            main.LowUseMains,
            main.LowUseMixed,
            main.[LegionellaTaskAutoInsertID],
            main.[LegionellaTaskAutoInsertTypeID],
            main.[LegionellaTaskNo],
            main.[LegionellaSectionID], 
            main.[LegionellaRiskCategoryID],
            main.[RiskDescription],
            main.[Action], 
            main.[LegionellaFrequencyCategoryID],
            main.[LegionellaRiskRatingID],
            main.[LegionellaPriorityRatingID],
            main.[SortOrder],
                  main.TaskDueDate [TaskDueDate]
      FROM
            (
                  Select 
                        'Legionella' [TableName],
                        NULL [TableCategoryID],
                        l.LegionellaID [TableID],
                        NULL [ParentID],
                        l.GUID [GUID],
                        l.GUIDVersion [GUIDVersion],
                        l.BuildingDesignation [BuildingDesignation],
                        l.GeneralDescriptionOfSite [GeneralDescriptionOfSite],
                        l.AreasNotAccessed [AreasNotAccessed],
                        l.Notes [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        Legionella l WITH (NOLOCK)
                        INNER JOIN @Legionella_Data ld ON l.LegionellaID = ld.LegionellaID
                  UNION
                  Select 
                        'LegionellaAsset' [TableName],
                        la.LegionellaAssetCategoryID [TableCategoryID],
                        la.LegionellaAssetID [TableID],
                        ld.LegionellaID [ParentID],
                        la.GUID [GUID],
                        la.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        la.SystemRef [SystemRef],
                        la.Location [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                       NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                                    NULL [TaskDueDate]
                  FROM 
                        LegionellaAsset la WITH (NOLOCK)
                        INNER JOIN @LegionellaAsset_Data lad ON la.LegionellaAssetID=lad.LegionellaAssetID
                        INNER JOIN @Legionella_Data ld ON lad.LegionellaGUID=ld.LegionellaGUID
				  WHERE
						la.Deleted IS NULL
							AND
						la.DateRemoved IS NULL
                  UNION
                  Select 
                        'LegionellaLocation' [TableName],
                        NULL [TableCategoryID],
                        ll.LegionellaLocationID [TableID],
                        ld.LegionellaID [ParentID],
                        ll.GUID [GUID],
                        ll.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
					    NULL [Notes],
                        NULL [SystemRef],
                        ll.Location [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        ll.SortOrder [SortOrder],
                        NULL [TaskDueDate]
                  FROM 
                        LegionellaLocation ll WITH (NOLOCK)
                        INNER JOIN @LegionellaLocation_Data lld ON lld.LegionellaLocationID=ll.LegionellaLocationID
                        INNER JOIN @Legionella_Data ld ON lld.LegionellaGUID=ld.LegionellaGUID
				  WHERE
						ll.Deleted IS NULL
							AND
						ll.DateRemoved IS NULL
                  UNION
                  Select 
                        'LegionellaOutlet' [TableName],
                        lo.LegionellaOutletCategoryID [TableCategoryID],
                        lo.LegionellaOutletID [TableID],
                        lld.LegionellaLocationID [ParentID],
                        lo.GUID [GUID],
                        lo.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        lo.SystemRef [SystemRef],
                        NULL [Location],
                        lo.SourceCold [SourceCold],
                        lo.SourceHot [SourceHot],
                        lo.SourceMains [SourceMains],
                        lo.SourceMixed [SourceMixed],
                        lo.SentinelCold [SentinelCold],
                        lo.SentinelHot [SentinelHot],
                        lo.SentinelMains [SentinelMains],
                        lo.SentinelMixed [SentinelMixed],
                        lo.EnabledCold [EnabledCold],
                        lo.EnabledHot [EnabledHot],
                        lo.EnabledMains [EnabledMains],
                        lo.EnabledMixed [EnabledMixed],
                        lo.LowUseCold [LowUseCold],
                        lo.LowUseHot [LowUseHot],
                        lo.LowUseMains [LowUseMains],
                        lo.LowUseMixed [LowUseMixed],
                        NULL [LegionellaTaskAutoInsertID],
                        NULL [LegionellaTaskAutoInsertTypeID],
                        NULL [LegionellaTaskNo],
                        NULL [LegionellaSectionID], 
                        NULL [LegionellaRiskCategoryID],
                        NULL [RiskDescription],
                        NULL [Action], 
                        NULL [LegionellaFrequencyCategoryID],
                        NULL [LegionellaRiskRatingID],
                        NULL [LegionellaPriorityRatingID],
                        NULL [SortOrder],
                        NULL [TaskDueDate]
                  FROM 
                        LegionellaOutlet lo WITH (NOLOCK)
                                    INNER JOIN @LegionellaOutlet_Data lod ON lod.LegionellaOutletID=lo.LegionellaOutletID
                                    INNER JOIN @LegionellaLocation_Data lld ON lld.LegionellaLocationGUID=lod.LegionellaLocationGUID
				  WHERE
						lo.Deleted IS NULL
							AND
						lo.DateRemoved IS NULL
            ) main

Insert into @ReinspectData (TableName,TableCategoryID,TableID,ParentID,GUID,GUIDVersion,BuildingDesignation,GeneralDescriptionOfSite,AreasNotAccessed,Notes,SystemRef,Location,[SourceCold],[SourceHot],[SourceMains],[SourceMixed],[SentinelCold],[SentinelHot],[SentinelMains],[SentinelMixed],[EnabledCold],[EnabledHot],[EnabledMains],[EnabledMixed],[LowUseCold],[LowUseHot],[LowUseMains],[LowUseMixed],LegionellaTaskAutoInsertID,LegionellaTaskAutoInsertTypeID,LegionellaTaskNo,LegionellaSectionID,LegionellaRiskCategoryID,RiskDescription,[Action],LegionellaFrequencyCategoryID,LegionellaRiskRatingID,LegionellaPriorityRatingID,SortOrder,TaskDueDate)
            Select
                  main.TableName,
                  main.TableCategoryID,
                  main.TableID,
                  main.ParentID,
                  main.GUID,
                  main.GuidVersion,
                  main.BuildingDesignation,
                  main.GeneralDescriptionOfSite [GeneralDescriptionOfSite],
                  main.AreasNotAccessed [AreasNotAccessed],
                  main.Notes [Notes],
                  main.SystemRef,
                  main.Location,
                  main.SourceCold,
                  main.SourceHot,
                  main.SourceMains,
                  main.SourceMixed,
                  main.SentinelCold,
                  main.SentinelHot,
                  main.SentinelMains,
                  main.SentinelMixed,
                  main.EnabledCold,
                  main.EnabledHot,
                  main.EnabledMains,
                  main.EnabledMixed,
                  main.LowUseCold,
                  main.LowUseHot,
                  main.LowUseMains,
                  main.LowUseMixed,
                  main.[LegionellaTaskAutoInsertID],
                  main.[LegionellaTaskAutoInsertTypeID],
                  main.[LegionellaTaskNo],
                  main.[LegionellaSectionID], 
                  main.[LegionellaRiskCategoryID],
                  main.[RiskDescription],
                  main.[Action], 
                  main.[LegionellaFrequencyCategoryID],
                  main.[LegionellaRiskRatingID],
                  main.[LegionellaPriorityRatingID],
                  main.[SortOrder],
                  main.TaskDueDate [TaskDueDate]
            FROM
            (
                  --now for the tasks!
                  Select 
                        'LegionellaTask_Outlet' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        lto.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData lto ON lt.LegionellaOutletID=lto.TableID AND lto.TableName='LegionellaOutlet'
                  WHERE
                        lt.Deleted IS NULL
							AND
						@IncludeDataCollectionAndTasks = 1
                  UNION
                  Select 
                        'LegionellaTask_Asset' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        lta.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData lta ON lt.LegionellaAssetID=lta.TableID AND lta.TableName='LegionellaAsset'
                  WHERE
                        lt.Deleted IS NULL
							AND
						@IncludeDataCollectionAndTasks = 1
                  UNION
                  Select 
                        'LegionellaTask_Location' [TableName],
                        NULL [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        ltll.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData ltll ON lt.LegionellaLocationID=ltll.TableID AND ltll.TableName='LegionellaLocation'
                  WHERE
                        lt.Deleted IS NULL
							AND
						@IncludeDataCollectionAndTasks = 1
                  UNION
                  Select 
                        'LegionellaTask_Legionella' [TableName],
                        lt.LegionellaSectionID [TableCategoryID],
                        lt.LegionellaTaskID [TableID],
                        ltl.TableID [ParentID],
                        lt.GUID [GUID],
                        lt.GUIDVersion [GUIDVersion],
                        NULL [BuildingDesignation],
                        NULL [GeneralDescriptionOfSite],
                        NULL [AreasNotAccessed],
                        NULL [Notes],
                        NULL [SystemRef],
                        NULL [Location],
                        NULL [SourceCold],
                        NULL [SourceHot],
                        NULL [SourceMains],
                        NULL [SourceMixed],
                        NULL [SentinelCold],
                        NULL [SentinelHot],
                        NULL [SentinelMains],
                        NULL [SentinelMixed],
                        NULL [EnabledCold],
                        NULL [EnabledHot],
                        NULL [EnabledMains],
                        NULL [EnabledMixed],
                        NULL [LowUseCold],
                        NULL [LowUseHot],
                        NULL [LowUseMains],
                        NULL [LowUseMixed],
                        lt.LegionellaTaskAutoInsertID [LegionellaTaskAutoInsertID],
                        lt.LegionellaTaskAutoInsertTypeID [LegionellaTaskAutoInsertTypeID],
                        lt.LegionellaTaskNo [LegionellaTaskNo],
                        lt.LegionellaSectionID [LegionellaSectionID], 
                        lt.LegionellaRiskCategoryID [LegionellaRiskCategoryID],
                        lt.RiskDescription [RiskDescription],
                        lt.[Action] [Action], 
                        lt.LegionellaFrequencyCategoryID [LegionellaFrequencyCategoryID],
                        lt.LegionellaRiskRatingID [LegionellaRiskRatingID],
                        lt.LegionellaPriorityRatingID [LegionellaPriorityRatingID],
                        lt.SortOrder [SortOrder],
                        lt.DueDate [TaskDueDate]
                  FROM 
                        LegionellaTask lt
                        INNER JOIN @ReinspectData ltl ON lt.LegionellaID=ltl.TableID AND ltl.TableName='Legionella'
                  WHERE
                        lt.Deleted IS NULL
							AND
						@IncludeDataCollectionAndTasks = 1
            ) main

      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaAsset' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaAssetID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaAsset' AND GUID IS NULL)
            UPDATE LegionellaAsset Set GUID=dbo.CreateGUID('000000000000','LegionellaAsset','TS'),GUIDVersion=1 Where LegionellaAssetID=@LegionellaAssetID
            DECLARE @LegionellaAssetGUID VARCHAR(50) = (Select GUID FROM LegionellaAsset Where LegionellaAssetID=@LegionellaAssetID)
            Update @ReinspectData Set GUID=@LegionellaAssetGUID,GUIDVersion=1 Where TableName='LegionellaAsset' AND TableID=@LegionellaAssetID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaLocation' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaLocationID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaLocation' AND GUID IS NULL)
            UPDATE LegionellaLocation Set GUID=dbo.CreateGUID('000000000000','LegionellaLocation','TS'),GUIDVersion=1 Where LegionellaLocationID=@LegionellaLocationID
            DECLARE @LegionellaLocationGUID VARCHAR(50) = (Select GUID FROM LegionellaLocation Where LegionellaLocationID=@LegionellaLocationID)
            Update @ReinspectData Set GUID=@LegionellaLocationGUID,GUIDVersion=1 Where TableName='LegionellaLocation' AND TableID=@LegionellaLocationID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName='LegionellaOutlet' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaOutletID INT = (Select top 1 TableID FROM @ReinspectData Where TableName='LegionellaOutlet' AND GUID IS NULL)
            UPDATE LegionellaOutlet Set GUID=dbo.CreateGUID('000000000000','LegionellaOutlet','TS'),GUIDVersion=1 Where LegionellaOutletID=@LegionellaOutletID
            DECLARE @LegionellaOutletGUID VARCHAR(50) = (Select GUID FROM LegionellaOutlet Where LegionellaOutletID=@LegionellaOutletID)
            Update @ReinspectData Set GUID=@LegionellaOutletGUID,GUIDVersion=1 Where TableName='LegionellaOutlet' AND TableID=@LegionellaOutletID
      END
      
      WHILE (SELECT COUNT(*) FROM @ReinspectData Where TableName LIKE 'LegionellaTask%' AND GUID IS NULL) > 0
      BEGIN
            DECLARE @LegionellaTaskID INT = (Select top 1 TableID FROM @ReinspectData Where TableName LIKE 'LegionellaTask%' AND GUID IS NULL)
            UPDATE LegionellaTask Set GUID=dbo.CreateGUID('000000000000','LegionellaTask','TS'),GUIDVersion=1 Where LegionellaTaskID=@LegionellaTaskID
            DECLARE @LegionellaTaskGUID VARCHAR(50) = (Select GUID FROM LegionellaTask Where LegionellaTaskID=@LegionellaTaskID)
            Update @ReinspectData Set GUID=@LegionellaTaskGUID,GUIDVersion=1 Where TableName LIKE 'LegionellaTask%' AND TableID=@LegionellaTaskID
      END

    Select * FROM @ReinspectData-- WHERE [GUID] IS NOT NULL AND [GUIDVersion] IS NOT NULL

	SELECT
		*
	FROM
	(
		SELECT
			*
		FROM
			LegionellaAssetOutletDataCollection laodc
			INNER JOIN @ReinspectData rd ON laodc.LegionellaID = rd.TableID AND TableName='Legionella'
		WHERE	
			laodc.Deleted IS NULL
				AND
			@IncludeDataCollectionAndTasks = 1
		UNION
		SELECT
			*
		FROM
			LegionellaAssetOutletDataCollection laodc
			INNER JOIN @ReinspectData rd ON laodc.LegionellaAssetID = rd.TableID AND TableName='LegionellaAsset'
		WHERE	
			laodc.Deleted IS NULL
				AND
			@IncludeDataCollectionAndTasks = 1
		UNION
		SELECT
			*
		FROM
			LegionellaAssetOutletDataCollection laodc
			INNER JOIN @ReinspectData rd ON laodc.LegionellaLocationID = rd.TableID AND TableName='LegionellaLocation'
		WHERE	
			laodc.Deleted IS NULL
				AND
			@IncludeDataCollectionAndTasks = 1
		UNION
		SELECT
			*
		FROM
			LegionellaAssetOutletDataCollection laodc
			INNER JOIN @ReinspectData rd ON laodc.LegionellaOutletID = rd.TableID AND TableName='LegionellaOutlet'
		WHERE	
			laodc.Deleted IS NULL
				AND
			@IncludeDataCollectionAndTasks = 1
	) main

	SELECT
		*
	FROM
	(
		SELECT
			*
		FROM
			LegionellaTaskEvent lte
			INNER JOIN @ReinspectData rd ON lte.LegionellaTaskID = rd.TableID AND TableName LIKE 'LegionellaTask_%'
		WHERE	
			lte.Deleted IS NULL
	) main
	ORDER BY
		main.LegionellaTaskID

  SET NOCOUNT OFF;
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'LegionellaSchedule') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[LegionellaSchedule] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[LegionellaSchedule]
      @LegionellaID INT,
      @DisplayDate DATETIME = NULL
AS
BEGIN
SET NOCOUNT ON;

/* NOTE: AS OF 18/11/2016, THIS HAS BEEN REPLACED WITH GetPortalLegionellaLogBookTasks ON THE PORTAL! */

Set @DisplayDate = cast(CONVERT(VARCHAR(11),ISNULL(@DisplayDate,GETDATE()),106) + ' 00:00:00' as datetime)
DECLARE @internalenddate DATETIME = cast(CONVERT(VARCHAR(11),@DisplayDate,106) + ' 23:59:59' as datetime)

Declare @Schedule TABLE (LegionellaTaskID INT, SortOrder INT,Frequency VARCHAR(MAX), PriorityColor VARCHAR(MAX), SystemRef VARCHAR(MAX), Location VARCHAR(MAX), [Action] VARCHAR(MAX), [EventRowNo] INT, [Performed By] VARCHAR(MAX), [Date] DATE, [Comment] VARCHAR(MAX))
Insert into @Schedule (LegionellaTaskID,SortOrder,Frequency,PriorityColor,SystemRef,Location,[Action],[EventRowNo],[Performed By],[Date],[Comment])
Select 
	lt.LegionellaTaskID [LegionellaTaskID],
	IsNull(lfc.SortOrder,-1) [SortOrder],
	lfc.Description [Frequency],
	ISNULL(lrr.RiskColour,'') [PriorityColor],
	lao.SystemRef [SystemRef],
	lao.Location [Location],
	lt.[Action] [Action],
	ROW_NUMBER() OVER (Partition By lt.LegionellaTaskID Order By lte.Recorded DESC) [EventRowNo],
	IsNull(e.FullName, IsNull(pu.FullName, lte.PerformedByThirdParty)) [Performed By],
	lte.Recorded [Date],
	lte.Comments
FROM
	Legionella l
	INNER JOIN
		(
			Select 'Asset' [Type], LegionellaAssetID [ID],SystemRef, Location, LegionellaID FROM LegionellaAsset Where LegionellaID=@LegionellaID AND DateRemoved IS NULL
				UNION 
			Select 'Outlet' [Type],LegionellaOutletID [ID], lo.SystemRef, ll.Location, ll.LegionellaID FROM LegionellaOutlet lo INNER JOIN LegionellaLocation ll ON lo.LegionellaLocationID=ll.LegionellaLocationID Where ll.LegionellaID=@LegionellaID AND ll.DateRemoved IS NULL AND lo.DateRemoved IS NULL
				UNION
			Select 'Section' [Type],NULL [ID], 'N/A', 'N/A', LegionellaID FROM LegionellaTask Where LegionellaID=@LegionellaID
				UNION
			Select 'Location' [Type],ll.LegionellaLocationID [ID], 'N/A', ll.Location, LegionellaID FROM LegionellaLocation ll Where LegionellaID=@LegionellaID AND DateRemoved IS NULL
		) lao ON l.LegionellaID=lao.LegionellaID
	INNER JOIN LegionellaTask lt ON (lt.LegionellaLocationID = lao.ID AND lao.Type='Location') OR (lt.LegionellaAssetID = lao.ID AND lao.Type='Asset') OR (lt.LegionellaOutletID = lao.ID AND lao.Type='Outlet')  OR (lt.LegionellaID = lao.LegionellaID AND lao.Type='Section') 
	LEFT OUTER JOIN LegionellaRiskRating lrr ON lrr.LegionellaRiskRatingID=lt.LegionellaRiskRatingID 
	LEFT OUTER JOIN LegionellaPriorityRating lpr ON lpr.LegionellaPriorityRatingID=lt.LegionellaPriorityRatingID 
	LEFT OUTER JOIN LegionellaFrequencyCategory lfc ON lfc.LegionellaFrequencyCategoryID=lt.LegionellaFrequencyCategoryID 
	LEFT OUTER JOIN LegionellaTaskEvent lte ON lte.LegionellaTaskID = lt.LegionellaTaskID
	AND
	(
		CASE WHEN lfc.DateAddModifier IS NULL THEN
			1
		ELSE
			CASE lfc.DateAddModifier 
				WHEN 'Day' THEN
					CASE WHEN lte.Recorded BETWEEN @DisplayDate AND @internalenddate THEN 1 ELSE 0 END
				WHEN 'Week' THEN
					CASE WHEN lte.Recorded BETWEEN DATEADD(Week,-(lfc.DateAddValue),@DisplayDate) AND DATEADD(Week,(lfc.DateAddValue),@DisplayDate) THEN 1 ELSE 0 END
				WHEN 'Month' THEN
					CASE WHEN lte.Recorded BETWEEN DATEADD(Month,-(lfc.DateAddValue),@DisplayDate) AND DATEADD(Month,(lfc.DateAddValue),@DisplayDate) THEN 1 ELSE 0 END
				WHEN 'Year' THEN
					CASE WHEN lte.Recorded BETWEEN DATEADD(Year,-(lfc.DateAddValue),@DisplayDate) AND DATEADD(Year,(lfc.DateAddValue),@DisplayDate) THEN 1 ELSE 0 END
			END
		END = 1
	)
	LEFT OUTER JOIN Employee e ON e.EmployeeID = lte.PerformedByEmployeeID
	LEFT OUTER JOIN PortalUser pu ON pu.PortalUserId = lte.PerformedByPortalUserID
Where
	@LegionellaID = l.LegionellaID
Order by
	IsNull(lfc.SortOrder,-1),lte.Recorded DESC
	
SELECT
	IsNull(sch.LegionellaTaskID, 0) [LegionellaTaskID], IsNull(sch.Frequency, '') [Frequency],sch.PriorityColor,sch.SystemRef,sch.Location,sch.Action,IsNull(sch.[Performed By], '') [PerformedBy],sch.Date, IsNull(sch.Comment, '') [Comment]
FROM 
	@Schedule sch
WHERE
	sch.EventRowNo = 1
ORDER BY
	sch.SortOrder,sch.Date

SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ReinspectionDateConfig') AND name='SiteDocumentTypeID') < 1
BEGIN
	ALTER TABLE [dbo].[ReinspectionDateConfig]
		ADD [SiteDocumentTypeID] [int] NULL;
END
GO

BEGIN TRANSACTION 
	IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='ConfigXeroSetup'))
	BEGIN
		CREATE TABLE [dbo].[ConfigXeroSetup] (
			[ConfigXeroSetupId] [int] IDENTITY (1, 1) NOT NULL,
			[ClientId] [varchar] (MAX) NOT NULL,
			[ClientSecret] [varchar] (MAX) NOT NULL,
			[CallbackUri] [varchar] (MAX) NOT NULL,
			[AccessToken] [varchar] (MAX) NULL,
			CONSTRAINT [PK_ConfigXeroSetup]
			PRIMARY KEY CLUSTERED
			(
				[ConfigXeroSetupId] ASC
			)
			WITH (PAD_INDEX = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF, DATA_COMPRESSION = NONE)
			ON [PRIMARY]
			) ON [PRIMARY]
			TEXTIMAGE_ON [PRIMARY];
	END 
COMMIT TRANSACTION
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'reorderRegisterItemsBySite') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[reorderRegisterItemsBySite] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[reorderRegisterItemsBySite]
	@ClientId INT,
	@SiteId INT

AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	
DECLARE @Samples TABLE (SampleId INT, NewItemNo INT)
INSERT INTO @Samples
SELECT
	s.SampleId,
	ROW_NUMBER() OVER (ORDER BY s.DateCreated) [NewItemNo]	
FROM
	GuidSamples gs
	INNER JOIN Sample s ON gs.SampleID = s.SampleID
WHERE
	gs.ClientID = @ClientId
		AND
	gs.SiteID = @SiteId
ORDER BY
	s.DateCreated

BEGIN TRAN

UPDATE Sample SET RegisterItemNo = s.NewItemNo FROM @Samples s WHERE Sample.SampleID = s.SampleId

COMMIT TRAN

END 
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'AllSitesAuthorisedForConsultancy') < 1 BEGIN
	EXEC('CREATE FUNCTION [dbo].[AllSitesAuthorisedForConsultancy] (@ClientID int, @ServerCode VARCHAR(MAX)) RETURNS bit BEGIN RETURN 0 END;')
END
GO

ALTER FUNCTION [dbo].[AllSitesAuthorisedForConsultancy] (@ClientID int, @ServerCode VARCHAR(MAX))
RETURNS bit
WITH EXECUTE AS CALLER
AS
BEGIN

DECLARE @NonAuthorisedSites INT = (SELECT
		COUNT(*) 
	FROM
		Client c
		INNER JOIN ClientSite cs on c.clientid = cs.clientid
		INNER JOIN Site si on cs.siteid = si.SiteID and si.Deleted IS NULL
		LEFT JOIN EnterpriseSiteAccessAuthorisation esaa on cs.siteid = esaa.SiteID AND ConsultancyServerCode = @ServerCode
	WHERE
		c.ClientID = @ClientID
			AND
		(esaa.EnterpriseSiteAccessAuthorisationID IS NULL OR esaa.DateDeleted IS NOT NULL)
	)
	
IF @NonAuthorisedSites > 0
BEGIN
	RETURN 0
END

RETURN 1
	
END;
GO

/* Paged_CompletedSampleReport begin*/

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_CompletedSampleReport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_CompletedSampleReport] AS BEGIN SET NOCOUNT ON; END')
End

GO

/****** Object:  StoredProcedure [dbo].[Paged_CompletedSampleReport]    Script Date: 11/08/2020 09:04:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_CompletedSampleReport]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filters
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@JobID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL,
	@EmployeeID INT = 0,
	@BranchOfficeID INT = 0,
	@CompletedSampleReportsFilterType INT = 0,
	@LaboratoryID INT = 0
AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
    Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1
      
	DECLARE @CompletedSampleReportJobs TABLE (JobID INT, JobNo INT, ClientOrderNo VARCHAR(MAX))
	INSERT INTO @CompletedSampleReportJobs (JobID, JobNo, ClientOrderNo)
	SELECT
		a.JobID, a.JobNo, a.ClientOrderNo
	FROM
	(
		SELECT
			jd.JobID, jd.JobNo, jd.ClientOrderNo,
			ROW_NUMBER() OVER (PARTITION BY jd.JobID Order By asu.DueDate ASC, r.RegisterFinish DESC) [Identifier]
		FROM
			(
				SELECT
					j.JobID, j.JobNo, a.AppointmentID, a.ClientOrderNo
				FROM
					Job j 
					INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
					INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
					LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
					LEFT JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
					LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
				WHERE
					a.DateDeclined IS NULL
						AND
					j.Approved IS NOT NULL
						AND
					j.Cancelled IS NULL
						AND
					(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
						AND
					(
						CASE WHEN j.SampleResultEmployeeID IS NOT NULL AND j.SampleContentEmployeeID IS NOT NULL THEN
							1
						ELSE
							0
						END = 1
					)
						AND
					(
						CASE @CompletedSampleReportsFilterType
							WHEN -1 THEN CASE WHEN a.AppointmentID IS NULL THEN 1 ELSE 0 END
							WHEN -2 THEN CASE WHEN a.AppointmentID IS NOT NULL THEN 1 ELSE 0 END
							WHEN 0 THEN 1
						ELSE
							1
						End = 1
					)
						AND
					(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
						AND
					(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
						AND
					(
						CASE WHEN @Filter IS NULL THEN
							1
						ELSE
							CASE WHEN
								/*j.ClientOrderNo LIKE '%' + @Filter + '%'
									OR*/ --This seems to be in other sp's, but not this one? - Left in for clarity later
								si.Address Like '%' + @Filter + '%'
									Or
								si.Postcode Like '%' + @Filter + '%'
									Or
								si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
									Or 
								si.UPRN = @Filter
							THEN 1 ELSE 0 END
						END = 1
					)
						AND
					j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
			) jd
			INNER JOIN JobEmployee je WITH (NOLOCK)ON je.JobID = jd.JobID
			INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
			
			LEFT JOIN AppointmentSurvey asu WITH (NOLOCK) ON jd.AppointmentID = asu.AppointmentID

		WHERE
			(
				CASE WHEN @JobID = 0 THEN
					CASE WHEN r.RegisterFinish between @FilterStartDate AND @FilterEndDate THEN 1 ELSE 0 END
				ELSE
					1
				END = 1
			)
	            AND
			(
				CASE @CompletedSampleReportsFilterType
					WHEN -1 THEN 1
					WHEN -2 THEN 1
					WHEN 0 THEN 1
				ELSE
					CASE WHEN asu.SurveyTypeID = @CompletedSampleReportsFilterType THEN 1 ELSE 0 END
				End = 1
			)
	) a
	WHERE
		a.Identifier = 1

    DECLARE @FullSet TABLE (JobNo INT, JobID INT, DateAnalysedStart DATETIME, DateAnalysedFinish DATETIME, DateCheckedInStart DATETIME, DateCheckedInFinish DATETIME, ClientOrderNo VARCHAR(MAX), SampleCount INT)

    Insert into @FullSet (JobNo, JobID, DateAnalysedStart, DateAnalysedFinish,DateCheckedInStart, DateCheckedInFinish, ClientOrderNo, SampleCount)
    SELECT
        csrj.JobNo,
        csrj.JobID,
        MIN(s.DateAnalysed) [DateAnalysedStart],
        MAX(s.DateAnalysed) [DateAnalysedFinish],
		MIN(s.DateCheckedIn) [DateCheckedInStart],
        MAX(s.DateCheckedIn) [DateCheckedInFinish],        
        csrj.ClientOrderNo,
        COUNT(*) [SampleCount]
	FROM
        @CompletedSampleReportJobs csrj
        INNER JOIN JobEmployee je WITH (NOLOCK) ON je.JobID = csrj.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Room rm WITH (NOLOCK) ON r.RegisterID=rm.RegisterID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID AND s.SampleRef NOT LIKE '%*%' AND NULLIF(s.SampleRef,'') IS NOT NULL AND s.AsSample=0
	WHERE
		(
			CASE WHEN @EmployeeID = 0 THEN
				1
			ELSE 
				CASE WHEN s.EmployeeID = @EmployeeID THEN 1 ELSE 0 END
			END = 1
		)
			AND
		(
			CASE 
				WHEN @LaboratoryID = 0 THEN 1
				WHEN @LaboratoryID = -2 AND s.LaboratoryId > 100 THEN 1
			ELSE 
				CASE WHEN s.LaboratoryId = @LaboratoryID THEN 1 ELSE 0 END
			END = 1
		)
	Group By 
		csrj.JobNo,csrj.JobID,csrj.ClientOrderNo
	
	DECLARE @CompletedSampleReportsData TABLE (Pages INT, Page INT, Row_Num INT, JobID INT, DateAnalysedStart DATETIME, DateAnalysedFinish DATETIME, DateCheckedInStart DATETIME, DateCheckedInFinish DATETIME, ClientOrderNo VARCHAR(MAX), SampleCount INT)
	DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
	DECLARE @BSRFile TABLE (JobID INT, [Filename] VARCHAR(MAX))

    ;With Paging As
    (
        Select
           CASE 
                WHEN @PerPage = 0 
                THEN 1
                ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages,
        CASE 
            WHEN @PerPage = 0 
            THEN 1
            ELSE
			((Row_Number() Over(Order By a.JobNo DESC)-1) / @PerPage)+1
            END As Page,
			Row_Number() Over(Order By a.JobNo DESC) as Row_Num,
			*
        From
        (
			Select * FROM @FullSet
        ) a
    )
    
    INSERT INTO @CompletedSampleReportsData (Pages, Page, Row_Num, JobID, DateAnalysedStart, DateAnalysedFinish,DateCheckedInStart, DateCheckedInFinish, ClientOrderNo, SampleCount)
    Select
		main.Pages,
        main.Page,
        main.Row_Num,
        main.JobID,
        main.DateAnalysedStart,
        main.DateAnalysedFinish,
		main.DateCheckedInStart,
        main.DateCheckedInFinish,
        main.ClientOrderNo,
        main.SampleCount
    FROM
		Paging main
	Where 
        (
            main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )
    
    INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				csrd.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY csrd.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@CompletedSampleReportsData csrd
				INNER JOIN Job j WITH (NOLOCK) On csrd.JobID = j.JobId
				INNER JOIN ClientTemplate ct WITH (NOLOCK) ON ct.ClientID = j.ClientID
				INNER JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1
		
	INSERT INTO @BSRFile (JobID,[Filename])
	SELECT
		a.JobID, a.[FileName]
    FROM
		(
			SELECT
				csrd.JobID, 
				PDF.[FileName],
				ROW_NUMBER() OVER (PARTITION BY csrd.JobID ORDER BY PDF.DateCreated DESC) [Identifier]
			FROM
				@CompletedSampleReportsData csrd
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = csrd.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
		) a
	Where
		a.Identifier = 1
    
    -- Start the main SELECT
    Select
        main.Pages,
        main.Page,
        main.Row_Num,
        j.JobNo, Client + IsNull(Case When Len(BranchName) > 0 Then ' (' + BranchName + ')' End, '') [Client],
        si.Address,
        j.JobID,
        j.Status,
        j.LastNoteCreated,
        j.approved [Approved],
        CASE WHEN CAST(main.DateAnalysedFinish AS DATE) = CAST(main.DateAnalysedStart AS DATE) THEN 
			dbo.FormatTeamsDate(main.DateAnalysedStart, 1)
		ELSE 
			dbo.FormatTeamsDate(main.DateAnalysedStart, 1) + ' - ' + dbo.FormatTeamsDate(main.DateAnalysedFinish, 1)
		END [DateAnalysed],
        main.DateAnalysedStart,
        main.DateAnalysedFinish,
		CASE WHEN CAST(main.DateCheckedInFinish AS DATE) = CAST(main.DateCheckedInStart AS DATE) THEN 
			dbo.FormatTeamsDate(main.DateCheckedInStart, 1)
		ELSE 
			dbo.FormatTeamsDate(main.DateCheckedInStart, 1) + ' - ' + dbo.FormatTeamsDate(main.DateCheckedInFinish, 1)
		END  [DateCheckedIn],
		main.DateCheckedInStart,
		main.DateCheckedInFinish,
        surveyors.List [Surveyors],
        COALESCE(main.ClientOrderNo, q.ClientOrderNo, j.ClientOrderNo, '') [ClientOrderNo],
        main.SampleCount,
		bsr_CT.TemplateID [ClientTemplateID],
		rep_BSR.[Filename] [FileName],
		ISNULL(CASE WHEN j.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
		CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
		ISNULL(p.Project + ISNULL(' (' + p.GroupName + ')',''),'') [ProjectAndGroup]
    From
        @CompletedSampleReportsData main
        INNER JOIN Job j WITH (NOLOCK) ON j.JobID=main.JobID
		LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
        INNER JOIN Client c WITH (NOLOCK) ON c.ClientID=j.ClientID
        INNER JOIN Site si WITH (NOLOCK) ON si.SiteID=j.SiteID
        LEFT OUTER JOIN Quote q WITH (NOLOCK) On q.JobID = j.JobID
		OUTER APPLY
		(
			SELECT STUFF((
                SELECT DISTINCT ', ' + e.FullName
                FROM
                    JobEmployee je INNER JOIN Employee e ON je.EmployeeID = e.EmployeeID
                WHERE
                    je.JobID = j.JobID
                FOR XML PATH('')
			), 1, 2, '') [List]
		) surveyors
		LEFT OUTER JOIN @BSRFile rep_BSR ON rep_BSR.JobID = j.JobID
		LEFT OUTER JOIN @BulkSampleClientTemplate bsr_CT ON bsr_CT.JobID=j.JobID
    WHERE
         (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    ORDER BY
         main.Row_Num
    
    
    SET NOCOUNT OFF;
END

GO
/* Paged_CompletedSampleReport end*/

/* IsUnverifiedSampleExchange begin */

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'IsUnverifiedSampleExchange') < 1 BEGIN
	EXEC('CREATE function [dbo].[IsUnverifiedSampleExchange]() returns bit AS BEGIN return 1 END')
END
GO


-- =============================================
-- Author:		John Harding
-- Create date: <11/08/2020>
-- Description:	Logic to determine if the flags passed in indicate an Unverified Sample Exchange
-- =============================================
ALTER  FUNCTION [dbo].[IsUnverifiedSampleExchange]
(
	@IsSampleExchange bit,
	@IsVerified bit,
	@IsAnalysed bit
)
RETURNS bit
AS
BEGIN
	declare @retval as bit
	select @retval = CAST(CASE WHEN ISNULL(@IsSampleExchange,0) = 1 AND ISNULL(@IsVerified,0) = 0 AND @IsAnalysed = 1 THEN 1 ELSE 0 END as BIT)
	
	return @retval		

END

GO
/* IsUnverifiedSampleExchange end */

/* Paged_OpenSurveys begin*/

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OpenSurveys') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OpenSurveys] AS BEGIN SET NOCOUNT ON; END')
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[Paged_OpenSurveys]
	-- Paging
    @PerPage INT = 30,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
	@JobID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchId INT = 0, -- (0=all)
    @EmployeeId INT = 0, -- (0=all)
    @SurveyTypeId VARCHAR(MAX) = '', -- (0=all) 
	@Accessibility INT = 0,-- (0=all, 1=accessible, 2=not accessible)
	@OrgStateId INT = NULL, -- (NULL=all), 0 = Queued
	@ExcludeClientId INT = 0, -- (0=don't exclude any)
    @IsSupplementary INT = 0, --(0=all, 1=non supplementary, 2=only supplementary)
	@IsVerified INT = 0,
	@FilterResults INT = 0,
	@PropertyTypeId INT = 0,
	@BookedByEmployeeId INT = 0 -- (0=all)

	/*
		0              Queued
		2              Import Failed
		5              Preview Generation Failed
		6              Preview Generation Succeeded
		9              Approved Generation Failed
		100         Rejected By Surveyor
		101         Rejected By Quality Control
		200         Awaiting Surveyor Approval
		201         Awaiting Final Approval
	*/
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;


    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		Restricted = 1
      
    DECLARE @OpenSurveysView TABLE (JobID INT, SurveyTypeID INT, Created DATETIME, StartTime DATETIME, DueDate DATETIME, NoAccess BIT, orgStateID INT, orgInstructionID INT,AllRegistersComplete INT, [HasRegister] BIT, IsSupplementary BIT) -- Add columns as necessary

	Insert into @OpenSurveysView (JobID, SurveyTypeID, Created, StartTime, DueDate, NoAccess, orgStateID, orgInstructionID, AllRegistersComplete, [HasRegister], IsSupplementary)
	Select
		jd.JobID, IsNull(su.SurveyTypeID,jd.SurveyTypeID), jd.Created, jd.StartTime, jd.DueDate, 
		CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL /*AND s.SampleID IS NOT NULL*/ THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END [NoAccess], 
		MAX(o.orgStateID) [orgInstructionID], MAX(o.orgInstructionID) [orgInstructionID], MIN(ISNULL(CAST(reg.RegisterComplete as INT),1)) [AllRegistersComplete], MIN(ISNULL(CASE WHEN reg.RegisterID IS NOT NULL THEN 1 ELSE 0 END,0)) [HasRegister], MAX(ISNULL(CASE WHEN sc.JobId IS NOT NULL THEN 1 ELSE 0 END,0)) [IsSupplementary]
	FROM
		(
			SELECT
				empFiltered.JobID,
				empFiltered.RejectedBySurveyor,
				empFiltered.RejectedByQC,
				empFiltered.Created,
				empFiltered.SiteID,
				empFiltered.SurveyTypeID,
				empFiltered.Approved,
				empFiltered.StartTime,
				empFiltered.DueDate
			FROM
				(
					SELECT
						jd.JobID,
						jd.RejectedBySurveyor,
						jd.RejectedByQC,
						jd.Created,
						jd.SiteID,
						jd.SurveyTypeID,
						jd.Approved,
						jd.StartTime,
						jd.DueDate,
						ROW_NUMBER() OVER (PARTITION BY jd.JobID, jd.RejectedBySurveyor, jd.RejectedByQC, jd.Created, jd.SiteID, jd.SurveyTypeID, jd.Approved ORDER BY iat.DateCreated ASC) [Identifier]
					FROM
						(
							Select 
								j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate], MIN(a.AppointmentID) [MinAppointmentID]
							FROM
								Job j WITH (NOLOCK)
								INNER JOIN Quote q WITH (NOLOCK) On q.JobId = j.JobId
								INNER JOIN Appointment a WITH (NOLOCK) On a.QuoteId = q.QuoteId
								INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) On a.AppointmentId = aSurv.AppointmentId
								INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
								INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
								INNER JOIN Survey surv WITH (NOLOCK) ON r.SurveyID = surv.SurveyID

							WHERE
								(
									a.DateDeclined IS NULL
											AND
									j.JobID = CASE WHEN @JobID > 0 AND @ClientID = 0 AND @SiteID = 0 AND @ProjectID = 0 THEN @JobID END
										AND
									j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
								)
									OR
								(
									a.DateDeclined IS NULL
										AND
									(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN r.RegisterFinish BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
											AND		
									(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID!=@ExcludeClientId THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @SurveyTypeId = '' THEN 1 ELSE CASE WHEN ISNULL(surv.SurveyTypeID,aSurv.SurveyTypeID) IN ((select CONVERT(int,s) from dbo.SplitString(ltrim(rtrim(@SurveyTypeId)), ','))) THEN 1 ELSE 0 END END = 1)
										AND
									(CASE WHEN @PropertyTypeId = 0 THEN 1 ELSE CASE WHEN aSurv.PropertyTypeID = @PropertyTypeId THEN 1 ELSE 0 END END = 1)
										AND
									j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
								)
							GROUP BY
								j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved
						) jd
						LEFT OUTER JOIN IntranetAuditTrail iat WITH (NOLOCK) ON iat.DataID=jd.MinAppointmentID AND iat.DataTable='Appointment'
					WHERE
						CASE WHEN @BookedByEmployeeId = 0 THEN 1 ELSE CASE WHEN iat.EmployeeID = @BookedByEmployeeId THEN 1 ELSE 0 END END = 1
			) empFiltered
			WHERE
				empFiltered.Identifier = 1
		) jd
		LEFT OUTER JOIN SupplementaryChanges sc ON sc.JobId=jd.JobID AND @IsSupplementary IN (0,2)
		INNER JOIN Site si WITH (NOLOCK) ON jd.SiteID=si.SiteID
		LEFT OUTER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		LEFT OUTER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId-- AND (@Accessibility IN (0,1))
		LEFT OUTER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId 
		LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID AND na.Deleted IS NULL-- AND (@Accessibility IN (0,2))
		LEFT OUTER JOIN orgInstruction o WITH (NOLOCK) ON o.JobID=jd.JobID AND o.Completed IS NULL AND o.Deleted IS NULL AND ISNULL(NULLIF(o.GenerationType,'survey'),'')=''
		Left Outer Join orgState s On o.orgStateID = s.orgStateID
		Left Outer Join SurveyApproval sa On sa.orgInstructionId = o.orgInstructionId And sa.DateDeleted Is Null
		Left Outer Join JobEmployee saje On saje.JobId = jd.JobId And saje.EmployeeId = sa.EmployeeId And saje.MainEmployee = 1
		Cross Join Config
	WHERE
		(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN je.EmployeeID=@EmployeeId THEN 1 ELSE 0 END END = 1)
			AND
		(
			CASE WHEN @OrgStateId IS NULL THEN 
				1 
			ELSE 
				CASE @OrgStateId
					WHEN 100 THEN
						Case When jd.RejectedBySurveyor = 1 Then 1 ELSE 0 END
					WHEN 101 THEN
						CASE When jd.RejectedByQC = 1 Then 1 ELSE 0 END
					WHEN 200 THEN
						Case When 
						   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
								  And 
						   o.orgStateID = 6 -- Preview Generation Succeeded
								  And
						   sa.SurveyApprovalId IS NOT NULL -- Office Approved
								  And
						   saje.JobEmployeeId IS NULL -- Not Surveyor Approved
						Then 1 Else 0
						End
					WHEN 201 THEN
						Case When
						   sa.SurveyApprovalId IS NOT NULL -- Office Approved
								  And 
						   o.orgStateID = 6 -- Preview Generation Succeeded
						Then 1 Else 0
						End
					WHEN 202 THEN
						CASE When o.orgInstructionID IS NULL Then 1 ELSE 0 END
					ELSE
						CASE WHEN o.orgStateID=@OrgStateId THEN 
							CASE WHEN @OrgStateId = 6 THEN
								CASE WHEN
									jd.RejectedBySurveyor = 0 
										AND 
									jd.RejectedByQC = 0
										AND
									(
										sa.SurveyApprovalId IS NULL
											OR
										(
											NOT ((Config.b__SurveyorApprovalRequired) = 1 AND saje.JobEmployeeId IS NULL)
										)
									)
								THEN 1 ELSE 0 END
							ELSE 1 END
						ELSE 0 END
				END
			END = 1
		)
			AND
		(
			CASE WHEN @Accessibility = 0 THEN
				CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN 
					CASE WHEN reg.DateApproved IS NULL OR jd.Approved IS NULL THEN 
						1 
					ELSE 
						0 
					END 
				ELSE 
					CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) AND jd.Approved IS NULL THEN 
						1
					ELSE 
						0
					END 
				END
			ELSE
				CASE WHEN @Accessibility = 1 THEN
					CASE WHEN reg.DateApproved IS NULL OR jd.Approved IS NULL THEN 
						CASE WHEN reg.RegisterID IS NOT NULL AND CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) THEN 0 ELSE 1 END = 1 THEN 
							1 
						ELSE 
							0 
						END
					ELSE 
						0
					END
				ELSE
					CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END
				END
			End = 1
		)
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
	GROUP BY
		jd.JobID, jd.Created, IsNull(su.SurveyTypeID,jd.SurveyTypeID), jd.StartTime, jd.DueDate, CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN su.SurveyID IS NOT NULL AND reg.RegisterID IS NOT NULL /*AND s.SampleID IS NOT NULL*/ THEN reg.RegisterFinish END,na.Created) THEN 1 ELSE 0 END
	
	Insert into @OpenSurveysView (JobID, SurveyTypeID, Created, StartTime, DueDate, NoAccess, orgStateID, orgInstructionID, AllRegistersComplete, [HasRegister], IsSupplementary)
	Select
		jd.JobID, jd.SurveyTypeID, jd.Created, jd.StartTime, jd.DueDate, 
		1 [NoAccess], 
		NULL [orgInstructionID], NULL [orgInstructionID], 1 [AllRegistersComplete], 0 [HasRegister], 0 [IsSupplementary]
	FROM
		(
			Select 
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved, MIN(a.StartTime) [StartTime], MAX(aSurv.DueDate) [DueDate]
			FROM
				NoAccess na WITH (NOLOCK)
				INNER JOIN Job j WITH (NOLOCK) ON na.JobID=j.JobID
				INNER JOIN Quote q WITH (NOLOCK) ON q.JobId = j.JobId
				INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteId = q.QuoteId
				INNER JOIN AppointmentSurvey aSurv WITH (NOLOCK) ON a.AppointmentId = aSurv.AppointmentId
				LEFT OUTER JOIN @OpenSurveysView osv ON osv.JobID = j.JobID

				LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
				LEFT JOIN Register reg WITH (NOLOCK) ON je.JobEmployeeID = reg.JobEmployeeID
			WHERE
				a.DateDeclined IS NULL
					AND
				osv.JobID IS NULL
					AND
				(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN na.Created BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN j.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID!=@ExcludeClientId THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN j.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchId THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @SurveyTypeId = '' THEN 1 ELSE CASE WHEN aSurv.SurveyTypeID IN ((select CONVERT(int,s) from dbo.SplitString(ltrim(rtrim(@SurveyTypeId)), ','))) THEN 1 ELSE 0 END END = 1)
					AND
				(CASE WHEN @PropertyTypeId = 0 THEN 1 ELSE CASE WHEN aSurv.PropertyTypeID = @PropertyTypeId THEN 1 ELSE 0 END END = 1)
					AND
				na.Created >= ISNULL(reg.RegisterFinish, na.Created)
			GROUP BY
				j.JobID, j.RejectedBySurveyor, j.RejectedByQC, j.Created, j.SiteID, aSurv.SurveyTypeID, j.Approved
		) jd
		INNER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID
		INNER JOIN Site si WITH (NOLOCK) ON jd.SiteID=si.SiteID
		/*
		LEFT OUTER JOIN SupplementaryChanges sc ON sc.JobId=jd.JobID AND @IsSupplementary IN (0,2)
		
		LEFT OUTER JOIN JobEmployee je WITH (NOLOCK) On jd.JobId = je.JobId
		LEFT OUTER JOIN Register reg WITH (NOLOCK) On reg.JobEmployeeId = je.JobEmployeeId-- AND (@Accessibility IN (0,1))
		LEFT OUTER JOIN Survey su WITH (NOLOCK) On reg.SurveyId = su.SurveyId 
		LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = jd.JobID AND na.Deleted IS NULL-- AND (@Accessibility IN (0,2))
		LEFT OUTER JOIN orgInstruction o WITH (NOLOCK) ON o.JobID=jd.JobID AND o.Completed IS NULL AND o.Deleted IS NULL AND ISNULL(NULLIF(o.GenerationType,'survey'),'')=''
		Left Outer Join orgState s On o.orgStateID = s.orgStateID
		Left Outer Join SurveyApproval sa On sa.orgInstructionId = o.orgInstructionId And sa.DateDeleted Is Null
		Left Outer Join JobEmployee saje On saje.JobId = jd.JobId And saje.EmployeeId = sa.EmployeeId And saje.MainEmployee = 1
		*/
		Cross Join Config
	WHERE
		(CASE WHEN @EmployeeId = 0 THEN 1 ELSE CASE WHEN na.EmployeeID=@EmployeeId THEN 1 ELSE 0 END END = 1)
			AND
		(
			CASE WHEN @OrgStateId IS NULL THEN 1 ELSE 0 END = 1
		)
			AND
		(
			CASE WHEN @Accessibility = 0 THEN
				1
			ELSE
				CASE WHEN @Accessibility = 1 THEN
					0
				ELSE
					1
				END
			End = 1
		)
			AND
		(
			  CASE WHEN LEN(@Filter ) = 0 THEN 1 ELSE 
				CASE WHEN
				  (
						si.Address Like '%' + @Filter + '%'
							Or 
						si.Postcode Like '%' + @Filter + '%'
							Or 
						si.Address + ', ' + si.Postcode Like '%' + @Filter + '%'
							Or 
						si.UPRN = @Filter
				  ) THEN 1 ELSE 0 END
			  END = 1
		)
	GROUP BY
		jd.JobID, jd.Created, jd.SurveyTypeID, jd.StartTime, jd.DueDate
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@OpenSurveysView
			)

	DECLARE @OpenSurveyTopLevel TABLE (TotalRows INT, Pages INT, page INT, RowNumber INT, JobID INT, BranchOfficeID INT, ClientID INT, SiteID INT, ReportType VARCHAR(MAX), SurveyTypeID INT, JobNo INT, ClientOrderNo VARCHAR(MAX), StartTime DATETIME, DueDate DATETIME, Client VARCHAR(MAX), SiteAddress VARCHAR(MAX), UPRN VARCHAR(MAX), orgStateID INT, orgInstructionID INT, NoAccess BIT,IsNew BIT, HasNotes BIT, NotesInLastHour BIT, HasRegister BIT, IsSupplementary BIT)
    DECLARE @OpenSurveyRiskFile TABLE (TotalRows INT, Pages INT, page INT, RowNumber INT, JobID INT, BranchOfficeID INT, ClientID INT, SiteID INT, ReportType VARCHAR(MAX), SurveyTypeID INT, JobNo INT, ClientOrderNo VARCHAR(MAX), StartTime DATETIME, DueDate DATETIME, Client VARCHAR(MAX), SiteAddress VARCHAR(MAX), UPRN VARCHAR(MAX), orgStateID INT, orgInstructionID INT, NoAccess BIT,IsNew BIT, HasNotes BIT, NotesInLastHour BIT, HasRegister BIT, IsSupplementary BIT, [RiskFileName] VARCHAR(MAX))
    DECLARE @BulkSampleClientTemplate TABLE (JobID INT, TemplateID INT)
    DECLARE @SurveyData TABLE (JobID INT,FloorplanID INT,FloorplanHasData BIT,SampleID INT,PhotoID INT,HasPhotoData BIT,PhysicalSample BIT,Content BIT,Verified INT,IsSampleExchange INT,SentToSampleExchange INT,AllCheckedIn INT, Analysed INT, SampleCount INT)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.DueDate ASC, a.StartTime ASC)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.DueDate ASC, a.StartTime ASC) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @OpenSurveysView WHERE AllRegistersComplete = 1
            ) a
    )
        
    Insert into @OpenSurveyTopLevel (TotalRows, Pages, page, RowNumber, JobID, BranchOfficeID, ClientID, SiteID, ReportType, SurveyTypeID, JobNo, ClientOrderNo, StartTime, DueDate, Client, SiteAddress, UPRN, orgStateID,orgInstructionID, NoAccess, IsNew, HasNotes, HasRegister, IsSupplementary, NotesInLastHour)
    Select  
		-- Columns for paging
        @TotalRowNumber [TotalRows],
        main.Pages [Pages],
        main.Page [Page],
        main.RowNumber [RowNumber],

		-- ID columns 
        main.JobID [JobID],
		j.BranchOfficeID [BranchOfficeID],
		c.ClientID [ClientID],
		s.SiteId [SiteID],

		-- Columns for grid
		sut.[Description] [ReportType],
		sut.SurveyTypeID,
        j.JobNo [JobNo],
        j.ClientOrderNo [ClientOrderNo],
		main.StartTime [StartDate],
		main.DueDate [DueDate],
		c.Client + IsNull(Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' End, '') [Client],
        s.[Address] + ', ' + s.Postcode [SiteAddress],
		s.UPRN [UPRN],
		main.orgStateID [orgStateID],
		main.orgInstructionID [orgInstructionID],
		main.NoAccess [NoAccess],
		
		-- Columns needed for icons etc.
        CAST(ISNULL(CASE WHEN main.Created > DATEADD(hh,-1,GetDate()) THEN 1 END,0) as BIT) [IsNew],
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
        main.HasRegister,
        main.IsSupplementary,
        CAST(CASE WHEN j.LastNoteCreated IS NOT NULL THEN CASE WHEN j.LastNoteCreated > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour]

    From 
        Paging main
        LEFT OUTER JOIN SurveyType sut WITH (NOLOCK) On main.SurveyTypeID=sut.SurveyTypeID
        
        INNER JOIN Job j On main.JobID = j.JobId
        LEFT OUTER Join Client c On j.ClientID = c.ClientID 
        LEFT OUTER Join Project p On j.ProjectID = p.ProjectID 
        LEFT OUTER Join Site s On j.SiteID = s.SiteID
        
    Where 
        (
            main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
        ) 
            Or 
        (
            @PerPage=0 
                And 
            @CurrentPage=0
        )

	INSERT INTO @BulkSampleClientTemplate (JobID, TemplateID)
    SELECT
		a.JobID, a.TemplateID
    FROM
		(
			Select
				ostl.JobID,
				ct.TemplateID,
				ROW_NUMBER() OVER (PARTITION BY ostl.JobID ORDER BY ct.[Version] DESC) [Identifier]
			FROM 
				@OpenSurveyTopLevel ostl		
				INNER JOIN ClientTemplate ct ON ct.ClientID = ostl.ClientID
				INNER JOIN TemplateType tt ON tt.TemplateTypeID = ct.TemplateTypeID AND tt.TemplateTypeID=14
		) a
	Where
		a.Identifier = 1

	INSERT INTO @OpenSurveyRiskFile (TotalRows,Pages,page,RowNumber,JobID,BranchOfficeID,ClientID,SiteID,ReportType,SurveyTypeID,StartTime,DueDate,Client,SiteAddress,UPRN,orgStateID,orgInstructionID,NoAccess,IsNew,HasNotes,NotesInLastHour,HasRegister,IsSupplementary,RiskFileName)
	SELECT
		main.TotalRows, 
		main.Pages, 
		main.page, 
		main.RowNumber, 
		main.JobID,
		main.BranchOfficeID, 
		main.ClientID, 
		main.SiteID, 
		main.ReportType,
		main.SurveyTypeID, 
		main.StartTime, 
		main.DueDate, 
		main.Client, 
		main.SiteAddress, 
		main.UPRN,
		main.orgStateID, 
		main.orgInstructionID,
		main.NoAccess,
		main.IsNew, 
		main.HasNotes, 
		main.NotesInLastHour,
		main.HasRegister,
		main.IsSupplementary,
		main.[RiskFileName]
	FROM
	(
		Select
			ostl.TotalRows, 
			ostl.Pages, 
			ostl.page, 
			ostl.RowNumber, 
			ostl.JobID, 
			ostl.BranchOfficeID, 
			ostl.ClientID, 
			ostl.SiteID, 
			ostl.ReportType,
			ostl.SurveyTypeID, 
			ostl.StartTime, 
			ostl.DueDate, 
			ostl.Client, 
			ostl.SiteAddress, 
			ostl.UPRN,
			ostl.orgStateID, 
			ostl.orgInstructionID,
			ostl.NoAccess,
			ostl.IsNew, 
			ostl.HasNotes, 
			ostl.NotesInLastHour,
			ostl.HasRegister,
			ostl.IsSupplementary,
			PDF.[FileName] [RiskFileName],
			ROW_NUMBER() OVER (PARTITION BY ostl.JobID ORDER BY PDf.DateCreated DESC) [Identifier]
		FROM
			@OpenSurveyTopLevel ostl
			LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = ostl.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] NOT LIKE '%bsr%' AND PDF.[FileName] LIKE '%ra%'
	) main
	WHERE
		main.Identifier = 1

	Insert into @SurveyData (JobID,FloorplanID,FloorplanHasData,SampleID,PhotoID,HasPhotoData,PhysicalSample,Content,Verified,IsSampleExchange,SentToSampleExchange,AllCheckedIn,Analysed, SampleCount)
	Select 
		osrf.JobId,
		fp.FloorplanID,
		CAST(CASE WHEN fp.AutocadDataContentType IS NOT NULL THEN 1 ELSE 0 END as BIT) [FloorplanHasData],
		s.SampleID,
		p.PhotoID,
		CAST(CASE WHEN p.ContentType IS NOT NULL THEN 1 ELSE 0 END as BIT) [PhotoHasData],
		CAST(CASE WHEN s.SampleRef Is NOT Null And s.AsSample = 0 And s.SampleRef Not Like '%{%}%' And s.SampleRef Not Like '%*%' THEN 1 ELSE 0 END as BIT) [PhysicalSample],
		Cast(IsNull(reg.ReportInformationId,0) as bit) [Content],
		Cast(CASE WHEN j.SampleResultEmployeeID IS NOT NULL THEN 1 ELSE 0 END as bit) [Verified],
		Case When Not l.ServerCode Is Null Then 1 Else 0 End [IsSampleExchange],
		Case When Not s.SampleExchangeSampleId Is Null Then 1 Else 0 End [SentToSampleExchange],
		CASE WHEN s.LaboratoryID IS NULL THEN 0 ELSE 1 END [AllCheckedIn],
		CASE WHEN s.DateAnalysed IS NULL THEN 0 ELSE 1 END [Analysed],
		samp.sampCount
	From 
		@OpenSurveyRiskFile osrf
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=osrf.JobID
		INNER JOIN JobEmployee je WITH (NOLOCK) On osrf.JobId = je.JobId
		INNER JOIN Register reg WITH (NOLOCK) On je.JobEmployeeId = reg.JobEmployeeId
		INNER JOIN Floorplan fp WITH (NOLOCK) On reg.RegisterId = fp.RegisterId
		LEFT OUTER JOIN Room rm WITH (NOLOCK) On fp.FloorplanId = rm.FloorplanId
		LEFT OUTER JOIN Sample s WITH (NOLOCK) On rm.RoomId = s.RoomId
		LEFT OUTER JOIN Photo p WITH (NOLOCK) on s.PhotoID = p.PhotoID
		LEFT OUTER JOIN Laboratory l WITH (NOLOCK) On s.LaboratoryId = l.LaboratoryId
		OUTER APPLY
		(
			SELECT
				COUNT(SampleID) [sampCount]
			FROM
				Job j
				INNER JOIN JobEmployee je ON j.JobID = je.JobID
				INNER JOIN Register r ON je.JobEmployeeID = r.JobEmployeeID
				INNER JOIN Room rm ON r.RegisterID = rm.RegisterID
				INNER JOIN Sample s ON rm.RoomID = s.RoomID AND s.SampleRef IS NOT NULL AND s.SampleRef NOT LIKE '%{%' AND s.SampleRef NOT LIKE '%*%' AND s.AsSample = 0
			WHERE
				j.JobID = osrf.JobID					
		) samp

	SELECT
		fd.TotalRows, 
		fd.Pages, 
		fd.page [Page], 
		fd.RowNumber, 
		fd.JobID, 
		fd.JobNo,
		fd.ClientOrderNo,
		fd.BranchOfficeID, 
		fd.ClientID, 
		fd.SiteID, 
		fd.ReportType,
		fd.SurveyTypeID [SurveyTypeID], 
		fd.StartTime, 
		fd.DueDate, 
		fd.Client, 
		fd.SiteAddress, 
		fd.UPRN,
		orgDetail.State [OrgState], 
		CAST(ISNULL(fd.NoAccess,0) as BIT) [NoAccess],
		CAST(CASE WHEN Content.JobID IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasContent],
		CAST(CASE WHEN plans.JobID IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasPlans],
		ISNULL(Photos.UploadedPhotos,0) [UploadedPhotos],
		ISNULL(Photos.PhotoRecords,0) [PhotoRecords],
		CAST(case when CAST(ISNULL(sd.Verified,1) as BIT) = 1 
			or dbo.IsUnverifiedSampleExchange(sd.IsSampleExchange,sd.Verified,sd.Analysed) = 1			
			then 
				1
			else 
				0 
			end AS bit) [HasResults], --If IsVerified is null, means no samples therefore no results to check so it has results. If IsUnverifiedSampleExchange = 1 it also counts as having results.
		fd.IsNew, 
		fd.HasNotes, 
		fd.NotesInLastHour,
		fd.[RiskFileName],
		fd.BulkSampleReport,
		fd.HasRegister [HasRegister],
		fd.IsSupplementary [IsSupplementary],
		bsct.TemplateID [BulkSampleClientTemplateID],
		CAST(ISNULL(sd.IsSampleExchange,0) as BIT) [IsSampleExchange],
		CAST(ISNULL(sd.SentToSampleExchange,0) as BIT) [SentToSampleExchange],
		CAST(ISNULL(sd.[AllCheckedIn],1) as BIT) [AllCheckedIn],
		CAST(CASE WHEN sd.JobId IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasSamples],
		CAST(ISNULL(sd.Verified,0) as BIT) [IsVerified],
		dbo.IsUnverifiedSampleExchange(sd.IsSampleExchange,sd.Verified,sd.Analysed) as [IsUnverifiedSampleExchange],
		CAST(CASE WHEN ISNULL(sd.IsSampleExchange,0) = 1 AND ISNULL(sd.Verified,0) = 0 AND sd.Analysed = 1 THEN 1 ELSE 0 END as BIT) [IsUnverifiedSampleExchange], -- Logic also used in HasResults 
		fd.FullName [Surveyor],
		sd.SampleCount,
		fd.ProjectManager
	FROM
	(
		SELECT
			main.TotalRows, 
			main.Pages, 
			main.page, 
			main.RowNumber, 
			main.JobID,
			main.BranchOfficeID, 
			main.ClientID, 
			main.SiteID, 
			main.ReportType, 
			main.SurveyTypeID,
			main.StartTime, 
			main.DueDate, 
			main.Client, 
			main.SiteAddress, 
			main.UPRN,
			main.orgStateID, 
			main.NoAccess,
			main.IsNew, 
			main.HasNotes, 
			main.NotesInLastHour,
			main.HasRegister,
			main.IsSupplementary,
			main.[RiskFileName],
			main.[BulkSampleReport],
			main.JobNo,
			main.ClientOrderNo,
			main.Fullname,
			main.[ProjectManager]
		FROM
		(
			Select
				osrf.TotalRows, 
				osrf.Pages, 
				osrf.page, 
				osrf.RowNumber, 
				osrf.JobID, 
				osrf.BranchOfficeID, 
				osrf.ClientID, 
				osrf.SiteID, 
				osrf.ReportType, 
				osrf.SurveyTypeID,
				osrf.StartTime, 
				osrf.DueDate, 
				osrf.Client, 
				osrf.SiteAddress, 
				osrf.UPRN,
				osrf.orgStateID, 
				osrf.NoAccess,
				osrf.IsNew, 
				osrf.HasNotes, 
				osrf.NotesInLastHour,
				osrf.HasRegister,
				osrf.[IsSupplementary],
				osrf.RiskFileName,
				PDF.[FileName] [BulkSampleReport],
				ROW_NUMBER() OVER (PARTITION BY osrf.JobID ORDER BY PDf.DateCreated DESC) [Identifier],
				j.JobNo,
				j.ClientOrderNo,
				j.SampleResultEmployeeID,
				e.FullName,
				projEmp.FullName [ProjectManager]
			FROM
				@OpenSurveyRiskFile osrf
				INNER JOIN Job j ON osrf.JobID=j.JobID
				LEFT OUTER JOIN PDF WITH (NOLOCK) ON PDF.JobID = osrf.JobID AND PDF.DateDeleted IS NULL AND PDF.[FileName] LIKE '%bsr%' AND PDF.[FileName] NOT LIKE '%ra%'
				LEFT OUTER JOIN JobEmployee je ON j.JobID = je.JobID
				LEFT OUTER JOIN Employee e ON je.EmployeeID = e.EmployeeID
				LEFT JOIN Employee projEmp ON j.ProjectManagerID = projEmp.EmployeeID
		) main
		WHERE
			main.Identifier = 1
	) fd
	LEFT OUTER JOIN @BulkSampleClientTemplate bsct ON bsct.JobID=fd.JobID
	LEFT OUTER JOIN 
	(
		SELECT 
			sd.JobID,
			MAX(sd.Verified) [Verified],
			MAX(sd.IsSampleExchange) [IsSampleExchange],
			MAX(sd.SentToSampleExchange) [SentToSampleExchange],
			MIN(sd.AllCheckedIn) [AllCheckedIn],
			MAX(sd.[Analysed]) [Analysed],
			sd.SampleCount
		FROM
			@SurveyData sd
		WHERE
			sd.PhysicalSample = 1
		GROUP BY sd.JobID, sd.SampleCount
	) sd ON fd.JobID=sd.JobID
    LEFT OUTER JOIN 
	(
		SELECT JobID FROM @SurveyData sd WHERE sd.Content = 1 GROUP BY sd.JobId
	) Content ON fd.JobID=Content.JobID
    LEFT OUTER JOIN 
	(
		SELECT JobID FROM @SurveyData sd WHERE sd.FloorplanHasData = 1 GROUP BY sd.JobId
	) Plans ON fd.JobID=Plans.JobID
    LEFT OUTER JOIN 
	(
		SELECT sd.JobID, SUM(CASE WHEN sd.PhotoID IS NOT NULL THEN 1 ELSE 0 END) [PhotoRecords], SUM(CASE WHEN NULLIF(sd.HasPhotoData,0) IS NOT NULL THEN 1 ELSE 0 END) [UploadedPhotos] FROM @SurveyData sd GROUP BY sd.JobID
	) Photos ON fd.JobID=Photos.JobID
    LEFT OUTER JOIN
    (
		Select
			osrf.JobID,
			Case
				 When 
					   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
							  And
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And
					   Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
				 Then
					   'Awaiting Surveyor Approval'

				 When
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
				 Then
					   'Awaiting Final Approval'
			     
				 Else
					   Case
							  When osrf.orgStateID = 0 Then
									 'Queued'
							  Else
									 s.ShortDescription
					   End

			End [State],
			Case 
				 When 
					   (Config.b__SurveyorApprovalRequired) = 1 -- Surveyor Approval Required
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
							  And
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And
					   Count(je.JobEmployeeId) = 0 -- Not Surveyor Approved
				 Then
					   'The preview PDF has been approved but requires the surveyors approval.'

				 When
					   Count(sa.SurveyApprovalId) > 0 -- Office Approved
							  And 
					   osrf.orgStateID = 6 -- Preview Generation Succeeded
				 Then
					   'The preview PDF has been pre-approved and is waiting final approval.'
			     
				 Else
					   Case
							  When osrf.orgStateID = 0 Then
									 'The report has been added to the queue.'
							  Else
									 s.Description
					   End
			End [StateDescription]
		From
			   @OpenSurveyRiskFile osrf
			   Left Outer Join orgState s On osrf.orgStateID = s.orgStateID
			   Cross Join Config
			   Left Outer Join SurveyApproval sa On sa.orgInstructionId = osrf.orgInstructionId And sa.DateDeleted Is Null
			   Left Outer Join JobEmployee je On je.JobId = osrf.JobId And je.EmployeeId = sa.EmployeeId And je.MainEmployee = 1
		GROUP BY
			osrf.JobID,Config.b__SurveyorApprovalRequired, osrf.orgStateID,s.ShortDescription,s.Description
    ) orgDetail ON fd.JobID=orgDetail.JobID
WHERE
	(CASE 
		WHEN @IsVerified = 0 THEN 1 
		ELSE 
			CASE 
				WHEN sd.Verified > 0 OR sd.JobId IS NULL THEN 1 
				ELSE 0 
			END 
	END) = 1

    SET NOCOUNT OFF;
END
GO


/* Paged_OpenSurveys end */

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetScheduled') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetScheduled] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_NotYetScheduled]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @Site VARCHAR(MAX) = NULL,
    @QuoteID INT = 0,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
	@QuoteTypeID INT = 0,

	-- Order bys
    @OrderByAccepted INT = 0,
    @OrderByQuoteNo INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByNotes INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Scheduled tab. Replaces the NotYetScheduled view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Site = NULLIF(LTRIM(RTRIM(@Site)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByAccepted = 0 AND @OrderByQuoteNo = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByNotes = 0
    BEGIN
        SET @OrderByAccepted = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByAccepted [OrderByAccepted],
        @OrderByQuoteNo [OrderByQuoteNo],
        @OrderByClient [OrderByClient],
        @OrderBySite [OrderBySite],
        @OrderByNotes [OrderByNotes]
    */

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Get all the Not Yet Scheduled data - just the minimum ammount of data for speed.
    DECLARE @NotYetScheduledData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, Notes VARCHAR(MAX), Accepted DATETIME, ClientID INT, Client VARCHAR(210), ProjectID INT, SiteID INT, Site VARCHAR(220), RemovalID INT, IsBackFromMobileTeams BIT, IsRemovalQuoteVisit BIT, IsRemovalWorkVisit BIT)
    
    INSERT INTO @NotYetScheduledData
    SELECT
        q.QuoteID,
        q.QuoteNo,
        q.Notes,
        q.Accepted,
        q.ClientID,
        q.Client,
        q.ProjectID,
        q.SiteID,
        q.Site,
        q.RemovalID,
        q.IsBackFromMobileTeams,
        q.IsRemovalQuoteVisit,
        q.IsRemovalWorkVisit
    FROM
        (
            SELECT
                q.QuoteID,
                q.QuoteNo,
                ISNULL(NULLIF(q.Status, ''), q.DetailsOfWork) [Notes],
                q.Accepted,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                q.ProjectID,
                si.SiteID,
                si.Address + ISNULL(', ' + NULLIF(si.Postcode, ''), '') [Site],
                rem.RemovalID, -- Also get the Removal columns, so we don't have to hit the View twice.
                rem.IsBackFromMobileTeams,
                rem.IsRemovalQuoteVisit,
                rem.IsRemovalWorkVisit
            FROM
                Quote q WITH (NOLOCK)
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID -- Remove to include Sample quotes.
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Removals rem WITH (NOLOCK) ON q.QuoteID = rem.QuoteID
				LEFT JOIN Project p WITH (NOLOCK) ON q.QuoteID = p.QuoteID
            WHERE
                q.Rejected IS NULL -- Not rejected.
                    AND
                q.Accepted IS NOT NULL -- Has been accepted.
                    AND
                (
                    ( -- Logic for most quotes.
                        (
                            qt.QuoteType != 'Removals (Notifiable)'
                                AND
                            qt.QuoteType != 'Removals (Non-Notifiable)'
                        )
                            AND
                        NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE QuoteID = q.QuoteID AND AppointmentTypeID != 8)
                            AND
                        q.JobID IS NULL
                            AND
                        NOT EXISTS (SELECT 1 FROM ProjectAppointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            AND
                        (
                            q.SiteID IS NOT NULL
                                OR
                            (
                                q.SiteID IS NULL
                                    AND
                                NOT EXISTS (SELECT 1 FROM Appointment WITH (NOLOCK) WHERE ProjectID = q.ProjectID)
                            )
                        )
                    )
                        OR
                    ( -- Logic for Removal quotes.
                        (
                            qt.QuoteType = 'Removals (Notifiable)'
                                OR
                            qt.QuoteType = 'Removals (Non-Notifiable)'
                        )
                            AND
                        ISNULL(rem.isBackFromMobileTeams, 0) = 1
                            AND
                        ISNULL(rem.isRemovalQuoteVisit, 0) = 1
                            AND
                        -- Make sure neither the Quote visit or Site visit for the Quote has no Appointment.
                        NOT EXISTS (SELECT 1 FROM Removals WITH (NOLOCK) WHERE RemovalID = rem.RemovalID AND AppointmentID IS NOT NULL AND ISNULL(isRemovalWorkVisit, 0) = 1 AND ISNULL(isBackFromMobileTeams, 0) = 1)
                    )
                )
                    AND
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR q.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                q.Accepted BETWEEN @FilterStartDate AND @FilterFinishDate
                    AND
                (@QuoteID = 0 OR q.QuoteID = @QuoteID)
					AND
				(@QuoteTypeID = 0 OR q.QuoteTypeID = @QuoteTypeID)
					AND
				p.ProjectID IS NULL
					AND
				c.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
        ) q
    WHERE
        (@Site IS NULL OR q.Site LIKE '%' + @Site + '%')
    ORDER BY
        CASE WHEN @OrderByAccepted = 1 THEN q.Accepted ELSE NULL END ASC,
        CASE WHEN @OrderByAccepted = 2 THEN q.Accepted ELSE NULL END DESC,
        CASE WHEN @OrderByQuoteNo = 1 THEN q.QuoteNo ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteNo = 2 THEN q.QuoteNo ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN q.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN q.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN q.Site ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN q.Site ELSE NULL END DESC,
        CASE WHEN @OrderByNotes = 1 THEN q.Notes ELSE NULL END ASC,
        CASE WHEN @OrderByNotes = 2 THEN q.Notes ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetScheduledData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((a.IndexID - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetScheduledData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.IndexID [Row_Num],
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        pag.Notes,
        q.Created,
        CAST(CASE WHEN q.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Accepted,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        qt.QuoteTypeID,
        qt.QuoteType,
        pag.ClientID,
        pag.Client,
        p.ProjectID,
        p.ProjectGroupID,
        NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
        pag.SiteID,
        si.Address,
        si.Postcode,
        pag.Site,
        si.UPRN,
        pag.RemovalID,
        pag.IsBackFromMobileTeams,
        pag.IsRemovalQuoteVisit,
        pag.IsRemovalWorkVisit,
		q.Value,
		q.CurrencyId [CurrencyID],
		q.ClientOrderNo
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN Project p WITH (NOLOCK) ON pag.ProjectID = p.ProjectID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
    WHERE
        (pag.IndexID BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.IndexID
    
    
    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS(select 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE upper(TABLE_NAME) = 'Airsample' AND upper(COLUMN_NAME) = 'DateCreated')
BEGIN
	ALTER TABLE Airsample
		ADD DateCreated datetime
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'IsDocumentAttached') < 1 BEGIN
	EXEC('CREATE function [dbo].[IsDocumentAttached]() returns bit AS BEGIN return 1 END')
END

GO


ALTER function [dbo].[IsDocumentAttached]
	(         
		@AppointmentId as int,
		@DocumentId as int,
		@DocumentType as varchar(50)
	 )
RETURNS bit
AS
BEGIN
	declare @IsAttached as bit
	
	select @IsAttached =  case when exists(select 
				AppointmentAttachmentId 
			  from 
				AppointmentAttachment 
			  where 
				Appointmentid = @AppointmentId
				and DocumentType = @DocumentType
				and DocumentId = @DocumentId
	) then 1 else 0 end	

	Return @IsAttached
END

GO

IF NOT EXISTS(select 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Config' AND COLUMN_NAME = 'i_AppointmentAttachmentsMonthsInPast')
BEGIN
	alter table Config add i_AppointmentAttachmentsMonthsInPast int default(24) not null 
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'AppointmentPotentialAttachments') < 1 BEGIN
	EXEC('CREATE PROCEDURE [AppointmentPotentialAttachments] AS BEGIN SET NOCOUNT ON; END')
END

GO
/*
	Returns potential email document attachments for an Apppointment
*/
ALTER   procedure [dbo].[AppointmentPotentialAttachments](@AppointmentId as int)
as
SET NOCOUNT ON
SET ANSI_WARNINGS OFF

declare @ClientId as int;
declare @SiteId as int;
declare @AppointmentTypeId as int
declare @MonthsToSearchAttachmentsFor as int 

-- Get the config value for the number of months in the past to search for survey report attachments
-- default to 12 months if value is zero
select top 1 @MonthsToSearchAttachmentsFor  = (case when i_AppointmentAttachmentsMonthsInPast = 0 then 12 else i_AppointmentAttachmentsMonthsInPast end * -1) from Config 

	Select  top 1   		
		a.AppointmentId,
		a.AppointmentTypeID,
	    isnull(e.EnquiryId,0) as EnquiryId,
	    isnull(q.QuoteId,0) as QuoteId,
	    isnull(q.ParentId,0) as ParentQuoteId,
	    isnull(j.JobId,0) as JobId,
        isnull(q.ProjectId,0) as QuoteProjectId,
        isnull(j.ProjectId,0) as JobProjectId,
        isnull(j.SiteID,0) as SiteID,
		isnull(a.ClientID,0) as ClientId,
		isnull(jp.ProjectGroupId,0) as JobProjectGroupId,
		isnull(qp.ProjectGroupId,0) as QuoteProjectGroupId		
	into 
		#AppointmentData
    From
        Appointment a
        Inner Join Quote q On a.QuoteId = q.QuoteId  And q.Rejected Is Null
        Inner Join Job j On q.JobID = j.JobId And j.Cancelled Is Null
        Left Outer Join Enquiry e On q.QuoteId = e.QuoteId And e.DateDiscarded Is Null
		left outer join Project jp on jp.ProjectId = j.ProjectID and jp.Deleted is null
		left outer join Project qp on qp.ProjectId = q.ProjectID and qp.Deleted is null		
	where 
		AppointmentId = @AppointmentId		



select 
	@ClientId = ClientId,
	@SiteID = SiteId,
	@AppointmentTypeId = AppointmentTypeID
from 
	#AppointmentData
where 
	AppointmentId = @AppointmentId



	Select	
		d.DocumentId,
		d.DocumentType,
		d.DocumentTypeId,
		d.DocumentTypeRef,
		d.FileName,
		d.Extension,
		dbo.FormatTeamsDate(d.Uploaded, 2) as UploadedChar,
		d.Employee,			
		dbo.IsDocumentAttached(@AppointmentId,d.DocumentId,d.DocumentType) as IsAttached,						
		cast(case when d.uploaded is null then 0 else 1 end as bit) as Uploaded,
		d.Uploaded as SortDate		
	From																
		Documents d 						
		cross join #AppointmentData ad 		
	Where			
		(d.DocumentType = 'Job' And d.DocumentTypeId = ad.JobId) 
		Or (d.DocumentType = 'Quote' And (d.DocumentTypeId = ad.QuoteId  Or d.DocumentTypeId = ad.ParentQuoteId)) 
		Or (d.DocumentType = 'Enquiry' And d.DocumentTypeId = ad.EnquiryId)
		Or (d.DocumentType = 'Site' And d.DocumentTypeId = ad.SiteId) 
		or (d.DocumentType = 'Project' and d.DocumentTypeId = ad.QuoteProjectGroupId)
		or (d.DocumentType = 'Project' and d.DocumentTypeId = ad.JobProjectGroupId)				
union 
		Select 								
				oi.orgInstructionID as DocumentId,
				'Report' as DocumentType,
				oi.orgInstructionId as DocumentTypeId,
				dbo.FormatTeamsReference('J', oi.JobNo)  as DocumentTypeRef,
				dbo.FormatTeamsReference('J', oi.JobNo)+'-'+ltrim(rtrim(isnull(oi.SurveyType,'MISSING')))+'.'+Right(pdfDestination, PatIndex('%.%', Reverse(pdfDestination)) - 1) as [FileName],				
				'pdf' as Extension,
				dbo.FormatTeamsDate(oi.DateApproved, 2) as UploadedChar,
				e.FullName as Employee,
				dbo.IsDocumentAttached(@AppointmentId,oi.orgInstructionID,'Report') as IsAttached,				
				cast(1 as Bit) as Uploaded,
				oi.DateApproved as SortDate				
		from 
				(
				select 
					*
				from
					( 
					select distinct
						row_number() over(partition by oi.JobId order by DateApproved desc) as RowNo,						
						j.ClientID,
						j.SiteID,
						j.JobNo,
						oi.JobId,
						oi.orgInstructionID,
						oi.DateApproved,
						oi.pdfDestination,
						ApprovedEmployeeID,
						qt.QuoteType as SurveyType
					from																				
						dbo.Quote q 
						Inner Join dbo.Job j On q.JobID = j.JobId  and j.Cancelled Is Null And q.Rejected Is Null 
						inner join dbo.orgInstruction oi  on j.JobId = oi.JobId 
						inner join QuoteType qt on q.QuoteTypeID = qt.QuoteTypeID
					where
						DateApproved >= dateadd(month, @MonthsToSearchAttachmentsFor, getdate())	
						and orgStateId = 10
						and oi.GenerationType is null
						and oi.Deleted is null	
						and j.SiteID = @SiteId
						and j.ClientID = @ClientId						
						and @AppointmentTypeID = 1 -- If the appointment passed in is not a Survey return nothing
				) as final
					where
						final.RowNo = 1
			) as oi 
				inner join Employee e on e.EmployeeID = oi.ApprovedEmployeeID				
		Order By
				SortDate desc				
GO



GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'AppointmentAttachments') < 1 BEGIN
	EXEC('CREATE PROCEDURE [AppointmentAttachments] AS BEGIN SET NOCOUNT ON; END')	
END

GO

alter procedure [dbo].[AppointmentAttachments](@AppointmentId as int)
as


Select 
	d.DocumentType, 
	d.DocumentTypeId, 
	d.FileName,
	Uploaded 
From 
	Documents d WITH (NOLOCK) 
	Inner Join AppointmentAttachment aa WITH (NOLOCK) On aa.AppointmentId = @AppointmentId And d.DocumentId = aa.DocumentId And d.DocumentType = aa.DocumentType 
	INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID = @AppointmentId AND a.DateDeclined IS NULL 
where
	d.DocumentType != 'Report'
UNION 
Select 
	'Report' DocumentType, 
    orgInstructionId as DocumentTypeId, 
	pdfDestination as [FileName],
	DateApproved as Uploaded
From 
	orgInstruction d WITH (NOLOCK) 
	Inner Join AppointmentAttachment aa WITH (NOLOCK) On aa.AppointmentId = @AppointmentId And d.orgInstructionID = aa.DocumentId And aa.DocumentType = 'Report' 
	INNER JOIN Appointment a WITH (NOLOCK) ON a.AppointmentID = @AppointmentId AND a.DateDeclined IS NULL
Order By 
	Uploaded
GO



if not exists(SELECT * FROM sys.indexes WHERE name='IDX_AppointmentAttachment_ApptDocType' AND object_id = OBJECT_ID('dbo.AppointmentAttachment'))
begin 

CREATE NONCLUSTERED INDEX [IDX_AppointmentAttachment_ApptDocType] ON [dbo].[AppointmentAttachment]
( 
	[AppointmentId] ASC,			
	[DocumentId] ASC,
	[DocumentType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

end
GO


IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Config') AND name='s__FeatureRequestBlockText') < 1
BEGIN
  ALTER TABLE Config
      ADD s__FeatureRequestBlockText VARCHAR(MAX) NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'FN' AND name = 'WorkingDaysInterval') < 1 BEGIN
	EXEC('CREATE FUNCTION [dbo].[WorkingDaysInterval] ( @StartDate DATETIME, @FinishDate DATETIME ) RETURNS INT BEGIN RETURN 0 END;')
END
GO

ALTER FUNCTION [dbo].[WorkingDaysInterval]
(
    @StartDate DATETIME,
    @FinishDate DATETIME
)
RETURNS INT
AS

BEGIN

DECLARE
	@WorkingStartDate DATETIME = @StartDate,
	@WorkingInterval INT = 0

WHILE @WorkingStartDate < @FinishDate
BEGIN
	
	SET @WorkingStartDate = DATEADD(DAY, 1, @WorkingStartDate)

	IF DATEPART(WEEKDAY, @WorkingStartDate) NOT IN (1, 7) AND NOT EXISTS (SELECT * FROM TeamsBankHoliday WHERE BankHolidayDate = @WorkingStartDate)
	BEGIN
		SET @WorkingInterval = @WorkingInterval + 1
	END
	
END

RETURN NULLIF(@WorkingInterval, 0)

END      
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'getClientEmailFromJobIDOrInvoiceID') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[getClientEmailFromJobIDOrInvoiceID] AS BEGIN SET NOCOUNT ON; END')
END

GO  

ALTER PROCEDURE [dbo].[getClientEmailFromJobIDOrInvoiceID]
      @jobid INT = NULL,
      @invoiceid INT = NULL

AS
BEGIN
    SET NOCOUNT ON
    --debug
        --DECLARE @jobid int, @invoiceid int        
        --SET @jobid = 39090
    --end debug
    
    DECLARE @clientid [int]
    DECLARE @contactID [int]
    DECLARE @client varchar(max)
    DECLARE @contact varchar(max)
    DECLARE @email varchar(MAX)
    DECLARE @address varchar(max)
    DECLARE @jobno varchar(max)
    DECLARE @invoiceno varchar(MAX)
    
    DECLARE @isJob AS bit=0,@isAirTest AS bit=0, @isInvoice AS bit=0,@isbulk AS bit=0
    
    set @client =NULL 
    set @contact =NULL 
    set @email =NULL 
    set @address =NULL 
    SET @jobno =NULL 
    set @invoiceno =NULL 
    
    /*GET DEFAULTS contactid FROM WORK ITEM LEVEL
    */
    
    IF NOT @invoiceid IS NULL
    BEGIN
        SELECT
            @invoiceno = [dbo].[FormatTeamsReference]('I',[i].InvoiceNo),
            @clientid=[i].[ClientID],
            @contactID = [i].[ContactId],
            @address = ''
        FROM 
            invoice i 
        WHERE 
            [i].[invoiceid] = @invoiceid
        
        SELECT @isInvoice = 1
    END
    ELSE
    BEGIN
        IF NOT @jobid IS NULL
        BEGIN

            SELECT 
                @jobno = [dbo].[FormatTeamsReference]('J',j.jobno),
                @clientid=[j].[ClientID],
                @contactID = coalesce([j].[ContactId],[q].[ContactId]),
                @address = [si].[Address],
                @isJob = CASE WHEN qt.[quotetypeid]!=5 THEN 1 ELSE 0 END ,
                @isAirTest = CASE WHEN qt.[quotetypeid] = 5 THEN 1 ELSE 0 end
            FROM 
                [dbo].[Job] j 
                INNER JOIN [dbo].[Quote] q ON j.[JobID] = [q].[JobID]
                INNER JOIN [dbo].[Site] si ON [si].[SiteID] = [j].[SiteID]
                INNER JOIN [dbo].[QuoteType] qt ON q.[QuoteTypeID]= [qt].[quotetypeid]
                --LEFT OUTER JOIN 
                --( 
                    --SELECT TOP 1
                        --je.JobID,
                        --CASE WHEN reg.[RegisterID] IS NOT NULL  THEN 
                            --1
                        --ELSE
                            --0
                        --END,
                        --CASE WHEN airt.[AirTestID] IS NOT NULL  THEN 
                            --1
                        --ELSE
                            --0
                        --END
                    --FROM 
                        --dbo.JobEmployee je
                        --LEFT OUTER JOIN dbo.Register reg ON reg.JobEmployeeID = je.JobEmployeeID
                        --LEFT OUTER JOIN dbo.AirTest airt ON airt.JobEmployeeID = je.JobEmployeeID
                    --WHERE
                        --NOT (reg.RegisterID IS NULL AND airt.AirTestID IS NULL) 
                --) firstreg(jobid, job, airtest) ON j.JobID = firstreg.jobid
            WHERE [j].[JobID] = @jobid


            IF @isJob=1
            BEGIN
                --is a job, but it is a bulk survey (has rooms but no floors)
                
                    if not EXISTS(
                        SELECT TOP 1 
                            'x'
                        FROM
                            [dbo].[Job] _j
                            INNER JOIN jobemployee _je ON [_j].[JobID] = _je.[JobID]
                            INNER JOIN [dbo].[Register] _reg ON [_reg].[JobEmployeeID] = [_je].[JobEmployeeID]
                            INNER JOIN [dbo].[Room] _room ON [_room].[RegisterID] = [_reg].[RegisterID]
                            INNER JOIN [dbo].[Floorplan] _fp ON _room.[RegisterID] = _fp.[RegisterID]
                        WHERE
                            _j.jobid = @jobid
                    )
                    begin
                        SELECT
                            @isbulk = 1,
                            @isJob = 0
                            
                        --print 'isbulk'
                    END
                    --ELSE
                    --BEGIN
                        --print 'isjob '    
                    --END 
            END 
            
            
        END
    END 
    
    /*now get from the client, default contact info and email with client name along with client overrides*/
    DECLARE 
        @ApprovalEmailSurvey_USE_MainContact                AS bit,
        @ApprovalEMailAirTest_USE_MainContact               AS bit,
        @ApprovalEmailBulk_USE_MainContact                  AS bit,
        @InvoiceCompleteEmail_USE_MainContact               AS bit,
        @ApprovalEmailSurvey_AdditionalContactInfoID        AS int,
        @ApprovalEMailAirTest_AdditionalContactInfoID       AS int,
        @ApprovalEmailBulk_AdditionalContactInfoID          AS int,
        @InvoiceCompleteEmail_AdditionalContactInfoID       AS int
        
            
    SELECT
        @client = [c].[Client],
        @contact =  c.MainContact, 
        @email = ISNULL(c.MainContact,'')  + ' <' + [c].[Email] + '>',
        @ApprovalEmailSurvey_USE_MainContact             =   isnull(ApprovalEmailSurvey_USE_MainContact,0),
        @ApprovalEMailAirTest_USE_MainContact            =   isnull(ApprovalEMailAirTest_USE_MainContact,0),
        @ApprovalEmailBulk_USE_MainContact               =   isnull(ApprovalEmailBulk_USE_MainContact,0),
        @InvoiceCompleteEmail_USE_MainContact            =   ISNULL(InvoiceCompleteEmail_USE_MainContact,0),
        @ApprovalEmailSurvey_AdditionalContactInfoID     =   ApprovalEmailSurvey_AdditionalContactInfoID ,
        @ApprovalEMailAirTest_AdditionalContactInfoID    =   ApprovalEMailAirTest_AdditionalContactInfoID ,
        @ApprovalEmailBulk_AdditionalContactInfoID       =   ApprovalEmailBulk_AdditionalContactInfoID ,
        @InvoiceCompleteEmail_AdditionalContactInfoID    =   InvoiceCompleteEmail_AdditionalContactInfoID
    FROM 
        [dbo].[Client] c
    WHERE
        [c].[ClientID] = @clientid
    
    /*
    SELECT

        @ApprovalEmailSurvey_USE_MainContact            [@ApprovalEmailSurvey_USE_MainContact],
        @ApprovalEMailAirTest_USE_MainContact           [@ApprovalEMailAirTest_USE_MainContact],
        @ApprovalEmailBulk_USE_MainContact              [@ApprovalEmailBulk_USE_MainContact],
        @InvoiceCompleteEmail_USE_MainContact           [@InvoiceCompleteEmail_USE_MainContact],
        @ApprovalEmailSurvey_AdditionalContactInfoID    [@ApprovalEmailSurvey_AdditionalContactInfoID],
        @ApprovalEMailAirTest_AdditionalContactInfoID   [@ApprovalEMailAirTest_AdditionalContactInfoID],
        @ApprovalEmailBulk_AdditionalContactInfoID      [@ApprovalEmailBulk_AdditionalContactInfoID],
        @InvoiceCompleteEmail_AdditionalContactInfoID   [@InvoiceCompleteEmail_AdditionalContactInfoID],
        @isJob                                          [@isJob],
        @isAirTest                                      [@isAirTest],
        @isbulk                                         [@isbulk],
        @isbulk                                         [@isbulk]

    */
    /*check the client over rides*/
    IF (
        (@ApprovalEmailSurvey_USE_MainContact = 1 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NULL AND @isJob=1) or
        (@ApprovalEMailAirTest_USE_MainContact = 1 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NULL AND @isAirTest=1) or
        (@ApprovalEmailBulk_USE_MainContact = 1 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NULL AND @isbulk=1) or
        (@InvoiceCompleteEmail_USE_MainContact = 1 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NULL AND @isInvoice=1)
       )
    BEGIN 
        --default client is forced to be used by the client config
        SET @contactID= NULL 
        --print 'client override use main contact'
    END 
    ELSE
    BEGIN 
        IF (
            (@ApprovalEmailSurvey_USE_MainContact = 0 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NOT NULL AND @isJob=1) or
            (@ApprovalEMailAirTest_USE_MainContact = 0 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NOT NULL AND @isAirTest=1) or
            (@ApprovalEmailBulk_USE_MainContact = 0 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NOT NULL AND @isbulk=1) or
            (@InvoiceCompleteEmail_USE_MainContact = 0 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NOT NULL AND @isInvoice=1)
           )
        BEGIN 
            --client has a forced contactid use that overriding anything else
            IF (@ApprovalEmailSurvey_USE_MainContact = 0 AND   @ApprovalEmailSurvey_AdditionalContactInfoID    IS NOT NULL AND @isJob=1) 
                    select @contactid = @ApprovalEmailSurvey_AdditionalContactInfoID
            IF (@ApprovalEMailAirTest_USE_MainContact = 0 AND  @ApprovalEMailAirTest_AdditionalContactInfoID   IS NOT NULL AND @isAirTest=1) 
                    select @contactid = @ApprovalEMailAirTest_AdditionalContactInfoID
            IF (@ApprovalEmailBulk_USE_MainContact = 0 AND     @ApprovalEmailBulk_AdditionalContactInfoID      IS NOT NULL AND @isbulk=1) 
                    select @contactid = @ApprovalEmailBulk_AdditionalContactInfoID
            IF (@InvoiceCompleteEmail_USE_MainContact = 0 AND  @InvoiceCompleteEmail_AdditionalContactInfoID   IS NOT NULL AND @isInvoice=1) 
                    select @contactID = @InvoiceCompleteEmail_AdditionalContactInfoID
            --print 'client override additional contact'
        END 
    END 
    --print 'using contactid ' + CAST(@contactID AS varchar)
    
    /*
    with the flow from above by the time we have gotten here, the contact inforation will be set for the default client, or a contactid will be set from the job or client override
    */
    
    IF EXISTS(SELECT 'x' FROM  [dbo].[AdditionalContactInfo] WHERE AdditionalContactTypeID=1 AND [AdditionalContactInfoID] = @contactID AND Deleted IS NULL)
    BEGIN
        --single contact is used
        SELECT 
            @contact=aci.[Contact], 
            @email= ISNULL([aci].[Contact],'')  + ' <' + [aci].[Email] + '>'
        FROM 
            AdditionalContactInfo aci
        WHERE 
            aci.AdditionalContactTypeID=1 AND 
            [aci].[AdditionalContactInfoID] = @contactID
            AND LTRIM(rtrim(ISNULL([aci].[Email],'')))!=''
                  AND Deleted IS NULL
         
         --print 'single contact'
    END
    ELSE
    BEGIN
        --csv of email addresses used.
        DECLARE @contact_TypeId_ForGroup [int]
        SELECT @contact_TypeId_ForGroup = additionalcontacttypeid FROM [dbo].[AdditionalContactType] WHERE [ContactTypeDescription] = 'Contact Group'
    
        IF EXISTS(SELECT 'x' FROM  [dbo].[AdditionalContactInfo] WHERE AdditionalContactTypeID=@contact_TypeId_ForGroup AND [AdditionalContactInfoID] = @contactID AND Deleted IS NULL)
        BEGIN
            select 
                @contact = x.[contacts],
                @email = x.sendstring
            FROM 
               tblfn_getContactGroupEmails(@contactID) x
        END 
        --print 'contact group'
    END 
    
    SELECT
        @client [Client],
        @contact [Contact],
        NULLIF(@email,' <>') [Email],
        @address [Address],
        coalesce(@invoiceno,@jobno)ref,
        c.s__CompanyName,
        c.s__CompanyAddress,
        c.s__CompanyTelephone,
        c.s__CompanyEmail,
        c.b__TEAMSPortalHTTPS,
        c.s__TEAMSPortalhost
    FROM
        (
            SELECT TOP 1
                config.s__CompanyName, 
                config.s__CompanyAddress,
                config.s__CompanyTelephone,
                config.s__CompanyEmail,
                config.b__TEAMSPortalHTTPS,
                config.s__TEAMSPortalHost
            FROM 
                config
        )c
        
    SET NOCOUNT off
end

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'JobDefaultToProjectContact') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[JobDefaultToProjectContact] AS BEGIN SET NOCOUNT ON; END')
END

go
ALTER procedure [dbo].[JobDefaultToProjectContact](@JobId as int)
as
SET NOCOUNT ON
SET ANSI_WARNINGS OFF

declare @ContactId as int
declare @ContactChanged as bit = 0
declare @PreviousContact as int
/*
	Updates the job contact id to be the same as the Project contact if the job id has not been
	set and the projectid has been set.
	If neither has been set leave alone as the system will us the default contact for the job.
*/

select 
	@PreviousContact = ContactId
from 
	Job j
where
	jobId = @JobId 	 

-- Check to see if a contact has already been assigned and quit if it has. Nothing to do!
if @PreviousContact is null
begin
	
		Update Job
			set ContactId = p.ContactId
		from	
			Project p
		where
			Job.ProjectID = p.ProjectID 		
			and Job.ContactId is null
			and p.ContactId is not null			
			and Job.JobId = @JobId			

		select @ContactChanged = cast(@@RowCount as bit)


end
-- return changed data
select 
	j.JobID,
	@PreviousContact as PreviousJobContactId,
	j.ContactId as NewJobContactId,
	p.ContactId as ProjectContact,
	@ContactChanged  as ContactChanged,
	isnull(cc.Contact, 'Error') as NewContactName
from 
	Job j
	inner join Project p on p.ProjectId = j.ProjectId
	left outer join ClientContacts cc on cc.ContactId = j.ContactId
where					
	j.JobId = @JobId 		

return 0
GO

IF EXISTS (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Site') AND name='Postcode')
BEGIN
	ALTER TABLE Site
	ALTER COLUMN Postcode VARCHAR(15) NOT NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetFloorplansForExport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetFloorplansForExport] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetFloorplansForExport]
    @JobID INT = NULL,
    @SurveyTypeID INT = NULL,
    @JobIDs VARCHAR(MAX) = NULL,
    @FloorplanID INT = 0,
    @FloorplanAdditionalID INT = 0,
    @CustomDateFormat SMALLINT = 0,
    @OrderByRegister BIT = 0,
    @DefaultTemplatePageLayout VARCHAR(100) = ''
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    /*
        NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
        WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS.
        MAKE SURE YOU ALSO CONSIDER ADJUSTING 'GetFloorplansForReport' AND 'GetLegionellaFloorplans' WHEN MODIFYING THIS ONE.
    */
    
    -- Set default variable values if not passed in.
    SELECT
        @JobIDs = NULLIF(LTRIM(RTRIM(@JobIDs)), '')
    
    -- Make sure that either a @JobID and @SurveyTypeID were passed in or a list of @JobIDs.
    IF (@JobID IS NULL OR @SurveyTypeID IS NULL) AND @JobIDs IS NULL
    BEGIN
        -- Raise a customised error and then turn NOEXEC on to stop further execution.
        RAISERROR('Incorrect parameters passed in. Please pass in a @JobID and @SurveyTypeID or a list of @JobIDs.', 12, 1)
        SET NOEXEC ON;
    END
    
    -- Set variables for logic.
    DECLARE @CompanyName NVARCHAR(50), @BasementName VARCHAR(50)
    SELECT
        @CompanyName = cfg.s__CompanyName,
        @BasementName = ISNULL(NULLIF(cfg.s__BasementName, ''), 'Z-Sub Level')
    FROM
        Config cfg WITH (NOLOCK)
    
    -- Get the JobIDs into a table variable.
    DECLARE @Jobs TABLE (JobID INT)
    IF @JobIDs IS NOT NULL
    BEGIN
        INSERT INTO @Jobs (JobID)
        SELECT CAST(s AS INT) [JobID]
        FROM dbo.SplitString(@JobIDs, ',')
    END
    
    -- Use table variable to get all the jobs used.
    DECLARE @JobData TABLE (IndexID INT IDENTITY(1,1) PRIMARY KEY, JobID INT, SurveyTypeID INT, JobNo INT, SurveyType VARCHAR(100), ClientID INT, Client VARCHAR(100), ClientBranch VARCHAR(100), ClientAddress VARCHAR(200), ClientPostcode VARCHAR(10), ProjectID INT, Project VARCHAR(50), ProjectGroupName VARCHAR(50), SiteID INT, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), SiteUPRN VARCHAR(50), UNIQUE CLUSTERED (IndexID, JobID))
    
    IF @JobID IS NOT NULL
    BEGIN
        -- Insert into table variable for one job only.
        INSERT INTO @JobData
        SELECT DISTINCT
            j.JobID,
            su.SurveyTypeID,
            j.JobNo,
            sut.Description [SurveyType],
            c.ClientID,
            c.Client,
            c.BranchName [ClientBranch],
            c.Address [ClientAddress],
            c.Postcode [ClientPostcode],
            p.ProjectID,
            p.Project,
            p.GroupName [ProjectGroupName],
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.UPRN [SiteUPRN]
        FROM
            Job j WITH (NOLOCK)
            INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
            LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
            INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
            INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
            INNER JOIN SurveyType sut WITH (NOLOCK) ON su.SurveyTypeID = sut.SurveyTypeID
        WHERE
            j.JobID = @JobID
                AND
            su.SurveyTypeID = @SurveyTypeID
    END
    ELSE
    BEGIN
        -- Insert into table variable for the JobIDs passed in.
        INSERT INTO @JobData
        SELECT DISTINCT
            j.JobID,
            su.SurveyTypeID,
            j.JobNo,
            sut.Description [SurveyType],
            c.ClientID,
            c.Client,
            c.BranchName [ClientBranch],
            c.Address [ClientAddress],
            c.Postcode [ClientPostcode],
            p.ProjectID,
            p.Project,
            p.GroupName [ProjectGroupName],
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.UPRN [SiteUPRN]
        FROM
            Job j WITH (NOLOCK)
            INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
            LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
            INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
            INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
            INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
            INNER JOIN SurveyType sut WITH (NOLOCK) ON su.SurveyTypeID = sut.SurveyTypeID
        WHERE
            j.JobID IN (SELECT JobID FROM @Jobs)
                AND
            r.DateApproved IS NOT NULL
    END
    
    -- Get all register data up front to reduce table scans on the Register table
    DECLARE @RegisterData TABLE (JobID INT, JobEmployeeID INT, RegisterID INT, BuildingDesignation VARCHAR(1000), RegisterStart DATETIME, RegisterFinish DATETIME, UNIQUE CLUSTERED (RegisterID))
    
    INSERT INTO @RegisterData (JobID, JobEmployeeID, RegisterID, BuildingDesignation, RegisterStart, RegisterFinish)
    SELECT
        j.JobID,
        je.JobEmployeeID,
        r.RegisterID,
        r.BuildingDesignation,
        r.RegisterStart,
        r.RegisterFinish
    FROM
        @JobData j
        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
    WHERE
        r.DateApproved IS NOT NULL
    
    -- Get all floorplan data up front to reduce table scans on the Floorplan table
    DECLARE @FloorplanData TABLE (JobID INT, RegisterID INT, FloorplanID INT, FloorNumber INT, FloorplanData IMAGE, FloorplanDataContentType VARCHAR(200), AutocadData IMAGE, AutocadDataContentType VARCHAR(200), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX), TEAMS_StoreID INT)
    
    IF @FloorplanAdditionalID = 0
    BEGIN
        INSERT INTO @FloorplanData (JobID, RegisterID, FloorplanID, FloorNumber, FloorplanData, FloorplanDataContentType, AutocadData, AutocadDataContentType, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize, TEAMS_StoreID)
        SELECT
            r.JobID,
            r.RegisterID,
            f.FloorplanID,
            f.FloorNumber,
            f.FloorplanData,
            f.FloorplanDataContentType,
            f.AutocadData,
            f.AutocadDataContentType,
            f.DescriptionOverride,
            f.ShortDescriptionOverride,
            f.TemplatePageLayout_SearchString,
            f.CanvasSize,
            f.TEAMS_StoreID
        FROM
            @RegisterData r
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        WHERE
            (@FloorplanID = 0 OR f.FloorplanID = @FloorplanID)
                AND
            (
                f.FloorplanData IS NOT NULL
                    OR
                f.AutocadData IS NOT NULL
            )
                AND
            ISNULL(f.ExcludeFromReport, 0) = 0
    END
    
    -- Declare variables for doing dynamic SQL (these might be needed below if Floorplans contain a TEAMS_StoreID).
    DECLARE @i INT, @FloorplanCount INT, @PlanID INT, @AutocadData VARBINARY(MAX), @AutocadDataContentType VARCHAR(200), @PlanData VARBINARY(MAX), @PlanDataContentType VARCHAR(200), @PlanSql NVARCHAR(MAX)
    
    -- If there is at least one Floorplan with a TEAMS_StoreID, then we need to run a loop with dynamic SQL to update the data fields above.
    IF EXISTS(SELECT 1 FROM @FloorplanData WHERE TEAMS_StoreID > 0)
    BEGIN
        -- First of all, only get the FloorplanIDs of Floorplans that have a TEAMS_StoreID.
        DECLARE @FloorplansFromStore TABLE (IndexID INT IDENTITY(1,1), FloorplanID INT, TEAMS_StoreID INT)
        INSERT INTO @FloorplansFromStore
        SELECT FloorplanID, TEAMS_StoreID
        FROM @FloorplanData
        WHERE FloorplanID > 0
        
        -- Reset the variables used for the loop.
        SELECT
            @i = 0,
            @FloorplanCount = (SELECT COUNT(*) FROM @FloorplansFromStore)
        
        -- Execute the loop.
        WHILE @i < @FloorplanCount
        BEGIN
            -- Reset the variables for the current Floorplan.
            SELECT
                @i = @i + 1,
                @PlanID = NULL,
                @AutocadData = NULL,
                @AutocadDataContentType = NULL,
                @PlanData = NULL,
                @PlanDataContentType = NULL,
                @PlanSql = NULL
            
            -- Set the variables for the current Floorplan.
            SELECT @PlanID = FloorplanID, @PlanSql = 'SELECT @ad = AutocadData, @adct = AutocadDataContentType, @pd = FloorplanData, @pdct = FloorplanDataContentType FROM TEAMS_Store' + CAST(TEAMS_StoreID AS VARCHAR(50)) + '.dbo.Floorplan WITH (NOLOCK) WHERE FloorplanID = @PlanID'
            FROM @FloorplansFromStore
            WHERE IndexID = @i
            
            -- Execute the dynamic SQL, setting the data variables for the current Floorplan.
            EXECUTE sp_executesql @PlanSql, N'@PlanID INT, @ad IMAGE OUTPUT, @adct VARCHAR(200) OUTPUT, @pd IMAGE OUTPUT, @pdct VARCHAR(200) OUTPUT', @PlanID = @PlanID, @ad = @AutocadData OUTPUT, @adct = @AutocadDataContentType OUTPUT, @pd = @PlanData OUTPUT, @pdct = @PlanDataContentType OUTPUT
            
            -- Update the main table variable to set the correct data for the current Floorplan.
            UPDATE @FloorplanData
            SET AutocadData = @AutocadData, AutocadDataContentType = @AutocadDataContentType, FloorplanData = @PlanData, FloorplanDataContentType = @PlanDataContentType
            WHERE FloorplanID = @PlanID
        END
        
        -- Now we have got the correct data, delete everything from the table variable.
        DELETE FROM @FloorplansFromStore
    END
    
    -- Get all additional floorplan data up front to reduce table scans on the FloorplanAdditional table
    DECLARE @FloorplanAdditionalData TABLE (JobID INT, RegisterID INT, FloorplanAdditionalID INT, FloorplanID INT, FloorNumber INT, FloorplanData IMAGE, FloorplanDataContentType VARCHAR(200), AutocadData IMAGE, AutocadDataContentType VARCHAR(200), Description VARCHAR(MAX), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    
    IF @FloorplanID = 0
    BEGIN
        INSERT INTO @FloorplanAdditionalData (JobID, RegisterID, FloorplanAdditionalID, FloorplanID, FloorNumber, FloorplanData, FloorplanDataContentType, AutocadData, AutocadDataContentType, Description, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
        SELECT
            r.JobID,
            r.RegisterID,
            fa.FloorplanAdditionalID,
            fa.FloorplanID,
            f.FloorNumber,
            fa.FloorplanData,
            fa.FloorplanDataContentType,
            fa.AutocadData,
            fa.AutocadDataContentType,
            fa.Description,
            f.DescriptionOverride,
            f.ShortDescriptionOverride,
            f.TemplatePageLayout_SearchString,
            f.CanvasSize
        FROM
            @RegisterData r
            INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
            INNER JOIN FloorplanAdditional fa WITH (NOLOCK) ON f.FloorplanID = fa.FloorplanID
        WHERE
            (@FloorplanAdditionalID = 0 OR fa.FloorplanAdditionalID = @FloorplanAdditionalID)
                AND
            (
                fa.FloorplanData IS NOT NULL
                    OR
                fa.AutocadData IS NOT NULL
            )
                AND
            ISNULL(fa.ExcludeFromReport, 0) = 0
    END
    
    
    -- Start the main SELECT
    SELECT
        ROW_NUMBER() OVER ( -- This ROW_NUMBER() ORDER BY needs to use the same logic as the ORDER BY.
            PARTITION BY
                f.JobID
            ORDER BY
                CASE WHEN @OrderByRegister = 1
                    THEN f.RegisterStartAsDate
                    ELSE NULL
                END,
                CASE WHEN @OrderByRegister = 1
                    THEN f.Building
                    ELSE NULL
                END,
                f.FloorNumber,
                f.Additional
        ) [FloorplanNumber],
        (SELECT COUNT(*) FROM @FloorplanData WHERE JobID = f.JobID) + (SELECT COUNT(*) FROM @FloorplanAdditionalData WHERE JobID = f.JobID) [TotalFloorplans],
        
        -- Get the main UNION data.
        f.*,
        
        -- Get TemplatePageLayout data (except for the SearchString which is handled by the main UNION).
        tpl.Body_RectString,
        tpl.Body_BrowserWidth,
        tpl.MediaBox,
        tpl.Landscape
        
    FROM
        (
            SELECT
                0 [Additional],
                r.RegisterID,
                ISNULL(r.BuildingDesignation, '') [Building],
                dbo.FormatDateCustom(r.RegisterStart, @CustomDateFormat) [RegisterStart],
                dbo.FormatDateCustom(r.RegisterFinish, @CustomDateFormat) [RegisterFinish],
                CAST(r.RegisterStart AS DATE) [RegisterStartAsDate],
                CAST(r.RegisterFinish AS DATE) [RegisterFinishAsDate],
                f.FloorplanID [FloorplanID],
                f.FloorplanID [FloorplanRecordID],
                NULL [FloorplanAdditionalRecordID],
                f.FloorNumber,
                REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName) [FloorName],
                ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [Description],
                f.AutocadData,
                f.AutocadDataContentType,
                f.FloorplanData,
                f.FloorplanDataContentType,
                CASE WHEN f.AutocadData IS NOT NULL
                    THEN
                        CASE WHEN f.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                            THEN 'getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50))
                            ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(50)) + ']'
                        END
                    ELSE 'getsketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50)) -- Use site floorplan image
                END [ImagePath],
                CASE WHEN f.AutocadData IS NOT NULL
                    THEN
                        CASE WHEN f.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                            ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(50)) + ']'
                        END
                    ELSE '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use site floorplan image
                END [ImagePathOrPDF],
                ISNULL(f.TemplatePageLayout_SearchString, @DefaultTemplatePageLayout) [TemplatePageLayout],
                
                -- Columns that are the same in both UNIONS (some are in capitals for backwards compatibility):
                j.JobID,
                j.SurveyTypeID,
                dbo.FormatTeamsReference('J', j.JobNo) [JobNo],
                j.SurveyType,
                j.Client [CLIENTNAME],
                j.ClientBranch [ClientBranch],
                j.Client + ISNULL(' (' + NULLIF(j.ClientBranch, '') + ')', '') [Client],
                j.ClientAddress [ClientAddress],
                REPLACE(j.ClientAddress, ', ', '<br />') [CLIENTADDRESSMULTILINE],
                j.ClientPostcode [CLIENTPOSTCODE],
                j.Project [PROJECT],
                j.ProjectGroupName,
                ISNULL(j.Project, '') + ISNULL(' / ' + NULLIF(j.ProjectGroupName, ''), '') [ProjectPlusProjectGroup],
                j.SiteAddress [SiteAddress],
                REPLACE(j.SiteAddress, ', ', '<br />') [SITEADDRESSWITHBREAKS],
                j.SitePostcode [SitePostcode],
                ISNULL(NULLIF(j.SiteUPRN, ''), 'N/A') [SiteUPRN],
                (SELECT LTRIM(RTRIM(s)) FROM dbo.SplitString(j.SiteAddress, ',') WHERE zeroBasedOccurance = 0) [FirstLineSiteAddress]
            FROM
                @JobData j
                INNER JOIN @RegisterData r ON j.JobID = r.JobID
                INNER JOIN @FloorplanData f ON r.RegisterID = f.RegisterID
            
            UNION ALL
            
            SELECT
                1 [Additional],
                r.RegisterID,
                ISNULL(r.BuildingDesignation, '') [Building],
                dbo.FormatDateCustom(r.RegisterStart, @CustomDateFormat) [RegisterStart],
                dbo.FormatDateCustom(r.RegisterFinish, @CustomDateFormat) [RegisterFinish],
                CAST(r.RegisterStart AS DATE) [RegisterStartAsDate],
                CAST(r.RegisterFinish AS DATE) [RegisterFinishAsDate],
                fa.FloorplanAdditionalID [FloorplanID],
                fa.FloorplanID [FloorplanRecordID],
                fa.FloorplanAdditionalID [FloorplanAdditionalRecordID],
                fa.FloorNumber,
                REPLACE(dbo.FloorName(fa.FloorNumber), 'Z-Sub Level', @BasementName) [FloorName],
                ISNULL(ISNULL(fa.Description, fa.DescriptionOverride), REPLACE(dbo.FloorName(fa.FloorNumber), 'Z-Sub Level', @BasementName)) [Description],
                fa.AutocadData,
                fa.AutocadDataContentType,
                fa.FloorplanData,
                fa.FloorplanDataContentType,
                CASE WHEN fa.AutocadData IS NOT NULL
                    THEN
                        CASE WHEN fa.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                            THEN 'getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1'
                            ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + ']'
                        END 
                    ELSE 'getsketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1' -- Use site floorplan image
                END [ImagePath],
                CASE WHEN fa.AutocadData IS NOT NULL
                    THEN
                        CASE WHEN fa.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                            THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                            ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + ']'
                        END 
                    ELSE '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use site floorplan image
                END [ImagePathOrPDF],
                ISNULL(fa.TemplatePageLayout_SearchString, @DefaultTemplatePageLayout) [TemplatePageLayout],
                
                -- Columns that are the same in both UNIONS (some are in capitals for backwards compatibility):
                j.JobID,
                j.SurveyTypeID,
                dbo.FormatTeamsReference('J', j.JobNo) [JobNo],
                j.SurveyType,
                j.Client [CLIENTNAME],
                j.ClientBranch [ClientBranch],
                j.Client + ISNULL(' (' + NULLIF(j.ClientBranch, '') + ')', '') [Client],
                j.ClientAddress [ClientAddress],
                REPLACE(j.ClientAddress, ', ', '<br />') [CLIENTADDRESSMULTILINE],
                j.ClientPostcode [CLIENTPOSTCODE],
                j.Project [PROJECT],
                j.ProjectGroupName,
                ISNULL(j.Project, '') + ISNULL(' / ' + NULLIF(j.ProjectGroupName, ''), '') [ProjectPlusProjectGroup],
                j.SiteAddress [SiteAddress],
                REPLACE(j.SiteAddress, ', ', '<br />') [SITEADDRESSWITHBREAKS],
                j.SitePostcode [SitePostcode],
                ISNULL(NULLIF(j.SiteUPRN, ''), 'N/A') [SiteUPRN],
                (SELECT LTRIM(RTRIM(s)) FROM dbo.SplitString(j.SiteAddress, ',') WHERE zeroBasedOccurance = 0) [FirstLineSiteAddress]
            FROM
                @JobData j
                INNER JOIN @RegisterData r ON j.JobID = r.JobID
                INNER JOIN @FloorplanAdditionalData fa ON r.RegisterID = fa.RegisterID
        ) f
        LEFT JOIN TemplatePageLayout tpl WITH (NOLOCK) ON f.TemplatePageLayout = tpl.SearchString
    
    ORDER BY -- This ORDER BY needs to use the same logic as the ROW_NUMBER() ORDER BY above.
        f.JobID,
        CASE WHEN @OrderByRegister = 1
            THEN f.RegisterStartAsDate
            ELSE NULL
        END,
        CASE WHEN @OrderByRegister = 1
            THEN f.Building
            ELSE NULL
        END,
        f.FloorNumber,
        f.Additional
    
    
    SET NOEXEC OFF;
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetFloorplansForReport') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetFloorplansForReport] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetFloorplansForReport]
    @JobID INT,
    @SurveyTypeID INT,
    @CustomDateFormat SMALLINT = 0,
    @OrderByRegister BIT = 0,
    @DefaultTemplatePageLayout VARCHAR(100) = ''
AS
BEGIN
    SET NOCOUNT ON;
    
    /*
        NOTE: THIS STORED PROCEDURE IS GENERIC ACROSS ALL SERVERS.
        WHEN MODIFYING, PLEASE TAKE THE LATEST VERSION FROM SVN FIRST. APPLY THE CHANGES ACROSS ALL SERVERS INCLUDING REPLICATED ONES.
        MAKE SURE YOU ALSO CONSIDER ADJUSTING 'GetFloorplansForExport' AND 'GetLegionellaFloorplans' WHEN MODIFYING THIS ONE.
    */
    
    -- Get information that is repeated per row in variables to reduce table scans
    DECLARE @JobNo VARCHAR(50), @SurveyType VARCHAR(100), @BasementName VARCHAR(50), @Client VARCHAR(100), @ClientBranch VARCHAR(100), @ClientAddress VARCHAR(200), @ClientPostcode VARCHAR(10), @SiteAddress VARCHAR(200), @SitePostcode VARCHAR(15), @SiteUPRN VARCHAR(50)
    SELECT
        @JobNo = dbo.FormatTeamsReference('J', j.JobNo),
        @SurveyType = (SELECT Description FROM SurveyType WHERE SurveyTypeID = @SurveyTypeID),
        @BasementName = (SELECT ISNULL(NULLIF(s__BasementName, ''), 'Z-Sub Level') FROM Config),
        @Client = c.Client,
        @ClientBranch = c.BranchName,
        @ClientAddress = c.Address,
        @ClientPostcode = c.Postcode,
        @SiteAddress = si.Address,
        @SitePostcode = si.Postcode,
        @SiteUPRN = si.UPRN
    FROM
        Job j WITH (NOLOCK)
        INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
        INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
    WHERE
        j.JobID = @JobID
    
    -- Get all register data up front to reduce table scans on the Register table
    DECLARE @RegisterData TABLE (JobEmployeeID INT, RegisterID INT, BuildingDesignation VARCHAR(1000), RegisterStart DATETIME, RegisterFinish DATETIME)
    
    INSERT INTO @RegisterData (JobEmployeeID, RegisterID, BuildingDesignation, RegisterStart, RegisterFinish)
    SELECT
        je.JobEmployeeID,
        r.RegisterID,
        r.BuildingDesignation,
        r.RegisterStart,
        r.RegisterFinish
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
    WHERE
        je.JobID = @JobID
            AND
        su.SurveyTypeID = @SurveyTypeID
    
    -- Get all floorplan data up front to reduce table scans on the Floorplan table
    DECLARE @FloorplanData TABLE (RegisterID INT, FloorplanID INT, FloorNumber INT, FloorplanData IMAGE, FloorplanDataContentType VARCHAR(200), AutocadData IMAGE, AutocadDataContentType VARCHAR(200), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    
    INSERT INTO @FloorplanData (RegisterID, FloorplanID, FloorNumber, FloorplanData, FloorplanDataContentType, AutocadData, AutocadDataContentType, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
        r.RegisterID,
        f.FloorplanID,
        f.FloorNumber,
        f.FloorplanData,
        f.FloorplanDataContentType,
        f.AutocadData,
        f.AutocadDataContentType,
        f.DescriptionOverride,
        f.ShortDescriptionOverride,
        f.TemplatePageLayout_SearchString,
        f.CanvasSize
    FROM
        @RegisterData r
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
    WHERE
        (
            f.FloorplanData IS NOT NULL
                OR
            f.AutocadData IS NOT NULL
        )
            AND
        ISNULL(f.ExcludeFromReport, 0) = 0
    
    -- Get all additional floorplan data up front to reduce table scans on the FloorplanAdditional table
    DECLARE @FloorplanAdditionalData TABLE (RegisterID INT, FloorplanAdditionalID INT, FloorplanID INT, FloorNumber INT, FloorplanData IMAGE, FloorplanDataContentType VARCHAR(200), AutocadData IMAGE, AutocadDataContentType VARCHAR(200), Description VARCHAR(MAX), DescriptionOverride VARCHAR(MAX), ShortDescriptionOverride VARCHAR(15), TemplatePageLayout_SearchString VARCHAR(MAX), CanvasSize VARCHAR(MAX))
    
    INSERT INTO @FloorplanAdditionalData (RegisterID, FloorplanAdditionalID, FloorplanID, FloorNumber, FloorplanData, FloorplanDataContentType, AutocadData, AutocadDataContentType, Description, DescriptionOverride, ShortDescriptionOverride, TemplatePageLayout_SearchString, CanvasSize)
    SELECT
        r.RegisterID,
        fa.FloorplanAdditionalID,
        fa.FloorplanID,
        f.FloorNumber,
        fa.FloorplanData,
        fa.FloorplanDataContentType,
        fa.AutocadData,
        fa.AutocadDataContentType,
        fa.Description,
        f.DescriptionOverride,
        f.ShortDescriptionOverride,
        f.TemplatePageLayout_SearchString,
        f.CanvasSize
    FROM
        @RegisterData r
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN FloorplanAdditional fa WITH (NOLOCK) ON f.FloorplanID = fa.FloorplanID
    WHERE
        (
            fa.FloorplanData IS NOT NULL
                OR
            fa.AutocadData IS NOT NULL
        )
            AND
        ISNULL(fa.ExcludeFromReport, 0) = 0
    
    
    -- Start the main SELECT
    SELECT
        ROW_NUMBER() OVER ( -- This ROW_NUMBER() needs to use the same logic as the ORDER BY.
            ORDER BY
                CASE WHEN @OrderByRegister = 1
                    THEN a.RegisterStartAsDate
                    ELSE NULL
                END,
                CASE WHEN @OrderByRegister = 1
                    THEN a.Building
                    ELSE NULL
                END,
                a.FloorNumber,
                a.Additional
        ) [FloorplanNumber],
        (SELECT COUNT(*) FROM @FloorplanData) + (SELECT COUNT(*) FROM @FloorplanAdditionalData) [TotalFloorplans],
        a.*,
        @JobNo [JobNo],
        @SurveyType [SurveyType],
        @Client [ClientName],
        @ClientBranch [ClientBranch],
        @Client + ISNULL(' (' + NULLIF(@ClientBranch, '') + ')', '') [Client],
        @ClientAddress [ClientAddress],
        REPLACE(@ClientAddress, ', ', '<br />') [ClientAddressMultiline],
        @ClientPostcode [ClientPostcode],
        @SiteAddress [SiteAddress],
        REPLACE(@SiteAddress, ', ', '<br />') [SiteAddressWithBreaks],
        @SitePostcode [SitePostcode],
        ISNULL(NULLIF(@SiteUPRN, ''), 'N/A') [SiteUPRN]
        
    FROM
    (
        SELECT
            0 [Additional],
            r.RegisterID,
            ISNULL(r.BuildingDesignation, '') [Building],
            dbo.FormatDateCustom(r.RegisterStart, @CustomDateFormat) [RegisterStart],
            dbo.FormatDateCustom(r.RegisterFinish, @CustomDateFormat) [RegisterFinish],
            CAST(r.RegisterStart AS DATE) [RegisterStartAsDate],
            CAST(r.RegisterFinish AS DATE) [RegisterFinishAsDate],
            f.FloorplanID [FloorplanID],
            f.FloorplanID [FloorplanRecordID],
            NULL [FloorplanAdditionalRecordID],
            f.FloorNumber,
            REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName) [FloorName],
            ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [Description],
            CASE WHEN f.AutocadData IS NOT NULL
                THEN 'getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50))
                ELSE 'getsketch.asp?id=' +  CAST(f.FloorplanID AS VARCHAR(50))
            END [ImagePath],
            CASE WHEN f.AutocadData IS NOT NULL
                THEN
                    CASE WHEN f.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                        THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                        ELSE '[FLOORPLANUPLOAD' + CAST(f.FloorplanID AS VARCHAR(50)) + ']'
                    END
                ELSE '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(f.FloorplanID AS VARCHAR(50)) + '&[RND]" class="' + ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(f.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use site floorplan image
            END [ImagePathOrPDF]
            
        FROM
            @RegisterData r
            INNER JOIN @FloorplanData f ON r.RegisterID = f.RegisterID
        
        UNION ALL
        
        SELECT
            1 [Additional],
            r.RegisterID,
            ISNULL(r.BuildingDesignation, '') [Building],
            dbo.FormatDateCustom(r.RegisterStart, @CustomDateFormat) [RegisterStart],
            dbo.FormatDateCustom(r.RegisterFinish, @CustomDateFormat) [RegisterFinish],
            CAST(r.RegisterStart AS DATE) [RegisterStartAsDate],
            CAST(r.RegisterFinish AS DATE) [RegisterFinishAsDate],
            fa.FloorplanAdditionalID [FloorplanID],
            fa.FloorplanID [FloorplanRecordID],
            fa.FloorplanAdditionalID [FloorplanAdditionalRecordID],
            fa.FloorNumber,
            REPLACE(dbo.FloorName(fa.FloorNumber), 'Z-Sub Level', @BasementName) [FloorName],
            ISNULL(ISNULL(fa.Description, fa.DescriptionOverride), REPLACE(dbo.FloorName(fa.FloorNumber), 'Z-Sub Level', @BasementName)) [Description],
            CASE WHEN fa.AutocadData IS NOT NULL
                THEN 'getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1'
                ELSE 'getsketch.asp?id=' +  CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1'
            END [ImagePath],
            CASE WHEN fa.AutocadData IS NOT NULL
                THEN
                    CASE WHEN fa.AutocadDataContentType != 'application/pdf' -- Use office floorplan image or PDF
                        THEN '<img src="[HOSTNAME]/images/getautosketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />'
                        ELSE '[FLOORPLANADDITIONALUPLOAD' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + ']'
                    END 
                ELSE '<img src="[HOSTNAME]/images/getsketch.asp?id=' + CAST(fa.FloorplanAdditionalID AS VARCHAR(50)) + '&additional=1&[RND]" class="' + ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')) + ' ' + REPLACE(ISNULL(fa.TemplatePageLayout_SearchString, ISNULL(@DefaultTemplatePageLayout, '')), 'tpl_', 'ConfigCSS_') + '" />' -- Use site floorplan image
            END [ImagePathOrPDF]
            
        FROM
            @RegisterData r
            INNER JOIN @FloorplanAdditionalData fa ON r.RegisterID = fa.RegisterID
    ) a
    
    ORDER BY -- This ORDER BY needs to use the same logic as the ROW_NUMBER() above.
        CASE WHEN @OrderByRegister = 1
            THEN a.RegisterStartAsDate
            ELSE NULL
        END,
        CASE WHEN @OrderByRegister = 1
            THEN a.Building
            ELSE NULL
        END,
        a.FloorNumber,
        a.Additional
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetLegionellaRisk_Export') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetLegionellaRisk_Export] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetLegionellaRisk_Export]
	@JobID INT = 0

WITH RECOMPILE
AS
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET NOCOUNT ON;

-- Get Legionella Items data up front to reduce table scans on the Legionella/Asset/Location/Outlet tables.
DECLARE @LegionellaItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, DateApproved DATETIME, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT,  OutletEnabledCold BIT, OutletEnabledHot BIT, OutletEnabledMixed BIT, OutletEnabledMains BIT, OutletLowUse BIT)

INSERT INTO @LegionellaItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, DateApproved, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, OutletEnabledCold, OutletEnabledHot, OutletEnabledMixed, OutletEnabledMains, OutletLowUse)
SELECT
	si.SiteID,
	j.JobID,
	lao.RowType,
	l.LegionellaID,
	l.GUID [LegGUID],
	l.GUIDVersion [LegGUIDVersion],
	l.DateApproved,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lao.OutletEnabledCold,
	lao.OutletEnabledHot,
	lao.OutletEnabledMixed,
	lao.OutletEnabledMains,
	CASE WHEN (lao.OutletEnabledCold = 1 AND lao.OutletLowUseCold = 1) OR (lao.OutletEnabledHot = 1 AND lao.OutletLowUseHot = 1) OR (lao.OutletEnabledMixed = 1 AND lao.OutletLowUseMixed = 1) OR (lao.OutletEnabledMains = 1 AND lao.OutletLowUseMains = 1)
		THEN 1
		ELSE 0
	END [OutletLowUse]
FROM
	Job j WITH (NOLOCK)
	INNER JOIN Site si ON j.SiteID = si.SiteID
	INNER JOIN Client c ON j.ClientID = c.ClientID
	INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
	INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
	INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
	INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
	INNER JOIN (
		SELECT
			1 [RowType],
			l.LegionellaID,
			NULL [LegionellaAssetOutletID],
			NULL [AssetOutletSystemRef],
			NULL [AssetOutletGUID],
			NULL [AssetOutletGUIDVersion],
			NULL [LegionellaLocationID],
			NULL [AssetOutletLocation],
			NULL [LocationGUID],
			NULL [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			Legionella l WITH (NOLOCK)

		UNION ALL

		SELECT
			2 [RowType],
			la.LegionellaID,
			la.LegionellaAssetID [LegionellaAssetOutletID],
			la.SystemRef [AssetOutletSystemRef],
			la.GUID [AssetOutletGUID],
			la.GUIDVersion [AssetOutletGUIDVersion],
			NULL [LegionellaLocationID],
			la.Location [AssetOutletLocation],
			NULL [LocationGUID],
			NULL [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			LegionellaAsset la WITH (NOLOCK)
		WHERE
			la.Deleted IS NULL
				AND
			la.DateRemoved IS NULL

		UNION ALL

		SELECT
			3 [RowType],
			ll.LegionellaID,
			NULL [LegionellaAssetOutletID],
			NULL [AssetOutletSystemRef],
			NULL [AssetOutletGUID],
			NULL [AssetOutletGUIDVersion],
			ll.LegionellaLocationID,
			ll.Location [AssetOutletLocation],
			ll.GUID [LocationGUID],
			ll.GUIDVersion [LocationGUIDVersion],
			NULL [OutletEnabledCold],
			NULL [OutletEnabledHot],
			NULL [OutletEnabledMixed],
			NULL [OutletEnabledMains],
			NULL [OutletLowUseCold],
			NULL [OutletLowUseHot],
			NULL [OutletLowUseMixed],
			NULL [OutletLowUseMains]
		FROM
			LegionellaLocation ll WITH (NOLOCK)
		WHERE
			ll.Deleted IS NULL
				AND
			ll.DateRemoved IS NULL

		UNION ALL

		SELECT
			4 [RowType],
			ll.LegionellaID,
			lo.LegionellaOutletID [LegionellaAssetOutletID],
			lo.SystemRef [AssetOutletSystemRef],
			lo.GUID [AssetOutletGUID],
			lo.GUIDVersion [AssetOutletGUIDVersion],
			ll.LegionellaLocationID,
			ll.Location [AssetOutletLocation],
			ll.GUID [LocationGUID],
			ll.GUIDVersion [LocationGUIDVersion],
			lo.EnabledCold [OutletEnabledCold],
			lo.EnabledHot [OutletEnabledHot],
			lo.EnabledMixed [OutletEnabledMixed],
			lo.EnabledMains [OutletEnabledMains],
			lo.LowUseCold [OutletLowUseCold],
			lo.LowUseHot [OutletLowUseHot],
			lo.LowUseMixed [OutletLowUseMixed],
			lo.LowUseMains [OutletLowUseMains]
		FROM
			LegionellaLocation ll WITH (NOLOCK)
			INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID AND lo.Deleted IS NULL
		WHERE
			ll.Deleted IS NULL
				AND
			ll.DateRemoved IS NULL
				AND
			lo.DateRemoved IS NULL
	) lao ON l.LegionellaID = lao.LegionellaID
WHERE
	j.JobID = @JobID
GROUP BY
	si.SiteID,
	j.JobID,
	lao.RowType,
	l.LegionellaID,
	l.GUID,
	l.GUIDVersion,
	l.DateApproved,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lao.OutletEnabledCold,
	lao.OutletEnabledHot,
	lao.OutletEnabledMixed,
	lao.OutletEnabledMains,
	lao.OutletLowUseCold,
	lao.OutletLowUseHot,
	lao.OutletLowUseMixed,
	lao.OutletLowUseMains

-- Get Legionella Task up front to reduce table scans on the LegionellaTask table.
-- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
DECLARE @LegionellaTasksData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, /* ADDITIONAL COLUMNS */ RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaPriorityRatingID INT)

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaID = lt.LegionellaID AND lt.Deleted IS NULL AND lao.RowType=1
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaAssetOutletID = lt.LegionellaAssetID AND lt.Deleted IS NULL AND lao.LegionellaLocationID IS NULL AND lao.RowType=2
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaLocationID = lt.LegionellaLocationID AND lt.Deleted IS NULL AND lao.LegionellaLocationID IS NOT NULL AND lao.RowType=3
WHERE
	lt.Deleted IS NULL

INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
SELECT
	lao.SiteID,
	lao.JobID,
	lao.RowType,
	lao.LegionellaID,
	lao.LegGUID,
	lao.LegGUIDVersion,
	lao.LegionellaAssetOutletID,
	lao.AssetOutletGUID,
	lao.AssetOutletGUIDVersion,
	lao.LegionellaLocationID,
	lao.LocationGUID,
	lao.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.GUID [TaskGUID],
	lt.GUIDVersion [TaskGUIDVersion],
	lt.LegionellaRiskRatingID,
	lt.RiskDescription,
	lt.Action,
	lt.LegionellaFrequencyCategoryID,
	lt.LegionellaPriorityRatingID
FROM
	@LegionellaItemsData lao
	INNER JOIN LegionellaTask lt WITH (NOLOCK) ON lao.LegionellaAssetOutletID = lt.LegionellaOutletID AND lt.Deleted IS NULL AND lao.RowType=4
WHERE
	lt.Deleted IS NULL

-- Get Legionella Risk Items data up front as used below. Basically GUID Tasks.
-- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
DECLARE @LegionellaRiskItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, /* ADDITIONAL COLUMNS */ JobNo INT, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), BuildingDesignation VARCHAR(50), AssetOutletSystemRef VARCHAR(8000), Location VARCHAR(8000), RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(8000), LegionellaPriorityRatingID INT, PriorityRating VARCHAR(20), PriorityColour VARCHAR(15))

INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, JobNo, SiteAddress, SitePostcode, BuildingDesignation, AssetOutletSystemRef, Location, RiskDescription, Action, LegionellaFrequencyCategoryID, FrequencyCategory, LegionellaPriorityRatingID, PriorityRating, PriorityColour)
SELECT
	lt.SiteID,
	lt.JobID,
	lt.RowType,
	lt.LegionellaID,
	lt.LegGUID,
	lt.LegGUIDVersion,
	lt.LegionellaAssetOutletID,
	lt.AssetOutletGUID,
	lt.AssetOutletGUIDVersion,
	lt.LegionellaLocationID,
	lt.LocationGUID,
	lt.LocationGUIDVersion,
	lt.LegionellaTaskID,
	lt.TaskGUID,
	lt.TaskGUIDVersion,
	lrr.LegionellaRiskRatingID,
	ISNULL(lrr.Description, 'None') [RiskRating],
	'#' + ISNULL(lrr.RiskColour, 'CCCCCC') [RiskColour],
	lrr.SortOrder [RiskRatingSortOrder],
	j.JobNo,
	si.Address [SiteAddress],
	si.Postcode [SitePostcode],
	ISNULL(NULLIF(l.BuildingDesignation, ''), 'No Building Designation') [BuildingDesignation],
	ISNULL(NULLIF(ISNULL(la.SystemRef, lo.SystemRef), ''), 'N/A') [AssetOutletSystemRef],
	ISNULL(ISNULL(la.Location, ll.Location), '') [Location],
	ISNULL(lt.RiskDescription, 'N/A') [RiskDescription],
	ISNULL(lt.Action, 'N/A') [Action],
	lfc.LegionellaFrequencyCategoryID,
	ISNULL(lfc.Description, '') [FrequencyCategory],
	lpr.LegionellaPriorityRatingID,
	ISNULL(lpr.ShortDescription, 'None') [PriorityRating],
	'#' + ISNULL(lpr.PriorityColour, 'CCCCCC') [PriorityColour]
FROM
	(
		SELECT -- Get each Legionella Task record with the max GUID.
			lt.SiteID,
			lt.JobID,
			lt.RowType,
			lt.LegionellaID,
			lt.LegGUID,
			lt.LegGUIDVersion,
			lt.LegionellaAssetOutletID,
			lt.AssetOutletGUID,
			lt.AssetOutletGUIDVersion,
			lt.LegionellaLocationID,
			lt.LocationGUID,
			lt.LocationGUIDVersion,
			lt.LegionellaTaskID,
			lt.TaskGUID,
			lt.TaskGUIDVersion,
			lt.LegionellaRiskRatingID,
			lt.RiskDescription,
			lt.Action,
			lt.LegionellaFrequencyCategoryID,
			lt.LegionellaPriorityRatingID,
			ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
		FROM @LegionellaTasksData lt
	) lt
	INNER JOIN Job j WITH (NOLOCK) ON lt.JobID = j.JobID
	INNER JOIN Site si WITH (NOLOCK) ON lt.SiteID = si.SiteID
	INNER JOIN Legionella l WITH (NOLOCK) ON lt.LegionellaID = l.LegionellaID
	LEFT JOIN LegionellaAsset la WITH (NOLOCK) ON lt.LegionellaAssetOutletID = la.LegionellaAssetID AND lt.RowType = 2
	LEFT JOIN LegionellaLocation ll WITH (NOLOCK) ON lt.LegionellaLocationID = ll.LegionellaLocationID
	LEFT JOIN LegionellaOutlet lo WITH (NOLOCK) ON lt.LegionellaAssetOutletID = lo.LegionellaOutletID AND lt.RowType = 4
	LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
	LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
	LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
WHERE lt.RowID = 1

-- Start the main SELECT.
SELECT 
	dbo.FormatTEAMSReference('J',lrid.JobNo) [JobNo],
	lrid.SiteAddress,
	lrid.BuildingDesignation,
	lrid.AssetOutletSystemRef,
	lrid.Location,
	lrid.RiskDescription,
	lrid.Action,
	lrid.RiskRating,
	lrid.FrequencyCategory,
	lrid.PriorityRating
FROM 
	@LegionellaRiskItemsData lrid
ORDER BY 
	lrid.SiteID

    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetProjectJobSheet') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetProjectJobSheet] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetProjectJobSheet]
	@ClientID INT = NULL
	, @ProjectGroupID INT = NULL
	, @ProjectID INT = NULL
	, @SiteID INT = NULL
	, @OrderByString VARCHAR(100) = 'SortOrder, JobNo, Address'
	
-- EXEC GetProjectJobSheet 780, 142, NULL, NULL
	
/**********************************************************************
** Overview: Get data for the View Project JobSheet tab - procedurised
**				to improve performance over previous code
***********************************************************************
**	Change History
***********************************************************************
**	Rev			Date			Author			Details
**	---			----------		----------		-------------------
**	INITIAL		21/09/2015		STodd			Created
**********************************************************************/
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN

	-- tidy input variables
	SELECT @ClientID = NULLIF(@ClientID, 0)
	SELECT @ProjectGroupID = NULLIF(@ProjectGroupID, 0)
	SELECT @ProjectID = NULLIF(@ProjectID, 0)
	SELECT @SiteID = NULLIF(@SiteID, 0)
	
	-- ensure we have at least 1 filter ID (don;t want to kill the server!)
	IF (@ClientID IS NULL) AND (@ProjectGroupID IS NULL) AND (@ProjectID IS NULL) AND (@SiteID IS NULL) BEGIN
		RAISERROR('No ID values passed to GetProjectJobSheet', 16, 1)
		RETURN
	END
	
	-- get ProjectIDs into a table to join to, based on @ProjectGroupID AND @ProjectID inputs
	CREATE TABLE #ProjectIDs (ProjectID INT)
	IF @ProjectID IS NOT NULL BEGIN
	
		INSERT
			#ProjectIDs
		SELECT
			@ProjectID
			
	END ELSE BEGIN
		
		INSERT
			#ProjectIDs
		SELECT
			ProjectID
		FROM
			Project
		WHERE
			ProjectGroupId = @ProjectGroupID
		
	END
	
	-- select from existing ProjectJobSheet view into a temp table
	CREATE TABLE #JobSheetData (
		SortOrder INT NOT NULL
		, AppointmentID INT NULL
		, [Status] VARCHAR(24)
		, StatusDate NVARCHAR(40)
		, JobNo NVARCHAR(50) NULL
		, [Address] VARCHAR(200)
		, Postcode VARCHAR(15)
		, Contact VARCHAR(100)
		, Telephone VARCHAR(50)
		, SiteEmail VARCHAR(50) NULL
		, JobId INT NULL
		, SurveyTypeId INT NULL
		, AppointmentDate DATE NULL
		, DateSiteWorkComplete DATETIME NULL
		, AnalysisComplete DATE NULL
		, TotalJobs INT NULL
		, WorkScheduled INT NULL
		, SiteWorkComplete INT NULL
		, Samples INT NULL
		, SampleResults INT NULL
		, [FileName] VARCHAR(50) NULL
		, ClientOrderNo VARCHAR(50) NULL
		, DateReceived NVARCHAR(40) NULL
		, UPRN VARCHAR(50) NULL
		, SurveyType NVARCHAR(MAX) NULL
		, Surveyor NVARCHAR(MAX) NULL
		, SurveyStart NVARCHAR(40) NULL
		, SurveyCompleted NVARCHAR(40) NULL
		, AnalysisCompleted NVARCHAR(40) NULL
		, Approved NVARCHAR(40) NULL
		, ApprovedBy VARCHAR(50) NULL
		, DueDate NVARCHAR(40) NULL
		, NoAccessAttempts INT NULL
		, GroupName NVARCHAR(50) NULL
		, ClientId INT NULL
		, ProjectId INT NULL
		, SiteId INT NULL
		, Other VARCHAR(MAX) NULL
		, ProjectAppointmentID INT NULL
	)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)
	SELECT @DynamicSQL = 'INSERT
		#JobSheetData
	SELECT
		pjs.SortOrder
		, pjs.AppointmentID
		, pjs.[Status]
		, pjs.StatusDate
		, pjs.JobNo
		, pjs.[Address]
		, pjs.Postcode
		, pjs.Contact
		, pjs.Telephone
		, pjs.SiteEmail
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.AppointmentDate
		, pjs.DateSiteWorkComplete
		, pjs.AnalysisComplete
		, pjs.TotalJobs
		, pjs.WorkScheduled
		, pjs.SiteWorkComplete
		, pjs.Samples
		, pjs.SampleResults
		, pjs.[FileName]
		, pjs.ClientOrderNo
		, pjs.DateReceived
		, pjs.UPRN
		, pjs.SurveyType
		, pjs.Surveyor
		, pjs.SurveyStart
		, pjs.SurveyCompleted
		, pjs.AnalysisCompleted
		, pjs.Approved
		, pjs.ApprovedBy
		, pjs.DueDate
		, pjs.NoAccessAttempts
		, pjs.GroupName
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, pjs.Other
		, pjspa.ProjectAppointmentID
	FROM
		ProjectJobSheet pjs
		INNER JOIN #ProjectIDs p ON p.ProjectID = pjs.ProjectID
		LEFT JOIN Appointment pjspa ON pjs.AppointmentID = pjspa.AppointmentID
	WHERE
		1 = 1'
	
	IF @ClientID IS NOT NULL BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' AND pjs.ClientID = ' + CONVERT(VARCHAR(10), @ClientID)  -- ClientID filter
	END
	IF @SiteID IS NOT NULL BEGIN
		SELECT @DynamicSQL = @DynamicSQL + ' AND pjs.SiteID = ' + CONVERT(VARCHAR(10), @SiteID)  -- SiteID filter
	END
	
	-- add dynamic order by
	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY ' + @OrderByString

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- get useful counts
    DECLARE @SurveysCompleted INT
    DECLARE @SurveysStillDue INT
    DECLARE @Approved INT
    DECLARE @SurveysOnTime INT
    DECLARE @SurveysOverTime INT
    DECLARE @UnScheduled INT
    DECLARE @KPI DECIMAL(12,2)
    DECLARE @TotalJobs_HasSampleResults INT
    DECLARE @Approved_HasSampleResults INT
    
	SELECT
		@SurveysCompleted = ISNULL(SUM(CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @SurveysStillDue = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' OR SortOrder = 3 THEN 0 ELSE 1 END)
								- SUM(CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @Approved = ISNULL(SUM(CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @SurveysOnTime = ISNULL(SUM(CASE WHEN DueDate > SurveyCompleted AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @SurveysOverTime = ISNULL(SUM(CASE WHEN DueDate < SurveyCompleted AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @UnScheduled = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
		, @KPI = ISNULL(CASE WHEN COUNT(SurveyCompleted) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN DueDate > SurveyCompleted AND SortOrder <> 3 THEN 1 ELSE 0 END)
					/ CONVERT(FLOAT,COUNT(SurveyCompleted)), 3) * 100 END, 0)
	FROM 
		#JobSheetData
		
	SELECT
		@TotalJobs_HasSampleResults = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' OR SortOrder = 3 THEN 0 ELSE 1 END), 0) 
		, @Approved_HasSampleResults = ISNULL(SUM(CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
	FROM 
		#JobSheetData
	WHERE
		Samples > 0
		AND Samples = SampleResults
		
	-- return useful counts to front end
	SELECT
		@SurveysStillDue AS WorkScheduled
		, @SurveysStillDue AS SurveysStillDue
		, @Approved AS Approved
		, @SurveysOnTime AS SurveysOnTime
		, @SurveysOverTime AS SurveysOverTime
		, @UnScheduled AS UnScheduled
		, @KPI AS KPI
		, @TotalJobs_HasSampleResults - @Approved_HasSampleResults AS SampleAnalysisComplete
		, @SurveysCompleted - @TotalJobs_HasSampleResults - @Approved AS SiteWorkComplete
	
	-- return raw data to front end
	SELECT
		*
	FROM
		#JobSheetData
	
	-- drop temp tables
	DROP TABLE #ProjectIDs
	DROP TABLE #JobSheetData
		
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetSampleReports') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetSampleReports] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[GetSampleReports]
    @PortalUserID INT,
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @ClientOrderNo VARCHAR(50) = '',
    @UPRN VARCHAR(50) = '',
    @AddressSearchString VARCHAR(200) = '',
    @StandalonesOnly BIT = 0,
    @JobNo INT = 0,
    @JobNoSearch INT = 0,
    @GetSiteDocuments INT = 0 /* 0 or NULL = Any, 1 = Yes, 2 = No */
/**********************************************************************
** Overview: Get a filtered collection of sample reports for the portal.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @ClientOrderNo = NULLIF(LTRIM(RTRIM(@ClientOrderNo)), ''),
        @UPRN = NULLIF(LTRIM(RTRIM(@UPRN)), ''),
        @AddressSearchString = NULLIF(LTRIM(RTRIM(@AddressSearchString)), ''),
        @StandalonesOnly = ISNULL(@StandalonesOnly, 0),
        @JobNo = NULLIF(@JobNo, 0),
        @JobNoSearch = NULLIF(@JobNoSearch, 0),
        @GetSiteDocuments = ISNULL(@GetSiteDocuments, 0)

    -- Declare a variable for storing dynamic SQL.
    DECLARE @DynamicSQL NVARCHAR(MAX) = ''

    -- Get all Bulk Sample Report Data up front to reduce the main SELECT table scans.
    DECLARE @BulkSampleReportData TABLE (IsSiteDocument BIT NOT NULL, JobID INT, JobNo INT, Status VARCHAR(100), Created DATETIME NOT NULL, Approved DATETIME, LastNoteCreated DATETIME, ClientID INT NOT NULL, Client VARCHAR(100) NOT NULL, BranchName VARCHAR(100), SiteID INT NOT NULL, Address VARCHAR(200) NOT NULL, Postcode VARCHAR(15) NOT NULL, UPRN VARCHAR(50), SampleCount INT NOT NULL, BulkSampleReport VARCHAR(100), DateAnalysedStart DATETIME NOT NULL, DateAnalysedFinish DATETIME NOT NULL, SiteDocumentID INT)

    -- Build the dynamic query. Get normal Bulk Sample Reports first.
    SELECT @DynamicSQL = '
    SELECT
        0 [IsSiteDocument],
        j.JobID,
        j.JobNo,
        j.Status,
        j.Created,
        j.Approved,
        MAX(n.DateCreated) [LastNoteCreated],
        c.ClientID,
        c.Client,
        c.BranchName,
        si.SiteID,
        si.Address,
        si.Postcode,
        si.UPRN,
        COUNT(1) [SampleCount],
        pdfFile.FileName [BulkSampleReport],
        ISNULL(CAST(MIN(s.DateAnalysed) AS DATE), GETDATE()) [DateAnalysedStart],
        ISNULL(CAST(MAX(s.DateAnalysed) AS DATE), GETDATE()) [DateAnalysedFinish],
        NULL [SiteDocumentID]
    FROM
        Sample s WITH (NOLOCK)
        INNER JOIN Room rm WITH (NOLOCK) ON s.RoomID = rm.RoomID
        INNER JOIN Register r WITH (NOLOCK) ON rm.RegisterID = r.RegisterID
        LEFT JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID AND c.Deleted IS NULL
        ' + CASE WHEN @ProjectID IS NOT NULL OR @ProjectGroupID IS NOT NULL THEN 'LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID' ELSE '' END + '
        INNER JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
        LEFT JOIN Note n WITH (NOLOCK) ON j.JobID = n.ItemID AND n.NoteTypeID = 3 AND n.PortalUserID IS NOT NULL
        OUTER APPLY
        (
            SELECT TOP 1 _pf.FileName [FileName]
            FROM PDF _pf WITH (NOLOCK)
            WHERE
                _pf.JobID = j.JobID
                    AND
                _pf.DateDeleted IS NULL
                    AND
                _pf.FileName LIKE ''%bsr%''
            ORDER BY
                _pf.DateCreated DESC
        ) pdfFile
    WHERE
        c.ClientID IN (' + @ClientIDs + ')
            AND
        si.Deleted IS NULL
            AND
        j.Cancelled IS NULL
            AND
        je.MainEmployee = 1
            AND
        NULLIF(s.SampleRef, '''') IS NOT NULL
            AND
        s.AsSample = 0
            AND
        s.SampleRef NOT LIKE ''%*%''
            AND
        s.SampleRef NOT LIKE ''%{%''
            AND
        j.SampleResultEmployeeID IS NOT NULL
            AND
        j.SampleContentEmployeeID IS NOT NULL
    '

    -- Add dynamic WHERE filters
    IF @ProjectGroupID IS NOT NULL OR @ProjectID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.Deleted IS NULL'
    END
    IF @ProjectGroupID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.ProjectGroupID = ' + CAST(@ProjectGroupID AS VARCHAR(20))
    END
    IF @ProjectID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.ProjectID = ' + CAST(@ProjectID AS VARCHAR(20))
    END
    IF @SiteIDs IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND si.SiteID IN (' + @SiteIDs + ')'
    END
    IF @ClientOrderNo IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND j.ClientOrderNo = ''' + @ClientOrderNo + ''''
    END
    IF @UPRN IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND si.UPRN = ''' + @UPRN + ''''
    END
    IF @AddressSearchString IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND ((si.Address LIKE ''%' + @AddressSearchString + '%'')
                OR
            (si.PostCode LIKE ''%' + @AddressSearchString + '%'')
                OR
            (si.Address + '', '' + ISNULL(si.Postcode, '''') LIKE ''%' + @AddressSearchString + '%'')
                OR
            (si.UPRN = ''' + @AddressSearchString + ''')
                OR
            (j.ClientOrderNo = ''' + @AddressSearchString + ''')
        )'
    END
    IF @StandalonesOnly = 1
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND su.SurveyID IS NULL'
    END
    IF @JobNo IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND j.JobNo = ' + CAST(@JobNo AS VARCHAR(20))
    END
    IF @JobNoSearch IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND j.JobNo LIKE ''' + CAST(@JobNoSearch AS VARCHAR(20)) + '%'''
    END

    -- Add a GROUP BY
    SELECT @DynamicSQL = @DynamicSQL + '
    GROUP BY
        j.JobID,
        j.JobNo,
        j.Status,
        j.Created,
        j.Approved,
        c.ClientID,
        c.Client,
        c.BranchName,
        si.SiteID,
        si.Address,
        si.Postcode,
        si.UPRN,
        pdfFile.FileName
    '

    -- Add a HAVING
    SELECT @DynamicSQL = @DynamicSQL + '
    HAVING
        COUNT(1) = COUNT(s.SampleResultID)
    '

    -- Add ORDER BY
    SELECT @DynamicSQL = @DynamicSQL + '
    ORDER BY
        j.Approved DESC
    '

    -- Execute the SQL
    IF @GetSiteDocuments <> 1
    BEGIN
        INSERT INTO @BulkSampleReportData
        EXECUTE sp_executesql @DynamicSQL
    END
    SELECT @DynamicSQL = ''

    -- Build the dynamic query. Get the Site Documents.
    SELECT @DynamicSQL = @DynamicSQL + '
    SELECT
        1 [IsSiteDocument],
        NULL [JobID],
        NULL [JobNo],
        NULL [Status],
        sid.Uploaded [Created],
        NULL [Approved],
        NULL [LastNoteCreated],
        MAX(c.ClientID) [ClientID],
        MAX(c.Client) [Client],
        MAX(c.BranchName) [BranchName],
        si.SiteID,
        si.Address,
        si.Postcode,
        si.UPRN,
        sidc.SiteDocumentCount [SampleCount],
        sid.FileName [BulkSampleReport],
        sid.WorkDate [DateAnalysedStart],
        sid.WorkDate [DateAnalysedFinish],
        sid.SiteDocumentID
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID AND c.Deleted IS NULL
        ' + CASE WHEN @ProjectGroupID IS NOT NULL OR @ProjectID IS NOT NULL THEN '
        LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID'
            ELSE ''
        END + '
        OUTER APPLY
        (
            SELECT TOP 1
                sid.SiteDocumentID,
                sid.SiteID,
                sid.EmployeeID,
                sid.PortalUserID,
                sid.FileName,
                sid.Uploaded,
                sidi.SiteDocumentInformationID,
                sidi.WorkDate
            FROM
                SiteDocument sid WITH (NOLOCK)
                INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentID = sidi.SiteDocumentID
            WHERE
                sid.SiteID = si.SiteID
                    AND
                sid.Deleted IS NULL
                    AND
                sid.SiteDocumentTypeID = 4
            ORDER BY
                sid.Uploaded DESC
        ) sid
        OUTER APPLY
        (
            SELECT COUNT(*) [SiteDocumentCount]
            FROM SiteDocument sid WITH (NOLOCK)
            WHERE
                sid.SiteID = si.SiteID
                    AND
                sid.Deleted IS NULL
                    AND
                sid.SiteDocumentTypeID = 4
        ) sidc
    WHERE
        c.ClientID IN (' + @ClientIDs + ')
            AND
        si.Deleted IS NULL
            AND
        sid.SiteDocumentID IS NOT NULL
    '

    -- Add dynamic WHERE filters
    IF @ProjectGroupID IS NOT NULL OR @ProjectID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.Deleted IS NULL'
    END
    IF @ProjectGroupID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.ProjectGroupID = ' + CAST(@ProjectGroupID AS VARCHAR(20))
    END
    IF @ProjectID IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND p.ProjectID = ' + CAST(@ProjectID AS VARCHAR(20))
    END
    IF @SiteIDs IS NOT NULL
    BEGIN
        SELECT @DynamicSQL = @DynamicSQL + ' AND si.SiteID IN (' + @SiteIDs + ')'
    END

    -- Add a GROUP BY
    SELECT @DynamicSQL = @DynamicSQL + '
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        si.UPRN,
        sid.SiteDocumentID,
        sid.FileName,
        sid.Uploaded,
        sid.WorkDate,
        sidc.SiteDocumentCount
    '

    -- Add ORDER BY
    SELECT @DynamicSQL = @DynamicSQL + '
    ORDER BY
        sid.Uploaded DESC
    '

    -- Execute the SQL
    IF @GetSiteDocuments <> 2
    BEGIN
        INSERT INTO @BulkSampleReportData
        EXECUTE sp_executesql @DynamicSQL
    END
    SELECT @DynamicSQL = ''

    -- Start the main SELECT
    SELECT *
    FROM @BulkSampleReportData
    ORDER BY
        ISNULL(Approved, Created) DESC,
        IsSiteDocument


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'P' AND name = 'Paged_MyRisksAsbestos')
BEGIN
    EXEC('CREATE PROCEDURE [dbo].[Paged_MyRisksAsbestos] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_MyRisksAsbestos]

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	-- From original portal SP
    @Risk VARCHAR(100) = '',
    @RecAction VARCHAR(100) = '',

	@SampleClassificationID INT = 0, -- (0=all)
	@HideInaccessibleItems INT = 0,
	@HideInaccessibleRooms INT = 0,

	@SiteIdList VARCHAR(MAX) = ''

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;

    -- Set variables for logic.
    DECLARE @BasementName VARCHAR(50)
    SELECT
        @BasementName = ISNULL(NULLIF(cfg.s__BasementName, ''), 'Z-Sub Level')
    FROM
        Config cfg WITH (NOLOCK)

	DECLARE @ListView TABLE (JobNo INT,Address VARCHAR(200),Postcode VARCHAR(15),UPRN VARCHAR(50),Building VARCHAR(1000),FloorNumber INT,
								FloorDescription VARCHAR(MAX),RoomCode VARCHAR(MAX),RoomNumber INT,RoomDescription VARCHAR(50),
								RegisterItemNo INT,AsSample BIT,SampleRef VARCHAR(50),SourceDescription NVARCHAR(MAX),AsbestosType NVARCHAR(MAX),
								MaterialAssessmentScore INT,PriorityAssessmentScore INT,RiskScore INT,RiskScoreGroupColour VARCHAR(10),
								RecommendedAction NVARCHAR(100),RecommendedActionColour VARCHAR(6),TimescaleForCompletion VARCHAR(MAX),
								SurveyTypeID INT,JobID INT,SampleID INT,IsMAOnly BIT,SurveyStartDate DATE,SurveyFinishDate DATE,SampleClassificationID INT)

	INSERT INTO @ListView (JobNo,Address,Postcode,UPRN,Building,FloorNumber,
							FloorDescription,RoomCode,RoomNumber,RoomDescription,
							RegisterItemNo,AsSample,SampleRef,SourceDescription,AsbestosType,
							MaterialAssessmentScore,PriorityAssessmentScore,RiskScore,RiskScoreGroupColour,
							RecommendedAction,RecommendedActionColour,TimescaleForCompletion,
							SurveyTypeID,JobID,SampleID,IsMAOnly,SurveyStartDate,SurveyFinishDate,SampleClassificationID)
	SELECT DISTINCT
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        ISNULL(r.BuildingDesignation, 'No Building Designation') [Building],
        f.FloorNumber,
        ISNULL(f.DescriptionOverride, REPLACE(dbo.FloorName(f.FloorNumber), 'Z-Sub Level', @BasementName)) [FloorDescription],
        rm.RoomCode,
        rm.Number [RoomNumber],
        rm.Description [RoomDescription],
        s.RegisterItemNo,
        s.AsSample,
        s.SampleRef,
        scd.SourceDescription,
        scd.AsbestosType,
        scd.MaterialAssessmentScore,
        scd.PriorityAssessmentScore,
        scd.RiskScore,
        scd.RiskScoreGroupColour,
        scd.RecommendedAction,
        scd.RecommendedActionColour,
        DATENAME(MONTH, scd.TimescaleForCompletion) + ' ' + CAST(DATEPART(YEAR, scd.TimescaleForCompletion) AS VARCHAR(4)) [TimescaleForCompletion],
        su.SurveyTypeID,
        j.JobID,
        s.SampleID,
        scd.IsMAOnly,
        CAST(r.RegisterStart AS DATE) [SurveyStartDate],
        CAST(r.RegisterFinish AS DATE) [SurveyFinishDate],
		ISNULL(s.SampleClassificationID, 0) [SampleClassificationID]
    FROM
        GuidSamples gs WITH (NOLOCK) 
        INNER JOIN SampleComputedData scd WITH (NOLOCK) ON gs.SampleID = scd.SampleID AND gs.ClientID = scd.ClientID AND gs.SiteID = scd.SiteID
        INNER JOIN Sample s WITH (NOLOCK) ON scd.SampleID = s.SampleID
		LEFT JOIN Element e5 WITH (NOLOCK) ON s.SampleID = e5.SampleID AND e5.ElementTypeID = 5
        INNER JOIN Room rm WITH (NOLOCK) ON s.RoomID = rm.RoomID
        INNER JOIN Floorplan f WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Register r WITH (NOLOCK) ON f.RegisterID = r.RegisterID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN JobEmployee je WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Job j WITH (NOLOCK) ON je.JobID = j.JobID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN Site si WITH (NOLOCK) ON scd.SiteID = si.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON scd.ClientID = c.ClientID
        LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
    WHERE
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
            AND
        si.Post2000 = 0 AND si.UnmanagedSite = 0 /* Also hide Post 2000 and Unmanaged Sites for this table. */
            AND
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
        scd.Removed = 0
            AND
        scd.RecommendedAction IS NOT NULL
			AND
		(@RecAction='' OR scd.RecommendedAction=@RecAction)
			AND
		(@SampleClassificationID=0 OR s.SampleClassificationID=@SampleClassificationID)
			AND
		(@HideInaccessibleRooms=0 OR rm.Inaccessible=0)
			AND
		(@HideInaccessibleItems = 0 OR e5.ElementIntID != 0)
			AND
		(@SiteIdList = '' OR si.SiteID IN (select convert(int,s) from dbo.SplitString(ltrim(rtrim(@SiteIdList)), ',')) )
    ORDER BY
        j.JobNo,
        si.Address,
        si.Postcode,
        si.UPRN,
        Building,
        f.FloorNumber,
        rm.RoomCode,
        rm.Number,
        s.RegisterItemNo

    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@ListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(ORDER BY a.JobNo,a.Address,a.Postcode,a.UPRN,a.Building,a.FloorNumber,
									a.RoomCode,a.RoomNumber,a.RegisterItemNo) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @ListView
            ) a
    )

    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.JobNo,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Building,
        main.FloorNumber,
        main.FloorDescription,
        main.RoomCode,
        main.RoomNumber,
        main.RoomDescription,
        main.RegisterItemNo,
        main.AsSample,
        main.SampleRef,
        main.SourceDescription,
        main.AsbestosType,
        main.MaterialAssessmentScore,
        main.PriorityAssessmentScore,
        main.RiskScore,
        main.RiskScoreGroupColour,
        main.RecommendedAction,
        main.RecommendedActionColour,
        main.TimescaleForCompletion,
        main.SurveyTypeID,
        main.JobID,
        main.SampleID,
        main.IsMAOnly,
        main.SurveyStartDate,
        main.SurveyFinishDate,
		main.SampleClassificationID
    From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetInvoiced') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetInvoiced] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_NotYetInvoiced]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @JobID INT = 0,
    @Address VARCHAR(MAX) = NULL,
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @FilterEndStartDate DATETIME = NULL,
    @FilterEndFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    --@QuoteTypeID INT = 0,
    @QuoteVisitTypeID INT = 0,
    @Complete BIT = NULL,

	-- Order bys
    @OrderByQuoteType INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByPostcode INT = 0,
    @OrderByProject INT = 0,
    @OrderByJobNo INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderByValue INT = 0,
    @OrderByDate INT = 0,
    @OrderByStartDate INT = 0,
    @OrderByFinishDate INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Invoiced tab. Replaces the NotYetInvoiced view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        --@FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        --@FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        --@FilterEndStartDate = ISNULL(@FilterEndStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        --@FilterEndFinishDate = ISNULL(@FilterEndFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Address = NULLIF(LTRIM(RTRIM(@Address)), '')

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				erca.EmployeeRestrictedClientAccessID
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByQuoteType = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByPostcode = 0 AND @OrderByProject = 0 AND @OrderByJobNo = 0 AND @OrderByClientOrderNo = 0 AND @OrderByValue = 0 AND @OrderByDate = 0
    BEGIN
        SET @OrderByDate = 2
    END
    
    -- Set variables for logic.
    DECLARE @b__NYI_AirTestCompletedPriorToday BIT, @i__maxNoOfNoAccessBeforeRaiseQuote INT
    SELECT
        @b__NYI_AirTestCompletedPriorToday = cfg.b__NYI_AirTestCompletedPriorToday,
        @i__maxNoOfNoAccessBeforeRaiseQuote = cfg.i__maxNoOfNoAccessBeforeRaiseQuote
    FROM
        Config cfg WITH (NOLOCK)

    DECLARE @NotYetInvoicedJobs TABLE (JobID INT, JobNo INT, InvoiceItemID INT, NoAccess BIT, Created DATETIME, HasAppointment BIT, AppointmentCost MONEY, AppointmentClientOrderNo VARCHAR(MAX), DateConfirmed DATETIME, AppointmentTypeID INT, HasNoAccess BIT)
    INSERT INTO @NotYetInvoicedJobs (JobID, JobNo, InvoiceItemID, NoAccess, Created, HasAppointment, AppointmentCost, AppointmentClientOrderNo, DateConfirmed, AppointmentTypeID, HasNoAccess)
    SELECT
            a.JobID, a.JobNo, a.InvoiceItemID, 0 [NoAccess], a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID, a.HasNoAccess
      FROM
      (
            SELECT
                  j.JobID,
                  j.JobNo,
                  q.InvoiceItemID,
                  CAST(ISNULL(a.EndTime, q.Created) AS DATE) [Created],
                  CASE WHEN a.AppointmentID IS NOT NULL THEN 1 ELSE 0 END [HasAppointment],
                  a.Cost [AppointmentCost],
                  a.ClientOrderNo [AppointmentClientOrderNo],
                  a.DateConfirmed,
                  a.AppointmentTypeID,
                  CASE WHEN na.NoAccessID IS NOT NULL THEN 1 ELSE 0 END [HasNoAccess],
                  ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY a.EndTime ASC, q.Created ASC) [Identified]
            FROM
                  Job j WITH (NOLOCK)
                  INNER JOIN Client c WITH (NOLOCK) ON j.ClientID = c.ClientID
                  LEFT JOIN Site si WITH (NOLOCK) ON j.SiteID = si.SiteID
                  LEFT JOIN Project p WITH (NOLOCK) ON j.ProjectID = p.ProjectID
                  INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                  INNER JOIN QuoteType qt WITH (NOLOCK) ON qt.QuoteTypeID=q.QuoteTypeID
                  LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                  LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
            WHERE
                  (CASE WHEN @QuoteVisitTypeID = 0 THEN 1 ELSE CASE WHEN qt.QuoteVisitTypeID=@QuoteVisitTypeID THEN 1 ELSE 0 END END = 1)
                        AND
                  q.Accepted IS NOT NULL
                        AND
                  j.Cancelled IS NULL
                        AND
                  j.ImportID IS NULL
                        AND
                  a.DateDeclined IS NULL
                        AND -- NOTE: These WHERE clauses are repeated in the second UNION.
                  (CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID=@ClientID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN p.ProjectID=@ProjectID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN si.SiteID=@SiteID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @BranchOfficeID = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID=@BranchOfficeID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID=@JobID THEN 1 ELSE 0 END END = 1)
                        AND
                  (CASE WHEN @Address IS NULL THEN 1 ELSE CASE WHEN si.[Address] LIKE '%' + @Address + '%' OR a.ClientOrderNo LIKE '%' + @Address + '%' OR j.JobNo LIKE '%' + REPLACE(@Address, 'j', '') + '%' THEN 1 ELSE 0 END END = 1)
						AND
				j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      ) a
      WHERE
            a.Identified = 1
                  AND
            (
                  CASE WHEN a.HasNoAccess = 0 THEN
                        CASE WHEN a.InvoiceItemID IS NULL THEN 1 ELSE 0 END
                  ELSE
                        1
                  END = 1
            )

	IF @i__maxNoOfNoAccessBeforeRaiseQuote < 999 BEGIN
      INSERT INTO @NotYetInvoicedJobs (JobID, InvoiceItemID, NoAccess, Created, HasAppointment, AppointmentCost, AppointmentClientOrderNo, DateConfirmed, AppointmentTypeID, HasNoAccess)
      SELECT
            a.JobID, a.InvoiceItemID, 1, a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID, 1
      FROM  
            (
                  SELECT nyij.JobID, nyij.JobNo, dbo.FormatTeamsReference('J',nyij.JobNo) [FormattedJobNo], nyij.InvoiceItemID, 1 [NoAccess], nyij.Created, nyij.HasAppointment, nyij.AppointmentCost, nyij.AppointmentClientOrderNo, nyij.DateConfirmed, nyij.AppointmentTypeID  FROM @NotYetInvoicedJobs nyij LEFT OUTER JOIN NoAccess na WITH (NOLOCK) ON na.JobID = nyij.JobID WHERE nyij.HasNoAccess = 1
            ) a
            LEFT OUTER JOIN InvoiceItem ii WITH (NOLOCK) ON (ii.JobNo = a.FormattedJobNo OR ii.InvoiceItemID=a.InvoiceItemID)
            LEFT OUTER JOIN Invoice i WITH (NOLOCK) ON i.InvoiceID=ii.InvoiceID
      WHERE
            (
            CASE WHEN ii.InvoiceItemID IS NULL THEN
                        1
                  ELSE
                        CASE WHEN ii.InvoiceItemID=a.InvoiceItemID AND i.DateCompleted IS NULL THEN
                              1
                        ELSE
                              0
                        END
                  END = 1
        )
      GROUP BY
            a.JobID, a.InvoiceItemID, a.Created, a.HasAppointment, a.AppointmentCost, a.AppointmentClientOrderNo, a.DateConfirmed, a.AppointmentTypeID
      HAVING 
            COUNT(*) >= @i__maxNoOfNoAccessBeforeRaiseQuote
	END


    DECLARE @NotYetInvoicedData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, BranchOfficeID INT, QuoteTypeID INT, QuoteType VARCHAR(100), ClientID INT, Client VARCHAR(210), ProjectID INT, Project VARCHAR(110), SiteID INT, Address VARCHAR(200), Postcode VARCHAR(15), Created DATETIME, Value MONEY, ClientOrderNo VARCHAR(50), JobID INT, JobNo INT, Complete BIT, StartDate DATETIME, FinishDate DATETIME)

    INSERT INTO @NotYetInvoicedData (QuoteID, QuoteNo, BranchOfficeID, QuoteTypeID, QuoteType, ClientID, Client, ProjectID, Project, SiteID, Address, Postcode, Created, Value, ClientOrderNo, JobID, JobNo, Complete, StartDate, FinishDate)
    SELECT
        i.QuoteID,
        i.QuoteNo,
        i.BranchOfficeID,
        i.QuoteTypeID,
        i.QuoteType,
        i.ClientID,
        i.Client,
        i.ProjectID,
        i.Project,
        i.SiteID,
        i.Address,
        i.Postcode,
        i.Created,
        i.Value,
        i.ClientOrderNo,
        i.JobID,
        i.JobNo,
        i.Complete,
        i.StartDate,
        i.FinishDate
    FROM
        (
            -- Normal joins for displaying in Not Yet Invoiced.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                nyij.Created [Created], -- NOTE: When adjusting, also adjust the HAVING.
                ISNULL(MAX(a.Cost), MAX(q.Value)) [Value],
                ISNULL(NULLIF(a.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete,
                CAST(COALESCE(MIN(r.RegisterStart), MIN(at.AirTestStart), MIN(l.LegionellaStart), nyij.Created) AS DATE) [StartDate],
                CAST(COALESCE(MAX(r.RegisterFinish), MAX(at.AirTestFinish), MAX(l.LegionellaFinish), nyij.Created) AS DATE) [FinishDate]
            FROM
                @NotYetInvoicedJobs nyij
                INNER JOIN Quote q WITH (NOLOCK) ON nyij.JobID = q.JobID
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN AirTestType att WITH (NOLOCK) ON at.AirTestTypeID = att.AirTestTypeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                LEFT JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = qt.TemplateTypeID
                LEFT JOIN TemplateTypeGroup tg WITH (NOLOCK) ON Not tg.GroupId = 0 And tg.GroupId = tt.GroupNo 
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                a.AppointmentID IS NOT NULL
                                    AND
                                a.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        a.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        a.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                                OR
                            ( -- Quote has a Bulk Sample Report that is not Approved.
                                a.AppointmentID IS NULL
                                    AND
                                qt.QuoteTypeID = 6
                                    AND
                                j.Approved IS NULL
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                nyij.InvoiceItemID IS NULL -- Make sure the Quote isn't already on an Invoice.
                    AND
                ( -- Work out if the work has been done:
                    ( -- Quote has an Appointment that is confirmed.
                        a.AppointmentID IS NOT NULL
                            AND
                        a.DateConfirmed IS NOT NULL
                            AND
                        (
                            ( -- Is a Survey that has work done.
                                a.AppointmentTypeID = 1
                                    AND
                                (r.RegisterID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is an Air Test.
                                a.AppointmentTypeID = 3
                                    AND
                                (
                                    (at.AirTestID IS NULL AND a.ManuallyMarkWorkDone = 1)
                                        OR
                                    (at.AirTestID IS NOT NULL AND att.AirTestTypeID IS NOT NULL)
                                )
                            )
                                OR
                            ( -- Is a Training Appointment.
                                a.AppointmentTypeID = 4
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                                OR
                            ( -- Is a Legionella Survey that has work done.
                                a.AppointmentTypeID = 9
                                    AND
                                (l.LegionellaID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is a general Appointment and work has been marked as done if booked.
                                a.AppointmentTypeID NOT IN (1, 3, 9)
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                        )
                    )
                        OR
                    ( -- Quote has a Bulk Sample Report that is approved.
                        a.AppointmentID IS NULL
                            AND
                        qt.QuoteTypeID = 6
                    )
                )
                    AND
                nyij.NoAccess = 0
					AND
				a.DateDeclined IS NULL
            GROUP BY
                nyij.Created,
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client,
                c.BranchName,
                p.ProjectID,
                p.Project,
                p.GroupName,
                si.SiteID,
                si.Address,
                si.Postcode,
                a.AppointmentTypeID,
                a.ClientOrderNo,
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                com.Complete
            HAVING -- NOTE: When adjusting, also adjust the SELECT column for the Created date.
                CASE WHEN a.AppointmentTypeID = 3 -- Will not show Air Test Appointments until the current date is greater than the Appoinment date.
                    THEN CASE WHEN @b__NYI_AirTestCompletedPriorToday = 1 AND MIN(nyij.Created) > GETDATE() THEN 0 ELSE 1 END
                   ELSE 1
                END = 1

            UNION

            /*
            TEMP table and check this for each job to populate, that way the below can be from that table as base, should increase speed a large amount
                        (SELECT COUNT(*) FROM NoAccess WITH (NOLOCK) WHERE JobID = j.JobID AND Deleted IS NULL) >= @i__maxNoOfNoAccessBeforeRaiseQuote
            
            Will need to do a straight join from previous TEMP table on JobNo (this is a varchar(10) /golfclap)
                NOT EXISTS (SELECT 1 FROM InvoiceItem WITH (NOLOCK) WHERE JobNo = dbo.FormatTeamsReference('J', j.JobNo))
            Select top 10 * FROM InvoiceItem
            */

            -- No Access data.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                125 [QuoteTypeID],
                (SELECT QuoteType FROM QuoteType WITH (NOLOCK) WHERE QuoteTypeID = 125) [QuoteType],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                CAST(ISNULL(nyij.Created, q.Created) AS DATE) [Created],
                ISNULL(nyij.AppointmentCost, q.Value) [Value],
                ISNULL(NULLIF(nyij.AppointmentClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete,
                nyij.Created [StartDate],
                nyij.Created [FinishDate]
                --CAST(COALESCE(r.RegisterStart, at.AirTestStart, l.LegionellaStart, nyij.Created) AS DATE) [StartDate],
                --CAST(COALESCE(r.RegisterFinish, at.AirTestFinish, l.LegionellaFinish, nyij.Created) AS DATE) [FinishDate]
            FROM
                @NotYetInvoicedJobs nyij
                INNER JOIN Quote q WITH (NOLOCK) ON nyij.JobID = q.JobID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                INNER JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                nyij.HasAppointment IS NOT NULL
                                    AND
                                nyij.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        nyij.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        nyij.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                nyij.NoAccess = 1
        ) i
    WHERE
        (CASE WHEN @FilterStartDate IS NOT NULL AND @FilterFinishDate IS NOT NULL
            THEN
                CASE WHEN i.StartDate BETWEEN @FilterStartDate AND @FilterFinishDate
                    THEN 1
                    ELSE 0
                END
            ELSE 1
        END = 1
            OR
        CASE WHEN @FilterEndStartDate IS NOT NULL AND @FilterEndFinishDate IS NOT NULL
            THEN
                CASE WHEN i.FinishDate BETWEEN @FilterEndStartDate AND @FilterEndFinishDate
                    THEN 1
                    ELSE 0
                END
            ELSE 1
        END = 1)
            AND
        (
            @Complete IS NULL
                OR
            (@Complete = 0 AND i.Complete = 0)
                OR
            (@Complete = 1 AND i.Complete = 1)
        )
    ORDER BY
        CASE WHEN @OrderByQuoteType = 1 THEN i.QuoteType ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteType = 2 THEN i.QuoteType ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN i.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN i.Address ELSE NULL END DESC,
        CASE WHEN @OrderByPostcode = 1 THEN i.Postcode ELSE NULL END ASC,
        CASE WHEN @OrderByPostcode = 2 THEN i.Postcode ELSE NULL END DESC,
        CASE WHEN @OrderByProject = 1 THEN i.Project ELSE NULL END ASC,
        CASE WHEN @OrderByProject = 2 THEN i.Project ELSE NULL END DESC,
        CASE WHEN @OrderByJobNo = 1 THEN i.JobNo ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN i.JobNo ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN i.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN i.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN i.Value ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN i.Value ELSE NULL END DESC,
        CASE WHEN @OrderByStartDate = 1 THEN i.StartDate ELSE NULL END ASC,
        CASE WHEN @OrderByStartDate = 2 THEN i.StartDate ELSE NULL END DESC,
        CASE WHEN @OrderByFinishDate = 1 THEN i.FinishDate ELSE NULL END ASC,
        CASE WHEN @OrderByFinishDate = 2 THEN i.FinishDate ELSE NULL END DESC

    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetInvoicedData);

    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetInvoicedData
           ) a
    )


    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        q.BranchOfficeID,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.QuoteTypeID,
        pag.QuoteType,
        apt.AppointmentTypeID,
        ISNULL(apt.AppointmentType, 'Samples') [AppointmentType],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.Project,
        pag.SiteID,
        pag.Address,
        pag.Postcode,
        si.UPRN,
        pag.Created,
        CAST(CASE WHEN pag.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Value,
        pag.ClientOrderNo,
        pag.JobID,
        pag.JobNo,
        NULLIF(j.ClientOrderNo, '') [JobClientOrderNo],
        pag.Complete,
        pag.StartDate,
        pag.FinishDate,
		q.CurrencyId [CurrencyID]
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
        LEFT JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num

    SELECT
            a.QuoteVisitTypeID, a.QuoteVisitType, a.Value, a.Ordering
    FROM
      (
            SELECT 
                  qvt.QuoteVisitTypeID, qvt.Description [QuoteVisitType]/*, qt.QuoteType*/, SUM(nyid.Value) [Value], 0 [Ordering], MAX(nyid.QuoteID) [test]
            FROM 
                  QuoteVisitType qvt WITH (NOLOCK)
                  LEFT OUTER JOIN QuoteType qt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qt.QuoteVisitTypeID
                  LEFT OUTER JOIN Quote q WITH (NOLOCK) ON qt.QuoteTypeID=q.QuoteTypeID
                  LEFT OUTER JOIN
                  (
                        Select
                              nyid.JobID, nyid.QuoteID, MAX(nyid.Value) [Value]
                        FROM
                              @NotYetInvoicedData nyid
                        GROUP BY
                              nyid.JobID, nyid.QuoteID
                  ) nyid ON nyid.QuoteID=q.QuoteID
            WHERE
                  qvt.Deleted IS NULL
            GROUP BY
                  qvt.QuoteVisitTypeID,qvt.Description
            UNION
            SELECT 
                  NULL [QuoteVisitTypeID], 'Total' [QuoteVisitType], /*'Total' [QuoteType],*/ SUM(nyid.Value) [Value], 1 [Ordering], 0 [test]
            FROM 
                  QuoteVisitType qvt WITH (NOLOCK)
                  LEFT OUTER JOIN
                  (
                        Select
                              nyid.JobID, nyid.QuoteID, qt.QuoteVisitTypeID, MAX(nyid.Value) [Value]
                        FROM
                              @NotYetInvoicedData nyid
                              INNER JOIN Quote q WITH (NOLOCK) ON nyid.QuoteID=q.QuoteID
                              INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID=qt.QuoteTypeID
                        GROUP BY
                              nyid.JobID, nyid.QuoteID, qt.QuoteVisitTypeID
                  ) nyid ON qvt.QuoteVisitTypeID=nyid.QuoteVisitTypeID
      ) a
      ORDER BY
          a.Ordering,
          a.QuoteVisitType


    SET NOCOUNT OFF;
END
GO


IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_NotYetInvoicedWithGroupFilter') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_NotYetInvoicedWithGroupFilter] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_NotYetInvoicedWithGroupFilter]
    @PerPage INT = 15,
    @CurrentPage INT = 1,
    @ClientID INT = 0,
    @ProjectID INT = 0,
    @SiteID INT = 0,
    @FilterStartDate DATETIME = NULL,
    @FilterFinishDate DATETIME = NULL,
    @BranchOfficeID INT = 0,
    --@QuoteTypeID INT = 0,
	@GroupID INT = 0,
    @Complete BIT = NULL,
    @JobID INT = 0,
    @Address VARCHAR(MAX) = NULL,
    @OrderByQuoteType INT = 0,
    @OrderByClient INT = 0,
    @OrderBySite INT = 0,
    @OrderByPostcode INT = 0,
    @OrderByProject INT = 0,
    @OrderByJobNo INT = 0,
    @OrderByClientOrderNo INT = 0,
    @OrderByValue INT = 0,
    @OrderByDate INT = 0
/**********************************************************************
** Overview: Get the data for the Not Yet Invoiced tab. Replaces the NotYetInvoiced view.
**********************************************************************/
WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;
    
    
    -- Set default variable values if not passed in.
    SELECT
        @FilterStartDate = ISNULL(@FilterStartDate, CAST(DATEADD(YY, -1, GETDATE()) AS DATE)),
        @FilterFinishDate = ISNULL(@FilterFinishDate, CAST(CAST(CAST(DATEADD(M, 3, GETDATE()) AS DATE) AS VARCHAR(100)) + ' 23:59:59.997' AS DATETIME)),
        @Address = NULLIF(LTRIM(RTRIM(@Address)), '')
    
    -- Validate the ORDER BY parameters. Set a default ORDER BY if not passed in.
    IF @OrderByQuoteType = 0 AND @OrderByClient = 0 AND @OrderBySite = 0 AND @OrderByPostcode = 0 AND @OrderByProject = 0 AND @OrderByJobNo = 0 AND @OrderByClientOrderNo = 0 AND @OrderByValue = 0 AND @OrderByDate = 0
    BEGIN
        SET @OrderByDate = 2
    END
    
    -- Test the ORDER BY parameters.
    /*
    SELECT
        @OrderByQuoteType [OrderByQuoteType],
        @OrderByClient [OrderByClient],
        @OrderBySite [OrderBySite],
        @OrderByPostcode [OrderByPostcode],
        @OrderByProject [OrderByProject],
        @OrderByJobNo [OrderByJobNo],
        @OrderByClientOrderNo [OrderByClientOrderNo],
        @OrderByValue [OrderByValue],
        @OrderByDate [OrderByDate]
    */
    
    -- Set variables for logic.
    DECLARE @b__NYI_AirTestCompletedPriorToday BIT, @i__maxNoOfNoAccessBeforeRaiseQuote INT
    SELECT
        @b__NYI_AirTestCompletedPriorToday = cfg.b__NYI_AirTestCompletedPriorToday,
        @i__maxNoOfNoAccessBeforeRaiseQuote = cfg.i__maxNoOfNoAccessBeforeRaiseQuote
    FROM
        Config cfg WITH (NOLOCK)
    
    -- Get all the Not Yet Invoiced data - just the minimum ammount of data for speed.
    -- NOTE: Looking at comments from the old view, j.Approved logic has been removed as it's been superseded by the Completed field below.
    DECLARE @NotYetInvoicedData TABLE (IndexID INT IDENTITY(1,1), QuoteID INT, QuoteNo INT, BranchOfficeID INT, QuoteTypeID INT, QuoteType VARCHAR(100), ClientID INT, Client VARCHAR(210), ProjectID INT, Project VARCHAR(110), SiteID INT, Address VARCHAR(200), Postcode VARCHAR(15), Created DATETIME, Value MONEY, ClientOrderNo VARCHAR(50), JobID INT, JobNo INT, Complete BIT)
    
    INSERT INTO @NotYetInvoicedData
    SELECT
        i.QuoteID,
        i.QuoteNo,
        i.BranchOfficeID,
        i.QuoteTypeID,
        i.QuoteType,
        i.ClientID,
        i.Client,
        i.ProjectID,
        i.Project,
        i.SiteID,
        i.Address,
        i.Postcode,
        i.Created,
        i.Value,
        i.ClientOrderNo,
        i.JobID,
        i.JobNo,
        i.Complete
    FROM
        (
            -- Normal joins for displaying in Not Yet Invoiced.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                MIN(CAST(ISNULL(a.EndTime, q.Created) AS DATE)) [Created], -- NOTE: When adjusting, also adjust the HAVING.
                ISNULL(MAX(a.Cost), MAX(q.Value)) [Value],
                ISNULL(NULLIF(a.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete
            FROM
                Quote q WITH (NOLOCK)
                INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                LEFT JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
                LEFT JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN AirTest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                LEFT JOIN AirTestType att WITH (NOLOCK) ON at.AirTestTypeID = att.AirTestTypeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
				LEFT JOIN TemplateType tt WITH (NOLOCK) ON tt.TemplateTypeID = qt.TemplateTypeID
				LEFT JOIN TemplateTypeGroup tg WITH (NOLOCK) ON Not tg.GroupId = 0 And tg.GroupId = tt.GroupNo 
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                a.AppointmentID IS NOT NULL
                                    AND
                                a.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        a.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        a.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                                OR
                            ( -- Quote has a Bulk Sample Report that is not Approved.
                                a.AppointmentID IS NULL
                                    AND
                                qt.QuoteTypeID = 6
                                    AND
                                j.Approved IS NULL
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                q.Accepted IS NOT NULL -- Make sure the Quote has been Accepted.
                    AND
                q.InvoiceItemID IS NULL -- Make sure the Quote isn't already on an Invoice.
                    AND
                a.DateDeclined IS NULL -- Make sure the Appointment is not declined.
                    AND
                j.Cancelled IS NULL -- Make sure the Job has not been cancelled.
                    AND
                ( -- Work out if the work has been done:
                    ( -- Quote has an Appointment that is confirmed.
                        a.AppointmentID IS NOT NULL
                            AND
                        a.DateConfirmed IS NOT NULL
                            AND
                        (
                            ( -- Is a Survey that has work done.
                                a.AppointmentTypeID = 1
                                    AND
                                (r.RegisterID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is an Air Test.
                                a.AppointmentTypeID = 3
                                    AND
                                (
                                    (at.AirTestID IS NULL AND a.ManuallyMarkWorkDone = 1)
                                        OR
                                    (at.AirTestID IS NOT NULL AND att.AirTestTypeID IS NOT NULL)
                                )
                            )
                                OR
                            ( -- Is a Training Appointment.
                                a.AppointmentTypeID = 4
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                                OR
                            ( -- Is a Legionella Survey that has work done.
                                a.AppointmentTypeID = 9
                                    AND
                                (l.LegionellaID IS NOT NULL OR a.ManuallyMarkWorkDone = 1)
                            )
                                OR
                            ( -- Is a general Appointment and work has been marked as done if booked.
                                a.AppointmentTypeID NOT IN (1, 3, 9)
                                    AND
                                a.ManuallyMarkWorkDone = 1
                            )
                        )
                    )
                        OR
                    ( -- Quote has a Bulk Sample Report that is approved.
                        a.AppointmentID IS NULL
                            AND
                        qt.QuoteTypeID = 6
                    )
                )
                    AND -- NOTE: These WHERE clauses are repeated in the second UNION.
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR p.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                (@BranchOfficeID = 0 OR q.BranchOfficeID = @BranchOfficeID)
                    AND
                (@GroupID = 0 OR tg.GroupID = @GroupID)
                    AND
                (@JobID = 0 OR j.JobID = @JobID)
                    AND
                (@Address IS NULL OR si.Address LIKE '%' + @Address + '%')
            GROUP BY
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                qt.QuoteTypeID,
                qt.QuoteType,
                c.ClientID,
                c.Client,
                c.BranchName,
                p.ProjectID,
                p.Project,
                p.GroupName,
                si.SiteID,
                si.Address,
                si.Postcode,
                a.AppointmentTypeID,
                a.ClientOrderNo,
                j.JobID,
                j.JobNo,
                j.ClientOrderNo,
                com.Complete
            HAVING -- NOTE: When adjusting, also adjust the SELECT column for the Created date.
                CASE WHEN a.AppointmentTypeID = 3 -- Will not show Air Test Appointments until the current date is greater than the Appoinment date.
                    THEN CASE WHEN @b__NYI_AirTestCompletedPriorToday = 1 AND MIN(CAST(ISNULL(a.EndTime, q.Created) AS DATE)) > GETDATE() THEN 0 ELSE 1 END
                    ELSE 1
                END = 1
            
            UNION
            
            -- No Access data.
            SELECT
                q.QuoteID,
                q.QuoteNo,
                q.BranchOfficeID,
                125 [QuoteTypeID],
                (SELECT QuoteType FROM QuoteType WITH (NOLOCK) WHERE QuoteTypeID = 125) [QuoteType],
                c.ClientID,
                c.Client + ISNULL(' (' + NULLIF(c.BranchName, '') + ')', '') [Client],
                p.ProjectID,
                NULLIF(p.Project, '') + ISNULL(' / ' + NULLIF(p.GroupName, ''), '') [Project],
                si.SiteID,
                si.Address,
                si.Postcode,
                CAST(ISNULL(fa.EndTime, q.Created) AS DATE) [Created],
                ISNULL(fa.Cost, q.Value) [Value],
                ISNULL(NULLIF(fa.ClientOrderNo, ''), NULLIF(j.ClientOrderNo, '')) [ClientOrderNo],
                j.JobID,
                j.JobNo,
                com.Complete
            FROM
                Quote q WITH (NOLOCK)
                OUTER APPLY
                (
                    SELECT TOP 1 _a.*
                    FROM Appointment _a WITH (NOLOCK)
                    WHERE
                        _a.QuoteID = q.QuoteID
                            AND
                        _a.DateDeclined IS NULL
                ) fa -- First Appointment
                INNER JOIN Client c WITH (NOLOCK) ON q.ClientID = c.ClientID
                LEFT JOIN Project p WITH (NOLOCK) ON q.ProjectID = p.ProjectID
                INNER JOIN Site si WITH (NOLOCK) ON q.SiteID = si.SiteID
                INNER JOIN Job j WITH (NOLOCK) ON q.JobID = j.JobID
                LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                LEFT JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID
                LEFT JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
                OUTER APPLY
                (
                    SELECT -- NOTE: Similiar logic to this is in the other UNION.
                        CASE WHEN
                            ( -- Is a Survey/Legionella Survey that is not Approved.
                                fa.AppointmentID IS NOT NULL
                                    AND
                                fa.DateConfirmed IS NOT NULL
                                    AND
                                (
                                    (
                                        fa.AppointmentTypeID = 1
                                            AND
                                        r.RegisterID IS NOT NULL
                                            AND
                                        r.DateApproved IS NULL
                                    )
                                        OR
                                    (
                                        fa.AppointmentTypeID = 9
                                            AND
                                        l.LegionellaID IS NOT NULL
                                            AND
                                        l.DateApproved IS NULL
                                    )
                                )
                            )
                            THEN 0
                            ELSE 1
                        END [Complete]
                ) com -- Complete
            WHERE
                (
                    q.InvoiceItemID IS NULL
                        OR -- IS THIS LINE CORRECT (JOIN TO INVOICE)?
                    (q.InvoiceItemID IS NOT NULL AND NOT EXISTS (SELECT 1 FROM Invoice WITH (NOLOCK) WHERE InvoiceID = q.InvoiceItemID AND DateCompleted IS NOT NULL))
                )
                    AND
                (SELECT COUNT(*) FROM NoAccess WITH (NOLOCK) WHERE JobID = j.JobID AND Deleted IS NULL) >= @i__maxNoOfNoAccessBeforeRaiseQuote
                    AND
                NOT EXISTS (SELECT 1 FROM InvoiceItem WITH (NOLOCK) WHERE JobNo = dbo.FormatTeamsReference('J', j.JobNo))
                    AND -- NOTE: These WHERE clauses are repeated in the first UNION.
                (@ClientID = 0 OR c.ClientID = @ClientID)
                    AND
                (@ProjectID = 0 OR p.ProjectID = @ProjectID)
                    AND
                (@SiteID = 0 OR si.SiteID = @SiteID)
                    AND
                (@BranchOfficeID = 0 OR q.BranchOfficeID = @BranchOfficeID)
                    AND
                --(@QuoteTypeID = 0 OR 125 = @QuoteTypeID)
                --    AND
                (@JobID = 0 OR j.JobID = @JobID)
                    AND
                (@Address IS NULL OR si.Address LIKE '%' + @Address + '%')
        ) i
    WHERE
        i.Created BETWEEN @FilterStartDate AND @FilterFinishDate
            AND
        (
            @Complete IS NULL
                OR
            (@Complete = 0 AND i.Complete = 0)
                OR
            (@Complete = 1 AND i.Complete = 1)
        )
    ORDER BY
        CASE WHEN @OrderByQuoteType = 1 THEN i.QuoteType ELSE NULL END ASC,
        CASE WHEN @OrderByQuoteType = 2 THEN i.QuoteType ELSE NULL END DESC,
        CASE WHEN @OrderByClient = 1 THEN i.Client ELSE NULL END ASC,
        CASE WHEN @OrderByClient = 2 THEN i.Client ELSE NULL END DESC,
        CASE WHEN @OrderBySite = 1 THEN i.Address ELSE NULL END ASC,
        CASE WHEN @OrderBySite = 2 THEN i.Address ELSE NULL END DESC,
        CASE WHEN @OrderByPostcode = 1 THEN i.Postcode ELSE NULL END ASC,
        CASE WHEN @OrderByPostcode = 2 THEN i.Postcode ELSE NULL END DESC,
        CASE WHEN @OrderByProject = 1 THEN i.Project ELSE NULL END ASC,
        CASE WHEN @OrderByProject = 2 THEN i.Project ELSE NULL END DESC,
        CASE WHEN @OrderByJobNo = 1 THEN i.JobNo ELSE NULL END ASC,
        CASE WHEN @OrderByJobNo = 2 THEN i.JobNo ELSE NULL END DESC,
        CASE WHEN @OrderByClientOrderNo = 1 THEN i.ClientOrderNo ELSE NULL END ASC,
        CASE WHEN @OrderByClientOrderNo = 2 THEN i.ClientOrderNo ELSE NULL END DESC,
        CASE WHEN @OrderByValue = 1 THEN i.Value ELSE NULL END ASC,
        CASE WHEN @OrderByValue = 2 THEN i.Value ELSE NULL END DESC,
        CASE WHEN @OrderByDate = 1 THEN i.Created ELSE NULL END ASC,
        CASE WHEN @OrderByDate = 2 THEN i.Created ELSE NULL END DESC
    
    -- Get the total number of rows.
    DECLARE @TotalRowNumber INT = (SELECT COUNT(*) FROM @NotYetInvoicedData);
    
    -- Use a CTE to setup paging.
    WITH Paging AS
    (
        SELECT
            ROW_NUMBER() OVER (ORDER BY a.IndexID) [Row_Num],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE ((ROW_NUMBER() OVER (ORDER BY a.IndexID) - 1) / @PerPage) + 1
            END [Page],
            CASE WHEN @PerPage = 0
                THEN 1
                ELSE CAST(CEILING(COUNT(*) OVER (PARTITION BY '') * 1.00 / @PerPage) AS INT)
            END [Pages],
            a.*
       FROM
           (
                SELECT * FROM @NotYetInvoicedData
           ) a
    )
    
    
    -- Start the main SELECT
    SELECT
        pag.Row_Num,
        @TotalRowNumber [Row_Total],
        pag.Page,
        pag.Pages,
        q.QuoteID,
        q.QuoteNo,
        q.BranchOfficeID,
        q.LastNoteCreated,
        CAST(CASE WHEN q.LastNoteCreated IS NOT NULL THEN 1 ELSE 0 END AS BIT) [HasNotes],
        CAST(
            CASE WHEN q.LastNoteCreated IS NOT NULL
                THEN
                    CASE WHEN q.LastNoteCreated > DATEADD(hh, -1, GETDATE())
                        THEN 1
                        ELSE 0
                    END
                ELSE 0
            END AS BIT) [NotesInLastHour],
        pag.QuoteTypeID,
        pag.QuoteType,
        apt.AppointmentTypeID,
        ISNULL(apt.AppointmentType, 'Samples') [AppointmentType],
        pag.ClientID,
        pag.Client,
        pag.ProjectID,
        pag.Project,
        pag.SiteID,
        pag.Address,
        pag.Postcode,
        si.UPRN,
        pag.Created,
        CAST(CASE WHEN pag.Created > DATEADD(hh, -1, GETDATE()) THEN 1 ELSE 0 END AS BIT) [IsNew],
        pag.Value,
        pag.ClientOrderNo,
        pag.JobID,
        pag.JobNo,
        NULLIF(j.ClientOrderNo, '') [JobClientOrderNo],
        pag.Complete
    FROM
        Paging pag WITH (NOLOCK)
        INNER JOIN Quote q WITH (NOLOCK) ON pag.QuoteID = q.QuoteID
        INNER JOIN QuoteType qt WITH (NOLOCK) ON q.QuoteTypeID = qt.QuoteTypeID
        LEFT JOIN AppointmentType apt WITH (NOLOCK) ON qt.AppointmentTypeID = apt.AppointmentTypeID
        LEFT JOIN Site si WITH (NOLOCK) ON pag.SiteID = si.SiteID
        LEFT JOIN Job j WITH (NOLOCK) ON pag.JobID = j.JobID
    WHERE
        (pag.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage)
            OR
        (@PerPage = 0 AND @CurrentPage = 0)
    ORDER BY
        pag.Row_Num
    
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_SiteList') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_SiteList] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Paged_SiteList] 

	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @BranchOfficeID INT = 0, -- (0=all)

	@PropertytypeID INT = 0, -- (0=all)
	@ConstructiontypeID INT = 0, -- (0=all)
	@ConstructionDate VARCHAR(MAX) = '', -- (''=all)
	@Other VARCHAR(MAX) = '', -- (''=all)
	@ShowPost2000 INT = 0
AS
BEGIN
    SET NOCOUNT ON;
    
    Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time
      
    DECLARE @SiteListView TABLE (SiteID INT,Address VARCHAR(200),Postcode VARCHAR(15),UPRN VARCHAR(500),Contact VARCHAR(100),
								Telephone VARCHAR(50),ConstructionDate VARCHAR(MAX),Region VARCHAR(MAX),Division VARCHAR(MAX),
								Other VARCHAR(MAX),Latitude FLOAT,Longitude FLOAT,Post2000 BIT,UnmanagedSite BIT,
								DocumentExists BIT,SampleResultsOverview VARCHAR(MAX),SampleResultsOverviewSortOrder NUMERIC,
								RiskSampleResultsOverview VARCHAR(MAX),RecommendedActionSampleResultsOverview VARCHAR(MAX),
								PropertyTypeID INT,ConstructionTypeID INT)

	Insert into @SiteListView (SiteID,Address,Postcode,UPRN,Contact,Telephone,ConstructionDate,Region,Division,Other,
								Latitude,Longitude,Post2000,UnmanagedSite,DocumentExists,SampleResultsOverview,
								SampleResultsOverviewSortOrder,RiskSampleResultsOverview,RecommendedActionSampleResultsOverview,
								PropertyTypeID,ConstructionTypeID)
	SELECT
		si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, '') [UPRN],
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat [Latitude],
        si.Location.Long [Longitude],
        si.Post2000,
        si.UnmanagedSite,
        CAST(CASE WHEN sid.SiteDocumentID > 0 THEN 1 ELSE 0 END AS BIT) [DocumentExists],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                ISNULL(
                    CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                        THEN MAX(ssros.RiskSampleResultsOverview)
                        ELSE MAX(ssros.RecommendedActionSampleResultsOverview)
                    END, '')
            ELSE NULL
        END [SampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN
                CASE WHEN MAX(CAST(c.UseRiskColours AS INT)) = 1
                    THEN MAX(ssros.RiskSortOrder)
                    ELSE MAX(ssros.RecommendedActionSortOrder)
                END
            ELSE NULL
        END [SampleResultsOverviewSortOrder],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RiskSampleResultsOverview), '')
            ELSE ''
        END [RiskSampleResultsOverview],
        CASE WHEN MAX(j.Approved) IS NOT NULL
            THEN ISNULL(MAX(ssros.RecommendedActionSampleResultsOverview), '')
            ELSE ''
        END [RecommendedActionSampleResultsOverview],
		ISNULL(si.PropertyTypeID, 0) [PropertyTypeID],
		ISNULL(si.ConstructionTypeID, 0) [ConstructionTypeID]
    FROM
        Site si WITH (NOLOCK)
        INNER JOIN ClientSite cs WITH (NOLOCK) ON si.SiteID = cs.SiteID
        INNER JOIN Client c WITH (NOLOCK) ON cs.ClientID = c.ClientID
		LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
        LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON c.ClientID = ssros.ClientID AND si.SiteID = ssros.SiteID
        OUTER APPLY
        (
            SELECT TOP 1 _sid.SiteDocumentID, _sidt.SiteDocumentTypeID
            FROM
                SiteDocument _sid WITH (NOLOCK)
                LEFT JOIN SiteDocumentType _sidt WITH (NOLOCK) ON _sid.SiteDocumentTypeID = _sidt.SiteDocumentTypeID AND _sidt.Deleted IS NULL AND _sidt.[Default] = 0
            WHERE _sid.SiteID = si.SiteID AND _sid.Deleted IS NULL
            ORDER BY _sidt.SiteDocumentTypeID DESC
        ) sid -- Site Documents
		OUTER APPLY
        (
            SELECT TOP 1
                j.JobID,
                j.Approved,
                j.ClientOrderNo
            FROM
                Job j WITH (NOLOCK)
            WHERE
                j.ClientID = c.ClientID
                    AND
                j.SiteID = si.SiteID
                    AND
                j.Cancelled IS NULL
                    AND
                j.Approved IS NOT NULL
            ORDER BY
                j.Approved DESC
        ) j
	WHERE
		(@ProjectID=0 OR p.ProjectID=@ProjectID)
			AND
		(@SiteID=0 OR si.SiteID=@SiteID)
			AND
		(@ClientID=0 OR c.ClientID=@ClientID)
            AND
		(@PropertytypeID=0 OR si.PropertyTypeID=@PropertytypeID)
			And
		(@ConstructiontypeID=0 OR si.ConstructionTypeID=@ConstructiontypeID)
			AND
		(@ConstructionDate='' OR si.ConstructionDate=@ConstructionDate)
			AND
		(@Other='' OR si.Other=@Other)
			AND
        si.Deleted IS NULL
            AND
        si.InactiveSite = 0
			AND
		(@ShowPost2000=1 OR (si.Post2000=0 OR si.Post2000 IS NULL))
			AND
		(
			(si.Postcode LIKE '%' + @Filter + '%') OR (si.UPRN LIKE '%' + @Filter + '%') OR (si.Address LIKE '%' + @Filter + '%')
		)
    GROUP BY
        si.SiteID,
        si.Address,
        si.Postcode,
        ISNULL(si.UPRN, ''),
        si.Contact,
        si.Telephone,
        si.ConstructionDate,
        si.Region,
        si.Division,
        si.Other,
        si.Location.Lat,
        si.Location.Long,
        si.Post2000,
        si.UnmanagedSite,
        sid.SiteDocumentID,
		si.PropertyTypeID,
		si.ConstructionTypeID
	ORDER BY
        SampleResultsOverviewSortOrder DESC,
        ISNULL(si.UPRN, ''),
        si.Address,
        si.Postcode
      
    DECLARE @TotalRowNumber INT = 
			(
				SELECT
					COUNT(*) [Number] 
				FROM 
					@SiteListView
			)
    
    ;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                ((Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode)-1) / @PerPage)+1
            END As Page, 

            Row_Number() Over(Order By a.SampleResultsOverviewSortOrder DESC, a.UPRN, a.Address, a.Postcode) as RowNumber, 

            *
        From 
            (
                SELECT * FROM @SiteListView
            ) a
    )
        
    Select  
		@TotalRowNumber [Row_Total],
		main.Pages,
		main.Page,
		main.RowNumber,
		main.SiteID,
        main.Address,
        main.Postcode,
        main.UPRN,
        main.Contact,
        main.Telephone,
        main.ConstructionDate,
        main.Region,
        main.Division,
        main.Other,
        main.Latitude,
        main.Longitude,
        main.Post2000,
        main.UnmanagedSite,
        main.SampleResultsOverview,
        main.SampleResultsOverviewSortOrder,
        main.RiskSampleResultsOverview,
        main.RecommendedActionSampleResultsOverview,
		main.PropertyTypeID,
		main.ConstructionTypeID
	From 
		Paging main
	Where 
        (
			main.RowNumber Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage
		) 
			Or 
		(
			@PerPage=0 
				And 
			@CurrentPage=0
		)
    Order By
        main.RowNumber
    
    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_GetJobDataForSites') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_GetJobDataForSites] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Portfolio_GetJobDataForSites]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = ''
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @Surveys BIT, @BulkSamples BIT, @AirTests BIT, @Legionella BIT, @b__onlyshowApprovedAirTestsOnPortal BIT, @b__PortalShowPDFsOnSitesTab BIT, @MoreThanOneSite BIT
    SELECT
		@Surveys = 1,
		@BulkSamples = 1,
		@AirTests = 1,
		@Legionella = 1,
        @b__onlyshowApprovedAirTestsOnPortal = cfg.b__onlyshowApprovedAirTestsOnPortal,
        @b__PortalShowPDFsOnSitesTab = cfg.b__PortalShowPDFsOnSitesTab,
        @MoreThanOneSite = CASE WHEN @SiteIDs IS NULL THEN 1 ELSE CASE WHEN CHARINDEX(',', @SiteIDs) > 0 THEN 1 ELSE 0 END END
    FROM
        Config cfg WITH (NOLOCK)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed. Also used by PopulateSiteJobsReinspectionState.
    CREATE TABLE #ClientIdData (ClientID INT PRIMARY KEY)
    INSERT INTO #ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    CREATE TABLE #SurveyTypeIdData (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO #SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT, UseRiskColours BIT)
    INSERT INTO @ClientSiteData (ClientID, SiteID, UseRiskColours)
    SELECT
        c.ClientID,
        si.SiteID,
        c.UseRiskColours
    FROM
        #ClientIdData cid
        INNER JOIN Client c WITH (NOLOCK) ON cid.ClientID = c.ClientID
        INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
        INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
        INNER JOIN (
            SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
        ) sis ON si.SiteID = sis.SiteID
    WHERE
        si.Deleted IS NULL
    GROUP BY
        c.ClientID,
        si.SiteID,
        c.UseRiskColours

    -- Get Job/Appointment data up front to reduce table scans.
    DECLARE @JobAppointmentData TABLE (ClientID INT, SiteID INT, UseRiskColours BIT, JobID INT)
    INSERT INTO @JobAppointmentData (ClientID, SiteID, UseRiskColours, JobID)
    SELECT
        csd.ClientID,
        csd.SiteID,
        csd.UseRiskColours,
        j.JobID
    FROM
        @ClientSiteData csd
        INNER JOIN Job j WITH (NOLOCK) ON csd.ClientID = j.ClientID AND csd.SiteID = j.SiteID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID AND q.Rejected IS NULL
        LEFT JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID
        LEFT JOIN AppointmentAirMonitoring aam WITH (NOLOCK) ON a.AppointmentID = aam.AppointmentID
    WHERE
        a.DateDeclined IS NULL
            AND
        j.Cancelled IS NULL
            AND
        (j.Approved IS NOT NULL OR (j.Approved IS NULL AND aam.AppointmentAirMonitoringID IS NOT NULL))
    GROUP BY
        csd.ClientID,
        csd.SiteID,
        csd.UseRiskColours,
        j.JobID

    -- Get all Site Jobs up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #SiteJobs (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)

    -- Add an index on important #SiteJobs fields to increase speed below.
    CREATE INDEX temp_SiteJobs ON #SiteJobs (SiteID)

    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, RegisterFinish [MaxRegisterFinish]
    FROM
    (
        SELECT
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.Post2000 [SitePost2000],
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.RegisterFinish DESC, jd.JobID DESC) [RowID]
        FROM
            @ClientSiteData csd
            INNER JOIN (
                SELECT
                    a.*,
                    ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.RegisterFinish DESC, a.JobID DESC) [RowID]
                FROM
                (
                    SELECT 0 [IsSiteDocument], jad.ClientID, jad.SiteID, jad.JobID, r.RegisterFinish
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                    UNION ALL
                    SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [RegisterFinish]
                    FROM
                        SiteDocument sid WITH (NOLOCK)
                        INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                    WHERE
                        sid.SiteDocumentTypeID = 3 -- Surveys
                            AND
                        sid.Deleted IS NULL
                ) a
            ) jd ON
                CASE WHEN jd.IsSiteDocument = 1
                    THEN -1
                    ELSE csd.ClientID
                END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        GROUP BY
            si.SiteID,
            si.Address,
            si.Postcode,
            si.Post2000,
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            jd.RowID
    ) a
    WHERE a.RowID = 1
    GROUP BY
        a.SiteID,
        a.SiteAddress,
        a.SitePostcode,
        a.SitePost2000,
        a.UnmanagedSite,
        a.IsSiteDocument,
        a.JobID,
        a.RegisterFinish,
        a.RowID
    ORDER BY
        a.SiteID

    -- Execute the SPROC PopulateSiteJobsReinspectionState. This populates additional columns in #SiteJobs, so it assumes #SiteJobs already exists.
    EXEC Portfolio_PopulateSiteJobsReinspectionState


    -- Start the main SELECT.
    SELECT
        csd.SiteID,
        ISNULL(SUM(o.SurveyJobCount), 0) [SurveyJobCount], -- How many Survey's against the current Site? That is Approved, appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.SurveyDocCount), 0) [SurveyDocCount], -- How many Survey Site Docs are there for the current Site?
        ISNULL(SUM(o.ManagementPlanCount), 0) [ManagementPlanCount], -- How many Management Plans are there for the current Site?
        ISNULL(SUM(o.BulkSampleCertificateCount), 0) [BulkSampleCertificateCount], -- How many Bulk Sample Report's against the current Site (either as part of a Survey or a standalone)? That is Approved, quote not rejected, etc.
        ISNULL(SUM(o.BulkSampleDocCount), 0) [BulkSampleDocCount], -- How many Bulk Sample Site Docs are there for the current Site?
        ISNULL(SUM(o.AirTestCount), 0) [AirTestCount], -- How many Air test's against the current Site? That is Approved (if config @b__onlyshowApprovedAirTestsOnPortal is true), appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.AirTestDocCount), 0) [AirTestDocCount], -- How many Air Test Site Docs are there for the current Site?
        ISNULL(SUM(o.LegionellaJobCount), 0) [LegionellaJobCount], -- How many Legionella's against the current Site? That is Approved, appointment not declined, quote not rejected, etc.
        ISNULL(SUM(o.LegionellaDocCount), 0) [LegionellaDocCount], -- How many Legionella Site Docs are there for the current Site?
        MAX(o.SurveyJobFileName) [SurveyJobFileName], -- If the job has 1 Survey, get the PDF File Name for it.
        MAX(o.SurveySiteDocumentID) [SurveySiteDocumentID], -- Get the latest Survey Site Document.
        MAX(o.SurveyDocFileName) [SurveyDocFileName], -- If the job has 1 Survey Site Document, get it.
        MAX(o.ManagementPlanSiteDocumentID) [ManagementPlanSiteDocumentID], -- Get the latest Site Document Management Plan.
        MAX(o.ManagementPlanFileName) [ManagementPlanFileName], -- If the job has 1 Management Plan, get it.
        MAX(o.BulkSampleJobFileName) [BulkSampleJobFileName], -- If the job has 1 BSR, get the PDF File Name for it.
        MAX(o.BulkSampleSiteDocumentID) [BulkSampleSiteDocumentID], -- Get the latest Bulk Sample Site Document.
        MAX(o.BulkSampleDocFileName) [BulkSampleDocFileName], -- If the job has 1 Bulk Sample Site Document, get it.
        MAX(o.AirTestJobFileName) [AirTestJobFileName], -- If the job has 1 Air Test, get the PDF File Name for it.
        MAX(o.AirTestSiteDocumentID) [AirTestSiteDocumentID], -- Get the latest Air Test Site Document.
        MAX(o.AirTestDocFileName) [AirTestDocFileName], -- If the job has 1 Air Test Site Document, get it.
        MAX(o.LegionellaJobFileName) [LegionellaJobFileName], -- If the job has 1 Legionella job, get the PDF File Name for it.
        MAX(o.LegionellaSiteDocumentID) [LegionellaSiteDocumentID], -- Get the latest Legionella Site Document.
        MAX(o.LegionellaDocFileName) [LegionellaDocFileName], -- If the job has 1 Legionella Site Document, get it.
        MAX(o.ExternalPhotoID) [ExternalPhotoID], -- Get the ExternalPhotoID of a photo that has data. Attempt to get a normal Register/Legionella record PhotoID.
        MAX(o.SurveyJobID) [SurveyJobID], -- The JobID of the latest Survey on the Site (previously ordered by RegisterFinish DESC).
        MIN(o.SurveyReinspectionDate) [SurveyReinspectionDate], -- The first Reinspection Date of the latest Survey at the Site.
        MAX(o.SurveySampleResultsOverview) [SurveySampleResultsOverview] -- The Sample Results Overview of the Site.
    FROM
        @ClientSiteData csd
        INNER JOIN
        (
            SELECT -- Surveys
                su.SiteID,
                su.SurveyJobCount,
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                su.ExternalPhotoID,
                su.JobID [SurveyJobID],
                CASE WHEN @Surveys = 1 AND (su.SurveyJobCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN (
                        SELECT TOP 1 _pf.FileName
                        FROM PDF _pf WITH (NOLOCK)
                        WHERE
                            _pf.JobID = su.JobID
                                AND
                            _pf.DateDeleted IS NULL
                                AND
                            _pf.FileName NOT LIKE '%bsr%'
                                AND
                            _pf.FileName NOT LIKE '%ra%'
                                AND
                            _pf.FileName NOT LIKE '%asb5%'
                        ORDER BY
                            _pf.DateCreated DESC
                    )
                    ELSE NULL
                END [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [SurveyJobCount],
                    MAX(mep.ExternalPhotoID) [ExternalPhotoID],
                    MAX(main.JobID) [JobID]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        su.SurveyTypeID
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                ) main
                OUTER APPLY
                (
                    SELECT TOP 1 p.PhotoID [ExternalPhotoID]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                        INNER JOIN Photo p WITH (NOLOCK) ON r.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
                    WHERE
                        jad.SiteID = main.SiteID
                    ORDER BY
                        r.MainExternalPhoto DESC,
                        p.PhotoNo DESC,
                        p.PhotoID DESC
                ) mep
                GROUP BY
                    main.SiteID
            ) su
            UNION ALL
            SELECT  -- Bulk Samples
                bsr.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                bsr.BSRCount [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                CASE WHEN @BulkSamples = 1 AND (bsr.BSRCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN bsr.FileName
                    ELSE NULL
                END [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [BSRCount],
                    MAX(main.FileName) [FileName]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        bsr.PDFId,
                        bsr.FileName
                    FROM
                        @JobAppointmentData jad
                        OUTER APPLY
                        (
                            SELECT TOP 1 _pf.PdfID, _pf.FileName
                            FROM PDF _pf WITH (NOLOCK)
                            WHERE
                                _pf.JobID = jad.JobID
                                    AND
                                _pf.DateDeleted IS NULL
                                    AND
                                _pf.FileName LIKE '%bsr%'
                            ORDER BY
                                _pf.DateCreated DESC
                        ) bsr
                    WHERE
                        bsr.PDFId IS NOT NULL
                ) main
                GROUP BY
                    main.SiteID
            ) bsr
            UNION ALL
            SELECT -- Air Tests
                at.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                at.AirTestCount,
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                CASE WHEN @AirTests = 1 AND (at.AirTestCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN at.FileName
                    ELSE NULL
                END [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.AirTestID) [AirTestCount],
                    MAX(main.FileName) [FileName]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        at.AirTestID,
                        pf.FileName
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Airtest at WITH (NOLOCK) ON je.JobEmployeeID = at.JobEmployeeID
                        OUTER APPLY
                        (
                            SELECT TOP 1 _pf.FileName
                            FROM PDF _pf WITH (NOLOCK)
                            WHERE
                                _pf.JobID = jad.JobID
                                    AND
                                _pf.DateDeleted IS NULL
                                    AND
                                _pf.FileName NOT LIKE '%bsr%'
                                    AND
                                _pf.FileName NOT LIKE '%ra%'
                                    AND
                                _pf.FileName NOT LIKE '%asb5%'
                                    AND
                                _pf.FileName LIKE '%\_' + CAST(at.AirTestID AS VARCHAR(20)) + ' (%' ESCAPE '\'
                            ORDER BY
                                _pf.DateCreated DESC
                        ) pf
                    WHERE
                        CASE WHEN @b__onlyshowApprovedAirTestsOnPortal = 1
                            THEN at.OfficeApproved
                            ELSE 1
                        END = 1
                ) main
                GROUP BY
                    main.SiteID
            ) at
            UNION ALL
            SELECT -- Legionella
                l.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                l.LegionellaJobCount,
                NULL [LegionellaDocCount],
                l.ExternalPhotoID,
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                CASE WHEN @Legionella = 1 AND (l.LegionellaJobCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN (
                        SELECT TOP 1 _pf.FileName
                        FROM PDF _pf WITH (NOLOCK)
                        WHERE
                            _pf.JobID = l.JobID
                                AND
                            _pf.DateDeleted IS NULL
                                AND
                            _pf.FileName NOT LIKE '%bsr%'
                                AND
                            _pf.FileName NOT LIKE '%ra%'
                                AND
                            _pf.FileName NOT LIKE '%asb5%'
                        ORDER BY
                            _pf.DateCreated DESC
                        )
                    ELSE NULL
                END [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.JobID) [LegionellaJobCount],
                    MAX(main.JobID) [JobID],
                    MAX(main.ExternalPhotoID) [ExternalPhotoID]
                FROM
                (
                    SELECT
                        jad.SiteID,
                        jad.JobID,
                        p.PhotoID [ExternalPhotoID]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON jad.JobID = je.JobID
                        INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID AND l.DateApproved IS NOT NULL
                        LEFT JOIN Photo p WITH (NOLOCK) ON l.PhotoID = p.PhotoID AND p.PhotoData IS NOT NULL
                ) main
                GROUP BY
                    main.SiteID
            ) l
            UNION ALL
            SELECT -- Site Documents with a Type
                sid.SiteID,
                NULL [SurveyJobCount],
                sid.SurveyDocCount,
                sid.ManagementPlanCount,
                NULL [BulkSampleCertificateCount],
                sid.BulkSampleDocCount,
                NULL [AirTestCount],
                sid.AirTestDocCount,
                NULL [LegionellaJobCount],
                sid.LegionellaDocCount,
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                CASE WHEN @Surveys = 1 AND (sid.SurveyDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.SurveySiteDocumentID
                    ELSE NULL
                END [SurveySiteDocumentID],
                CASE WHEN @Surveys = 1 AND (sid.SurveyDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.SurveyDocFileName
                    ELSE NULL
                END [SurveyDocFileName],
                NULL [SurveyReinspectionDate],
                NULL [SurveySampleResultsOverview],
                CASE WHEN @Surveys = 1 AND (sid.ManagementPlanCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.ManagementPlanSiteDocumentID
                    ELSE NULL
                END [ManagementPlanSiteDocumentID],
                CASE WHEN @Surveys = 1 AND (sid.ManagementPlanCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.ManagementPlanFileName
                    ELSE NULL
                END [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                CASE WHEN @BulkSamples = 1 AND (sid.BulkSampleDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.BulkSampleSiteDocumentID
                    ELSE NULL
                END [BulkSampleSiteDocumentID],
                CASE WHEN @BulkSamples = 1 AND (sid.BulkSampleDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.BulkSampleDocFileName
                    ELSE NULL
                END [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                CASE WHEN @AirTests = 1 AND (sid.AirTestDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.AirTestSiteDocumentID
                    ELSE NULL
                END [AirTestSiteDocumentID],
                CASE WHEN @AirTests = 1 AND (sid.AirTestDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.AirTestDocFileName
                    ELSE NULL
                END [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                CASE WHEN @Legionella = 1 AND (sid.LegionellaDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.LegionellaSiteDocumentID
                    ELSE NULL
                END [LegionellaSiteDocumentID],
                CASE WHEN @Legionella = 1 AND (sid.LegionellaDocCount = 1 OR @b__PortalShowPDFsOnSitesTab = 1)
                    THEN sid.LegionellaDocFileName
                    ELSE NULL
                END [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    COUNT(DISTINCT main.SurveySiteDocumentID) [SurveyDocCount],
                    MAX(main.SurveySiteDocumentID) [SurveySiteDocumentID],
                    MAX(main.SurveyFileName) [SurveyDocFileName],
                    COUNT(DISTINCT main.ManagementPlanSiteDocumentID) [ManagementPlanCount],
                    MAX(main.ManagementPlanSiteDocumentID) [ManagementPlanSiteDocumentID],
                    MAX(main.ManagementPlanFileName) [ManagementPlanFileName],
                    COUNT(DISTINCT main.BulkSampleSiteDocumentID) [BulkSampleDocCount],
                    MAX(main.BulkSampleSiteDocumentID) [BulkSampleSiteDocumentID],
                    MAX(main.BulkSampleFileName) [BulkSampleDocFileName],
                    COUNT(DISTINCT main.AirTestSiteDocumentID) [AirTestDocCount],
                    MAX(main.AirTestSiteDocumentID) [AirTestSiteDocumentID],
                    MAX(main.AirTestFileName) [AirTestDocFileName],
                    COUNT(DISTINCT main.LegionellaSiteDocumentID) [LegionellaDocCount],
                    MAX(main.LegionellaSiteDocumentID) [LegionellaSiteDocumentID],
                    MAX(main.LegionellaFileName) [LegionellaDocFileName]
                FROM
                (
                    SELECT
                        csd.SiteID,
                        suSid.SiteDocumentID [SurveySiteDocumentID],
                        suSid.FileName [SurveyFileName],
                        mPlanSid.SiteDocumentID [ManagementPlanSiteDocumentID],
                        mPlanSid.FileName [ManagementPlanFileName],
                        bsrSid.SiteDocumentID [BulkSampleSiteDocumentID],
                        bsrSid.FileName [BulkSampleFileName],
                        atSid.SiteDocumentID [AirTestSiteDocumentID],
                        atSid.FileName [AirTestFileName],
                        lSid.SiteDocumentID [LegionellaSiteDocumentID],
                        lSid.FileName [LegionellaFileName]
                    FROM
                        @ClientSiteData csd
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 3
                        ) suSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 2
                        ) mPlanSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 4
                        ) bsrSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 5
                        ) atSid
                        OUTER APPLY
                        (
                            SELECT
                                sid.SiteDocumentID,
                                sid.FileName
                            FROM
                                SiteDocument sid WITH (NOLOCK)
                            WHERE
                                sid.SiteID = csd.SiteID
                                    AND
                                sid.Deleted IS NULL
                                    AND
                                sid.SiteDocumentTypeID = 6
                        ) lSid
                ) main
                WHERE
                    main.SurveySiteDocumentID IS NOT NULL OR main.ManagementPlanSiteDocumentID IS NOT NULL OR main.BulkSampleSiteDocumentID IS NOT NULL OR main.AirTestSiteDocumentID IS NOT NULL OR main.LegionellaSiteDocumentID IS NOT NULL
                GROUP BY
                    main.SiteID
            ) sid
            UNION ALL
            SELECT -- Survey Sample Results Overview HTML and Reinspection Dates
                ssro.SiteID,
                NULL [SurveyJobCount],
                NULL [SurveyDocCount],
                NULL [ManagementPlanCount],
                NULL [BulkSampleCertificateCount],
                NULL [BulkSampleDocCount],
                NULL [AirTestCount],
                NULL [AirTestDocCount],
                NULL [LegionellaJobCount],
                NULL [LegionellaDocCount],
                NULL [ExternalPhotoID],
                NULL [SurveyJobID],
                NULL [SurveyJobFileName],
                NULL [SurveySiteDocumentID],
                NULL [SurveyDocFileName],
                ssro.ReinspectionDate [SurveyReinspectionDate],
                ssro.SampleResultsOverview [SurveySampleResultsOverview],
                NULL [ManagementPlanSiteDocumentID],
                NULL [ManagementPlanFileName],
                NULL [BulkSampleJobFileName],
                NULL [BulkSampleSiteDocumentID],
                NULL [BulkSampleDocFileName],
                NULL [AirTestJobFileName],
                NULL [AirTestSiteDocumentID],
                NULL [AirTestDocFileName],
                NULL [LegionellaJobFileName],
                NULL [LegionellaSiteDocumentID],
                NULL [LegionellaDocFileName]
            FROM
            (
                SELECT
                    main.SiteID,
                    MIN(main.ReinspectionDate) [ReinspectionDate],
                    MAX(main.SampleResultsOverview) [SampleResultsOverview]
                FROM
                (
                    SELECT
                        sj.SiteID,
                        sj.ReinspectionDate,
                        CASE WHEN jad.UseRiskColours = 1
                            THEN ssros.RiskSampleResultsOverview
                            ELSE ssros.RecommendedActionSampleResultsOverview
                        END [SampleResultsOverview]
                    FROM
                        @JobAppointmentData jad
                        INNER JOIN #SiteJobs sj ON jad.SiteID = sj.SiteID
                        LEFT JOIN SiteSampleResultsOverviewSorting ssros WITH (NOLOCK) ON jad.ClientID = ssros.ClientID AND jad.SiteID = ssros.SiteID
                ) main
                GROUP BY
                    main.SiteID
            ) ssro
        ) o ON csd.SiteID = o.SiteID
    GROUP BY
        csd.SiteID
    ORDER BY
        csd.SiteID


    -- Clear up temp tables.
    DROP TABLE #ClientIdData
    DROP TABLE #SurveyTypeIdData
    DROP TABLE #SiteJobs


    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_OverviewLegionellaGraphData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_OverviewLegionellaGraphData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Portfolio_OverviewLegionellaGraphData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL,
    @TotalCompliance BIT = 1,
    @RiskItems BIT = 1,
    @LowUseOutlets BIT = 0,
    @OutletsOutOfSpec BIT = 0,
    @RiskItemID INT = 0

WITH RECOMPILE
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed.
    DECLARE @ClientIdData TABLE (ClientID INT PRIMARY KEY)
    INSERT INTO @ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            @ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Total Compliance data up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #TotalComplianceData (SiteID INT PRIMARY KEY, Post2000 BIT NOT NULL, UnmanagedSite BIT NOT NULL, JobID INT)

    -- Add an index on important #TotalComplianceData fields to increase speed below.
    CREATE INDEX temp_TotalComplianceData ON #TotalComplianceData (SiteID, JobID)

    -- Get Total Compliance data for Sites with a Survey.
    IF @TotalCompliance = 1 OR @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite, JobID)
        SELECT SiteID, Post2000, UnmanagedSite, JobID
        FROM
        (
            SELECT
                si.SiteID,
                si.Post2000,
                si.UnmanagedSite,
                CASE WHEN si.Post2000 = 0 AND si.UnmanagedSite = 0 THEN ISNULL(jd.JobID, -1) ELSE NULL END [JobID],
                ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.LegionellaFinish DESC, jd.JobID DESC) [RowID]
            FROM
                @ClientSiteData csd
                INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
                INNER JOIN (
                    SELECT
                        a.*,
                        ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.LegionellaFinish DESC, a.JobID DESC) [RowID]
                    FROM
                    (
                        SELECT 0 [IsSiteDocument], j.ClientID, j.SiteID, j.JobID, l.LegionellaFinish
                        FROM
                            Job j WITH (NOLOCK)
                            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                            INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
                            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID AND l.DateApproved IS NOT NULL
                        WHERE j.Approved IS NOT NULL AND j.Cancelled IS NULL
                        UNION ALL
                        SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [LegionellaFinish]
                        FROM
                            SiteDocument sid WITH (NOLOCK)
                            INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                        WHERE
                            sid.SiteDocumentTypeID = 6 -- Legionella Surveys
                                AND
                            sid.Deleted IS NULL
                    ) a
                ) jd ON
                    CASE WHEN jd.IsSiteDocument = 1
                        THEN -1
                        ELSE csd.ClientID
                    END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            GROUP BY
                si.SiteID,
                si.Post2000,
                si.UnmanagedSite,
                jd.IsSiteDocument,
                jd.JobID,
                jd.LegionellaFinish,
                jd.RowID
        ) a
        WHERE a.RowID = 1
        GROUP BY
            a.SiteID,
            a.Post2000,
            a.UnmanagedSite,
            a.JobID
        ORDER BY
            a.SiteID
    END

    -- Get Legionella Items data up front to reduce table scans on the Legionella/Asset/Location/Outlet tables.
    DECLARE @LegionellaItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, DateApproved DATETIME, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT,  OutletEnabledCold BIT, OutletEnabledHot BIT, OutletEnabledMixed BIT, OutletEnabledMains BIT, OutletLowUse BIT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, DateApproved, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, OutletEnabledCold, OutletEnabledHot, OutletEnabledMixed, OutletEnabledMains, OutletLowUse)
        SELECT
            tcd.SiteID,
            j.JobID,
            lao.RowType,
            l.LegionellaID,
            l.GUID [LegGUID],
            l.GUIDVersion [LegGUIDVersion],
            l.DateApproved,
            lao.LegionellaAssetOutletID,
            lao.AssetOutletGUID,
            lao.AssetOutletGUIDVersion,
            lao.LegionellaLocationID,
            lao.LocationGUID,
            lao.LocationGUIDVersion,
            lao.OutletEnabledCold,
            lao.OutletEnabledHot,
            lao.OutletEnabledMixed,
            lao.OutletEnabledMains,
            CASE WHEN (lao.OutletEnabledCold = 1 AND lao.OutletLowUseCold = 1) OR (lao.OutletEnabledHot = 1 AND lao.OutletLowUseHot = 1) OR (lao.OutletEnabledMixed = 1 AND lao.OutletLowUseMixed = 1) OR (lao.OutletEnabledMains = 1 AND lao.OutletLowUseMains = 1)
                THEN 1
                ELSE 0
            END [OutletLowUse]
        FROM
            #TotalComplianceData tcd
            INNER JOIN Job j WITH (NOLOCK) ON tcd.SiteID = j.SiteID AND j.Approved IS NOT NULL AND j.Cancelled IS NULL
            INNER JOIN @ClientIdData c ON j.ClientID = c.ClientID
            INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
            INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
            INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
            INNER JOIN Legionella l WITH (NOLOCK) ON je.JobEmployeeID = l.JobEmployeeID
            INNER JOIN (
                SELECT
                    1 [RowType],
                    l.LegionellaID,
                    NULL [LegionellaAssetOutletID],
                    NULL [AssetOutletSystemRef],
                    NULL [AssetOutletGUID],
                    NULL [AssetOutletGUIDVersion],
                    NULL [LegionellaLocationID],
                    NULL [AssetOutletLocation],
                    NULL [LocationGUID],
                    NULL [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    Legionella l WITH (NOLOCK)

                UNION ALL

                SELECT
                    2 [RowType],
                    la.LegionellaID,
                    la.LegionellaAssetID [LegionellaAssetOutletID],
                    la.SystemRef [AssetOutletSystemRef],
                    la.GUID [AssetOutletGUID],
                    la.GUIDVersion [AssetOutletGUIDVersion],
                    NULL [LegionellaLocationID],
                    la.Location [AssetOutletLocation],
                    NULL [LocationGUID],
                    NULL [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    LegionellaAsset la WITH (NOLOCK)
                WHERE
                    la.Deleted IS NULL
						AND
					la.DateRemoved IS NULL

                UNION ALL

                SELECT
                    3 [RowType],
                    ll.LegionellaID,
                    NULL [LegionellaAssetOutletID],
                    NULL [AssetOutletSystemRef],
                    NULL [AssetOutletGUID],
                    NULL [AssetOutletGUIDVersion],
                    ll.LegionellaLocationID,
                    ll.Location [AssetOutletLocation],
                    ll.GUID [LocationGUID],
                    ll.GUIDVersion [LocationGUIDVersion],
                    NULL [OutletEnabledCold],
                    NULL [OutletEnabledHot],
                    NULL [OutletEnabledMixed],
                    NULL [OutletEnabledMains],
                    NULL [OutletLowUseCold],
                    NULL [OutletLowUseHot],
                    NULL [OutletLowUseMixed],
                    NULL [OutletLowUseMains]
                FROM
                    LegionellaLocation ll WITH (NOLOCK)
                WHERE
                    ll.Deleted IS NULL
						AND
					ll.DateRemoved IS NULL

                UNION ALL

                SELECT
                    4 [RowType],
                    ll.LegionellaID,
                    lo.LegionellaOutletID [LegionellaAssetOutletID],
                    lo.SystemRef [AssetOutletSystemRef],
                    lo.GUID [AssetOutletGUID],
                    lo.GUIDVersion [AssetOutletGUIDVersion],
                    ll.LegionellaLocationID,
                    ll.Location [AssetOutletLocation],
                    ll.GUID [LocationGUID],
                    ll.GUIDVersion [LocationGUIDVersion],
                    lo.EnabledCold [OutletEnabledCold],
                    lo.EnabledHot [OutletEnabledHot],
                    lo.EnabledMixed [OutletEnabledMixed],
                    lo.EnabledMains [OutletEnabledMains],
                    lo.LowUseCold [OutletLowUseCold],
                    lo.LowUseHot [OutletLowUseHot],
                    lo.LowUseMixed [OutletLowUseMixed],
                    lo.LowUseMains [OutletLowUseMains]
                FROM
                    LegionellaLocation ll WITH (NOLOCK)
                    INNER JOIN LegionellaOutlet lo WITH (NOLOCK) ON ll.LegionellaLocationID = lo.LegionellaLocationID AND lo.Deleted IS NULL
                WHERE
                    ll.Deleted IS NULL
						AND
					ll.DateRemoved IS NULL
						AND
					lo.DateRemoved IS NULL
            ) lao ON l.LegionellaID = lao.LegionellaID
        GROUP BY
            tcd.SiteID,
            j.JobID,
            lao.RowType,
            l.LegionellaID,
            l.GUID,
            l.GUIDVersion,
            l.DateApproved,
            lao.LegionellaAssetOutletID,
            lao.AssetOutletGUID,
            lao.AssetOutletGUIDVersion,
            lao.LegionellaLocationID,
            lao.LocationGUID,
            lao.LocationGUIDVersion,
            lao.OutletEnabledCold,
            lao.OutletEnabledHot,
            lao.OutletEnabledMixed,
            lao.OutletEnabledMains,
            lao.OutletLowUseCold,
            lao.OutletLowUseHot,
            lao.OutletLowUseMixed,
            lao.OutletLowUseMains
    END

    -- Get Legionella data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion)
        SELECT
            l.SiteID,
            l.JobID,
            l.LegionellaID,
            l.LegGUID,
            l.LegGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella record with the max GUID.
                    l.SiteID,
                    l.JobID,
                    l.LegionellaID,
                    l.LegGUID,
                    l.LegGUIDVersion,
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(l.LegGUID, NEWID()) ORDER BY l.LegGUIDVersion DESC, l.DateApproved DESC) [RowID]
                FROM @LegionellaItemsData l
                WHERE l.RowType = 1
            ) l
        WHERE l.RowID = 1
    END*/

    -- Get Legionella Asset data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaAssetGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetID INT, AssetGUID VARCHAR(MAX), AssetGUIDVersion INT)

    IF @RiskItems = 1
    BEGIN
        INSERT INTO @LegionellaAssetGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetID, AssetGUID, AssetGUIDVersion)
        SELECT
            la.SiteID,
            la.JobID,
            la.LegionellaID,
            la.LegGUID,
            la.LegGUIDVersion,
            la.LegionellaAssetID,
            la.AssetGUID,
            la.AssetGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella Asset record with the max GUID.
                    la.SiteID,
                    la.JobID,
                    la.LegionellaID,
                    la.LegGUID,
                    la.LegGUIDVersion,
                    la.LegionellaAssetOutletID [LegionellaAssetID],
                    la.AssetOutletGUID [AssetGUID],
                    la.AssetOutletGUIDVersion [AssetGUIDVersion],
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(la.AssetOutletGUID, NEWID()) ORDER BY la.AssetOutletGUIDVersion DESC) [RowID]
                FROM @LegionellaItemsData la
                WHERE la.RowType = 2
            ) la
        WHERE la.RowID = 1
    END*/

    -- Get Legionella Location data combined as GUIDs up front as used below.
    /*DECLARE @LegionellaLocationGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaLocationID INT NOT NULL, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaLocationGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion)
        SELECT
            ll.SiteID,
            ll.JobID,
            ll.LegionellaID,
            ll.LegGUID,
            ll.LegGUIDVersion,
            ll.LegionellaLocationID,
            ll.LocationGUID,
            ll.LegGUIDVersion
        FROM
            (
                SELECT -- Get each Legionella Location record with the max GUID.
                    ll.SiteID,
                    ll.JobID,
                    ll.LegionellaID,
                    ll.LegGUID,
                    ll.LegGUIDVersion,
                    ll.LegionellaLocationID,
                    ll.LocationGUID,
                    ll.LocationGUIDVersion,
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(ll.LocationGUID, NEWID()) ORDER BY ll.LocationGUIDVersion DESC) [RowID]
                FROM @LegionellaItemsData ll
                WHERE ll.RowType = 3
            ) ll
        WHERE ll.RowID = 1
    END*/

    -- Get Legionella Outlet data combined as GUIDs up front as used below. As well as getting the latest GUID version, get the latest LegionellaOutletComputedData version (if available).
    DECLARE @LegionellaOutletGUIDData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaLocationID INT NOT NULL, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaOutletID INT NOT NULL, OutletGUID VARCHAR(MAX), OutletGUIDVersion INT, Cold DECIMAL(10, 2), Hot DECIMAL(10, 2), Mixed DECIMAL(10, 2), Mains DECIMAL(10, 2), Flushed BIT NOT NULL, LowUse BIT NOT NULL)

    IF @RiskItems = 1 OR @LowUseOutlets = 1 OR @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaOutletGUIDData (SiteID, JobID, LegionellaID, LegGUID, LegGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaOutletID, OutletGUID, OutletGUIDVersion, Cold, Hot, Mixed, Mains, Flushed, LowUse)
        SELECT
            lo.SiteID,
            lo.JobID,
            lo.LegionellaID,
            lo.LegGUID,
            lo.LegGUIDVersion,
            lo.LegionellaLocationID,
            lo.LocationGUID,
            lo.LocationGUIDVersion,
            lo.LegionellaOutletID,
            lo.OutletGUID,
            lo.OutletGUIDVersion,
            lo.Cold,
            lo.Hot,
            lo.Mixed,
            lo.Mains,
            lo.Flushed,
            lo.LowUse
        FROM
            (
                SELECT -- Get each Legionella Outlet record with the max GUID.
                    lo.SiteID,
                    lo.JobID,
                    lo.LegionellaID,
                    lo.LegGUID,
                    lo.LegGUIDVersion,
                    lo.LegionellaLocationID,
                    lo.LocationGUID,
                    lo.LocationGUIDVersion,
                    lo.LegionellaOutletID,
                    lo.OutletGUID,
                    lo.OutletGUIDVersion,
                    CASE WHEN lo.EnabledCold = 1 THEN locd.Cold ELSE NULL END [Cold],
                    CASE WHEN lo.EnabledHot = 1 THEN locd.Hot ELSE NULL END [Hot],
                    CASE WHEN lo.EnabledMixed = 1 THEN locd.Mixed ELSE NULL END [Mixed],
                    CASE WHEN lo.EnabledMains = 1 THEN locd.Mains ELSE NULL END [Mains],
                    CASE WHEN (lo.EnabledCold = 1 AND locd.FlushedCold = 1) OR (lo.EnabledHot = 1 AND locd.FlushedHot = 1) OR (lo.EnabledMixed = 1 AND locd.FlushedMixed = 1) OR (lo.EnabledMains = 1 AND locd.FlushedMains = 1)
                        THEN 1
                        ELSE 0
                    END [Flushed],
                    lo.OutletLowUse [LowUse],
                    ROW_NUMBER() OVER (PARTITION BY ISNULL(lo.OutletGUID, NEWID()) ORDER BY lo.OutletGUIDVersion DESC, locd.Created DESC) [RowID]
                FROM
                    (
                        SELECT -- Get each Legionella Outlet record with the max GUID.
                            lo.SiteID,
                            lo.JobID,
                            lo.LegionellaID,
                            lo.LegGUID,
                            lo.LegGUIDVersion,
                            lo.LegionellaLocationID,
                            lo.LocationGUID,
                            lo.LocationGUIDVersion,
                            lo.LegionellaAssetOutletID [LegionellaOutletID],
                            lo.AssetOutletGUID [OutletGUID],
                            lo.AssetOutletGUIDVersion [OutletGUIDVersion],
                            lo.OutletEnabledCold [EnabledCold],
                            lo.OutletEnabledHot [EnabledHot],
                            lo.OutletEnabledMixed [EnabledMixed],
                            lo.OutletEnabledMains [EnabledMains],
                            lo.OutletLowUse,
                            ROW_NUMBER() OVER (PARTITION BY ISNULL(lo.AssetOutletGUID, NEWID()) ORDER BY lo.AssetOutletGUIDVersion DESC) [RowID]
                        FROM @LegionellaItemsData lo
                        WHERE lo.RowType = 4
                    ) lo
                    INNER JOIN LegionellaOutletComputedData locd WITH (NOLOCK) ON lo.LegionellaOutletID = locd.LegionellaOutletID
                    WHERE lo.RowID = 1
            ) lo
        WHERE lo.RowID = 1
    END

    -- Get Legionella Task up front to reduce table scans on the LegionellaTask table.
    -- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
    DECLARE @LegionellaTasksData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, /* ADDITIONAL COLUMNS */ RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, LegionellaPriorityRatingID INT)

    IF @RiskItems = 1
    BEGIN
        IF @ReturnAsChart = 1 -- Basic columns only.
        BEGIN
            INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID)
            SELECT
                lao.SiteID,
                lao.JobID,
                lao.RowType,
                lao.LegionellaID,
                lao.LegGUID,
                lao.LegGUIDVersion,
                lao.LegionellaAssetOutletID,
                lao.AssetOutletGUID,
                lao.AssetOutletGUIDVersion,
                lao.LegionellaLocationID,
                lao.LocationGUID,
                lao.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.GUID [TaskGUID],
                lt.GUIDVersion [TaskGUIDVersion],
                lt.LegionellaRiskRatingID
            FROM
                @LegionellaItemsData lao
                INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
                    CASE lao.RowType -- Join based on the main UNION
                        WHEN 1 THEN lao.LegionellaID
                        WHEN 3 THEN lao.LegionellaLocationID
                        ELSE lao.LegionellaAssetOutletID
                    END =
                    CASE lao.RowType -- Join based on this live table
                        WHEN 1 THEN lt.LegionellaID
                        WHEN 2 THEN lt.LegionellaAssetID
                        WHEN 3 THEN lt.LegionellaLocationID
                        WHEN 4 THEN lt.LegionellaOutletID
                    END
            WHERE
                lt.Deleted IS NULL
                    AND
                CASE WHEN @RiskItemID = 0 -- Risk filter.
                    THEN 1
                    ELSE
                        CASE WHEN @RiskItemID = -1
                            THEN CASE WHEN lt.LegionellaRiskRatingID IS NULL THEN 1 ELSE 0 END
                            ELSE CASE WHEN @RiskItemID = ISNULL(lt.LegionellaRiskRatingID, -1) THEN 1 ELSE 0 END
                        END
                END = 1
        END
        ELSE
        BEGIN -- Additional columns included.
            INSERT INTO @LegionellaTasksData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskDescription, Action, LegionellaFrequencyCategoryID, LegionellaPriorityRatingID)
            SELECT
                lao.SiteID,
                lao.JobID,
                lao.RowType,
                lao.LegionellaID,
                lao.LegGUID,
                lao.LegGUIDVersion,
                lao.LegionellaAssetOutletID,
                lao.AssetOutletGUID,
                lao.AssetOutletGUIDVersion,
                lao.LegionellaLocationID,
                lao.LocationGUID,
                lao.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.GUID [TaskGUID],
                lt.GUIDVersion [TaskGUIDVersion],
                lt.LegionellaRiskRatingID,
                lt.RiskDescription,
                lt.Action,
                lt.LegionellaFrequencyCategoryID,
                lt.LegionellaPriorityRatingID
            FROM
                @LegionellaItemsData lao
                INNER JOIN LegionellaTask lt WITH (NOLOCK) ON
                    CASE lao.RowType -- Join based on the main UNION
                        WHEN 1 THEN lao.LegionellaID
                        WHEN 3 THEN lao.LegionellaLocationID
                        ELSE lao.LegionellaAssetOutletID
                    END =
                    CASE lao.RowType -- Join based on this live table
                        WHEN 1 THEN lt.LegionellaID
                        WHEN 2 THEN lt.LegionellaAssetID
                        WHEN 3 THEN lt.LegionellaLocationID
                        WHEN 4 THEN lt.LegionellaOutletID
                    END
            WHERE
                lt.Deleted IS NULL
                    AND
                CASE WHEN @RiskItemID = 0 -- Risk filter.
                    THEN 1
                    ELSE
                        CASE WHEN @RiskItemID = -1
                            THEN CASE WHEN lt.LegionellaRiskRatingID IS NULL THEN 1 ELSE 0 END
                            ELSE CASE WHEN @RiskItemID = ISNULL(lt.LegionellaRiskRatingID, -1) THEN 1 ELSE 0 END
                        END
                END = 1
        END
    END

    -- Get Legionella Risk Items data up front as used below. Basically GUID Tasks.
    -- NOTE: Columns are out of order with the LegionellaTask table, as some of these we only get when viewing the data from a popup window. This is to increase speed when the data is not needed.
    DECLARE @LegionellaRiskItemsData TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, RowType INT NOT NULL, LegionellaID INT NOT NULL, LegGUID VARCHAR(MAX), LegGUIDVersion INT, LegionellaAssetOutletID INT, AssetOutletGUID VARCHAR(MAX), AssetOutletGUIDVersion INT, LegionellaLocationID INT, LocationGUID VARCHAR(MAX), LocationGUIDVersion INT, LegionellaTaskID INT NOT NULL, TaskGUID VARCHAR(MAX), TaskGUIDVersion INT, LegionellaRiskRatingID INT, RiskRating VARCHAR(MAX), RiskColour VARCHAR(15), RiskRatingSortOrder INT, /* ADDITIONAL COLUMNS */ JobNo INT, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), BuildingDesignation VARCHAR(50), AssetOutletSystemRef VARCHAR(8000), Location VARCHAR(8000), RiskDescription VARCHAR(MAX), Action VARCHAR(MAX), LegionellaFrequencyCategoryID INT, FrequencyCategory VARCHAR(8000), LegionellaPriorityRatingID INT, PriorityRating VARCHAR(20), PriorityColour VARCHAR(15))

    IF @RiskItems = 1
    BEGIN
        IF @ReturnAsChart = 1 -- Basic columns only.
        BEGIN
            INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder)
            SELECT
                lt.SiteID,
                lt.JobID,
                lt.RowType,
                lt.LegionellaID,
                lt.LegGUID,
                lt.LegGUIDVersion,
                lt.LegionellaAssetOutletID,
                lt.AssetOutletGUID,
                lt.AssetOutletGUIDVersion,
                lt.LegionellaLocationID,
                lt.LocationGUID,
                lt.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.TaskGUID,
                lt.TaskGUIDVersion,
                lrr.LegionellaRiskRatingID,
                lrr.Description [RiskRating],
                lrr.RiskColour,
                lrr.SortOrder [RiskRatingSortOrder]
            FROM
                (
                    SELECT -- Get each Legionella Task record with the max GUID.
                        lt.SiteID,
                        lt.JobID,
                        lt.RowType,
                        lt.LegionellaID,
                        lt.LegGUID,
                        lt.LegGUIDVersion,
                        lt.LegionellaAssetOutletID,
                        lt.AssetOutletGUID,
                        lt.AssetOutletGUIDVersion,
                        lt.LegionellaLocationID,
                        lt.LocationGUID,
                        lt.LocationGUIDVersion,
                        lt.LegionellaTaskID,
                        lt.TaskGUID,
                        lt.TaskGUIDVersion,
                        lt.LegionellaRiskRatingID,
                        ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
                    FROM @LegionellaTasksData lt
                ) lt
                LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
            WHERE lt.RowID = 1
        END
        ELSE
        BEGIN -- Additional columns included.
            INSERT INTO @LegionellaRiskItemsData (SiteID, JobID, RowType, LegionellaID, LegGUID, LegGUIDVersion, LegionellaAssetOutletID, AssetOutletGUID, AssetOutletGUIDVersion, LegionellaLocationID, LocationGUID, LocationGUIDVersion, LegionellaTaskID, TaskGUID, TaskGUIDVersion, LegionellaRiskRatingID, RiskRating, RiskColour, RiskRatingSortOrder, JobNo, SiteAddress, SitePostcode, BuildingDesignation, AssetOutletSystemRef, Location, RiskDescription, Action, LegionellaFrequencyCategoryID, FrequencyCategory, LegionellaPriorityRatingID, PriorityRating, PriorityColour)
            SELECT
                lt.SiteID,
                lt.JobID,
                lt.RowType,
                lt.LegionellaID,
                lt.LegGUID,
                lt.LegGUIDVersion,
                lt.LegionellaAssetOutletID,
                lt.AssetOutletGUID,
                lt.AssetOutletGUIDVersion,
                lt.LegionellaLocationID,
                lt.LocationGUID,
                lt.LocationGUIDVersion,
                lt.LegionellaTaskID,
                lt.TaskGUID,
                lt.TaskGUIDVersion,
                lrr.LegionellaRiskRatingID,
                ISNULL(lrr.Description, 'None') [RiskRating],
                '#' + ISNULL(lrr.RiskColour, 'CCCCCC') [RiskColour],
                lrr.SortOrder [RiskRatingSortOrder],
                j.JobNo,
                si.Address [SiteAddress],
                si.Postcode [SitePostcode],
                ISNULL(NULLIF(l.BuildingDesignation, ''), 'No Building Designation') [BuildingDesignation],
                ISNULL(NULLIF(ISNULL(la.SystemRef, lo.SystemRef), ''), 'N/A') [AssetOutletSystemRef],
                ISNULL(ISNULL(la.Location, ll.Location), '') [Location],
                ISNULL(lt.RiskDescription, 'N/A') [RiskDescription],
                ISNULL(lt.Action, 'N/A') [Action],
                lfc.LegionellaFrequencyCategoryID,
                ISNULL(lfc.Description, '') [FrequencyCategory],
                lpr.LegionellaPriorityRatingID,
                ISNULL(lpr.ShortDescription, 'None') [PriorityRating],
                '#' + ISNULL(lpr.PriorityColour, 'CCCCCC') [PriorityColour]
            FROM
                (
                    SELECT -- Get each Legionella Task record with the max GUID.
                        lt.SiteID,
                        lt.JobID,
                        lt.RowType,
                        lt.LegionellaID,
                        lt.LegGUID,
                        lt.LegGUIDVersion,
                        lt.LegionellaAssetOutletID,
                        lt.AssetOutletGUID,
                        lt.AssetOutletGUIDVersion,
                        lt.LegionellaLocationID,
                        lt.LocationGUID,
                        lt.LocationGUIDVersion,
                        lt.LegionellaTaskID,
                        lt.TaskGUID,
                        lt.TaskGUIDVersion,
                        lt.LegionellaRiskRatingID,
                        lt.RiskDescription,
                        lt.Action,
                        lt.LegionellaFrequencyCategoryID,
                        lt.LegionellaPriorityRatingID,
                        ROW_NUMBER() OVER (PARTITION BY ISNULL(lt.TaskGUID, NEWID()) ORDER BY lt.TaskGUIDVersion DESC) [RowID]
                    FROM @LegionellaTasksData lt
                ) lt
                INNER JOIN Job j WITH (NOLOCK) ON lt.JobID = j.JobID
                INNER JOIN Site si WITH (NOLOCK) ON lt.SiteID = si.SiteID
                INNER JOIN Legionella l WITH (NOLOCK) ON lt.LegionellaID = l.LegionellaID
                LEFT JOIN LegionellaAsset la WITH (NOLOCK) ON lt.LegionellaAssetOutletID = la.LegionellaAssetID AND lt.RowType = 2
                LEFT JOIN LegionellaLocation ll WITH (NOLOCK) ON lt.LegionellaLocationID = ll.LegionellaLocationID
                LEFT JOIN LegionellaOutlet lo WITH (NOLOCK) ON lt.LegionellaAssetOutletID = lo.LegionellaOutletID AND lt.RowType = 4
                LEFT JOIN LegionellaRiskRating lrr WITH (NOLOCK) ON lt.LegionellaRiskRatingID = lrr.LegionellaRiskRatingID
                LEFT JOIN LegionellaFrequencyCategory lfc WITH (NOLOCK) ON lt.LegionellaFrequencyCategoryID = lfc.LegionellaFrequencyCategoryID
                LEFT JOIN LegionellaPriorityRating lpr WITH (NOLOCK) ON lt.LegionellaPriorityRatingID = lpr.LegionellaPriorityRatingID
            WHERE lt.RowID = 1
        END
    END

    -- Get the default Outlet Temperature Limits for the Company.
    DECLARE @ColdMin FLOAT = 0, @ColdMax FLOAT = 0, @HotMin FLOAT = 0, @HotMax FLOAT = 0, @MixedMin FLOAT = 0, @MixedMax FLOAT = 0, @MainsMin FLOAT = 0, @MainsMax FLOAT = 0
    IF @OutletsOutOfSpec = 1
    BEGIN
        SELECT TOP 1
            @ColdMin = ISNULL(ColdMin, 0),
            @ColdMax = ISNULL(ColdMax, 0),
            @HotMin = ISNULL(HotMin, 0),
            @HotMax = ISNULL(HotMax, 0),
            @MixedMin = ISNULL(MixedMin, 0),
            @MixedMax = ISNULL(MixedMax, 0),
            @MainsMin = ISNULL(MainsMin, 0),
            @MainsMax = ISNULL(MainsMax, 0)
        FROM SiteLegionellaTemperatureLimits WITH (NOLOCK)
        WHERE SiteID = -1 AND Deleted IS NULL
    END

    -- Get the Legionella Outlets out of Spec for each Site.
    DECLARE @LegionellaOutletsOutOfSpec TABLE (SiteID INT NOT NULL, JobID INT NOT NULL, LegionellaID INT NOT NULL, LegionellaLocationID INT NOT NULL, LegionellaOutletID INT NOT NULL, Cold DECIMAL(10, 2), Hot DECIMAL(10, 2), Mixed DECIMAL(10, 2), Mains DECIMAL(10, 2), ColdMin FLOAT, ColdMax FLOAT, HotMin FLOAT, HotMax FLOAT, MixedMin FLOAT, MixedMax FLOAT, MainsMin FLOAT, MainsMax FLOAT, TempOutOfSpec BIT NOT NULL)

    IF @OutletsOutOfSpec = 1
    BEGIN
        INSERT INTO @LegionellaOutletsOutOfSpec (SiteID, JobID, LegionellaID, LegionellaLocationID, LegionellaOutletID, Cold, Hot, Mixed, Mains, ColdMin, ColdMax, HotMin, HotMax, MixedMin, MixedMax, MainsMin, MainsMax, TempOutOfSpec)
        SELECT
            lo.SiteID,
            lo.JobID,
            lo.LegionellaID,
            lo.LegionellaLocationID,
            lo.LegionellaOutletID,
            lo.Cold,
            lo.Hot,
            lo.Mixed,
            lo.Mains,
            ISNULL(siltl.ColdMin, @ColdMin) [ColdMin],
            ISNULL(siltl.ColdMax, @ColdMax) [ColdMax],
            ISNULL(siltl.HotMin, @HotMin) [HotMin],
            ISNULL(siltl.HotMax, @HotMax) [HotMax],
            ISNULL(siltl.MixedMin, @MixedMin) [MixedMin],
            ISNULL(siltl.MixedMax, @MixedMax) [MixedMax],
            ISNULL(siltl.MainsMin, @MainsMin) [MainsMin],
            ISNULL(siltl.MainsMax, @MainsMax) [MainsMax],
            CASE
                WHEN lo.Cold < ISNULL(siltl.ColdMin, @ColdMin) OR lo.Cold > ISNULL(siltl.ColdMax, @ColdMax) THEN 1
                WHEN lo.Hot < ISNULL(siltl.HotMin, @HotMin) OR lo.Hot > ISNULL(siltl.HotMax, @HotMax) THEN 1
                WHEN lo.Mixed < ISNULL(siltl.MixedMin, @MixedMin) OR lo.Mixed > ISNULL(siltl.MixedMax, @MixedMax) THEN 1
                WHEN lo.Mains < ISNULL(siltl.MainsMin, @MainsMin) OR lo.Mains > ISNULL(siltl.MainsMax, @MainsMax) THEN 1
                ELSE 0
            END [TempOutOfSpec]
        FROM
            @LegionellaOutletGUIDData lo
            LEFT JOIN SiteLegionellaTemperatureLimits siltl WITH (NOLOCK) ON lo.SiteID = siltl.SiteID AND siltl.Deleted IS NULL
    END

    -- Add more to the Total Compliance data for Sites without a Survey.
    IF @TotalCompliance = 1
    BEGIN
        INSERT INTO #TotalComplianceData (SiteID, Post2000, UnmanagedSite)
        SELECT
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite
        FROM
            @ClientSiteData csd
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        WHERE
            si.SiteID NOT IN (SELECT SiteID FROM #TotalComplianceData)
        GROUP BY
            si.SiteID,
            si.Post2000,
            si.UnmanagedSite
    END

    -- Get the total number of items.
    DECLARE @TotalComplianceItems INT = (SELECT COUNT(*) FROM #TotalComplianceData)
    DECLARE @TotalRiskItems INT = (SELECT COUNT(*) FROM @LegionellaRiskItemsData)
    DECLARE @TotalLowUseOutlets INT = (SELECT COUNT(*) FROM @LegionellaOutletGUIDData WHERE LowUse = 1)
    DECLARE @TotalOutletsOutOfSpec INT = (SELECT COUNT(*) FROM @LegionellaOutletsOutOfSpec)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END [category],
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END [Colour],
            COUNT(*) [Share],
            @TotalComplianceItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            CAST(
                CASE WHEN JobID IS NOT NULL
                    THEN 1
                    ELSE 0
                END AS BIT) [Surveyed]
        FROM #TotalComplianceData
        WHERE @TotalCompliance = 1
        GROUP BY
            CASE
                WHEN Post2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                WHEN JobID IS NOT NULL THEN 'Surveyed'
                ELSE 'Not Surveyed'
            END,
            CASE
                WHEN Post2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                WHEN JobID IS NOT NULL THEN '#AFD8F8'
                ELSE '#F6BD0F'
            END,
            CASE WHEN JobID IS NOT NULL
                THEN 1
                ELSE 0
            END
        ORDER BY
            Surveyed,
            category

        SELECT
            ISNULL(RiskRating, 'None') [category],
            '#' + ISNULL(RiskColour, 'CCCCCC') [Colour],
            COUNT(*) [Share],
            @TotalRiskItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            ISNULL(RiskRatingSortOrder, -1) [SortOrder],
            ISNULL(LegionellaRiskRatingID, -1) [LegionellaRiskRatingID]
        FROM @LegionellaRiskItemsData
        WHERE @RiskItems = 1
        GROUP BY
            ISNULL(RiskRating, 'None'),
            '#' + ISNULL(RiskColour, 'CCCCCC'),
            ISNULL(RiskRatingSortOrder, -1),
            ISNULL(LegionellaRiskRatingID, -1)
        ORDER BY
            SortOrder,
            category

        SELECT
            CASE WHEN Flushed = 1
                THEN 'Flushed'
                ELSE 'Not Flushed'
            END [category],
            CASE WHEN Flushed = 1
                THEN '#AFD8F8'
                ELSE '#CCCCCC'
            END [Colour],
            COUNT(*) [Share],
            @TotalLowUseOutlets [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            Flushed
        FROM @LegionellaOutletGUIDData
        WHERE @LowUseOutlets = 1 AND LowUse = 1
        GROUP BY
            CASE WHEN Flushed = 1
                THEN 'Flushed'
                ELSE 'Not Flushed'
            END,
            CASE WHEN Flushed = 1
                THEN '#AFD8F8'
                ELSE '#CCCCCC'
            END,
            Flushed
        ORDER BY
            Flushed DESC,
            category

        SELECT
            CASE WHEN TempOutOfSpec = 1
                THEN 'Outside of Specification'
                ELSE 'Within Specification'
            END [category],
            CASE WHEN TempOutOfSpec = 1
                THEN '#E8412D'
                ELSE '#00B050'
            END [Colour],
            COUNT(*) [Share],
            @TotalOutletsOutOfSpec [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            TempOutOfSpec
        FROM @LegionellaOutletsOutOfSpec
        WHERE @OutletsOutOfSpec = 1
        GROUP BY
            CASE WHEN TempOutOfSpec = 1
                THEN 'Outside of Specification'
                ELSE 'Within Specification'
            END,
            CASE WHEN TempOutOfSpec = 1
                THEN '#E8412D'
                ELSE '#00B050'
            END,
            TempOutOfSpec
        ORDER BY
            TempOutOfSpec,
            category
    END
    ELSE
    BEGIN
        SELECT * FROM #TotalComplianceData
        WHERE @TotalCompliance = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaRiskItemsData
        WHERE @RiskItems = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaOutletGUIDData
        WHERE @LowUseOutlets = 1 AND LowUse = 1
        ORDER BY SiteID

        SELECT * FROM @LegionellaOutletsOutOfSpec
        WHERE @OutletsOutOfSpec = 1
        ORDER BY SiteID
    END

    -- Clear up temp tables.
    DROP TABLE #TotalComplianceData


    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_PopulateSiteJobsReinspectionState') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_PopulateSiteJobsReinspectionState] AS BEGIN SET NOCOUNT ON; END')
END
GO


ALTER PROCEDURE [dbo].[Portfolio_PopulateSiteJobsReinspectionState]
/**********************************************************************
** Overview: Takes a list of Site/Jobs and sets the reinspection state of each
**   NOTE: Designed to be called within another procedure to populate columns in a temporary
**   table named #SiteJobs. This table must be created with the correct columns before calling this.
**   There must also be a temporary table called #ClientIdData which contains a list of the ClientIDs.
**   As of 20/12/2016, it is being used by these procedures (which are commented appropriately):
**     a) GetSites
**     b) GetSites_MainTab
**     c) GetSitesSurveyed
**     d) GetPortalJobDataForSites
**   This method is used to save duplicating logic between procedures and allowing the complicated logic
**   to calculate the reinspection state to only be run on as few sites/jobs as possible for performance
**   reasons.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- For each Site in #SiteJobs, get all Jobs for that Site into a temp table. We have to do this, as otherwise we could only join based upon the SiteID which doesn't have a filtered list of SurveyTypes.
    CREATE TABLE #AllSiteJobsData (JobID INT PRIMARY KEY NOT NULL, SiteID INT NOT NULL)

    -- Add an index on important #AllSiteJobsData fields to increase speed in the main UPDATE.
    CREATE INDEX temp_AllSiteJobsData ON #AllSiteJobsData (JobID)

    INSERT INTO #AllSiteJobsData (JobID, SiteID)
    SELECT j.JobID, j.SiteID
    FROM
        #SiteJobs sj
        INNER JOIN Job j WITH (NOLOCK) ON sj.SiteID = j.SiteID
        INNER JOIN #ClientIdData c ON j.ClientID = c.ClientID
        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
    GROUP BY
        j.JobID, j.SiteID

    -- Get SampleComputedData data up front to reduce table scans on the SampleComputedData table.
    -- NOTE: Only gets certain fields from SampleComputedData to increase speed. Add more columns in the future if needed.
    -- If more Element data is required in the future, then we will want to move this data into an #ElementData temp table.
    CREATE TABLE #SiteJobsComputedData (SampleComputedDataID INT PRIMARY KEY, SiteID INT, JobID INT, SampleID INT, RiskScoreGroupID INT, DateOfNextReviewInt INT, DateOfNextReviewIsAsRequired BIT NOT NULL)

    -- Add an index on important #SiteJobsComputedData fields to increase speed in the main UPDATE.
    CREATE INDEX temp_SiteJobsComputedData ON #SiteJobsComputedData (SiteID, RiskScoreGroupID, DateOfNextReviewInt, DateOfNextReviewIsAsRequired)

    INSERT INTO #SiteJobsComputedData (SampleComputedDataID, SiteID, JobID, SampleID, RiskScoreGroupID, DateOfNextReviewInt, DateOfNextReviewIsAsRequired)
    SELECT
        scd.SampleComputedDataID,
        scd.SiteID,
        scd.JobID,
        scd.SampleID,
        scd.RiskScoreGroupID,
        CASE WHEN ISNUMERIC(eim27.ShortDescription) = 1 THEN CAST(eim27.ShortDescription AS INT) END [DateOfNextReviewInt],
		CASE WHEN eim27.ShortDescription = 'As Required' THEN 1 ELSE 0 END [DateOfNextReviewIsAsRequired]
    FROM
        (
            SELECT scd.SampleComputedDataID, scd.SiteID, scd.JobID, scd.SampleID, scd.RiskScoreGroupID, e27.ElementIntMeaningID
            FROM
                #AllSiteJobsData sj
                INNER JOIN SampleComputedData scd WITH (NOLOCK) ON sj.JobID = scd.JobID AND scd.Removed = 0
                INNER JOIN GuidSamples gs WITH (NOLOCK) ON scd.SampleID = gs.SampleID
                LEFT JOIN Element e27 WITH (NOLOCK) ON scd.SampleId = e27.SampleID AND e27.ElementTypeID = 27
            GROUP BY
                scd.SampleComputedDataID, scd.SiteID, scd.JobID, scd.SampleID, scd.RiskScoreGroupID, e27.ElementIntMeaningID
        ) scd
        LEFT JOIN ElementIntMeaning eim27 WITH (NOLOCK) ON scd.ElementIntMeaningID = eim27.ElementIntMeaningID

    -- Update temp table #SiteJobs with the data from #SiteJobsComputedData. Does one UPDATE to increase speed (rather than four seperate updates).
    DECLARE @SiteJobsCalculated TABLE (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)
    INSERT INTO @SiteJobsCalculated (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed)
    SELECT
        sj.SiteID,
        sj.SiteAddress,
        sj.SitePostcode,
        sj.SitePost2000,
        sj.UnmanagedSite,
        sj.IsSiteDocument,
        sj.JobID,
        sj.MaxRegisterFinish,
        hrsgi.HighestRiskScoreGroupID,
        fnrd.FirstNextReviewDate,
        rd.ReinspectionDate,
        CASE
            -- A post-2000 Site
            WHEN sj.SitePost2000 = 1 THEN 5
            -- A Un-managed Site
            WHEN sj.UnmanagedSite = 1 THEN 6
            -- ReinspectionNotRequired
            WHEN rd.ReinspectionDate IS NULL AND ISNULL(fnrd.DateOfNextReviewIsAsRequired, 0) = 0 THEN 1
            -- Compliant
            WHEN rd.ReinspectionDate > DATEADD(MONTH, 3, GETDATE()) OR ISNULL(fnrd.DateOfNextReviewIsAsRequired, 0) = 1 THEN 2
            -- ReinspectionOverdue
            WHEN rd.ReinspectionDate < GETDATE() THEN 3
            -- ReinspectionDueIn3Months
            ELSE 4
        END [Surveyed]
    FROM
        #SiteJobs sj
        OUTER APPLY
        (
            SELECT MAX(RiskScoreGroupID) [HighestRiskScoreGroupID]
            FROM #SiteJobsComputedData
            WHERE SiteID = sj.SiteID
        ) hrsgi -- HighestRiskScoreGroupID
        OUTER APPLY
        (
            SELECT MIN(DateOfNextReviewInt) [FirstNextReviewDate], CAST(MAX(CAST(DateOfNextReviewIsAsRequired AS INT)) AS BIT) [DateOfNextReviewIsAsRequired]
            FROM #SiteJobsComputedData
            WHERE SiteID = sj.SiteID AND RiskScoreGroupID = hrsgi.HighestRiskScoreGroupID AND (DateOfNextReviewInt IS NOT NULL OR DateOfNextReviewIsAsRequired = 1)
        ) fnrd -- FirstNextReviewDate
        OUTER APPLY
        (
            SELECT
                CASE
                    WHEN sj.IsSiteDocument = 1 THEN DATEADD(MONTH, 12, sj.MaxRegisterFinish)
                    WHEN fnrd.FirstNextReviewDate IS NOT NULL THEN DATEADD(MONTH, fnrd.FirstNextReviewDate, sj.MaxRegisterFinish)
					WHEN fnrd.DateOfNextReviewIsAsRequired = 1 THEN NULL
                    WHEN hrsgi.HighestRiskScoreGroupID = 4 THEN DATEADD(MONTH, 6, sj.MaxRegisterFinish)
                    WHEN hrsgi.HighestRiskScoreGroupID IS NOT NULL THEN DATEADD(MONTH, 12, sj.MaxRegisterFinish)
                END [ReinspectionDate]
        ) rd -- ReinspectionDate

    -- Delete from #SiteJobs.
    DELETE FROM #SiteJobs

    -- Re-insert the new data into #SiteJobs.
    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish, HighestRiskScoreGroupID, FirstNextReviewDate, ReinspectionDate, Surveyed FROM @SiteJobsCalculated

    -- Clear up temp tables.
    DROP TABLE #AllSiteJobsData
    DROP TABLE #SiteJobsComputedData


    SET NOCOUNT OFF;
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Portfolio_SitesSurveyedChartData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Portfolio_SitesSurveyedChartData] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[Portfolio_SitesSurveyedChartData]
    @ClientIDs VARCHAR(MAX) = '',
    @ProjectGroupID INT = NULL,
    @ProjectID INT = NULL,
    @SiteIDs VARCHAR(MAX) = '',
    @SurveyTypeIDs VARCHAR(MAX) = '',
    @ReturnAsChart BIT = NULL
/**********************************************************************
** Overview: Get the Sites Surveyed data.
**
** PLEASE NOTE: Please use SVN as a Change Log.
**********************************************************************/
AS
BEGIN
    SET NOCOUNT ON;


    -- Set default variable values if not passed in.
    SELECT
        @ClientIDs = NULLIF(LTRIM(RTRIM(@ClientIDs)), ''),
        @ProjectGroupID = NULLIF(@ProjectGroupID, 0),
        @ProjectID = NULLIF(@ProjectID, 0),
        @SiteIDs = NULLIF(LTRIM(RTRIM(@SiteIDs)), ''),
        @SurveyTypeIDs = NULLIF(LTRIM(RTRIM(@SurveyTypeIDs)), ''),
        @ReturnAsChart = ISNULL(@ReturnAsChart, 0)

    -- Get all Clients up front to reduce table scans on the Client table and only get the ones needed. Also used by PopulateSiteJobsReinspectionState.
    CREATE TABLE #ClientIdData (ClientID INT PRIMARY KEY)
    INSERT INTO #ClientIdData (ClientID)
    SELECT LTRIM(RTRIM(s)) [ClientID]
    FROM dbo.SplitString(@ClientIDs, ',')
    WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL
    GROUP BY s

    -- Get all Survey Types up front to reduce table scans on the SurveyType table and only get the ones needed.
    CREATE TABLE #SurveyTypeIdData (SurveyTypeID INT PRIMARY KEY)
    INSERT INTO #SurveyTypeIdData (SurveyTypeID)
    SELECT s
    FROM dbo.SplitString(@SurveyTypeIDs, ',')

    -- Get the assigned Client and Site data up front to reduce table scans on the Client/Site table.
    DECLARE @ClientSiteData TABLE (ClientID INT, SiteID INT)

    IF @SiteIDs IS NOT NULL
    BEGIN -- Restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            #ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            INNER JOIN (
                SELECT LTRIM(RTRIM(s)) [SiteID] FROM dbo.SplitString(@SiteIDs, ',') WHERE NULLIF(LTRIM(RTRIM(s)), '') IS NOT NULL GROUP BY s
            ) sis ON si.SiteID = sis.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END
    ELSE
    BEGIN -- No restriction of Sites.
        INSERT INTO @ClientSiteData (ClientID, SiteID)
        SELECT
            c.ClientID,
            si.SiteID
        FROM
            #ClientIdData c
            INNER JOIN ClientSite cs WITH (NOLOCK) ON c.ClientID = cs.ClientID
            INNER JOIN Site si WITH (NOLOCK) ON cs.SiteID = si.SiteID
            LEFT JOIN ProjectSite ps WITH (NOLOCK) ON si.SiteID = ps.SiteID
            LEFT JOIN Project p WITH (NOLOCK) ON ps.ProjectID = p.ProjectID
        WHERE
            si.Deleted IS NULL
                AND
            si.InactiveSite = 0
                AND
            ( -- Project Filter.
                (
                    @ProjectGroupID IS NULL
                        AND
                    @ProjectID IS NULL
                )
                    OR
                (
                    p.Deleted IS NULL
                        AND
                    (
                        p.ProjectGroupID = @ProjectGroupID
                            OR
                        p.ProjectID = @ProjectID
                    )
                )
            )
        GROUP BY
            c.ClientID,
            si.SiteID
    END

    -- Get all Site Jobs up front to reduce table scans (get the most recent job for each Site).
    CREATE TABLE #SiteJobs (SiteID INT PRIMARY KEY, SiteAddress VARCHAR(200), SitePostcode VARCHAR(15), SitePost2000 BIT, UnmanagedSite BIT, IsSiteDocument BIT, JobID INT, MaxRegisterFinish DATETIME, HighestRiskScoreGroupID INT, FirstNextReviewDate INT, ReinspectionDate DATETIME, Surveyed INT)

    -- Add an index on important #SiteJobs fields to increase speed below.
    CREATE INDEX temp_SiteJobs ON #SiteJobs (SiteID)

    INSERT INTO #SiteJobs (SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, MaxRegisterFinish)
    SELECT SiteID, SiteAddress, SitePostcode, SitePost2000, UnmanagedSite, IsSiteDocument, JobID, RegisterFinish [MaxRegisterFinish]
    FROM
    (
        SELECT
            si.SiteID,
            si.Address [SiteAddress],
            si.Postcode [SitePostcode],
            si.Post2000 [SitePost2000],
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            ROW_NUMBER() OVER(PARTITION BY si.SiteID ORDER BY jd.RegisterFinish DESC, jd.JobID DESC) [RowID]
        FROM
            @ClientSiteData csd
            INNER JOIN (
                SELECT
                    a.*,
                    ROW_NUMBER() OVER(PARTITION BY a.ClientID, a.SiteID ORDER BY a.RegisterFinish DESC, a.JobID DESC) [RowID]
                FROM
                (
                    SELECT 0 [IsSiteDocument], j.ClientID, j.SiteID, j.JobID, r.RegisterFinish
                    FROM
                        Job j WITH (NOLOCK)
                        INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
                        INNER JOIN Appointment a WITH (NOLOCK) ON q.QuoteID = a.QuoteID AND a.DateDeclined IS NULL
                        INNER JOIN JobEmployee je WITH (NOLOCK) ON j.JobID = je.JobID
                        INNER JOIN Register r WITH (NOLOCK) ON je.JobEmployeeID = r.JobEmployeeID AND r.DateApproved IS NOT NULL
                        INNER JOIN Survey su WITH (NOLOCK) ON r.SurveyID = su.SurveyID
                        INNER JOIN #SurveyTypeIdData sut ON su.SurveyTypeID = sut.SurveyTypeID
                    WHERE j.Approved IS NOT NULL AND j.Cancelled IS NULL
                    UNION ALL
                    SELECT 1 [IsSiteDocument], NULL [ClientID], sid.SiteID, NULL [JobID], sidi.WorkDate [RegisterFinish]
                    FROM
                        SiteDocument sid WITH (NOLOCK)
                        INNER JOIN SiteDocumentInformation sidi WITH (NOLOCK) ON sid.SiteDocumentId = sidi.SiteDocumentID
                    WHERE
                        sid.SiteDocumentTypeID = 3 -- Surveys
                            AND
                        sid.Deleted IS NULL
                ) a
            ) jd ON
                CASE WHEN jd.IsSiteDocument = 1
                    THEN -1
                    ELSE csd.ClientID
                END = ISNULL(jd.ClientID, -1) AND csd.SiteID = jd.SiteID AND jd.RowID = 1
            INNER JOIN Site si WITH (NOLOCK) ON csd.SiteID = si.SiteID
        GROUP BY
            si.SiteID,
            si.Address,
            si.Postcode,
            si.Post2000,
            si.UnmanagedSite,
            jd.IsSiteDocument,
            jd.JobID,
            jd.RegisterFinish,
            jd.RowID
    ) a
    WHERE a.RowID = 1
    GROUP BY
        a.SiteID,
        a.SiteAddress,
        a.SitePostcode,
        a.SitePost2000,
        a.UnmanagedSite,
        a.IsSiteDocument,
        a.JobID,
        a.RegisterFinish,
        a.RowID
    ORDER BY
        a.SiteID

    -- Execute the SPROC Portfolio_PopulateSiteJobsReinspectionState. This populates additional columns in #SiteJobs, so it assumes #SiteJobs already exists.
    EXEC Portfolio_PopulateSiteJobsReinspectionState

    -- Get the total number of items.
    DECLARE @TotalItems INT = (SELECT COUNT(*) FROM #SiteJobs)

    -- Start the main SELECT.
    IF @ReturnAsChart = 1
    BEGIN
        SELECT
            CASE
                WHEN SitePost2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN 'Reinspection Not Required'
                        WHEN 2 THEN 'Compliant'
                        WHEN 3 THEN 'Reinspection Overdue'
                        WHEN 4 THEN 'Compliant - Reinspection Due Within 3 Months'
                        ELSE NULL
                    END
            END [category],
            CASE
                WHEN SitePost2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN '#00B050'
                        WHEN 2 THEN '#AFD8F8'
                        WHEN 3 THEN '#E8412D'
                        WHEN 4 THEN '#F6BD0F'
                        ELSE NULL
                    END
            END [Colour],
            COUNT(*) [Share],
            @TotalItems [TotalItems],
            CAST(1 AS BIT) [VisibleInLegend],
            Surveyed
        FROM #SiteJobs
        GROUP BY
            CASE
                WHEN SitePost2000 = 1 THEN 'Post 2000'
                WHEN UnmanagedSite = 1 THEN 'Un-managed Site (No survey required)'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN 'Reinspection Not Required'
                        WHEN 2 THEN 'Compliant'
                        WHEN 3 THEN 'Reinspection Overdue'
                        WHEN 4 THEN 'Compliant - Reinspection Due Within 3 Months'
                        ELSE NULL
                    END
            END,
            CASE
                WHEN SitePost2000 = 1 THEN '#CCCCCC'
                WHEN UnmanagedSite = 1 THEN '#15527F'
                ELSE
                    CASE Surveyed
                        WHEN 1 THEN '#00B050'
                        WHEN 2 THEN '#AFD8F8'
                        WHEN 3 THEN '#E8412D'
                        WHEN 4 THEN '#F6BD0F'
                        ELSE NULL
                    END
            END,
            Surveyed
        ORDER BY
            Surveyed,
            category
    END
    ELSE
    BEGIN
        SELECT
            sj.SiteID,
            sj.JobID,
            0 [SurveyTypeID], -- 07/11/2016 - Old column, remove in the future.
            sj.Surveyed,
            sj.ReinspectionDate,
            sj.SiteAddress,
            sj.SitePostcode
        FROM
            #SiteJobs sj
    END

    -- Clear up temp tables.
    DROP TABLE #ClientIdData
    DROP TABLE #SurveyTypeIdData
    DROP TABLE #SiteJobs


    SET NOCOUNT OFF;
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'ClientContactsActive') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[ClientContactsActive] AS BEGIN SET NOCOUNT ON; END')
End

go

alter procedure ClientContactsActive(@ClientId as int)
as
/* Lists active client contacts joins back to AdditionalContacts to eliminate deleted additional contacts 
which appear in the ClientContacts view 
Also eliminates the 0 default contact from list
*/

select 	
	cc.ContactID,
	cc.Contact	
from 
	ClientContacts cc 
	inner join AdditionalContactInfo aci on aci.AdditionalContactInfoId = cc.ContactId 
											and aci.Linkid = @ClientId
											and cc.MainContact = 0 
											and aci.Deleted is null
											and cc.ContactId != 0 
											and cc.ClientId = @ClientId 		
order by 	
	Contact

go

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'LegionellaJobTasks') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[LegionellaJobTasks] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[LegionellaJobTasks]
	@LegionellaId INT
AS
SET NOCOUNT ON
SET ANSI_WARNINGS OFF
BEGIN
	DECLARE @Tasks TABLE (LegionellaTaskID INT)

	INSERT INTO @Tasks
	SELECT 
		lt.LegionellaTaskID
	FROM 
		LegionellaTask lt
	WHERE
		lt.LegionellaID = @LegionellaId
			AND
		lt.Deleted IS NULL

	INSERT INTO @Tasks
	SELECT 
		lt.LegionellaTaskID
	FROM 
		LegionellaAsset la
		JOIN LegionellaTask lt ON lt.LegionellaAssetID = la.LegionellaAssetID
	WHERE
		la.LegionellaID = @LegionellaId
			AND
		la.Deleted IS NULL
			AND
		la.DateRemoved IS NULL
			AND
		lt.Deleted IS NULL

	DECLARE @Locations TABLE (LegionellaLocationID INT)

	INSERT INTO @Locations
	SELECT 
		ll.LegionellaLocationID
	FROM 
		LegionellaLocation ll 
	WHERE
		ll.LegionellaID = @LegionellaId
			AND
		ll.Deleted IS NULL
			AND
		ll.DateRemoved IS NULL
	ORDER BY
		ll.Location

	INSERT INTO @Tasks
	SELECT 
		lt.LegionellaTaskID
	FROM
		@Locations ll
		JOIN LegionellaOutlet lo ON ll.LegionellaLocationID = lo.LegionellaLocationID
		JOIN LegionellaTask lt ON lo.LegionellaOutletID = lt.LegionellaOutletID
	WHERE
		lo.Deleted IS NULL
			AND 
		lo.DateRemoved IS NULL
			AND
		lt.Deleted IS NULL

	INSERT INTO @Tasks
	SELECT
		lt.LegionellaTaskID
	FROM
		@Locations ll
		JOIN LegionellaTask lt ON ll.LegionellaLocationID = lt.LegionellaLocationID
	WHERE
		lt.Deleted IS NULL

	SELECT 
		* 
	FROM
		LegionellaTask lt
		JOIN @Tasks t ON lt.LegionellaTaskID = t.LegionellaTaskID
END
GO

-- Legionella paging alterations begin

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_LegionellaCompletedJobsGrid') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_LegionellaCompletedJobsGrid] AS BEGIN SET NOCOUNT ON; END')
END
GO

alter PROCEDURE [dbo].[TEAMS_LegionellaCompletedJobsGrid]
	-- Paging
    @PerPage INT = 15,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
	@JobID INT = 0,
	@JobNo VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @EmployeeId INT = 0,
	@WorkTypeId INT = 0,
	@BranchId INT = 0, -- (0 = all)
	@ExcludeClientId INT = 0 -- (0=don't exclude any)
AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				*
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1

	-- Get all of the required data from dgLegionellaNew and dgLegionellaCompleted in to one table so that we can apply our filters later on in one go instead of seperately on each view
	DECLARE @LegionellaCompletedView TABLE (IndexID INT IDENTITY(1,1), RowNo INT, JobID INT, TypeID INT, Type VARCHAR(MAX), JobNo VARCHAR(10), Start DATETIME, Finish DATETIME, MonitoringSchedule DATETIME, 
	Due DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, Site VARCHAR(MAX), Report BIT, Photos BIT, Plans BIT, Documents BIT, DateApproved DATETIME, HasNotes INT, NotesInLastHour INT, NewGrid INT, 
	Status VARCHAR(MAX), OrgState VARCHAR(MAX), PDF BIT, EmployeeID INT, FullName VARCHAR(MAX), ProjectID INT)

	INSERT INTO @LegionellaCompletedView (RowNo, JobID, TypeID, Type, JobNo, Start, Finish, MonitoringSchedule, Due, ClientID, Client, SiteID, Site, Report, Photos, Plans, Documents, DateApproved, HasNotes, NotesInLastHour, NewGrid, Status, OrgState, PDF, EmployeeID, FullName, ProjectID)
	Select
		ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY MAX(l.LegionellaFinish) DESC) [RowNo],
		j.JobID,
		lt.LegionellaTypeID [TypeID],
		lt.Description [Type],
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		MIN(l.LegionellaStart) [Start],
		MAX(l.LegionellaFinish) [Finish],
		MAX(l.MonitoringSchedule) [MonitoringSchedule],
		MAX(al.DueDate) [Due],
		c.ClientID,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteID,
		s.Address [Site],
		CAST(CASE WHEN leginfo.ReportInformationID IS NULL THEN 0 ELSE 1 END as bit) [Report],
		CAST(CASE WHEN p.PhotoID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Photos],
		CAST(CASE WHEN fp.FloorplanID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Plans],
		CAST(CASE WHEN MIN(lsd.LegionellaSupportingDocumentId) IS NOT NULL THEN 1 ELSE 0 END as BIT) [Documents],
		l.DateApproved,
		0 [HasNotes],
		0 [NotesInLastHour],
		1 [NewGrid],
		j.Status [Status],
		os.ShortDescription [OrgState],
		CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT) [PDF],
		je.EmployeeID [EmployeeID],
		e.FullName [FullName],
		j.ProjectID
	FROM
		Job j WITH (NOLOCK)
		INNER JOIN Client c WITH (NOLOCK) ON j.ClientID=c.ClientID
		INNER JOIN Site s WITH (NOLOCK) ON j.SiteID=s.SiteID
		INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
		INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID
		INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID = a.AppointmentID
		INNER JOIN LegionellaType lt WITH (NOLOCK) ON lt.LegionellaTypeID = al.LegionellaTypeID
		LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
		LEFT JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
		LEFT JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID AND l.DateApproved IS NOT NULL
		LEFT JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
		OUTER APPLY
		(
			SELECT TOP 1
				l.ReportInformationID
			FROM
				Job _j
				INNER JOIN JobEmployee je ON j.JobID = je.JobID
				INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
			WHERE
				_j.JobID = j.JobId
			ORDER BY
				l.ReportInformationID
		) legInfo
		LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.LegionellaID=l.LegionellaID AND (fp.AutocadDataContentType IS NOT NULL OR fp.FloorplanDataContentType IS NOT NULL)
		LEFT OUTER JOIN LegionellaSupportingDocument lsd WITH (NOLOCK) ON lsd.LegionellaID=l.LegionellaID
		LEFT OUTER JOIN Photo p WITH (NOLOCK) ON p.PhotoID = l.PhotoID
		LEFT OUTER JOIN PDF pf WITH (NOLOCK) ON pf.JobId=j.JobID AND pf.DateDeleted IS NULL
		LEFT JOIN orgInstruction o WITH (NOLOCK) ON o.JobID=j.JobID AND o.Completed IS NULL AND o.Deleted IS NULL AND ISNULL(NULLIF(o.GenerationType,'legionella'),'')=''
		LEFT JOIN orgState os On o.orgStateID = os.orgStateID
	Where
		a.DateDeclined IS NULL
			AND
		j.Approved IS NOT NULL
			AND		
		(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN al.DueDate BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID = @JobID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID = @ClientID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN s.SiteID = @SiteID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID = @ProjectID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobNo IS NULL OR LTRIM(RTRIM(@JobNo)) = '' THEN 1 ELSE CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @EmployeeID = 0 THEN 1 ELSE CASE WHEN je.EmployeeID = @EmployeeID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @WorkTypeID = 0 THEN 1 ELSE CASE WHEN lt.LegionellaTypeID = @WorkTypeID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID = @BranchId THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID != @ExcludeClientId THEN 1 ELSE 0 END END = 1)
	GROUP BY
		j.JobID,
		lt.LegionellaTypeID,
		lt.Description,
		j.JobNo,
		c.ClientID,
		c.Client,
		c.BranchName,
		s.SiteID,
		s.Address,
		l.DateApproved,
		j.Status,
		je.EmployeeID,
		e.FullName,
		os.ShortDescription,
		CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT),
		fp.FloorplanID,
		p.PhotoID,
		leginfo.ReportInformationID,
		j.ProjectID






	 --Only get jobs from the dgLegionellaCompleted view if they have not selected a work type.
	IF @WorkTypeId = 0
	BEGIN
	  INSERT INTO @LegionellaCompletedView (RowNo, JobID, TypeID, Type, JobNo, Start, Finish, MonitoringSchedule, Due, ClientID, Client, SiteID, Site, Report, Photos, Plans, Documents, DateApproved, HasNotes, NotesInLastHour, NewGrid, Status, OrgState, PDF, EmployeeID, FullName, ProjectID)		
	  Select
		ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY j.Approved DESC) [RowNo],
		j.JobId,
		qvt.QuoteVisitTypeId [TypeID], 
		qvt.Description [Type], 
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		Cast(MIN(a.StartTime) as date) [Start],
		Cast(MIN(a.EndTime) as date) [Finish],
		Cast(MIN(a.EndTime) as date) [MonitoringSchedule],
		Cast(MAX(agt.DueDate) as date) [Due], 
		c.ClientId,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteId,
		s.Address [Site],
		0 As [Report],
		0 As [Photos],
		0 As [Plans],
		0 As [Documents],
		j.Approved [DateApproved],
		0 [HasNotes],
		0 [NotesInLastHour],
		0 [NewGrid],
		j.Status [Status],
		'' [OrgState],
		0 As [PDF],
		qe.EmployeeID [EmployeeID],
		e.FullName [FullName],
		j.ProjectID [ProjectID]
	From 
		Quote q WITH (NOLOCK)
		INNER JOIN QuoteEmployee qe WITH (NOLOCK) ON q.QuoteID=qe.QuoteID
		INNER JOIN Employee e WITH (NOLOCK) ON qe.EmployeeID = e.EmployeeID
		INNER JOIN QuoteVisit qv WITH (NOLOCK) ON qv.QuoteEmployeeID=qe.QuoteEmployeeID
		INNER JOIN QuoteVisitType qvt WITH (NOLOCK) ON qvt.QuoteVisitTypeID=qv.QuoteVisitTypeID
		Inner Join Appointment a WITH (NOLOCK) On a.QuoteID = q.QuoteID AND a.AppointmentTypeID IN (5,4)			
		INNER JOIN
		(
			Select ag.DueDate, ag.AppointmentID FROM AppointmentGeneral ag WITH (NOLOCK)
				UNION
			Select null [DueDate], at.AppointmentID FROM AppointmentTraining at WITH (NOLOCK)
		) agt ON agt.AppointmentID=a.AppointmentID
		INNER JOIN Job j WITH (NOLOCK) ON j.JobID=q.JobID
		Left Outer Join Client c WITH (NOLOCK) On a.ClientId = c.ClientId
		Left Outer Join Site s WITH (NOLOCK) On a.SiteId = s.SiteId
		Outer Apply 
		(
			Select Top 1 [FileName] From PDF p WITH (NOLOCK) Where p.JobId = j.JobID AND p.FileName Like '%ra%' AND p.DateDeleted Is Null Order by p.DateCreated DESC
		) oa_pdf
	where		
		a.ManuallyMarkWorkDone = 1
			And
		a.DateConfirmed IS NOT Null
			And
		a.DateDeclined Is Null
			And
		qvt.QuoteVisitTypeId=4
		and
		(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN agt.DueDate BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID = @JobID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID = @ClientID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN s.SiteID = @SiteID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID = @ProjectID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobNo IS NULL OR LTRIM(RTRIM(@JobNo)) = '' THEN 1 ELSE CASE WHEN JobNo = @JobNo THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @EmployeeID = 0 THEN 1 ELSE CASE WHEN qe.EmployeeID = @EmployeeID THEN 1 ELSE 0 END END = 1)			
			AND
		(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN c.ClientID != @ExcludeClientId THEN 1 ELSE 0 END END = 1)
			AND		
		(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID = @BranchId THEN 1 ELSE 0 END END = 1)
	GROUP BY
		j.JobId,
		qvt.QuoteVisitTypeId,
		qvt.Description,
		j.JobNo,
		c.ClientId,
		c.Client,
		c.BranchName,
		s.SiteId,
		s.Address,
		j.Approved,
		j.Status,
		qe.EmployeeID,
		e.FullName,
		j.ProjectID


	END

	--Apply our filters
	DECLARE @LegionellaCompletedTopLevel TABLE (IndexID INT IDENTITY(1,1), JobID INT, TypeID INT, ReportType VARCHAR(MAX), JobNo VARCHAR(10), Start DATETIME, Finish DATETIME, MonitoringSchedule DATETIME, Due DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, Site VARCHAR(MAX), Report BIT, Photos BIT, Plans BIT, Documents BIT, DateApproved DATETIME, HasNotes INT, NotesInLastHour INT, NewGrid INT, Status VARCHAR(MAX), OrgState VARCHAR(MAX), PDF BIT, EmployeeID INT, FullName VARCHAR(MAX), ProjectID INT, BranchOfficeID INT, UPRN VARCHAR(MAX))

	INSERT INTO @LegionellaCompletedTopLevel (JobID, TypeID, ReportType, JobNo, Start, Finish, MonitoringSchedule, Due, ClientID, Client, SiteID, Site, Report, Photos, Plans, Documents, DateApproved, HasNotes, NotesInLastHour, NewGrid, Status, OrgState, PDF, EmployeeID, FullName, ProjectID, BranchOfficeID, UPRN)
	SELECT
		lcompv.JobID,
		lcompv.TypeID,
		lcompv.Type,
		lcompv.JobNo,
		lcompv.Start,
		lcompv.Finish,
		lcompv.MonitoringSchedule,
		lcompv.Due,
		lcompv.ClientID,
		lcompv.Client,
		lcompv.SiteID,
		si.Address + ', ' + si.Postcode [Site],
		lcompv.Report,
		lcompv.Photos,
		lcompv.Plans,
		lcompv.Documents,
		lcompv.DateApproved,
		lcompv.HasNotes,
		lcompv.NotesInLastHour,
		lcompv.NewGrid,
		lcompv.Status,
		lcompv.OrgState,
		lcompv.PDF,
		lcompv.EmployeeID,
		lcompv.FullName,
		lcompv.ProjectID,
		j.BranchOfficeID,
		si.UPRN
	FROM
		@LegionellaCompletedView lcompv
		INNER JOIN Job j ON lcompv.JobID = j.JobID
		INNER JOIN Site si ON lcompv.SiteID = si.SiteID
	WHERE	
		(
			CASE
				WHEN LEN(@Filter ) = 0 
				THEN 1 
				ELSE 
					CASE 
						WHEN
						(
							lcompv.Site Like '%' + @Filter + '%'
						) 
						THEN 1 
						ELSE 0 
					END
			END = 1
		)
			AND
		j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)	

		declare @RowTotal as int
		declare @Pages as int
		select 
			@RowTotal = count(IndexId) 			
		from
			 @LegionellaCompletedTopLevel
		
	select 
		*	
	from
	(
		Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 			

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                cast((Row_Number() Over(Order By a.DateApproved DESC)-1) / @PerPage+1  as int)
            END As Page, 

            cast(Row_Number() Over(Order By a.Due) as int) as Row_Num, 
			@RowTotal as RowTotal,

            *
        From 
			(
				Select * FROM @LegionellaCompletedTopLevel
			) a		
	) as x where
	[Page] = @CurrentPage
	order by
		Finish desc


	SET NOCOUNT OFF;
END
GO

if exists(SELECT * FROM sys.indexes WHERE name='idx_SurveyApproval_orgInstructionDateDeleted' AND object_id = OBJECT_ID('dbo.SurveyApproval'))
begin
DROP INDEX [idx_SurveyApproval_orgInstructionDateDeleted] ON [dbo].[SurveyApproval]
end
GO

CREATE NONCLUSTERED INDEX [idx_SurveyApproval_orgInstructionDateDeleted] ON [dbo].[SurveyApproval]
(
	[orgInstructionID] ASC,
	[DateDeleted] ASC
)
INCLUDE ([SurveyApprovalId],
	[EmployeeId]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO


if exists(SELECT * FROM sys.indexes WHERE name='idx_Floorplan_LegionellaId' AND object_id = OBJECT_ID('dbo.Floorplan'))
begin
DROP INDEX [idx_Floorplan_LegionellaId] ON [dbo].[Floorplan]
end
GO

CREATE NONCLUSTERED INDEX [idx_Floorplan_LegionellaId] ON [dbo].[Floorplan]
(
	[LegionellaID] ASC
)
INCLUDE ([FloorplanID],
	[FloorplanDataContentType],
	[AutocadDataContentType]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO


if exists(SELECT * FROM sys.indexes WHERE name='idx_PDF_DateDeleted' AND object_id = OBJECT_ID('dbo.PDF'))
begin
	DROP INDEX [idx_PDF_DateDeleted] ON [dbo].[PDF]
end


CREATE NONCLUSTERED INDEX [idx_PDF_DateDeleted] ON [dbo].[PDF]
(
	[DateDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

if exists(SELECT * FROM sys.indexes WHERE name='idx_Appointment_LegionellaBrowse' AND object_id = OBJECT_ID('dbo.Appointment'))
begin
	DROP INDEX [idx_Appointment_LegionellaBrowse] ON [dbo].[Appointment]
end
GO

CREATE NONCLUSTERED INDEX [idx_Appointment_LegionellaBrowse] ON [dbo].[Appointment]
(
	[DateDeclined] ASC,
	[ManuallyMarkWorkDone] ASC,
	[AppointmentTypeID] ASC,
	[DateConfirmed] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

-- Legionella paging alterations end

INSERT INTO LegionellaAssetCategory (LegionellaAssetCategoryID,[Description],TabName,DefaultAssetCode,SortOrder,Deleted) Select 72,'Hose Reels','Hose Reels','HR',999,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaAssetCategory WHERE LegionellaAssetCategoryID=72)=0
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GetAdditionalClientContactsGridData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GetAdditionalClientContactsGridData] AS BEGIN SET NOCOUNT ON; END')
END
GO


-- =============================================
-- Author:		Daniel W
-- Create date: 13/12/2017
-- Altered : John H 24/09/2020 Deleted groups appearing in group list fix
-- Description:	Stored procedure to get the grid data for the 'Edit Additional Client Contacts' grid
-- =============================================
ALTER PROCEDURE [dbo].[GetAdditionalClientContactsGridData]
	-- Add the parameters for the stored procedure here
	@ClientID int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT
		isnull(groups.Names,'') [Groups],
		aci.AdditionalContactInfoID,
		aci.Contact,
		'Client - ' + c.Client [ClientDescription],
		aci.Email,
		aci.Phone,
		aci.Salutation,
		aci.ContactAddress,
		aci.ContactPostcode,
		c.ClientID
	FROM
		AdditionalContactInfo aci
		INNER JOIN Client c WITH (NOLOCK) ON aci.LinkID = c.ClientID
		OUTER APPLY
		(SELECT
			STUFF(
				(
					SELECT
						', ' + Isnull(aci2.Contact,'')
					FROM
						AdditionalContactInfo aci2
						INNER JOIN AdditionalContactGroupLinks acgl WITH (NOLOCK) ON aci2.AdditionalContactInfoID = acgl.AdditionalContactInfoId_forGroup
					WHERE
						aci2.Deleted IS NULL
							AND
						aci2.AdditionalContactTypeID = (SELECT AdditionalContactTypeID FROM AdditionalContactType act2 WHERE act2.ContactTypeDescription = 'Contact Group' AND act2.Deleted IS NULL)
							AND
						aci2.LinkID = @ClientID
							AND
						acgl.AdditionalContactInfoId_forMember = aci.AdditionalContactInfoID
							AND							
						aci2.b_isTemp = 0										
					FOR XML PATH(''), TYPE
				).value('.', 'nvarchar(max)'),
				1,
				1,
				''
			)
		) [groups](names)
	WHERE
		aci.b_isTemp = 0
			AND
		aci.Deleted IS NULL
			AND
		aci.AdditionalContactTypeID = (SELECT AdditionalContactTypeID FROM AdditionalContactType act2 WHERE act2.ContactTypeDescription = 'Client' AND act2.Deleted IS NULL)
			AND
		aci.LinkID = @ClientID
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='Sample') AND name='SampleTypeID') < 1 BEGIN
	ALTER TABLE [Sample]
		ADD [SampleTypeID] INT NOT NULL DEFAULT(1)
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SampleType')) BEGIN
	CREATE TABLE [dbo].[SampleType](
		[SampleTypeID] [int] NOT NULL,
		[Description] [varchar](max) NOT NULL,
		[DateDeleted] [datetime] NULL,
	 CONSTRAINT [PK_SampleType] PRIMARY KEY CLUSTERED 
	(
		[SampleTypeID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 1, 'Asbestos',NULL WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=1)=0
INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 2, 'PCB',GETDATE() WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=2)=0
INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 3, 'SMF',GETDATE() WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=3)=0
INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 4, 'Lead Paint',GETDATE() WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=4)=0
INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 5, 'Lead Dust',GETDATE() WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=5)=0
INSERT INTO SampleType (SampleTypeID,Description,DateDeleted) SELECT 6, 'ODS',GETDATE() WHERE (SELECT COUNT(*) FROM SampleType WHERE SampleTypeID=6)=0

GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SampleTypeElement')) BEGIN
	CREATE TABLE [dbo].[SampleTypeElement](
		[SampleTypeElementID] [int] IDENTITY(1,1) NOT NULL,
		[SampleTypeID] [int] NOT NULL,
		[ElementTypeID] [int] NOT NULL,
		[ElementTypeDescription] [varchar](max) NULL,
		[PriorityAssessment] [BIT] NOT NULL DEFAULT(0),
		[UseElementIntMeaningExtended] [BIT] NOT NULL DEFAULT(0),
		[UseElementIntMeaningSubOption] [BIT] NOT NULL DEFAULT(0),
	 CONSTRAINT [PK_SampleTypeElement] PRIMARY KEY CLUSTERED 
	(
		[SampleTypeElementID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SampleTypeElementIntMeaning')) BEGIN
	CREATE TABLE [dbo].[SampleTypeElementIntMeaning](
		[SampleTypeElementIntMeaningID] [int] IDENTITY(1,1) NOT NULL,
		[SampleTypeID] [int] NOT NULL,
		[ElementTypeID] [int] NOT NULL,
		[ElementIntMeaningID] [int] NOT NULL,
		[ElementIntValue] [int] NOT NULL,
		[Description] [varchar](max) NULL,
		[ShortDescription] [varchar](max) NULL,
	 CONSTRAINT [PK_SampleTypeElementIntMeaning] PRIMARY KEY CLUSTERED 
	(
		[SampleTypeElementIntMeaningID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SampleTypeElementIntMeaningExtended')) BEGIN
	CREATE TABLE [dbo].[SampleTypeElementIntMeaningExtended](
		[SampleTypeElementIntMeaningExtendedID] [int] IDENTITY(1,1) NOT NULL,
		[SampleTypeID] [int] NOT NULL,
		[ElementIntMeaningExtendedID] [int] NOT NULL,
		[ElementTypeID] [int] NOT NULL,
		[Description] [varchar](max) NULL,
	 CONSTRAINT [PK_SampleTypeElementIntMeaningExtended] PRIMARY KEY CLUSTERED 
	(
		[SampleTypeElementIntMeaningExtendedID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF (not EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='SampleTypeElementIntMeaningSubOption')) BEGIN
	CREATE TABLE [dbo].[SampleTypeElementIntMeaningSubOption](
		[SampleTypeElementIntMeaningSubOptionID] [int] IDENTITY(1,1) NOT NULL,
		[SampleTypeID] [int] NOT NULL,
		[ElementIntMeaningSubOptionID] [int] NOT NULL,
		[ElementTypeID] [int] NOT NULL,
		[Description] [varchar](max) NULL,
	 CONSTRAINT [PK_SampleTypeElementIntMeaningSubOption] PRIMARY KEY CLUSTERED 
	(
		[SampleTypeElementIntMeaningSubOptionID] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

If (SELECT COUNT(*) FROM sys.objects WHERE type = 'IF' AND name = 'SamplesForJob') < 1 BEGIN
	EXEC('CREATE FUNCTION [dbo].[SamplesForJob] (@JobID as int) RETURNS TABLE RETURN ( SELECT 1 )')
End
GO

ALTER FUNCTION [dbo].[SamplesForJob](@JobID as int)
RETURNS TABLE 
AS
RETURN 
(	
	SELECT
		s.SampleID,
		s.SampleRef,
        s.[DateAnalysed]
	FROM
		Sample s WITH (NOLOCK)
		INNER JOIN Room WITH (NOLOCK) ON s.RoomID = Room.RoomID
		INNER JOIN Register WITH (NOLOCK) ON Room.RegisterID = Register.RegisterID
		INNER JOIN JobEmployee WITH (NOLOCK) ON Register.JobEmployeeID = JobEmployee.JobEmployeeID
		INNER JOIN Job WITH (NOLOCK) ON JobEmployee.JobID = Job.JobID
		LEFT JOIN Element WITH (NOLOCK) ON s.SampleID = Element.SampleID 
	WHERE
		(ElementTypeID = 2 OR ElementTypeID IS NULL)
		AND JobEmployee.MainEmployee=1
		AND NOT ISNULL(SampleRef,'') = '' 
		AND AsSample = 0 
		AND ( 
				LaboratoryID IS NOT NULL
				OR EXISTS( Select 1 From Config Where b__UseSampleCheckIn = 0 )
			)
        AND Job.JobID = @JobID
		AND s.SampleTypeID = 1	
)

GO

IF EXISTS (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='CreditItem') AND name='Description')
BEGIN
	ALTER TABLE CreditItem
	ALTER COLUMN Description VARCHAR(MAX) NOT NULL
END
GO

IF EXISTS (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='ProFormaItem') AND name='Description')
BEGIN
	ALTER TABLE ProFormaItem
	ALTER COLUMN Description VARCHAR(MAX) NOT NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'PopulateSampleComputedData') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[PopulateSampleComputedData] AS BEGIN SET NOCOUNT ON; END')
END
GO

USE [TEAMS]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
    NEW VERSION OF POPULATE SAMPLECOMPUTEDDATA AND GUIDSAMPLES SPROCS
    These now join to the Floorplan table as well to prevent data issues on Ensafe, in particular to do with Import data.
    As well as this, PopulateSampleComputedData now uses less CTE's and more table variables, which has sped it up a lot. Seems to be working well on Ensafe, but we might need to keep an eye out.
*/
ALTER PROCEDURE [dbo].[PopulateSampleComputedData]
    @JobID INT
AS
BEGIN
    SET NOCOUNT ON;


    -- Delete existing data for the Job.
    DELETE FROM SampleComputedData
    WHERE JobID = @JobID

    -- Set variables for logic.
    DECLARE @CompanyName NVARCHAR(50), @BranchName NVARCHAR(50), @RecommendedActionsAllowed INT
    SELECT
        @CompanyName = cfg.s__CompanyName,
        @BranchName = cfg.s__BranchName,
        @RecommendedActionsAllowed = (SELECT mc.MobileConfigInt FROM MobileConfig mc WITH (NOLOCK) INNER JOIN MobileConfigType mct WITH (NOLOCK) ON mc.MobileConfigTypeID = mct.MobileConfigTypeID WHERE mct.ConfigType = 'RecommendedActionAllowed')
    FROM
        Config cfg WITH (NOLOCK)

    -- Get all sample result data up front to reduce table scans on the sample table
    DECLARE @SampleData TABLE (RegisterID INT, RegisterFinish DATETIME, PriorityAssessment BIT, RoomID INT, SampleRef VARCHAR(50), AsSample BIT, RegisterItemNo INT, SampleID INT, PhotoID INT, SampleResultID INT, SampleResult VARCHAR(500), FullSampleResult VARCHAR(500), SampleResultValue INT, SampleClassificationID INT, SampleClassification VARCHAR(500), SampleClassificationValue INT, SampleClassificationScore INT, Notes VARCHAR(MAX))

    INSERT INTO @SampleData (RegisterID, RegisterFinish, PriorityAssessment, RoomID, SampleRef, AsSample, RegisterItemNo, SampleID, PhotoID, SampleResultID, SampleResult, FullSampleResult, SampleResultValue, SampleClassificationID, SampleClassification, SampleClassificationValue, SampleClassificationScore, Notes)
    SELECT
        r.RegisterID,
        r.RegisterFinish,
        r.PriorityAssessment,
        rm.RoomID,
        s.SampleRef,
        s.AsSample,
        s.RegisterItemNo,
        s.SampleID,
        s.PhotoID,
        sr.SampleResultID,
        COALESCE(sr.SampleResult, eim8.ShortDescription, eim8.Description),
        COALESCE(sr.FullSampleResult, sr.SampleResult, eim8.ShortDescription, eim8.Description),
        COALESCE(sr.Value, e8.ElementIntID, -1),
        sc.SampleClassificationID,
        COALESCE(sce.SampleClassification, sc.SampleClassification, eime6.Description, eimso6.Description, eim6.ShortDescription, eim6.Description),
        COALESCE(sc.Value, e6sc.Value, -1),
        COALESCE(sc.Score, e6sc.Score, 0),
        s.Notes
    FROM
        JobEmployee je WITH (NOLOCK)
        INNER JOIN Register r WITH (NOLOCK) ON r.JobEmployeeID = je.JobEmployeeID
        INNER JOIN Survey su WITH (NOLOCK) ON su.SurveyID = r.SurveyID
        INNER JOIN Floorplan f WITH (NOLOCK) ON r.RegisterID = f.RegisterID
        INNER JOIN Room rm WITH (NOLOCK) ON rm.FloorplanID = f.FloorplanID
        INNER JOIN Sample s WITH (NOLOCK) ON s.RoomID = rm.RoomID
        LEFT JOIN SampleResult sr WITH (NOLOCK) ON s.SampleResultID = sr.SampleResultID
        LEFT JOIN Element e8 WITH (NOLOCK) ON s.SampleID = e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN ElementIntMeaning eim8 WITH (NOLOCK) ON e8.ElementIntMeaningID = eim8.ElementIntMeaningID
        LEFT JOIN SampleClassification sc WITH (NOLOCK) ON s.SampleClassificationID = sc.SampleClassificationID
        LEFT JOIN SampleClassificationExtended sce WITH (NOLOCK) ON s.SampleClassificationExtendedID = sce.SampleClassificationExtendedID
        LEFT JOIN Element e6 WITH (NOLOCK) ON s.SampleID = e6.SampleID AND e6.ElementTypeID = 6
        LEFT JOIN ElementIntMeaning eim6 WITH (NOLOCK) ON e6.ElementIntMeaningID = eim6.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime6 WITH (NOLOCK) ON e6.ElementIntMeaningExtendedID = eime6.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso6 WITH (NOLOCK) ON e6.ElementIntMeaningSubOptionID = eimso6.ElementIntMeaningSubOptionID
        LEFT JOIN SampleClassification e6sc WITH (NOLOCK) ON e6.ElementIntID = e6sc.SampleClassificationID
    WHERE
        je.JobID = @JobID
            AND
        s.Archived = 0
	    AND
	s.SampleTypeID = 1

    -- Get all element data up front to reduce table scans on the element table
    DECLARE @ElementData TABLE (ElementID INT, SampleID INT, ElementTypeID INT, ElementText VARCHAR(MAX), ElementIntID INT, ElementIntMeaningID INT, ElementIntMeaningExtendedID INT, ElementIntMeaningSubOptionID INT, ElementIntMeaningDescription VARCHAR(MAX), ElementIntMeaningShortDescription VARCHAR(MAX), ElementIntMeaningLongDescription VARCHAR(MAX), ElementDescriptionOrText VARCHAR(MAX))

    INSERT INTO @ElementData (ElementID, SampleID, ElementTypeID, ElementText, ElementIntID, ElementIntMeaningID, ElementIntMeaningExtendedID, ElementIntMeaningSubOptionID, ElementIntMeaningDescription, ElementIntMeaningShortDescription, ElementIntMeaningLongDescription, ElementDescriptionOrText)
    SELECT
        e.ElementID,
        e.SampleID,
        e.ElementTypeID,
        e.ElementText,
        e.ElementIntID,
        e.ElementIntMeaningID,
        e.ElementIntMeaningExtendedID,
        e.ElementIntMeaningSubOptionID,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description),
        eim.ShortDescription,
        eim.Description,
        COALESCE(eimso.Description, eime.Description, eim.ShortDescription, eim.Description, e.ElementText)
    FROM
        @SampleData s
        INNER JOIN Element e WITH (NOLOCK) ON e.SampleID = s.SampleID
        LEFT JOIN ElementIntMeaning eim WITH (NOLOCK) ON eim.ElementIntMeaningID = e.ElementIntMeaningID
        LEFT JOIN ElementIntMeaningExtended eime WITH (NOLOCK) ON eime.ElementIntMeaningExtendedID = e.ElementIntMeaningExtendedID
        LEFT JOIN ElementIntMeaningSubOption eimso WITH (NOLOCK) ON eimso.ElementIntMeaningSubOptionID = e.ElementIntMeaningSubOptionID

    -- Update table variable so that As Samples get the same Sample Data of the physical Samples
    UPDATE @SampleData
    SET
        SampleResultID = (SELECT subSD.SampleResultID FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        SampleResult = ISNULL((SELECT subSD.SampleResult FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        FullSampleResult = ISNULL((SELECT subSD.FullSampleResult FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), (SELECT ShortDescription FROM ElementIntMeaning WHERE ElementTypeID=8 AND ElementIntValue=e8.ElementIntID)),
        SampleResultValue = ISNULL((SELECT subSD.SampleResultValue FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e8.ElementIntID),
        SampleClassificationID = (SELECT subSD.SampleClassificationID FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0),
        SampleClassification = ISNULL((SELECT subSD.SampleClassification FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), e6.ElementIntMeaningDescription),
        SampleClassificationValue = ISNULL((SELECT subSD.SampleClassificationValue FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Value FROM SampleClassification WHERE e6.ElementIntID=SampleClassificationID), 0)),
        SampleClassificationScore = ISNULL((SELECT subSD.SampleClassificationScore FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0), ISNULL((SELECT Score FROM SampleClassification WHERE e6.ElementIntID=SampleClassificationID), 0)),
        Notes = (SELECT subSD.Notes FROM @SampleData subSD WHERE subSD.SampleRef=updateSD.SampleRef AND subSD.AsSample=0)
    FROM
        @SampleData updateSD
        LEFT JOIN @ElementData e8 ON updateSD.SampleID=e8.SampleID AND e8.ElementTypeID = 8
        LEFT JOIN @ElementData e6 ON updateSD.SampleID=e6.SampleID AND e6.ElementTypeID = 6
    WHERE
        updateSD.AsSample = 1

    -- Setup the CTEs.
      ;With SamplesComputed As
      (
            Select
                  s.SampleId,
                  s.SampleRef,
                  e2.ElementText [SourceDescription], 
                  e20.ElementIntMeaningShortDescription [RecommendedAction],
                  rac.RecommendedActionColour,
                  CASE WHEN e20.ElementIntMeaningShortDescription = 'No further action required'
                    THEN 0
                    Else @RecommendedActionsAllowed + 1 - e20.ElementIntID
                  END [RecommendedActionSortOrder],
                  s.SampleResultValue [SampleResult],

                  Case
                        When Not s.SampleResultValue = -1 Then
                              '(' + Cast(s.SampleResultValue as varchar(10)) + ') ' +
                              ISNULL(s.FullSampleResult, '')
                  End [AsbestosType],

                  Coalesce(sc.Value, sc2.Value, 0) [ClassificationValue],
                  Coalesce(sc.SampleClassification, e6.ElementIntMeaningShortDescription, e6.ElementIntMeaningLongDescription, '') [Classification],
                  Case
                        When sr.Value < 1 Then
                              0
                        When Not sc.SampleClassificationID Is Null Then
                              sc.Score
                        When Not e6.ElementIntID Is Null Then
                              e6.ElementIntID
                        Else
                              0
                  End [ClassificationScore],

                  e9.ElementIntID + e10.ElementIntID [MaterialAssessmentScore],

                  IsNull(e11.ElementIntID,0) [OccupantActivity],
                  IsNull(e12.ElementIntID,0) [LocationScore],
                  IsNull(e13.ElementIntID,0) [VulnerabilityScore],
                  IsNull(e14.ElementIntID,0) [QuantityScore],
                  IsNull(e15.ElementIntID,0) [NoOfOccupants],
                  IsNull(e16.ElementIntID,0) [FrequencyOfUse],
                  IsNull(e17.ElementIntID,0) [AverageTimeAreaIsInUse],
                  IsNull(e18.ElementIntID,0) [TypeOfMaintenance],
                  IsNull(e19.ElementIntID,0) [FrequencyOfMaintenance],
                  
                  s.SampleResultID,
                  s.SampleClassificationID,

                  Case
                        When (s.SampleResultValue > 0 Or e5.ElementIntId = 0)  AND (IsNull(e48.ElementIntMeaningID,0)<>121 AND IsNull(e48.ElementIntMeaningID,0)<>126) Then
                              Case
                                    When e27.ElementID IS NULL Then
                                          Case Coalesce(sc.Value,sc2.Value,0)
                                                      When 0 Then
                                                            Case e5.ElementIntID
                                                                  When 0 Then 
                                                                        -- INACCESSIBLE
                                                                        Case e22.ElementIntMeaningID
                                                                              When 113 Then ReviewDates.TwelveMonths
                                                                        End
                                                            End
                                                      When 10 Then ReviewDates.SixMonths
                                                      When  8 Then ReviewDates.SixMonths
                                                      When  7 Then ReviewDates.SixMonths
                                                      When  6 Then ReviewDates.SixMonths
                                                      Else 
                                                            ReviewDates.TwelveMonths
                                          End
                                    When ISNUMERIC(e27.ElementIntMeaningShortDescription) = 1 Then
                                          DATEADD(MONTH, CONVERT(int, e27.ElementIntMeaningShortDescription), ReviewDates.RegisterFinish)
                              End
                  End [ReviewDate],
                  
                  Case
                        When (s.SampleResultValue > 0 Or e5.ElementIntId = 0) And (IsNull(e48.ElementIntMeaningID,0)<>121 AND IsNull(e48.ElementIntMeaningID,0)<>126) Then
                              Case IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)
                                      When '2 Months' Then ReviewDates.TwoMonths
                                      When '3 Months' Then ReviewDates.ThreeMonths
                                      When '6 Months' Then ReviewDates.SixMonths
                                      Else
                                          Case
                                                When IsDate(IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)) = 1 Then
                                                      IsNull(e24.ElementText, e24.ElementIntMeaningLongDescription)
                                          End
                                    End
                  End [TimescaleForCompletion],

                  CASE WHEN s.PriorityAssessment = 1 THEN 0 ELSE 1 END [IsMAOnly],

                  LTrim(
                        Cast(IsNull(e26.ElementText, '') as varchar(Max)) + ' ' +
                        Cast(IsNull(e3.ElementText, '') as varchar(Max)) + ' ' +
                        Cast(IsNull(e4.ElementText, '') as varchar(Max))
                  ) [Quantity],
                  e31.ElementText [Comments],
                  Cast(Case When IsNull(e48.ElementIntMeaningId,0) = 121 Then 1 Else 0 End as bit) [Removed]
            From
                  @SampleData s
                  Outer Apply
                  (
                        Select
							CAST(MAX(RegisterFinish) as date) RegisterFinish,							
                            DateAdd(m,  2, Cast(Max(RegisterFinish) as date)) as TwoMonths,
                            DateAdd(m,  3, Cast(Max(RegisterFinish) as date)) as ThreeMonths,
                            DateAdd(m,  6, Cast(Max(RegisterFinish) as date)) as SixMonths,
                            DateAdd(m, 12, Cast(Max(RegisterFinish) as date)) as TwelveMonths
                        From @SampleData
                  ) as ReviewDates
                  LEFT JOIN SampleResult sr WITH (NOLOCK) On s.SampleResultId = sr.SampleResultId 
                  LEFT JOIN SampleClassification sc WITH (NOLOCK) On s.SampleClassificationId = sc.SampleClassificationID

                  -- Source Description
                  LEFT JOIN @ElementData e2 On s.SampleID = e2.SampleID AND e2.ElementTypeID = 2

                  -- Level of Identification
                  LEFT JOIN @ElementData e5 On s.SampleID = e5.SampleID AND e5.ElementTypeID = 5

                  -- Reinspection State
                  LEFT JOIN @ElementData e48 On s.SampleID = e48.SampleID AND e48.ElementTypeID = 48

                  -- Date of Next Review Override
                  LEFT JOIN @ElementData e27 On s.SampleID = e27.SampleID AND e27.ElementTypeID = 27

                  -- Management Option
                  LEFT JOIN @ElementData e22 On s.SampleID = e22.SampleID AND e22.ElementTypeID = 22

                  -- Timescale for Completion
                  LEFT JOIN @ElementData e24 On s.SampleID = e24.SampleID AND e24.ElementTypeID = 24

                  -- Asbestos Type
                  LEFT JOIN @ElementData e8 On s.SampleID = e8.SampleID AND e8.ElementTypeID = 8

                  -- Recommended Action
                  LEFT JOIN @ElementData e20 On s.SampleID = e20.SampleID AND e20.ElementTypeID = 20
                  LEFT JOIN RecommendedActionColour rac WITH (NOLOCK) On e20.ElementIntID = rac.ElementIntValue

                  -- Classification Score
                  LEFT JOIN @ElementData e6 On s.SampleID = e6.SampleID AND e6.ElementTypeID = 6
                  LEFT JOIN SampleClassification sc2 WITH (NOLOCK) On sc2.Score = e6.ElementIntID And sc2.SampleClassificationId Between 1 And 7

                  -- Quantity
                  LEFT JOIN @ElementData e26 On s.SampleId = e26.SampleId AND e26.ElementTypeId = 26
                  LEFT JOIN @ElementData e3 On s.SampleId = e3.SampleId AND  e3.ElementTypeId = 3
                  LEFT JOIN @ElementData e4 On s.SampleId = e4.SampleId AND  e4.ElementTypeId = 4

                  -- Comments
                  LEFT JOIN @ElementData e31 On s.SampleId = e31.SampleId AND e31.ElementTypeId = 31

                  LEFT JOIN @ElementData e7 On e7.SampleID = s.SampleID And e7.ElementTypeID = 7

                  -- Material Assessment Score
                        -- Damage/Detoriation
                        LEFT JOIN @ElementData e9 On s.SampleID = e9.SampleID AND e9.ElementTypeID = 9
                        -- Surface Treatment
                        LEFT JOIN @ElementData e10 On s.SampleID = e10.SampleID AND e10.ElementTypeID = 10

                  -- Priority Assessment Score
                        -- Occupant Activity
                        LEFT JOIN @ElementData e11 On s.SampleID = e11.SampleID AND e11.ElementTypeID = 11

                  -- Disturbance Score
                        -- Location Score
                        LEFT JOIN @ElementData e12 On s.SampleID = e12.SampleID AND e12.ElementTypeID = 12
                        -- Vulnerability Score
                        LEFT JOIN @ElementData e13 On s.SampleID = e13.SampleID AND e13.ElementTypeID = 13
                        -- Quantity Score
                        LEFT JOIN @ElementData e14 On s.SampleID = e14.SampleID AND e14.ElementTypeID = 14

                  -- ExposureScore
                        -- No. of Occupants
                        LEFT JOIN @ElementData e15 On s.SampleID = e15.SampleID AND e15.ElementTypeID = 15
                        -- Frequency of Use
                        LEFT JOIN @ElementData e16 On s.SampleID = e16.SampleID AND e16.ElementTypeID = 16
                        -- Average Time Area is in Use
                        LEFT JOIN @ElementData e17 On s.SampleID = e17.SampleID AND e17.ElementTypeID = 17

                  -- MaintenanceScore
                        -- Type of Maintenance
                        LEFT JOIN @ElementData e18 On s.SampleID = e18.SampleID AND e18.ElementTypeID = 18
                        -- Frequency of Maintenance
                        LEFT JOIN @ElementData e19 On s.SampleID = e19.SampleID AND e19.ElementTypeID = 19
      ),
      SamplesComputed2 as
      (
            Select
                  j.JobId,
                  j.SiteId,
                  j.ClientId,
                  SampleId,
                  SampleRef,
                  SourceDescription,
                  Case
                        When SampleResult = 0 Or Removed = 1 Then
                              'No further action required'
                        Else
                              RecommendedAction
                  End as RecommendedAction,
                  Case
                        When AsbestosType = '(0) no asbestos detected' Or Removed = 1 Then
                              '92A0F4'
                        Else
                              RecommendedActionColour
                  End as RecommendedActionColour,
                  Case
                        When SampleResult = 0 Or Removed = 1 Then
                              0-- Doesn't matter as we're not using the Rec. Action Sort Order is not used on the portal.
                        Else
                              RecommendedActionSortOrder
                  End as RecommendedActionSortOrder,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then
                                          -- MA Score
                                          MaterialAssessmentScore + 
                                          SampleResult + 
                                          ClassificationValue
                                    Else
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue
                              End
                  End as MaterialAssessmentScore,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 AND IsMAOnly = 0 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then                                                  
                                          -- PA Score
                                          LocationScore + 
                                          VulnerabilityScore + 
                                          QuantityScore +
                                          NoOfOccupants

                                    When @CompanyName = 'G & L Consultancy Ltd' And @BranchName = 'Northern Ireland' Then
                                          -- PA Score
                                          OccupantActivity +
                                                -- Disturbance Score
                                                Round(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3, 0) +
                                                -- ExposureScore
                                                Round(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3, 0) +
                                                -- MaintenanceScore
                                                Round(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2, 0)
                                    Else
                                          -- PA Score
                                          OccupantActivity +
                                                -- Disturbance Score
                                                Ceiling(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3) +
                                                -- ExposureScore
                                                Ceiling(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3) +
                                                -- MaintenanceScore
                                                Ceiling(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2)
                              End
                  End as PriorityAssessmentScore,
                  Case
                        When SampleResult <> 0 And Not MaterialAssessmentScore Is Null And Not Removed = 1 Then
                              Case
                                    When @CompanyName = 'Environtec' And c.RegisterRowTemplate Is Null Then
                                          -- MA Score
                                          MaterialAssessmentScore + 
                                          SampleResult + 
                                          ClassificationValue +

                                          -- PA Score
                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  LocationScore + 
                                                  VulnerabilityScore + 
                                                  QuantityScore +
                                                  NoOfOccupants
                                              ELSE 0
                                          END

                                    When @CompanyName = 'G & L Consultancy Ltd' And @BranchName = 'Northern Ireland' Then
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue +

                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  -- PA Score
                                                  OccupantActivity +
                                                  -- Disturbance Score
                                                  Round(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3, 0) +
                                                  -- ExposureScore
                                                  Round(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3, 0) +
                                                  -- MaintenanceScore
                                                  Round(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2, 0)
                                              ELSE 0
                                          END
                                    Else        
                                          -- MA Score
                                          MaterialAssessmentScore +
                                          SampleResult +  
                                          ClassificationValue +

                                          -- PA Score
                                          CASE WHEN IsMAOnly = 0
                                              THEN
                                                  OccupantActivity +
                                                  -- Disturbance Score
                                                  Ceiling(Cast(LocationScore + VulnerabilityScore + QuantityScore as float)/3) +
                                                  -- ExposureScore
                                                  Ceiling(Cast(NoOfOccupants + FrequencyOfUse + AverageTimeAreaIsInUse as float)/3) +
                                                  -- MaintenanceScore
                                                  Ceiling(Cast(TypeOfMaintenance + FrequencyOfMaintenance as float)/2)
                                              ELSE 0
                                          END
                              End
                  End as RiskScore,
                  SampleResult,
                  AsbestosType,
                  Classification,
                  ClassificationScore,
                  ClassificationValue,
                  ReviewDate,
                  TimescaleForCompletion,
                  IsMAOnly,
                  Quantity,
                  Comments,
                  Removed
            From
                  SamplesComputed s WITH (NOLOCK)
                  Inner Join Job j WITH (NOLOCK) On @JobID = j.JobId
                  Inner Join Client c WITH (NOLOCK) On j.ClientId = c.ClientId
      )

      -- Run the main SQL to INSERT the data.
      INSERT INTO SampleComputedData (ClientId, SiteId, JobId, SampleId, SourceDescription, PriorityAssessmentScore, MaterialAssessmentScore, SampleResult, AsbestosType, Classification, ClassificationScore, ClassificationScoreValue, ReviewDate, TimescaleForCompletion, RecommendedAction, RecommendedActionColour, RecommendedActionSortOrder, RiskScore, RiskScoreGroupId, RiskScoreGroup, RiskScoreGroupColour, RiskScoreSortOrder, IsMAOnly, Quantity, Comments, Removed, DateCreated)
      Select
            s.ClientId,
            s.SiteId,
            s.JobID,
            s.SampleID,
            s.SourceDescription,

            s.PriorityAssessmentScore,
            s.MaterialAssessmentScore,

            s.SampleResult,
            s.AsbestosType,

            s.Classification,
            s.ClassificationScore,
            s.ClassificationValue,
            s.ReviewDate,
            s.TimescaleForCompletion,
            RecommendedAction,
            RecommendedActionColour,
            RecommendedActionSortOrder,
            s.RiskScore,

            Coalesce(rsbc.RiskScoreGroupId, rsb.RiskScoreGroupId, rsbcMA.RiskScoreGroupId, rsbMA.RiskScoreGroupId) [RiskScoreGroupId],
            Coalesce(rsbc.ScoreGroup, rsb.ScoreGroup, rsbcMA.ScoreGroup, rsbMA.ScoreGroup) [RiskScoreGroup],
            Coalesce(rsbc.Colour, rsb.Colour, rsbcMA.Colour, rsbMA.Colour) [RiskScoreGroupColour],
            Coalesce(rsbc.SortOrder, rsb.SortOrder, rsbcMA.SortOrder, rsbMa.SortOrder) [SortOrder],

            s.IsMAOnly,
            s.Quantity,
            s.Comments,
            s.Removed,
            GETDATE() [DateCreated]
      From
            SamplesComputed2 s

            -- MA & PA with client specific risk.
            LEFT JOIN RiskScore rsc WITH (NOLOCK) On Cast(s.RiskScore as int) = rsc.RiskScore And rsc.ClientId = s.ClientId And s.IsMAOnly = 0
            LEFT JOIN RiskScoreGroup rsbc WITH (NOLOCK) On rsc.RiskScoreGroupId = rsbc.RiskScoreGroupId

            -- MA & PA with default specific risk.
            LEFT JOIN RiskScore rs WITH (NOLOCK) On Cast(s.RiskScore as int) = rs.RiskScore And rs.ClientId Is Null And s.IsMAOnly = 0
            LEFT JOIN RiskScoreGroup rsb WITH (NOLOCK) On rs.RiskScoreGroupId = rsb.RiskScoreGroupId

            -- MA Only with client specific risk.
            LEFT JOIN RiskScoreMAOnly rscMA WITH (NOLOCK) On s.MaterialAssessmentScore = rscMA.MaterialAssessmentScore And rscMA.ClientId = s.ClientId And s.IsMAOnly = 1
            LEFT JOIN RiskScoreGroup rsbcMA WITH (NOLOCK) On rscMA.RiskScoreGroupId = rsbcMA.RiskScoreGroupId

            -- MA Only with default specific risk.
            LEFT JOIN RiskScoreMAOnly rsMA WITH (NOLOCK) On s.MaterialAssessmentScore = rsMA.MaterialAssessmentScore And rsMA.ClientId Is Null And s.IsMAOnly = 1
            LEFT JOIN RiskScoreGroup rsbMA WITH (NOLOCK) On rsMA.RiskScoreGroupId = rsbMA.RiskScoreGroupId
    ORDER BY
        s.SampleID


    SET NOCOUNT OFF;
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE type = 'V' AND name = 'ResultModifications')
BEGIN
    EXEC('CREATE VIEW[dbo].[ResultModifications] AS SELECT 1 GO')
END
GO

ALTER View [dbo].[ResultModifications]
As
Select
    s.RegisterItemNo,
    j.JobID,
    su.SurveyTypeID,
    reg.RegisterID,
    reg.SystemName,
    reg.BuildingDesignation,
    reg.Management,
    reg.PriorityAssessment,
    f.FloorNumber,
    r.Number,
    r.[Description],
    p.PhotoNo,
    s.AsSample,
    s.SampleRef,
    s.SampleID,
    s.SampleClassificationID,
    s.SampleResultID,
	CASE
		WHEN s.SampleTypeID != 1 AND s.SampleResultID IS NOT NULL THEN
			CASE 
				WHEN s.SampleResultID = 1 THEN 'Negative'
				ELSE 'Positive'
			END
		ELSE sr.FullSampleResult
	END [LabResult],
    sce.SampleClassification as LabClassification
From
    Job j WITH (NOLOCK)
    INNER JOIN JobEmployee je WITH (NOLOCK) On j.JobID = je.JobID
    INNER JOIN Floorplan f WITH (NOLOCK)
    INNER JOIN Register reg WITH (NOLOCK) On f.RegisterID = reg.RegisterID
    INNER JOIN Room r WITH (NOLOCK) On f.FloorplanID = r.FloorplanID
    INNER JOIN [Sample] s WITH (NOLOCK) On r.RoomID = s.RoomID
    INNER JOIN Survey su WITH (NOLOCK) On reg.SurveyID = su.SurveyID On je.JobEmployeeID = reg.JobEmployeeID
	LEFT JOIN Photo p WITH (NOLOCK)  On s.PhotoID = p.PhotoID
    LEFT JOIN SampleResult sr WITH (NOLOCK) On sr.SampleResultID = s.SampleResultID    
	LEFT JOIN SampleClassificationExtended sce WITH (NOLOCK) ON s.SampleClassificationExtendedID = sce.SampleClassificationExtendedID
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_ProjectJobSheetv2') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_ProjectJobSheetv2] AS BEGIN SET NOCOUNT ON; END')
END

GO

ALTER PROCEDURE [dbo].[Paged_ProjectJobSheetv2]
	@PerPage INT = 15
	, @CurrentPage INT = 1
	, @ClientID INT = NULL
	, @ProjectGroupID INT = NULL
	, @ProjectID INT = NULL
	, @SiteID INT = NULL
	, @Status VARCHAR(24) = ''
	, @Other VARCHAR(MAX) = ''
	, @Address VARCHAR(200) = ''
	, @PhoneCalls INT = NULL
	, @Letters INT = NULL,
	@NoAccessAttempts INT = NULL
/**********************************************************************
** Overview: Get data for the View Project JobSheet tab - procedurised
**		to improve performance over previous code + add paging capability
**
** PLEASE NOTE: The Change Log has now been removed as this has been added to SQL SVN instead.
** Please use the latest version from SVN before making changes. Commit the changes when done.
**********************************************************************/
AS
SET ANSI_WARNINGS OFF
BEGIN
    SET NOCOUNT ON;
    
	-- tidy input variables
	SELECT @ClientID = NULLIF(@ClientID, 0)
	SELECT @ProjectGroupID = NULLIF(@ProjectGroupID, 0)
	SELECT @ProjectID = NULLIF(@ProjectID, 0)
	SELECT @SiteID = NULLIF(@SiteID, 0)
	SELECT @Status = NULLIF(@Status, '')
	SELECT @Other = NULLIF(@Other, '')
	SELECT @Address = NULLIF(@Address, '')
	SELECT @PhoneCalls = NULLIF(@PhoneCalls, 0)
	SELECT @Letters = NULLIF(@Letters, 0)
	SELECT @NoAccessAttempts = NULLIF(@NoAccessAttempts, 0)

	-- ensure we have at least 1 filter ID (don't want to kill the server!)
	IF (@ClientID IS NULL) AND (@ProjectGroupID IS NULL) AND (@ProjectID IS NULL) AND (@SiteID IS NULL) BEGIN
		RAISERROR('No ID values passed to GetProjectJobSheet', 16, 1)
		RETURN
	END
	
	-- get ProjectIDs into a table to join to, based on @ProjectGroupID AND @ProjectID inputs
	CREATE TABLE #ProjectIDs (ProjectID INT)
	IF @ProjectID IS NOT NULL BEGIN
	
		INSERT
			#ProjectIDs
		SELECT
			@ProjectID
			
	END ELSE BEGIN
		
		INSERT
			#ProjectIDs
		SELECT
			ProjectID
		FROM
			Project
		WHERE
			ProjectGroupId = @ProjectGroupID
	END
	
	-- change #ProjectIDs into a comma separated string of IDs 
	DECLARE @ProjectIDsString VARCHAR(MAX)
	SELECT @ProjectIDsString = STUFF 
	((
		SELECT ',' + CONVERT(VARCHAR(20), ProjectID)
		FROM #ProjectIDs
		FOR XML PATH('')
	), 1, 1, '')

	SELECT * INTO #ProjectJobSheet FROM ProjectJobSheet WHERE ProjectID IN (SELECT ProjectID FROM #ProjectIDs)
	
	-- select from existing ProjectJobSheet view into a temp table
	CREATE TABLE #JobSheetData (
		JobSheetDataID INT IDENTITY (1,1) NOT NULL
		, AppointmentID INT NULL
		, JobId INT NULL
		, SurveyTypeId INT NULL
		, ClientId INT NULL
		, ProjectId INT NULL
		, SiteId INT NULL
		, SurveyCompleted INT NULL
		, SurveyStillDue INT NULL
		, Approved INT NULL
		, SurveyOnTime INT NULL
		, SurveyOverTime INT NULL
		, Unscheduled INT NULL
		, SurveyCompletedRaw NVARCHAR(40) NULL
		, DueDateRaw NVARCHAR(40) NULL
		, ApprovedRaw NVARCHAR(40) NULL
		, SortOrder INT NOT NULL
		, Samples INT NULL
		, SampleResults INT NULL
		, [Status] VARCHAR(24)
		, Other VARCHAR(MAX)
		, [Address] VARCHAR(200)
		, PhoneCalls INT NULL
		, Letters INT NULL
		, NoAccessAttempts INT NULL
		, StatusFilterTypeID INT NULL
		, StatusFilterType VARCHAR(MAX) NULL
	)
	
	/**************************************************************************************************************************************
	-- NOTE - We are using dynamic SQL because the WHERE filters are still evaluated even if the parameter to be filtered on IS NULL, which
	--   causes a hit on performance.  NOT ideal, but performance is more important than tidy code here!
	**************************************************************************************************************************************/
	DECLARE @DynamicSQL NVARCHAR(MAX)
	SELECT @DynamicSQL = 'INSERT
		#JobSheetData
	SELECT
		pjs.AppointmentID
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, CASE WHEN NOT SurveyCompleted IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyCompleted
		, CASE WHEN pjs.[Status] = ''Unscheduled'' OR SortOrder = 3 THEN 0 ELSE 1 END AS SurveyStillDue
		, CASE WHEN NOT Approved IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END AS Approved
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) <= 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOnTime
		, CASE WHEN DATEDIFF(dd, DueDate, SurveyCompleted) > 0 AND SortOrder <> 3 THEN 1 ELSE 0 END AS SurveyOverTime
		, CASE WHEN pjs.[Status] = ''Unscheduled'' AND SortOrder <> 3 THEN 1 ELSE 0 END AS Unscheduled
		, SurveyCompleted
		, DueDate
		, Approved
		, SortOrder
		, Samples
		, SampleResults
		, pjs.[Status]
		, pjs.Other
		, pjs.[Address]
		, [PhoneCalls]
		, [Letters]
		, pjs.NoAccessAttempts
		, s.StatusFilterTypeID
		, sft.[Status] As StatusFilterType
	FROM
		#ProjectJobSheet pjs
		LEFT JOIN Site s ON pjs.SiteId = s.SiteID
		LEFT JOIN StatusFilterType sft ON s.StatusFilterTypeID = sft.StatusFilterTypeID
	WHERE
		pjs.ProjectID IN (' + @ProjectIDsString + ') '

	-- add default order by
	SELECT @DynamicSQL = @DynamicSQL + ' ORDER BY SortOrder, JobNo, Address'

	-- execute the SQL
	EXECUTE sp_executesql @DynamicSQL
	
	-- ClientID filter (not applied to view above as extra view filters slow performance)
	IF @ClientID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE ClientID <> @ClientID
	END
	
	-- SiteID filter (not applied to view above as extra view filters slow performance)
	IF @SiteID IS NOT NULL BEGIN
		DELETE FROM #JobSheetData WHERE SiteID <> @SiteID
	END

	-- @PhoneCalls filter (not applied to view above as extra view filters slow performance)
	IF @PhoneCalls IS NOT NULL BEGIN
		
		IF @PhoneCalls > 3 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls < 4
		END

		IF @PhoneCalls < 4 BEGIN
			DELETE FROM #JobSheetData WHERE PhoneCalls <> @PhoneCalls
		END
	END

	-- @Letters filter (not applied to view above as extra view filters slow performance)
	IF @Letters IS NOT NULL BEGIN

		IF @Letters > 3 BEGIN
			DELETE FROM #JobSheetData WHERE Letters < 4
		END

		IF @Letters < 4 BEGIN
			DELETE FROM #JobSheetData WHERE Letters <> @Letters
		END
	END
	
	-- @NoAccessAttempts filter (not applied to view above as extra view filters slow performance)
	IF @NoAccessAttempts IS NOT NULL BEGIN

		IF @NoAccessAttempts > 3 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts < 4
		END

		IF @NoAccessAttempts < 4 BEGIN
			DELETE FROM #JobSheetData WHERE NoAccessAttempts <> @NoAccessAttempts
		END
	END

	-- calculate useful totals
    DECLARE @SurveysCompleted INT
    DECLARE @SurveysStillDue INT
    DECLARE @Approved INT
    DECLARE @SurveysOnTime INT
    DECLARE @SurveysOverTime INT
    DECLARE @UnScheduled INT
    DECLARE @KPI DECIMAL(12,2)
    DECLARE @TotalJobs_HasSampleResults INT
    DECLARE @Approved_HasSampleResults INT
    DECLARE @TotalRows INT
    
	SELECT
		@SurveysCompleted = ISNULL(SUM(SurveyCompleted), 0)
		, @SurveysStillDue = ISNULL(SUM(SurveyStillDue), 0) - ISNULL(SUM(SurveyCompleted), 0)
		, @Approved = ISNULL(SUM(Approved), 0)
		, @SurveysOnTime = ISNULL(SUM(SurveyOnTime), 0)
		, @SurveysOverTime = ISNULL(SUM(SurveyOverTime), 0)
		, @UnScheduled = ISNULL(SUM(UnScheduled), 0)
		, @KPI = ISNULL(CASE WHEN COUNT(SurveyCompletedRaw) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN DueDateRaw > SurveyCompletedRaw AND SortOrder <> 3 THEN 1 ELSE 0 END)
					/ CONVERT(FLOAT,COUNT(SurveyCompletedRaw)), 3) * 100 END, 0)
		, @TotalRows = COUNT(1)
	FROM 
		#JobSheetData
		
	SELECT
		@TotalJobs_HasSampleResults = ISNULL(SUM(CASE WHEN [Status] = 'Unscheduled' OR SortOrder = 3 THEN 0 ELSE 1 END), 0) 
		, @Approved_HasSampleResults = ISNULL(SUM(CASE WHEN NOT ApprovedRaw IS NULL AND SortOrder <> 3 THEN 1 ELSE 0 END), 0)
	FROM 
		#JobSheetData
	WHERE
		Samples > 0
		AND Samples = SampleResults
	
	-- return paged raw data to front end
	-- NOTE - @Status, @Other and @Address filters only filter this data, not the count data
	;WITH Paging AS 
    ( 
       SELECT 
           CAST(CEILING(COUNT(*) OVER(PARTITION BY '') * 1.00 / @PerPage) AS INT) AS Pages
           , ((ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) - 1) / @PerPage) + 1 AS Page
           , ROW_NUMBER() OVER(ORDER BY a.JobSheetDataID ASC) AS Row_Num
           , *
       FROM 
       (
			SELECT * FROM #JobSheetData jsd
			WHERE
				( (jsd.[Status] = @Status) OR (jsd.[StatusFilterType] = @Status) OR (@Status IS NULL) )
				AND ( (jsd.Other = @Other) OR (@Other IS NULL) )
				AND ( (jsd.[Address] = @Address) OR (@Address IS NULL) )
	   ) a
    )	
	SELECT  
		main.Pages
		, main.Page
		, main.Row_Num
		, pjs.SortOrder
		, pjs.AppointmentID
		, pjs.[Status]
		, pjs.StatusDate
		, pjs.JobNo
		, pjs.[Address]
		, pjs.Postcode
		, pjs.Contact
		, pjs.Telephone
		, pjs.SiteEmail
		, pjs.JobId
		, pjs.SurveyTypeId
		, pjs.AppointmentDate
		, pjs.DateSiteWorkComplete
		, pjs.AnalysisComplete
		, pjs.TotalJobs
		, pjs.WorkScheduled
		, pjs.SiteWorkComplete
		, pjs.Samples
		, pjs.SampleResults
		, pjs.[FileName]
		, pjs.ClientOrderNo
		, pjs.DateReceived
		, pjs.UPRN
		, pjs.SurveyType
		, pjs.Surveyor
		, pjs.SurveyStart
		, pjs.SurveyCompleted
		, pjs.AnalysisCompleted
		, pjs.Approved
		, pjs.ApprovedBy
		, pjs.DueDate
		, pjs.NoAccessAttempts
		, pjs.PhoneCalls
		, pjs.Letters
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 1
				FOR XML PATH('')
			), 1, 1, '')) AS PhoneCallSiteContactIDs
		, (SELECT STUFF(
			(
				SELECT ',' + CONVERT(VARCHAR(10), sc2.SiteContactID)
				FROM SiteContact sc2
				WHERE sc2.SiteID = pjs.SiteId AND sc2.ProjectID = pjs.ProjectId AND sc2.Datedeleted IS NULL AND sc2.ContactTypeID = 2
				FOR XML PATH('')
			), 1, 1, '')) AS LetterSiteContactIDs
		, pjs.GroupName
		, pjs.ClientId
		, pjs.ProjectId
		, pjs.SiteId
		, pjs.Other
		, pjspa.ProjectAppointmentID
		, pjs.LastNoAccessDate
		, pjs.LastJobEmployeeDate
		, pjs.QuoteId
		, pjs.QuoteDate
		, pjs.InvoiceDate
		, main.StatusFilterTypeID
		, main.StatusFilterType
    FROM 
		Paging main
		INNER JOIN #ProjectJobSheet pjs 
			ON ISNULL(main.AppointmentID, 0) = ISNULL(pjs.AppointmentID, 0)
			AND ISNULL(main.JobID, 0) = ISNULL(pjs.JobID, 0)
			AND ISNULL(main.SurveyTypeID, 0) = ISNULL(pjs.SurveyTypeID, 0)
			AND ISNULL(main.ClientID, 0) = ISNULL(pjs.ClientID, 0)
			AND ISNULL(main.ProjectID, 0) = ISNULL(pjs.ProjectID, 0)
			AND ISNULL(main.SiteID, 0) = ISNULL(pjs.SiteID, 0)
		LEFT JOIN Appointment pjspa ON pjs.AppointmentID = pjspa.AppointmentID
    WHERE 
		main.Row_Num BETWEEN (@CurrentPage - 1) * @PerPage + 1 AND @CurrentPage * @PerPage
	ORDER BY
		main.Row_Num
	
	-- drop temp tables
	DROP TABLE #ProjectIDs
	DROP TABLE #JobSheetData
	
	-- return useful counts to front end
	SELECT
		@SurveysStillDue AS WorkScheduled
		, @SurveysStillDue AS SurveysStillDue
		, @Approved AS Approved
		, @SurveysOnTime AS SurveysOnTime
		, @SurveysOverTime AS SurveysOverTime
		, @UnScheduled AS UnScheduled
		, @KPI AS KPI
		, @TotalJobs_HasSampleResults - @Approved_HasSampleResults AS SampleAnalysisComplete
		--, @SurveysCompleted - @TotalJobs_HasSampleResults - @Approved AS SiteWorkComplete
		, @TotalRows - @UnScheduled - @SurveysStillDue - @TotalJobs_HasSampleResults + @Approved_HasSampleResults - @Approved AS SiteWorkComplete
    
    
    SET NOCOUNT OFF;
END
GO

Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select 466,'Quote - Legionella Tap Descale',(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%Report -%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=466)=0
Insert into QuoteType (QuoteTypeID,TemplateTypeID,QuoteType,InvoiceQuoteType,Deleted,AppointmentTypeId,QuoteVisitTypeID) Select 300,466,'Tap Descale','Tap Descale',GETDATE(),9,4 WHERE (SELECT COUNT(*) FROM QuoteType WHERE QuoteTypeID=300)=0
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select 467,'Report -  Legionella Tap Descale',(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%Report -%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=467)=0
Insert into LegionellaType (LegionellaTypeID,Description,TemplateTypeID,LegionellaFrequencyCategoryID,LegionellaAssetCategoryID,LegionellaMonitoring,Deleted) Select 33,'Tap Descale',467,NULL,NULL,1,GETDATE() WHERE (SELECT COUNT(*) FROM LegionellaType WHERE LegionellaTypeID=33)=0
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select 468,'Quote -  HSMS renewal',(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%Quote -%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=468)=0
Insert into QuoteType (QuoteTypeID,TemplateTypeID,QuoteType,InvoiceQuoteType,Deleted,AppointmentTypeId,QuoteVisitTypeID) Select 301,468,'HSMS renewal','HSMS renewal',GETDATE(),5,10 WHERE (SELECT COUNT(*) FROM QuoteType WHERE QuoteTypeID=301)=0
Insert into TemplateType (TemplateTypeID,TemplateType,ReportFooterID,Deleted) Select 470,'Quote -  HSMS standard',(Select top 1 reportFooter.ReportFooterID FROM (Select ReportFooterID,COUNT(*) [Ordering] FROM TemplateType Where TemplateType LIKE '%Quote -%' GROUP BY ReportFooterID) reportFooter Order by reportFooter.Ordering DESC),GETDATE() WHERE (SELECT COUNT(*) FROM TemplateType WHERE TemplateTypeID=470)=0
Insert into QuoteType (QuoteTypeID,TemplateTypeID,QuoteType,InvoiceQuoteType,Deleted,AppointmentTypeId,QuoteVisitTypeID) Select 302,470,'HSMS standard','HSMS standard',GETDATE(),5,10 WHERE (SELECT COUNT(*) FROM QuoteType WHERE QuoteTypeID=302)=0


GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'GUID_CreateGUID_ByJob_AllTypes') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[GUID_CreateGUID_ByJob_AllTypes]  AS BEGIN SET NOCOUNT ON; END')
END

GO
/*
	JRH 9/10/2020 Fork of GUID_CreateGUID_ByJob to be used by the reports.asp in classic teams code
	Run at the end of the process to make sure all the guids are populated 
	Original does inner join to floorplans and not all reports will have them	
*/
ALTER PROCEDURE [dbo].[GUID_CreateGUID_ByJob_AllTypes] 
      @JobID INT,
	  @DisablePopulateProcedures INT = 0,
      @Return INT output
AS
BEGIN


      SET NOCOUNT ON;

      /*    #######################################
            Get each register, floorplan, room and sample for a job.
            #######################################    */   
      DECLARE @ClientID INT = (Select ClientID FROM Job Where JobID=@JobID)
      DECLARE @SiteID INT =   (Select SiteID FROM Job Where JobID=@JobID)
            
      DECLARE @JobSummary TABLE 
                  (
                        JobID INT,RegisterID INT, RegisterGUID VARCHAR(MAX),RegisterCreated DATETIME,
                        FloorplanID INT, FloorplanGUID VARCHAR(MAX),FloorplanCreated DATETIME,
                        RoomID INT, RoomGUID VARCHAR(MAX),RoomCreated DATETIME,
                        SampleID INT, SampleGUID VARCHAR(MAX),SampleCreated DATETIME
                  )
      
      ;with cte_IDList (JobID,RegisterID,FloorplanID,RoomID,SampleID)
      as
      (
            SELECT 
                  j.JobID,r.RegisterID,fp.FloorplanID,rm.RoomID,s.SampleID
            FROM Job j
                  INNER JOIN JobEmployee je ON je.JobID = j.JobID
                  INNER JOIN Register r ON r.JobEmployeeID = je.JobEmployeeID
                  --INNER JOIN Survey su ON su.SurveyID = r.SurveyID
                  LEFT OUTER JOIN Floorplan fp ON fp.RegisterID = r.RegisterID
                  INNER JOIN Room rm ON r.RegisterID = rm.RegisterID
                  INNER JOIN Sample s ON s.RoomID = rm.RoomID
            WHERE j.JobID = @JobID 
			--AND (r.GUID IS NULL OR fp.GUID IS NULL OR rm.GUID IS NULL OR s.GUID IS NULL)
      )
      
      Insert into @JobSummary (RegisterID,FloorplanID,RoomID,SampleID) Select ids.RegisterID,ids.FloorplanID,ids.RoomID,ids.SampleID FROM cte_IDList ids
      
	  /*    #######################################
            Creating a UNIQUE GUID based on time and ID of the table level - not possible to get duplicate without a manual update, so no need to test.
            #######################################    */
      
      --    REGISTER GUIDS#########################
	  Update @JobSummary 
		Set 
			RegisterGUID
				=
			'SCMG-' + CAST(r.RegisterID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Register'
            CROSS JOIN Config c
      --    END REGISTER GUIDS#########################
      
      --    FLOORPLAN GUIDS#########################
      Update @JobSummary 
		Set 
			FloorplanGUID
				=
			'SCMG-' + CAST(fp.FloorplanID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Floorplan fp WITH (NOLOCK) ON fp.FloorplanID=js.FloorplanID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Floorplan'
            CROSS JOIN Config c
      --    END FLOORPLAN GUIDS#########################
      
      --    ROOM GUIDS#########################
	  Update @JobSummary 
		Set 
			RoomGUID
				=
			'SCMG-' + CAST(rm.RoomID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Room rm WITH (NOLOCK) ON rm.RoomID=js.RoomID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Room'
            CROSS JOIN Config c
	  --    END ROOM GUIDS#########################
      
      --    SAMPLE GUIDS#########################
	  Update @JobSummary 
		Set 
			SampleGUID
				=
			'SCMG-' + CAST(s.SampleID as varchar) + '-' +
                        c.s__ServerCode + '-' + 
                        r.SystemName + '-' +
                        tc.TableCode + '-' + 
                        dbo.FormatGUIDDateTime(GETDATE())
      FROM 
			@JobSummary js
			INNER JOIN Register r WITH (NOLOCK) ON r.RegisterID=js.RegisterID
			INNER JOIN Sample s WITH (NOLOCK) ON s.SampleID=js.SampleID
			INNER JOIN TableCode tc WITH (NOLOCK) ON TableName = 'Sample'
            CROSS JOIN Config c
      --    END SAMPLE GUIDS#########################
      
      /*    #######################################
            Update each record updating the GUID with a where clause to make sure the GUID does not exist, keeping a track of the total number of updated rows. This needs to match the record count of those that need updating.
            #######################################    */   
      
      DECLARE @registerUpdated INT = (Select COUNT(DISTINCT RegisterID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @floorplanUpdated INT = (Select COUNT(DISTINCT FloorplanID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @roomUpdated INT = (Select COUNT(DISTINCT RoomID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @sampleUpdated INT = (Select COUNT(DISTINCT SampleID) FROM @JobSummary) --SELECT @RowsUpdated = @RowsUpdated+@@ROWCOUNT
      DECLARE @UpdatesComplete BIT = 1
      
      IF (Select COUNT(*) FROM @JobSummary)=0 BEGIN 
            Set @Return = 2 
            Set @UpdatesComplete = 0
      END
      
      IF @UpdatesComplete = 1
      BEGIN
            BEGIN TRANSACTION
                  
                  --#### UPDATE ACTUAL TABLE RECORDS ####         
                  UPDATE Register Set GUIDVersion=1,GUID=u.Guid FROM Register INNER JOIN (Select RegisterID,RegisterGUID [Guid] FROM @JobSummary Where RegisterGUID IS NOT NULL GROUP BY RegisterID,RegisterGUID) u ON u.RegisterID=Register.RegisterID
                  IF @@ROWCOUNT <> @registerUpdated BEGIN Set @UpdatesComplete = 5 END
                  
                  UPDATE Floorplan Set GUIDVersion=1,GUID=u.Guid FROM Floorplan INNER JOIN (Select FloorplanID,FloorplanGUID [Guid] FROM @JobSummary Where FloorplanGUID IS NOT NULL GROUP BY FloorplanID,FloorplanGUID) u ON u.FloorplanID=Floorplan.FloorplanID
                  IF @@ROWCOUNT <> @floorplanUpdated BEGIN Set @UpdatesComplete = 6 END
                  
                  UPDATE Room Set GUIDVersion=1,GUID=u.Guid FROM Room INNER JOIN (Select RoomID,RoomGUID [Guid] FROM @JobSummary Where RoomGUID IS NOT NULL GROUP BY RoomID,RoomGUID) u ON u.RoomID=Room.RoomID
                  IF @@ROWCOUNT <> @roomUpdated BEGIN Set @UpdatesComplete = 7 END
                  
                  UPDATE Sample Set GUIDVersion=1,GUID=u.Guid FROM Sample INNER JOIN (Select SampleID,SampleGUID [Guid] FROM @JobSummary Where SampleGUID IS NOT NULL GROUP BY SampleID,SampleGUID) u ON u.SampleID=Sample.SampleID
                  IF @@ROWCOUNT <> @sampleUpdated BEGIN Set @UpdatesComplete = 8 END
            
            IF @UpdatesComplete = 1
                  BEGIN
                        COMMIT TRANSACTION
                        IF (Select COUNT(*) FROM Job Where Approved IS NOT NULL AND JobID=@JobID) > 0 AND @DisablePopulateProcedures = 0 BEGIN
                              Exec PopulateGuidSamples @ClientId, @SiteId 
                              Exec CreateSiteSampleResultsOverviewSorting @ClientId, @SiteId
                        END
                        Set @Return = 1
                  END
            ELSE
                  BEGIN
                        ROLLBACK TRANSACTION
                        Set @Return = 0
            END
      END
  
      RETURN @Return
      
      SET NOCOUNT OFF;

END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='TestExternalIndividual') AND name='LegionellaID') < 1
BEGIN
  ALTER TABLE TestExternalIndividual
      ADD LegionellaID INT NULL
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_QuoteHistory') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_QuoteHistory] AS BEGIN SET NOCOUNT ON; END')
END
GO


-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Moving 'QuoteHistory' from a view to a stored procedure to increase speed.
-- In addition the the normal re-factoring, this requires a page number and number of items per page
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */


ALTER PROCEDURE [dbo].[Paged_QuoteHistory]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filters
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@QuoteID INT = 0,
	@EnquiryID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@QuoteHistoryFilterAssignedTo INT = 0,
	@QuoteHistoryFilterQuoteType INT = 0,
	@QuoteHistoryFilterHideInstaquote INT = 0,
	@QuoteHistoryFilterQuoteEnquiry VARCHAR(10) = '',
	@QuoteHistoryFilterCreatedBy int = 0,
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL
	
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))

	  DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	  INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	  SELECT
			c.ClientID,
			Access.EmployeeRestrictedClientAccessID
	  FROM
			Client c
			OUTER APPLY
			(
				SELECT
					erca.EmployeeRestrictedClientAccessID
				FROM
					EmployeeRestrictedClientAccess erca
				WHERE
					erca.EmployeeID = @LoggedInEmployeeID
						AND
					erca.ClientID = c.ClientID
			) Access
	  WHERE
			c.Restricted = 1
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @QuoteHistoryViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @QuoteHistoryView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX))
      
	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='Q' 
		OR @QuoteHistoryFilterQuoteEnquiry='Q_AC' OR @QuoteHistoryFilterQuoteEnquiry='Q_RJ'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
		  From
				Quote q 
				Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
				Left Outer Join Job j On q.JobId = j.JobId
				Left Outer Join Client c On c.ClientID = q.ClientID 
				Left Outer Join Project p On p.ProjectID = q.ProjectID 
				Left Outer Join Site s On s.SiteID = q.SiteID
				LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID
		  Where 
				(
					  LEN(@Filter ) = 0
							OR
					  (
							s.Address Like '%' + @Filter + '%'
								  Or 
							s.Postcode Like '%' + @Filter + '%'
								  Or 
							s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
							Or s.UPRN = @Filter
					)
				)
					  And
				(Not Accepted Is Null Or Not Rejected Is Null) 
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_AC' THEN
								CASE WHEN Not q.Accepted Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_RJ' THEN
								CASE WHEN Not q.Rejected Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND					  
				(@ProjectID=0 OR q.ProjectID=@ProjectID)
					  AND
				(@SiteID=0 OR q.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR q.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										q.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterCreatedBy = 0 THEN 1 ELSE CASE WHEN q.EmployeeID = @QuoteHistoryFilterCreatedBy THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterHideInstaquote = 0 THEN 0 ELSE 
											Cast(
												Case When q.ReallyQuickQuote = 1 Then 
													1
												Else 
													0 
												End as bit) 
										END = 0
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
					AND
				q.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      END

	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='E'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select enq.EnquiryId,'E' as ItemType, enq.Created    
		  From
				Enquiries enq
		  Where
				(
					  LEN(@Filter ) = 0
							OR
					  (
							enq.SiteAddress Like '%' + @Filter + '%'
								  Or 
							enq.SitePostcode Like '%' + @Filter + '%'
								  Or 
							enq.SiteAddress + ', ' + enq.SitePostcode Like '%' + @Filter + '%'
							Or enq.SiteUPRN = @Filter
				)
				)
					  And
				(Not enq.Accepted Is Null Or Not enq.Rejected Is Null) 
					  And
				(
					  Not enq.QuoteId Is Null
							Or
					  (
							enq.QuoteId Is Null
								  And
							Not enq.Rejected Is Null
					  )
				)
					  AND
				(@ProjectID=0)
					  AND
				(@SiteID=0 OR enq.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR enq.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN @QuoteID = 0 AND @EnquiryID = enq.EnquiryID THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										enq.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN enq.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterCreatedBy = 0 THEN 1 ELSE CASE WHEN enq.EmployeeID = @QuoteHistoryFilterCreatedBy THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN enq.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
					AND
				enq.ClientId NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      END

	  IF @QuoteHistoryFilterQuoteEnquiry='' OR @QuoteHistoryFilterQuoteEnquiry='Q' 
		OR @QuoteHistoryFilterQuoteEnquiry='Q_AC' OR @QuoteHistoryFilterQuoteEnquiry='Q_RJ'
	  BEGIN

		  Insert into @QuoteHistoryViewID (ItemID,ItemType,Created)
		  Select DISTINCT q.QuoteID as ItemId, 'RQV' as ItemType, q.Created
		  FROM
				Quote q 
				INNER JOIN [dbo].[QuoteEmployee] qe ON qe.[QuoteID] = [q].[QuoteID]
				INNER JOIN [dbo].[QuoteVisit] qv ON qe.[QuoteEmployeeID] = [qv].[QuoteEmployeeID]   
				Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
				INNER JOIN Appointment a ON a.QuoteID=q.QuoteID AND a.DateDeclined IS NOT NULL
				OUTER APPLY 
				(
					  /*count declined appointments and non declineds, if they have */
					  SELECT
							COUNT(*) [ValidAppointments]
					  FROM
							[dbo].[Appointment] _app 
					  WHERE
							_app.[QuoteID] = [q].[QuoteID]
								  AND
							_app.DateDeclined IS NULL
				) currentCount
				Left Outer Join Job j On q.JobId = j.JobId
				Left Outer Join Client c On c.ClientID = q.ClientID 
				Left Outer Join Project p On p.ProjectID = q.ProjectID 
				Left Outer Join Site s On s.SiteID = q.SiteID 
		  Where 
				(
					  LEN(@Filter ) = 0
							OR
					  (
							s.Address Like '%' + @Filter + '%'
								  Or 
							s.Postcode Like '%' + @Filter + '%'
								  Or 
							s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
							Or s.UPRN = @Filter
					  )
				)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_AC' THEN
								CASE WHEN Not q.Accepted Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND
						(
							CASE WHEN @QuoteHistoryFilterQuoteEnquiry = 'Q_RJ' THEN
								CASE WHEN Not q.Rejected Is Null THEN 1 ELSE 0 END
							ELSE
								1
							END = 1 
						)
					AND					
				currentCount.ValidAppointments=0
					  AND
				(@ProjectID=0 OR q.ProjectID=@ProjectID)
					  AND
				(@SiteID=0 OR q.SiteID=@SiteID)
					  AND
				(@ClientID=0 OR q.ClientID=@ClientID)
					  AND
				(
					  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
							CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
					  ELSE
							CASE WHEN
								  (
										q.Created BETWEEN @FilterStartDate AND @FilterEndDate
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @QuoteHistoryFilterAssignedTo THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterCreatedBy = 0 THEN 1 ELSE CASE WHEN q.EmployeeID = @QuoteHistoryFilterCreatedBy THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @QuoteHistoryFilterQuoteType THEN 1 ELSE 0 END END = 1
								  )
										AND
								  (
										CASE WHEN @QuoteHistoryFilterHideInstaquote = 0 THEN 0 ELSE 
											Cast(
												Case When q.ReallyQuickQuote = 1 Then 
													1
												Else 
													0 
												End as bit) 
										END = 0
								  )
							THEN 1 ELSE 0 END
					  END = 1
				)
					AND
				q.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      END
		         
			DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @QuoteHistoryViewID)				 
				    
      ;With Paging As 
    ( 
        Select 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
               Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
			END As Pages, 

			CASE WHEN @PerPage = 0 THEN
				1
			ELSE
               ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
			END As Page, 

               Row_Number() Over(Order By a.Created DESC) as Row_Num, 
               *
               From 
               (
                              Select * FROM @QuoteHistoryViewID
                     ) a
    )
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
			CASE
				WHEN e.QuoteNo IS NOT NULL
				THEN dbo.FormatTeamsReference('Q', e.QuoteNo)
			ELSE
				q.Status
			END [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN COALESCE(e.DiscardReason, q.RejectReason, 'Rejected') ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
			ISNULL(e.EnquirySource,es.Description) [Source],
			ISNULL(e.LeadEmployee, qemp.FullName)	[SourceOrigin],
			CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo],
			q.CurrencyId [CurrencyID],
			Isnull(ecb.FullName,'Not Recorded') CreatedBy			
	From 
            Paging main
            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
			LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
			LEFT OUTER JOIN EnquirySource es ON q.EnquirySourceID = es.EnquirySourceID
			LEFT OUTER JOIN Employee qemp ON q.EnquiryEmployeeID = qemp.EmployeeID
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
			LEFT OUTER JOIN Employee ecb ON ecb.EmployeeID = q.EmployeeID
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END

GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'Paged_OutstandingQuotes') < 1
BEGIN
	EXEC('CREATE PROCEDURE [dbo].[Paged_OutstandingQuotes] AS BEGIN SET NOCOUNT ON; END')
END
GO



-- =============================================
-- Author:        Joe
-- Create date: 03/09/2015
-- Description:   Clone of Paged_QuoteHistory changed to Outstanding to repalce view
-- =============================================

/* NOTE STODD 16/10/2015 - Please ensure this proc and Export_QuoteHistory are synced at all times */

ALTER PROCEDURE [dbo].[Paged_OutstandingQuotes]
	-- Paging
	@PerPage INT = 15,
	@CurrentPage INT = 1,

	-- Standard filter
	@ClientID INT = 0,
	@SiteID INT = 0,
	@ProjectID INT = 0,
	@QuoteID INT = 0,
	@EnquiryID INT = 0,
	@Filter VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
	@OutstandingQuotesFilterAssignedTo INT = 0,
	@OutstandingQuotesFilterCreatedBy INT = 0,
	@OutstandingQuotesFilterQuoteType INT = 0,	
	@OutstandingQuotesHideInstaquote INT = 0,	
	@FilterStartDate DATETIME = NULL,
	@FilterEndDate DATETIME = NULL
AS
BEGIN
      SET NOCOUNT ON;

      Set @FilterStartDate = ISNULL(@FilterStartDate,DATEADD(year,-1,GETDATE()))
      Set @FilterEndDate = ISNULL(@FilterEndDate,DATEADD(month,3,GETDATE()))

	  DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	  INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	  SELECT
			c.ClientID,
			Access.EmployeeRestrictedClientAccessID
	  FROM
			Client c
			OUTER APPLY
			(
				SELECT
					erca.EmployeeRestrictedClientAccessID
				FROM
					EmployeeRestrictedClientAccess erca
				WHERE
					erca.EmployeeID = @LoggedInEmployeeID
						AND
					erca.ClientID = c.ClientID
			) Access
	  WHERE
			c.Restricted = 1
      
      DECLARE @FilterSites TABLE (SiteID INT)
      
      DECLARE @OutstandingQuotesViewID TABLE (ItemID INT, ItemType VARCHAR(3), Created DATETIME)

      DECLARE @OutstandingQuotesView TABLE (ItemId INT,Itemtype VARCHAR(3),ItemNo INT, QuoteTypeID INT,QuoteType VARCHAR(MAX),Value MONEY,Created DATETIME, [Status] VARCHAR(MAX),LastNoteCreated VARCHAR(MAX),ClientId INT,ProjectID INT,SiteID INT, [Site] VARCHAR(MAX), [Address] VARCHAR(MAX), Postcode VARCHAR(MAX),Accepted DATETIME, Rejected DATETIME,IsInstaQuote BIT,AssignedEmployeeID INT, StatusText VARCHAR(MAX), isNew INT, DateActioned DATETIME, HasPDF INT, [File] varchar(MAX), CreatedBy varchar(50))
      
  	  Insert into @OutstandingQuotesViewID (ItemID,ItemType,Created)
	  Select  q.QuoteID as ItemId, 'Q' as ItemType, q.Created
	  From
			Quote q 
			Inner Join QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
			Left Outer Join Job j On q.JobId = j.JobId
			Left Outer Join Client c On c.ClientID = q.ClientID 
			Left Outer Join Project p On p.ProjectID = q.ProjectID 
			Left Outer Join Site s On s.SiteID = q.SiteID
			LEFT OUTER JOIN @FilterSites fs ON s.SiteID=fs.SiteID			
			OUTER APPLY
			(
				SELECT CASE when
				EXISTS 
				( 
		        
					SELECT 
						'x'
					FROM
						[dbo].[Appointment] [a]
						INNER JOIN [dbo].[AppointmentType] [at] ON [at].[AppointmentTypeId] = [a].[AppointmentTypeID]
					WHERE
						[a].[QuoteID] = [q].[QuoteID]     
							AND
						[a].[AppointmentTypeID] = 8
				)
				THEN 
					1
				ELSE 
					0
				END 
			)isQuoteVisitApointment(val)
	  Where 
			(
				  LEN(@Filter ) = 0
						OR
				  (
						s.Address Like '%' + @Filter + '%'
							  Or 
						s.Postcode Like '%' + @Filter + '%'
							  Or 
						s.Address + ', ' + s.Postcode Like '%' + @Filter + '%'
						Or s.UPRN = @Filter
				)
			)
				  AND
			(
				CASE WHEN qt.QuoteVisitTypeID IS NOT NULL AND [isQuoteVisitApointment].[val] = 1 THEN
					(Select COUNT(*) FROM QuoteVisit qv INNER JOIN QuoteEmployee qe ON qv.QuoteEmployeeID=qe.QuoteEmployeeID Where qe.QuoteID=q.QuoteID AND qe.EmployeeID>0)
				ELSE
					1
				END = 1
			)
				And
			(Accepted Is Null) 
				AND
			(Rejected IS NULL)
				AND					  
			(@ProjectID=0 OR q.ProjectID=@ProjectID)
				  AND
			(@SiteID=0 OR q.SiteID=@SiteID)
				  AND
			(@ClientID=0 OR q.ClientID=@ClientID)
				  AND
			(
				  CASE WHEN @QuoteID > 0 OR @EnquiryID > 0 THEN
						CASE WHEN q.QuoteID = @QuoteID AND @EnquiryID = 0 THEN 1 ELSE 0 END
				  ELSE
						CASE WHEN
							  (
									q.Created BETWEEN @FilterStartDate AND @FilterEndDate
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterAssignedTo = 0 THEN 1 ELSE CASE WHEN q.AssignedEmployeeID = @OutstandingQuotesFilterAssignedTo THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesFilterCreatedBy = 0 THEN 1 ELSE CASE WHEN q.EmployeeID = @OutstandingQuotesFilterCreatedBy THEN 1 ELSE 0 END END = 1
							  )
									AND
									
							  (
									CASE WHEN @OutstandingQuotesFilterQuoteType = 0 THEN 1 ELSE CASE WHEN q.QuoteTypeID = @OutstandingQuotesFilterQuoteType THEN 1 ELSE 0 END END = 1
							  )
									AND
							  (
									CASE WHEN @OutstandingQuotesHideInstaquote = 0 THEN 0 ELSE 
										Cast(
											Case When q.ReallyQuickQuote = 1 Then 
												1
											Else 
												0 
											End as bit) 
									END = 0
							  )
						THEN 1 ELSE 0 END
				  END = 1
			)
				AND
			q.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
      
	  DECLARE @TotalRowNumber INT = (Select COUNT(*) [Number] FROM @OutstandingQuotesViewID)
		            
      ;With Paging As 
		( 
			Select 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
				END As Pages, 

				CASE WHEN @PerPage = 0 THEN
					1
				ELSE
				   ((Row_Number() Over(Order By a.Created DESC)-1) / @PerPage)+1
				END As Page, 

				   Row_Number() Over(Order By a.Created DESC) as Row_Num, 
				   *
				   From 
				   (
						Select * FROM @OutstandingQuotesViewID
				   ) a
		)
	
    Select  
			@TotalRowNumber [Row_Total],
            main.Pages,
            main.Page,
            main.Row_Num,
            main.ItemId,
            main.Itemtype,
            ISNULL(e.EnquiryNo,q.QuoteNo) [ItemNo], 
            ISNULL(e.QuoteTypeID,q.QuoteTypeID) [QuoteTypeID],
            ISNULL(e.QuoteType,qt.QuoteType) [QuoteType], 
            q.Value [Value], 
            main.Created [Created], 
            ISNULL('Q' + Right('00000'+ Cast(e.QuoteNo as varchar), Case When Len(e.QuoteNo)<=6 Then 6 Else Len(e.QuoteNo) End),q.Status) [Status], 
            ISNULL(e.LastNoteCreated,q.LastNoteCreated) [LastNoteCreated], 
            ISNULL(e.ClientId,q.ClientID) [ClientId], 
            IsNull(e.Client + Case When Len(e.ClientBranchName) > 0 Then ' (' + e.ClientBranchName + ')' Else '' End,c.Client + Case When Len(c.BranchName) > 0 Then ' (' + c.BranchName + ')' Else '' End) [Client],
            q.ProjectID [ProjectID], 
            p.Project + ' / ' + ISNULL([p].[GroupName],'') [Project], 
            ISNULL(e.SiteId,q.SiteID) [SiteID], 
            ISNULL(e.SiteAddress,s.Address) [Site], 
            ISNULL(e.SiteAddress,s.Address) [Address], 
            ISNULL(e.SitePostcode,s.Postcode) [Postcode], 
            ISNULL(e.SiteUPRN,s.UPRN) [UPRN], 
            ISNULL(e.Accepted,q.Accepted) [Accepted], 
            ISNULL(e.Rejected,q.Rejected) [Rejected], 
            Cast(Case When ABS(DateDiff(day, j.Created, q.Created)) = 0 Then Case When ABS(DateDiff(s, j.Created, q.Created)) <= 10 Then 1 Else 0 End ELSE 0 END as bit) [IsInstaQuote], --the deault is 0 i.e. for enquiries
            ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID) [AssignedEmployeeID], 
            CASE main.ItemType WHEN 'RTQ' Then 'Discarded' ELSE CASE WHEN IsNull(e.Rejected,q.Rejected) IS NOT NULL THEN 'Rejected' ELSE 'Accepted' END END [StatusText], 
            ISNULL(CASE WHEN IsNull(e.Created,q.Created) > DATEADD(hh,-1,GetDate()) THEN 1 END,0) [isNew], 
            ISNULL(q.Rejected,CASE WHEN IsNull(e.Accepted,q.Accepted) IS NOT NULL THEN IsNull(e.Accepted,q.Accepted) ELSE IsNull(e.Rejected,q.Rejected) END) [DateActioned], 
            CAST(CASE WHEN main.ItemType = 'Q' THEN CASE WHEN PDFId is not null then 1 ELSE 0 END END as BIT) [HasPDF], 
            CASE WHEN main.ItemType = 'Q' THEN pdf.FileName END [File],
            q.JobID,
            q.ReminderDate [ReminderDate],
            CONVERT(BIT, CASE WHEN qt.MethodStatement_TemplateTypeID IS NOT NULL THEN 1 ELSE 0 END) [UseMethodStatement],
            CAST(ISNULL(s.SiteID,bQuoteHasSite.[Count]) as BIT) [bQuoteHasSite],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN 1 ELSE 0 END as BIT) [HasNotes],
            CAST(CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) IS NOT NULL THEN CASE WHEN ISNULL(e.LastNoteCreated,q.LastNoteCreated) > DATEADD(hh,-1,GetDate()) THEN 1 ELSE 0 END ELSE 0 END as BIT) [NotesInLastHour],
			ISNULL(emp.FullName, '') [AssignedTo],
			q.CurrencyId [CurrencyID],
			ISNULL(ecb.FullName,'Not Recorded') as CreatedBy 
    From 
            Paging main

            LEFT OUTER JOIN Enquiries e ON main.ItemID=e.EnquiryID AND main.ItemType='E'
            
            LEFT OUTER JOIN Quote q ON main.ItemID=q.QuoteID AND (main.ItemType='Q' OR main.ItemType='RQV')
            LEFT OUTER JOIN QuoteType qt ON q.QuoteTypeID = qt.QuoteTypeID 
            LEFT OUTER JOIN Job j On q.JobId = j.JobId
            LEFT OUTER JOIN Client c On c.ClientID = q.ClientID 
            LEFT OUTER JOIN Project p On p.ProjectID = q.ProjectID 
            LEFT OUTER JOIN Site s On s.SiteID = q.SiteID
            LEFT OUTER JOIN Employee emp ON emp.EmployeeID=ISNULL(e.AssignedEmployeeId,q.AssignedEmployeeID)
			LEFT OUTER JOIN Employee ecb ON ecb.EmployeeID = q.EmployeeID
            
            OUTER APPLY
            (
                  Select IsNull((Select top 1 Value FROM QuoteValueHistory qvh Where qvh.QuoteID=q.QuoteID AND ((Accepted IS NOT NULL AND q.Accepted IS NOT NULL) OR (Rejected IS NOT NULL AND q.Rejected IS NOT NULL)) Order by CASE WHEN Accepted IS NOT NULL THEN Accepted ELSE Rejected END DESC),q.VALUE) [QuoteHistoryValue]
            ) qHistory
            OUTER APPLY
            (
                  SELECT TOP 1 [Pdf].[PDFId],[Pdf].[FileName] from Pdf where Pdf.QuoteID = q.QuoteID  and pdf.DateDeleted IS null AND [FileName] Not  Like '%ra%'  order BY [Pdf].[DateCreated] DESC    
            )pdf(PDFId,filename)
            OUTER APPLY
            (
				Select COUNT(*) [Count] FROM ProjectSite Where ProjectID=p.ProjectID
            ) bQuoteHasSite
	Where 
            (main.Row_Num Between (@CurrentPage - 1) * @PerPage + 1 And @CurrentPage * @PerPage) OR (@PerPage=0 AND @CurrentPage=0)
    Order by
            main.Row_Num
      
    SET NOCOUNT OFF;
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='StandardProcedure') AND name='DownloadToSurveyingApp') < 1
BEGIN
  ALTER TABLE StandardProcedure
      ADD DownloadToSurveyingApp BIT NOT NULL DEFAULT(1)
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='StandardProcedure') AND name='DownloadToAirApp') < 1
BEGIN
  ALTER TABLE StandardProcedure
      ADD DownloadToAirApp BIT NOT NULL DEFAULT(1)
END
GO

IF (Select COUNT(*) FROM sys.[all_columns] Where object_id IN (Select object_id FROM sys.tables Where name='StandardProcedure') AND name='DownloadToLegionellaApp') < 1
BEGIN
  ALTER TABLE StandardProcedure
      ADD DownloadToLegionellaApp BIT NOT NULL DEFAULT(1)
END
GO

IF (SELECT COUNT(*) FROM sys.objects WHERE type = 'P' AND name = 'TEAMS_LegionellaWorkInProgressGrid') < 1 BEGIN
	EXEC('CREATE PROCEDURE [dbo].[TEAMS_LegionellaWorkInProgressGrid] AS BEGIN SET NOCOUNT ON; END')
END
GO

ALTER PROCEDURE [dbo].[TEAMS_LegionellaWorkInProgressGrid]
	-- Paging
    @PerPage INT = 30,
    @CurrentPage INT = 1,

	-- Standard filters
    @ClientID INT = 0,
    @SiteID INT = 0,
    @ProjectID INT = 0,
	@Filter VARCHAR(MAX) = '', -- Text entered in search box (part of address, postcode etc.)
	@JobID INT = 0,
	@JobNo VARCHAR(MAX) = '',
	@LoggedInEmployeeID INT = 0,

	-- User selected filters
    @FilterFromDate DATETIME = NULL,
    @FilterToDate DATETIME = NULL,
    @EmployeeId INT = 0,
	@WorkTypeId INT = 0,
	@BranchId INT = 0, -- (0 = all)
	@Accessibility INT = 0,-- (0=all, 1=accessible, 2=not accessible)
	@OrgStateId INT = NULL, -- (NULL=all), 0 = Queued
	@ExcludeClientId INT = 0 -- (0=don't exclude any)
AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	Set @FilterFromDate = ISNULL(@FilterFromDate, DATEADD(year, -1, GETDATE())) -- 1 year ago
    Set @FilterToDate = ISNULL(@FilterToDate, DATEADD(month, 3, GETDATE())) -- 3 months time

	DECLARE @RestrictedClientIDs TABLE (IndexID INT IDENTITY(1,1), ClientID INT, EmployeeRestrictedClientAccessID INT)
	INSERT INTO @RestrictedClientIDs (ClientID, EmployeeRestrictedClientAccessID)
	SELECT
		c.ClientID,
		Access.EmployeeRestrictedClientAccessID
	FROM
		Client c
		OUTER APPLY
		(
			SELECT
				*
			FROM
				EmployeeRestrictedClientAccess erca
			WHERE
				erca.EmployeeID = @LoggedInEmployeeID
					AND
				erca.ClientID = c.ClientID
		) Access
	WHERE
		c.Restricted = 1

	-- Get all of the required data from dgLegionellaNew and dgLegionellaWip in to one table so that we can apply our filters later on in one go instead of seperately on each view
	--DECLARE @LegionellaWIPView TABLE (IndexID INT IDENTITY(1,1), RowNo INT, JobID INT, TypeID INT, Type VARCHAR(MAX), JobNo VARCHAR(10), Start DATETIME, Finish DATETIME, MonitoringSchedule DATETIME, Due DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, Site VARCHAR(MAX), Report BIT, Photos BIT, Plans BIT, Documents BIT, DateApproved DATETIME, HasNotes INT, NotesInLastHour INT, NewGrid INT, Status VARCHAR(MAX), OrgState VARCHAR(MAX), PDF BIT, EmployeeID INT, FullName VARCHAR(MAX), ProjectID INT, LegionellaID INT, NoAccessID INT, naCreated DATETIME, NoAccess BIT)

	--INSERT INTO @LegionellaWIPView
	Select
		ROW_NUMBER() OVER (PARTITION BY j.JobID ORDER BY MAX(l.LegionellaFinish) DESC) [RowNo],
		j.JobID,
		lt.LegionellaTypeID [TypeID],
		lt.Description [Type],
		'J' + RIGHT('000000' + CONVERT(VARCHAR(MAX),j.jobno),6) [JobNo],
		MIN(l.LegionellaStart) [Start],
		MAX(l.LegionellaFinish) [Finish],
		MAX(l.MonitoringSchedule) [MonitoringSchedule],
		MAX(al.DueDate) [Due],
		c.ClientID,
		c.Client + IsNull(' (' + NULLIF(c.BranchName,'') + ')','') [Client],
		s.SiteID,
		s.Address [Site],
		CAST(CASE WHEN leginfo.ReportInformationID IS NULL THEN 0 ELSE 1 END as bit) [Report],
		CAST(CASE WHEN p.PhotoID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Photos],
		CAST(CASE WHEN fp.FloorplanID IS NOT NULL THEN 1 ELSE 0 END as BIT) [Plans],
		CAST(CASE WHEN MIN(lsd.LegionellaSupportingDocumentId) IS NOT NULL THEN 1 ELSE 0 END as BIT) [Documents],
		l.DateApproved,
		0 [HasNotes],
		0 [NotesInLastHour],
		1 [NewGrid],
		j.Status [Status],
		org.State [OrgState],
		CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT) [PDF],
		je.EmployeeID [EmployeeID],
		e.FullName [FullName],
		j.ProjectID,		
		l.legionellaID,
		na.NoAccessID,
		na.Created [naCreated],
		CAST(CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN lt.LegionellaTypeID IS NOT NULL AND l.LegionellaID IS NOT NULL THEN l.LegionellaFinish END,na.Created) THEN 1 ELSE 0 END as BIT) [NoAccess]
	into 
		#LegionellaWIPView
	FROM
		Job j WITH (NOLOCK)
		INNER JOIN Client c WITH (NOLOCK) ON j.ClientID=c.ClientID
		INNER JOIN Site s WITH (NOLOCK) ON j.SiteID=s.SiteID
		INNER JOIN Quote q WITH (NOLOCK) ON j.JobID = q.JobID
		INNER JOIN Appointment a WITH (NOLOCK) ON a.QuoteID=q.QuoteID
		INNER JOIN AppointmentLegionella al WITH (NOLOCK) ON al.AppointmentID = a.AppointmentID
		INNER JOIN LegionellaType lt WITH (NOLOCK) ON lt.LegionellaTypeID = al.LegionellaTypeID
		LEFT JOIN JobEmployee je WITH (NOLOCK) ON j.JobID=je.JobID
		LEFT JOIN Employee e WITH (NOLOCK) ON je.EmployeeID = e.EmployeeID
		LEFT JOIN Legionella l WITH (NOLOCK) ON l.JobEmployeeID=je.JobEmployeeID AND l.DateApproved IS NULL
		LEFT JOIN NoAccess na WITH (NOLOCK) ON na.JobID = j.JobID
		OUTER APPLY
		(
			SELECT TOP 1
				l.ReportInformationID
			FROM
				Job _j
				INNER JOIN JobEmployee je ON j.JobID = je.JobID
				INNER JOIN Legionella l ON je.JobEmployeeID = l.JobEmployeeID
			WHERE
				_j.JobID = j.JobId
			ORDER BY
				l.ReportInformationID
		) legInfo
		LEFT OUTER JOIN Floorplan fp WITH (NOLOCK) ON fp.LegionellaID=l.LegionellaID AND (fp.AutocadDataContentType IS NOT NULL OR fp.FloorplanDataContentType IS NOT NULL)
		LEFT OUTER JOIN LegionellaSupportingDocument lsd WITH (NOLOCK) ON lsd.LegionellaID=l.LegionellaID
		LEFT OUTER JOIN Photo p WITH (NOLOCK) ON p.PhotoID=l.PhotoID
		LEFT OUTER JOIN PDF pf WITH (NOLOCK) ON pf.JobId=j.JobID AND pf.DateDeleted IS NULL
		LEFT JOIN OfflineReportGeneration org WITH (NOLOCK) ON org.JobID = j.JobID AND org.Completed IS NULL
	Where
		a.DateDeclined IS NULL
			AND
		j.Approved IS NULL
			AND
		(CASE WHEN @FilterFromDate IS NULL OR @FilterToDate IS NULL THEN 1 ELSE CASE WHEN al.DueDate BETWEEN @FilterFromDate AND @FilterToDate THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobID = 0 THEN 1 ELSE CASE WHEN j.JobID = @JobID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ClientID = 0 THEN 1 ELSE CASE WHEN c.ClientID = @ClientID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @SiteID = 0 THEN 1 ELSE CASE WHEN s.SiteID = @SiteID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ProjectID = 0 THEN 1 ELSE CASE WHEN j.ProjectID = @ProjectID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @JobNo IS NULL OR LTRIM(RTRIM(@JobNo)) = '' THEN 1 ELSE CASE WHEN j.JobNo = @JobNo THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @EmployeeID = 0 THEN 1 ELSE CASE WHEN je.EmployeeID = @EmployeeID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @WorkTypeID = 0 THEN 1 ELSE CASE WHEN lt.LegionellaTypeID = @WorkTypeID THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @BranchId = 0 THEN 1 ELSE CASE WHEN j.BranchOfficeID = @BranchId THEN 1 ELSE 0 END END = 1)
			AND
		(CASE WHEN @ExcludeClientId = 0 THEN 1 ELSE CASE WHEN j.ClientID != @ExcludeClientId THEN 1 ELSE 0 END END = 1)
	GROUP BY
		j.JobID,
		lt.LegionellaTypeID,
		lt.Description,
		j.JobNo,
		c.ClientID,
		c.Client,
		c.BranchName,
		s.SiteID,
		s.Address,
		l.DateApproved,
		j.Status,
		je.EmployeeID,
		e.FullName,
		org.State,
		CAST(CASE WHEN pf.PDFId IS NOT NULL THEN 1 ELSE 0 END as BIT),
		fp.FloorplanID,
		p.PhotoID,
		leginfo.ReportInformationID,
		j.ProjectID,
		l.LegionellaID,
		na.NoAccessID,
		na.Created,
		CAST(CASE WHEN na.NoAccessID IS NOT NULL AND na.Created >= ISNULL(CASE WHEN lt.LegionellaTypeID IS NOT NULL AND l.LegionellaID IS NOT NULL THEN l.LegionellaFinish END,na.Created) THEN 1 ELSE 0 END as BIT)

	--Apply our filters
	--DECLARE @LegionellaWIPTopLevel TABLE (IndexID INT IDENTITY(1,1), JobID INT, TypeID INT, ReportType VARCHAR(MAX), JobNo VARCHAR(10), Start DATETIME, Finish DATETIME, MonitoringSchedule DATETIME, Due DATETIME, ClientID INT, Client VARCHAR(MAX), SiteID INT, Site VARCHAR(MAX), Report BIT, Photos BIT, Plans BIT, Documents BIT, DateApproved DATETIME, HasNotes INT, NotesInLastHour INT, NewGrid INT, Status VARCHAR(MAX), OrgState VARCHAR(MAX), PDF BIT, EmployeeID INT, FullName VARCHAR(MAX), ProjectID INT, BranchOfficeID INT, UPRN VARCHAR(MAX), LegionellaID INT, NoAccessID INT, naCreated DATETIME, NoAccess BIT)
	--select * into #LegionellaWIPTopLevel from @LegionellaWIPTopLevel
	--INSERT INTO #LegionellaWIPTopLevel (JobID, TypeID, ReportType, JobNo, Start, Finish, MonitoringSchedule, Due, ClientID, Client, SiteID, Site, Report, Photos, Plans, Documents, DateApproved, HasNotes, NotesInLastHour, NewGrid, Status, OrgState, PDF, EmployeeID, FullName, ProjectID, BranchOfficeID, UPRN, LegionellaID, NoAccessID, naCreated, NoAccess)	
	SELECT		
		cast(row_number() OVER (PARTITION BY (select null) order by Due asc,Finish desc) as Int) as IndexId,
		lwipv.JobID as JobId,
		lwipv.TypeID,
		lwipv.Type ReportType,
		lwipv.JobNo,
		lwipv.Start,
		lwipv.Finish,
		lwipv.MonitoringSchedule,
		lwipv.Due,
		lwipv.ClientID,
		lwipv.Client,
		lwipv.SiteID,
		--lwipv.Site,
		si.Address + ', ' + si.Postcode [Site],
		lwipv.Report,
		lwipv.Photos,
		lwipv.Plans,
		lwipv.Documents,
		lwipv.DateApproved,
		lwipv.HasNotes,
		lwipv.NotesInLastHour,
		lwipv.NewGrid,
		lwipv.Status,
		lwipv.OrgState,
		lwipv.PDF,
		lwipv.EmployeeID,
		lwipv.FullName,
		lwipv.ProjectID,
		j.BranchOfficeID,
		si.UPRN,
		lwipv.LegionellaID,
		lwipv.NoAccessID,
		lwipv.naCreated,
		lwipv.NoAccess		
	into 
		#LegionellaWIPTopLevel
	FROM
		#LegionellaWIPView lwipv
		INNER JOIN Job j ON lwipv.JobID = j.JobID
		INNER JOIN Site si ON lwipv.SiteID = si.SiteID
		LEFT JOIN orgInstruction o ON lwipv.JobID = o.JobID
	WHERE
		lwipv.RowNo = 1
			AND		
		(
			CASE
				WHEN LEN(@Filter ) = 0 
				THEN 1 
				ELSE 
					CASE 
						WHEN
						(
							lwipv.Site Like '%' + @Filter + '%'
						) 
						THEN 1 
						ELSE 0 
					END
			END = 1
		)
			AND
		(
			CASE WHEN @Accessibility = 0 THEN
				CASE WHEN lwipv.TypeID IS NOT NULL AND lwipv.LegionellaID IS NOT NULL THEN 
					CASE WHEN lwipv.DateApproved  IS NULL OR j.Approved IS NULL THEN 
						1 
					ELSE 
						0 
					END 
				ELSE 
					CASE WHEN lwipv.NoAccessID IS NOT NULL AND lwipv.naCreated >= ISNULL(CASE WHEN lwipv.TypeID IS NOT NULL AND lwipv.LegionellaID IS NOT NULL THEN lwipv.Finish END,lwipv.naCreated) AND j.Approved IS NULL THEN 
						1
					ELSE 
						0
					END 
				END
			ELSE
				CASE WHEN @Accessibility = 1 THEN
					CASE WHEN lwipv.DateApproved IS NULL OR j.Approved IS NULL THEN 
						CASE WHEN lwipv.LegionellaID IS NOT NULL AND CASE WHEN lwipv.NoAccessID IS NOT NULL AND lwipv.naCreated >= ISNULL(CASE WHEN lwipv.TypeID IS NOT NULL AND lwipv.LegionellaID IS NOT NULL THEN lwipv.Finish END,lwipv.naCreated) THEN 0 ELSE 1 END = 1 THEN 
							1 
						ELSE 
							0 
						END
					ELSE 
						0
					END
				ELSE
					CASE WHEN lwipv.NoAccessID IS NOT NULL AND lwipv.naCreated >= ISNULL(CASE WHEN lwipv.TypeID IS NOT NULL AND lwipv.LegionellaID IS NOT NULL THEN lwipv.Finish END,lwipv.naCreated) THEN 1 ELSE 0 END
				END
			End = 1
		)
			AND
		(
			CASE WHEN @OrgStateId IS NULL THEN 
				1 
			ELSE 
				CASE @OrgStateId
					WHEN 100 THEN
						Case When j.RejectedBySurveyor = 1 Then 1 ELSE 0 END
					WHEN 101 THEN
						CASE When j.RejectedByQC = 1 Then 1 ELSE 0 END
					WHEN 201 THEN
						Case When
						   lwipv.DateApproved IS NOT NULL -- Office Approved
								  And 
						   o.orgStateID = 6 -- Preview Generation Succeeded
						Then 1 Else 0
						End
					WHEN 202 THEN
						CASE When o.orgInstructionID IS NULL Then 1 ELSE 0 END
					ELSE
						CASE WHEN o.orgStateID=@OrgStateId THEN 
							CASE WHEN @OrgStateId = 6 THEN
								CASE WHEN
									j.RejectedBySurveyor = 0 
										AND 
									j.RejectedByQC = 0
								THEN 1 ELSE 0 END
							ELSE 1 END
						ELSE 0 END
				END
			END = 1
		)
			AND
		j.ClientID NOT IN (SELECT ClientID FROM @RestrictedClientIDs WHERE EmployeeRestrictedClientAccessID IS NULL)
		GROUP BY
			lwipv.JobID, lwipv.TypeID, lwipv.Type, lwipv.JobNo, lwipv.Start, lwipv.Finish, lwipv.MonitoringSchedule, lwipv.Due, lwipv.ClientID,
			lwipv.Client, lwipv.SiteID, si.Address, si.Postcode, lwipv.Report, lwipv.Photos,lwipv.Plans, lwipv.Documents, lwipv.DateApproved, lwipv.HasNotes,
			lwipv.NotesInLastHour, lwipv.NewGrid, lwipv.Status, lwipv.OrgState, lwipv.PDF, lwipv.EmployeeID, lwipv.FullName, lwipv.ProjectID, j.BranchOfficeID,
			si.UPRN, lwipv.LegionellaID, lwipv.NoAccessId, lwipv.naCreated, lwipv.NoAccess
			
			declare @RowTotal as int
			select @RowTotal = count(*) from #LegionellaWIPTopLevel

	;With Paging As 
    ( 
        Select 
            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(Ceiling(Count(*) Over (Partition By '') * 1.00 / @PerPage) as int)
            END As Pages, 

            CASE WHEN @PerPage = 0 THEN
                1
            ELSE
                Cast(((Row_Number() Over(Order By a.DateApproved DESC)-1) / @PerPage)+1 as int)
            END As Page, 

            Row_Number() Over(Order By a.DateApproved DESC) as Row_Num, 
			
			@RowTotal as RowTotal,
            *
        From 
			(
				Select * FROM #LegionellaWIPTopLevel 
			) a
	)

SELECT 
		IndexId,
		JobID,
		TypeID,
		ReportType,
		JobNo,
		Start,
		Finish,
		MonitoringSchedule,
		Due,
		ClientID,
		Client,
		SiteID,
		Site,
		Report,
		Photos,
		Plans,
		Documents,
		DateApproved,
		HasNotes,
		NotesInLastHour,
		NewGrid,
		STATUS,
		OrgState,
		PDF,
		EmployeeID,
		FullName,
		ProjectID,
		BranchOfficeID,
		UPRN,
		LegionellaID,
		NoAccessID,
		naCreated,
		NoAccess,
		[Pages],
		[Page]
FROM 
	Paging 
where
	[Page] = @CurrentPage

	SET NOCOUNT OFF;
END
GO


